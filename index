<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>PurchaseHub System</title>
  
  <script src="https://cdn.tailwindcss.com"></script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    .animate-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // =================================================================
    // --- ICON SYSTEM (EXPLICIT SAFE MODE) ---
    // สร้าง Component รอไว้เลย ไม่ต้องรอ Library โหลดเสร็จ ป้องกัน Error 100%
    // =================================================================
    
    // รายชื่อไอคอนทั้งหมดที่ใช้ในแอปนี้
    const USED_ICONS = [
      'LayoutDashboard', 'Plus', 'Package', 'CheckCircle', 'Clock', 
      'FileText', 'Search', 'User', 'LogOut', 'ChevronRight', 
      'ShoppingCart', 'Truck', 'AlertCircle', 'Paperclip',
      'HardHat', 'Briefcase', 'Building', 'ShieldCheck', 'BadgeCheck',
      'UploadCloud', 'FileCheck', 'Sparkles', 'X', 'MessageSquare', 'History', 'Store', 'Mail', 'Trash2', 'FileInput',
      'Save', 'Edit', 'RotateCcw', 'Send', 'AlertTriangle', 'Bell', 'Pencil', 'Box', 'Filter', 'RefreshCw', 'ArrowRight', 'List', 'ClipboardList', 'ArrowLeftRight', 'Monitor', 'Smartphone', 'Tag', 'Wrench', 'ArrowUpDown', 'Download', 
      'Image', // Alias: ImageIcon
      'Eye', 'XCircle', 'Camera', 
      'Info', 
      'Printer', 'CornerUpLeft', 'CheckSquare', 'XSquare', 'ExternalLink', 'PlayCircle', 'ArrowUpRight', 'PenTool', 'FileSignature', 'Calendar', 'CalendarClock', 'CreditCard', 'Flame', 'MousePointerClick'
    ];

    const lucideReact = {};

    // Helper: แปลง PascalCase -> kebab-case
    const pascalToKebab = (str) => str.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g, '$1-$2').toLowerCase().replace(/^-/, '');

    // สร้าง Component ปลอมรอไว้สำหรับทุกไอคอน
    USED_ICONS.forEach(name => {
        lucideReact[name] = (props) => {
            // 1. เช็คว่า Library มาหรือยัง
            if (!window.lucide || !window.lucide.icons) {
                return React.createElement('div', { 
                    style: { width: props.size || 24, height: props.size || 24, background: '#eee', borderRadius: 4, display: 'inline-block' },
                    className: props.className
                });
            }

            const cleanName = pascalToKebab(name);
            const iconData = window.lucide.icons[cleanName];

            // 2. ถ้าหาไอคอนไม่เจอ (อาจจะชื่อผิด) ให้แสดง Fallback
            if (!iconData) {
                return null;
            }

            // 3. วาดไอคอนจริง
            const tag = iconData[0];
            const attrs = iconData[1];
            const children = iconData[2];

            return React.createElement(tag, {
                ...attrs,
                width: props.size || 24,
                height: props.size || 24,
                stroke: props.color || "currentColor",
                strokeWidth: props.strokeWidth || (attrs ? attrs["stroke-width"] : 2),
                className: `lucide lucide-${cleanName} ${props.className || ""}`,
                ...props
            }, children.map((child, idx) => 
                React.createElement(child[0], { ...child[1], key: idx })
            ));
        };
    });

    // =================================================================
    // --- APP LOGIC ---
    // =================================================================

    // ดึงตัวแปร Icon (มั่นใจได้ว่ามีครบทุกตัวแน่นอน)
    const {
      LayoutDashboard, Plus, Package, CheckCircle, Clock, 
      FileText, Search, User, LogOut, ChevronRight, 
      ShoppingCart, Truck, AlertCircle, Paperclip,
      HardHat, Briefcase, Building, ShieldCheck, BadgeCheck,
      UploadCloud, FileCheck, Sparkles, X, MessageSquare, History, Store, Mail, Trash2, FileInput,
      Save, Edit, RotateCcw, Send, AlertTriangle, Bell, Pencil, Box, Filter, RefreshCw, ArrowRight, List, ClipboardList, ArrowLeftRight, Monitor, Smartphone, Tag, Wrench, ArrowUpDown, Download, 
      Image: ImageIcon, // Alias
      Eye, XCircle, Camera, 
      Paperclip: AttachmentIcon, // Alias
      Info, 
      Briefcase: BriefcaseIcon, // Alias
      Printer, CornerUpLeft, CheckSquare, XSquare, ExternalLink, PlayCircle, ArrowUpRight, PenTool, FileSignature, Calendar, CalendarClock, CreditCard, Flame, MousePointerClick
    } = lucideReact;

    // Manual Aliasing for missing/renamed icons
    // (กรณีที่ชื่อใน Array ข้างบนไม่ตรงกับตัวแปรที่ใช้)
    if (!BriefcaseIcon) lucideReact.BriefcaseIcon = lucideReact.Briefcase;
    if (!AttachmentIcon) lucideReact.AttachmentIcon = lucideReact.Paperclip;

    const createIcon = (name) => (props) => {
        const Icon = lucideReact[name];
        return Icon ? React.createElement(Icon, props) : null;
    };

    // --- Configuration & Constants ---
    const ROLES = {
      ADMIN: 'Admin (ผู้ดูแลระบบ)',
      USER: 'User (ผู้ขอซื้อ)',
      DEPT_HEAD: 'หัวหน้าแผนกฝ่ายจัดซื้อ (Level 1)',
      PM: 'ผู้จัดการโครงการ (Level 2)',
      PURCHASING: 'ฝ่ายจัดซื้อ (HO & Local Buyer)',
      STORE: 'Store Keeper (ผู้ดูแลคลัง)'
    };

    const RENTAL_UNITS = {
        'Day': 'บาท/วัน',
        'Month': 'บาท/เดือน',
        'Year': 'บาท/ปี'
    };

    const ITEM_UNITS = [
        'ชิ้น', 'อัน', 'ชุด', 'กล่อง', 'แพ็ค', 'เมตร', 'เส้น', 'ม้วน', 'kg', 'ลิตร', 'ถัง', 'เครื่อง', 'คัน', 'เล่ม', 'แผ่น'
    ];

    const PRIORITIES = {
        'Normal': { label: 'ปกติ', color: 'bg-blue-100 text-blue-700 border-blue-200' },
        'Urgent': { label: 'ด่วน', color: 'bg-orange-100 text-orange-700 border-orange-200' },
        'Critical': { label: 'ด่วนมาก', color: 'bg-red-100 text-red-700 border-red-200' }
    };

    const STATUS_LABELS = {
      'Draft': 'แบบร่าง (Draft)',
      'Pending Check': 'รอฝ่ายจัดซื้อตรวจสอบ (Check)',
      'Revise Needed': 'รอแก้ไขข้อมูล (Revise)',
      'Pending Head': 'รอหัวหน้าแผนกตรวจสอบ',
      'Pending PM': 'รอ PM อนุมัติ',
      'Approved': 'อนุมัติแล้ว (รอดำเนินการ)',
      'Ordered': 'สั่งซื้อแล้ว (รอรับของ)',
      'PR Issued': 'ออกใบขอซื้อ (PR) แล้ว',
      'PO Issued': 'ออกใบสั่งซื้อ (PO) แล้ว',
      'Contract Pending': 'รอทำสัญญาเช่า',
      'Contract Signed': 'ทำสัญญาเช่าแล้ว',
      'Shipping': 'กำลังจัดส่ง/ส่งมอบ',
      'Partially Received': 'รับของบางส่วน (Partial)',
      'Ready to Disburse': 'รอจ่ายของ (เบิก/ยืม)',
      'Completed': 'ได้รับของแล้ว/จบงาน',
      'Returned': 'คืนของแล้ว (Returned)',
      'Rejected': 'ไม่อนุมัติ (Rejected)'
    };

    const STATUS_STEPS_LOCAL = ['Pending Head', 'Pending PM', 'Approved', 'Ordered', 'Completed'];
    const STATUS_STEPS_HO_SHORT = ['Pending Check', 'Approved', 'PR Issued', 'PO Issued', 'Shipping', 'Completed'];
    const STATUS_STEPS_HO_FULL = ['Pending Check', 'Pending Head', 'Pending PM', 'Approved', 'PR Issued', 'PO Issued', 'Shipping', 'Completed'];
    const STATUS_STEPS_HO_RENT_SHORT = ['Pending Check', 'Approved', 'Contract Pending', 'Contract Signed', 'Shipping', 'Completed'];
    const STATUS_STEPS_HO_RENT_FULL = ['Pending Check', 'Pending Head', 'Pending PM', 'Approved', 'Contract Pending', 'Contract Signed', 'Shipping', 'Completed'];
    const STATUS_STEPS_HO_RENT_SKIP = ['Pending Check', 'Approved', 'Shipping', 'Completed']; 
    const STATUS_STEPS_HO_RENT_SKIP_FULL = ['Pending Check', 'Pending Head', 'Pending PM', 'Approved', 'Shipping', 'Completed'];
    const STATUS_STEPS_WITHDRAW = ['Pending Head', 'Approved', 'Ready to Disburse', 'Completed'];
    const STATUS_STEPS_BORROW = ['Pending Head', 'Approved', 'Ready to Disburse', 'Completed', 'Returned'];

    // --- Helper Functions ---
    const createLog = (action, user, note = '', images = []) => ({ 
      date: new Date().toLocaleString('th-TH'), 
      action, 
      user, 
      note,
      images: images || [] 
    });

    const getNextDocIndex = (allRequests, type, purchaseType) => {
        return allRequests.filter(r => {
            if (!r.docNumber) return false;
            if (r.type !== type) return false;
            if (type === 'HO') return r.purchaseType === purchaseType;
            return true;
        }).length;
    };

    const generateDocId = (type, index, purchaseType) => {
        const year = new Date().getFullYear().toString().slice(-2);
        const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
        const runNo = (index + 1).toString().padStart(3, '0');
        switch(type) {
            case 'Local': return `LPO-${year}${month}-${runNo}`;
            case 'HO': 
                return purchaseType === 'Rent' 
                    ? `HRO-${year}${month}-${runNo}` 
                    : `HPO-${year}${month}-${runNo}`;
            case 'Withdraw': return `WID-${year}${month}-${runNo}`;
            case 'Borrow': return `BOR-${year}${month}-${runNo}`;
            default: return `DOC-${year}${month}-${runNo}`;
        }
    };

    // --- Components ---
    const StatusBadge = ({ status }) => {
      let color = 'bg-gray-100 text-gray-800';
      if (status === 'Draft') color = 'bg-gray-200 text-gray-600 border border-gray-300';
      else if (status === 'Revise Needed') color = 'bg-red-50 text-red-600 border border-red-200 animate-pulse';
      else if (status.includes('Pending') || status === 'PR Issued') color = 'bg-amber-100 text-amber-800';
      else if (status === 'Contract Pending') color = 'bg-amber-100 text-amber-800 border border-amber-200';
      else if (status === 'Approved') color = 'bg-cyan-100 text-cyan-800';
      else if (status === 'Ready to Disburse') color = 'bg-purple-100 text-purple-800';
      else if (['Ordered', 'PO Issued', 'Shipping', 'Contract Signed', 'Partially Received'].includes(status)) color = 'bg-blue-100 text-blue-800';
      else if (status === 'Completed') color = 'bg-green-100 text-green-800';
      else if (status === 'Returned') color = 'bg-teal-100 text-teal-800';
      else if (status === 'Rejected') color = 'bg-red-100 text-red-800';
      return <span className={`px-2 py-1 rounded-full text-xs font-semibold ${color}`}>{STATUS_LABELS[status] || status}</span>;
    };

    const DocIdBadge = ({ type, id }) => {
        if (!id) return null;
        let color = 'bg-gray-100 text-gray-600 border-gray-200';
        let icon = createIcon('FileText')({className: "w-3 h-3"});
        if (id.startsWith('HRO')) {
            color = 'bg-teal-50 text-teal-700 border-teal-200';
            icon = createIcon('PenTool')({className: "w-3 h-3"});
        }
        else if (type === 'Local') { color = 'bg-orange-50 text-orange-700 border-orange-200'; icon = createIcon('HardHat')({className: "w-3 h-3"}); }
        else if (type === 'HO') { color = 'bg-indigo-50 text-indigo-700 border-indigo-200'; icon = createIcon('Building')({className: "w-3 h-3"}); }
        else if (type === 'Withdraw') { color = 'bg-pink-50 text-pink-700 border-pink-200'; icon = createIcon('Package')({className: "w-3 h-3"}); }
        else if (type === 'Borrow') { color = 'bg-blue-50 text-blue-700 border-blue-200'; icon = createIcon('Monitor')({className: "w-3 h-3"}); }

        return (
            <span className={`text-xs px-2 py-0.5 rounded border flex items-center gap-1 font-bold ${color}`}>
                {icon} {id}
            </span>
        );
    };

    const ProgressBar = ({ request }) => {
      let steps = STATUS_STEPS_LOCAL;
      if (request.type === 'HO') {
          if (request.purchaseType === 'Rent') {
              if (request.needContract === false) {
                  steps = request.isFullApprovalFlow ? STATUS_STEPS_HO_RENT_SKIP_FULL : STATUS_STEPS_HO_RENT_SKIP;
              } else {
                  steps = request.isFullApprovalFlow ? STATUS_STEPS_HO_RENT_FULL : STATUS_STEPS_HO_RENT_SHORT;
              }
          } else {
              steps = request.isFullApprovalFlow ? STATUS_STEPS_HO_FULL : STATUS_STEPS_HO_SHORT;
          }
      }
      if (request.type === 'Withdraw') steps = STATUS_STEPS_WITHDRAW;
      if (request.type === 'Borrow') steps = STATUS_STEPS_BORROW;
      
      let statusToFind = request.status;
      if (statusToFind === 'Partially Received') {
          if (request.type === 'Local') statusToFind = 'Ordered';
          else if (request.type === 'HO') statusToFind = 'Shipping';
      }

      const currentIndex = steps.indexOf(statusToFind);
      const AlertCircleIcon = createIcon('AlertCircle');
      
      return (
        <div className="w-full mt-3 mb-4">
           {request.status === 'Revise Needed' && (
               <div className="mb-2 text-xs text-red-500 font-bold flex items-center gap-1 animate-bounce">
                   <AlertCircleIcon className="w-3 h-3"/> ต้องแก้ไขข้อมูล (ดูรายละเอียดในประวัติ)
               </div>
           )}
          <div className="flex justify-between mb-2">
              {steps.map((step, idx) => (
                 <div key={step} className={`text-[10px] flex flex-col items-center ${idx <= currentIndex ? 'text-blue-600 font-bold' : 'text-gray-300'}`}>
                      <div className={`w-2 h-2 rounded-full mb-1 ${idx <= currentIndex ? 'bg-blue-600' : 'bg-gray-200'}`}></div>
                      <span className="hidden sm:inline">{STATUS_LABELS[step]?.split(' ')[0] || step}</span>
                  </div>
              ))}
          </div>
          <div className="h-1.5 bg-gray-100 rounded-full overflow-hidden flex">
              {steps.map((step, idx) => (
                  <div key={step} className={`h-full border-r border-white last:border-0 transition-all duration-500 ${idx <= currentIndex ? 'bg-blue-500' : 'bg-transparent'}`} style={{ width: `${100 / steps.length}%` }} />
              ))}
          </div>
        </div>
      );
    };

    // --- MAIN APP COMPONENT ---
    const App = () => {
      const [currentUserRole, setCurrentUserRole] = useState(ROLES.USER);
      const [activeTab, setActiveTab] = useState('dashboard');
      
      // Use Empty Array initially, will fetch from Sheet
      const [requests, setRequests] = useState([]);
      const [inventory, setInventory] = useState([]);
      const [assets, setAssets] = useState([]);
      const [invLogs, setInvLogs] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [uploadFiles, setUploadFiles] = useState({ email: null, quotation: null });

      
      // Special Sync wrappers calling specific backend functions
      const saveRequestToSheet = (req) => {
         google.script.run.syncRequest(req);
      };
      const saveInventoryToSheet = (item) => {
         google.script.run.syncInventory(item);
      };
      const saveAssetToSheet = (asset) => {
         google.script.run.syncAsset(asset);
      };
      const saveLogToSheet = (log) => {
         google.script.run.syncLog(log);
      };

      const handleCreateOrder = async (e, isDraft = false) => {
    e.preventDefault();
    if (!newOrderMeta.job || !newOrderMeta.dateRequired) {
      showToast("กรุณากรอกชื่อโครงการและวันที่ต้องการ", 'error');
      return;
    }
    if (orderItems.length === 0) { 
      showToast("กรุณาเพิ่มรายการ", 'error'); 
      return; 
    }
    
    setIsLoading(true);
    
    let attachmentData = newOrderMeta.attachment;
    let quotationData = newOrderMeta.quotation;
    
    try {
      if (uploadFiles.email) {
        const base64 = await fileToBase64(uploadFiles.email);
        const result = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .uploadFileToDrive(base64, uploadFiles.email.name);
        });
        if (result.error) throw new Error(result.error);
        attachmentData = result;
      }
      
      if (uploadFiles.quotation) {
        const base64 = await fileToBase64(uploadFiles.quotation);
        const result = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .uploadFileToDrive(base64, uploadFiles.quotation.name);
        });
        if (result.error) throw new Error(result.error);
        quotationData = result;
      }
    } catch (err) {
      console.error("Upload Error:", err);
      showToast("เกิดข้อผิดพลาดในการอัปโหลดไฟล์: " + err.message, 'error');
      setIsLoading(false);
      return;
    }
    
    // สร้าง Order
    let nextStatus = 'Draft';
    let isFullFlow = false;
    const existingReq = editingId ? requests.find(r => r.id === editingId) : null;
    if (existingReq) isFullFlow = existingReq.isFullApprovalFlow || false;
    
    if (!isDraft) {
      if (newOrderMeta.type === 'HO') {
        nextStatus = isFullFlow ? 'Pending Head' : 'Pending Check';
      } else if (newOrderMeta.type === 'Local') {
        nextStatus = 'Pending Head';
      } else {
        nextStatus = 'Pending Head';
      }
    }
    
    const order = {
      id: editingId || `REQ-00${requests.length + 1}`,
      requester: 'Current User',
      status: nextStatus,
      created: new Date().toISOString().split('T')[0],
      items: orderItems,
      ...newOrderMeta,
      attachment: attachmentData,
      quotation: quotationData,
      docNumber: existingReq?.docNumber || null,
      isFullApprovalFlow: isFullFlow,
      history: [
        ...(existingReq?.history || []),
        createLog(
          isDraft ? 'บันทึกแบบร่าง' : (editingId ? 'ส่งข้อมูลแก้ไข' : 'สร้างคำขอ'),
          'Current User',
          isFullFlow ? 'Submit (Full Flow)' : 'Submit'
        )
      ],
      comments: existingReq?.comments || []
    };
    
    setRequests(prev => 
      editingId 
        ? prev.map(r => r.id === editingId ? order : r) 
        : [order, ...prev]
    );
    
    saveRequestToSheet(order);
    setIsLoading(false);
    showToast(isDraft ? 'บันทึกแบบร่างแล้ว' : 'ส่งคำขอเรียบร้อย');
    setUploadFiles({ email: null, quotation: null });
    handleCloseCreateModal();
  };


      // --- FETCH DATA ON LOAD ---
      useEffect(() => {
        google.script.run.withSuccessHandler((data) => {
           if(data.requests) setRequests(data.requests);
           if(data.inventory) setInventory(data.inventory);
           if(data.assets) setAssets(data.assets);
           if(data.logs) setInvLogs(data.logs);
           setIsLoading(false);
        }).loadInitialData();
      }, []);


      // State from original file
      const [assetTabMode, setAssetTabMode] = useState('Company');
      const [dashboardView, setDashboardView] = useState('Purchase');
      const [dashboardSearch, setDashboardSearch] = useState('');
      const [dashboardStatusFilter, setDashboardStatusFilter] = useState('All');
      const [searchQuery, setSearchQuery] = useState('');
      const [invSearch, setInvSearch] = useState('');
      const [assetSearch, setAssetSearch] = useState('');
      const [historySearch, setHistorySearch] = useState('');
      const [historyFilterItem, setHistoryFilterItem] = useState(null);
      const [invSort, setInvSort] = useState({ key: 'id', direction: 'asc' });
      const [assetSort, setAssetSort] = useState({ key: 'id', direction: 'asc' });
      const [statusFilter, setStatusFilter] = useState('All');
      const [typeFilter, setTypeFilter] = useState('All');
      
      // Modals
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [showDetailModal, setShowDetailModal] = useState(false);
      const [showPRModal, setShowPRModal] = useState(false);
      const [showPOModal, setShowPOModal] = useState(false);
      const [notification, setNotification] = useState(null);
      const [showReceiveGoodsModal, setShowReceiveGoodsModal] = useState(false);
      const [showDisburseModal, setShowDisburseModal] = useState(false);
      const [showRejectModal, setShowRejectModal] = useState(false);
      const [showItemDetailModal, setShowItemDetailModal] = useState(false);
      const [showPOPreviewModal, setShowPOPreviewModal] = useState(false);
      const [showSelectionModal, setShowSelectionModal] = useState(false);
      const [isForceClose, setIsForceClose] = useState(false);
      
      // Verification Modal State
      const [showVerificationModal, setShowVerificationModal] = useState(false);
      const [verificationData, setVerificationData] = useState({
          requestId: null,
          checks: { quotation: true, email: true, details: true },
          filesExist: { quotation: false, email: false },
          needApproval: false,
          needContract: true,
          note: ''
      });
      const [viewingItem, setViewingItem] = useState(null);
      const [previewImage, setPreviewImage] = useState(null); 

      // Inventory/Asset Management Modals
      const [showAddInvModal, setShowAddInvModal] = useState(false);
      const [showEditInvModal, setShowEditInvModal] = useState(false);
      const [showAssetModal, setShowAssetModal] = useState(false);
      const [showEditAssetModal, setShowEditAssetModal] = useState(false);
      const [showReturnAssetModal, setShowReturnAssetModal] = useState(false);
      const [editingStockItem, setEditingStockItem] = useState(null);
      const [editingAssetItem, setEditingAssetItem] = useState(null);
      const [returnAssetData, setReturnAssetData] = useState({ id: '', condition: 'Good', note: '', images: [] });
      const [disburseData, setDisburseData] = useState({ requestId: null, note: '', images: [] });
      const [rejectData, setRejectData] = useState({ requestId: null, reason: '' });
      const [newStockItem, setNewStockItem] = useState({ name: '', qty: 0, unit: 'ชิ้น', minStock: 0, price: 0, images: [] });
      const [newAssetItem, setNewAssetItem] = useState({ id: '', name: '', serial: '', status: 'Available', condition: 'Good', price: 0, images: [] });
      
      // Form Data
      const [selectedRequest, setSelectedRequest] = useState(null);
      const [receiveItems, setReceiveItems] = useState([]);
      const [editingId, setEditingId] = useState(null);
      const [newOrderMeta, setNewOrderMeta] = useState({ type: 'Local', purchaseType: 'Buy', job: '', dateRequired: '', priority: 'Normal', attachment: null, quotation: null });
      const [tempItem, setTempItem] = useState({ name: '', qty: 1, unitPrice: 0, unit: 'ชิ้น', subJob: '', epCode: '', note: '', images: [] });
      const [orderItems, setOrderItems] = useState([]);
      
      const [showSuggestions, setShowSuggestions] = useState(false);
      const [suggestions, setSuggestions] = useState([]);
      const [stockSuggestion, setStockSuggestion] = useState(null);
      const [selectionSearch, setSelectionSearch] = useState('');

      const [prData, setPrData] = useState({ requestId: null, file: null, prNumber: '' });
      const [poData, setPoData] = useState({ requestId: null, file: null, poNumber: '' });

      // --- Helper Validation Logic ---
      const isVerificationPass = () => {
          const { checks, filesExist } = verificationData;
          const isDetailsPass = checks.details === true;
          const isQuotationPass = filesExist.quotation ? (checks.quotation === true) : (checks.quotation === false);
          const isEmailPass = filesExist.email ? (checks.email === true) : (checks.email === false);
          return isDetailsPass && isQuotationPass && isEmailPass;
      };

      // --- Helpers ---
      const showToast = (message, type = 'success') => {
        setNotification({ message, type });
        setTimeout(() => setNotification(null), 3000);
      };
        const fileToBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = (error) => reject(error);
    });
  };

      const addInvLog = (action, item, change, note = '', images = []) => {
        const log = {
          date: new Date().toLocaleString('th-TH'),
          action,
          item,
          change,
          by: currentUserRole,
          note,
          images
        };
        setInvLogs(prev => [log, ...prev]);
        saveLogToSheet(log); // Sync Log
      };

      const handleSort = (key, currentSort, setSort) => {
        setSort({
            key,
            direction: currentSort.key === key && currentSort.direction === 'asc' ? 'desc' : 'asc'
        });
      };

      const getSortedData = (data, sortConfig) => {
          const sorted = [...data];
          sorted.sort((a, b) => {
              if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'asc' ? -1 : 1;
              if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'asc' ? 1 : -1;
              return 0;
          });
          return sorted;
      };

      // --- Logic Hooks ---
      const filteredRequests = useMemo(() => {
        let data = requests;
        if (searchQuery) {
            const lowerQ = searchQuery.toLowerCase();
            data = data.filter(r => r.id.toLowerCase().includes(lowerQ) || r.items.some(i => i.name.toLowerCase().includes(lowerQ)) || (r.docNumber && r.docNumber.toLowerCase().includes(lowerQ)));
        }
        if (typeFilter !== 'All') {
            data = data.filter(r => r.type === typeFilter);
        }
        if (statusFilter !== 'All') {
           data = data.filter(r => r.status === statusFilter);
        }

        switch (currentUserRole) {
            case ROLES.USER:
                // For demo, assume Current User creates all or modify this logic
                // data = data.filter(r => r.requester === 'Somsak' || r.requester === 'Current User');
                break;
            case ROLES.DEPT_HEAD:
                data = data.filter(r => r.status === 'Pending Head');
                break;
            case ROLES.PM:
                data = data.filter(r => r.status === 'Pending PM');
                break;
            case ROLES.PURCHASING:
                data = data.filter(r => {
                    if (r.type === 'Local') return ['Approved', 'Ordered', 'Partially Received'].includes(r.status);
                    if (r.type === 'HO') return ['Pending Check', 'PR Issued', 'PO Issued', 'Shipping', 'Approved', 'Contract Pending', 'Contract Signed', 'Partially Received'].includes(r.status);
                    return false;
                });
                break;
            case ROLES.STORE:
                data = data.filter(r => ['Withdraw', 'Borrow'].includes(r.type) && ['Ready to Disburse', 'Pending Head', 'Approved'].includes(r.status));
                break;
            case ROLES.ADMIN:
                break;
        }

        return data;
      }, [requests, searchQuery, typeFilter, statusFilter, currentUserRole]);

      const filteredInventory = useMemo(() => {
          let data = inventory;
          if (invSearch) {
              data = data.filter(i => i.name.toLowerCase().includes(invSearch.toLowerCase()) || i.id.toLowerCase().includes(invSearch.toLowerCase()));
          }
          return getSortedData(data, invSort);
      }, [inventory, invSearch, invSort]);

      const filteredAssets = useMemo(() => {
          let data = assets;
          data = data.filter(a => a.ownerType === assetTabMode);
          if (assetSearch) {
              data = data.filter(a => a.name.toLowerCase().includes(assetSearch.toLowerCase()) || a.id.toLowerCase().includes(assetSearch.toLowerCase()) || a.holder.toLowerCase().includes(assetSearch.toLowerCase()));
          }
          return getSortedData(data, assetSort);
      }, [assets, assetSearch, assetSort, assetTabMode]);

      // --- Functions & Handlers (Logic from original file) ---
      
      // Smart Suggestion
      useEffect(() => {
        let timeoutId;
        setStockSuggestion(null);
        if (tempItem.name && tempItem.name.length > 1) {
            if (newOrderMeta.type === 'Local' || newOrderMeta.type === 'HO') {
               const stockMatch = inventory.find(i => i.name.toLowerCase().includes(tempItem.name.toLowerCase()) && i.qty > 0);
               if (stockMatch) {
                   setStockSuggestion({ ...stockMatch, type: 'Material', matchType: 'Withdraw' });
               } else {
                 const assetMatch = assets.find(a => a.name.toLowerCase().includes(tempItem.name.toLowerCase()) && a.status === 'Available');
                 if (assetMatch) {
                     setStockSuggestion({ ...assetMatch, type: 'Asset', matchType: 'Borrow' });
                 }
               }
            }
        }
        return () => clearTimeout(timeoutId);
      }, [tempItem.name, newOrderMeta.type, inventory, assets]);

      const selectSuggestion = (item) => {
        setTempItem({ 
            ...tempItem, 
            name: item.name + (item.serial ? ` (${item.serial})` : ''), 
            unitPrice: (newOrderMeta.type === 'Withdraw' || newOrderMeta.type === 'Borrow') ? 0 : item.price 
        });
        setShowSuggestions(false);
      };

      const handleAddItem = () => {
        if (!tempItem.name) return;
        const itemQty = newOrderMeta.type === 'Borrow' ? 1 : tempItem.qty;
        if (itemQty <= 0) return;
        if (newOrderMeta.type === 'Withdraw') {
            const stockItem = inventory.find(i => i.name === tempItem.name);
            if (!stockItem || itemQty > stockItem.qty) {
                showToast(`สินค้าไม่พอ (มี: ${stockItem?.qty || 0})`, 'error');
                return;
            }
        }
        setOrderItems([...orderItems, { ...tempItem, qty: itemQty }]);
        setTempItem({ name: '', qty: 1, unitPrice: 0, unit: 'ชิ้น', subJob: '', epCode: '', note: '', images: [] });
        setStockSuggestion(null);
        setShowSuggestions(false);
      };

      const getSelectionItems = () => {
          const isAssetRequest = newOrderMeta.type === 'Borrow';
          let items = isAssetRequest ? assets : inventory;
          if (isAssetRequest) {
              items = items.filter(a => a.status === 'Available');
          }
          if (selectionSearch) {
              const lower = selectionSearch.toLowerCase();
              items = items.filter(i => 
                  i.name.toLowerCase().includes(lower) || 
                  (i.serial && i.serial.toLowerCase().includes(lower)) ||
                  (i.id && i.id.toLowerCase().includes(lower))
              );
          }
          return items;
      };

      const handleSelectFromModal = (item) => {
          const isAsset = newOrderMeta.type === 'Borrow';
          const name = isAsset ? `${item.name} (${item.serial})` : item.name;
          const unitPrice = (newOrderMeta.type === 'Withdraw' || newOrderMeta.type === 'Borrow') ? 0 : item.price;
          const unit = isAsset ? 'เครื่อง' : (item.unit || 'ชิ้น');
          setTempItem({
              ...tempItem,
              name,
              unitPrice,
              unit
          });
          setShowSelectionModal(false);
          setSelectionSearch('');
      };
      
      const handleOpenSelectionModal = () => {
          setSelectionSearch('');
          setShowSelectionModal(true);
      };

      const handleEditDraft = (req) => {
          setEditingId(req.id);
          setNewOrderMeta({
              type: req.type,
              purchaseType: req.purchaseType || 'Buy',
              job: req.job || '',
              dateRequired: req.dateRequired || '',
              priority: req.priority || 'Normal',
              attachment: req.attachment || null,
              quotation: req.quotation || null
          });
          setOrderItems(req.items || []);
          setShowCreateModal(true);
      };
      
      const handleRevise = (req) => {
          handleEditDraft(req);
          showToast('กรุณาแก้ไขข้อมูลตามที่ผู้ตรวจสอบแจ้ง', 'info');
      };

      const handleCloseCreateModal = () => {
          setShowCreateModal(false);
          setEditingId(null);
          setOrderItems([]);
          setNewOrderMeta({ type: 'Local', purchaseType: 'Buy', job: '', dateRequired: '', priority: 'Normal', attachment: null, quotation: null });
          setTempItem({ name: '', qty: 1, unitPrice: 0, unit: 'ชิ้น', subJob: '', epCode: '', note: '', images: [] });
      };

      const handleOpenCreateModal = () => {
          setEditingId(null);
          setOrderItems([]);
          setNewOrderMeta({ type: 'Local', purchaseType: 'Buy', job: '', dateRequired: '', priority: 'Normal', attachment: null, quotation: null });
          setTempItem({ name: '', qty: 1, unitPrice: 0, unit: 'ชิ้น', subJob: '', epCode: '', note: '', images: [] });
          setShowCreateModal(true);
      };

      const initiateRecall = (id) => {
          const updatedReqs = requests.map(r => {
              if (r.id === id) {
                   const updated = { ...r, status: 'Draft', history: [...r.history, createLog('Revert to Draft', currentUserRole, 'User recalled request')] };
                   saveRequestToSheet(updated); // Sync
                   return updated;
              }
              return r;
          });
          setRequests(updatedReqs);
          showToast('เรียกคืนเอกสารกลับมาเป็นแบบร่างแล้ว');
      };

      const handleRemoveItem = (index) => {
          const newItems = [...orderItems];
          newItems.splice(index, 1);
          setOrderItems(newItems);
      };

      const handleAddNewProduct = () => {
          if (!newStockItem.name) { showToast('กรุณาระบุชื่อสินค้า', 'error'); return; }
          const newItem = {
              id: `INV-${String(inventory.length + 1).padStart(3, '0')}`,
              ...newStockItem,
              lastUpdated: new Date().toLocaleString('th-TH'),
              image: newStockItem.images && newStockItem.images.length > 0 ? newStockItem.images[0].name : null
          };
          setInventory(prev => {
             const updated = [...prev, newItem];
             return updated;
          });
          saveInventoryToSheet(newItem); // Sync
          addInvLog('Add Item', newItem.name, `+${newItem.qty}`, 'เพิ่มสินค้าใหม่', newStockItem.images);
          setShowAddInvModal(false);
          setNewStockItem({ name: '', qty: 0, unit: 'ชิ้น', minStock: 0, price: 0, images: [] });
          showToast('เพิ่มสินค้าใหม่เรียบร้อย');
      };

      const handleUpdateStock = () => {
          if (!editingStockItem) return;
          const updatedItem = { ...editingStockItem, lastUpdated: new Date().toLocaleString('th-TH') };
          
          setInventory(prev => prev.map(item => item.id === editingStockItem.id ? updatedItem : item));
          saveInventoryToSheet(updatedItem); // Sync

          const oldItem = inventory.find(i => i.id === editingStockItem.id);
          const change = editingStockItem.qty - (oldItem ? oldItem.qty : 0);
          const changeStr = change > 0 ? `+${change}` : `${change}`;
          
          addInvLog('Update Stock', editingStockItem.name, changeStr, 'แก้ไขข้อมูลสต็อก', []);
          setShowEditInvModal(false);
          setEditingStockItem(null);
          showToast('อัปเดตข้อมูลเรียบร้อย');
      };

      const handleAddAsset = () => {
          if (!newAssetItem.id || !newAssetItem.name) {
              showToast('กรุณากรอกรหัสและชื่อทรัพย์สิน', 'error');
              return;
          }
          if (assets.some(a => a.id === newAssetItem.id)) {
              showToast('รหัสทรัพย์สินนี้มีอยู่แล้ว', 'error');
              return;
          }

          const date = new Date().toLocaleString('th-TH');
          const newAsset = { holder: '-', currentRequestId: null, lastUpdated: date, ownerType: assetTabMode, ...newAssetItem, image: newAssetItem.images.length > 0 ? newAssetItem.images[0].name : null };
          
          setAssets(prev => [...prev, newAsset]);
          saveAssetToSheet(newAsset); // Sync
          
          addInvLog('Add Asset', newAssetItem.name, 'New', `เพิ่มทรัพย์สินใหม่ ${newAssetItem.id} (${assetTabMode})`, newAssetItem.images);
          setShowAssetModal(false);
          setNewAssetItem({ id: '', name: '', serial: '', status: 'Available', condition: 'Good', price: 0, images: [] });
          showToast('เพิ่มทรัพย์สินเรียบร้อย');
      };

      const initiateReturnAsset = (asset) => {
          setReturnAssetData({ id: asset.id, condition: 'Good', note: '', images: [] });
          setShowReturnAssetModal(true);
      };

      const confirmReturnAsset = () => {
          const asset = assets.find(a => a.id === returnAssetData.id);
          if (!asset) return;
          
          const updatedAsset = { 
              ...asset, 
              status: 'Available', 
              holder: '-', 
              currentRequestId: null, 
              condition: returnAssetData.condition,
              lastUpdated: new Date().toLocaleString('th-TH'),
              image: returnAssetData.images.length > 0 ? returnAssetData.images[0].name : asset.image 
          };

          setAssets(prev => prev.map(a => a.id === asset.id ? updatedAsset : a));
          saveAssetToSheet(updatedAsset); // Sync

          addInvLog('Return Asset', asset.name, 'Return', `รับคืน: ${returnAssetData.condition} ${returnAssetData.note ? `(${returnAssetData.note})` : ''}`, returnAssetData.images);
          if (asset.currentRequestId) {
              setRequests(prev => prev.map(r => {
                  if (r.id === asset.currentRequestId) {
                      const updatedReq = { 
                          ...r, 
                          status: 'Returned', 
                          history: [...r.history, createLog('Returned', currentUserRole, `คืนของ: ${returnAssetData.condition}`, returnAssetData.images)]
                      };
                      saveRequestToSheet(updatedReq); // Sync Req
                      return updatedReq;
                  }
                  return r;
              }));
          }
          setShowReturnAssetModal(false);
          showToast('รับคืนและอัปเดตสถานะเรียบร้อย');
      };

      const handleUpdateAsset = (e) => {
          e.preventDefault();
          const date = new Date().toLocaleString('th-TH');
          const updatedAsset = { ...editingAssetItem, lastUpdated: date };
          setAssets(prev => prev.map(a => a.id === editingAssetItem.id ? updatedAsset : a));
          saveAssetToSheet(updatedAsset); // Sync
          addInvLog('Edit Asset', editingAssetItem.name, 'Edit', `แก้ไขสถานะ: ${editingAssetItem.status}`, editingAssetItem.images);
          setShowEditAssetModal(false);
          showToast('แก้ไขข้อมูลทรัพย์สินเรียบร้อย');
      };

    
      
      const openVerificationModal = (reqId) => {
          const req = requests.find(r => r.id === reqId);
          if(!req) return;
          const hasQuotation = !!req.quotation;
          const hasEmail = !!req.attachment;
          setVerificationData({
              requestId: reqId,
              filesExist: { quotation: hasQuotation, email: hasEmail },
              checks: { quotation: hasQuotation ? true : false, email: hasEmail ? true : false, details: true },
              needApproval: !hasEmail, 
              needContract: true, 
              note: ''
          });
          setShowVerificationModal(true);
      };
      
      const handleChecklistChange = (field) => {
          setVerificationData(prev => ({...prev, checks: {...prev.checks, [field]: !prev.checks[field]}}));
      };
      
      const handleConfirmVerification = () => {
          const { requestId, checks, filesExist, needApproval, needContract, note } = verificationData;
          const req = requests.find(r => r.id === requestId);
          if (!req) return;
          
          const isDetailsPass = checks.details === true;
          const isQuotationPass = filesExist.quotation ? (checks.quotation === true) : (checks.quotation === false);
          const isEmailPass = filesExist.email ? (checks.email === true) : (checks.email === false);
          const allPass = isDetailsPass && isQuotationPass && isEmailPass;

          let updatedReq;
          if (!allPass) {
              const returnNote = `ส่งคืนแก้ไข: - ${note}`;
              updatedReq = { ...req, status: 'Revise Needed', history: [...req.history, createLog('Return for Revision', currentUserRole, returnNote)] };
              showToast('ส่งคืนเอกสารให้ผู้ขอแก้ไขเรียบร้อย', 'error');
          } else if (needApproval) {
              updatedReq = { ...req, status: 'Pending Head', isFullApprovalFlow: true, needContract: needContract, history: [...req.history, createLog('Forward for Approval', currentUserRole, `ส่งต่ออนุมัติ: ${note}`)] };
              showToast('ส่งต่อให้หัวหน้าแผนกอนุมัติเรียบร้อย');
          } else {
              const count = getNextDocIndex(requests, req.type, req.purchaseType);
              const newDocId = req.docNumber || generateDocId(req.type, count, req.purchaseType);
              updatedReq = { ...req, status: 'Approved', needContract: needContract, docNumber: newDocId, history: [...req.history, createLog('Pass Verification', currentUserRole, `ตรวจสอบผ่าน: ${note}`)] };
              showToast('ตรวจสอบผ่านแล้ว รอออกใบขอซื้อ (PR)');
          }
          
          setRequests(prev => prev.map(r => r.id === requestId ? updatedReq : r));
          saveRequestToSheet(updatedReq); // Sync
          setShowVerificationModal(false);
      };

      const handleViewFile = (fileData, fileName) => {
  if (!fileData) {
    showToast('ไม่พบไฟล์', 'error');
    return;
  }
  
  // Check if it's a URL or Base64
  if (typeof fileData === 'string' && fileData.startsWith('http')) {
    // It's a URL - open directly
    window.open(fileData, '_blank');
  } else if (typeof fileData === 'string' && (fileData.startsWith('data:') || fileData.includes('base64'))) {
    // It's Base64 - open in new tab
    const newWindow = window.open();
    newWindow.document.write(`
      <html>
        <head><title>${fileName || 'Document'}</title></head>
        <body style="margin:0">
          <iframe src="${fileData}" style="width:100%;height:100vh;border:none"></iframe>
        </body>
      </html>
    `);
  } else {
    // It's a file name - show placeholder
    showToast(`ไฟล์: ${fileData}`, 'info');
  }
};

      const handleApprovalUpdate = (id, newStatus) => { handleUpdateStatus(id, newStatus); };

      const openReceiveModal = (req) => {
          const defaultTarget = req.type === 'HO' ? 'Asset' : 'Inventory';
          const items = req.items.map(item => {
              const receivedSoFar = item.receivedTotal || 0;
              const remaining = Math.max(0, item.qty - receivedSoFar);
              const assetsReg = Array.from({ length: remaining }, (_, i) => ({ 
                  id: '', serial: '', name: item.name,
                  rentalStart: '', rentalEnd: '', rentalPrice: req.purchaseType === 'Rent' ? item.unitPrice : 0, rentalUnit: 'Month' 
              }));

              return { 
                  ...item, 
                  targetType: defaultTarget, 
                  assetId: '', assetSerial: '', 
                  receiveImages: [], 
                  assetsToRegister: assetsReg, 
                  isRent: req.purchaseType === 'Rent', 
                  receivedQty: remaining,
                  actualPrice: item.unitPrice,
                  orderedQty: item.qty,
                  receivedSoFar: receivedSoFar
              };
          });
          setReceiveItems(items);
          setIsForceClose(false);
          setSelectedRequest(req);
          setShowReceiveGoodsModal(true);
      };

      const handleConfirmReceive = () => {
          if (!selectedRequest) return;
          const date = new Date().toLocaleString('th-TH');
          
          const updatedItems = selectedRequest.items.map(originalItem => {
              const receivingItem = receiveItems.find(ri => ri.name === originalItem.name);
              if (receivingItem) {
                  const newReceivedTotal = (originalItem.receivedTotal || 0) + receivingItem.receivedQty;
                  return {
                      ...originalItem,
                      receivedTotal: newReceivedTotal
                  };
              }
              return originalItem;
          });

          const allComplete = updatedItems.every(item => (item.receivedTotal || 0) >= item.qty);
          let newStatus = 'Completed';
          if (!allComplete && !isForceClose) {
              newStatus = 'Partially Received';
          }

          // Process Inventory/Asset updates
          receiveItems.forEach(item => {
              const qtyToReceive = item.receivedQty || 0;
              if (qtyToReceive <= 0) return;

              if (item.targetType === 'Inventory') {
                  const existing = inventory.find(inv => inv.name === item.name);
                  if (existing) {
                      const updatedInv = { ...existing, qty: existing.qty + qtyToReceive, lastUpdated: date, image: item.receiveImages.length > 0 ? item.receiveImages[0].name : existing.image };
                      setInventory(prev => prev.map(inv => inv.id === existing.id ? updatedInv : inv));
                      saveInventoryToSheet(updatedInv); // Sync
                      addInvLog('Stock In', item.name, `+${qtyToReceive}`, `รับของจาก ${selectedRequest.id} (Partial)`, item.receiveImages);
                  } else {
                      const newInv = { id: `INV-${String(inventory.length + 1 + Math.floor(Math.random()*100)).padStart(3, '0')}`, name: item.name, qty: qtyToReceive, unit: 'หน่วย', minStock: 0, price: item.actualPrice, lastUpdated: date, image: item.receiveImages.length > 0 ? item.receiveImages[0].name : null };
                      setInventory(prev => [...prev, newInv]);
                      saveInventoryToSheet(newInv); // Sync
                      addInvLog('Create Item', item.name, `Start: ${qtyToReceive}`, `สินค้าใหม่จาก ${selectedRequest.id}`, item.receiveImages);
                  }
              } else {
                  const assetsToProcess = item.assetsToRegister.slice(0, qtyToReceive);
                  assetsToProcess.forEach((assetReg, idx) => {
                      const assetId = assetReg.id || `AST-AUTO-${Date.now().toString().slice(-6)}-${idx}`;
                      const newAsset = { id: assetId, name: assetReg.name || item.name, serial: assetReg.serial || '-', status: 'Available', condition: 'Good', holder: '-', currentRequestId: null, price: item.actualPrice, image: item.receiveImages.length > 0 ? item.receiveImages[0].name : null, lastUpdated: date, ownerType: item.isRent ? 'Rent' : 'Company', rentalStart: assetReg.rentalStart || null, rentalEnd: assetReg.rentalEnd || null, rentalPrice: assetReg.rentalPrice || 0, rentalUnit: assetReg.rentalUnit || 'Month' };
                      setAssets(prev => [...prev, newAsset]);
                      saveAssetToSheet(newAsset); // Sync
                      addInvLog('Register Asset', newAsset.name, 'New', `ทรัพย์สินใหม่ (${assetId})`, item.receiveImages);
                  });
              }
          });
          
          const updatedReq = {
             ...selectedRequest,
             items: updatedItems,
             status: newStatus,
             history: [...selectedRequest.history, createLog(STATUS_LABELS[newStatus], currentUserRole, `รับของเพิ่ม (สถานะ: ${newStatus})`)]
          };

          setRequests(prev => prev.map(req => req.id === selectedRequest.id ? updatedReq : req));
          saveRequestToSheet(updatedReq); // Sync Req
          
          setShowReceiveGoodsModal(false);
          showToast(`บันทึกรับของเรียบร้อย (${STATUS_LABELS[newStatus]})`);
      };

      const openDisburseModal = (reqId) => { setDisburseData({ requestId: reqId, note: '', images: [] }); setShowDisburseModal(true); };
      
      const handleConfirmDisburse = () => {
          const req = requests.find(r => r.id === disburseData.requestId);
          if (!req) return;
          if (req.type === 'Withdraw') {
              req.items.forEach(item => {
                 const stockItem = inventory.find(i => i.name === item.name);
                 if (stockItem) {
                     const updatedStock = { ...stockItem, qty: Math.max(0, stockItem.qty - item.qty), lastUpdated: new Date().toLocaleString('th-TH') };
                     setInventory(inv => inv.map(x => x.id === stockItem.id ? updatedStock : x));
                     saveInventoryToSheet(updatedStock); // Sync
                     addInvLog('Withdraw', item.name, `-${item.qty}`, `จ่ายของเอกสาร ${req.id} (${disburseData.note})`, disburseData.images);
                 }
              });
          } else if (req.type === 'Borrow') {
              req.items.forEach(item => {
                  const assetName = item.name.split(' (')[0];
                  setAssets(assets => assets.map(a => {
                      if (a.name === assetName || item.name.includes(a.serial)) {
                          const updatedAsset = { ...a, status: 'Borrowed', holder: req.requester, currentRequestId: req.id, lastUpdated: new Date().toLocaleString('th-TH'), image: disburseData.images.length > 0 ? disburseData.images[0].name : a.image };
                          saveAssetToSheet(updatedAsset); // Sync inside loop (optimization: could batch)
                          return updatedAsset;
                      } return a;
                  }));
                  addInvLog('Borrow', item.name, 'Out', `ยืมโดย ${req.requester} (${req.id})`, disburseData.images);
              });
          }
          handleUpdateStatus(req.id, 'Completed', `จ่ายของ/ยืมของเรียบร้อย ${disburseData.note}`, disburseData.images);
          setShowDisburseModal(false);
          showToast('จ่ายของและบันทึกข้อมูลเรียบร้อย');
      };

      const openRejectModal = (reqId) => { setRejectData({ requestId: reqId, reason: '' }); setShowRejectModal(true); };
      const handleConfirmReject = () => { handleUpdateStatus(rejectData.requestId, 'Rejected', `ไม่อนุมัติ: ${rejectData.reason}`); setShowRejectModal(false); showToast('บันทึกการไม่อนุมัติเรียบร้อย'); };

      const handleUpdateStatus = (id, newStatus, note = '', images = [], attachments = []) => {
        setRequests(prev => prev.map(r => {
          if (r.id === id) {
            let updateData = { ...r, status: newStatus, history: [...r.history, createLog(STATUS_LABELS[newStatus], currentUserRole, note, images)] };
            if (!r.docNumber && ['Ordered', 'PR Issued', 'Ready to Disburse', 'Approved'].includes(newStatus)) {
                const shouldGenerate = (r.type === 'Local' && newStatus === 'Ordered') || (r.type === 'HO' && newStatus === 'PO Issued') || (r.type === 'Withdraw' && newStatus === 'Ready to Disburse') || (r.type === 'Borrow' && newStatus === 'Ready to Disburse');
                if (shouldGenerate) {
                    const count = getNextDocIndex(requests, r.type, r.purchaseType);
                    updateData.docNumber = generateDocId(r.type, count, r.purchaseType);
                }
            }
            if (selectedRequest && selectedRequest.id === id) setSelectedRequest(updateData);
            saveRequestToSheet(updateData); // Sync
            return updateData;
          }
          return r;
        }));
      };

      const openPRModal = (id) => { setPrData({ requestId: id, file: null, prNumber: '' }); setShowPRModal(true); };
      const handleSubmitPR = () => { 
          if (!prData.prNumber && !prData.file) { showToast('กรุณาระบุเลขที่หรือแนบไฟล์', 'error'); return; }
          const note = `PR: ${prData.prNumber} ${prData.file ? `[File: ${prData.file.name}]` : ''}`;
          const attachments = prData.file ? [prData.file] : [];
          handleUpdateStatus(prData.requestId, 'PR Issued', note, [], attachments); setShowPRModal(false); 
      };

      const openPOModal = (id) => { setPoData({ requestId: id, file: null, poNumber: '' }); setShowPOModal(true); };
      const handleSubmitPO = () => { 
          if (!poData.poNumber && !poData.file) { showToast('กรุณาระบุเลขที่หรือแนบไฟล์', 'error'); return; }
          const note = `PO: ${poData.poNumber} ${poData.file ? `[File: ${poData.file.name}]` : ''}`;
          const attachments = poData.file ? [poData.file] : [];
          handleUpdateStatus(poData.requestId, 'PO Issued', note, [], attachments); setShowPOModal(false); 
      };

      const openViewItem = (item) => { setViewingItem(item); setHistoryFilterItem(null); setHistorySearch(''); setShowItemDetailModal(true); };
      const openGeneralHistory = () => { setViewingItem(null); setHistoryFilterItem(null); setHistorySearch(''); setShowItemDetailModal(true); }
      const openImagePreview = (imageName) => { setPreviewImage(imageName); };
      const handleCardClick = (status) => { if (dashboardStatusFilter === status) setDashboardStatusFilter('All'); else setDashboardStatusFilter(status); };
      const handlePrint = () => { window.print(); };
      const openPOPreview = (req) => { setSelectedRequest(req); setShowPOPreviewModal(true); };

      const dashboardStats = useMemo(() => {
        const activeRequests = requests.filter(r => r.status !== 'Draft');
        const calcStats = (typeFilterFn) => {
            const reqs = activeRequests.filter(typeFilterFn);
            return {
                total: reqs.length,
                pending: reqs.filter(r => r.status.includes('Pending') || r.status === 'PR Issued' || r.status === 'Approved' || r.status === 'Revise Needed' || r.status === 'Contract Pending').length,
                processing: reqs.filter(r => ['Ordered', 'PO Issued', 'Shipping', 'Ready to Disburse', 'Contract Signed', 'Partially Received'].includes(r.status)).length,
                ready: reqs.filter(r => r.status === 'Ready to Disburse').length,
                completed: reqs.filter(r => r.status === 'Completed' || r.status === 'Returned').length
            };
        };
        return { purchase: calcStats(r => r.type === 'Local' || r.type === 'HO'), withdraw: calcStats(r => r.type === 'Withdraw' || r.type === 'Borrow') };
      }, [requests]);

      const dashboardRequests = useMemo(() => {
        let data = requests.filter(r => r.status !== 'Draft');
        if (dashboardView === 'Purchase') data = data.filter(r => r.type === 'Local' || r.type === 'HO'); else data = data.filter(r => r.type === 'Withdraw' || r.type === 'Borrow');
        if (dashboardSearch) { const lowerQ = dashboardSearch.toLowerCase(); data = data.filter(r => r.id.toLowerCase().includes(lowerQ) || r.items.some(i => i.name.toLowerCase().includes(lowerQ))); }
        if (dashboardStatusFilter !== 'All') {
           if (dashboardStatusFilter === 'Pending') data = data.filter(r => r.status.includes('Pending') || r.status === 'PR Issued' || r.status === 'Approved' || r.status === 'Revise Needed' || r.status === 'Contract Pending');
           else if (dashboardStatusFilter === 'Processing') data = data.filter(r => ['Ordered', 'PO Issued', 'Shipping', 'Ready to Disburse', 'Contract Signed', 'Partially Received'].includes(r.status));
           else if (dashboardStatusFilter === 'Ready') data = data.filter(r => r.status === 'Ready to Disburse');
           else if (dashboardStatusFilter === 'Completed') data = data.filter(r => r.status === 'Completed' || r.status === 'Returned');
        }
        return data;
      }, [requests, dashboardView, dashboardSearch, dashboardStatusFilter]);


      // --- RENDER ---
      
      if (isLoading) {
         return <div className="flex h-screen items-center justify-center bg-gray-50"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div></div>;
      }
      
      return (
        <div className="flex h-screen bg-gray-50 font-sans text-gray-800 overflow-hidden relative print:bg-white print:h-auto print:overflow-visible">
          
          {/* Print Styles */}
          <style>{`
            @media print {
              @page { size: A4; margin: 10mm; }
              body { background: white; -webkit-print-color-adjust: exact; }
              .no-print, aside, header, .modal-backdrop { display: none !important; }
              .print-only { display: block !important; position: static !important; width: 100% !important; height: auto !important; overflow: visible !important; }
              .print-container { width: 100%; padding: 0; margin: 0; border: none; shadow: none; }
            }
            .print-only { display: none; }
          `}</style>
    
          {/* Notification */}
          {notification && (
            <div className="absolute top-4 right-4 z-[60] px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 bg-gray-900 text-white animate-in slide-in-from-top-5 no-print">
               {notification.type === 'error' ? <AlertCircle className="w-5 h-5"/> : <Bell className="w-5 h-5"/>}
               <p className="text-sm font-medium">{notification.message}</p>
            </div>
          )}
    
          {/* Sidebar */}
          <aside className="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col shadow-lg z-20 no-print">
            <div className="p-6 border-b border-gray-100"><h1 className="text-2xl font-bold text-blue-700 flex items-center gap-2"><Package className="w-8 h-8" /> Purchase<span className="text-gray-800">Hub</span></h1></div>
            <nav className="flex-1 p-4 space-y-1">
              <button onClick={() => setActiveTab('dashboard')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'dashboard' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}><LayoutDashboard className="w-5 h-5" /> ภาพรวม (Dashboard)</button>
              <button onClick={() => setActiveTab('orders')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'orders' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}><ShoppingCart className="w-5 h-5" /> รายการสั่งซื้อ/เบิก</button>
              <button onClick={() => setActiveTab('inventory')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'inventory' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}><Box className="w-5 h-5" /> คลังสินค้า (Store)</button>
              <button onClick={() => setActiveTab('assets')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'assets' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}><Monitor className="w-5 h-5" /> ทะเบียนทรัพย์สิน</button>
            </nav>
            <div className="p-4 bg-gray-50 m-4 rounded-xl border border-gray-200"><p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 flex items-center gap-1"><User className="w-3 h-3"/> จำลองผู้ใช้งาน (Role)</p><select value={currentUserRole} onChange={(e) => setCurrentUserRole(e.target.value)} className="w-full p-2 text-sm border-gray-300 rounded-md focus:ring-blue-500 bg-white shadow-sm cursor-pointer">{Object.entries(ROLES).map(([key, role]) => <option key={key} value={role}>{role}</option>)}</select></div>
          </aside>
    
          <main className="flex-1 flex flex-col overflow-hidden relative no-print">
            {/* Header */}
            <header className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm z-10">
              <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                 {activeTab === 'dashboard' && 'ภาพรวมระบบ'}
                 {activeTab === 'orders' && `รายการที่ต้องทำ (${currentUserRole === ROLES.USER ? 'งานของฉัน' : 'รอการดำเนินการ'})`}
                 {activeTab === 'inventory' && 'คลังสินค้า (Inventory)'}
                 {activeTab === 'assets' && 'ทะเบียนทรัพย์สิน (Assets)'}
              </h2>
              <div className="flex items-center gap-4">
                 <div className="hidden md:flex items-center gap-2 text-sm text-gray-700 bg-gray-100 px-3 py-1.5 rounded-full border border-gray-200"><span className="font-semibold">{currentUserRole}</span></div>
                 <button onClick={handleOpenCreateModal} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-md"><Plus className="w-4 h-4" /> สร้างคำสั่งซื้อ/เบิก/ยืม</button>
              </div>
            </header>
    
            {/* Content */}
            <div className="flex-1 overflow-auto p-6 bg-slate-50">
              {activeTab === 'dashboard' && (
                <div className="space-y-6 max-w-7xl mx-auto">
                   <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                      <div className={`p-5 rounded-2xl border bg-white shadow-sm cursor-pointer transition-all hover:shadow-md ${dashboardStatusFilter === 'Pending' ? 'ring-2 ring-amber-500 bg-amber-50' : ''}`} onClick={() => handleCardClick('Pending')}>
                          <div className="flex justify-between items-start mb-2"><div className="p-2 bg-amber-100 rounded-lg"><Clock className="w-6 h-6 text-amber-600"/></div><span className="text-2xl font-bold text-gray-800">{dashboardView === 'Purchase' ? dashboardStats.purchase.pending : dashboardStats.withdraw.pending}</span></div>
                          <p className="text-sm text-gray-500 font-medium">รออนุมัติ/ตรวจสอบ</p>
                      </div>
                      <div className={`p-5 rounded-2xl border bg-white shadow-sm cursor-pointer transition-all hover:shadow-md ${dashboardStatusFilter === 'Processing' ? 'ring-2 ring-blue-500 bg-blue-50' : ''}`} onClick={() => handleCardClick('Processing')}>
                          <div className="flex justify-between items-start mb-2"><div className="p-2 bg-blue-100 rounded-lg"><Truck className="w-6 h-6 text-blue-600"/></div><span className="text-2xl font-bold text-gray-800">{dashboardView === 'Purchase' ? dashboardStats.purchase.processing : dashboardStats.withdraw.processing}</span></div>
                          <p className="text-sm text-gray-500 font-medium">กำลังดำเนินการ/สั่งซื้อ</p>
                      </div>
                      <div className={`p-5 rounded-2xl border bg-white shadow-sm cursor-pointer transition-all hover:shadow-md ${dashboardStatusFilter === 'Ready' ? 'ring-2 ring-purple-500 bg-purple-50' : ''}`} onClick={() => handleCardClick('Ready')}>
                          <div className="flex justify-between items-start mb-2"><div className="p-2 bg-purple-100 rounded-lg"><Package className="w-6 h-6 text-purple-600"/></div><span className="text-2xl font-bold text-gray-800">{dashboardView === 'Purchase' ? dashboardStats.purchase.ready : dashboardStats.withdraw.ready}</span></div>
                          <p className="text-sm text-gray-500 font-medium">รอจ่ายของ/เบิก</p>
                      </div>
                      <div className={`p-5 rounded-2xl border bg-white shadow-sm cursor-pointer transition-all hover:shadow-md ${dashboardStatusFilter === 'Completed' ? 'ring-2 ring-green-500 bg-green-50' : ''}`} onClick={() => handleCardClick('Completed')}>
                          <div className="flex justify-between items-start mb-2"><div className="p-2 bg-green-100 rounded-lg"><CheckCircle className="w-6 h-6 text-green-600"/></div><span className="text-2xl font-bold text-gray-800">{dashboardView === 'Purchase' ? dashboardStats.purchase.completed : dashboardStats.withdraw.completed}</span></div>
                          <p className="text-sm text-gray-500 font-medium">เสร็จสิ้น/รับของแล้ว</p>
                      </div>
                   </div>
                   <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                     <div className="flex bg-gray-200 p-1 rounded-lg">
                        <button onClick={() => setDashboardView('Purchase')} className={`px-4 py-2 rounded-md text-sm font-bold transition-all flex items-center gap-2 ${dashboardView === 'Purchase' ? 'bg-white text-blue-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}><ShoppingCart className="w-4 h-4"/> งานสั่งซื้อ</button>
                        <button onClick={() => setDashboardView('Withdraw')} className={`px-4 py-2 rounded-md text-sm font-bold transition-all flex items-center gap-2 ${dashboardView === 'Withdraw' ? 'bg-white text-pink-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}><ArrowLeftRight className="w-4 h-4"/> งานเบิก/ยืม</button>
                     </div>
                     <div className="relative w-full md:w-96"><Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/><input type="text" className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="ค้นหารายการ..." value={dashboardSearch} onChange={e => setDashboardSearch(e.target.value)}/></div>
                  </div>
                  {dashboardRequests.length > 0 ? (
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                          <div className="overflow-x-auto">
                              <table className="w-full text-sm text-left">
                                  <thead className="bg-gray-100 text-gray-600 font-medium border-b">
                                      <tr><th className="px-6 py-3">ID</th><th className="px-6 py-3">เรื่อง</th><th className="px-6 py-3">ผู้ขอ</th><th className="px-6 py-3">วันที่</th><th className="px-6 py-3 text-center">สถานะ</th><th className="px-6 py-3 text-right">Action</th></tr>
                                  </thead>
                                  <tbody className="divide-y">
                                      {dashboardRequests.slice(0, 5).map(req => (
                                          <tr key={req.id} className="hover:bg-gray-50">
                                              <td className="px-6 py-4 font-bold text-blue-600">{req.id}</td>
                                              <td className="px-6 py-4">{req.items[0]?.name} <span className="text-gray-400 text-xs">+{req.items.length - 1} more</span></td>
                                              <td className="px-6 py-4">{req.requester}</td>
                                              <td className="px-6 py-4 text-gray-500">{req.created}</td>
                                              <td className="px-6 py-4 text-center"><StatusBadge status={req.status} /></td>
                                              <td className="px-6 py-4 text-right"><button onClick={() => { setSelectedRequest(req); setShowDetailModal(true); }} className="text-gray-400 hover:text-blue-600"><ChevronRight className="w-5 h-5"/></button></td>
                                          </tr>
                                      ))}
                                  </tbody>
                              </table>
                          </div>
                          {dashboardRequests.length > 5 && <div className="p-3 text-center bg-gray-50 text-xs text-blue-600 cursor-pointer font-bold hover:bg-gray-100" onClick={() => setActiveTab('orders')}>ดูทั้งหมด ({dashboardRequests.length})</div>}
                      </div>
                  ) : (
                      <div className="text-center py-10 bg-white rounded-xl border border-dashed border-gray-300 text-gray-400">
                          <Package className="w-12 h-12 mx-auto mb-3 text-gray-300"/>
                          <p>ไม่พบรายการที่ค้นหา</p>
                      </div>
                  )}
                </div>
              )}
    
              {activeTab === 'orders' && (
                 <div className="space-y-6 max-w-7xl mx-auto">
                     <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-wrap gap-4 items-center justify-between">
                         <div className="flex items-center gap-4 flex-1 min-w-[200px]">
                          <div className="relative flex-1">
                              <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                              <input type="text" className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none" placeholder="ค้นหา..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}/>
                          </div>
                      </div>
                     </div>
                     <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <div className="divide-y divide-gray-100">
                            {filteredRequests.map(req => (
                                <div key={req.id} className="p-5 hover:bg-slate-50 transition-colors group">
                                     <div className="flex justify-between mb-2">
                                        <div className="flex items-center gap-3">
                                            <span className={`text-[10px] px-2 py-0.5 rounded-full border font-bold ${req.type === 'Local' ? 'bg-orange-50 text-orange-700' : req.type === 'Withdraw' ? 'bg-pink-50 text-pink-700' : req.type === 'Borrow' ? 'bg-blue-50 text-blue-700' : 'bg-purple-50 text-purple-700'}`}>{req.type}</span>
                                            <span className="text-xs text-gray-400">{req.id}</span>
                                            <DocIdBadge type={req.type} id={req.docNumber} />
                                            <h4 className="font-bold text-gray-900 text-sm">{req.items[0]?.name}</h4>
                                        </div>
                                        <StatusBadge status={req.status} />
                                    </div>
                                    <ProgressBar request={req} />
                                    <div className="flex justify-end gap-2 mt-2">
                                        {currentUserRole === ROLES.USER && req.status === 'Draft' && (<button type="button" onClick={() => handleEditDraft(req)} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-sm"><Edit className="w-4 h-4"/> แก้ไขแบบร่าง</button>)}
                                        {currentUserRole === ROLES.USER && req.status === 'Revise Needed' && (<button type="button" onClick={() => handleRevise(req)} className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 shadow-sm animate-pulse"><Edit className="w-4 h-4"/> แก้ไขข้อมูล/ส่งใหม่</button>)}
                                        {currentUserRole === ROLES.USER && (req.status.includes('Pending')) && (<button type="button" onClick={() => initiateRecall(req.id)} className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 shadow-sm"><RotateCcw className="w-4 h-4"/> เรียกคืน</button>)}
                                        {(req.status === 'Approved' || req.status === 'Ordered') && req.type === 'Local' && (
                                           <button type="button" onClick={() => openPOPreview(req)} className="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 border border-blue-200 text-sm font-medium rounded-lg hover:bg-blue-100 shadow-sm"><Printer className="w-4 h-4"/> พิมพ์</button>
                                        )}
                                        
                                        <button type="button" onClick={() => { setSelectedRequest(req); setShowDetailModal(true); }} className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 shadow-sm"><History className="w-4 h-4"/> ประวัติ/รายละเอียด</button>
                                        
                                        {req.status !== 'Draft' && (
                                            <>
                                            {(currentUserRole === ROLES.DEPT_HEAD || currentUserRole === ROLES.ADMIN) && req.status === 'Pending Head' && (
                                                <>
                                                    <button type="button" onClick={() => openRejectModal(req.id)} className="px-4 py-2 border border-red-300 text-red-600 text-sm font-medium rounded-lg hover:bg-red-50 shadow-sm">ไม่อนุมัติ</button>
                                                    <button type="button" onClick={() => handleUpdateStatus(req.id, (req.type === 'Withdraw' || req.type === 'Borrow') ? 'Ready to Disburse' : 'Pending PM')} className="px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700 shadow-sm">{(req.type === 'Withdraw' || req.type === 'Borrow') ? 'อนุมัติเบิก/ยืม' : 'ส่งต่อ PM'}</button>
                                                </>
                                            )}
                                            {(currentUserRole === ROLES.PM || currentUserRole === ROLES.ADMIN) && req.status === 'Pending PM' && (
                                                <>
                                                    <button type="button" onClick={() => openRejectModal(req.id)} className="px-4 py-2 border border-red-300 text-red-600 text-sm font-medium rounded-lg hover:bg-red-50 shadow-sm">ไม่อนุมัติ</button>
                                                    <button type="button" onClick={() => handleApprovalUpdate(req.id, 'Approved')} className="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 shadow-sm">อนุมัติการสั่งซื้อ</button>
                                                </>
                                            )}
                                            {(currentUserRole === ROLES.STORE || currentUserRole === ROLES.ADMIN) && (req.type === 'Withdraw' || req.type === 'Borrow') && req.status === 'Ready to Disburse' && (
                                                <button type="button" onClick={() => openDisburseModal(req.id)} className="px-4 py-2 bg-teal-600 text-white text-sm font-medium rounded-lg hover:bg-teal-700 shadow-sm">จ่ายของ & ตัดสต็อก/ยืม</button>
                                            )}
                                            {(currentUserRole === ROLES.PURCHASING || currentUserRole === ROLES.ADMIN) && req.type === 'Local' && req.status === 'Approved' && (<button type="button" onClick={() => handleUpdateStatus(req.id, 'Ordered')} className="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 shadow-sm">สั่งซื้อ (Local)</button>)}
                                            {(currentUserRole === ROLES.PURCHASING || currentUserRole === ROLES.ADMIN) && req.type === 'Local' && (req.status === 'Ordered' || req.status === 'Partially Received') && (<button type="button" onClick={() => openReceiveModal(req)} className="px-4 py-2 bg-teal-600 text-white text-sm font-medium rounded-lg hover:bg-teal-700 shadow-sm">รับของ/ปิดงาน</button>)}
                                          
                                            {(currentUserRole === ROLES.PURCHASING || currentUserRole === ROLES.ADMIN) && req.type === 'HO' && req.status === 'Pending Check' && (
                                                <button type="button" onClick={() => openVerificationModal(req.id)} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-sm"><CheckSquare className="w-4 h-4"/> ตรวจสอบเอกสาร (Verify)</button>
                                            )}
                                            
                                            {/* --- HO Buy Flow --- */}
                                            {(currentUserRole === ROLES.PURCHASING || currentUserRole === ROLES.ADMIN) && req.type === 'HO' && req.purchaseType === 'Buy' && req.status === 'Approved' && (
                                                <button type="button" onClick={() => openPRModal(req.id)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 shadow-sm">ออก PR</button>
                                            )}
                                            {(currentUserRole === ROLES.PURCHASING || currentUserRole === ROLES.ADMIN) && req.type === 'HO' && req.purchaseType === 'Buy' && req.status === 'PR Issued' && (<button type="button" onClick={() => openPOModal(req.id)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 shadow-sm">ออก PO</button>)}
                                            {(currentUserRole === ROLES.PURCHASING || currentUserRole === ROLES.ADMIN) && req.type === 'HO' && req.purchaseType === 'Buy' && req.status === 'PO Issued' && (<button type="button" onClick={() => handleUpdateStatus(req.id, 'Shipping')} className="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-sm">อัปเดตส่งของ</button>)}
                                            
                                            {/* --- HO Rent Flow --- */}
                                            {(currentUserRole === ROLES.PURCHASING || currentUserRole === ROLES.ADMIN) && req.type === 'HO' && req.purchaseType === 'Rent' && req.status === 'Contract Pending' && (
                                                <button type="button" onClick={() => handleUpdateStatus(req.id, 'Contract Signed')} className="flex items-center gap-2 px-4 py-2 bg-teal-600 text-white text-sm font-medium rounded-lg hover:bg-teal-700 shadow-sm"><FileSignature className="w-4 h-4"/> บันทึกทำสัญญาแล้ว</button>
                                            )}
                                            {(currentUserRole === ROLES.PURCHASING || currentUserRole === ROLES.ADMIN) && req.type === 'HO' && req.purchaseType === 'Rent' && req.status === 'Contract Signed' && (
                                                <button type="button" onClick={() => handleUpdateStatus(req.id, 'Shipping')} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-sm"><Truck className="w-4 h-4"/> เริ่มจัดส่ง/ส่งมอบ</button>
                                            )}
    
                                            {(currentUserRole === ROLES.PURCHASING || currentUserRole === ROLES.ADMIN) && req.type === 'HO' && (req.status === 'Shipping' || req.status === 'Partially Received') && (<button type="button" onClick={() => openReceiveModal(req)} className="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 shadow-sm">ยืนยันได้รับของ</button>)}
                                            
                                            {(currentUserRole === ROLES.PURCHASING || currentUserRole === ROLES.ADMIN) && req.type === 'HO' && req.purchaseType === 'Rent' && req.status === 'Approved' && (
                                                req.needContract !== false 
                                                ? <button type="button" onClick={() => handleUpdateStatus(req.id, 'Contract Pending')} className="flex items-center gap-2 px-4 py-2 bg-teal-600 text-white text-sm font-medium rounded-lg hover:bg-teal-700 shadow-sm">ทำสัญญาต่อ (หลังอนุมัติ)</button>
                                                : <button type="button" onClick={() => handleUpdateStatus(req.id, 'Shipping')} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-sm">จัดส่งต่อ (หลังอนุมัติ)</button>
                                            )}
                                            </>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                     </div>
                 </div>
              )}
    
              {/* INVENTORY TAB */}
              {activeTab === 'inventory' && (
                <div className="space-y-6 max-w-7xl mx-auto">
                   <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                      <div className="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
                         <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2"><Box className="w-5 h-5"/> คลังวัสดุสิ้นเปลือง</h3>
                         <div className="flex gap-2">
                           <button onClick={() => openGeneralHistory()} className="text-gray-600 text-sm font-medium flex items-center gap-1 hover:bg-gray-100 px-3 py-1.5 rounded"><ClipboardList className="w-4 h-4"/> ประวัติรวม</button>
                           {(currentUserRole === ROLES.STORE || currentUserRole === ROLES.ADMIN) && (
                             <button onClick={() => { setShowAddInvModal(true); setNewStockItem({ name: '', qty: 0, unit: 'ชิ้น', minStock: 0, price: 0, images: [] }); }} className="bg-green-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-1.5 rounded hover:bg-green-700"><Plus className="w-4 h-4"/> เพิ่มสินค้า</button>
                           )}
                         </div>
                      </div>
                      <table className="w-full text-sm text-left">
                         <thead className="bg-gray-100 text-gray-600">
                            <tr>
                                <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('id', invSort, setInvSort)}>รหัส <ArrowUpDown className="w-3 h-3 inline"/></th>
                                <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('name', invSort, setInvSort)}>ชื่อสินค้า <ArrowUpDown className="w-3 h-3 inline"/></th>
                                <th className="px-6 py-3 text-center cursor-pointer hover:bg-gray-200" onClick={() => handleSort('qty', invSort, setInvSort)}>คงเหลือ <ArrowUpDown className="w-3 h-3 inline"/></th>
                                <th className="px-6 py-3 text-center">สถานะ</th>
                                <th className="px-6 py-3 text-center">อัปเดตล่าสุด</th>
                                <th className="px-6 py-3 text-center">รูปภาพ</th>
                                <th className="px-6 py-3 text-right">จัดการ</th>
                            </tr>
                         </thead>
                         <tbody className="divide-y">
                            {filteredInventory.map(inv => (
                               <tr key={inv.id} onClick={() => openViewItem(inv)} className="hover:bg-gray-50 cursor-pointer">
                                  <td className="px-6 py-4 font-medium text-gray-500">{inv.id}</td>
                                  <td className="px-6 py-4 font-medium text-gray-900">{inv.name}</td>
                                  <td className="px-6 py-4 text-center"><span className="text-lg font-bold text-blue-600">{inv.qty}</span> {inv.unit}</td>
                                  <td className="px-6 py-4 text-center">{inv.qty < inv.minStock ? <span className="text-red-600 text-xs font-bold">ต่ำกว่าเกณฑ์</span> : <span className="text-green-600 text-xs">ปกติ</span>}</td>
                                  <td className="px-6 py-4 text-center text-xs text-gray-500">{inv.lastUpdated || '-'}</td>
                                  <td className="px-6 py-4 text-center">{inv.image ? <ImageIcon className="w-4 h-4 text-blue-500 mx-auto"/> : '-'}</td>
                                  <td className="px-6 py-4 text-right flex items-center justify-end gap-2">
                                      {(currentUserRole === ROLES.STORE || currentUserRole === ROLES.ADMIN) && 
                                         <button onClick={(e) => { e.stopPropagation(); setEditingStockItem(inv); setShowEditInvModal(true); }} className="text-blue-600 bg-blue-50 p-1.5 rounded hover:bg-blue-100">
                                            <Edit className="w-4 h-4"/>
                                        </button>
                                      }
                                  </td>
                               </tr>
                            ))}
                         </tbody>
                      </table>
                   </div>
                </div>
              )}
    
              {/* ASSETS TAB */}
              {activeTab === 'assets' && (
                <div className="space-y-6 max-w-7xl mx-auto">
                   <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                      <div className="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
                         <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2"><Monitor className="w-5 h-5"/> ทะเบียนทรัพย์สิน</h3>
                         <div className="flex gap-3">
                            <div className="flex bg-gray-100 p-1 rounded-lg">
                                <button onClick={() => setAssetTabMode('Company')} className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all flex items-center gap-2 ${assetTabMode === 'Company' ? 'bg-white text-blue-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                                    <BriefcaseIcon className="w-4 h-4"/> ทรัพย์สินบริษัท
                                </button>
                                <button onClick={() => setAssetTabMode('Rent')} className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all flex items-center gap-2 ${assetTabMode === 'Rent' ? 'bg-white text-teal-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                                    <Clock className="w-4 h-4"/> ทรัพย์สินเช่า
                                </button>
                            </div>
                            <button onClick={() => openGeneralHistory()} className="text-gray-600 text-sm font-medium flex items-center gap-1 hover:bg-gray-100 px-3 py-1.5 rounded"><ClipboardList className="w-4 h-4"/> ประวัติรวม</button>
                            {(currentUserRole === ROLES.STORE || currentUserRole === ROLES.ADMIN) && (
                                <button onClick={() => { setShowAssetModal(true); setNewAssetItem({ id: '', name: '', serial: '', status: 'Available', condition: 'Good', price: 0, images: [] }); }} className="bg-indigo-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-1.5 rounded hover:bg-indigo-700"><Plus className="w-4 h-4"/> เพิ่มทรัพย์สิน</button>
                            )}
                         </div>
                      </div>
                      <div className="overflow-x-auto">
                          <table className="w-full text-sm text-left min-w-[1000px]">
                         <thead className="bg-gray-100 text-gray-600">
                            <tr>
                                <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('id', assetSort, setAssetSort)}>รหัสทรัพย์สิน <ArrowUpDown className="w-3 h-3 inline"/></th>
                                <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('name', assetSort, setAssetSort)}>รายการ <ArrowUpDown className="w-3 h-3 inline"/></th>
                                <th className="px-6 py-3">Serial No.</th>
                                <th className="px-6 py-3 text-center">สถานะ</th>
                                {assetTabMode === 'Rent' && <th className="px-6 py-3">ระยะเวลาเช่า</th>}
                                {assetTabMode === 'Rent' && <th className="px-6 py-3 text-right">ราคาเช่า</th>}
                                <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('holder', assetSort, setAssetSort)}>ผู้ถือครอง <ArrowUpDown className="w-3 h-3 inline"/></th>
                                <th className="px-6 py-3 text-center">อัปเดตล่าสุด</th>
                                <th className="px-6 py-3 text-center">รูปภาพ</th>
                                <th className="px-6 py-3 text-right">จัดการ</th>
                            </tr>
                         </thead>
                         <tbody className="divide-y">{filteredAssets.map(ast => (
                            <tr key={ast.id} onClick={() => openViewItem(ast)} className="hover:bg-gray-50 cursor-pointer">
                               <td className="px-6 py-4 font-medium text-gray-500">{ast.id}</td>
                               <td className="px-6 py-4 font-medium text-gray-900">{ast.name}</td>
                               <td className="px-6 py-4 text-gray-500">{ast.serial}</td>
                               <td className="px-6 py-4 text-center">
                                   {ast.status === 'Available' ? <span className="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">ว่าง</span> :
                                    ast.status === 'Borrowed' ? <span className="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs">ถูกยืม</span> :
                                    <span className="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">{ast.status}</span>}
                               </td>
                               {assetTabMode === 'Rent' && (
                                   <td className="px-6 py-4 text-xs">
                                       <div className="flex flex-col gap-1">
                                           <span className="flex items-center gap-1 text-green-700"><Calendar className="w-3 h-3"/> {ast.rentalStart || '-'}</span>
                                           <span className="flex items-center gap-1 text-red-700"><CalendarClock className="w-3 h-3"/> {ast.rentalEnd || '-'}</span>
                                       </div>
                                   </td>
                               )}
                               {assetTabMode === 'Rent' && (
                                   <td className="px-6 py-4 text-right font-medium text-gray-900">
                                       {ast.rentalPrice?.toLocaleString()} <span className="text-gray-400 text-xs font-normal">{RENTAL_UNITS[ast.rentalUnit]}</span>
                                   </td>
                               )}
                               <td className="px-6 py-4">{ast.holder}</td>
                               <td className="px-6 py-4 text-center text-xs text-gray-500">{ast.lastUpdated || '-'}</td>
                               <td className="px-6 py-4 text-center">
                                    {ast.image ? <ImageIcon className="w-4 h-4 text-blue-500 mx-auto"/> : <span className="text-xs text-gray-400">-</span>}
                               </td>
                               <td className="px-6 py-4 text-right flex items-center justify-end gap-2">
                                   {(currentUserRole === ROLES.STORE || currentUserRole === ROLES.ADMIN) && (
                                       <>
                                         {ast.status === 'Borrowed' && (
                                            <button onClick={(e) => { e.stopPropagation(); initiateReturnAsset(ast); }} className="bg-teal-50 text-teal-600 px-3 py-1 rounded text-xs font-bold hover:bg-teal-100">
                                              รับคืน
                                            </button>
                                         )}
                                         <button onClick={(e) => { e.stopPropagation(); setEditingAssetItem({...ast, note: ''}); setShowEditAssetModal(true); }} className={`p-1.5 rounded ${ast.status === 'Borrowed' ? 'text-gray-300 cursor-not-allowed' : 'text-blue-600 hover:bg-blue-50'}`} disabled={ast.status === 'Borrowed'}>
                                              <Edit className="w-4 h-4"/>
                                         </button>
                                       </>
                                   )}
                               </td>
                            </tr>
                         ))}</tbody>
                      </table>
                      </div>
                   </div>
                </div>
              )}
            </div>
          </main>
    
          {/* Create Modal */}
      {showCreateModal && (
            <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[90vh] overflow-y-auto">
                <div className="px-6 py-5 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-blue-50 to-white">
                  <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2">{editingId ? <Edit className="w-6 h-6 text-blue-600"/> : <Plus className="w-6 h-6 text-blue-600"/>} {editingId ? `แก้ไขแบบร่าง` : 'สร้างคำขอใหม่'}</h3>
                  <button onClick={handleCloseCreateModal} className="text-gray-400 hover:text-gray-600"><X className="w-5 h-5" /></button>
                </div>
                <form className="p-8 space-y-6">
                  <div className="grid grid-cols-2 gap-3 mb-2">
                     <button type="button" onClick={() => setNewOrderMeta({...newOrderMeta, type: 'Local'})} className={`p-3 rounded-xl border-2 text-center ${newOrderMeta.type === 'Local' ? 'bg-orange-50 border-orange-500 text-orange-800' : 'border-gray-200'}`}><HardHat className="w-5 h-5 mx-auto mb-1"/> ซื้อ (Local)</button>
                     <button type="button" onClick={() => setNewOrderMeta({...newOrderMeta, type: 'HO'})} className={`p-3 rounded-xl border-2 text-center ${newOrderMeta.type === 'HO' ? 'bg-purple-50 border-purple-500 text-purple-800' : 'border-gray-200'}`}><Building className="w-5 h-5 mx-auto mb-1"/> ซื้อ (HO)</button>
                     <button type="button" onClick={() => setNewOrderMeta({...newOrderMeta, type: 'Withdraw'})} className={`p-3 rounded-xl border-2 text-center ${newOrderMeta.type === 'Withdraw' ? 'bg-pink-50 border-pink-500 text-pink-800' : 'border-gray-200'}`}><Package className="w-5 h-5 mx-auto mb-1"/> เบิกวัสดุ</button>
                     <button type="button" onClick={() => setNewOrderMeta({...newOrderMeta, type: 'Borrow'})} className={`p-3 rounded-xl border-2 text-center ${newOrderMeta.type === 'Borrow' ? 'bg-blue-50 border-blue-500 text-blue-800' : 'border-gray-200'}`}><Monitor className="w-5 h-5 mx-auto mb-1"/> ยืมทรัพย์สิน</button>
                  </div>
                  
                  {newOrderMeta.type === 'HO' && (
                      <div className="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100 mb-2 flex gap-4">
                         <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="purchaseType" className="text-indigo-600" checked={newOrderMeta.purchaseType === 'Buy'} onChange={() => setNewOrderMeta({...newOrderMeta, purchaseType: 'Buy'})} /><span className="text-sm font-medium">ซื้อขาด (Buy)</span></label>
                         <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="purchaseType" className="text-indigo-600" checked={newOrderMeta.purchaseType === 'Rent'} onChange={() => setNewOrderMeta({...newOrderMeta, purchaseType: 'Rent'})} /><span className="text-sm font-medium">เช่า (Rent)</span></label>
                      </div>
                  )}
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div className="col-span-2">
                        <label className="block text-sm font-medium text-gray-700 mb-1.5">ชื่อโครงการ (Project Name)</label>
                        <input required type="text" className="w-full p-2.5 border border-gray-300 rounded-xl" placeholder="ระบุชื่อโครงการ..." value={newOrderMeta.job} onChange={e => setNewOrderMeta({...newOrderMeta, job: e.target.value})}/>
                    </div>
                    
                    {newOrderMeta.type !== 'Borrow' && (
                        <div className="col-span-1">
                            <label className="block text-sm font-medium text-gray-700 mb-1.5">ความสำคัญ (Priority)</label>
                            <div className="flex gap-2">
                                {Object.entries(PRIORITIES).map(([key, conf]) => (
                                    <button key={key} type="button" onClick={() => setNewOrderMeta({...newOrderMeta, priority: key})} className={`flex-1 py-2 rounded-lg text-sm font-bold border-2 transition-all ${newOrderMeta.priority === key ? `${conf.color} border-current` : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'}`}>
                                        {conf.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    <div className={newOrderMeta.type === 'Borrow' ? "col-span-2" : "col-span-1"}>
                        <label className="block text-sm font-medium text-gray-700 mb-1.5">วันที่ใช้</label>
                        <input required type="date" className="w-full p-2.5 border border-gray-300 rounded-xl" value={newOrderMeta.dateRequired} onChange={e => setNewOrderMeta({...newOrderMeta, dateRequired: e.target.value})}/>
                    </div>
                  </div>
    
                  {stockSuggestion && (
                     <div className="bg-green-50 border border-green-200 p-3 rounded-lg flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-2 text-green-800 text-sm"><CheckCircle className="w-5 h-5 text-green-600"/><span>มี <b>{stockSuggestion.name}</b> {stockSuggestion.matchType === 'Withdraw' ? `ในคลัง ${stockSuggestion.qty} ${stockSuggestion.unit}` : 'ว่างพร้อมยืม'}</span></div>
                        <button type="button" onClick={() => { setNewOrderMeta({...newOrderMeta, type: stockSuggestion.type === 'Asset' ? 'Borrow' : 'Withdraw'}); selectSuggestion(stockSuggestion); }} className="bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-green-700">เปลี่ยนประเภท</button>
                     </div>
                  )}
    
                  <div className="bg-gray-50 p-5 rounded-2xl border border-gray-200 relative">
                      <h4 className="font-bold text-gray-700 mb-3 flex items-center gap-2"><ShoppingCart className="w-4 h-4"/> รายการ</h4>
                      
                      {newOrderMeta.type !== 'Borrow' ? (
                          <div className="space-y-3">
                              <div className="grid grid-cols-12 gap-2">
                                  <div className="col-span-8">
                                      <label className="text-xs text-gray-500 mb-1 block">ชื่อรายการ</label>
                                      <div className="relative">
                                        <input type="text" className="w-full p-2 border rounded-lg text-sm" placeholder="ระบุชื่อสินค้า..." value={tempItem.name} onChange={e => setTempItem({...tempItem, name: e.target.value})} />
                                        <button type="button" onClick={() => setShowSelectionModal(true)} className="absolute right-2 top-2 text-gray-400 hover:text-blue-600">
                                            <List className="w-5 h-5"/>
                                        </button>
                                      </div>
                                  </div>
                                  <div className="col-span-2">
                                      <label className="text-xs text-gray-500 mb-1 block">จำนวน</label>
                                      <input type="number" min="1" className="w-full p-2 border rounded-lg text-sm" value={tempItem.qty} onChange={e => setTempItem({...tempItem, qty: parseInt(e.target.value) || 0})} />
                                  </div>
                                  <div className="col-span-2">
                                      <label className="text-xs text-gray-500 mb-1 block">หน่วย</label>
                                      <select className="w-full p-2 border rounded-lg text-sm bg-white" value={tempItem.unit} onChange={e => setTempItem({...tempItem, unit: e.target.value})}>
                                          {ITEM_UNITS.map(u => <option key={u} value={u}>{u}</option>)}
                                      </select>
                                  </div>
                              </div>
                              <div className="grid grid-cols-12 gap-2">
                                  <div className="col-span-4">
                                      <label className="text-xs text-gray-500 mb-1 block">SubJob</label>
                                      <input type="text" className="w-full p-2 border rounded-lg text-sm" value={tempItem.subJob} onChange={e => setTempItem({...tempItem, subJob: e.target.value})} />
                                  </div>
                                  <div className="col-span-4">
                                      <label className="text-xs text-gray-500 mb-1 block">EP Code</label>
                                      <input type="text" className="w-full p-2 border rounded-lg text-sm" value={tempItem.epCode} onChange={e => setTempItem({...tempItem, epCode: e.target.value})} />
                                  </div>
                                  <div className="col-span-4">
                                      <label className="text-xs text-gray-500 mb-1 block">ราคา/หน่วย (บาท)</label>
                                      <input type="number" min="0" disabled={newOrderMeta.type === 'Withdraw'} className="w-full p-2 border rounded-lg text-sm" value={tempItem.unitPrice} onChange={e => setTempItem({...tempItem, unitPrice: parseFloat(e.target.value) || 0})} />
                                  </div>
                              </div>
                              <div>
                                  <label className="text-xs text-gray-500 mb-1 block">หมายเหตุ</label>
                                  <input type="text" className="w-full p-2 border rounded-lg text-sm" placeholder="รายละเอียดเพิ่มเติม..." value={tempItem.note} onChange={e => setTempItem({...tempItem, note: e.target.value})} />
                              </div>
                          </div>
                      ) : (
                          <div className="grid grid-cols-12 gap-2 items-end">
                              <div className="col-span-10">
                                  <label className="text-xs text-gray-500 mb-1 block">ชื่อทรัพย์สิน (ค้นหาจากทะเบียน)</label>
                                 <div className="relative">
                                     <input type="text" className="w-full p-2 border rounded-lg text-sm" placeholder="ค้นหา..." value={tempItem.name} onChange={e => setTempItem({...tempItem, name: e.target.value})} onClick={() => setShowSelectionModal(true)}/>
                                     <Search className="absolute right-3 top-2.5 w-4 h-4 text-gray-400"/>
                                 </div>
                              </div>
                              <div className="col-span-2">
                                 <label className="text-xs text-gray-500 mb-1 block">จำนวน</label>
                                 <input type="number" value={1} disabled className="w-full p-2 border rounded-lg text-sm bg-gray-100 text-center"/>
                              </div>
                          </div>
                      )}
    
                      <button type="button" onClick={handleAddItem} className="w-full bg-blue-600 text-white p-2 rounded-lg text-sm font-medium hover:bg-blue-700 mt-4">เพิ่มรายการ</button>
    
                      <div className="bg-white border rounded-xl overflow-hidden mt-4">
                        <table className="w-full text-sm"><thead className="bg-gray-100 text-gray-500 text-left"><tr><th className="p-3 font-normal">รายการ</th>
                        {newOrderMeta.type !== 'Borrow' && <><th className="p-3">SubJob/EP</th><th className="p-3">หมายเหตุ</th></>}
                        <th className="p-3 text-center">Qty</th><th className="p-3 text-right">Unit</th><th className="p-3"></th></tr></thead>
                           <tbody className="divide-y">{orderItems.map((itm, idx) => (
                               <tr key={idx}>
                                   <td className="p-3 text-gray-800"><p className="font-bold">{itm.name}</p></td>
                                   {newOrderMeta.type !== 'Borrow' && (
                                       <>
                                       <td className="p-3 text-xs text-gray-500"><p>Sub: {itm.subJob || '-'}</p><p>EP: {itm.epCode || '-'}</p></td>
                                       <td className="p-3 text-xs text-gray-500">{itm.note || '-'}</td>
                                       </>
                                   )}
                                   <td className="p-3 text-center">{itm.qty}</td>
                                   <td className="p-3 text-right text-xs text-gray-500">{itm.unit}</td>
                                   <td className="p-3 text-center flex items-center justify-center gap-2"><button type="button" onClick={() => handleRemoveItem(idx)} className="text-red-400 hover:text-red-600 bg-red-50 p-1 rounded"><Trash2 className="w-3 h-3"/></button></td>
                               </tr>
                           ))}</tbody>
                        </table>
                        {orderItems.length === 0 && <div className="p-4 text-center text-gray-400 text-xs">ยังไม่มีรายการ</div>}
                      </div>
                  </div>
                  
                  {newOrderMeta.type === 'HO' && (
                      <div className="bg-amber-50 p-4 rounded-xl border border-amber-200 mt-2 space-y-3">
                        <div>
                            <label className="block text-sm font-bold text-amber-800 mb-1 flex items-center gap-2"><AttachmentIcon className="w-4 h-4" /> 1. ไฟล์อีเมลอนุมัติ (Approval Email)</label>
                            <input type="file" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => setUploadFiles({...uploadFiles, email: e.target.files[0]})} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-amber-100 file:text-amber-700 hover:file:bg-amber-200"/>
                             {editingId && newOrderMeta.attachment && <p className="text-xs text-green-600 mt-1">✔ มีไฟล์เดิม: {newOrderMeta.attachment.name}</p>}
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-amber-800 mb-1 flex items-center gap-2"><FileText className="w-4 h-4" /> 2. ใบเสนอราคา (Quotation)</label>
                            <input type="file" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => setUploadFiles({...uploadFiles, quotation: e.target.files[0]})} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-amber-100 file:text-amber-700 hover:file:bg-amber-200"/>
                            {editingId && newOrderMeta.quotation && <p className="text-xs text-green-600 mt-1">✔ มีไฟล์เดิม: {newOrderMeta.quotation.name}</p>}
                        </div>
                      </div>
                  )}
    
                  <div className="flex gap-3 pt-2"><button type="button" onClick={(e) => handleCreateOrder(e, true)} className="flex-1 bg-white border-2 border-gray-300 text-gray-700 font-bold py-4 rounded-xl shadow-sm hover:bg-gray-50 flex items-center justify-center gap-2"><Save className="w-5 h-5"/> บันทึกร่าง</button><button type="button" onClick={(e) => handleCreateOrder(e, false)} className="flex-1 bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-black flex items-center justify-center gap-2"><Send className="w-5 h-5"/> ส่งคำขอ</button></div>
                </form>
              </div>
            </div>
      )}
    
          {/* Other Modals (Selection, PR, PO, Receive, Verify etc) would go here. For brevity, including the Selection Modal structure */}
          {showSelectionModal && (
            <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[100] p-4 animate-in fade-in">
              <div className="bg-white rounded-2xl shadow-xl w-full max-w-2xl h-[80vh] flex flex-col overflow-hidden">
                 <div className="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
                     <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2"><List className="w-5 h-5 text-blue-600"/> เลือกรายการ (Select Item)</h3>
                     <button onClick={() => setShowSelectionModal(false)} className="text-gray-400 hover:text-gray-600"><X className="w-5 h-5"/></button>
                 </div>
                 <div className="p-4 border-b bg-white">
                     <div className="relative">
                         <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                         <input type="text" className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ค้นหาชื่อ, รหัส..." value={selectionSearch} onChange={e => setSelectionSearch(e.target.value)} autoFocus />
                     </div>
                 </div>
                 <div className="flex-1 overflow-y-auto p-4 bg-gray-50">
                     <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                         {getSelectionItems().map((item, idx) => (
                             <div key={idx} onClick={() => handleSelectFromModal(item)} className="bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:border-blue-400 hover:shadow-md cursor-pointer transition-all flex gap-3 items-center">
                                 <div className="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0 border"><Package className="w-8 h-8 text-gray-300"/></div>
                                 <div className="flex-1 min-w-0"><h4 className="font-bold text-gray-900 text-sm truncate">{item.name}</h4><p className="text-xs text-gray-500 truncate">{item.id || item.serial || '-'}</p>
                                 {newOrderMeta.type !== 'Borrow' && (<p className="text-xs text-blue-600 mt-1">คงเหลือ: {item.qty} {item.unit}</p>)}
                                 </div>
                             </div>
                         ))}
                     </div>
                 </div>
              </div>
            </div>
          )}
          
{/* NEW: Verification Modal - Improved Design */}
{showVerificationModal && (
  <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[80] p-4 backdrop-blur-sm animate-in fade-in">
    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in-95 duration-200">
       <div className="px-6 py-4 border-b border-gray-100 bg-indigo-50 flex justify-between items-center">
           <h3 className="font-bold text-lg text-indigo-900 flex items-center gap-2">
               <CheckSquare className="w-5 h-5 text-indigo-600"/> ตรวจสอบเอกสาร (Verification)
           </h3>
           <button onClick={() => setShowVerificationModal(false)} className="text-gray-400 hover:text-gray-600">
               <X className="w-5 h-5"/>
           </button>
       </div>
       
       <div className="p-6 space-y-4">
           {/* Checklist Section */}
           <div className="space-y-3">
               {/* Quotation Check */}
               <label className={`flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${
                   verificationData.checks.quotation 
                   ? 'border-green-500 bg-green-50' 
                   : 'border-gray-200 hover:border-indigo-200'
               }`}>
                   <input 
                       type="checkbox" 
                       className="w-5 h-5 accent-green-600" 
                       checked={verificationData.checks.quotation} 
                       onChange={() => handleChecklistChange('quotation')} 
                   />
                   <span className="text-sm font-medium flex-1">
                       ใบเสนอราคาถูกต้อง (Quotation)
                   </span>
                   {verificationData.filesExist.quotation && (
                       <>
                           <span className="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">มีไฟล์</span>
                           <button 
                               type="button"
                               onClick={(e) => {
                                   e.preventDefault();
                                   e.stopPropagation();
                                   const req = requests.find(r => r.id === verificationData.requestId);
                                   handleViewFile(req?.quotation, 'Quotation');
                               }}
                               className="text-xs bg-white border border-gray-300 px-2 py-1 rounded flex items-center gap-1 hover:bg-gray-50"
                           >
                               <Eye className="w-3 h-3"/> ดูไฟล์
                           </button>
                       </>
                   )}
               </label>

               {/* Email Check */}
               <label className={`flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${
                   verificationData.checks.email 
                   ? 'border-green-500 bg-green-50' 
                   : 'border-gray-200 hover:border-indigo-200'
               }`}>
                   <input 
                       type="checkbox" 
                       className="w-5 h-5 accent-green-600" 
                       checked={verificationData.checks.email} 
                       onChange={() => handleChecklistChange('email')} 
                   />
                   <span className="text-sm font-medium flex-1">
                       อีเมลอนุมัติครบถ้วน (Email)
                   </span>
                   {verificationData.filesExist.email && (
                       <>
                           <span className="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">มีไฟล์</span>
                           <button 
                               type="button"
                               onClick={(e) => {
                                   e.preventDefault();
                                   e.stopPropagation();
                                   const req = requests.find(r => r.id === verificationData.requestId);
                                   handleViewFile(req?.attachment, 'Email Approval');
                               }}
                               className="text-xs bg-white border border-gray-300 px-2 py-1 rounded flex items-center gap-1 hover:bg-gray-50"
                           >
                               <Eye className="w-3 h-3"/> ดูไฟล์
                           </button>
                       </>
                   )}
               </label>

               {/* Details Check */}
               <label className={`flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${
                   verificationData.checks.details 
                   ? 'border-green-500 bg-green-50' 
                   : 'border-gray-200 hover:border-indigo-200'
               }`}>
                   <input 
                       type="checkbox" 
                       className="w-5 h-5 accent-green-600" 
                       checked={verificationData.checks.details} 
                       onChange={() => handleChecklistChange('details')} 
                   />
                   <span className="text-sm font-medium flex-1">
                       รายละเอียดสินค้า/ราคา ถูกต้อง
                   </span>
               </label>
           </div>

           <hr className="border-gray-100"/>

           {/* Additional Options */}
           <div className="space-y-3">
               {/* Need Approval Checkbox */}
               <label className="flex items-start gap-3 cursor-pointer group">
                   <div className="pt-0.5">
                       <input 
                           type="checkbox" 
                           className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"
                           checked={verificationData.needApproval}
                           onChange={(e) => setVerificationData({...verificationData, needApproval: e.target.checked})}
                       />
                   </div>
                   <div>
                       <p className="text-sm font-bold text-gray-700 group-hover:text-indigo-700">
                           ต้องขออนุมัติจาก Head/PM เพิ่มเติม
                       </p>
                       <p className="text-xs text-gray-500">กรณีงบเกิน หรือสินค้าพิเศษที่ต้องพิจารณา</p>
                   </div>
               </label>

               {/* Contract Requirement (Only for Rent) */}
               {requests.find(r => r.id === verificationData.requestId)?.purchaseType === 'Rent' && (
                   <label className="flex items-start gap-3 cursor-pointer group">
                       <div className="pt-0.5">
                           <input 
                               type="checkbox" 
                               className="w-4 h-4 text-teal-600 rounded focus:ring-teal-500"
                               checked={verificationData.needContract}
                               onChange={(e) => setVerificationData({...verificationData, needContract: e.target.checked})}
                           />
                       </div>
                       <div>
                           <p className="text-sm font-bold text-gray-700 group-hover:text-teal-700">
                               ต้องทำสัญญาเช่า (Contract Required)
                           </p>
                           <p className="text-xs text-gray-500">ติ๊กออกหากเป็นการเช่าระยะสั้นที่ไม่ต้องทำสัญญา</p>
                       </div>
                   </label>
               )}
           </div>

           {/* Note Input */}
           <div>
               <label className="block text-xs font-bold text-gray-500 mb-1">หมายเหตุเพิ่มเติม (ถ้ามี)</label>
               <textarea 
                  className="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" 
                  rows="2"
                  placeholder="ระบุเหตุผล หรือรายละเอียดเพิ่มเติม..."
                  value={verificationData.note}
                  onChange={e => setVerificationData({...verificationData, note: e.target.value})}
               ></textarea>
           </div>

           {/* Action Buttons */}
           <div className="flex gap-3 pt-2">
               <button 
                   onClick={() => setShowVerificationModal(false)} 
                   className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600 font-medium hover:bg-gray-50"
               >
                   ยกเลิก
               </button>
               <button 
                   onClick={handleConfirmVerification} 
                   className={`flex-1 py-2 rounded-lg text-white font-bold shadow-md ${
                       isVerificationPass() 
                       ? (verificationData.needApproval 
                           ? 'bg-orange-500 hover:bg-orange-600' 
                           : 'bg-green-600 hover:bg-green-700'
                       ) 
                       : 'bg-red-500 hover:bg-red-600'
                   }`}
               >
                   {isVerificationPass() 
                       ? (verificationData.needApproval 
                           ? 'ส่งขออนุมัติเพิ่ม' 
                           : 'ยืนยันถูกต้อง (Approve)'
                       ) 
                       : 'ส่งกลับแก้ไข (Revise)'
                   }
               </button>
           </div>
       </div>
    </div>
  </div>
)}
          
          {showDetailModal && selectedRequest && (
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[70] p-4 backdrop-blur-sm">
             <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col overflow-hidden">
                 <div className="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
                     <div>
                         <div className="flex items-center gap-3">
                             <h3 className="font-bold text-xl text-gray-800">{selectedRequest.id}</h3>
                             <StatusBadge status={selectedRequest.status} />
                         </div>
                         <p className="text-sm text-gray-500 mt-1">วันที่: {selectedRequest.created} | ผู้ขอ: {selectedRequest.requester}</p>
                     </div>
                     <button onClick={() => setShowDetailModal(false)} className="text-gray-400 hover:text-gray-600 bg-white p-2 rounded-full shadow-sm border border-gray-200"><X className="w-5 h-5"/></button>
                 </div>
                 <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 space-y-6">
                            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                                <h4 className="font-bold text-gray-700 mb-4 flex items-center gap-2 border-b pb-2"><Info className="w-4 h-4"/> ข้อมูลทั่วไป</h4>
                                <div className="grid grid-cols-2 gap-y-4 text-sm">
                                    <div><span className="text-gray-500 block mb-1">ประเภท</span><span className="font-medium bg-gray-100 px-2 py-1 rounded">{selectedRequest.type} {selectedRequest.purchaseType ? `(${selectedRequest.purchaseType})` : ''}</span></div>
                                    <div><span className="text-gray-500 block mb-1">ความสำคัญ</span><span className={`font-bold ${selectedRequest.priority === 'Critical' ? 'text-red-600' : selectedRequest.priority === 'Urgent' ? 'text-orange-600' : 'text-blue-600'}`}>{PRIORITIES[selectedRequest.priority]?.label}</span></div>
                                    <div className="col-span-2"><span className="text-gray-500 block mb-1">โครงการ (Job)</span><span className="font-medium text-gray-900">{selectedRequest.job}</span></div>
                                    <div><span className="text-gray-500 block mb-1">วันที่ต้องการ</span><span className="font-medium">{selectedRequest.dateRequired}</span></div>
                                    <div><span className="text-gray-500 block mb-1">เลขที่เอกสาร</span><span className="font-mono bg-yellow-50 px-2 py-1 rounded border border-yellow-100 text-yellow-800">{selectedRequest.docNumber || '-'}</span></div>
                                </div>
                            </div>
                            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                                <h4 className="font-bold text-gray-700 mb-4 flex items-center gap-2 border-b pb-2"><ShoppingCart className="w-4 h-4"/> รายการสินค้า ({selectedRequest.items.length})</h4>
                                <div className="space-y-4">
                                    {selectedRequest.items.map((item, idx) => (
                                        <div key={idx} className="flex gap-4 p-3 bg-gray-50 rounded-lg border border-gray-100">
                                            <div className="w-12 h-12 bg-white rounded-lg border flex items-center justify-center shrink-0"><Package className="w-6 h-6 text-gray-300"/></div>
                                            <div className="flex-1">
                                                <div className="flex justify-between items-start">
                                                    <h5 className="font-bold text-gray-900">{item.name}</h5>
                                                    <span className="text-sm font-bold text-blue-600">x{item.qty} {item.unit}</span>
                                                </div>
                                                <div className="text-xs text-gray-500 mt-1 grid grid-cols-2 gap-2">
                                                    {item.subJob && <span>Sub: {item.subJob}</span>}
                                                    {item.epCode && <span>EP: {item.epCode}</span>}
                                                </div>
                                                {item.note && <p className="text-xs text-gray-500 mt-1 bg-white p-1 rounded border border-dashed">Note: {item.note}</p>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="space-y-6">
                            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                                <h4 className="font-bold text-gray-700 mb-4 flex items-center gap-2 border-b pb-2"><History className="w-4 h-4"/> ประวัติการดำเนินการ</h4>
                                <div className="relative border-l-2 border-gray-100 ml-2 space-y-6 pb-2">
                                    {selectedRequest.history.slice().reverse().map((log, idx) => (
                                        <div key={idx} className="ml-6 relative">
                                            <div className={`absolute -left-[31px] top-0 w-4 h-4 rounded-full border-2 border-white ${idx===0 ? 'bg-blue-500 ring-2 ring-blue-100' : 'bg-gray-300'}`}></div>
                                            <div className="flex justify-between items-start">
                                                <span className="text-xs font-bold text-gray-900">{log.action}</span>
                                                <span className="text-[10px] text-gray-400">{log.date}</span>
                                            </div>
                                            <p className="text-xs text-gray-500 mt-0.5">โดย: {log.user}</p>
                                            {log.note && <div className="mt-1.5 text-xs bg-gray-50 p-2 rounded text-gray-600 border border-gray-100">{log.note}</div>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
             </div>
        </div>
      )}

      {showReceiveGoodsModal && selectedRequest && (
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[80] p-4 backdrop-blur-sm">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col overflow-hidden">
            <div className="px-6 py-4 border-b flex justify-between items-center bg-teal-50">
                <div>
                    <h3 className="font-bold text-lg text-teal-800 flex items-center gap-2"><Truck className="w-5 h-5"/> รับของ / ตรวจรับงาน</h3>
                    <p className="text-xs text-teal-600">เอกสาร: {selectedRequest.docNumber || selectedRequest.id}</p>
                </div>
                <button onClick={() => setShowReceiveGoodsModal(false)} className="text-gray-400 hover:text-gray-600"><X className="w-5 h-5"/></button>
            </div>
            <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                <div className="space-y-4">
                    {receiveItems.map((item, idx) => (
                        <div key={idx} className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <div className="flex justify-between mb-4 pb-3 border-b">
                                <div>
                                    <h4 className="font-bold text-lg text-gray-800">{item.name}</h4>
                                    <div className="flex gap-4 text-sm text-gray-500 mt-1">
                                        <span>สั่งซื้อ: <b className="text-gray-900">{item.qty}</b></span>
                                        <span>รับแล้ว: <b className="text-green-600">{item.receivedSoFar}</b></span>
                                        <span>ค้างรับ: <b className="text-red-500">{Math.max(0, item.qty - item.receivedSoFar)}</b></span>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <label className="block text-xs font-bold text-gray-500 mb-1">จำนวนที่รับรอบนี้</label>
                                    <input type="number" min="0" max={Math.max(0, item.qty - item.receivedSoFar)} className="w-24 p-2 border-2 border-teal-100 rounded-lg text-center font-bold text-teal-700 focus:border-teal-500 outline-none" 
                                        value={item.receivedQty} 
                                        onChange={(e) => {
                                            const val = Math.min(Math.max(0, parseInt(e.target.value) || 0), item.qty - item.receivedSoFar);
                                            const newItems = [...receiveItems];
                                            newItems[idx].receivedQty = val;
                                            setReceiveItems(newItems);
                                        }}
                                    />
                                </div>
                            </div>
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-100 mb-3">
                                <p className="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">การจัดเก็บ (Destination)</p>
                                <div className="flex gap-4">
                                    <label className="flex items-center gap-2 cursor-pointer bg-white px-3 py-2 rounded border border-gray-200 hover:border-blue-300 transition-all">
                                        <input type="radio" name={`target-${idx}`} checked={item.targetType === 'Inventory'} onChange={() => { const n = [...receiveItems]; n[idx].targetType = 'Inventory'; setReceiveItems(n); }} className="accent-blue-600"/>
                                        <span className="text-sm font-medium"><Box className="w-4 h-4 inline mr-1 text-blue-500"/> เข้าคลัง (Stock)</span>
                                    </label>
                                    <label className="flex items-center gap-2 cursor-pointer bg-white px-3 py-2 rounded border border-gray-200 hover:border-indigo-300 transition-all">
                                        <input type="radio" name={`target-${idx}`} checked={item.targetType === 'Asset'} onChange={() => { const n = [...receiveItems]; n[idx].targetType = 'Asset'; setReceiveItems(n); }} className="accent-indigo-600"/>
                                        <span className="text-sm font-medium"><Monitor className="w-4 h-4 inline mr-1 text-indigo-500"/> ขึ้นทะเบียนทรัพย์สิน (Asset)</span>
                                    </label>
                                </div>
                            </div>
                            {item.targetType === 'Asset' && item.receivedQty > 0 && (
                                <div className="space-y-2 animate-in slide-in-from-top-2">
                                    <p className="text-xs font-bold text-indigo-600 flex items-center gap-1"><Tag className="w-3 h-3"/> ระบุ Serial Number / รหัสทรัพย์สิน ({item.receivedQty} รายการ)</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                        {Array.from({ length: item.receivedQty }).map((_, i) => (
                                            <input key={i} type="text" placeholder={`Serial No. ชิ้นที่ ${i+1}`} className="text-sm p-2 border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500 outline-none" 
                                                value={item.assetsToRegister[i]?.serial || ''} 
                                                onChange={(e) => {
                                                    const n = [...receiveItems];
                                                    if(!n[idx].assetsToRegister[i]) n[idx].assetsToRegister[i] = {};
                                                    n[idx].assetsToRegister[i].serial = e.target.value;
                                                    setReceiveItems(n);
                                                }}
                                            />
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
             </div>
             <div className="p-5 border-t bg-white shadow-lg">
             {receiveItems.some(i => i.receivedQty < (i.qty - i.receivedSoFar)) && (
                 <div className="mb-4 bg-orange-50 p-3 rounded-lg border border-orange-200">
                     <label className="flex items-center gap-2 cursor-pointer text-orange-800 text-sm font-bold">
                         <input type="checkbox" className="w-4 h-4 text-orange-600 rounded focus:ring-orange-500" checked={isForceClose} onChange={(e) => setIsForceClose(e.target.checked)}/>
                         ปิดงานเลยหรือไม่ (Force Close)
                     </label>
                     <p className="text-xs text-orange-600 mt-1 ml-6">กรณีของมาไม่ครบ แต่จะไม่รับส่วนที่เหลือแล้ว (สถานะจะเป็น Completed)</p>
                 </div>
             )}
             <div className="flex gap-3">
               <button onClick={() => setShowReceiveGoodsModal(false)} className="flex-1 py-3 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50">ยกเลิก</button>
               <button onClick={handleConfirmReceive} className="flex-1 py-3 bg-teal-600 text-white rounded-xl font-bold hover:bg-teal-700 shadow-md">ยืนยันรับของเข้าคลัง</button>
             </div>
         </div>
      </div>
    </div>
  )}

  {showAddInvModal && (
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
            <div className="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden">
                <div className="px-6 py-4 border-b bg-green-50 flex justify-between items-center">
                    <h3 className="font-bold text-lg text-green-800">เพิ่มสินค้าใหม่ (Inventory)</h3>
                    <button onClick={() => setShowAddInvModal(false)}><X className="w-5 h-5 text-gray-400 hover:text-gray-600"/></button>
                </div>
                <div className="p-6 space-y-4">
                    <div><label className="block text-sm font-bold text-gray-700 mb-1">ชื่อสินค้า</label><input type="text" className="w-full p-2 border rounded-lg" value={newStockItem.name} onChange={e => setNewStockItem({...newStockItem, name: e.target.value})} autoFocus/></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-bold text-gray-700 mb-1">จำนวนเริ่มต้น</label><input type="number" className="w-full p-2 border rounded-lg" value={newStockItem.qty} onChange={e => setNewStockItem({...newStockItem, qty: parseInt(e.target.value)||0})}/></div>
                        <div><label className="block text-sm font-bold text-gray-700 mb-1">หน่วยนับ</label><select className="w-full p-2 border rounded-lg bg-white" value={newStockItem.unit} onChange={e => setNewStockItem({...newStockItem, unit: e.target.value})}>{ITEM_UNITS.map(u => <option key={u} value={u}>{u}</option>)}</select></div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-bold text-gray-700 mb-1">Min Stock</label><input type="number" className="w-full p-2 border rounded-lg" value={newStockItem.minStock} onChange={e => setNewStockItem({...newStockItem, minStock: parseInt(e.target.value)||0})}/></div>
                        <div><label className="block text-sm font-bold text-gray-700 mb-1">ราคาต่อหน่วย</label><input type="number" className="w-full p-2 border rounded-lg" value={newStockItem.price} onChange={e => setNewStockItem({...newStockItem, price: parseFloat(e.target.value)||0})}/></div>
                    </div>
                    <button onClick={handleAddNewProduct} className="w-full py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 shadow-md mt-2">บันทึกสินค้า</button>
                </div>
            </div>
        </div>
      )}

      {showAssetModal && (
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
            <div className="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden">
                <div className="px-6 py-4 border-b bg-indigo-50 flex justify-between items-center">
                    <h3 className="font-bold text-lg text-indigo-800">เพิ่มทรัพย์สินใหม่ (Asset)</h3>
                    <button onClick={() => setShowAssetModal(false)}><X className="w-5 h-5 text-gray-400 hover:text-gray-600"/></button>
                </div>
                <div className="p-6 space-y-4">
                    <div><label className="block text-sm font-bold text-gray-700 mb-1">รหัสทรัพย์สิน (Asset ID)</label><input type="text" className="w-full p-2 border rounded-lg font-mono" placeholder="AST-XXXX" value={newAssetItem.id} onChange={e => setNewAssetItem({...newAssetItem, id: e.target.value})} autoFocus/></div>
                    <div><label className="block text-sm font-bold text-gray-700 mb-1">ชื่อรายการ</label><input type="text" className="w-full p-2 border rounded-lg" value={newAssetItem.name} onChange={e => setNewAssetItem({...newAssetItem, name: e.target.value})}/></div>
                    <div><label className="block text-sm font-bold text-gray-700 mb-1">Serial Number</label><input type="text" className="w-full p-2 border rounded-lg" value={newAssetItem.serial} onChange={e => setNewAssetItem({...newAssetItem, serial: e.target.value})}/></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-bold text-gray-700 mb-1">สภาพ (Condition)</label><select className="w-full p-2 border rounded-lg bg-white" value={newAssetItem.condition} onChange={e => setNewAssetItem({...newAssetItem, condition: e.target.value})}><option value="Good">Good (ดี)</option><option value="Fair">Fair (พอใช้)</option><option value="Damaged">Damaged (ชำรุด)</option></select></div>
                        <div><label className="block text-sm font-bold text-gray-700 mb-1">ราคาซื้อ/เช่า</label><input type="number" className="w-full p-2 border rounded-lg" value={newAssetItem.price} onChange={e => setNewAssetItem({...newAssetItem, price: parseFloat(e.target.value)||0})}/></div>
                    </div>
                    <button onClick={handleAddAsset} className="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 shadow-md mt-2">บันทึกทรัพย์สิน</button>
                </div>
            </div>
        </div>
      )}

      {showItemDetailModal && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[80] p-4 backdrop-blur-sm">
             <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden">
                <div className="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
                    <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">
                        {viewingItem ? <><Box className="w-5 h-5"/> ประวัติ: {viewingItem.name}</> : <><ClipboardList className="w-5 h-5"/> ประวัติการทำรายการรวม (All Logs)</>}
                    </h3>
                    <button onClick={() => setShowItemDetailModal(false)}><X className="w-5 h-5 text-gray-400 hover:text-gray-600"/></button>
                </div>
                <div className="flex-1 overflow-y-auto p-0">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-gray-100 text-gray-600 sticky top-0"><tr><th className="px-6 py-3">Timestamp</th><th className="px-6 py-3">Action</th><th className="px-6 py-3">Item</th><th className="px-6 py-3">Change</th><th className="px-6 py-3">User</th><th className="px-6 py-3">Note</th></tr></thead>
                        <tbody className="divide-y">{invLogs.filter(l => !viewingItem || l.item === viewingItem.name).slice().reverse().map((log, i) => (
                            <tr key={i} className="hover:bg-gray-50">
                                <td className="px-6 py-3 text-gray-500 text-xs">{log.date}</td>
                                <td className="px-6 py-3 font-bold">{log.action}</td>
                                <td className="px-6 py-3">{log.item}</td>
                                <td className={`px-6 py-3 font-mono font-bold ${log.change.includes('+') ? 'text-green-600' : log.change.includes('-') ? 'text-red-600' : 'text-blue-600'}`}>{log.change}</td>
                                <td className="px-6 py-3">{log.by}</td>
                                <td className="px-6 py-3 text-gray-500">{log.note}</td>
                            </tr>
                        ))}</tbody>
                    </table>
                    {invLogs.length === 0 && <div className="p-8 text-center text-gray-400">ยังไม่มีประวัติการทำรายการ</div>}
                </div>
             </div>
          </div>
      )}

      {showRejectModal && (
         <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
             <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                 <h3 className="font-bold text-lg text-red-600 mb-4 flex items-center gap-2"><AlertCircle className="w-5 h-5"/> ไม่อนุมัติรายการ</h3>
                 <textarea className="w-full p-3 border border-gray-300 rounded-lg text-sm mb-4 outline-none focus:ring-2 focus:ring-red-500" rows="3" placeholder="ระบุเหตุผลที่ไม่อนุมัติ..." value={rejectData.reason} onChange={e => setRejectData({...rejectData, reason: e.target.value})} autoFocus></textarea>
                 <div className="flex gap-3">
                     <button onClick={() => setShowRejectModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600">ยกเลิก</button>
                     <button onClick={handleConfirmReject} className="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700">ยืนยัน</button>
                 </div>
             </div>
         </div>
      )}

      {showDisburseModal && (
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
            <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 className="font-bold text-lg text-teal-700 mb-4 flex items-center gap-2"><Package className="w-5 h-5"/> ยืนยันการจ่ายของ/เบิก</h3>
                <p className="text-sm text-gray-600 mb-3">ตรวจสอบความถูกต้องและสภาพของก่อนส่งมอบ</p>
                <textarea className="w-full p-3 border border-gray-300 rounded-lg text-sm mb-4 outline-none focus:ring-2 focus:ring-teal-500" rows="2" placeholder="หมายเหตุการจ่าย (Optional)..." value={disburseData.note} onChange={e => setDisburseData({...disburseData, note: e.target.value})}></textarea>
                <div className="flex gap-3">
                    <button onClick={() => setShowDisburseModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600">ยกเลิก</button>
                    <button onClick={handleConfirmDisburse} className="flex-1 py-2 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700">ยืนยันจ่ายของ</button>
                </div>
            </div>
        </div>
      )}

      {showEditInvModal && editingStockItem && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
              <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                  <h3 className="font-bold text-lg text-blue-700 mb-4 flex items-center gap-2"><Edit className="w-5 h-5"/> แก้ไขสต็อกสินค้า</h3>
                  <div className="space-y-3">
                      <div><label className="text-xs font-bold text-gray-500">ชื่อสินค้า</label><input type="text" className="w-full p-2 border rounded bg-gray-50" value={editingStockItem.name} disabled/></div>
                      <div className="grid grid-cols-2 gap-3">
                        <div><label className="text-xs font-bold text-gray-500">คงเหลือ (Qty)</label><input type="number" className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={editingStockItem.qty} onChange={e => setEditingStockItem({...editingStockItem, qty: parseInt(e.target.value)||0})}/></div>
                        <div><label className="text-xs font-bold text-gray-500">Min Stock</label><input type="number" className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={editingStockItem.minStock} onChange={e => setEditingStockItem({...editingStockItem, minStock: parseInt(e.target.value)||0})}/></div>
                      </div>
                  </div>
                  <div className="flex gap-3 mt-6">
                      <button onClick={() => setShowEditInvModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600">ยกเลิก</button>
                      <button onClick={handleUpdateStock} className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">บันทึก</button>
                  </div>
              </div>
          </div>
      )}

      {showEditAssetModal && editingAssetItem && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
              <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                  <h3 className="font-bold text-lg text-blue-700 mb-4 flex items-center gap-2"><Edit className="w-5 h-5"/> แก้ไขข้อมูลทรัพย์สิน</h3>
                   <div className="space-y-3">
                      <div><label className="text-xs font-bold text-gray-500">รหัสทรัพย์สิน</label><input type="text" className="w-full p-2 border rounded bg-gray-50" value={editingAssetItem.id} disabled/></div>
                      <div><label className="text-xs font-bold text-gray-500">ชื่อรายการ</label><input type="text" className="w-full p-2 border rounded" value={editingAssetItem.name} onChange={e => setEditingAssetItem({...editingAssetItem, name: e.target.value})}/></div>
                      <div><label className="text-xs font-bold text-gray-500">สภาพ (Condition)</label><select className="w-full p-2 border rounded" value={editingAssetItem.condition} onChange={e => setEditingAssetItem({...editingAssetItem, condition: e.target.value})}><option value="Good">Good</option><option value="Fair">Fair</option><option value="Damaged">Damaged</option></select></div>
                   </div>
                  <div className="flex gap-3 mt-6">
                      <button onClick={() => setShowEditAssetModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600">ยกเลิก</button>
                      <button onClick={handleUpdateAsset} className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">บันทึก</button>
                  </div>
              </div>
          </div>
      )}

      {showPRModal && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
             <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                 <h3 className="font-bold text-lg text-blue-800 mb-4">ออกใบขอซื้อ (Issue PR)</h3>
                 <div className="space-y-3">
                     <div><label className="block text-sm font-bold text-gray-700 mb-1">เลขที่ PR (PR Number)</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="PR-XXXX" value={prData.prNumber} onChange={e => setPrData({...prData, prNumber: e.target.value})} autoFocus/></div>
                     <div><label className="block text-sm font-bold text-gray-700 mb-1">แนบไฟล์ PR (PDF/Image)</label><input type="file" className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onChange={e => setPrData({...prData, file: e.target.files[0]})}/></div>
                 </div>
                 <button onClick={handleSubmitPR} className="w-full py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 mt-4 shadow-md">บันทึก PR</button>
                 <button onClick={() => setShowPRModal(false)} className="w-full py-2 text-gray-500 text-sm mt-2 hover:underline">ยกเลิก</button>
             </div>
          </div>
      )}

      {showPOModal && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
             <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                 <h3 className="font-bold text-lg text-indigo-800 mb-4">ออกใบสั่งซื้อ (Issue PO)</h3>
                 <div className="space-y-3">
                     <div><label className="block text-sm font-bold text-gray-700 mb-1">เลขที่ PO (PO Number)</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="PO-XXXX" value={poData.poNumber} onChange={e => setPoData({...poData, poNumber: e.target.value})} autoFocus/></div>
                     <div><label className="block text-sm font-bold text-gray-700 mb-1">แนบไฟล์ PO (PDF/Image)</label><input type="file" className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" onChange={e => setPoData({...poData, file: e.target.files[0]})}/></div>
                 </div>
                 <button onClick={handleSubmitPO} className="w-full py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 mt-4 shadow-md">บันทึก PO</button>
                 <button onClick={() => setShowPOModal(false)} className="w-full py-2 text-gray-500 text-sm mt-2 hover:underline">ยกเลิก</button>
             </div>
          </div>
      )}

      {showReturnAssetModal && returnAssetData && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
              <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                  <h3 className="font-bold text-lg text-teal-800 mb-4 flex items-center gap-2"><RotateCcw className="w-5 h-5"/> รับคืนทรัพย์สิน</h3>
                  <div className="bg-gray-50 p-3 rounded mb-4 text-sm"><span className="text-gray-500 block">รหัสทรัพย์สิน:</span> <b>{returnAssetData.id}</b></div>
                  <div className="space-y-3">
                      <div><label className="block text-sm font-bold text-gray-700 mb-1">สภาพทรัพย์สิน (Condition)</label><select className="w-full p-2 border rounded-lg bg-white" value={returnAssetData.condition} onChange={e => setReturnAssetData({...returnAssetData, condition: e.target.value})}><option value="Good">Good (ปกติ/ดี)</option><option value="Damaged">Damaged (ชำรุด)</option><option value="Lost">Lost (สูญหาย)</option></select></div>
                      <div><label className="block text-sm font-bold text-gray-700 mb-1">หมายเหตุ</label><textarea className="w-full p-2 border rounded-lg text-sm" rows="2" value={returnAssetData.note} onChange={e => setReturnAssetData({...returnAssetData, note: e.target.value})}></textarea></div>
                  </div>
                  <div className="flex gap-3 mt-6">
                      <button onClick={() => setShowReturnAssetModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600">ยกเลิก</button>
                      <button onClick={confirmReturnAsset} className="flex-1 py-2 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700">ยืนยันรับคืน</button>
                  </div>
              </div>
          </div>
      )}

      {showPOPreviewModal && selectedRequest && (
        <div className="fixed inset-0 bg-white z-[200] overflow-auto">
            <div className="max-w-[210mm] mx-auto p-10 print-container">
                <div className="flex justify-between items-start mb-8 border-b pb-4 no-print">
                    <h2 className="text-xl font-bold">ตัวอย่างเอกสาร (Preview)</h2>
                    <div className="flex gap-2">
                        <button onClick={handlePrint} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"><Printer className="w-4 h-4"/> พิมพ์</button>
                        <button onClick={() => setShowPOPreviewModal(false)} className="px-4 py-2 border rounded hover:bg-gray-50">ปิด</button>
                    </div>
                </div>
                {/* Print Layout */}
                <div className="p-8 border border-gray-200 shadow-sm print:border-0 print:shadow-none bg-white min-h-[297mm]">
                    <div className="flex justify-between items-start mb-8">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-800">ใบสั่งซื้อ (PURCHASE ORDER)</h1>
                            <p className="text-sm text-gray-500">บริษัท ตัวอย่าง จำกัด (สำนักงานใหญ่)</p>
                            <p className="text-xs text-gray-400">123 ถ.สุขุมวิท แขวงคลองเตย เขตคลองเตย กทม. 10110</p>
                        </div>
                        <div className="text-right">
                            <div className="mb-2"><span className="text-gray-500 text-xs block">เลขที่เอกสาร</span><span className="font-bold text-lg">{selectedRequest.docNumber || 'DRAFT'}</span></div>
                            <div><span className="text-gray-500 text-xs block">วันที่</span><span className="font-medium">{new Date().toLocaleDateString('th-TH')}</span></div>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-8 mb-8 text-sm">
                        <div className="p-4 bg-gray-50 rounded border border-gray-100">
                            <h3 className="font-bold border-b border-gray-200 pb-2 mb-2 text-gray-700">ผู้ขาย (Vendor)</h3>
                            <p className="text-gray-400 italic">-- ระบุชื่อร้านค้า --</p>
                            <p>..................................................................</p>
                        </div>
                        <div className="p-4 bg-gray-50 rounded border border-gray-100">
                             <h3 className="font-bold border-b border-gray-200 pb-2 mb-2 text-gray-700">รายละเอียดการจัดส่ง</h3>
                             <p><span className="font-bold text-gray-500">โครงการ:</span> {selectedRequest.job}</p>
                             <p><span className="font-bold text-gray-500">ผู้ขอซื้อ:</span> {selectedRequest.requester}</p>
                             <p><span className="font-bold text-gray-500">วันที่ต้องการ:</span> {selectedRequest.dateRequired}</p>
                        </div>
                    </div>
                    <table className="w-full text-sm mb-8">
                        <thead><tr className="bg-gray-100 text-gray-700 border-y border-gray-300"><th className="py-2 px-3 text-left w-10">#</th><th className="py-2 px-3 text-left">รายการ (Description)</th><th className="py-2 px-3 text-center w-20">จำนวน</th><th className="py-2 px-3 text-right w-24">หน่วยละ</th><th className="py-2 px-3 text-right w-24">รวมเงิน</th></tr></thead>
                        <tbody className="divide-y">
                            {selectedRequest.items.map((item, i) => (
                                <tr key={i}>
                                    <td className="py-3 px-3 text-center">{i+1}</td>
                                    <td className="py-3 px-3">
                                        <p className="font-bold">{item.name}</p>
                                        <p className="text-xs text-gray-500">{item.subJob ? `Job: ${item.subJob}` : ''} {item.epCode ? `EP: ${item.epCode}` : ''}</p>
                                    </td>
                                    <td className="py-3 px-3 text-center">{item.qty} {item.unit}</td>
                                    <td className="py-3 px-3 text-right">{item.unitPrice?.toLocaleString()}</td>
                                    <td className="py-3 px-3 text-right">{(item.qty * item.unitPrice)?.toLocaleString()}</td>
                                </tr>
                            ))}
                        </tbody>
                        <tfoot>
                            <tr className="border-t-2 border-gray-300">
                                <td colSpan="4" className="py-3 px-3 text-right font-bold">รวมเป็นเงิน (Total)</td>
                                <td className="py-3 px-3 text-right font-bold text-lg">{selectedRequest.items.reduce((sum, i) => sum + (i.qty * i.unitPrice), 0).toLocaleString()}</td>
                            </tr>
                        </tfoot>
                    </table>
                    <div className="grid grid-cols-3 gap-4 mt-16 text-center text-sm">
                        <div><p className="border-b border-black mb-2 pb-8"> </p><p>ผู้จัดทำ</p></div>
                        <div><p className="border-b border-black mb-2 pb-8"> </p><p>ผู้อนุมัติ (PM)</p></div>
                        <div><p className="border-b border-black mb-2 pb-8"> </p><p>ผู้มีอำนาจลงนาม</p></div>
                    </div>
                </div>
            </div>
        </div>
      )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
