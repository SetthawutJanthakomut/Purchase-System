<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>PurchaseHub System</title>
  
  <script src="https://cdn.tailwindcss.com"></script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    .animate-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }




  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // =================================================================
    // --- ICON SYSTEM (EXPLICIT SAFE MODE) ---
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Component ‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Library ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error 100%
    // =================================================================
    
// ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ
    const USED_ICONS = [
      'LayoutDashboard', 'Plus', 'Package', 'CheckCircle', 'Clock', 
      'FileText', 'Search', 'User', 'LogOut', 'ChevronRight', 
      'ShoppingCart', 'Truck', 'AlertCircle', 'Paperclip',
      'HardHat', 'Briefcase', 'Building', 'ShieldCheck', 'BadgeCheck',
      'UploadCloud', 'FileCheck', 'Sparkles', 'X', 'MessageSquare', 'History', 
      'Store', 'Mail', 'Trash2', 'FileInput',
      'Save', 'Edit', 'RotateCcw', 'Send', 'AlertTriangle', 'Bell', 'Pencil', 'Box', 'Filter', 'RefreshCw', 'ArrowRight', 'List', 'ClipboardList', 'ArrowLeftRight', 
      'Monitor', 'Smartphone', 'Tag', 'Wrench', 'ArrowUpDown', 'Download', 
      'Image', // Alias: ImageIcon
      'Eye', 'XCircle', 'Camera', 
      'Info', 
      'Printer', 'CornerUpLeft', 'CheckSquare', 'XSquare', 'ExternalLink', 'PlayCircle', 'ArrowUpRight', 'PenTool', 'FileSignature', 'Calendar', 'CalendarClock', 'CreditCard', 'Flame', 'MousePointerClick',
      'Upload',
      'Settings',
      'Lock',
      'Menu', // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô Menu ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      'Eye', 'EyeOff',
      'BellOff', 'Megaphone'// ‚≠ê‚≠ê‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö (‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏° comma ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á Settings ‡∏î‡πâ‡∏ß‡∏¢)
    ];
    const lucideReact = {};
    // --- PERMISSION CONSTANTS ---
    const PERMISSIONS = {
        1:  '‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Read Only)',
        2:  'Admin (‡πÑ‡∏î‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)',
        3:  'Sub-Admin (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠/‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏° ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)',
        4:  '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠: ‡∏ã‡∏∑‡πâ‡∏≠ Local',
        5:  '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠: ‡∏ã‡∏∑‡πâ‡∏≠ HO',
        6:  '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠: ‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏',
        7:  '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠: ‡∏¢‡∏∑‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô',
        8:  '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: (Level 1)',
        9:  '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: (Level 2)',
        10: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Verify)',
        11: '‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠ (Issue PR)',
        12: '‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Issue PO)',
        13: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (Shipping)',
        14: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (Contract)',
        15: '‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á (Receive Goods)',
        16: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Add Inv)',
        17: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Edit Inv)',
        18: '‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Delete Inv)',
        19: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Add Asset)',
        20: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Edit Asset)',
        21: '‡∏•‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Delete Asset)',
        22: 'Import CSV (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)',
        23: 'Import CSV (‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô)',
        24: '‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á/‡∏¢‡∏∑‡∏° (Disburse)',
        25: '‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Return Asset)',
        26: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project Settings)',
        27: '‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Restore)',
        28: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (Manage Announcement)',
        // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡∏°‡πà
        29: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏£‡∏´‡∏±‡∏™ (Cost Control)' 
    };

    // Helper: ‡πÅ‡∏õ‡∏•‡∏á PascalCase -> kebab-case
    const pascalToKebab = (str) => str.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g, '$1-$2').toLowerCase().replace(/^-/, '');

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Component ‡∏õ‡∏•‡∏≠‡∏°‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
    USED_ICONS.forEach(name => {
        lucideReact[name] = (props) => {
            // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Library ‡∏°‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            if (!window.lucide || !window.lucide.icons) {
                return React.createElement('div', { 
                    style: { width: props.size || 24, height: props.size || 24, background: '#eee', borderRadius: 4, display: 'inline-block' },
                    className: props.className
                });
            }

            const cleanName = pascalToKebab(name);
            const iconData = window.lucide.icons[cleanName];

            // 2. ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏¥‡∏î) ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Fallback
            if (!iconData) {
                return null;
            }

            // 3. ‡∏ß‡∏≤‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á
            const tag = iconData[0];
            const attrs = iconData[1];
            const children = iconData[2];

            return React.createElement(tag, {
                ...attrs,
                width: props.size || 24,
                height: props.size || 24,
                stroke: props.color || "currentColor",
                strokeWidth: props.strokeWidth || (attrs ? attrs["stroke-width"] : 2),
                className: `lucide lucide-${cleanName} ${props.className || ""}`,
                ...props
            }, children.map((child, idx) => 
                React.createElement(child[0], { ...child[1], key: idx })
            ));
        };
    });

    // =================================================================
    // --- APP LOGIC ---
    // =================================================================

    // ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Icon (‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô)
const {
      LayoutDashboard, Plus, Package, CheckCircle, Clock, 
      FileText, Search, User, LogOut, ChevronRight, 
      ShoppingCart, Truck, AlertCircle, Paperclip,
      HardHat, Briefcase, Building, ShieldCheck, BadgeCheck,
      UploadCloud, FileCheck, Sparkles, X, MessageSquare, History, Store, Mail, Trash2, FileInput,
      Save, Edit, RotateCcw, Send, AlertTriangle, Bell, Pencil, Box, Filter, RefreshCw, ArrowRight, List, ClipboardList, ArrowLeftRight, Monitor, Smartphone, Tag, Wrench, ArrowUpDown, Download, 
      Image: ImageIcon, 
      Eye, XCircle, Camera, 
      Paperclip: AttachmentIcon, 
      Info, 
      Briefcase: BriefcaseIcon, 
      Printer, CornerUpLeft, CheckSquare, XSquare, ExternalLink, PlayCircle, ArrowUpRight, PenTool, FileSignature, Calendar, CalendarClock, CreditCard, Flame, MousePointerClick,
      Upload,
      Settings,Lock,EyeOff, 
      BellOff, Megaphone,
      Menu // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
    } = lucideReact;

    // Manual Aliasing for missing/renamed icons
    // (‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô Array ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ)
    if (!BriefcaseIcon) lucideReact.BriefcaseIcon = lucideReact.Briefcase;
    if (!AttachmentIcon) lucideReact.AttachmentIcon = lucideReact.Paperclip;

    const createIcon = (name) => (props) => {
        const Icon = lucideReact[name];
        return Icon ? React.createElement(Icon, props) : null;
    };

    // --- Configuration & Constants ---
const ROLES = {
      ADMIN: 'Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)',
      USER: 'User (‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠)',
      DEPT_HEAD: '‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 1 (Head)', // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠
      PM: '‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 2 (PM)',         // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠
      PURCHASING: '‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠ (HO & Local Buyer)',
      STORE: 'Store Keeper (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏Ñ‡∏•‡∏±‡∏á)'
    };

    const RENTAL_UNITS = {
        'Day': '‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô',
        'Month': '‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
        'Year': '‡∏ö‡∏≤‡∏ó/‡∏õ‡∏µ'
    };

    const ITEM_UNITS = [
        'EA', // (Each) ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
        '‡∏ä‡∏¥‡πâ‡∏ô', '‡∏≠‡∏±‡∏ô', '‡∏ä‡∏∏‡∏î', '‡πÅ‡∏û‡πá‡∏Ñ' , '‡∏Å‡∏•‡πà‡∏≠‡∏á' ,
        '‡πÄ‡∏™‡πâ‡∏ô', '‡πÄ‡∏°‡∏ï‡∏£', '‡∏°‡πâ‡∏ß‡∏ô', 
        'kg', '‡∏ï‡∏±‡∏ô', '‡∏•‡∏¥‡∏ï‡∏£', '‡πÅ‡∏Å‡∏•‡∏•‡∏≠‡∏ô', '‡∏ñ‡∏∏‡∏á', '‡∏õ‡∏µ‡πä‡∏ö', '‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á', '‡∏Ç‡∏ß‡∏î', '‡∏´‡∏•‡∏≠‡∏î', // ‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß/‡∏ß‡∏±‡∏™‡∏î‡∏∏
        '‡πÉ‡∏ö', '‡∏ï‡∏±‡∏ß', '‡∏Ñ‡∏π‡πà', '‡∏Ç‡πâ‡∏≤‡∏á', // ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏ã‡∏ü‡∏ï‡∏µ‡πâ
        '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', '‡∏Ñ‡∏±‡∏ô', // ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£/‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞
        '‡πÄ‡∏•‡πà‡∏°', '‡πÅ‡∏ú‡πà‡∏ô', '‡∏î‡πâ‡∏≤‡∏°', '‡∏ï‡∏•‡∏±‡∏ö' // ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô/‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        // ‚ùå ‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å: ‡∏Å‡∏•‡πà‡∏≠‡∏á, ‡πÅ‡∏û‡πá‡∏Ñ, ‡∏•‡∏±‡∏á, ‡πÇ‡∏´‡∏•, ‡∏£‡∏µ‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏¢‡πà‡∏≠‡∏¢‡πÄ‡∏™‡∏°‡∏≠)
    ];

    const ASSET_STATUS_LABELS = {
    'Available': '‡∏ß‡πà‡∏≤‡∏á',
    'Borrowed': '‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°',
    'Lost': '‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢',
    'Damaged': '‡∏ä‡∏≥‡∏£‡∏∏‡∏î'
};


    const PRIORITIES = {
        'Normal': { label: '‡∏õ‡∏Å‡∏ï‡∏¥', color: 'bg-blue-100 text-blue-700 border-blue-200' },
        'Urgent': { label: '‡∏î‡πà‡∏ß‡∏ô', color: 'bg-orange-100 text-orange-700 border-orange-200' },
        'Critical': { label: '‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å', color: 'bg-red-100 text-red-700 border-red-200' }
    };

const STATUS_LABELS = {
      'Draft': '‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á (Draft)',
      'Pending Check': '‡∏£‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Check)',
      'Revise Needed': '‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Revise)',
      'Pending Head': '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 1',      // ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠
      'Pending PM': '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 2',        // ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠
      'Approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)',
      'Ordered': '‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á)',
      'PR Issued': '‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠ (PR) ‡πÅ‡∏•‡πâ‡∏ß',
      'PO Issued': '‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (PO) ‡πÅ‡∏•‡πâ‡∏ß',
      'Contract Pending': '‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ä‡πà‡∏≤',
      'Contract Signed': '‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß',
      'Shipping': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á/‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö',
      'Partially Received': '‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô (Partial)',
      'Ready to Disburse': '‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á (‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏°)',
      'Completed': '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß/‡∏à‡∏ö‡∏á‡∏≤‡∏ô',
      'Returned': '‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (Returned)',
      'Rejected': '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Rejected)',
      'Cancelled': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (Cancelled)'
    };

    const STATUS_STEPS_LOCAL = ['Pending Head', 'Pending PM', 'Pending Check', 'Approved', 'Ordered', 'Completed'];
    const STATUS_STEPS_HO_SHORT = ['Pending Check', 'Approved', 'PR Issued', 'PO Issued', 'Shipping', 'Completed'];
    const STATUS_STEPS_HO_FULL = ['Pending Check', 'Pending Head', 'Pending PM', 'Approved', 'PR Issued', 'PO Issued', 'Shipping', 'Completed'];
    const STATUS_STEPS_HO_RENT_SHORT = ['Pending Check', 'Approved', 'Contract Pending', 'Contract Signed', 'Shipping', 'Completed'];
    const STATUS_STEPS_HO_RENT_FULL = ['Pending Check', 'Pending Head', 'Pending PM', 'Approved', 'Contract Pending', 'Contract Signed', 'Shipping', 'Completed'];
    const STATUS_STEPS_HO_RENT_SKIP = ['Pending Check', 'Approved', 'Shipping', 'Completed']; 
    const STATUS_STEPS_HO_RENT_SKIP_FULL = ['Pending Check', 'Pending Head', 'Pending PM', 'Approved', 'Shipping', 'Completed'];
    const STATUS_STEPS_WITHDRAW = ['Pending Head', 'Approved', 'Ready to Disburse', 'Completed'];
    const STATUS_STEPS_BORROW = ['Pending Head', 'Approved', 'Ready to Disburse', 'Completed', 'Returned'];

    // --- Helper Functions ---
    const createLog = (action, user, note = '', images = []) => ({ 
      date: new Date().toLocaleString('th-TH'), 
      action, 
      user, 
      note,
      images: images || [] 
    });



const StatusBadge = ({ status, type, onClick }) => { // ‚≠ê ‡∏£‡∏±‡∏ö onClick ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
      let color = 'bg-gray-100 text-gray-800';
      let label = STATUS_LABELS[status] || status;

      if (status === 'Pending Head' && (type === 'Withdraw' || type === 'Borrow')) {
          label = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 1 / Level 2';
      }

      if (status === 'Draft') color = 'bg-gray-200 text-gray-600 border border-gray-300';
      else if (status === 'Revise Needed') color = 'bg-red-50 text-red-600 border border-red-200 animate-pulse';
      else if (status.includes('Pending') || status === 'PR Issued') color = 'bg-amber-100 text-amber-800 border border-amber-200';
      else if (status === 'Contract Pending') color = 'bg-amber-100 text-amber-800 border border-amber-200';
      else if (status === 'Approved') color = 'bg-cyan-100 text-cyan-800 border border-cyan-200';
      else if (status === 'Ready to Disburse') color = 'bg-purple-100 text-purple-800 border border-purple-200';
      else if (['Ordered', 'PO Issued', 'Shipping', 'Contract Signed', 'Partially Received'].includes(status)) color = 'bg-blue-100 text-blue-800 border border-blue-200';
      else if (status === 'Completed') color = 'bg-green-100 text-green-800 border border-green-200';
      else if (status === 'Returned') color = 'bg-teal-100 text-teal-800 border border-teal-200';
      else if (status === 'Rejected') color = 'bg-red-100 text-red-800 border border-red-200';
      else if (status === 'Cancelled') color = 'bg-slate-200 text-slate-600 border border-slate-300';
      
      // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° cursor-pointer ‡πÅ‡∏•‡∏∞ onClick
      return (
        <span 
            onClick={onClick}
            className={`px-2 py-1 rounded-full text-xs font-bold border flex items-center gap-1 w-fit transition-transform active:scale-95 ${color} ${onClick ? 'cursor-pointer hover:shadow-sm hover:brightness-95' : ''}`}
            title={onClick ? "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö" : ""}
        >
            {label} 
            {/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Å‡∏î‡∏î‡∏π‡πÑ‡∏î‡πâ */}
            {onClick && <Info size={10} className="opacity-50"/>}
        </span>
      );
};

    const DocIdBadge = ({ type, id }) => {
        if (!id) return null;
        let color = 'bg-gray-100 text-gray-600 border-gray-200';
        let icon = createIcon('FileText')({className: "w-3 h-3"});
        if (id.startsWith('HRO')) {
            color = 'bg-teal-50 text-teal-700 border-teal-200';
            icon = createIcon('PenTool')({className: "w-3 h-3"});
        }
        else if (type === 'Local') { color = 'bg-orange-50 text-orange-700 border-orange-200'; icon = createIcon('HardHat')({className: "w-3 h-3"}); }
        else if (type === 'HO') { color = 'bg-indigo-50 text-indigo-700 border-indigo-200'; icon = createIcon('Building')({className: "w-3 h-3"}); }
        else if (type === 'Withdraw') { color = 'bg-pink-50 text-pink-700 border-pink-200'; icon = createIcon('Package')({className: "w-3 h-3"}); }
        else if (type === 'Borrow') { color = 'bg-blue-50 text-blue-700 border-blue-200'; icon = createIcon('Monitor')({className: "w-3 h-3"}); }

        return (
            <span className={`text-xs px-2 py-0.5 rounded border flex items-center gap-1 font-bold ${color}`}>
                {icon} {id}
            </span>
        );
    };

    const ProgressBar = ({ request }) => {
      let steps = STATUS_STEPS_LOCAL;
      if (request.type === 'HO') {
          if (request.purchaseType === 'Rent') {
              if (request.needContract === false) {
                  steps = request.isFullApprovalFlow ? STATUS_STEPS_HO_RENT_SKIP_FULL : STATUS_STEPS_HO_RENT_SKIP;
              } else {
                  steps = request.isFullApprovalFlow ? STATUS_STEPS_HO_RENT_FULL : STATUS_STEPS_HO_RENT_SHORT;
              }
          } else {
              steps = request.isFullApprovalFlow ? STATUS_STEPS_HO_FULL : STATUS_STEPS_HO_SHORT;
          }
      }
      if (request.type === 'Withdraw') steps = STATUS_STEPS_WITHDRAW;
      if (request.type === 'Borrow') steps = STATUS_STEPS_BORROW;
      
      let statusToFind = request.status;
      if (statusToFind === 'Partially Received') {
          if (request.type === 'Local') statusToFind = 'Ordered';
          else if (request.type === 'HO') statusToFind = 'Shipping';
      }

      const currentIndex = steps.indexOf(statusToFind);
      const AlertCircleIcon = createIcon('AlertCircle');
      
      return (
        <div className="w-full mt-3 mb-4">
           {request.status === 'Revise Needed' && (
               <div className="mb-2 text-xs text-red-500 font-bold flex items-center gap-1 animate-bounce">
                   <AlertCircleIcon className="w-3 h-3"/> ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)
               </div>
           )}
          <div className="flex justify-between mb-2">
              {steps.map((step, idx) => (
                 <div key={step} className={`text-[10px] flex flex-col items-center ${idx <= currentIndex ? 'text-blue-600 font-bold' : 'text-gray-300'}`}>
                      <div className={`w-2 h-2 rounded-full mb-1 ${idx <= currentIndex ? 'bg-blue-600' : 'bg-gray-200'}`}></div>
                      <span className="hidden sm:inline">{STATUS_LABELS[step]?.split(' ')[0] || step}</span>
                  </div>
              ))}
          </div>
          <div className="h-1.5 bg-gray-100 rounded-full overflow-hidden flex">
              {steps.map((step, idx) => (
                  <div key={step} className={`h-full border-r border-white last:border-0 transition-all duration-500 ${idx <= currentIndex ? 'bg-blue-500' : 'bg-transparent'}`} style={{ width: `${100 / steps.length}%` }} />
              ))}
          </div>
        </div>
      );
    };

    // --- MAIN APP COMPONENT ---
    const App = () => {
      const [user, setUser] = useState(null);
      const [isSidebarOpen, setIsSidebarOpen] = useState(true);

      const [allUsers, setAllUsers] = useState([]); // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ User ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      const [showPermissionModal, setShowPermissionModal] = useState(false); // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
      const [selectedUserForEdit, setSelectedUserForEdit] = useState(null); // User ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
      const [permissionTab, setPermissionTab] = useState(''); // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠ Project ‡πÉ‡∏ô Modal ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
      const [currentUserRole, setCurrentUserRole] = useState(ROLES.USER);
      const [activeTab, setActiveTab] = useState('dashboard');
      
      // Use Empty Array initially, will fetch from Sheet
      const [requests, setRequests] = useState([]);
      const [inventory, setInventory] = useState([]);
      const [assets, setAssets] = useState([]);
      const [invLogs, setInvLogs] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [uploadFiles, setUploadFiles] = useState({ email: null, quotation: null });
      // --- STATE: Image Preview Modal ---
      const [fullscreenImage, setFullscreenImage] = useState(null); // ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏´‡∏£‡∏∑‡∏≠ Base64 ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏π
      const [viewingAttachments, setViewingAttachments] = useState(null); // ‡πÄ‡∏Å‡πá‡∏ö Object { attachments: [] }
      const [showImportAssetModal, setShowImportAssetModal] = useState(false);
      const [importData, setImportData] = useState([]);
      const [importFileName, setImportFileName] = useState('');
      const [isImportAssetTableExpanded, setIsImportAssetTableExpanded] = useState(false);
      const [isImportInvTableExpanded, setIsImportInvTableExpanded] = useState(false); // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ
// --- STATE: Projects Management ---
      const [projects, setProjects] = useState([]); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô Array ‡∏ß‡πà‡∏≤‡∏á (‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î)
      const [disburseItems, setDisburseItems] = useState([]);

      const [isError, setIsError] = useState(false); // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Error
const [errorMessage, setErrorMessage] = useState(''); // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error

const [showAuditModal, setShowAuditModal] = useState(false);
const [auditItems, setAuditItems] = useState([]); // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏±‡∏ö

const [showSuperRollbackModal, setShowSuperRollbackModal] = useState(false);
const [rollbackTarget, setRollbackTarget] = useState('');
const [rollbackReason, setRollbackReason] = useState('');
  

// ... (inside App component)

// --- LOGIC: EXPORT ITEM HISTORY CSV ---
const handleExportItemHistory = () => {
    if (!viewingItem || !viewingItem.id) return;

    setIsLoading(true);
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Backend ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    google.script.run.withSuccessHandler((allLogs) => {
        setIsLoading(false);
        
        if (!allLogs || allLogs.length === 0) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'error');
            return;
        }

        let csvContent = "\uFEFF"; // BOM for Thai support
        const isAsset = viewingItem.serial !== undefined;
        let rows = [];
        let filename = "";

        if (!isAsset) {
            // üü¢ ‡∏Å‡∏£‡∏ì‡∏µ 1: Inventory (‡∏ß‡∏±‡∏™‡∏î‡∏∏)
            const targetActions = ['Stock In', 'Stock In (Merge)', 'Stock In (New)', 'Withdraw', 'Adjust Stock', 'Audit Adjust', 'Return', 'Import Merge', 'Import New', 'Delete Inventory'];
            
            // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Header: ‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å (Requester)" ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
            csvContent += "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥,‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏,‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á (Change),‡∏´‡∏ô‡πà‡∏ß‡∏¢,‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô),‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Supplier),‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å (Requester),‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏,‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n";
            
            // Filter Data
            const filteredLogs = allLogs.filter(log => {
                return targetActions.some(act => log.action.includes(act)) || (log.change && (log.change.includes('+') || log.change.includes('-') || log.change.includes('Start:')));
            });

            rows = filteredLogs.map(log => {
                const cleanName = (viewingItem.name || '').replace(/,/g, ' ');
                const cleanNote = (log.note || '').replace(/[\r\n]+/g, ' ').replace(/,/g, ' ');
                const type = viewingItem.stockType === 'NonSystem' ? '‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö' : '‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
                const supplier = log.supplier || '-';
                
                // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ Start: ‡∏≠‡∏≠‡∏Å
                let changeQty = log.change || '-';
                if (changeQty.toString().includes('Start:')) {
                    changeQty = changeQty.replace('Start:', '').trim();
                }

                // ‚≠ê‚≠ê Logic ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡∏≤‡∏Å Order ‚≠ê‚≠ê
                let requesterName = '-';
                if (log.relatedRequestId) {
                    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô state requests ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                    const relatedReq = requests.find(r => r.id === log.relatedRequestId || r.docNumber === log.relatedRequestId);
                    if (relatedReq) {
                        requesterName = relatedReq.requester;
                    }
                }

                return [
                    `"${log.date}"`,
                    `"${log.action}"`,
                    `"${getDisplayId(viewingItem.id)}"`,
                    `"${cleanName}"`,
                    `"${type}"`,
                    `"${changeQty}"`, 
                    `"${viewingItem.unit}"`,
                    `"${viewingItem.price || 0}"`,
                    `"${supplier}"`, 
                    `"${requesterName}"`, // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                    `"${cleanNote}"`,
                    `"${log.by}"`
                ].join(",");
            });
            
            filename = `History_Inventory_${getDisplayId(viewingItem.id)}.csv`;

 } else {
            // üîµ ‡∏Å‡∏£‡∏ì‡∏µ 2: Asset (‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô)
            // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î targetActions ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡πÄ‡∏≠‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            
            // Header (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°: ‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á)
            csvContent += "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥ (Action),‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô,‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡∏ô‡∏±‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,‡∏£‡∏≤‡∏Ñ‡∏≤,‡∏´‡∏ô‡πà‡∏ß‡∏¢,‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤,‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏Ç‡∏ì‡∏∞‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£),‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á (Holder),‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Supplier),‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏,‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n";

            // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡πÉ‡∏ä‡πâ allLogs ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á filter
            const filteredLogs = allLogs;

            rows = filteredLogs.map(log => {
                const cleanName = (viewingItem.name || '').replace(/,/g, ' ');
                const cleanNote = (log.note || '').replace(/[\r\n]+/g, ' ').replace(/,/g, ' ');
                const type = viewingItem.ownerType === 'Rent' ? '‡πÄ‡∏ä‡πà‡∏≤' : '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó';
                
                // ‡∏î‡∏∂‡∏á Supplier
                const supplier = log.supplier || '-';
                
                // ‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á (Logic ‡πÄ‡∏î‡∏¥‡∏°)
                let holder = viewingItem.holder; 
                if (log.action === 'Borrow' && log.note.includes('‡∏¢‡∏∑‡∏°‡πÇ‡∏î‡∏¢')) {
                    holder = log.note.split('‡∏¢‡∏∑‡∏°‡πÇ‡∏î‡∏¢')[1]?.trim() || '-';
                } else if (log.action === 'Return') {
                    holder = '-'; 
                }

                const price = viewingItem.ownerType === 'Rent' ? viewingItem.rentalPrice : viewingItem.price;
                const unit = viewingItem.ownerType === 'Rent' ? viewingItem.rentalUnit : '‡∏ö‡∏≤‡∏ó';

                return [
                    `"${log.date}"`,
                    `"${log.action}"`,
                    `"${viewingItem.id}"`,
                    `"${cleanName}"`,
                    `"${viewingItem.serial || '-'}"`,
                    `"${type}"`,
                    `"${price || 0}"`,
                    `"${unit}"`,
                    `"${viewingItem.rentalStart || '-'}"`,
                    `"${viewingItem.rentalEnd || '-'}"`,
                    `"${log.change || viewingItem.status}"`,
                    `"${holder}"`,
                    `"${supplier}"`,
                    `"${cleanNote}"`,
                    `"${log.by}"`
                ].join(",");
            });

            filename = `History_Asset_${viewingItem.id}.csv`;
        }

        if (rows.length === 0) {
            showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç', 'info');
            return;
        }

        // Generate Download
        csvContent += rows.join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

    }).getAllLogsForItem(viewingItem.id);
};
// --- STATE: Go to Top Button ---
const [showGoTop, setShowGoTop] = useState(false);

// --- STATE: Go to Bottom Button ---
const [showGoBottom, setShowGoBottom] = useState(true);

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î
const scrollToBottom = () => {
    const contentArea = document.querySelector('.flex-1.overflow-auto');
    if (contentArea) {
        contentArea.scrollTo({ 
            top: contentArea.scrollHeight, 
            behavior: 'smooth' 
        });
    }
};

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ scroll ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô useEffect ‡πÄ‡∏î‡∏¥‡∏°)
useEffect(() => {
    const handleScroll = () => {
        const contentArea = document.querySelector('.flex-1.overflow-auto');
        if (contentArea) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Top ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏°‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 300px
            setShowGoTop(contentArea.scrollTop > 300);
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Bottom ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î (‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô 50px)
            const isAtBottom = contentArea.scrollHeight - contentArea.scrollTop <= contentArea.clientHeight + 50;
            setShowGoBottom(!isAtBottom);
        }
    };

    const contentArea = document.querySelector('.flex-1.overflow-auto');
    if (contentArea) {
        
        contentArea.addEventListener('scroll', handleScroll);
        return () => contentArea.removeEventListener('scroll', handleScroll);
    }
}, [activeTab]); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤

const scrollToTop = () => {
    const contentArea = document.querySelector('.flex-1.overflow-auto');
    if (contentArea) {
        contentArea.scrollTo({ top: 0, behavior: 'smooth' });
    }
};

// --- [NEW] Component ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏ô Modal ---
    const ModalScrollButtons = ({ targetId }) => (
        <div className="absolute bottom-6 right-6 flex flex-col gap-2 z-[60] no-print">
            <button 
                onClick={() => document.getElementById(targetId)?.scrollTo({ top: 0, behavior: 'smooth' })}
                className="bg-white/80 backdrop-blur text-gray-500 hover:text-blue-600 p-2.5 rounded-full shadow-lg border border-gray-200 hover:bg-blue-50 transition-all transform hover:scale-110"
                title="‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>
            </button>
            <button 
                onClick={() => {
                    const el = document.getElementById(targetId);
                    el?.scrollTo({ top: el.scrollHeight, behavior: 'smooth' });
                }}
                className="bg-white/80 backdrop-blur text-gray-500 hover:text-blue-600 p-2.5 rounded-full shadow-lg border border-gray-200 hover:bg-blue-50 transition-all transform hover:scale-110"
                title="‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>
            </button>
        </div>
    );

      
      const [showProjectModal, setShowProjectModal] = useState(false); // Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡πÄ‡∏û‡∏¥‡πà‡∏°
      const [showProjectDetailModal, setShowProjectDetailModal] = useState(false); // ‚≠ê Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
      
      const [editingProject, setEditingProject] = useState(null); 
      const [viewingProject, setViewingProject] = useState(null); // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö Project ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
      const [projectFormTab, setProjectFormTab] = useState('General');
      const [inventoryProjectFilter, setInventoryProjectFilter] = useState('All');
      const [assetProjectFilter, setAssetProjectFilter] = useState('All');
      const [projectDetailTab, setProjectDetailTab] = useState('SubJob'); // 'SubJob' ‡∏´‡∏£‡∏∑‡∏≠ 'matCode'
      const [globalProjectFilter, setGlobalProjectFilter] = useState('All');
      // --- STATE: User Detail Modal ---
const [viewingUser, setViewingUser] = useState(null); // ‡πÄ‡∏Å‡πá‡∏ö User ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π
const [userDetailTab, setUserDetailTab] = useState('info'); // info, purchase, withdraw, borrow
const [detailSearch, setDetailSearch] = useState(''); // ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Detail
const [userSearch, setUserSearch] = useState(''); // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ User
const [expandedBudgetGroups, setExpandedBudgetGroups] = useState({});

const [announcements, setAnnouncements] = useState([]); 
    const [publicAnnounces, setPublicAnnounces] = useState([]); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
    const [showPublicAnnounce, setShowPublicAnnounce] = useState(false);
    const [announcement, setAnnouncement] = useState(null);
    const [announceForm, setAnnounceForm] = useState({ id: '', title: '', detail: '', active: true }); 
    const [isAnnounceLoading, setIsAnnounceLoading] = useState(false);

// --- STATE: Export Budget CSV ---
const [showExportModal, setShowExportModal] = useState(false);
const [exportTargetProject, setExportTargetProject] = useState('All');

    // --- STATE: Checklist & Audit ---
const [showChecklistModal, setShowChecklistModal] = useState(false);
const [checklistMode, setChecklistMode] = useState('Inventory'); // 'Inventory' or 'Asset'
const [checklistFilters, setChecklistFilters] = useState({
    projects: [],
    types: [], // Inv: System/NonSystem | Asset: Company/Rent
    statuses: [], // Asset only
    selectedItems: [] // Store IDs
});
const [checklistUploadFile, setChecklistUploadFile] = useState(null);

// Helper: Toggle Checkbox in Filters
const toggleChecklistFilter = (field, value) => {
    setChecklistFilters(prev => {
        const current = prev[field];
        const newSet = current.includes(value) 
            ? current.filter(x => x !== value)
            : [...current, value];
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Filter ‡∏´‡∏•‡∏±‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Items ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏ä‡∏∏‡∏î
        if (field !== 'selectedItems') {
             return { ...prev, [field]: newSet, selectedItems: [] };
        }
        return { ...prev, [field]: newSet };
    });
};

// Helper: Select All Items based on current filters
const handleSelectAllChecklistItems = (filteredItems) => {
    const allIds = filteredItems.map(i => i.id);
    setChecklistFilters(prev => ({ 
        ...prev, 
        selectedItems: prev.selectedItems.length === allIds.length ? [] : allIds 
    }));
};

// --- Helper: ‡∏ï‡∏±‡∏î‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢) ---
    const COMPOSITE_SEP = '|';
    const getDisplayId = (id) => {
        if (!id) return '';
        const str = id.toString();
        return str.includes(COMPOSITE_SEP) ? str.split(COMPOSITE_SEP)[0] : str;
    };



// --- LOGIC: EXPORT BUDGET CSV (UPDATED: Add Lot Details Column) ---
const handleExportBudgetCSV = () => {
    // 1. ‡∏Å‡∏£‡∏≠‡∏á Request ‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Completed (‡πÉ‡∏ä‡πâ‡∏á‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß) ‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const completedReqs = requests.filter(r => {
        const isBudgetUsed = r.status === 'Completed' && ['Local', 'HO'].includes(r.type);
        const isProjectMatch = exportTargetProject === 'All' || r.job === exportTargetProject;
        return isBudgetUsed && isProjectMatch;
    });

    if (completedReqs.length === 0) {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç', 'error');
        return;
    }

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Header CSV (‡πÄ‡∏û‡∏¥‡πà‡∏° BOM \uFEFF ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
    let csvContent = "\uFEFF"; 
    // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Lot Detail)
    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 116 ‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏ú‡∏π‡πâ‡∏Ç‡∏≠," ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
csvContent += "‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£,Doc No.,‡∏ú‡∏π‡πâ‡∏Ç‡∏≠,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤,SubJob,Mat. Code,‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î),‡∏à‡∏≥‡∏ô‡∏ß‡∏ô,‡∏´‡∏ô‡πà‡∏ß‡∏¢/‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤,‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô (Actual Cost),‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Lot Detail)\n";

    // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    completedReqs.forEach(req => {
        const projObj = projects.find(p => p.name === req.job);
        const projectId = projObj ? projObj.id : req.job;
        const docNo = req.docNumber || req.id;

        req.items.forEach(item => {
            const isRent = req.type === 'HO' && req.purchaseType === 'Rent';
            
            // --- LOGIC ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏£‡∏¥‡∏á (Actual Cost Logic) ---
            // --- LOGIC ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏£‡∏¥‡∏á (Actual Cost Logic) ---
// ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏Ñ‡∏≤ (Price) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏° Logic ‡πÉ‡∏´‡∏°‡πà
const relatedAssets = assets.filter(a => 
    a.currentRequestId === req.id && 
    a.name === item.name &&
    (a.price === item.unitPrice || a.rentalPrice === item.unitPrice)
);
            const receivedLogs = item.receivedLog || [];
            
            let itemTotalVal = 0;
            let receivedCount = 0;
            let displayPrice = 0; 
            let lotDetailList = []; // ‚≠ê ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Lot

            // A. ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô Asset
            if (relatedAssets.length > 0) {
                itemTotalVal += relatedAssets.reduce((sum, asset) => {
                    const p = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                    const d = isRent ? (asset.duration || item.duration || 1) : 1;
                    return sum + (p * d);
                }, 0);
                receivedCount = relatedAssets.length;
                displayPrice = relatedAssets[0].price; 
                
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Asset ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß
                relatedAssets.forEach((a, i) => {
                    const p = isRent ? a.rentalPrice : a.price;
                    lotDetailList.push(`Asset#${i+1}: ${p.toLocaleString()}`);
                });
            } 
            // B. ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô Material (‡∏î‡∏π‡∏à‡∏≤‡∏Å Log ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á)
            else if (receivedLogs.length > 0) {
                itemTotalVal += receivedLogs.reduce((sum, log) => {
                    const p = log.price;
                    const d = isRent ? (log.duration || 1) : 1;
                    
                    // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞ Lot: "Lot 1: 20 @ 160"
                    lotDetailList.push(`Lot ${lotDetailList.length + 1}: ${log.qty} @ ${p.toLocaleString()}`);
                    
                    return sum + (log.qty * p * d);
                }, 0);
                receivedCount = item.receivedTotal || 0;
                displayPrice = receivedLogs[receivedLogs.length - 1].price;
           }

            // C. ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Estimate)
            // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏°‡πà‡∏ô‡∏≥‡∏°‡∏≤‡∏ö‡∏ß‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (itemTotalVal) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ Actual Cost ‡∏à‡∏£‡∏¥‡∏á‡πÜ
            const remainingQty = Math.max(0, item.qty - receivedCount);
            if (remainingQty > 0) {
                const p = item.unitPrice || 0;
                
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏ß‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏â‡∏¢‡πÜ (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏¢)
                if(displayPrice === 0) displayPrice = p;
                
                // ‚ùå ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á: itemTotalVal += (remainingQty * p * d);
                
                // (Optional) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
                lotDetailList.push(`Not Received/Cancel: ${remainingQty}`);
            }

            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° CSV
            const cleanName = (item.name || '').replace(/,/g, ' ');
            const cleanSub = (item.subJob || '').replace(/,/g, ' ');
            const cleanMat = (item.matCode || '').replace(/,/g, ' ');
            
            // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Lot ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ " | "
            const lotDetailStr = lotDetailList.join(" | ");

            let durationLabel = item.unit;
            if (isRent) {
                const duration = item.duration || 1;
                const rentUnit = item.rentalUnit || 'Month';
                durationLabel = `${rentUnit} (${duration})`;
            }

            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á row ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 138
const row = [
    `"${projectId}"`,   
    `"${docNo}"`,
    `"${req.requester}"`, // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    `"${cleanName}"`,   
    `"${cleanSub}"`,    
    `"${cleanMat}"`,
    displayPrice.toFixed(2), 
    item.qty,           
    `"${durationLabel}"`, 
    itemTotalVal.toFixed(2),
    `"${lotDetailStr}"`
];

            csvContent += row.join(",") + "\n";
        });
    });

    // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    
    const dateStr = new Date().toISOString().split('T')[0];
    const projName = exportTargetProject === 'All' ? 'All_Projects' : exportTargetProject;
    link.setAttribute("download", `Budget_Used_${projName}_${dateStr}.csv`);
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setShowExportModal(false);
    showToast('Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Lot) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
};


// Logic: Filter Items for Checklist Modal
const getChecklistFilteredItems = () => {
    if (checklistMode === 'Inventory') {
        return inventory.filter(i => {
            // Filter Project
            if (checklistFilters.projects.length > 0 && !checklistFilters.projects.includes(i.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á')) return false;
            // Filter Type
            const type = i.stockType || 'System';
            if (checklistFilters.types.length > 0 && !checklistFilters.types.includes(type)) return false;
            return true;
        });
    } else {
        return assets.filter(a => {
            // Filter Project
            if (checklistFilters.projects.length > 0 && !checklistFilters.projects.includes(a.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á')) return false;
            // Filter Type (Owner)
            if (checklistFilters.types.length > 0 && !checklistFilters.types.includes(a.ownerType)) return false;
            // Filter Status
            if (checklistFilters.statuses.length > 0 && !checklistFilters.statuses.includes(a.status)) return false;
            return true;
        });
    }
};

// Logic: Upload Signed Checklist
const handleUploadChecklist = async () => {
    if (!checklistUploadFile) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î', 'error');
        return;
    }
    
    setIsLoading(true);
    try {
        const base64 = await fileToBase64(checklistUploadFile);
        const result = await new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .uploadFileToDrive(base64, checklistUploadFile.name);
        });

        if (result.error) throw new Error(result.error);

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log
        const logAction = checklistMode === 'Inventory' ? 'Audit Inventory' : 'Audit Assets';
        const note = `‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Checklist (${checklistMode}) \n‡πÑ‡∏ü‡∏•‡πå: ${result.name}`;
        const logImages = []; // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡πÄ‡∏õ‡πá‡∏ô Link ‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        
        // ‡πÉ‡∏ä‡πâ addInvLog ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏ß‡∏°
        await addInvLog(
            logAction, 
            'Checklist Document', 
            'Upload', 
            note, 
            [{ name: result.name, url: result.url, type: 'application/pdf' }]
        );

        showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        setChecklistUploadFile(null);
        setShowChecklistModal(false);
    } catch (err) {
        console.error(err);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
    } finally {
        setIsLoading(false);
    }
};


const handlePrintChecklist = () => {
    // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠ Title ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
    const originalTitle = document.title;
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó_‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£_‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤
    const dateStr = new Date().toLocaleString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit', hour:'2-digit', minute:'2-digit' }).replace(/[\/:]/g, '-').replace(', ', '_');
    const typeName = checklistMode === 'Inventory' ? 'Inventory_Audit' : 'Asset_Audit';
    const projectStr = checklistFilters.projects.length > 0 ? checklistFilters.projects.join('_') : 'All_Projects';
    
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Title (Browser ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå PDF)
    document.title = `${typeName}_${projectStr}_${dateStr}`;
    
    // ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
    window.print();
    
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Title ‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Browser ‡∏à‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏ô)
    setTimeout(() => {
        document.title = originalTitle;
    }, 1000);
};

// Logic: Open Modal
const openChecklistModal = (mode) => {
    setChecklistMode(mode);
    setChecklistFilters({
        projects: [],
        types: [],
        statuses: [],
        selectedItems: []
    });
    setChecklistUploadFile(null);
    setShowChecklistModal(true);
};

// --- UI Component: Searchable Dropdown (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ) ---
    const SearchableDropdown = ({ label, options, value, onChange, disabled, placeholder }) => {
        const [isOpen, setIsOpen] = useState(false);
        const [search, setSearch] = useState("");
        const wrapperRef = useRef(null);

        // Sync ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (value)
        useEffect(() => {
            const selected = options?.find(o => o.code === value);
            if (selected) {
                setSearch(`${selected.code} : ${selected.description}`);
            } else if (!value) {
                setSearch("");
            }
        }, [value, options]);

        // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î Dropdown
        useEffect(() => {
            const handleClickOutside = (event) => {
                if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                    setIsOpen(false);
                    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏î‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ Reset ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    const selected = options?.find(o => o.code === value);
                    if (selected) setSearch(`${selected.code} : ${selected.description}`);
                    else if (!value) setSearch("");
                }
            };
            document.addEventListener("mousedown", handleClickOutside);
            return () => document.removeEventListener("mousedown", handleClickOutside);
        }, [wrapperRef, value, options]);

        const filteredOptions = (options || []).filter(opt => 
            opt.code.toLowerCase().includes(search.toLowerCase()) || 
            opt.description.toLowerCase().includes(search.toLowerCase())
        );

        return (
            <div className="relative" ref={wrapperRef}>
                <label className="text-xs font-bold text-gray-500 mb-1 block">{label}</label>
                <div className="relative">
                    <input
                        type="text"
                        className={`w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none ${disabled ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white'}`}
                        placeholder={placeholder}
                        value={search}
                        onChange={(e) => {
                            setSearch(e.target.value);
                            setIsOpen(true);
                            if (e.target.value === "") onChange(""); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏î
                        }}
                        onFocus={() => !disabled && setIsOpen(true)}
                        disabled={disabled}
                    />
                    {/* Icon ‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏•‡∏á */}
                    <div className="absolute right-3 top-3 pointer-events-none text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                    </div>
                </div>

                {isOpen && !disabled && (
                    <div className="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 overflow-y-auto animate-in fade-in zoom-in-95">
                        {filteredOptions.length > 0 ? (
                            filteredOptions.map((opt) => (
                                <div
                                    key={opt.code}
                                    className="px-3 py-2 text-sm hover:bg-indigo-50 cursor-pointer text-gray-700 border-b border-gray-50 last:border-0"
                                    onClick={() => {
                                        onChange(opt.code);
                                        setIsOpen(false);
                                    }}
                                >
                                    <span className="font-bold text-indigo-600">{opt.code}</span> : {opt.description}
                                </div>
                            ))
                        ) : (
                            <div className="px-3 py-3 text-sm text-gray-400 text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                        )}
                    </div>
                )}
            </div>
        );
    };

   // --- STATE: Signature (‡∏ä‡∏∏‡∏î‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå) ---
    const [sigMode, setSigMode] = useState('Draw'); // 'Draw' ‡∏´‡∏£‡∏∑‡∏≠ 'Upload'
    const sigCanvasRef = useRef(null);
    const [isDrawing, setIsDrawing] = useState(false);
    const [hasDrawn, setHasDrawn] = useState(false); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const [signatureFile, setSignatureFile] = useState(null); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î Upload
    const [tempSignatureUrl, setTempSignatureUrl] = useState(null); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Preview

    // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î
    const startDrawing = (e) => {
        const canvas = sigCanvasRef.current;
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        
        const rect = canvas.getBoundingClientRect();
        // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡πâ‡∏ß‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™
        const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
        const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
        
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(x, y);
        setIsDrawing(true);
    };

    // 2. ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏î (‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏°‡∏≤‡∏™‡πå/‡∏ô‡∏¥‡πâ‡∏ß)
    const draw = (e) => {
        if (!isDrawing) return;
        e.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏à‡∏≠‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•‡∏ï‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
        
        const canvas = sigCanvasRef.current;
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        
        const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
        const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);

        const x = clientX - rect.left;
        const y = clientY - rect.top;
        
        ctx.lineTo(x, y);
        ctx.stroke();
        
        if (!hasDrawn) setHasDrawn(true); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    };

    // 3. ‡∏´‡∏¢‡∏∏‡∏î‡∏ß‡∏≤‡∏î (‡∏¢‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå/‡∏ô‡∏¥‡πâ‡∏ß‡∏≠‡∏≠‡∏Å)
    const stopDrawing = () => {
        setIsDrawing(false);
        const canvas = sigCanvasRef.current;
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.closePath();
        }
    };

    // 4. ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
    const clearSignature = () => {
        const canvas = sigCanvasRef.current;
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        setTempSignatureUrl(null);
        setHasDrawn(false); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    };




const hasPermission = (permId, project = globalProjectFilter) => {
          // 1. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Super Admin ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏•‡∏≠‡∏î
          if (user?.isSuperAdmin) return true;
          
          // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Project (All) ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏£‡∏∞‡∏î‡∏±‡∏ö Global
          if (!project || project === 'All') {
              // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô "‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÉ‡∏î‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏´‡∏ô‡∏∂‡πà‡∏á" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (User.permissions ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô { "ProjectA": [1,2], "ProjectB": [] })
              if (!user?.permissions) return false;
              return Object.values(user.permissions).some(perms => 
                  perms.includes(2) || perms.includes(permId) // ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå 2 ‡∏Ñ‡∏∑‡∏≠ Admin ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ô‡∏±‡πâ‡∏ô
              );
          }

          // 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô Project ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
          const userPerms = user?.permissions?.[project] || [];
          
          // - ‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ô‡∏µ‡πâ (2)
          if (userPerms.includes(2)) return true;

          // - ‡πÄ‡∏õ‡πá‡∏ô Sub-Admin (3) -> ‡πÑ‡∏î‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (4,5,6,7)
          if (userPerms.includes(3) && [4, 5, 6, 7].includes(permId)) return true;

          // - ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á
          return userPerms.includes(permId);
      };


// --- AUTH SCREEN (Full Features: Login, Register, Forgot Password, Forgot Username) ---
    const AuthScreen = ({ onLoginSuccess, requests = [] }) => {
        // view state: 'login' | 'register' | 'forgot' | 'forgotUser'
        const [view, setView] = useState('login'); 
        const [loading, setLoading] = useState(false);
        

        
        // State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OTP (Register/Forgot Password)
        const [otpSent, setOtpSent] = useState(false);
        const [refCode, setRefCode] = useState('');
        const [countdown, setCountdown] = useState(0);
        
        // State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UI
        
        const [showPassword, setShowPassword] = useState(false);

        const [formData, setFormData] = useState({
            username: '', password: '', confirmPassword: '', email: '', empId: '', firstName: '', lastName: '', otp: '', newPassword: ''
        });

     

        // --- Countdown Timer ---
        useEffect(() => {
            let timer;
            if (countdown > 0) timer = setTimeout(() => setCountdown(countdown - 1), 1000);
            return () => clearTimeout(timer);
        }, [countdown]);

        // Stats Logic
        const stats = useMemo(() => {
            const active = requests.filter(r => r.status !== 'Draft');
            return {
                pending: active.filter(r => r.status.includes('Pending') || r.status === 'PR Issued' || r.status === 'Approved' || r.status === 'Revise Needed' || r.status === 'Contract Pending').length,
                processing: active.filter(r => ['Ordered', 'PO Issued', 'Shipping', 'Contract Signed', 'Partially Received'].includes(r.status)).length,
                ready: active.filter(r => r.status === 'Ready to Disburse').length,
                completed: active.filter(r => r.status === 'Completed' || r.status === 'Returned').length
            };
        }, [requests]);

        const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
        const validatePassword = (pwd) => pwd.length >= 6 && /[a-zA-Z]/.test(pwd) && /[0-9]/.test(pwd);

        // --- Actions ---

        const handleLogin = (e) => {
            e.preventDefault();
            setLoading(true);
            google.script.run.withSuccessHandler((res) => {
                setLoading(false);
                if (res.success) {
                    
                    onLoginSuccess(res.user);
                } else { alert(res.message); }
            }).loginUser(formData.username, formData.password);
        };

const handleRegisterRequestOTP = () => {
            if(!formData.username || !formData.password || !formData.email || !formData.empId) { // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ empId ‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)'); 
                return; 
            }
            if (!validatePassword(formData.password)) { alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 6 ‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ (‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£+‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)'); return; }
            if (formData.password !== formData.confirmPassword) { alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô'); return; }

            setLoading(true);
            google.script.run.withSuccessHandler((res) => {
                setLoading(false);
                if (res.success) {
                    alert(`${res.message}\nRef: ${res.refCode}`);
                    setOtpSent(true); setRefCode(res.refCode); setCountdown(15);
                } else { alert(res.message); }
 
            }).sendRegistrationOTP(formData.email, formData.username, formData.empId); // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° formData.empId ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
        };

        const handleRegisterConfirm = (e) => {
            e.preventDefault();
            setLoading(true);
            google.script.run.withSuccessHandler((res) => {
                setLoading(false);
                if (res.success) {
                    alert('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    setView('login'); setOtpSent(false); setFormData({...formData, password:'', confirmPassword:'', otp:''});
                } else { alert(res.message); }
            }).registerUser(formData, formData.otp);
        };

        const handleForgotRequestOTP = () => {
            if(!formData.email) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏µ‡πÄ‡∏°‡∏•'); return; }
            setLoading(true);
            google.script.run.withSuccessHandler((res) => {
                setLoading(false);
                if (res.success) {
                    alert(`${res.message}\nRef: ${res.refCode}`);
                    setOtpSent(true); setRefCode(res.refCode); setCountdown(15);
                } else { alert(res.message); }
            }).sendForgotPasswordOTP(formData.email);
        };

        const handleResetPassword = (e) => {
            e.preventDefault();
            if(!formData.otp || !formData.newPassword) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
            if (!validatePassword(formData.newPassword)) { alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 6 ‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ (‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£+‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)'); return; }
            if (formData.newPassword !== formData.confirmPassword) { alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô'); return; }

            setLoading(true);
            google.script.run.withSuccessHandler((res) => {
                setLoading(false);
                if (res.success) {
                    alert(res.message);
                    setView('login'); setOtpSent(false); setFormData({...formData, email:'', otp:'', newPassword:'', confirmPassword:''});
                } else { alert(res.message); }
            }).resetPassword(formData.email, formData.otp, formData.newPassword);
        };

        // ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        const handleRecoverUsername = (e) => {
            e.preventDefault();
            if(!formData.email) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏µ‡πÄ‡∏°‡∏•'); return; }
            setLoading(true);
            google.script.run.withSuccessHandler((res) => {
                setLoading(false);
                alert(res.message);
                if (res.success) {
                    setView('login');
                    setFormData({...formData, email:''});
                }
            }).sendUsernameToEmail(formData.email);
        };

        return (
            <div className="min-h-screen flex bg-white font-sans overflow-hidden">
                {/* LEFT SIDE (Dashboard) */}
                <div className="hidden lg:flex w-7/12 bg-slate-50 relative flex-col justify-between p-10 overflow-hidden">
                    <div className="absolute top-0 right-0 w-96 h-96 bg-blue-100 rounded-full blur-3xl opacity-50 -mr-20 -mt-20"></div>
                    <div className="absolute bottom-0 left-0 w-full h-64 bg-gradient-to-t from-white to-transparent z-10"></div>
                    <div className="absolute bottom-0 left-0 w-full h-1/2 bg-[url('https://img.freepik.com/free-vector/city-skyline-concept-illustration_114360-8923.jpg?w=1380')] bg-contain bg-bottom bg-no-repeat opacity-20 pointer-events-none mix-blend-multiply"></div>

                    <div className="relative z-20">
                        <h1 className="text-4xl font-extrabold text-slate-800 mb-2">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h1>
                        <p className="text-slate-500 text-lg">"‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ"</p>
                    </div>

                    <div className="grid grid-cols-2 xl:grid-cols-4 gap-4 relative z-20 mt-8">
                        <div className="bg-amber-50 border border-amber-100 p-4 rounded-2xl shadow-sm hover:shadow-md transition-all group">
                            <div className="flex justify-between items-start mb-2"><div className="p-2 bg-white rounded-lg shadow-sm text-amber-600 group-hover:scale-110 transition-transform"><Clock size={24} strokeWidth={2}/></div></div>
                            <div className="text-3xl font-extrabold text-slate-800 mb-1">{stats.pending}</div>
                            <p className="text-[10px] font-bold text-amber-700 bg-amber-100 px-2 py-1 rounded w-fit">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                        </div>
                        <div className="bg-blue-50 border border-blue-100 p-4 rounded-2xl shadow-sm hover:shadow-md transition-all group">
                            <div className="flex justify-between items-start mb-2"><div className="p-2 bg-white rounded-lg shadow-sm text-blue-600 group-hover:scale-110 transition-transform"><Truck size={24} strokeWidth={2}/></div></div>
                            <div className="text-3xl font-extrabold text-slate-800 mb-1">{stats.processing}</div>
                            <p className="text-[10px] font-bold text-blue-700 bg-blue-100 px-2 py-1 rounded w-fit">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                        </div>
                        <div className="bg-purple-50 border border-purple-100 p-4 rounded-2xl shadow-sm hover:shadow-md transition-all group">
                            <div className="flex justify-between items-start mb-2"><div className="p-2 bg-white rounded-lg shadow-sm text-purple-600 group-hover:scale-110 transition-transform"><Package size={24} strokeWidth={2}/></div></div>
                            <div className="text-3xl font-extrabold text-slate-800 mb-1">{stats.ready}</div>
                            <p className="text-[10px] font-bold text-purple-700 bg-purple-100 px-2 py-1 rounded w-fit">‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á/‡πÄ‡∏ö‡∏¥‡∏Å</p>
                        </div>
                        <div className="bg-green-50 border border-green-100 p-4 rounded-2xl shadow-sm hover:shadow-md transition-all group">
                            <div className="flex justify-between items-start mb-2"><div className="p-2 bg-white rounded-lg shadow-sm text-green-600 group-hover:scale-110 transition-transform"><CheckCircle size={24} strokeWidth={2}/></div></div>
                            <div className="text-3xl font-extrabold text-slate-800 mb-1">{stats.completed}</div>
                            <p className="text-[10px] font-bold text-green-700 bg-green-100 px-2 py-1 rounded w-fit">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô/‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</p>
                        </div>
                    </div>

                    <div className="relative z-20 mt-6 bg-white/90 backdrop-blur-sm p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4 max-w-2xl">
                        <div className="p-3 bg-indigo-100 text-indigo-700 rounded-xl"><Sparkles size={24}/></div>
                        <div>
                            <h3 className="font-bold text-slate-800 text-base">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà PurchaseHub!</h3>
                            <p className="text-xs text-slate-500 mt-0.5">‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏° ‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Real-time</p>
                            <div className="flex gap-2 mt-2">
                                <span className="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded border">**** Papers</span>
                                <span className="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded border">System Online</span>
                            </div>
                        </div>
                    </div>
                    <div className="flex-1"></div>
                </div>

                {/* RIGHT SIDE (Forms) */}
                <div className="w-full lg:w-5/12 flex flex-col justify-center items-center p-8 bg-white relative shadow-2xl z-30 overflow-y-auto">
                    <div className="w-full max-w-md my-auto">
                        <div className="mb-8 flex flex-col items-center text-center">
                            <img src="https://www.appsheet.com/template/gettablefileurl?appName=ImageURL-701958446&tableName=URL&fileName=URL_Images%2F01-17-2026%2010-30-07.Photo.033012.png" 
                                alt="Logo" className="h-32 lg:h-48 w-auto object-contain mb-4 drop-shadow-sm hover:scale-105 transition-transform duration-500" 
                                onError={(e)=>{e.target.onerror=null;e.target.style.display='none'}}/>
                            <h2 className="text-2xl font-bold text-slate-800">PurchaseHub System</h2>
                            <p className="text-slate-500 text-sm mt-1">
                                {view === 'login' && '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                                {view === 'register' && '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà'}
                                {view === 'forgot' && '‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Reset Password)'}
                                {view === 'forgotUser' && '‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Forgot Username)'}
                            </p>
                        </div>

                        {/* --- LOGIN FORM --- */}
                        {view === 'login' && (
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div><label className="text-xs font-bold text-slate-500 flex items-center gap-1"><User size={12}/> ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label><input name="username" required className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={formData.username} onChange={handleChange} /></div>
                                
                                <div>
    <label className="text-xs font-bold text-slate-500 flex items-center gap-1">
        <Lock size={12}/> ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
    </label>
    <div className="relative">
        <input 
    name="password" 
    type={showPassword ? "text" : "password"} 
    required 
    className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all pr-10" 
    value={formData.password} 
    onChange={handleChange} 
/>

{/* ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÉ‡∏ä‡πâ SVG ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á) */}
<button 
    type="button" 
    onClick={() => setShowPassword(!showPassword)} 
    className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors" 
    tabIndex="-1"
    title={showPassword ? "‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" : "‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"}
>
    {showPassword ? (
        // üëÅÔ∏è‚Äçüó®Ô∏è ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏õ‡∏¥‡∏î (Eye Off - SVG)
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/>
            <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/>
            <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/>
            <line x1="2" x2="22" y1="2" y2="22"/>
        </svg>
    ) : (
        // üëÅÔ∏è ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡πÄ‡∏õ‡∏¥‡∏î (Eye - SVG)
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
            <circle cx="12" cy="12" r="3"/>
        </svg>
    )}
</button>
    </div>
</div>

                                <div className="flex justify-between items-center">
                                    
                                    
                                    {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏•‡∏∑‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */}
                                    <div className="flex gap-3 text-xs font-bold">
                                        <button type="button" onClick={() => { setView('forgotUser'); setFormData({...formData, email:''}); }} className="text-indigo-600 hover:underline">‡∏•‡∏∑‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ?</button>
                                        <span className="text-slate-300">|</span>
                                        <button type="button" onClick={() => { setView('forgot'); setOtpSent(false); setFormData({...formData, email:''}); }} className="text-blue-600 hover:underline">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?</button>
                                    </div>
                                </div>
                                <button type="submit" disabled={loading} className="w-full py-3.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-lg shadow-blue-200 transition-all transform active:scale-95 mt-4">{loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'}</button>
                            </form>
                        )}

                        {/* --- REGISTER FORM --- */}
                        {view === 'register' && (
                            <form onSubmit={handleRegisterConfirm} className="space-y-4">
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs font-bold text-slate-500">‡∏ä‡∏∑‡πà‡∏≠</label><input name="firstName" required disabled={otpSent} className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>
                                    <div><label className="text-xs font-bold text-slate-500">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input name="lastName" required disabled={otpSent} className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>
                                </div>
                                <div><label className="text-xs font-bold text-slate-500">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input name="empId" required disabled={otpSent} className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>
                                <div><label className="text-xs font-bold text-slate-500">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏£‡∏±‡∏ö OTP)</label><input name="email" type="email" required disabled={otpSent} className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>
                                <div><label className="text-xs font-bold text-slate-500">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label><input name="username" required disabled={otpSent} className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>
                                <div><label className="text-xs font-bold text-slate-500">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (6+ ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)</label><input name="password" type="password" required disabled={otpSent} className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>
                                {!otpSent && <div><label className="text-xs font-bold text-slate-500">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input name="confirmPassword" type="password" required className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>}
                                
                                {otpSent && (
                                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 text-center animate-in fade-in">
                                        <p className="text-xs text-blue-600 mb-2">Ref: <b>{refCode}</b> | ‡∏Å‡∏£‡∏≠‡∏Å OTP 4 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏≠‡∏µ‡πÄ‡∏°‡∏•</p>
                                        <input name="otp" type="text" maxLength="4" required className="w-32 mx-auto p-3 text-center text-xl font-bold bg-white border rounded-lg outline-none focus:ring-4 focus:ring-blue-200" placeholder="0000" onChange={handleChange} />
                                        <div className="mt-2"><button type="button" onClick={handleRegisterRequestOTP} disabled={countdown > 0} className={`text-xs underline ${countdown>0?'text-gray-400':'text-blue-600'}`}>{countdown>0 ? `‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô ${countdown} ‡∏ß‡∏¥` : '‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà'}</button></div>
                                    </div>
                                )}

                                {!otpSent ? (
                                    <button type="button" onClick={handleRegisterRequestOTP} disabled={loading} className="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-lg mt-4">{loading?'Checking...':'‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™ OTP'}</button>
                                ) : (
                                    <div className="flex gap-2 mt-4">
                                        <button type="button" onClick={() => setOtpSent(false)} className="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg font-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                        <button type="submit" disabled={loading} className="flex-[2] py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-lg">{loading?'Verifying...':'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'}</button>
                                    </div>
                                )}
                            </form>
                        )}

                        {/* --- FORGOT PASSWORD FORM --- */}
                        {view === 'forgot' && (
                            <form onSubmit={handleResetPassword} className="space-y-4 animate-in fade-in">
                                <div><label className="text-xs font-bold text-slate-500">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ</label><input name="email" type="email" required disabled={otpSent} className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>
                                
                                {otpSent && (
                                    <>
                                        <div className="bg-orange-50 p-4 rounded-xl border border-orange-100 text-center">
                                            <p className="text-xs text-orange-800 mb-2">Ref: <b>{refCode}</b> | ‡∏Å‡∏£‡∏≠‡∏Å OTP ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà</p>
                                            <input name="otp" type="text" maxLength="4" required className="w-32 mx-auto p-3 text-center text-xl font-bold bg-white border rounded-lg outline-none focus:ring-4 focus:ring-orange-200" placeholder="0000" onChange={handleChange} />
                                            <div className="mt-2"><button type="button" onClick={handleForgotRequestOTP} disabled={countdown > 0} className={`text-xs underline ${countdown>0?'text-gray-400':'text-orange-600'}`}>{countdown>0 ? `‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô ${countdown} ‡∏ß‡∏¥` : '‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà'}</button></div>
                                        </div>
                                        <div><label className="text-xs font-bold text-slate-500">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label><input name="newPassword" type="password" required className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>
                                        <div><label className="text-xs font-bold text-slate-500">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label><input name="confirmPassword" type="password" required className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>
                                    </>
                                )}

                                {!otpSent ? (
                                    <button type="button" onClick={handleForgotRequestOTP} disabled={loading} className="w-full py-3.5 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-bold shadow-lg mt-4">{loading?'Sending...':'‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP'}</button>
                                ) : (
                                    <div className="flex gap-2 mt-4">
                                        <button type="button" onClick={() => setOtpSent(false)} className="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                        <button type="submit" disabled={loading} className="flex-[2] py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-lg">{loading?'Resetting...':'‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'}</button>
                                    </div>
                                )}
                            </form>
                        )}

                        {/* --- ‚≠ê FORGOT USERNAME FORM --- */}
                        {view === 'forgotUser' && (
                            <form onSubmit={handleRecoverUsername} className="space-y-4 animate-in fade-in">
                                <div className="text-center mb-6">
                                    <div className="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-3"><User size={24}/></div>
                                    <p className="text-sm text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô<br/>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username) ‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•</p>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                                    <input name="email" type="email" required className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} value={formData.email} placeholder="name@example.com"/>
                                </div>
                                <button type="submit" disabled={loading} className="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-lg mt-2">{loading?'Sending...':'‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}</button>
                                <button type="button" onClick={() => setView('login')} className="w-full py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg font-bold text-sm">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                            </form>
                        )}

                        <div className="mt-8 text-center pb-8">
                            {view !== 'login' && view !== 'forgotUser' && <p className="text-xs text-slate-500 mb-2">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? <button onClick={() => { setView('login'); setOtpSent(false); }} className="text-blue-600 font-bold hover:underline">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></p>}
                            {view === 'login' && <p className="text-xs text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <button onClick={() => { setView('register'); setOtpSent(false); }} className="text-blue-600 font-bold hover:underline">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button></p>}
                            <div className="mt-6 flex justify-center items-center gap-2 text-[10px] text-slate-400"><ShieldCheck size={12}/> PurchaseHub System v1.0</div>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

// --- Helper: Print Check Logic (UPDATED HO Flow) ---
      const handleOpenPrintPreview = (req) => {
          const historyDesc = [...(req.history || [])].reverse();
          const isActionMatch = (logAction, statusKey) => {
              if (!logAction) return false;
              const label = STATUS_LABELS[statusKey] || '';
              return logAction === statusKey || logAction === label || logAction.includes(label);
          };

          // ‚≠ê ‡∏¢‡πâ‡∏≤‡∏¢ getUser ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏ö‡∏ô‡∏™‡∏∏‡∏î) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î
          const getUser = (log) => {
              if(!log || !log.user) return null;
              let txt = log.user.replace(' (Email)', '').trim();
              const firstPart = txt.split(' ')[0];
              return allUsers.find(u => 
                  (u.empId && u.empId === firstPart) || 
                  (u.username === txt) || 
                  (u.email && txt.includes(u.email)) || 
                  (`${u.firstName} ${u.lastName}` === txt)
              );
          };

          // 1. Requester
          const reqLog = historyDesc.find(h => h.action === 'Draft' || h.action === 'Create' || h.action.includes('‡∏™‡∏£‡πâ‡∏≤‡∏á')) || historyDesc[historyDesc.length - 1];
          
          // 2. Level 1 (‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ Pending PM ‡∏´‡∏£‡∏∑‡∏≠ Ready to Disburse)
          let l1Log = historyDesc.find(h => 
              isActionMatch(h.action, 'Pending PM') || 
              ((req.type === 'Withdraw' || req.type === 'Borrow') && isActionMatch(h.action, 'Ready to Disburse'))
          );

          // 3. Level 2 (L2) - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Flow ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Local->HO
          let l2Log = null;
          if (req.type === 'Local') {
              // Local Flow: L2 ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ô‡∏™‡πà‡∏á‡πÑ‡∏õ Pending Check
              l2Log = historyDesc.find(h => isActionMatch(h.action, 'Pending Check')); 
              if (!l2Log) l2Log = historyDesc.find(h => isActionMatch(h.action, 'Approved') && h !== l1Log); 
          } else {
              // HO Flow Logic (Updated):
              
              // 1. ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å "Pending Check" ‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™ Local -> HO)
              const pendingCheckLog = historyDesc.find(h => isActionMatch(h.action, 'Pending Check'));
              
              if (pendingCheckLog) {
                  const uCheck = getUser(pendingCheckLog); // ‚úÖ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß
                  const uReq = getUser(reqLog); 
                  
                  // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏Å‡∏î Check ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ -> ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô L2 ‡∏à‡∏≤‡∏Å Local Flow
                  const isRequester = (uCheck && uReq && uCheck.id === uReq.id) || 
                                      (pendingCheckLog.user === reqLog.user);
                                      
                  if (!isRequester) {
                      l2Log = pendingCheckLog;
                  }
              }

              // 2. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô HO ‡∏õ‡∏Å‡∏ï‡∏¥) ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏à‡∏≤‡∏Å Approved
              if (!l2Log) {
                  l2Log = historyDesc.find(h => 
                      isActionMatch(h.action, 'Approved') && 
                      h !== l1Log &&
                      (!h.note || !h.note.includes('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô HO'))
                  );
              }
          }

          // 4. ‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠ (Purchasing)
          let purchasingLog = null;
          if (['Local', 'HO'].includes(req.type)) {
              if (req.type === 'Local') {
                  // Local: ‡∏Ñ‡∏ô‡∏Å‡∏î Ordered ‡∏´‡∏£‡∏∑‡∏≠ Approved
                  purchasingLog = historyDesc.find(h => isActionMatch(h.action, 'Ordered')); 
                  if (!purchasingLog) {
                      const hasCheckStep = historyDesc.some(h => isActionMatch(h.action, 'Pending Check'));
                      if (hasCheckStep) {
                          purchasingLog = historyDesc.find(h => isActionMatch(h.action, 'Approved'));
                      } else {
                          purchasingLog = historyDesc.find(h => isActionMatch(h.action, 'Approved') && h !== l2Log && h !== l1Log);
                      }
                  }
              } else {
                  // HO: ‡∏î‡∏∂‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏™‡πà‡∏á‡πÑ‡∏õ "Pending Head"
                  purchasingLog = historyDesc.find(h => isActionMatch(h.action, 'Pending Head'));
                  
                  // Fallback
                  if (!purchasingLog) {
                      purchasingLog = historyDesc.find(h => 
                          h.note && (h.note.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô') || h.note.includes('Verify') || h.note.includes('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô HO'))
                       );
                  }
              }
          }

          const userReq = getUser(reqLog);
          const userL1 = getUser(l1Log);
          const userL2 = getUser(l2Log);
          const userPurchasing = getUser(purchasingLog);

          const missingSigs = [];
          if (!userReq || !userReq.signature) missingSigs.push("‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ (Requester)");
          if (!userL1 || !userL1.signature) missingSigs.push("‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 1");
          
          const needsL2 = (req.type === 'Local' || (req.type === 'HO' && req.isFullApprovalFlow));
          if (needsL2 && req.type !== 'Withdraw' && req.type !== 'Borrow') {
               if (!userL2 || !userL2.signature) missingSigs.push("‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 2");
          }

          const needsPurchasing = ['Local', 'HO'].includes(req.type);
          if (needsPurchasing) {
              if (!userPurchasing || !userPurchasing.signature) missingSigs.push("‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠ (Purchasing)");
          }

          if (missingSigs.length > 0) {
              showToast(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ: ‡∏Ç‡∏≤‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Ç‡∏≠‡∏á ${missingSigs.join(', ')}`, 'error');
          } else {
              openPOPreview(req);
          }
      };


const handleSaveProject = async () => {
    // 1. Validation
    if (!editingProject.id) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£', 'error'); return; }
    if (!editingProject.name) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£', 'error'); return; }
    
    if (editingProject.isNew && projects.some(p => p.id === editingProject.id)) {
        showToast('‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
        return;
    }

    // ‚≠ê ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Loading (‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏´‡∏°‡∏∏‡∏ô)
    setIsLoading(true);

    try {
        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (Old Data) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        let oldName = '';
        let oldId = '';
        if (!editingProject.isNew) {
            const originalProj = projects.find(p => p.id === editingProject.originalId);
            if (originalProj) {
                oldName = originalProj.name;
                oldId = originalProj.id;
            }
        }

        const projectToSave = { ...editingProject, isNew: undefined, originalId: undefined };
        
        // --- 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Optimistic UI) ---
        if (editingProject.isNew) {
            setProjects(prev => [...prev, projectToSave]);
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á
            if (user) {
                const currentPerms = { ...(user.permissions || {}) };
                currentPerms[projectToSave.name] = [26];
                const updatedUser = { ...user, permissions: currentPerms };
                setUser(updatedUser);
                google.script.run.saveUserData(updatedUser);
            }
        } else {
            setProjects(prev => prev.map(p => p.id === (editingProject.originalId || editingProject.id) ? projectToSave : p));
        }

        // --- 2. ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà Backend ---
        if (editingProject.isNew) {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà: ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            await new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).syncProject(projectToSave);
            });
            await addInvLog('Add Project', projectToSave.name, 'New', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà: ${projectToSave.name}`, []);
        } else {
            // ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏ß‡∏≤‡∏î‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö
            await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .updateProjectGlobalData(projectToSave, oldId, oldName);
            });

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log
            let changes = [];
            if(oldId !== projectToSave.id) changes.push(`ID: ${oldId} -> ${projectToSave.id}`);
            if(oldName !== projectToSave.name) changes.push(`Name: ${oldName} -> ${projectToSave.name}`);
            await addInvLog('Edit Project', projectToSave.name, 'Edit', `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:\n${changes.join('\n')}`, []);
        }
        
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        setShowProjectModal(false);
        setEditingProject(null);
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏î‡πâ‡∏ß‡∏¢
        if (viewingProject && viewingProject.id === (editingProject.originalId || editingProject.id)) {
            setViewingProject(projectToSave);
        } else {
            setShowProjectDetailModal(false);
        }

    } catch (error) {
        console.error(error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
    } finally {
        // ‚≠ê ‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à
        setIsLoading(false);
    }
};


// --- [index.html] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleDeleteProject (Secure Version) ---

const handleDeleteProject = async (id) => {
    // 1. ‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SubJob ‡πÅ‡∏•‡∏∞ Mat. Code ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')) return;
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)
    const targetProject = projects.find(p => p.id === id);
    const projectName = targetProject ? targetProject.name : id;

    // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡∏£‡∏≠ (Loading)
    setIsLoading(true);

    try {
        // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Backend ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Secure Call)
        await new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                // ‚≠ê ‡∏™‡πà‡∏á user.id ‡πÅ‡∏•‡∏∞ projectName ‡πÑ‡∏õ‡πÉ‡∏´‡πâ Backend ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                .deleteItemSecure(user.id, 'Projects', id, projectName); 
        });

        // 3. ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ Error) ‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        setProjects(prev => prev.filter(p => p.id !== id));
        
        // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡∏Å‡∏≤‡∏£‡∏•‡∏ö (Frontend Log - ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•)
        // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: Backend ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡πÄ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        await addInvLog('Delete Project', projectName, 'Delete', `‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${projectName} (ID: ${id})`, []);
        
        setShowProjectDetailModal(false); 
        showToast('‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

    } catch (err) {
        console.error(err);
        // ‡∏ñ‡πâ‡∏≤ Backend ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (Throw Error) ‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        showToast("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message, 'error');
        // (Optional: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Projects ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á)
        handleRefresh(); 
    } finally {
        setIsLoading(false);
    }
};

      const handleImportProjectData = (e, type) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (event) => {
              const text = event.target.result;
              const rows = text.split('\n').map(row => row.split(','));
              
              // CSV Format Expectation: Code, Description
              // Skip Header row if exists (Check if row 0 is header)
              
              
              const startIndex = rows[0][0].toLowerCase().includes('group') || rows[0][1].toLowerCase().includes('code') ? 1 : 0;

              // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic ‡∏Å‡∏≤‡∏£ Map ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Group ‡∏≠‡∏¢‡∏π‡πà Col 0, Code ‡∏≠‡∏¢‡∏π‡πà Col 1)
              const newData = rows.slice(startIndex).filter(row => row.length >= 2 && row[1]?.trim()).map(row => ({
                  group: row[0]?.trim() || '',        // Col 0: Group
                  code: row[1]?.trim(),               // Col 1: Code
                  description: row[2]?.trim() || '',  // Col 2: Description
                  budget: parseFloat(row[3]?.trim()) || 0 // Col 3: Budget
              }));
              
              setEditingProject(prev => ({
                  ...prev,
                  [type]: [...(prev[type] || []), ...newData]
              }));
              showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${type === 'subJobs' ? 'SubJob' : 'Mat. Code'} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${newData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
          };
          reader.readAsText(file);
          e.target.value = ''; // Reset input
      };



      // --- STATE: Asset Summary Drill-down ---
      const [showAssetGroupModal, setShowAssetGroupModal] = useState(false);
      const [selectedAssetGroup, setSelectedAssetGroup] = useState(null);
      // --- STATE: Selection & Restore ---
      const [selectedAssets, setSelectedAssets] = useState([]);
      
     // --- STATE: Inventory Selection ---
      const [selectedInventory, setSelectedInventory] = useState([]);

      // --- LOGIC: INVENTORY SELECTION & BULK DELETE ---
      
      const toggleSelectInventory = (id) => {
          setSelectedInventory(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
      };

      const toggleSelectAllInventory = () => {
          if (selectedInventory.length === filteredInventory.length) setSelectedInventory([]);
          else setSelectedInventory(filteredInventory.map(i => i.id));
      };

      // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      const handleDeleteInventory = async (ids = []) => {
          const targetIds = ids.length > 0 ? ids : selectedInventory;
          if (targetIds.length === 0) return;

          if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${targetIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£? \n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)`)) return;

          setIsLoading(true);
          try {
for (const id of targetIds) {
    const item = inventory.find(i => i.id === id);
    if (item) {
        // ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Backend ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        await new Promise((resolve, reject) => {
             // ‡∏™‡πà‡∏á user.id ‡πÅ‡∏•‡∏∞ item.project ‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
             google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject) // ‡πÄ‡∏û‡∏¥‡πà‡∏° reject ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö Error ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                .deleteItemSecure(user.id, 'Inventory', id, item.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á'); 
        });
        
        const backupData = JSON.stringify(item);
        
        // ‚≠ê ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Change
        const projectLabel = item.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
        await addInvLog('Delete Inventory', item.name, `Delete (${projectLabel})`, backupData, [], null, id);
    }
}

              setInventory(prev => prev.filter(i => !targetIds.includes(i.id)));
              setSelectedInventory([]); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
              setShowItemDetailModal(false);
              showToast(`‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${targetIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
          } catch (err) {
              console.error(err);
              showToast('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
          } finally {
              setIsLoading(false);
          }
      };
      const [invTabMode, setInvTabMode] = useState('System'); // 'System', 'NonSystem', 'Summary'

// --- STATE: Inventory Import ---
      const [showImportInvModal, setShowImportInvModal] = useState(false);
      const [importInvData, setImportInvData] = useState([]);
      const [importInvFileName, setImportInvFileName] = useState('');

      

// --- LOGIC: IMPORT INVENTORY CSV (UPDATED: Thai Support & ID Column) ---
const handleInvFileImport = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    setImportInvFileName(file.name);
    const reader = new FileReader();
    
    reader.onload = (event) => {
        const text = event.target.result;
        // ‚úÖ ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà: ‡πÉ‡∏ä‡πâ parseCSVLine ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏î " ‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        const rows = text.split(/\r?\n/).map(row => parseCSVLine(row));
        
        // Helper: ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
        const getStockType = (val) => {
            if (!val) return 'System';
            const v = val.trim().toLowerCase();
            if (v.includes('‡∏ô‡∏≠‡∏Å') || v.includes('non')) return 'NonSystem';
            return 'System'; // Default: ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        };

        // CSV Columns (9 columns): 
        // 0: ID, 1: Name, 2: Type, 3: Qty, 4: Unit, 5: Min, 6: Price, 7: Note, 8: Project
const data = rows.slice(1).filter(row => row.length > 1 && row[1]?.trim() !== '').map((row, index) => {
            return {
                tempId: index,
                id: row[0]?.trim() || '',
                name: row[1]?.trim() || '',
                stockType: getStockType(row[2]),
                qty: parseInt(row[3]?.trim()) || 0,
                unit: row[4]?.trim() || '‡∏ä‡∏¥‡πâ‡∏ô',
                minStock: parseInt(row[5]?.trim()) || 0,
                price: parseFloat(row[6]?.trim()) || 0,
                note: row[7]?.trim() || '',
                project: row[8]?.trim() || '',
                supplier: row[9]?.trim() || '' // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ Supplier
            };
        });
        setImportInvData(data);
    };
    
    reader.readAsText(file);
};


// --- Helper: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á CSV ‡πÅ‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Quote (") ---
    const parseCSVLine = (text) => {
        const result = [];
        let current = '';
        let inQuote = false;
        
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            
            if (char === '"') {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ "" ‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ü‡∏±‡∏ô‡∏´‡∏ô‡∏π 1 ‡∏ï‡∏±‡∏ß (Escape)
                if (inQuote && text[i + 1] === '"') {
                    current += '"';
                    i++; 
                } else {
                    inQuote = !inQuote; // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Quote
                }
            } else if (char === ',' && !inQuote) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ , ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Quote ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current);
        return result;
    };

// --- LOGIC: CONFIRM IMPORT INVENTORY (BATCH + CHUNKING VERSION) ---
const confirmImportInventory = async () => {
    if (importInvData.length === 0) return;

    // 1. Validation Loop (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    for (let i = 0; i < importInvData.length; i++) {
        const item = importInvData[i];
        if (!item.name) { showToast(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${i+1}: ‡∏Ç‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤`, 'error'); return; }
        if (!item.project) { showToast(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${i+1}: ‡∏Ç‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£`, 'error'); return; }
        const projectExists = projects.some(p => p.name === item.project);
        if (!projectExists) { showToast(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${i+1}: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ "${item.project}" ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`, 'error'); return; }
    }

    setIsLoading(true); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏ô Loading
    const date = new Date().toLocaleString('th-TH');
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    let currentInvList = [...inventory];
    let runNoCount = inventory.length;
    
    // ‚≠ê ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏ã‡∏≠‡∏¢‡∏™‡πà‡∏á)
    let batchItems = [];
    let batchLogs = [];

    // 2. Loop Processing (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Logic ‡∏Å‡∏≤‡∏£ Merge/New Item)
    for (const item of importInvData) {
        const currentType = item.stockType || 'System';

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const existingIndex = currentInvList.findIndex(inv => 
            inv.name === item.name && 
            inv.project === item.project &&
            (inv.stockType === currentType || (!inv.stockType && currentType === 'System'))
        );
const logNote = (item.note || '') + (item.supplier ? ` | ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ${item.supplier}` : '');

        if (existingIndex !== -1) {
            // ‚úÖ MERGE (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
            const existingItem = currentInvList[existingIndex];
            const updatedItem = {
                ...existingItem,
                id: existingItem.id, 
                qty: existingItem.qty + item.qty,
                price: item.price > 0 ? item.price : existingItem.price,
                note: logNote,
                lastUpdated: date,
                supplier: item.supplier || existingItem.supplier
            };
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô List ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏á‡∏≤‡∏ô)
            currentInvList[existingIndex] = updatedItem;
            
            // ‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            const { images, ...itemForServer } = updatedItem;
            batchItems.push(itemForServer);

            const supplierTxt = item.supplier ? ` | ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ${item.supplier}` : '';
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Note ‡∏à‡∏≤‡∏Å CSV ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Note ‡∏ô‡∏±‡πâ‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ "CSV Import" ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
            const baseNote = item.note || 'CSV Import'; 
            const logNote = `${baseNote}${supplierTxt}`;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Log ‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
            batchLogs.push({
                date: date,
                action: 'Import Merge',
                item: updatedItem.name,
                change: `+${item.qty}`,
                note: logNote,
                images: [],
                requestId: null,
                assetId: updatedItem.id,
                by: `${user.empId} ${user.firstName}`,
                supplier: item.supplier
            });
            
        } else {
            // ‚úÖ NEW (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)
            let baseId = item.id;
            if (!baseId) {
                runNoCount++;
                baseId = `INV-${String(runNoCount).padStart(3, '0')}`;
                while (currentInvList.some(inv => getDisplayId(inv.id) === baseId)) {
                    runNoCount++;
                    baseId = `INV-${String(runNoCount).padStart(3, '0')}`;
                }
            }

            let finalId = `${baseId}|${item.project}|${currentType}`;
            let counter = 1;
            while (currentInvList.some(i => i.id === finalId)) {
                finalId = `${baseId}|${item.project}|${currentType}|${counter}`;
                counter++;
            }

            const newItem = {
                id: finalId,
                name: item.name,
                stockType: currentType,
                qty: item.qty,
                unit: item.unit || '‡∏ä‡∏¥‡πâ‡∏ô',
                minStock: item.minStock || 0,
                price: item.price || 0,
                lastUpdated: date,
                image: null,
                images: [],
                note: item.note,
                supplier: item.supplier || '',
                project: item.project
            };
            
            currentInvList.push(newItem);
            
            const { images, ...itemForServer } = newItem;
            batchItems.push(itemForServer);

            const typeLabel = currentType === 'NonSystem' ? '[‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö]' : '[‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö]';
            const supplierTxt = item.supplier ? ` | ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ${item.supplier}` : '';
            const logNote = `‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: ${item.project} [${typeLabel}] | CSV New Item${supplierTxt}`;
            batchLogs.push({
                date: date, 
                action: 'Import New',
                item: newItem.name,
                change: `Start: ${newItem.qty}`,
                note: logNote,
                images: [],
                requestId: null,
                assetId: finalId,
                by: `${user.empId} ${user.firstName}`,
                supplier: item.supplier
            });
        }
    }

    // ‚≠ê‚≠ê 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÅ‡∏ö‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô (Chunking Logic) ‚≠ê‚≠ê
    const CHUNK_SIZE = 100; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 50-100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
    const totalChunks = Math.ceil(batchItems.length / CHUNK_SIZE);

    try {
        for (let i = 0; i < batchItems.length; i += CHUNK_SIZE) {
            // ‡∏ï‡∏±‡∏î‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Items ‡πÅ‡∏•‡∏∞ Logs ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
            const chunkItems = batchItems.slice(i, i + CHUNK_SIZE);
            const chunkLogs = batchLogs.slice(i, i + CHUNK_SIZE);
            
            const currentChunk = Math.floor(i / CHUNK_SIZE) + 1;
            
            // ‡πÅ‡∏™‡∏î‡∏á Toast ‡∏ö‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
            showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${currentChunk}/${totalChunks} (${chunkItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)...`, 'info');

            // ‡∏™‡πà‡∏á‡∏Å‡πâ‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏£‡∏≠‡∏à‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡πà‡∏á‡∏Å‡πâ‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ)
            await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler((err) => reject(new Error(`Batch ${currentChunk} failed: ${err.message}`)))
                    .batchImportInventory(chunkItems, chunkLogs); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
            });
        }

        // 4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Å‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        setInventory(currentInvList); 
        
        setIsLoading(false);
        setShowImportInvModal(false);
        setImportInvData([]);
        setImportInvFileName('');
        showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${batchItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!`);
        
    } catch (error) {
        setIsLoading(false);
        console.error(error);
        showToast("Error saving batch: " + error.message, 'error');
    }
};


      // --- LOGIC: DELETE & RESTORE ---
      
      // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
      const handleDeleteAssets = async (ids = []) => {
          const targetIds = ids.length > 0 ? ids : selectedAssets;
          if (targetIds.length === 0) return;
          
          if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${targetIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£? \n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢ Admin)`)) return;

          setIsLoading(true);
          try {
              // ‡∏ß‡∏ô‡∏•‡∏π‡∏•‡∏•‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
for (const id of targetIds) {
    const asset = assets.find(a => a.id === id);
    if (asset) {
        // ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Backend ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        await new Promise((resolve, reject) => {
             google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .deleteItemSecure(user.id, 'Assets', id, asset.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á');
        });
        
        const backupData = JSON.stringify(asset);
        
        // ‚≠ê ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Change
        const projectLabel = asset.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
        await addInvLog('Delete Asset', asset.name, `Delete (${projectLabel})`, backupData, [], null, id);
    }
}

              // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï State (‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
              setAssets(prev => prev.filter(a => !targetIds.includes(a.id)));
              setSelectedAssets([]); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
              setShowItemDetailModal(false); // ‡∏õ‡∏¥‡∏î Modal ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
              
              showToast(`‡∏•‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ${targetIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

          } catch (err) {
              console.error(err);
              showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
          } finally {
              setIsLoading(false);
          }
      };

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô (Restore) - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
const handleRestoreAsset = async (log) => {
    try {
        // 1. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Note (JSON) ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏ô
        const assetData = JSON.parse(log.note);
        if (!assetData || !assetData.id) throw new Error("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Backup ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

        // ‚≠ê 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô (27) ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô‡πÜ
        const targetProject = assetData.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á'; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Project ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á
        if (!hasPermission(27, targetProject)) {
            showToast(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ "${targetProject}"`, 'error');
            return;
        }

        setIsLoading(true);
        // 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ ID ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥)
        if (assets.some(a => a.id === assetData.id)) {
                showToast(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${assetData.id} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô)`, 'error');
                setIsLoading(false);
                return;
        }

        // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheet
        const { images, ...assetForServer } = assetData;
        await new Promise((resolve) => {
                google.script.run.withSuccessHandler(resolve).syncAsset(assetForServer);
        });

        // 5. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï State ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log
        setAssets(prev => [...prev, assetData]);
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô (‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢)
        await addInvLog('Restore Asset', assetData.name, 'Restore', `‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${targetProject} (‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${log.date})`, [], null, assetData.id);
        
        showToast(`‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô ${assetData.id} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    } catch (err) {
        console.error(err);
        showToast('‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error');
    } finally {
        setIsLoading(false);
    }
};

      // --- LOGIC: INVENTORY MANAGEMENT (DELETE, RESTORE, UPDATE) ---


// 3. ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Restore Inventory) - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
const handleRestoreInventory = async (log) => {
    try {
        // 1. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const itemData = JSON.parse(log.note);
        if (!itemData || !itemData.id) throw new Error("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Backup ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

        // ‚≠ê 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô (27) ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô‡πÜ
        const targetProject = itemData.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
        if (!hasPermission(27, targetProject)) {
            showToast(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ "${targetProject}"`, 'error');
            return;
        }

        setIsLoading(true);
        // 3. ‡πÄ‡∏ä‡πá‡∏Ñ ID ‡∏ã‡πâ‡∏≥
        if (inventory.some(i => i.id === itemData.id)) {
                showToast(`‡∏£‡∏´‡∏±‡∏™ ${itemData.id} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`, 'error');
                setIsLoading(false);
                return;
        }

        // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheet
        const { images, ...itemForServer } = itemData;
        await new Promise((resolve) => {
                google.script.run.withSuccessHandler(resolve).syncInventory(itemForServer);
        });

        // 5. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï State ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log
        setInventory(prev => [...prev, itemData]);
        
        await addInvLog('Restore Inventory', itemData.name, 'Restore', `‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${targetProject} (‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ${log.date})`, [], null, itemData.id);

        showToast(`‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${itemData.id} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    } catch (err) {
        console.error(err);
        showToast('‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
    } finally {
        setIsLoading(false);
    }
};

// --- HELPER: ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Inventory Edit) ---

// 1. ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (New Preview)
const handleRemoveEditStockNewImage = (index) => {
    setEditingStockItem(prev => ({
        ...prev,
        newImages: prev.newImages.filter((_, i) => i !== index)
    }));
};

// 2. ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (Current Image)
const handleRemoveCurrentInvImage = () => {
    if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        setEditingStockItem(prev => ({ ...prev, image: null }));
    }
};

// [‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleUpdateInventory ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ]

const handleUpdateInventory = async () => {
    if (!editingStockItem) return;

    // 1. Validation: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    const duplicateName = inventory.find(i => 
        i.name === editingStockItem.name && 
        i.project === editingStockItem.project && 
        (i.stockType === editingStockItem.stockType) &&
        i.id !== editingStockItem.originalId
    );

    if (duplicateName) {
        showToast(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡∏ä‡∏∑‡πà‡∏≠ "${editingStockItem.name}" ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô`, 'error');
        return;
    }

    setIsLoading(true);
    try {
        const date = new Date().toLocaleString('th-TH');
        const currentType = editingStockItem.stockType || 'System';
        
        // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÄ‡∏ï‡πá‡∏° (Real ID)
        let inputId = editingStockItem.id;
        if (inputId.includes('|')) inputId = inputId.split('|')[0];
        
        let finalId = `${inputId}|${editingStockItem.project}|${currentType}`;
        
        // 3. ‡πÄ‡∏ä‡πá‡∏Ñ ID ‡∏ã‡πâ‡∏≥
        if (finalId !== editingStockItem.originalId) { 
             let counter = 1;
             while (inventory.some(i => i.id === finalId && i.id !== editingStockItem.originalId)) {
                 finalId = `${inputId}|${editingStockItem.project}|${currentType}|${counter}`;
                 counter++;
             }
        } else {
             finalId = editingStockItem.originalId;
        }

        // 4. Upload Images
        let newUploadedFiles = [];
        if (editingStockItem.newImages && editingStockItem.newImages.length > 0) {
             const uploadPromises = editingStockItem.newImages.map(imgObj => {
                return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(imgObj.file);
                        reader.onload = () => google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).uploadAssetImage(reader.result, imgObj.file.name);
                });
            });
            newUploadedFiles = await Promise.all(uploadPromises);
        }
        const mainImage = newUploadedFiles.length > 0 ? newUploadedFiles[0].name : editingStockItem.image;
        
        // 5. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
        const updatedItem = {
            ...editingStockItem,
            id: finalId, // ‡πÉ‡∏ä‡πâ ID ‡πÉ‡∏´‡∏°‡πà
            lastUpdated: date,
            image: mainImage,
            images: [], 
            newImages: []
        };

        // ‚≠ê 6. ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Detailed Change Log)
        const oldItem = inventory.find(i => i.id === editingStockItem.originalId);
        let changes = [];
        const val = (v) => (v === null || v === undefined || v === '') ? '-' : v; // Helper

        if (oldItem) {
            // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            if (val(oldItem.stockType) !== val(updatedItem.stockType)) changes.push(`‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${val(oldItem.stockType)} -> ${val(updatedItem.stockType)}`);
            // ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            if (val(getDisplayId(oldItem.id)) !== val(inputId)) changes.push(`‡∏£‡∏´‡∏±‡∏™: ${getDisplayId(oldItem.id)} -> ${inputId}`);
            // ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            if (val(oldItem.name) !== val(updatedItem.name)) changes.push(`‡∏ä‡∏∑‡πà‡∏≠: ${val(oldItem.name)} -> ${val(updatedItem.name)}`);
            // ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
            if (oldItem.qty !== updatedItem.qty) changes.push(`Qty: ${oldItem.qty} -> ${updatedItem.qty}`);
            // ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö
            if (val(oldItem.unit) !== val(updatedItem.unit)) changes.push(`‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${val(oldItem.unit)} -> ${val(updatedItem.unit)}`);
            // Min Stock
            if (oldItem.minStock !== updatedItem.minStock) changes.push(`Min Stock: ${oldItem.minStock} -> ${updatedItem.minStock}`);
            // ‡∏£‡∏≤‡∏Ñ‡∏≤
            if (oldItem.price !== updatedItem.price) changes.push(`‡∏£‡∏≤‡∏Ñ‡∏≤: ${oldItem.price} -> ${updatedItem.price}`);
            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
            if (val(oldItem.note) !== val(updatedItem.note)) changes.push(`Note: ${val(oldItem.note)} -> ${val(updatedItem.note)}`);
            // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            if (newUploadedFiles.length > 0) changes.push(`‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà`);
        }

        // 7. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™ (Change ID Logic)
        if (editingStockItem.originalId !== finalId) {
             await new Promise(r => google.script.run.withSuccessHandler(r).deleteDataFromSheet('Inventory', editingStockItem.originalId)); 
             
             try {
                 await new Promise(r => google.script.run.withSuccessHandler(r).updateLogItemId(editingStockItem.originalId, finalId));
             } catch (e) { console.log("Backend updateLogItemId error"); }

             setInvLogs(prevLogs => prevLogs.map(log => {
                 if (log.assetId === editingStockItem.originalId) return { ...log, assetId: finalId };
                 return log;
             }));
        }

        // 8. Update State & Save
        setInventory(prev => {
            const filtered = prev.filter(i => i.id !== editingStockItem.originalId);
            return [...filtered, updatedItem];
        });

        const { images, newImages, originalId, originalName, originalProject, ...itemForServer } = updatedItem;
        await saveInventoryToSheet(itemForServer);

        // 9. Add Log
        const logAttachments = newUploadedFiles.map(f => ({ name: f.name, type: 'image/jpeg', url: f.url }));
        
        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Changes ‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ
        const changeDetail = changes.length > 0 ? changes.join('\n') : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤)';
        const noteText = `‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: ${updatedItem.project}\n${changeDetail}`;
            
        await addInvLog('Update Stock', updatedItem.name, 'Edit', noteText, logAttachments, null, finalId);
        
        setIsLoading(false);
        setShowEditInvModal(false);
        setEditingStockItem(null);
        showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

    } catch (error) {
        setIsLoading(false);
        console.error(error);
        showToast("Error: " + error.message, 'error');
    }
};


      // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Checkbox
      const toggleSelectAsset = (id) => {
          setSelectedAssets(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
      };

      const toggleSelectAllAssets = () => {
          if (selectedAssets.length === filteredAssets.length) setSelectedAssets([]);
          else setSelectedAssets(filteredAssets.map(a => a.id));
      };

      const toggleExpandItem = (idx) => {
    const newSet = new Set(expandedItems);
    if (newSet.has(idx)) newSet.delete(idx);
    else newSet.add(idx);
    setExpandedItems(newSet);
};
      

      // --- FUNCTION: Open Image Fullscreen ---
      const handleOpenImage = (imageUrl) => {
          if (imageUrl) {
              setFullscreenImage(imageUrl);
          }
      };

      
  // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Promise ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà await ‡πÑ‡∏î‡πâ (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Too many scripts)
      const saveRequestToSheet = (req) => {
         return new Promise((resolve, reject) => google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).syncRequest(req));
      };
      const saveInventoryToSheet = (item) => {
         return new Promise((resolve, reject) => google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).syncInventory(item));
      };
      const saveAssetToSheet = (asset) => {
         return new Promise((resolve, reject) => google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).syncAsset(asset));
      };


const saveLogToSheet = (log) => {
   // ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Promise ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à
   return new Promise((resolve, reject) => {
       google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).syncLog(log);
   });
};

const handleCreateOrder = async (e, isDraft = false) => {
    e.preventDefault();

    // =================================================================
    // 1. Validation Logic (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á - ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£)
    // =================================================================
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (Header)
    if (!newOrderMeta.job || !newOrderMeta.dateRequired) {
        showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£", 'error');
        return;
    }
    if (orderItems.length === 0) { 
        showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", 'error');
        return; 
    }

    if (newOrderMeta.type === 'Withdraw') {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏á
        const hasSystem = orderItems.some(item => item.stockType === 'System' || !item.stockType); 
        const hasNonSystem = orderItems.some(item => item.stockType === 'NonSystem');
        
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡∏õ‡∏ô‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á Error ‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        if (hasSystem && hasNonSystem) {
            showToast("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á '‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' ‡πÅ‡∏•‡∏∞ '‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö' ‡∏õ‡∏ô‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏¢‡∏Å‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", 'error');
            return;
        }
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏Å‡∏î "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠" ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πà‡∏≤‡∏á")
    if (!isDraft) { 
        const targetProject = newOrderMeta.job;
        
        for (const item of orderItems) {
            // --- Check 1: SubJob ‡πÅ‡∏•‡∏∞ Mat. Code ---
            if (['Local', 'HO'].includes(newOrderMeta.type)) {
                if (!item.subJob || !item.matCode) { 
                    showToast(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${item.name}" ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏±‡πâ‡∏á SubJob ‡πÅ‡∏•‡∏∞ Mat. Code`, 'error');
                    return; 
                }
            } else if (newOrderMeta.type === 'Withdraw') {
                if (!item.subJob && !item.matCode) { 
                    showToast(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${item.name}" ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ SubJob ‡∏´‡∏£‡∏∑‡∏≠ Mat. Code ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á`, 'error');
                    return; 
                }
            }

            // --- Check 2: ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (Local, HO) ---
            if (['Local', 'HO'].includes(newOrderMeta.type)) {
                const price = parseFloat(item.unitPrice);
                if (!price || price <= 0) {
                    showToast(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${item.name}" ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0)`, 'error');
                    return; 
                }
            }

// --- Check 3 & 4: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô (Frontend Check) ---
            if (newOrderMeta.type === 'Withdraw') {
                // ‚≠ê ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏à‡∏∏‡∏î
                const currentStockType = item.stockType || newOrderMeta.withdrawStockType || 'System';
                const stockTypeLabel = currentStockType === 'NonSystem' ? '‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö' : '‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';

                const stockItem = inventory.find(i => 
                    i.name === item.name && 
                    i.project === targetProject &&
                    (i.stockType || 'System') === currentStockType
                );

                if (!stockItem) {
                    showToast(`‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${item.name}" (${stockTypeLabel}) ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${targetProject}`, 'error');
                    return; 
                }
                if (item.qty > stockItem.qty) {
                    showToast(`‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${item.name}" (${stockTypeLabel}) ‡∏°‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏Ç‡∏≠: ${item.qty}, ‡∏°‡∏µ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á: ${stockItem.qty})`, 'error');
                    return; 
                }
            } else if (newOrderMeta.type === 'Borrow') {
                 if (item.assetId) {
                    const assetItem = assets.find(a => a.id === item.assetId);
                    if (!assetItem) {
                        showToast(`‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏£‡∏´‡∏±‡∏™ ${item.assetId}`, 'error');
                        return;
                    }
                    if (assetItem.status !== 'Available') {
                        showToast(`‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô "${item.name}" ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${assetItem.status})`, 'error');
                        return;
                    }
                }
            }
        }
    }

    // =================================================================
    // 2. Prepare Data & Upload Files (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    // =================================================================
    setIsLoading(true);
    
    let attachmentData = newOrderMeta.attachment;
    let quotationData = newOrderMeta.quotation;
    
    try {
        // 2.1 ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å
        if (uploadFiles.email) {
            const base64 = await fileToBase64(uploadFiles.email);
            const result = await new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).uploadFileToDrive(base64, uploadFiles.email.name);
            });
            if (result.error) throw new Error(result.error);
            attachmentData = result;
        }
        
        if (uploadFiles.quotation) {
            const base64 = await fileToBase64(uploadFiles.quotation);
            const result = await new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).uploadFileToDrive(base64, uploadFiles.quotation.name);
            });
            if (result.error) throw new Error(result.error);
            quotationData = result;
        }

        // 2.2 ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const processedItems = await Promise.all(orderItems.map(async (item) => {
            let processedImages = [];
            if (item.images && item.images.length > 0) {
                const itemImagePromises = item.images.map(imgObj => {
                    if (imgObj.base64) {
                            return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .uploadAssetImage(imgObj.base64, imgObj.name); 
                        });
                    }
                    return Promise.resolve(imgObj);
                });

                const uploadedResults = await Promise.all(itemImagePromises);
                processedImages = uploadedResults.map(u => ({ name: u.name, type: 'image/jpeg', url: u.url }));
            }
            return { ...item, images: processedImages };
        }));

        // =================================================================
        // 3. Construct Payload & Save
        // =================================================================
        
        let nextStatus = 'Draft';
        let isFullFlow = false;
        const existingReq = editingId ? requests.find(r => r.id === editingId) : null;
        if (existingReq) isFullFlow = existingReq.isFullApprovalFlow || false;
        
        if (!isDraft) {
            if (newOrderMeta.type === 'HO' && existingReq?.isPreviouslyApproved) {
                nextStatus = 'Pending Check'; 
            } else if (newOrderMeta.type === 'HO') {
                nextStatus = isFullFlow ? 'Pending Head' : 'Pending Check';
            } else if (newOrderMeta.type === 'Local' && existingReq?.status === 'Revise Needed') {
                nextStatus = 'Pending Check';
            } else {
                nextStatus = 'Pending Head';
            }
        }

        const orderPayload = {
            requester: `${user.firstName} ${user.lastName}`,
            status: nextStatus,
            created: existingReq ? existingReq.created : new Date().toISOString().split('T')[0],
            items: processedItems, 
            ...newOrderMeta,
            attachment: attachmentData,
            quotation: quotationData,
            docNumber: existingReq?.docNumber || null,
            isFullApprovalFlow: isFullFlow,
            isPreviouslyApproved: existingReq?.isPreviouslyApproved || false,
            history: [
                ...(existingReq?.history || []),
                createLog(
                    isDraft ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á' : (editingId ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Edit Data)' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠'),
                    `${user.empId} ${user.firstName} ${user.lastName}`,
                    isFullFlow ? 'Submit (Full Flow)' : 'Submit'
                )
            ],
            comments: existingReq?.comments || []
        };

        // --- ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---

if (editingId) {
            // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Edit):
            orderPayload.id = editingId;
            
            // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô helper ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (‡∏°‡∏µ await ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
            await saveRequestToSheet(orderPayload); 
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï State ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            setRequests(prev => prev.map(r => r.id === editingId ? orderPayload : r));
            if (selectedRequest && selectedRequest.id === orderPayload.id) {
                setSelectedRequest(orderPayload);
            }

        } else {
            // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (New): ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Backend ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å
            const result = await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve) 
                    .withFailureHandler(reject)
                    .createRequestSecurely(orderPayload); // üëà ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
            });

            // üõë ‡πÄ‡∏ä‡πá‡∏Ñ Result ‡∏à‡∏≤‡∏Å Backend
            if (!result.success) {
                throw new Error(result.message); // ‡πÇ‡∏¢‡∏ô Error ‡πÑ‡∏õ‡∏ó‡∏µ‡πà catch ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
            }

            // ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            const newRequest = result.request; 
            setRequests(prev => [newRequest, ...prev]);
            if (selectedRequest) setSelectedRequest(newRequest);
        }

        // =================================================================
        // 4. Finalize
        // =================================================================

        const targetId = editingId || (requests[0] ? requests[0].id : null);
        if (showVerificationModal && verificationData.requestId === targetId) {
             const hasQuotation = !!orderPayload.quotation; 
             const hasEmail = !!orderPayload.attachment;    
             setVerificationData(prev => ({
                 ...prev,
                 filesExist: { quotation: hasQuotation, email: hasEmail },
                 checks: { ...prev.checks, quotation: hasQuotation ? true : prev.checks.quotation, email: hasEmail ? true : prev.checks.email }
             }));
        }

        setIsLoading(false);
        showToast(isDraft ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß' : (editingId ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'));
        
        setUploadFiles({ email: null, quotation: null });
        handleCloseCreateModal();

    } catch (err) {
        console.error("Create Order Error:", err);
        showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message, 'error');
        
        // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÄ‡∏ä‡πá‡∏Ñ Error ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const msg = err.message || "";
        if (msg.includes('‡∏°‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏≠') || msg.includes('‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á') || msg.includes('‡∏ï‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á') || msg.includes('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')) {
            console.log("Stock mismatch detected. Refreshing data...");
            handleRefresh(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
        }
        
        setIsLoading(false);
    }
};
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Refresh ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Logs ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢) ---
const handleRefresh = () => {
    setIsLoading(true);
    setIsError(false); // Reset Error state

    // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (Requests, Inventory, Assets, Users, Projects)
    google.script.run
        .withSuccessHandler((data) => {
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
            if(data.requests) setRequests(data.requests);
            if(data.inventory) setInventory(data.inventory);
            if(data.assets) setAssets(data.assets);
            if(data.projects) setProjects(data.projects);
            if(data.users) setAllUsers(data.users);
            
            // 2. ‚≠ê‚≠ê ‡∏™‡∏±‡πà‡∏á‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Logs) ‡∏ï‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‚≠ê‚≠ê
            google.script.run.withSuccessHandler((logs) => {
                if (logs && logs.length > 0) {
                    setInvLogs(logs); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ invLogs ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                }
                
                setIsLoading(false); // ‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏°‡∏∏‡∏ô
                showToast('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                
            }).getRecentLogs(200); // ‡∏î‡∏∂‡∏á 200 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)

        })
        .withFailureHandler((error) => {
            setIsLoading(false);
            showToast('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
        })
        .loadInitialData(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà Backend
};

// --- LOGIC: New User Count (‡∏ô‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà) ---
const newUsersCount = useMemo(() => {
    if (!allUsers) return 0;
    return allUsers.filter(u => u.status === 'New').length;
}, [allUsers]);

const myPendingCount = useMemo(() => {
          if (!user || !requests) return 0;
          const myName = `${user.firstName} ${user.lastName}`;

          return requests.filter(req => {
              if (globalProjectFilter !== 'All' && req.job !== globalProjectFilter) return false;
              if (['Completed', 'Rejected', 'Returned'].includes(req.status)) return false;

              const isMine = req.requester === myName || req.requester === 'Current User';
              
              let canAct = false;
              // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] Logic ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Pending Head
              if (req.status === 'Pending Head') {
                  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏° -> ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á Level 1 (8) ‡πÅ‡∏•‡∏∞ Level 2 (9)
                  if ((req.type === 'Withdraw' || req.type === 'Borrow') && (hasPermission(8) || hasPermission(9))) {
                      canAct = true;
                  }
                  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠ -> ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Level 1 (8) ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
                  else if (['Local', 'HO'].includes(req.type) && hasPermission(8)) {
                      canAct = true;
                  }
              }

              if (hasPermission(9) && req.status === 'Pending PM') canAct = true;
              if (hasPermission(10) && req.status === 'Pending Check') canAct = true;
              if (hasPermission(11) && req.status === 'Approved' && req.purchaseType === 'Buy') canAct = true;
              if (hasPermission(12) && req.type === 'HO' && req.status === 'PR Issued') canAct = true;
              if (hasPermission(12) && req.type === 'Local' && req.status === 'Approved') canAct = true;
              if (hasPermission(13) && req.type === 'HO' && (req.status === 'PO Issued' || req.status === 'Contract Signed')) canAct = true;
              if (hasPermission(14) && req.type === 'HO' && req.status === 'Contract Pending') canAct = true;
              if (hasPermission(15) && req.type === 'Local' && (req.status === 'Ordered' || req.status === 'Partially Received')) canAct = true;
              if (hasPermission(15) && req.type === 'HO' && (req.status === 'Shipping' || req.status === 'Partially Received')) canAct = true;
              if (hasPermission(24) && (req.type === 'Withdraw' || req.type === 'Borrow') && req.status === 'Ready to Disburse') canAct = true;

              // Admin ‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á
              if (user.isSuperAdmin) return true;

              return isMine || canAct;
          }).length;
      }, [requests, user, globalProjectFilter]);


useEffect(() => {
        google.script.run.withSuccessHandler((data) => {
            if (data && data.length > 0) {
                setPublicAnnounces(data);
                setShowPublicAnnounce(true); // ‡πÄ‡∏õ‡∏¥‡∏î Popup ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Active
            }
        }).getPublicAnnouncements();
    }, []);
      
      useEffect(() => {
        setIsLoading(true);
        google.script.run.withSuccessHandler((data) => {
           if(data.requests) setRequests(data.requests);
           if(data.inventory) setInventory(data.inventory);
           if(data.assets) setAssets(data.assets);
           if(data.logs) setInvLogs(data.logs);
           if(data.projects) setProjects(data.projects);
           if(data.users) setAllUsers(data.users);
           
           if (data.announcement && data.announcement.active) {
               setAnnouncement(data.announcement);
               setAnnounceForm({ title: data.announcement.title, detail: data.announcement.detail });
           } else {
               setAnnouncement(null);
               setAnnounceForm({ title: '', detail: '' });
           }

           setIsLoading(false);
        }).loadInitialData();
      }, []);

useEffect(() => {
  setIsLoading(true);
  setIsError(false); // Reset Error ‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î

  google.script.run
    .withSuccessHandler((data) => {
        // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà setRequests, setInventory ‡∏Ø‡∏•‡∏Ø) ...
        if(data.requests) setRequests(data.requests);
        if(data.inventory) setInventory(data.inventory);
        if(data.assets) setAssets(data.assets);
        if(data.projects) setProjects(data.projects);
        if(data.users) setAllUsers(data.users);
        
        if (data.announcement && data.announcement.active) {
            setAnnouncement(data.announcement);
            setAnnounceForm({ title: data.announcement.title, detail: data.announcement.detail });
        } else {
            setAnnouncement(null);
            setAnnounceForm({ title: '', detail: '' });
        }

        setIsLoading(false);
        
        // ‡πÇ‡∏´‡∏•‡∏î Logs ‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        google.script.run.withSuccessHandler((logs) => {
            if(logs && logs.length > 0) setInvLogs(logs);
        }).getRecentLogs(100);
    })
    .withFailureHandler((error) => { // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏±‡∏á
        console.error(error);
        setIsLoading(false);
        setIsError(true);
        setErrorMessage(error.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Server ‡πÑ‡∏î‡πâ");
    })
    .loadInitialData();
}, []);


      // State from original file
      const [assetTabMode, setAssetTabMode] = useState('Company');
      
      const [dashboardSearch, setDashboardSearch] = useState('');
      const [dashboardStatusFilter, setDashboardStatusFilter] = useState('All');
      const [searchQuery, setSearchQuery] = useState('');
      const [invSearch, setInvSearch] = useState('');
      const [assetSearch, setAssetSearch] = useState('');
      const [historySearch, setHistorySearch] = useState('');
      const [historyFilterItem, setHistoryFilterItem] = useState(null);
      const [invSort, setInvSort] = useState({ key: 'id', direction: 'asc' });
      const [assetSort, setAssetSort] = useState({ key: 'id', direction: 'asc' });
      const [statusFilter, setStatusFilter] = useState('All');
      const [typeFilter, setTypeFilter] = useState('All');
      
      // Modals
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [showDetailModal, setShowDetailModal] = useState(false);
      const [showPRModal, setShowPRModal] = useState(false);
      const [showPOModal, setShowPOModal] = useState(false);
      const [notification, setNotification] = useState(null);
      const [showReceiveGoodsModal, setShowReceiveGoodsModal] = useState(false);
      const [showDisburseModal, setShowDisburseModal] = useState(false);
      const [showRejectModal, setShowRejectModal] = useState(false);
      const [showItemDetailModal, setShowItemDetailModal] = useState(false);
      const [showPOPreviewModal, setShowPOPreviewModal] = useState(false);
      const [showSelectionModal, setShowSelectionModal] = useState(false);
      const [expandedItems, setExpandedItems] = useState(new Set());
      const [isForceClose, setIsForceClose] = useState(false);
const [isCostEditMode, setIsCostEditMode] = useState(false);
      const [tempCostRequest, setTempCostRequest] = useState(null);

      // --- STATE: Who can act modal ---
const [showActorModal, setShowActorModal] = useState(false);
const [actorList, setActorList] = useState({ title: '', status: '', users: [] });

// --- Helper: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ---
const handleShowActors = (req) => {
    let permId = null;
    let title = '‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    switch (req.status) {
        case 'Pending Head': permId = 8; title = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 1'; break;
        case 'Pending PM': permId = 9; title = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 2'; break;
        case 'Pending Check': permId = 10; title = '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'; break;
        case 'Approved': 
            if (req.type === 'Local') { permId = 12; title = '‡∏£‡∏≠‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Local)'; }
            else if (req.type === 'HO' && req.purchaseType === 'Buy') { permId = 11; title = '‡∏£‡∏≠‡∏≠‡∏≠‡∏Å PR'; }
            else { permId = 14; title = '‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤/‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'; } // HO Rent
            break;
        case 'PR Issued': permId = 12; title = '‡∏£‡∏≠‡∏≠‡∏≠‡∏Å PO'; break;
        case 'PO Issued': permId = 13; title = '‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á'; break;
        case 'Ordered': permId = 15; title = '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (Local)'; break;
        case 'Shipping': permId = 15; title = '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (HO)'; break;
        case 'Ready to Disburse': permId = 24; title = '‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á (Store)'; break;
        case 'Contract Pending': permId = 14; title = '‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤'; break;
        case 'Contract Signed': permId = 13; title = '‡∏£‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö'; break;
        default: 
            showToast('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠ (‡∏à‡∏ö‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£/‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)', 'info');
            return;
    }

const validUsers = allUsers.filter(u => {
        if (u.status !== 'Activated') return false;
        
        // if (u.isSuperAdmin) return true; // ‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏ä‡∏ß‡πå

        const perms = u.permissions?.[req.job] || [];
        
        // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏±‡∏î conditions ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ Admin (2) ‡∏≠‡∏≠‡∏Å
        // ‡πÄ‡∏î‡∏¥‡∏°: return perms.includes(2) || perms.includes(permId);
        
        // ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        return perms.includes(permId); 
    });


    setActorList({
        title: title,
        status: req.status,
        users: validUsers
    });
    setShowActorModal(true);
};

// --- Helper: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Updated: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå) ---
    const getActorData = (req, allUsers) => {
        let permIds = []; // ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
        let title = '';

        switch (req.status) {
            case 'Pending Head': 
                title = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 1'; 
                // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏° ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡πâ‡∏á L1(8) ‡πÅ‡∏•‡∏∞ L2(9) ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                if (req.type === 'Withdraw' || req.type === 'Borrow') {
                    permIds = [8, 9]; 
                } else {
                    permIds = [8];
                }
                break;
            case 'Pending PM': 
                title = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 2'; 
                permIds = [9]; 
                break;
            case 'Pending Check': 
                title = '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'; 
                permIds = [10]; 
                break;
            case 'Approved': 
                if (req.type === 'Local') { permIds = [12]; title = '‡∏£‡∏≠‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Local)'; }
                else if (req.type === 'HO' && req.purchaseType === 'Buy') { permIds = [11]; title = '‡∏£‡∏≠‡∏≠‡∏≠‡∏Å PR'; }
                else { permIds = [14, 13]; title = '‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤/‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'; } // ‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤(14) ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á(13) ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
                break;
            case 'PR Issued': permIds = [12]; title = '‡∏£‡∏≠‡∏≠‡∏≠‡∏Å PO'; break;
            case 'PO Issued': permIds = [13]; title = '‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á'; break;
            case 'Ordered': permIds = [15]; title = '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (Local)'; break;
            case 'Shipping': permIds = [15]; title = '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (HO)'; break;
            case 'Ready to Disburse': permIds = [24]; title = '‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á (Store)'; break;
            case 'Contract Pending': permIds = [14]; title = '‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤'; break;
            case 'Contract Signed': permIds = [13]; title = '‡∏£‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö'; break;
            default: return null;
        }

const validUsers = allUsers.filter(u => {
        if (u.status !== 'Activated') return false;
        
        // ‚ùå ‡∏ï‡∏±‡∏î Super Admin ‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á)
        // if (u.isSuperAdmin) return true; 

        const perms = u.permissions?.[req.job] || [];
        
        // ‚≠ê ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin (2) ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
        // const isProjectAdmin = perms.includes(2); <--- ‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const hasSpecificRight = permIds.some(id => perms.includes(id));

        return hasSpecificRight; 
    });

    return { title, users: validUsers };
};

    // --- Component: Tooltip ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ---
    const StatusWithTooltip = ({ request, allUsers, children }) => {
        const [isVisible, setIsVisible] = useState(false);
        const [isLocked, setIsLocked] = useState(false); // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
        const [actorData, setActorData] = useState(null);

        useEffect(() => {
            if (isVisible || isLocked) {
                setActorData(getActorData(request, allUsers));
            }
        }, [isVisible, isLocked, request, allUsers]);

        return (
            <div 
                className="relative inline-block"
                onMouseEnter={() => setIsVisible(true)}
                onMouseLeave={() => !isLocked && setIsVisible(false)}
            >
                {/* ‡∏ï‡∏±‡∏ß Badge ‡πÄ‡∏î‡∏¥‡∏° */}
                <div 
                    onClick={(e) => {
                        e.stopPropagation(); // ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        setIsLocked(!isLocked); // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πá‡∏≠‡∏Ñ
                    }}
                    className="cursor-pointer"
                >
                    {children}
                </div>

                {/* ‡∏™‡πà‡∏ß‡∏ô Tooltip Popup */}
                {(isVisible || isLocked) && actorData && actorData.users.length > 0 && (
                    <div className="absolute right-0 top-full mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-200 z-50 animate-in fade-in slide-in-from-top-2 overflow-hidden">
                        {/* ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ */}
                        <div className="bg-slate-50 px-3 py-2 border-b border-gray-100 flex justify-between items-center">
                            <div>
                                <p className="text-[10px] font-bold text-gray-500">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                                <p className="text-xs font-bold text-blue-700">{actorData.title}</p>
                            </div>
                            {isLocked && <span className="text-[9px] bg-red-100 text-red-600 px-1.5 rounded border border-red-200">Pin</span>}
                        </div>
                        
                        {/* ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ */}
                        <div className="max-h-48 overflow-y-auto p-1 custom-scrollbar">
                            {actorData.users.map((u, i) => (
                                <div key={i} className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded transition-colors">
                                    <div className="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-[10px] font-bold text-gray-600">
                                        {u.firstName?.charAt(0)}
                                    </div>
                                    <div className="overflow-hidden">
                                        <p className="text-xs font-bold text-gray-800 truncate">{u.firstName} {u.lastName}</p>
                                        <p className="text-[9px] text-gray-400">{u.empId} {u.role === 'Admin' ? '(Admin)' : ''}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        );
    };

      const [expandedChart, setExpandedChart] = useState(null);
      const [drillDownState, setDrillDownState] = useState({ SubJob: null, matCode: null });
      
      // Verification Modal State
      const [showVerificationModal, setShowVerificationModal] = useState(false);
const [verificationData, setVerificationData] = useState({
    requestId: null,
    checks: { quotation: true, email: true, details: true },
    filesExist: { quotation: false, email: false },
    needApproval: false,
    needContract: true,
    note: '',
    isChangeMode: false // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ
});
      const [viewingItem, setViewingItem] = useState(null);
      const [previewImage, setPreviewImage] = useState(null); 

      // Inventory/Asset Management Modals
      const [showAddInvModal, setShowAddInvModal] = useState(false);
      const [showEditInvModal, setShowEditInvModal] = useState(false);
      const [showAssetModal, setShowAssetModal] = useState(false);
      const [showEditAssetModal, setShowEditAssetModal] = useState(false);
      const [showReturnAssetModal, setShowReturnAssetModal] = useState(false);
      const [editingStockItem, setEditingStockItem] = useState(null);
      const [editingAssetItem, setEditingAssetItem] = useState(null);
      const [returnAssetData, setReturnAssetData] = useState({ id: '', condition: 'Good', note: '', images: [] });
      const [disburseData, setDisburseData] = useState({ requestId: null, note: '', images: [] });
      const [rejectData, setRejectData] = useState({ requestId: null, reason: '' });
      const [newStockItem, setNewStockItem] = useState({ name: '', qty: 0, unit: '‡∏ä‡∏¥‡πâ‡∏ô', minStock: 0, price: 0, images: [] });
      // --- STATE: Asset Management (Updated) ---
      const [newAssetItem, setNewAssetItem] = useState({ 
          id: '', 
          isAutoId: false, 
          name: '', 
          serial: '', 
          status: 'Available', 
          condition: 'Good', 
          ownerType: '', // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
          price: 0, 
          rentalPrice: 0, 
          rentalUnit: 'Month', 
          images: [] 
      });
      
      // Form Data
      const [selectedRequest, setSelectedRequest] = useState(null);
      // --- STATE: Bulk Selection ---
const [selectedOrderIds, setSelectedOrderIds] = useState([]);

// Helper: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ User ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
const canUserManageRequest = (req) => {
    // 1. Level 1 (Head)
    if (req.status === 'Pending Head') {
        // ‡∏á‡∏≤‡∏ô‡∏ã‡∏∑‡πâ‡∏≠: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå L1(8)
        if (['Local', 'HO'].includes(req.type) && hasPermission(8)) return true;
        // ‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏°: ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå L1(8) ‡∏´‡∏£‡∏∑‡∏≠ L2(9) ‡∏Å‡πá‡πÑ‡∏î‡πâ
        if (['Withdraw', 'Borrow'].includes(req.type) && (hasPermission(8) || hasPermission(9))) return true;
    }
    // 2. Level 2 (PM)
    if (req.status === 'Pending PM' && hasPermission(9)) return true;
    
    return false;
};

// Helper: Toggle Selection
const toggleSelectOrder = (id) => {
    setSelectedOrderIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
};

// Function: ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
const handleBulkAction = async (actionType) => {
    if (selectedOrderIds.length === 0) return;
    
    // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Request ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const targets = requests.filter(r => selectedOrderIds.includes(r.id));
    
    if (actionType === 'Reject') {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ‡∏ñ‡∏≤‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        const reason = prompt(`‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${targets.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:`, "");
        if (reason === null) return; // ‡∏Å‡∏î Cancel
        if (!reason) { showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•", "error"); return; }

        setIsLoading(true);
        try {
            for (const req of targets) {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                await handleUpdateStatus(req.id, 'Rejected', `[Bulk Reject] ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${reason}`);
            }
            setSelectedOrderIds([]); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            showToast(`‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${targets.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        } catch (err) {
            console.error(err);
            showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "error");
        } finally {
            setIsLoading(false);
        }
    } 
    else if (actionType === 'Approve') {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÉ‡∏ö‡πÄ‡∏≠‡∏á
        if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${targets.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) return;

        setIsLoading(true);
        try {
            for (const req of targets) {
                let nextStatus = '';
                
                // Logic ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß)
                if (req.status === 'Pending Head') {
                    if (req.type === 'Withdraw' || req.type === 'Borrow') nextStatus = 'Ready to Disburse';
                    else nextStatus = 'Pending PM';
                } 
                else if (req.status === 'Pending PM') {
                    nextStatus = 'Approved';
                }

                if (nextStatus) {
                    await handleUpdateStatus(req.id, nextStatus, `[Bulk Approve] ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢ ${user.firstName}`);
                }
            }
            setSelectedOrderIds([]); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            showToast(`‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${targets.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        } catch (err) {
            console.error(err);
            showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "error");
        } finally {
            setIsLoading(false);
        }
    }
};
      const [receiveItems, setReceiveItems] = useState([]);
      const [editingId, setEditingId] = useState(null);
      const [newOrderMeta, setNewOrderMeta] = useState({ type: 'Local', purchaseType: 'Buy', withdrawStockType: 'System', job: '', dateRequired: '', priority: 'Normal', attachment: null, quotation: null });
      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
const [tempItem, setTempItem] = useState({ name: '', qty: 1, unitPrice: 0, unit: '‡∏ä‡∏¥‡πâ‡∏ô', subJob: '', matCode: '', note: '', images: [], assetId: '', serial: '', duration: 1 });



      const [orderItems, setOrderItems] = useState([]);
      
      const [showSuggestions, setShowSuggestions] = useState(false);
      const [suggestions, setSuggestions] = useState([]);
      const [stockSuggestion, setStockSuggestion] = useState(null);
      const [foundSuggestions, setFoundSuggestions] = useState([]);
      const [selectionSearch, setSelectionSearch] = useState('');

      const [prData, setPrData] = useState({ requestId: null, file: null, prNumber: '' });
      const [poData, setPoData] = useState({ requestId: null, file: null, poNumber: '' });
      const [showContractModal, setShowContractModal] = useState(false);
const [contractData, setContractData] = useState({ requestId: null, file: null });

const [historySort, setHistorySort] = useState({ key: 'date', direction: 'desc' });
      const [historyActionFilter, setHistoryActionFilter] = useState('All');

      // --- HELPER: Parse Thai Date String to Date Object ---
      const parseThaiDate = (dateStr) => {
          if (!dateStr) return null;
          // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ format "10/1/2567 14:30:00" ‡∏´‡∏£‡∏∑‡∏≠ "10/1/2567"
          try {
              const parts = dateStr.split(' ')[0].split('/');
              if (parts.length === 3) {
                  const day = parseInt(parts[0]);
                  const month = parseInt(parts[1]) - 1;
                  const year = parseInt(parts[2]) - 543; // ‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏®. -> ‡∏Ñ.‡∏®.
                  return new Date(year, month, day);
              }
          } catch (e) { return null; }
          return null;
      };


const handleSaveAnnouncement = () => {
          if(!announceForm.title || !announceForm.detail) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', 'error'); return; }
          setIsLoading(true);
          
          const payload = {
              id: 'ANNOUNCEMENT',
              active: true,
              title: announceForm.title,
              detail: announceForm.detail,
              date: new Date().toLocaleString('th-TH'),
              updatedBy: user ? `${user.firstName} ${user.lastName}` : 'System'
          };

          google.script.run.withSuccessHandler((res) => {
              setIsLoading(false);
              setAnnouncement(payload);
              showToast(res.message);
          }).saveSystemAnnouncement(payload);
      };

      // ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (Admin)
      const handleClearAnnouncement = () => {
          if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
          setIsLoading(true);
          google.script.run.withSuccessHandler((res) => {
              setIsLoading(false);
              setAnnouncement(null);
              setAnnounceForm({ title: '', detail: '' });
              showToast(res.message);
          }).clearSystemAnnouncement();
      };

const handleStartCostEdit = () => {
          const clone = JSON.parse(JSON.stringify(selectedRequest));
          
          // 1. ‡∏î‡∏∂‡∏á Asset ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á Request ‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ
          const reqAssets = assets.filter(a => a.currentRequestId === selectedRequest.id);
          const tempAssets = JSON.parse(JSON.stringify(reqAssets));

          // 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà Item ‡∏Å‡∏±‡∏ö Asset ‡πÅ‡∏•‡∏∞‡∏ù‡∏±‡∏á _tempItemId ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ
          clone.items = clone.items.map((item, idx) => {
              // ‡∏´‡∏≤ Asset ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Item ‡∏ô‡∏µ‡πâ (‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠+‡∏£‡∏≤‡∏Ñ‡∏≤)
              tempAssets.forEach(a => {
                  if (a.name === item.name &&
                     (a.price === item.unitPrice || a.rentalPrice === item.unitPrice) &&
                     a._tempItemId === undefined // ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
                  ) {
                      a._tempItemId = idx; // ‚≠ê ‡∏ù‡∏±‡∏á index ‡∏Ç‡∏≠‡∏á item ‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô asset
                  }
              });
              return item; 
          });
          
          clone.tempAssets = tempAssets; // ‡πÄ‡∏Å‡πá‡∏ö Asset ‡∏ó‡∏µ‡πà‡∏ù‡∏±‡∏á ID ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
          setTempCostRequest(clone);
          setIsCostEditMode(true);
      };

      const handleCancelCostEdit = () => {
          setTempCostRequest(null);
          setIsCostEditMode(false);
      };

const handleSaveCostEdit = async () => {
    if (!tempCostRequest) return;
    setIsLoading(true);
    try {
        const changes = [];
        const oldReq = selectedRequest;
        const newReq = tempCostRequest;
        const userSignature = `${user.empId} ${user.firstName} ${user.lastName}`;

        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á Request (SubJob, MatCode, Unit, Qty, Inventory Logs)
        newReq.items.forEach((newItem, idx) => {
            const oldItem = oldReq.items[idx];
            
            if (newItem.subJob !== oldItem.subJob) changes.push(`${newItem.name}: SubJob (${oldItem.subJob || '-'} -> ${newItem.subJob})`);
            if (newItem.matCode !== oldItem.matCode) changes.push(`${newItem.name}: Mat. (${oldItem.matCode || '-'} -> ${newItem.matCode})`);
            if (newItem.unit !== oldItem.unit) changes.push(`${newItem.name}: Unit (${oldItem.unit} -> ${newItem.unit})`);

            // ‚≠ê [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Qty)
            if (newItem.qty !== oldItem.qty) {
                const receivedCount = oldItem.receivedTotal || 0;
                // Validation: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                if (newItem.qty < receivedCount) {
                    throw new Error(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${newItem.name}" ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${receivedCount} ‡∏ä‡∏¥‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ`);
                }
                changes.push(`${newItem.name}: Qty (${oldItem.qty} -> ${newItem.qty})`);
            }

            // Check Inventory Logs (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡∏•‡∏∞ Lot)
            if (newItem.receivedLog && newItem.receivedLog.length > 0) {
                newItem.receivedLog.forEach((newLog, logIdx) => {
                    const oldLog = oldItem.receivedLog?.[logIdx];
                    if (oldLog && newLog.price !== oldLog.price) {
                        changes.push(`${newItem.name} (Lot ${logIdx + 1}): Price (${oldLog.price.toLocaleString()} -> ${newLog.price.toLocaleString()})`);
                    }
                });
            }
        });

        // 2. ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á Assets (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
        if (newReq.tempAssets && newReq.tempAssets.length > 0) {
            for (const newAsset of newReq.tempAssets) {
                const oldAsset = assets.find(a => a.id === newAsset.id);
                if (!oldAsset) continue;

                let assetChanged = false;
                let assetChanges = [];

                // Check Price (Buy/Rent)
                if (newAsset.price !== oldAsset.price) { assetChanges.push(`Price: ${oldAsset.price} -> ${newAsset.price}`); assetChanged = true; }
                if (newAsset.rentalPrice !== oldAsset.rentalPrice) { assetChanges.push(`Rent Price: ${oldAsset.rentalPrice} -> ${newAsset.rentalPrice}`); assetChanged = true; }
                // Check Duration & Unit
                if (newAsset.duration !== oldAsset.duration) { assetChanges.push(`Duration: ${oldAsset.duration} -> ${newAsset.duration}`); assetChanged = true; }
                if (newAsset.rentalUnit !== oldAsset.rentalUnit) { assetChanges.push(`Unit: ${oldAsset.rentalUnit} -> ${newAsset.rentalUnit}`); assetChanged = true; }

                if (assetChanged) {
                    // Sync Asset to Server
                    await saveAssetToSheet(newAsset); 
                    // Update Global State
                    setAssets(prev => prev.map(a => a.id === newAsset.id ? newAsset : a));
                    
                    changes.push(`${newAsset.id}: ${assetChanges.join(', ')}`);
                    // Log for Asset
                    await addInvLog('Edit Asset Cost', newAsset.name, 'Edit', `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Cost/Term: ${assetChanges.join(', ')}`, [], selectedRequest.id, newAsset.id);
                }
            }
        }

        if (changes.length === 0) {
            showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á', 'info');
            setIsCostEditMode(false);
            setIsLoading(false);
            return;
        }

        // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Request ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        const logNote = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Cost/Qty/Code/Assets:\n- ${changes.join('\n- ')}`;
        const { tempAssets, ...reqToSave } = newReq; // ‡πÄ‡∏≠‡∏≤ tempAssets ‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Request
        
        const updatedReq = {
            ...reqToSave,
            history: [...newReq.history, createLog('Edit Cost/Qty', userSignature, logNote)]
        };
        
        saveRequestToSheet(updatedReq); // Sync Request
        setRequests(prev => prev.map(r => r.id === updatedReq.id ? updatedReq : r));
        setSelectedRequest(updatedReq);
        
        setIsCostEditMode(false);
        setTempCostRequest(null);
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

    } catch (err) {
        console.error(err);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
    } finally {
        setIsLoading(false);
    }
};

// --- LOGIC: IMPORT ASSETS (CSV) - SMART PARSER ---
const handleFileImport = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    setImportFileName(file.name);
    const reader = new FileReader();
    
    reader.onload = (event) => {
        const text = event.target.result;
        // ‚úÖ ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
        const rows = text.split(/\r?\n/).map(row => parseCSVLine(row));
        
        // --- Helper Functions ---
        // 1. ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Type)
        const mapType = (val) => {
            if (!val) return 'Company';
            const v = val.trim();
            if (v === '‡πÄ‡∏ä‡πà‡∏≤' || v.toLowerCase() === 'rent') return 'Rent';
            return 'Company'; // Default '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó'
        };

        // 2. ‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status)
        const mapStatus = (val) => {
            if (!val) return 'Available';
            const v = val.trim();
            if (v === '‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°' || v.toLowerCase() === 'borrowed') return 'Borrowed';
            if (v === '‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢' || v.toLowerCase() === 'lost') return 'Lost';
            if (v === '‡∏ä‡∏≥‡∏£‡∏∏‡∏î' || v.toLowerCase() === 'damaged') return 'Damaged';
            return 'Available'; // Default '‡∏ß‡πà‡∏≤‡∏á'
        };

        // 3. ‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö (Unit)
        const mapUnit = (u, type) => {
            if (!u) return type === 'Rent' ? 'Month' : 'baht';
            const val = u.trim();
            if (val.includes('‡∏ß‡∏±‡∏ô') || val.toLowerCase().includes('day')) return 'Day';
            if (val.includes('‡∏õ‡∏µ') || val.toLowerCase().includes('year')) return 'Year';
            if (val.includes('‡πÄ‡∏î‡∏∑‡∏≠‡∏ô') || val.toLowerCase().includes('month')) return 'Month';
            return 'baht';
        };

        // ‚≠ê 4. ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Format Date) - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
        const formatDate = (d) => {
            if (!d) return null;
            const val = d.trim();
            if (val === '') return null;
            if (val.match(/^\d{4}-\d{2}-\d{2}$/)) return val; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
            if (val.includes('/')) { 
                const parts = val.split('/');
                if (parts.length === 3) {
                    let [day, month, year] = parts;
                    let y = parseInt(year);
                    if (y > 2400) y -= 543; // ‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®.
                    return `${y}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
                }
            }
            return val;
        };

        // --- Process Data ---
        const data = rows.slice(1).filter(row => row.length > 1 && row[1]?.trim() !== '').map((row, index) => {
            const type = mapType(row[3]);
            const status = mapStatus(row[8]);
            
            return {
                tempId: index,
                id: row[0]?.trim() || '',           
                name: row[1]?.trim() || '',         
                serial: row[2]?.trim() || '',       
                ownerType: type,
                price: parseFloat(row[4]?.trim()) || 0, 
                rentalUnit: mapUnit(row[5], type),   
                rentalStart: formatDate(row[6]),  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ formatDate ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                rentalEnd: formatDate(row[7]),    // ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                status: status, 
                holder: row[9]?.trim() || '-',      
                note: row[10]?.trim() || '',
                project: row[11]?.trim() || '',
                supplier: row[12]?.trim() || ''
            };
        });
        
        setImportData(data);
    };
    reader.readAsText(file);
};

// --- LOGIC: CONFIRM IMPORT ASSETS (BATCH + CHUNKING VERSION) ---
const confirmImportAssets = async () => {
    if (importData.length === 0) return;

    // 1. Validation Loop (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    for (let i = 0; i < importData.length; i++) {
        const item = importData[i];
        const line = i + 1;

        if (!item.name) { showToast(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${line}: ‡∏Ç‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'error'); return; }
        if (!item.serial) { showToast(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${line}: ‡∏Ç‡∏≤‡∏î Serial No.`, 'error'); return; }
        // ... (Validation ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ ID ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        if (item.id && assets.some(a => a.id === item.id)) {
            showToast(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${line}: ‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô "${item.id}" ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß`, 'error'); return;
        }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    setIsLoading(true); // ‡∏´‡∏°‡∏∏‡∏ô Loading
    const date = new Date().toLocaleString('th-TH');
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Batch
    const newAssets = [];
    const batchLogs = [];
    let currentRunNo = assets.length; 
    
    // 2. Process Data (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏™‡πà Array ‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô)
    for (const item of importData) {
        let finalId = item.id;
        
        // Auto Gen ID Logic
        if (!finalId) {
            currentRunNo++;
            const prefix = item.ownerType === 'Rent' ? 'AST-R' : 'AST-C';
            const runNo = String(currentRunNo).padStart(3, '0');
            finalId = `${prefix}-${new Date().getFullYear().toString().slice(-2)}${(new Date().getMonth()+1).toString().padStart(2,'0')}-${runNo}`;
            
            while (assets.some(a => a.id === finalId) || newAssets.some(a => a.id === finalId)) {
                currentRunNo++;
                const nextRunNo = String(currentRunNo).padStart(3, '0');
                finalId = `${prefix}-${new Date().getFullYear().toString().slice(-2)}${(new Date().getMonth()+1).toString().padStart(2,'0')}-${nextRunNo}`;
            }
        }

        const newAsset = {
            id: finalId,
            name: item.name,
            serial: item.serial,
            ownerType: item.ownerType,
            status: item.status,
            price: item.ownerType === 'Company' ? item.price : 0,
            rentalPrice: item.ownerType === 'Rent' ? item.price : 0,
            rentalUnit: item.rentalUnit, 
            rentalStart: item.rentalStart || null,
            rentalEnd: item.rentalEnd || null,
            condition: 'Good',
            holder: item.holder,
            currentRequestId: null,
            lastUpdated: date,
            image: null,
            note: item.note,
            supplier: item.supplier || '',
            project: item.project 
        };

        newAssets.push(newAsset);
        
       const logNote = `‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: ${item.project}` + (item.note ? ` | ${item.note}` : '') + (item.supplier ? ` | ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ${item.supplier}` : '');
        batchLogs.push({
            date: date,
            action: 'Import Assets',
            item: newAsset.name,
            change: 'New',
            note: logNote,
            images: [],
            requestId: null,
            supplier: item.supplier,
            assetId: newAsset.id,
            by: `${user.empId} ${user.firstName}`
        });
    }

    // ‚≠ê‚≠ê 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÅ‡∏ö‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô (Chunking Logic) ‚≠ê‚≠ê
    const CHUNK_SIZE = 100; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏•‡∏∞ 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    const totalChunks = Math.ceil(newAssets.length / CHUNK_SIZE);

    try {
        for (let i = 0; i < newAssets.length; i += CHUNK_SIZE) {
            // ‡∏ï‡∏±‡∏î‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const chunkAssets = newAssets.slice(i, i + CHUNK_SIZE);
            const chunkLogs = batchLogs.slice(i, i + CHUNK_SIZE);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡∏Ç‡∏ä‡∏∏‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            const currentChunk = Math.floor(i / CHUNK_SIZE) + 1;
            
            // (Optional) ‡πÅ‡∏™‡∏î‡∏á Toast ‡∏ö‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ User ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡πâ‡∏≤‡∏á
            showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${currentChunk}/${totalChunks} (${chunkAssets.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)...`, 'info');

            // ‡∏™‡πà‡∏á‡∏Å‡πâ‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler((err) => reject(new Error(`Batch ${currentChunk} failed: ${err.message}`)))
                    .batchImportAssets(chunkAssets, chunkLogs); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô backend ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà
            });
        }

        // 4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Å‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        setAssets(prev => [...prev, ...newAssets]);
        
        setIsLoading(false);
        setShowImportAssetModal(false);
        setImportData([]);
        setImportFileName('');
        showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${newAssets.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

    } catch (error) {
        setIsLoading(false);
        console.error(error);
        showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + error.message, 'error');
        // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏£‡∏ì‡∏µ Error ‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏±‡∏ô ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (Partial Success)
    }
};


// --- LOGIC: EXPORT INVENTORY CSV (UPDATED) ---
const handleExportInventory = () => {
    let dataToExport = [];

    // 1. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Tab "Summary" ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö -> ‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö)
    if (invTabMode === 'Summary') {
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (Raw Data) ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        let baseData = [...inventory];

        // ‡∏Å‡∏£‡∏≠‡∏á Global Project
        if (globalProjectFilter !== 'All') {
            baseData = baseData.filter(i => i.project === globalProjectFilter);
        }
        // ‡∏Å‡∏£‡∏≠‡∏á Search
        if (invSearch) {
            const lower = invSearch.toLowerCase();
            baseData = baseData.filter(i => 
                i.name.toLowerCase().includes(lower) || 
                i.id.toLowerCase().includes(lower) ||
                (i.project && i.project.toLowerCase().includes(lower))
            );
        }
        // ‡∏Å‡∏£‡∏≠‡∏á Inventory Project Filter (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (inventoryProjectFilter !== 'All') {
            baseData = baseData.filter(i => i.project === inventoryProjectFilter);
        }

        // ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô (System -> NonSystem)
        const systemItems = baseData.filter(i => (i.stockType || 'System') === 'System');
        const nonSystemItems = baseData.filter(i => i.stockType === 'NonSystem');
        
        dataToExport = [...systemItems, ...nonSystemItems];

    } else {
        // 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Tab ‡∏≠‡∏∑‡πà‡∏ô (System/NonSystem) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
        dataToExport = filteredInventory;
    }

    if (dataToExport.length === 0) {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export', 'error');
        return;
    }

    // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á CSV ---
    const headers = ["‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏,‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô,‡∏´‡∏ô‡πà‡∏ß‡∏¢,‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥,‡∏£‡∏≤‡∏Ñ‡∏≤,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏,‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"];

    const rows = dataToExport.map(item => {
        const type = item.stockType === 'NonSystem' ? '‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö' : '‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
        const cleanId = getDisplayId(item.id); 
        
        const safe = (str) => `"${(str || '').toString().replace(/"/g, '""')}"`;

        return [
            safe(cleanId),
            safe(item.name),
            safe(type),
            item.qty,
            safe(item.unit),
            item.minStock || 0,
            item.price || 0,
            safe(item.note),
            safe(item.project)
        ].join(',');
    });

    const csvContent = "\uFEFF" + headers.concat(rows).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    const dateStr = new Date().toISOString().split('T')[0];
    const typeLabel = invTabMode === 'Summary' ? 'All_Sorted' : invTabMode;
    link.setAttribute("download", `Inventory_Export_${typeLabel}_${dateStr}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

// --- LOGIC: EXPORT ASSETS CSV (UPDATED) ---
const handleExportAssets = () => {
    let dataToExport = [];

    // 1. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Tab "Summary" ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà (Company -> Rent)
    if (assetTabMode === 'Summary') {
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (Raw Data)
        let baseData = [...assets];

        if (globalProjectFilter !== 'All') { 
            baseData = baseData.filter(a => a.project === globalProjectFilter); 
        }
        if (assetSearch) {
            const lower = assetSearch.toLowerCase();
            baseData = baseData.filter(a => 
                a.name.toLowerCase().includes(lower) || 
                a.id.toLowerCase().includes(lower) || 
                (a.holder && a.holder.toLowerCase().includes(lower)) || 
                (a.project && a.project.toLowerCase().includes(lower))
            );
        }
        if (assetProjectFilter !== 'All') { 
            baseData = baseData.filter(a => a.project === assetProjectFilter); 
        }

        // ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô (Company -> Rent)
        const companyItems = baseData.filter(a => a.ownerType === 'Company');
        const rentItems = baseData.filter(a => a.ownerType === 'Rent');

        dataToExport = [...companyItems, ...rentItems];

    } else {
        // 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Tab ‡∏≠‡∏∑‡πà‡∏ô (Company/Rent) ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
        dataToExport = filteredAssets;
    }

    if (dataToExport.length === 0) {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export', 'error');
        return;
    }

    // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á CSV ---
    const headers = ["‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô,‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡∏ô‡∏±‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,‡∏£‡∏≤‡∏Ñ‡∏≤,‡∏´‡∏ô‡πà‡∏ß‡∏¢,‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤,‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞,‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏,‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"];

    const rows = dataToExport.map(item => {
        const type = item.ownerType === 'Rent' ? '‡πÄ‡∏ä‡πà‡∏≤' : '‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏î'; // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à
        
        const statusMap = {
            'Available': '‡∏ß‡πà‡∏≤‡∏á',
            'Borrowed': '‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°',
            'Lost': '‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢',
            'Damaged': '‡∏ä‡∏≥‡∏£‡∏∏‡∏î'
        };
        const statusTh = statusMap[item.status] || item.status;
        
        const price = item.ownerType === 'Rent' ? (item.rentalPrice || 0) : (item.price || 0);
        const unit = item.ownerType === 'Rent' ? (item.rentalUnit || 'Month') : '‡∏ö‡∏≤‡∏ó';

        const safe = (str) => `"${(str || '').toString().replace(/"/g, '""')}"`;

        return [
            safe(item.id),
            safe(item.name),
            safe(item.serial),
            safe(type),
            price,
            safe(unit),
            safe(item.rentalStart),
            safe(item.rentalEnd),
            safe(statusTh),
            safe(item.holder),
            safe(item.note),
            safe(item.project)
        ].join(',');
    });

    const csvContent = "\uFEFF" + headers.concat(rows).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    const dateStr = new Date().toISOString().split('T')[0];
    const typeLabel = assetTabMode === 'Summary' ? 'All_Sorted' : assetTabMode;
    link.setAttribute("download", `Assets_Export_${typeLabel}_${dateStr}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

// ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sidebar)
      const pendingOrdersCount = useMemo(() => {
         if (!filteredRequests) return 0;
         return filteredRequests.filter(r => !['Completed', 'Rejected', 'Returned', 'Draft'].includes(r.status)).length;
      }, [filteredRequests]);



const filteredLogs = useMemo(() => {
    let data = invLogs;

    // 0. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏ß‡∏° (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á Item) ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á User/Permission ‡∏≠‡∏≠‡∏Å
    if (!viewingItem) {
        const excludeActions = ['Edit Permissions', 'Edit Profile', 'Edit User Status', 'Register', 'Change Password'];
        data = data.filter(l => !excludeActions.includes(l.action));
    }

   if (globalProjectFilter !== 'All') { // ‚≠ê ‡∏ï‡∏±‡∏î !viewingItem ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏°‡∏≠
        data = data.filter(l => 
            (l.note && l.note.includes(globalProjectFilter)) || 
            (l.project && l.project === globalProjectFilter)
        );
    }

    // 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Item (Viewing Detail)
    if (viewingItem) {
         if (viewingItem.isSummary) {
             // ... (Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Summary ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏Å‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß) ...
             data = data.filter(l => {
                 const nameMatch = l.item === viewingItem.name;
                 const idMatch = viewingItem.combinedIds && viewingItem.combinedIds.includes(l.assetId);
                 const summaryIdMatch = l.assetId === viewingItem.id;
                 return nameMatch || idMatch || summaryIdMatch;
             });
         } else {
             // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Item ‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß (System/NonSystem/Asset)
             const isAssetView = viewingItem.serial !== undefined;
             data = data.filter(l => {
                 // 1. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ID ‡πÉ‡∏ô Log ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô -> ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô (Priority ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
                 if (l.assetId === viewingItem.id) return true;

                 // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ID ‡πÉ‡∏ô Log -> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ Project ‡∏î‡πâ‡∏ß‡∏¢!
                 if (!l.assetId && l.item === viewingItem.name) {
                     
                     // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö !isAssetView ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Asset ‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ Project ‡∏î‡πâ‡∏ß‡∏¢
                     // ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°: if (!isAssetView && viewingItem.project) {
                     // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô:
                     if (viewingItem.project) {
                         const logProj = l.project;
                         const logNote = l.note || '';
                         
                         // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Project ‡πÉ‡∏ô Log ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠ Project ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÉ‡∏ô Note
                         const isProjectMatch = (logProj && logProj === viewingItem.project) || 
                                                (!logProj && logNote.includes(viewingItem.project));
                         
                         // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ô‡∏•‡∏∞ Project -> ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤
                         if (!isProjectMatch) return false;
                     }

                     const assetOnlyActions = ['Import Assets', 'Add Asset', 'Register Asset', 'Return Asset', 'Restore Asset', 'Delete Asset', 'Snooze Alert', 'Disable Alert', 'Enable Alert', 'Update Image'];
                     const isLogForAsset = assetOnlyActions.includes(l.action) || (l.action === 'Borrow' && isAssetView) || (l.action === 'Return' && isAssetView);
                     return isAssetView ? isLogForAsset : !isLogForAsset;
                 }
                 return false;
             });
         }
    }

   if (historySearch) {
    const lower = historySearch.toLowerCase();
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô l ‡πÄ‡∏õ‡πá‡∏ô log ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üëá
    data = data.filter(log => 
        log.action.toLowerCase().includes(lower) ||
        log.item.toLowerCase().includes(lower) ||
        log.by.toLowerCase().includes(lower) ||
        log.note.toLowerCase().includes(lower) ||
        (log.relatedRequestId && log.relatedRequestId.toLowerCase().includes(lower))
    );
}

    // 4. Filter Action
    if (historyActionFilter !== 'All') {
        data = data.filter(l => l.action === historyActionFilter);
    }
    
    // 5. Sort Logic
    const parseLogDate = (dStr) => {
        if (!dStr) return 0;
        try {
            const [datePart, timePart] = dStr.split(' ');
            if (!datePart) return 0;
            const [day, month, year] = datePart.split('/').map(Number);
            const [hour, min, sec] = timePart ? timePart.split(':').map(Number) : [0, 0, 0];
            const adYear = year > 2400 ? year - 543 : year;
            return new Date(adYear, month - 1, day, hour, min, sec).getTime();
        } catch (e) { return 0; }
    };

    return [...data].sort((a, b) => {
        if (historySort.key === 'date') {
            const timeA = parseLogDate(a.date);
            const timeB = parseLogDate(b.date);
            return historySort.direction === 'asc' ? timeA - timeB : timeB - timeA;
        } else {
            const valA = (a[historySort.key] || '').toString().toLowerCase();
            const valB = (b[historySort.key] || '').toString().toLowerCase();
            if (valA < valB) return historySort.direction === 'asc' ? -1 : 1;
            if (valA > valB) return historySort.direction === 'asc' ? 1 : -1;
            return 0;
        }
    });

}, [invLogs, viewingItem, historySearch, historyActionFilter, historySort, globalProjectFilter]);


      // --- Helper Validation Logic ---

      // --- Helpers ---
      const showToast = (message, type = 'success') => {
        setNotification({ message, type });
        setTimeout(() => setNotification(null), 3000);
      };
        const fileToBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = (error) => reject(error);
    });
  };

 // --- LOGIC: HISTORY & LOGS (UPDATED WITH REFERENCE) ---


const addInvLog = async (action, item, change, note = '', images = [], relatedRequestId = null, assetId = null, extraData = {}) => {
  const log = {
    date: new Date().toLocaleString('th-TH'),
    action,
    item,
    change,
    by: user ? `${user.empId} ${user.firstName} ${user.lastName}` : currentUserRole, 
    note,
    images,
    relatedRequestId,
    assetId,
    ...extraData // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÄ‡∏ä‡πà‡∏ô supplier
  };
  setInvLogs(prev => [log, ...prev]);
  
  try {
      await saveLogToSheet(log);
  } catch (err) {
      console.error("Save Log Error:", err);
  }
};


      // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
      const handleOpenRequestDetail = (reqId) => {
          const req = requests.find(r => r.id === reqId);
          if (req) {
              setSelectedRequest(req);
              setShowDetailModal(true);
          } else {
              showToast(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ${reqId}`, 'error');
          }
      };

      const handleSort = (key, currentSort, setSort) => {
        setSort({
            key,
            direction: currentSort.key === key && currentSort.direction === 'asc' ? 'desc' : 'asc'
        });
      };
      const handleHistorySort = (key) => handleSort(key, historySort, setHistorySort);
      const getSortedData = (data, sortConfig) => {
          const sorted = [...data];
          sorted.sort((a, b) => {
              if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'asc' ? -1 : 1;
              if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'asc' ? 1 : -1;
              return 0;
          });
          return sorted;
      };

      // --- Logic Hooks ---
;// --- LOGIC: Filter & Sort Requests (UPDATED) ---
      const filteredRequests = useMemo(() => {
        if (!user) return [];
        let data = requests;
        const myName = `${user.firstName} ${user.lastName}`; // ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

        // 1. ‡∏Å‡∏£‡∏≠‡∏á Global Project
        if (globalProjectFilter !== 'All') {
            data = data.filter(r => r.job === globalProjectFilter);
        }

        // 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Search Query
        if (searchQuery) {
            const lowerQ = searchQuery.toLowerCase();
            data = data.filter(r => r.id.toLowerCase().includes(lowerQ) || r.items.some(i => i.name.toLowerCase().includes(lowerQ)) || (r.docNumber && r.docNumber.toLowerCase().includes(lowerQ)));
        }

        // 3. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Status Filter (Dropdown ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Orders)
        if (statusFilter !== 'All') {
           data = data.filter(r => r.status === statusFilter);
        }

        // ‚≠ê 4. ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå"
        data = data.filter(req => {
            const isMine = req.requester === myName || req.requester === 'Current User';
            
            let canAct = false;
            
            // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö myPendingCount
            if (req.status === 'Pending Head') {
                 if ((req.type === 'Withdraw' || req.type === 'Borrow') && (hasPermission(8) || hasPermission(9))) canAct = true;
                 else if (['Local', 'HO'].includes(req.type) && hasPermission(8)) canAct = true;
            }

            if (hasPermission(9) && req.status === 'Pending PM') canAct = true;
            if (hasPermission(10) && req.status === 'Pending Check') canAct = true;
            if (hasPermission(11) && req.status === 'Approved' && req.purchaseType === 'Buy') canAct = true; // PR
            if (hasPermission(12) && req.type === 'HO' && req.status === 'PR Issued') canAct = true; // PO
            if (hasPermission(12) && req.type === 'Local' && req.status === 'Approved') canAct = true; // Local Buy
            if (hasPermission(13) && req.type === 'HO' && (req.status === 'PO Issued' || req.status === 'Contract Signed')) canAct = true; // Shipping
            if (hasPermission(14) && req.type === 'HO' && req.status === 'Contract Pending') canAct = true; // Contract
            if (hasPermission(15) && req.type === 'Local' && (req.status === 'Ordered' || req.status === 'Partially Received')) canAct = true; // Receive Local
            if (hasPermission(15) && req.type === 'HO' && (req.status === 'Shipping' || req.status === 'Partially Received')) canAct = true; // Receive HO
            if (hasPermission(24) && (req.type === 'Withdraw' || req.type === 'Borrow') && req.status === 'Ready to Disburse') canAct = true; // Disburse
            
            // User ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á + Admin ‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î + ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏´‡πá‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥
            if (user.isSuperAdmin) return true;
            return isMine || canAct;
        });

        // ‚≠ê 5. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
        // Helper: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏∂‡∏á Date Required
        const getDaysDiff = (dateStr) => {
            if (!dateStr) return 999;
            const target = new Date(dateStr);
            const today = new Date();
            today.setHours(0,0,0,0);
            const diffTime = target - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        };

       return data.sort((a, b) => {
            // 5.1 [NEW] ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (Cancelled) ‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Completed)
            const isCancelledA = a.status === 'Cancelled';
            const isCancelledB = b.status === 'Cancelled';
            if (isCancelledA !== isCancelledB) return isCancelledA ? 1 : -1;

            // 5.2 ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (Completed/Rejected/Returned) ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏á‡∏•‡∏á‡∏°‡∏≤
            const isCompletedA = ['Completed', 'Rejected', 'Returned'].includes(a.status);
            const isCompletedB = ['Completed', 'Rejected', 'Returned'].includes(b.status);
            if (isCompletedA !== isCompletedB) return isCompletedA ? 1 : -1;

            // 5.3 ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (Date Required) ‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å (‡∏î‡πà‡∏ß‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)
            const daysA = getDaysDiff(a.dateRequired);
            const daysB = getDaysDiff(b.dateRequired);
            return daysA - daysB;
        });

      }, [requests, searchQuery, statusFilter, currentUserRole, globalProjectFilter, user]); // ‡πÄ‡∏û‡∏¥‡πà‡∏° user dependency

// --- LOGIC: Filter & Process Inventory (Updated with Combined IDs) ---
      const filteredInventory = useMemo(() => {
          let data = [...inventory];

          // ‡∏Å‡∏£‡∏≠‡∏á Project (Global)
          if (globalProjectFilter !== 'All') {
              data = data.filter(i => i.project === globalProjectFilter);
          }

          if (invSearch) {
                const lower = invSearch.toLowerCase();
                data = data.filter(i => 
                    i.name.toLowerCase().includes(lower) || 
                    i.id.toLowerCase().includes(lower) ||
                    (i.project && i.project.toLowerCase().includes(lower))
                );
            }

          if (inventoryProjectFilter !== 'All') {
              data = data.filter(i => i.project === inventoryProjectFilter);
          }

          // 2. Tab Logic
          if (invTabMode === 'Summary') {
              // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] Logic ‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°: ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö/‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏•‡∏∞ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
              const grouped = data.reduce((acc, item) => {
                  let existingItem = acc.find(x => x.name === item.name);
                  
                  if (!existingItem) {
                      existingItem = { 
                          ...item, 
                          id: `SUM-${item.name}`, 
                          isSummary: true,
                          combinedIds: [item.id],
                          // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà
                          qty: 0, 
                          systemQty: 0,
                          nonSystemQty: 0,
                          projectBreakdown: {}
                      };
                      acc.push(existingItem);
                  } else {
                      existingItem.combinedIds.push(item.id);
                  }

                  // ‡∏ö‡∏ß‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
                  existingItem.qty += item.qty;
                  
                  // ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                  if (item.stockType === 'NonSystem') existingItem.nonSystemQty += item.qty;
                  else existingItem.systemQty += item.qty;

                  // ‡πÅ‡∏¢‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                  const projName = item.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
                  existingItem.projectBreakdown[projName] = (existingItem.projectBreakdown[projName] || 0) + item.qty;

                  return acc;
              }, []);
              return getSortedData(grouped, invSort);
          } else {
              // ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: System / NonSystem
              data = data.filter(i => (i.stockType || 'System') === invTabMode);
              return getSortedData(data, invSort);
          }

      }, [inventory, invSearch, invSort, invTabMode, globalProjectFilter, inventoryProjectFilter]);


// --- LOGIC: Filter & Sort Assets (UPDATED: Show Both Alerts) ---
      const filteredAssets = useMemo(() => {
          let data = assets;
          
          if (globalProjectFilter !== 'All') { data = data.filter(a => a.project === globalProjectFilter); }
          
          if (assetSearch) {
            const lower = assetSearch.toLowerCase();
            data = data.filter(a => a.name.toLowerCase().includes(lower) || a.id.toLowerCase().includes(lower) || (a.holder && a.holder.toLowerCase().includes(lower)) || (a.project && a.project.toLowerCase().includes(lower)));
          }

          if (assetProjectFilter !== 'All') { data = data.filter(a => a.project === assetProjectFilter); }

          if (assetTabMode === 'Summary') {
              // ... (Summary Logic ‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ) ...
              const grouped = data.reduce((acc, item) => {
                  const existing = acc.find(g => g.name === item.name);
                  if (existing) {
                      existing.totalQty++;
                      if (item.ownerType === 'Company') existing.companyQty++;
                      if (item.ownerType === 'Rent') existing.rentQty++;
                      existing.items.push(item);
                  } else {
                      acc.push({ id: `GRP-${item.name}`, name: item.name, totalQty: 1, companyQty: item.ownerType === 'Company' ? 1 : 0, rentQty: item.ownerType === 'Rent' ? 1 : 0, items: [item], isSummary: true });
                  }
                  return acc;
              }, []);
              return grouped.sort((a, b) => a.name.localeCompare(b.name));
          } else {
            // Normal Logic
            data = data.filter(a => a.ownerType === assetTabMode);
            
            const today = new Date();
            today.setHours(0,0,0,0);

            const processedData = data.map(asset => {
                let alertType = null; 
                let priority = 0;
                let daysLeft = null;
                
                // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ Overdue ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å
                let isOverdue = false;
                let overdueDays = 0;
                
                // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤
                if (asset.ownerType === 'Rent' && asset.rentalEnd) {
                    const endDate = new Date(asset.rentalEnd);
                    const diffTime = endDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    daysLeft = diffDays;

                    if (diffDays < 0) { 
                        alertType = 'expired'; 
                        priority = 3; 
                    } else if (diffDays <= 30) { 
                        alertType = 'expiring'; 
                        priority = 2; 
                    }
                }

                // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏∑‡∏°‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î (Borrowed Overdue)
                if (asset.status === 'Borrowed' && asset.lastUpdated) {
                     const borrowDate = parseThaiDate(asset.lastUpdated);
                     if (borrowDate) {
                         const diffTime = Math.abs(today - borrowDate);
                         const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                         
                         const isSnoozed = asset.snoozeUntil && new Date(asset.snoozeUntil) > today;

                         if (diffDays > 7 && !isSnoozed) { 
                             // ‚≠ê ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Flag ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á
                             isOverdue = true;
                             overdueDays = diffDays;
                             priority = Math.max(priority, 1); 
                             
                             // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ alertType (‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤) ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô overdue
                             // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡πÄ‡∏ä‡πà‡∏ô expired/expiring) ‡∏Å‡πá‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ
                             if (!alertType) alertType = 'overdue';
                         }
                     }
                }
            
                return { ...asset, alertType, priority, daysLeft, isOverdue, overdueDays };
            });

            // Sort: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Priority (‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)
            return processedData.sort((a, b) => {
                if (b.priority !== a.priority) return b.priority - a.priority;
                if (a.daysLeft !== null && b.daysLeft !== null && a.daysLeft !== b.daysLeft) return a.daysLeft - b.daysLeft;
                if (a[assetSort.key] < b[assetSort.key]) return assetSort.direction === 'asc' ? -1 : 1;
                if (a[assetSort.key] > b[assetSort.key]) return assetSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
          }
      }, [assets, assetSearch, assetSort, assetTabMode, globalProjectFilter, assetProjectFilter]);

      // --- Functions & Handlers (Logic from original file) ---
      

// --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Suggestion ---
useEffect(() => {
    let timeoutId;
    setFoundSuggestions([]);
    
  if (tempItem.name && tempItem.name.length > 2 && ['Local', 'HO'].includes(newOrderMeta.type)) {
        timeoutId = setTimeout(() => {
            const lowerName = tempItem.name.toLowerCase();
            let matches = [];

            // üü¢ 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á (Inventory) -> ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏¥‡∏Å (‡πÅ‡∏¢‡∏Å‡∏¢‡∏≠‡∏î ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö / ‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏ô)
            const groupedInv = {};
            
            inventory.forEach(inv => {
                // ‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ
                if (inv.name.toLowerCase().includes(lowerName) && inv.qty > 0) {
                    const currentStockType = inv.stockType || 'System'; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô System
                    
                    // ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á Key ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°: "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤|‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£|‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Å"
                    const key = `${inv.name}|${inv.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á'}|${currentStockType}`;

                    if (!groupedInv[key]) {
                        groupedInv[key] = {
                            ...inv, 
                            qty: 0, // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
                            type: 'Material', 
                            matchType: 'Withdraw',
                            stockType: currentStockType, // ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                            sourceLabel: `‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏ (${currentStockType === 'NonSystem' ? '‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö' : '‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'})`
                        };
                    }

                    // ‡∏ö‡∏ß‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                    groupedInv[key].qty += inv.qty;
                }
            });

            // ‡πÅ‡∏õ‡∏•‡∏á Object ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            Object.values(groupedInv).forEach(item => {
                matches.push(item);
            });

            // üîµ 2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Assets) -> ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏° (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            assets.forEach(ast => {
                if (ast.name.toLowerCase().includes(lowerName) && ast.status === 'Available') {
                    matches.push({ 
                        ...ast, 
                        type: 'Asset', 
                        matchType: 'Borrow',
                        sourceLabel: '‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô'
                    });
                }
            });

            setFoundSuggestions(matches);
        }, 500);
    }
    return () => clearTimeout(timeoutId);
}, [tempItem.name, inventory, assets, newOrderMeta.type]);


// --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Suggestion ---
const selectSuggestion = (item) => {
    const actionLabel = item.matchType === 'Withdraw' 
        ? `‡πÄ‡∏ö‡∏¥‡∏Å (‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á${item.stockType === 'NonSystem' ? '‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö' : '‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'})` 
        : '‡∏¢‡∏∑‡∏°';

    if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ "${actionLabel}" ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ "${item.project}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        
        // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Meta Data (Type, Project, ‡πÅ‡∏•‡∏∞ üìç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Radio Button ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
        setNewOrderMeta(prev => ({
            ...prev,
            type: item.matchType, // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Withdraw ‡∏´‡∏£‡∏∑‡∏≠ Borrow
            job: item.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á', // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠
            withdrawStockType: item.stockType || 'System' // ‚≠ê ‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö/‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        }));

        // 2. ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
        setTempItem(prev => ({ 
            ...prev, 
            name: item.name, 
            unit: item.unit || '‡∏ä‡∏¥‡πâ‡∏ô',
            qty: 1, // Default 1
            unitPrice: 0, // ‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏° ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤
            assetId: item.id, // ‡πÄ‡∏Å‡πá‡∏ö ID
            serial: item.serial || '',
            image: item.image,
            stockType: item.stockType || 'System' // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å
        }));

        // 3. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Suggestion
        setFoundSuggestions([]);
    }
};
// --- LOGIC: ADD ITEM TO ORDER (UPDATED) ---
const handleAddItem = () => {
    if (!tempItem.name) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error'); return; }
    
    const currentType = newOrderMeta.type;

    // üü¢ 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏" (Withdraw)
    if (currentType === 'Withdraw') {
        const currentStockType = newOrderMeta.withdrawStockType || 'System';

        // ‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (System/NonSystem)
        const stockItem = inventory.find(i => 
            i.name === tempItem.name && 
            i.project === newOrderMeta.job &&
            (i.stockType || 'System') === currentStockType
        );
        
        if (!stockItem) {
            showToast(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${tempItem.name}" (${currentStockType === 'System' ? '‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö'}) ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ`, 'error');
            return;
        }

        const totalStock = stockItem.qty;

        const activeRequests = requests.filter(r => 
            r.id !== editingId &&
            !['Draft', 'Completed', 'Rejected', 'Returned', 'Cancelled'].includes(r.status) &&
            r.job === newOrderMeta.job && 
            r.type === 'Withdraw'
        );
        
        const reservedQty = activeRequests.reduce((sum, req) => {
            const sameItem = req.items.find(i => i.name === tempItem.name && (i.stockType || req.withdrawStockType || 'System') === currentStockType);
            return sum + (sameItem ? (sameItem.qty || 0) : 0);
        }, 0);

        const realAvailable = totalStock - reservedQty;

        if (tempItem.qty > realAvailable) {
            showToast(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏°‡∏µ: ${totalStock}, ‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏á: ${reservedQty}, ‡∏ß‡πà‡∏≤‡∏á: ${realAvailable})`, 'error');
            return;
        }

        // ‚≠ê ‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô Item ‡∏î‡πâ‡∏ß‡∏¢
        tempItem.stockType = currentStockType;
    }

    // üîµ 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏¢‡∏∑‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô" (Borrow)
    if (currentType === 'Borrow') {
        if (!tempItem.assetId) { showToast(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'error'); return; }
        if (orderItems.some(item => item.assetId === tempItem.assetId)) { showToast(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥: "${tempItem.name}" ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß`, 'error'); return; }

        const isBookedByOther = requests.some(r => 
            r.id !== editingId &&
            !['Draft', 'Completed', 'Rejected', 'Returned', 'Cancelled'].includes(r.status) &&
            r.type === 'Borrow' &&
            r.items.some(i => i.assetId === tempItem.assetId)
        );

        if (isBookedByOther) { showToast(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ: ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô`, 'error'); return; }
        
        const currentAsset = assets.find(a => a.id === tempItem.assetId);
        if (currentAsset && currentAsset.status !== 'Available') { showToast(`‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á (${currentAsset.status})`, 'error'); return; }
    }

    setOrderItems([...orderItems, { ...tempItem }]);
    setTempItem({ name: '', qty: 1, unitPrice: 0, unit: '‡∏ä‡∏¥‡πâ‡∏ô', subJob: '', matCode: '', note: '', images: [], assetId: '', serial: '' });
    setStockSuggestion(null); 
};


const handleEditItem = (index) => {
          const itemToEdit = orderItems[index];
          setTempItem(itemToEdit); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°
          
          // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ)
          const newItems = [...orderItems];
          newItems.splice(index, 1);
          setOrderItems(newItems);
      };

const getItemLatestImage = (item) => {
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô invLogs (‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å ‡πÉ‡∏´‡∏°‡πà -> ‡πÄ‡∏Å‡πà‡∏≤ ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
    const log = invLogs.find(l => {
        // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        if (!l.images || l.images.length === 0) return false;
        
        // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà] ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ID ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏µ‡πà ID ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ AST ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà)
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏ú‡∏¥‡∏î‡∏ï‡∏±‡∏ß
        if (item.id && l.assetId) {
            return l.assetId === item.id;
        }

        // ‡∏Å‡∏£‡∏ì‡∏µ Inventory: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ID ‡πÉ‡∏ô Log (Log ‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏Å‡πà‡∏≤) ‡∏≠‡∏ô‡∏∏‡πÇ‡∏•‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ
        // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Asset (‡∏°‡∏µ serial) ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏π‡∏õ‡∏ã‡πâ‡∏≥
        if (item.serial === undefined) { 
             return l.item === item.name;
        }
        
        return false;
    });

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ Log ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏£‡∏π‡∏õ‡πÅ‡∏£‡∏Å
    if (log) return log.images[0];
    return null;
};

const getItemLatestImages = (item) => {
    // ‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÅ‡∏ï‡πà return images ‡∏ó‡∏±‡πâ‡∏á array
    const log = invLogs.find(l => {
        if (!l.images || l.images.length === 0) return false;
        
        // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏ä‡πá‡∏Ñ ID ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
        if (item.id && l.assetId) {
             return l.assetId === item.id;
        }

        if (item.serial === undefined) { 
             return l.item === item.name;
        }

        return false;
    });
    return log ? log.images : [];
};



// --- LOGIC: Filter Selection Items (Updated) ---
const getSelectionItems = () => {
    const type = newOrderMeta.type;
    const targetProject = newOrderMeta.job;
    
    if (!targetProject) return [];
    let items = [];

    // üü¢ ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏ (Withdraw) -> ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (System / NonSystem)
    if (type === 'Withdraw') {
        const currentType = newOrderMeta.withdrawStockType || 'System'; // ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

        // 1. ‡∏´‡∏≤‡∏ö‡∏¥‡∏•‡∏à‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏á
        const activeRequests = requests.filter(r => 
            r.id !== editingId &&
            !['Draft', 'Completed', 'Rejected', 'Returned', 'Cancelled'].includes(r.status) &&
            r.job === targetProject &&
            r.type === 'Withdraw'
        );

        // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏à‡∏≠‡∏á ‡πÇ‡∏î‡∏¢‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Type ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
        const reservesByName = {};
        activeRequests.forEach(req => {
            req.items.forEach(item => {
                const iType = item.stockType || req.withdrawStockType || 'System'; 
                if (iType === currentType) {
                    reservesByName[item.name] = (reservesByName[item.name] || 0) + (item.qty || 0);
                }
            });
        });

        // 3. ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        items = inventory
            .filter(i => i.project === targetProject && (i.stockType || 'System') === currentType)
            .map(item => {
                const reserved = reservesByName[item.name] || 0;
                const realAvailable = Math.max(0, item.qty - reserved);
                return {
                    ...item,
                    qty: realAvailable, // ‡πÇ‡∏ä‡∏ß‡πå‡∏¢‡∏≠‡∏î‡∏ß‡πà‡∏≤‡∏á
                    reserved: reserved
                };
            })
            .filter(i => i.qty > 0); // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î
    } 
    // üîµ ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏¢‡∏∑‡∏° (Borrow) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ã‡∏∑‡πâ‡∏≠ (Local/HO)
    else {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const projectInventory = inventory.filter(i => i.project === targetProject && i.qty > 0);
        
        const pendingAssetIds = requests
            .filter(r => r.id !== editingId && !['Draft', 'Completed', 'Rejected', 'Returned', 'Cancelled'].includes(r.status) && r.type === 'Borrow')
            .flatMap(r => r.items.map(i => i.assetId))
            .filter(id => id);

        const projectAssets = assets.filter(a => {
            if (a.project !== targetProject) return false;
            if (a.status !== 'Available') return false; 
            if (pendingAssetIds.includes(a.id)) return false; // ‡∏´‡∏±‡∏Å‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏á

            if (a.ownerType === 'Rent' && a.rentalEnd) {
                const endDate = new Date(a.rentalEnd);
                if (!isNaN(endDate.getTime())) {
                   endDate.setHours(0, 0, 0, 0);
                   if (endDate < today) return false;
                }
            }
            return true;
        });

        if (type === 'Local') items = projectInventory;
        else if (type === 'HO') items = [...projectInventory, ...projectAssets];
        else if (type === 'Borrow') items = projectAssets;
    }

    if (selectionSearch) {
        const lower = selectionSearch.toLowerCase();
        items = items.filter(i => 
            i.name.toLowerCase().includes(lower) || 
            (i.id && i.id.toLowerCase().includes(lower)) || 
            (i.serial && i.serial.toLowerCase().includes(lower))
        );
    }
    
    return items;
};

// --- LOGIC: Handle Selection (Updated) ---
      const handleSelectFromModal = (item) => {
          const isBorrow = newOrderMeta.type === 'Borrow';
          const isWithdraw = newOrderMeta.type === 'Withdraw';
          
          // ‚≠ê Logic ‡∏ä‡∏∑‡πà‡∏≠: ‡∏¢‡∏∑‡∏°/‡πÄ‡∏ö‡∏¥‡∏Å/‡∏ã‡∏∑‡πâ‡∏≠ ‡∏î‡∏∂‡∏á‡πÅ‡∏Ñ‡πà "‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ID ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢)
          const name = item.name; 

          setTempItem({
              ...tempItem,
              name: name,
              unitPrice: (isWithdraw || isBorrow) ? 0 : item.price,
              unit: (item.unit || '‡∏ä‡∏¥‡πâ‡∏ô'),
              // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Asset ‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Ñ Validation ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
              assetId: item.id,
              serial: item.serial,
              image: item.image 
          });
          setShowSelectionModal(false);
          setSelectionSearch('');
      };
      
      const handleOpenSelectionModal = () => {
          setSelectionSearch('');
          setShowSelectionModal(true);
      };

const handleEditDraft = (req) => {
          setEditingId(req.id);
          
          // ‚≠ê 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° withdrawStockType ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å "‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"
          setNewOrderMeta({
              type: req.type,
              purchaseType: req.purchaseType || 'Buy',
              withdrawStockType: req.withdrawStockType || 'System', // üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
              job: req.job || '',
              dateRequired: req.dateRequired || '',
              priority: req.priority || 'Normal',
              attachment: req.attachment || null,
              quotation: req.quotation || null
          });
          
          // ‚≠ê 2. ‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏ï‡∏£‡∏≤ stockType ‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô items ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ validation ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Error
          const itemsWithStockType = (req.items || []).map(item => ({
              ...item,
              stockType: item.stockType || req.withdrawStockType || 'System' // üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
          }));
          
          setOrderItems(itemsWithStockType); // üëà ‡πÄ‡∏ã‡πá‡∏ï items ‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
          setShowCreateModal(true);
      };
      
      const handleRevise = (req) => {
          handleEditDraft(req);
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á', 'info');
      };

      const handleCloseCreateModal = () => {
          setShowCreateModal(false);
          setEditingId(null);
          setOrderItems([]);
          setNewOrderMeta({ type: 'Local', purchaseType: 'Buy', withdrawStockType: 'System', job: '', dateRequired: '', priority: 'Normal', attachment: null, quotation: null });
          setTempItem({ name: '', qty: 1, unitPrice: 0, unit: '‡∏ä‡∏¥‡πâ‡∏ô', subJob: '', matCode: '', note: '', images: [] });
      };

// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
      const getFutureDate = (days) => {
          const date = new Date();
          date.setDate(date.getDate() + days);
          return date.toISOString().split('T')[0];
      };

      // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á handleOpenCreateModal
      const handleOpenCreateModal = () => {
          setEditingId(null);
          setOrderItems([]);
setNewOrderMeta({ 
    type: 'Local', 
    purchaseType: 'Buy', 
    withdrawStockType: 'System', // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    job: globalProjectFilter !== 'All' ? globalProjectFilter : '', 
    dateRequired: getFutureDate(7), 
    priority: 'Urgent',
    attachment: null, 
    quotation: null 
});
          setTempItem({ name: '', qty: 1, unitPrice: 0, unit: '‡∏ä‡∏¥‡πâ‡∏ô', subJob: '', matCode: '', note: '', images: [] });
          setShowCreateModal(true);
      };


      // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Priority ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      const handleDateChange = (e) => {
          const selectedDate = e.target.value;
          if (!selectedDate) {
              setNewOrderMeta(prev => ({ ...prev, dateRequired: selectedDate }));
              return;
          }

          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const target = new Date(selectedDate);
          const diffTime = target - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          let newPriority = 'Normal';
          if (diffDays <= 7) newPriority = 'Critical';      // 0 - 7 ‡∏ß‡∏±‡∏ô -> ‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å
          else if (diffDays <= 30) newPriority = 'Urgent';  // 8 - 30 ‡∏ß‡∏±‡∏ô -> ‡∏î‡πà‡∏ß‡∏ô
          else newPriority = 'Normal';                      // 31 ‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ -> ‡∏õ‡∏Å‡∏ï‡∏¥

          setNewOrderMeta(prev => ({ ...prev, dateRequired: selectedDate, priority: newPriority }));
      };

      const initiateRecall = (id) => {
          if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£? \n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô "‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á" (Draft) ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà')) return;
          const updatedReqs = requests.map(r => {
              if (r.id === id) {
                    // ‚≠ê ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                    const updated = { ...r, status: 'Draft', history: [...r.history, createLog('Revert to Draft', `${user.empId} ${user.firstName} ${user.lastName}`, 'User recalled request')] };
                    saveRequestToSheet(updated);
                    return updated;
              }
              return r;
          });
          setRequests(updatedReqs);
          showToast('‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß');
      };

const handleCancelOrder = (req) => {
          if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ${req.id} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

          const reason = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å:");
          if (reason === null) return; // ‡∏Å‡∏î Cancel
          if (!reason.trim()) {
              showToast("‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", "error");
              return;
          }

          const userSignature = `${user.empId} ${user.firstName} ${user.lastName}`;
          handleUpdateStatus(req.id, 'Cancelled', `‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${reason}`);
      };

      const handleRemoveItem = (index) => {
          const newItems = [...orderItems];
          newItems.splice(index, 1);
          setOrderItems(newItems);
      };


      const handleUpdateStock = () => {
          if (!editingStockItem) return;
          const updatedItem = { ...editingStockItem, lastUpdated: new Date().toLocaleString('th-TH') };
          
          setInventory(prev => prev.map(item => item.id === editingStockItem.id ? updatedItem : item));
          saveInventoryToSheet(updatedItem); // Sync

          const oldItem = inventory.find(i => i.id === editingStockItem.id);
          const change = editingStockItem.qty - (oldItem ? oldItem.qty : 0);
          const changeStr = change > 0 ? `+${change}` : `${change}`;
          
          addInvLog('Update Stock', editingStockItem.name, changeStr, '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å', []);
          setShowEditInvModal(false);
          setEditingStockItem(null);
          showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      };


// --- LOGIC: ASSET IMAGE HANDLING (Base64 Preview like Daily Report) ---
      
      // 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Base64 ‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ Array ‡πÄ‡∏î‡∏¥‡∏°)
      const handleAssetImageSelect = (e, isEdit = false) => {
          if (e.target.files && e.target.files.length > 0) {
              const files = Array.from(e.target.files);
              
              // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
              const promises = files.map(file => {
                  return new Promise((resolve, reject) => {
                      const reader = new FileReader();
                      reader.onload = (x) => resolve({ 
                          base64: x.target.result, 
                          file: file, // ‡πÄ‡∏Å‡πá‡∏ö File Object ‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ (‡πÅ‡∏ï‡πà‡∏´‡∏•‡∏±‡∏Å‡πÜ ‡πÉ‡∏ä‡πâ Base64 ‡πÇ‡∏ä‡∏ß‡πå)
                          name: file.name
                      });
                      reader.onerror = reject;
                      reader.readAsDataURL(file);
                  });
              });

              Promise.all(promises).then(newImages => {
                  if (isEdit) {
                      // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô newImages
                      setEditingAssetItem(prev => ({
                          ...prev,
                          newImages: [...(prev.newImages || []), ...newImages]
                      }));
                  } else {
                      // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô images
                      setNewAssetItem(prev => ({ 
                          ...prev, 
                          images: [...prev.images, ...newImages] 
                      }));
                  }
              });
          }
      };

      // --- LOGIC: RETURN ASSET IMAGE HANDLING ---
      const handleReturnImageSelect = (e) => {
          if (e.target.files && e.target.files.length > 0) {
              const files = Array.from(e.target.files);
              const newImages = files.map(file => ({ file, url: URL.createObjectURL(file) }));
              setReturnAssetData(prev => ({ 
                  ...prev, 
                  images: [...(prev.images || []), ...files], // ‡πÄ‡∏Å‡πá‡∏ö File Object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Upload
                  previews: [...(prev.previews || []), ...newImages] // ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Preview
              }));
          }
      };

      const handleRemoveReturnImage = (index) => {
          setReturnAssetData(prev => ({
              ...prev,
              images: prev.images.filter((_, i) => i !== index),
              previews: prev.previews.filter((_, i) => i !== index)
          }));
      };

      // 2. ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
      const handleRemoveAssetImage = (index, isEdit = false) => {
          if (isEdit) {
              setEditingAssetItem(prev => ({
                  ...prev,
                  newImages: prev.newImages.filter((_, i) => i !== index)
              }));
          } else {
              setNewAssetItem(prev => ({
                  ...prev,
                  images: prev.images.filter((_, i) => i !== index)
              }));
          }
      };

// --- LOGIC: STOCK IMAGE HANDLING ---
      const handleStockImageSelect = (e) => {
          if (e.target.files && e.target.files.length > 0) {
              const files = Array.from(e.target.files);
              const promises = files.map(file => {
                  return new Promise((resolve) => {
                      const reader = new FileReader();
                      reader.onload = (x) => resolve({
                          base64: x.target.result,
                          file: file,
                          name: file.name
                      });
                      reader.readAsDataURL(file);
                  });
              });
              Promise.all(promises).then(newImages => {
                  setNewStockItem(prev => ({
                      ...prev,
                      images: [...(prev.images || []), ...newImages]
                  }));
              });
          }
      };

      const handleRemoveStockImage = (index) => {
          setNewStockItem(prev => ({
              ...prev,
              images: prev.images.filter((_, i) => i !== index)
          }));
      };

// --- LOGIC: ADD NEW PRODUCT (Robust Auto Gen & Composite ID) ---
const handleAddNewProduct = async () => {
    // 1. Validation
    if (!newStockItem.name) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'error'); return; }
    if (!newStockItem.project) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£', 'error'); return; }
    if (newStockItem.qty < 0) { showToast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 0', 'error'); return; }
    
    const currentType = newStockItem.stockType || 'System';

    // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ä‡∏∑‡πà‡∏≠+‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£+‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞)
    const existingInv = inventory.find(i => 
        i.name === newStockItem.name && 
        i.project === newStockItem.project && 
        (i.stockType === currentType || (!i.stockType && currentType === 'System'))
    );
    
    // 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Base ID (‡∏£‡∏´‡∏±‡∏™‡∏™‡∏±‡πâ‡∏ô)
    let baseId = newStockItem.id;
    if (newStockItem.isAutoId) {
        // ‚≠ê Auto Gen Logic: ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÜ
        let runNoCount = inventory.length + 1;
        baseId = `INV-${String(runNoCount).padStart(3, '0')}`;
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö "‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô" ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        while (inventory.some(inv => getDisplayId(inv.id) === baseId)) {
            runNoCount++;
            baseId = `INV-${String(runNoCount).padStart(3, '0')}`;
        }
    } else {
        // ‡∏ñ‡πâ‡∏≤ Manual ID ‡∏°‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏´‡∏° (‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏Å‡πá‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ)
        if (!baseId) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'error'); return; }
    }

    // ‚≠ê 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á Real ID (‡∏£‡∏´‡∏±‡∏™|‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£|‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° -> ‡πÉ‡∏ä‡πâ ID ‡πÄ‡∏î‡∏¥‡∏°
    // ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà -> ‡πÉ‡∏ä‡πâ BaseId ‡∏ó‡∏µ‡πà Gen ‡∏°‡∏≤ + Suffix
    let finalId = existingInv ? existingInv.id : `${baseId}|${newStockItem.project}|${currentType}`;

    setIsLoading(true);
    try {
        // ... (‡∏™‡πà‡∏ß‡∏ô Upload Image ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ) ...
        let uploadedFiles = [];
        if (newStockItem.images && newStockItem.images.length > 0) {
            const uploadPromises = newStockItem.images.map(imgObj => {
                return new Promise((resolve, reject) => {
                    google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).uploadAssetImage(imgObj.base64, imgObj.name);
                });
            });
            uploadedFiles = await Promise.all(uploadPromises);
        }
        const mainImageName = uploadedFiles.length > 0 ? uploadedFiles[0].name : (existingInv ? existingInv.image : null);
        const date = new Date().toLocaleString('th-TH');
        // ... (‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô Image) ...
const supplierTxt = newStockItem.supplier ? ` | ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ${newStockItem.supplier}` : '';
        if (existingInv) {
            // ‚úÖ MERGE (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
const updatedItem = {
                ...existingInv,
                qty: existingInv.qty + newStockItem.qty,
                price: newStockItem.price > 0 ? newStockItem.price : existingInv.price,
                note: newStockItem.note ? (existingInv.note ? `${existingInv.note} | ${newStockItem.note}` : newStockItem.note) : existingInv.note,
                lastUpdated: date,
                image: mainImageName,
                supplier: newStockItem.supplier || existingInv.supplier // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Supplier
            };
            setInventory(prev => prev.map(i => i.id === existingInv.id ? updatedItem : i));
            
            // ‡πÉ‡∏ä‡πâ await ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
            await saveInventoryToSheet(updatedItem);
            
            const logAttachments = uploadedFiles.map(f => ({ name: f.name, type: 'image/jpeg', url: f.url }));
            await addInvLog('Add Stock (Merge)', updatedItem.name, `+${newStockItem.qty}`, `‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: ${updatedItem.project} (${currentType})${supplierTxt}`, logAttachments, null, finalId, { supplier: newStockItem.supplier });
            
            showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${updatedItem.qty})`);
            
        } else {
            // ‚úÖ NEW
            const newItem = {
                id: finalInvId,
                ...newStockItem,
                supplier: newStockItem.supplier || '', // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Supplier
                stockType: currentType,
                // ...
            };
            const { images, isAutoId, ...itemForServer } = newItem;
            
            setInventory(prev => [...prev, newItem]);
            await saveInventoryToSheet(itemForServer);
            
            const logAttachments = uploadedFiles.map(f => ({ name: f.name, type: 'image/jpeg', url: f.url }));
            const typeLabel = currentType === 'NonSystem' ? '[‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö]' : '[‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö]';
            await addInvLog('Add New Item', newItem.name, `Start: ${newItem.qty}`, `‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: ${newItem.project} | ${typeLabel}${supplierTxt}`, logAttachments, null, finalId, { supplier: newItem.supplier });
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

        setIsLoading(false);
        setShowAddInvModal(false);
        // Reset Form
        setNewStockItem({ name: '', qty: 0, unit: '‡∏ä‡∏¥‡πâ‡∏ô', minStock: 0, price: 0, images: [], note: '', stockType: 'System', project: globalProjectFilter !== 'All' ? globalProjectFilter : '', id: '', isAutoId: true });

    } catch (error) {
        setIsLoading(false);
        console.error(error);
        showToast("Error: " + error.message, 'error');
    }
};

// --- LOGIC: ADD ASSET (UPDATED: Check Holder) ---
const handleAddAsset = async () => {
          // Validation
          if (!newAssetItem.ownerType) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô', 'error');
          return; }
          if (!newAssetItem.isAutoId && !newAssetItem.id) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô', 'error'); return;
          }
          if (!newAssetItem.name) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error'); return;
          }
          if (!newAssetItem.isAutoId && assets.some(a => a.id === newAssetItem.id)) { showToast('‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ã‡πâ‡∏≥', 'error');
          return; }
          
          // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏¢‡∏∑‡∏° ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô Borrowed
          if (newAssetItem.status === 'Borrowed') {
              if (!newAssetItem.holder || newAssetItem.holder.trim() === '') {
                  showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°', 'error');
                  return;
              }
              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤ ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
              const isValidUser = allUsers.some(u => `${u.firstName} ${u.lastName}` === newAssetItem.holder);
              if (!isValidUser) {
                  showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)', 'error');
                  return;
              }
          }

          setIsLoading(true);

          try {
              const date = new Date().toLocaleString('th-TH');
              
              // Auto Gen ID
              let finalId = newAssetItem.id;
              if (newAssetItem.isAutoId) {
                  const prefix = newAssetItem.ownerType === 'Rent' ? 'AST-R' : 'AST-C';
                  const runNo = String(assets.length + 1).padStart(3, '0');
                  finalId = `${prefix}-${new Date().getFullYear().toString().slice(-2)}${(new Date().getMonth()+1).toString().padStart(2,'0')}-${runNo}`;
              }

              // Upload Images
              let uploadedFiles = [];
              if (newAssetItem.images && newAssetItem.images.length > 0) {
                  const uploadPromises = newAssetItem.images.map(imgObj => {
                      return new Promise((resolve, reject) => {
                          google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .uploadAssetImage(imgObj.base64, imgObj.name);
                      });
                  });
                  uploadedFiles = await Promise.all(uploadPromises);
              }

              const mainImageName = uploadedFiles.length > 0 ? uploadedFiles[0].name : null;

              // ‚≠ê ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Holder: ‡∏ñ‡πâ‡∏≤ Borrowed ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô '-'
              const finalHolder = newAssetItem.status === 'Borrowed' ? newAssetItem.holder : '-';

const newAsset = { 
                  currentRequestId: null, 
                  lastUpdated: date,
                  ...newAssetItem, 
                  holder: finalHolder,
                  id: finalId,     
                  image: mainImageName,
                  supplier: newAssetItem.supplier || '', // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Supplier
                  images: [] 
              };
              
              const { images, ...assetForServer } = newAsset;
              saveAssetToSheet(assetForServer); 
              setAssets(prev => [...prev, newAsset]);
              
              // Log
              const logAttachments = uploadedFiles.map(f => ({ name: f.name, type: 'image/jpeg', url: f.url }));
              
              // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Log
              let logAction = `‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${newAssetItem.project || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà ${finalId} (${newAssetItem.status})`;
              if (newAssetItem.status === 'Borrowed') logAction += ` ‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°: ${finalHolder}`;
              if (newAssetItem.supplier) logAction += ` | ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ${newAssetItem.supplier}`;

              addInvLog('Add Asset', newAssetItem.name, 'New', logAction, logAttachments, null, null, { supplier: newAssetItem.supplier });

              
              setIsLoading(false);
              setShowAssetModal(false);
              // Reset State
              setNewAssetItem({ id: '', isAutoId: false, name: '', serial: '', status: 'Available', condition: 'Good', ownerType: '', price: 0, rentalPrice: 0, rentalUnit: 'Month', images: [], note: '', holder: '' });
              showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);

          } catch (error) {
              setIsLoading(false);
              showToast("Error: " + error.message, 'error');
          }
      };

 // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç initiateReturnAsset
      const initiateReturnAsset = (asset) => {
          setReturnAssetData({ 
              id: asset.id, 
              name: asset.name, // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á
              serial: asset.serial, // ‡πÄ‡∏Å‡πá‡∏ö serial ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á
              condition: 'Good', 
              note: '', 
              images: [], 
              previews: [] // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ
          });
          setShowReturnAssetModal(true);
      };

// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô (Update: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å User ‡∏à‡∏£‡∏¥‡∏á‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)
const confirmReturnAsset = async () => {
    const asset = assets.find(a => a.id === returnAssetData.id);
    if (!asset) return;
    
    // Validation
    if (returnAssetData.condition === 'Lost' || returnAssetData.condition === 'Damaged') {
        if (!returnAssetData.note || returnAssetData.note.trim() === '') {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢/‡∏ä‡∏≥‡∏£‡∏∏‡∏î)', 'error');
            return;
        }
    }
    
    if (returnAssetData.condition === 'Damaged') {
        if (!returnAssetData.images || returnAssetData.images.length === 0) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡∏†‡∏≤‡∏û‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏ä‡∏≥‡∏£‡∏∏‡∏î)', 'error');
            return;
        }
    }
    
    setIsLoading(true);
    try {
        // 1. Upload Images
        let uploadedFiles = [];
        if (returnAssetData.images && returnAssetData.images.length > 0) {
            const uploadPromises = returnAssetData.images.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .uploadAssetImage(reader.result, file.name);
                    };
                });
            });
            uploadedFiles = await Promise.all(uploadPromises);
        }
        
        const logAttachments = uploadedFiles.map(f => ({ name: f.name, type: 'image/jpeg', url: f.url }));
        
        // 2. New Status
        let newStatus = 'Available';
        if (returnAssetData.condition === 'Damaged') newStatus = 'Damaged';
        if (returnAssetData.condition === 'Lost') newStatus = 'Lost';

        // 3. Update Asset
        const updatedAsset = { 
            ...asset, 
            status: newStatus,
            holder: '-', 
            currentRequestId: null, 
            lastUpdated: new Date().toLocaleString('th-TH'),
            image: uploadedFiles.length > 0 ? uploadedFiles[0].name : asset.image,
            note: returnAssetData.note || asset.note 
        };
        setAssets(prev => prev.map(a => a.id === asset.id ? updatedAsset : a));
        
        const { images, ...assetForServer } = updatedAsset;
        saveAssetToSheet(assetForServer);

        // 4. Log & Request Update
        let statusText = '‡∏õ‡∏Å‡∏ï‡∏¥/‡∏î‡∏µ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)';
        if (returnAssetData.condition === 'Damaged') statusText = '‡∏ä‡∏≥‡∏£‡∏∏‡∏î';
        if (returnAssetData.condition === 'Lost') statusText = '‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢';

        // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô (User ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
        const returnerSignature = `${user.empId} ${user.firstName} ${user.lastName}`;

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡∏Ç‡∏≠‡∏á Asset
        await addInvLog(
            'Return Asset', 
            asset.name, 
            'Return', 
            `‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô: ${statusText} ‡πÇ‡∏î‡∏¢ ${returnerSignature} ${returnAssetData.note ? `(${returnAssetData.note})` : ''}`, 
            logAttachments, 
            asset.currentRequestId, 
            asset.id // üëà ‡πÉ‡∏™‡πà ID ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏õ‡πÇ‡∏ú‡∏•‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡πâ‡∏ô‡πÜ
        );
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡∏Ç‡∏≠‡∏á Request (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô PDF ‡∏ä‡πà‡∏≠‡∏á Returned By)
        if (asset.currentRequestId) {
            setRequests(prev => prev.map(r => {
                if (r.id === asset.currentRequestId) {
                    const updatedReq = { 
                        ...r, 
                        status: 'Returned', 
                        // ‡πÉ‡∏ä‡πâ returnerSignature ‡πÅ‡∏ó‡∏ô currentUserRole
                        history: [...r.history, createLog('Returned', returnerSignature, `‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á: ${statusText}`, logAttachments)]
                    };
                    saveRequestToSheet(updatedReq); 
                    return updatedReq;
                }
                return r;
            }));
        }
        
        setIsLoading(false);
        setShowReturnAssetModal(false);
        showToast('‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

    } catch (error) {
        setIsLoading(false);
        console.error(error);
        showToast("Error: " + error.message, 'error');
    }
};

const handleUpdateAsset = async (e) => {
    e.preventDefault();
    
    // 1. Validation
    if (editingAssetItem.status === 'Lost' || editingAssetItem.status === 'Damaged') {
        if (!editingAssetItem.note || editingAssetItem.note.trim() === '') {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢/‡∏ä‡∏≥‡∏£‡∏∏‡∏î)', 'error');
            return;
        }
    }
    
    if (editingAssetItem.status === 'Damaged') {
        if (!editingAssetItem.newImages || editingAssetItem.newImages.length === 0) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏ä‡∏≥‡∏£‡∏∏‡∏î)', 'error');
            return;
        }
    }

    setIsLoading(true);

    try {
        const date = new Date().toLocaleString('th-TH');
        const originalAsset = assets.find(a => a.id === editingAssetItem.originalId);

        // 2. Upload New Images
        let newUploadedFiles = [];
        if (editingAssetItem.newImages && editingAssetItem.newImages.length > 0) {
            const uploadPromises = editingAssetItem.newImages.map(imgObj => {
                return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(imgObj.file);
                        reader.onload = () => {
                            google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .uploadAssetImage(reader.result, imgObj.file.name);
                        };
                });
            });
            newUploadedFiles = await Promise.all(uploadPromises);
        }

        const mainImage = newUploadedFiles.length > 0 ? newUploadedFiles[0].name : editingAssetItem.image;
        
        // 3. Prepare Updated Data
        const updatedAsset = { 
            ...editingAssetItem, 
            lastUpdated: date,
            image: mainImage,
            images: [], 
            newImages: [] 
        };
        
        // ‚≠ê 4. Compare Changes (Detailed Log)
        let changes = [];
        const val = (v) => (v === null || v === undefined || v === '') ? '-' : v;

        if (originalAsset) {
            // ‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô
            if (val(originalAsset.id) !== val(updatedAsset.id)) changes.push(`ID: ${originalAsset.id} -> ${updatedAsset.id}`);
            // ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            if (val(originalAsset.name) !== val(updatedAsset.name)) changes.push(`‡∏ä‡∏∑‡πà‡∏≠: ${originalAsset.name} -> ${updatedAsset.name}`);
            // Serial Number
            if (val(originalAsset.serial) !== val(updatedAsset.serial)) changes.push(`S/N: ${val(originalAsset.serial)} -> ${val(updatedAsset.serial)}`);
            
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÄ‡∏ä‡πà‡∏≤
            if (updatedAsset.ownerType === 'Rent') {
                if (originalAsset.rentalPrice !== updatedAsset.rentalPrice) changes.push(`‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤: ${originalAsset.rentalPrice} -> ${updatedAsset.rentalPrice}`);
                if (val(originalAsset.rentalUnit) !== val(updatedAsset.rentalUnit)) changes.push(`‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏ä‡πà‡∏≤: ${val(originalAsset.rentalUnit)} -> ${val(updatedAsset.rentalUnit)}`);
                if (val(originalAsset.rentalStart) !== val(updatedAsset.rentalStart)) changes.push(`‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤: ${val(originalAsset.rentalStart)} -> ${val(updatedAsset.rentalStart)}`);
                if (val(originalAsset.rentalEnd) !== val(updatedAsset.rentalEnd)) changes.push(`‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤: ${val(originalAsset.rentalEnd)} -> ${val(updatedAsset.rentalEnd)}`);
            } else {
                if (originalAsset.price !== updatedAsset.price) changes.push(`‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠: ${originalAsset.price} -> ${updatedAsset.price}`);
            }

            // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            if (val(originalAsset.status) !== val(updatedAsset.status)) changes.push(`‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${val(originalAsset.status)} -> ${val(updatedAsset.status)}`);
            
            // ‚≠ê ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á / ‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏° (‡πÉ‡∏´‡∏°‡πà)
            if (val(originalAsset.holder) !== val(updatedAsset.holder)) changes.push(`‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°: ${val(originalAsset.holder)} -> ${val(updatedAsset.holder)}`);

            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
            if (val(originalAsset.note) !== val(updatedAsset.note)) changes.push(`Note: ${val(originalAsset.note)} -> ${val(updatedAsset.note)}`);
            
            // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            if (newUploadedFiles.length > 0) changes.push(`‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà`);
        }
   
        const changeLog = changes.length > 0 ? changes.join('\n') : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤)';

        // 5. Handle ID Change
        if (originalAsset && originalAsset.id !== updatedAsset.id) {
             await new Promise(r => google.script.run.withSuccessHandler(r).deleteDataFromSheet('Assets', originalAsset.id)); 
             try {
                 await new Promise(r => google.script.run.withSuccessHandler(r).updateLogItemId(originalAsset.id, updatedAsset.id));
             } catch (e) { console.log("Backend updateLogItemId error"); }

             setInvLogs(prevLogs => prevLogs.map(log => {
                 if (log.assetId === originalAsset.id) return { ...log, assetId: updatedAsset.id };
                 return log;
             }));
        }

        // 6. Update Asset State & Save
        setAssets(prev => {
            const filtered = prev.filter(a => a.id !== editingAssetItem.originalId);
            return [...filtered, updatedAsset];
        });
        
        const { images, newImages, originalId, ...assetForServer } = updatedAsset;
        saveAssetToSheet(assetForServer); 

        // 7. Log Action
        const logAttachments = newUploadedFiles.map(f => ({ name: f.name, type: 'image/jpeg', url: f.url }));
        await addInvLog('Edit Asset', updatedAsset.name, 'Edit', changeLog, logAttachments, null, updatedAsset.id);
        
        setIsLoading(false);
        setShowEditAssetModal(false);
        setEditingAssetItem(null);
        showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

    } catch (error) {
        setIsLoading(false);
        console.error(error);
        showToast("Error: " + error.message, 'error');
    }
};
      
// --- HELPER: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÅ‡∏•‡∏∞ ‡∏£‡∏≤‡∏¢ Code) ---
const getBudgetStats = (req, identifier, type, isGroup = false) => {
    if (!req || !req.job || !identifier) return { budget: 0, used: 0, pending: 0, current: 0 };
    const projectData = projects.find(p => p.name === req.job);
    if (!projectData) return { budget: 0, used: 0, pending: 0, current: 0 };

    const defs = type === 'SubJob' ? (projectData.subJobs || []) : (projectData.matCodes || []);
    
    // 1. ‡∏£‡∏∞‡∏ö‡∏∏ Target Codes ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
    let targetCodes = [];
    let totalBudget = 0;

    if (isGroup) {
        // üü¢ ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°: identifier ‡∏Ñ‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏° -> ‡∏´‡∏≤ Codes ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏±‡πâ‡∏ô
        targetCodes = defs
            .filter(d => (d.group || 'Others (‡∏≠‡∏∑‡πà‡∏ô‡πÜ)') === identifier)
            .map(d => d.code);
        
        // ‡∏£‡∏ß‡∏°‡∏á‡∏ö‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
        totalBudget = defs
            .filter(d => targetCodes.includes(d.code))
            .reduce((sum, d) => sum + (Number(d.budget) || 0), 0);
    } else {
        // üîµ ‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß: identifier ‡∏Ñ‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™ Code -> ‡πÉ‡∏ä‡πâ Code ‡∏ô‡∏±‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        targetCodes = [identifier];
        const targetDef = defs.find(d => d.code === identifier);
        totalBudget = targetDef ? (Number(targetDef.budget) || 0) : 0;
    }

    if (targetCodes.length === 0) return { budget: 0, used: 0, pending: 0, current: 0 };

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡πÉ‡∏ä‡πâ Logic: Assets > Logs > Estimate)
    const calculateValue = (r) => {
        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Item ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Target Codes
        const relevantItems = r.items.filter(i => targetCodes.includes(type === 'SubJob' ? i.subJob : i.matCode));
        const isRent = r.type === 'HO' && r.purchaseType === 'Rent';
        
        return relevantItems.reduce((sum, item) => {
            const relatedAssets = assets.filter(a => 
                a.currentRequestId === r.id && 
                a.name === item.name &&
                (a.price === item.unitPrice || a.rentalPrice === item.unitPrice)
            );
            const receivedLogs = item.receivedLog || [];
            
            let itemVal = 0;
            let cnt = 0;

            if (relatedAssets.length > 0) {
                itemVal += relatedAssets.reduce((s, asset) => {
                    const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                    const duration = isRent ? (asset.duration || item.duration || 1) : 1;
                    return s + (price * duration);
                }, 0);
                cnt = relatedAssets.length;
            } else if (receivedLogs.length > 0) {
                itemVal += receivedLogs.reduce((s, log) => {
                    const duration = isRent ? (log.duration || 1) : 1;
                    return s + (log.qty * log.price * duration);
                }, 0);
                cnt = item.receivedTotal || 0;
            }

            if (r.status !== 'Completed') {
                const rem = Math.max(0, item.qty - cnt);
                const dur = isRent ? (item.duration || 1) : 1;
                itemVal += (rem * (item.unitPrice || 0) * dur);
            }
            return sum + itemVal;
        }, 0);
    };

    // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å Request
    let used = 0;
    let pending = 0;
    let current = 0;

    requests.forEach(r => {
        if (r.job !== req.job || !['Local', 'HO'].includes(r.type)) return;
        
        const val = calculateValue(r);

        if (r.id === req.id) {
            current += val;
        } else if (r.status === 'Completed') {
            used += val;
        } else if (!['Draft', 'Rejected', 'Returned'].includes(r.status)) {
            pending += val;
        }
    });

    return { budget: totalBudget, used, pending, current };
};

  // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á URL ‡πÅ‡∏•‡∏∞ Base64)
// --- HELPER: FILE VIEWING (UPDATED) ---
  const handleViewFile = (fileData, fileName) => {
    if (!fileData) {
      showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå', 'error');
      return;
    }
    
    // üü¢ ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Object (‡∏°‡∏≤‡∏à‡∏≤‡∏Å Google Drive Upload)
    if (typeof fileData === 'object' && fileData.url) {
      window.open(fileData.url, '_blank');
      return;
    }

    // üü¢ ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô String
    if (typeof fileData === 'string') {
        // 2.1 ‡πÄ‡∏õ‡πá‡∏ô URL (http/https)
        if (fileData.startsWith('http')) {
            window.open(fileData, '_blank');
        } 
        // 2.2 ‡πÄ‡∏õ‡πá‡∏ô Base64 (‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ/PDF ‡∏ó‡∏µ‡πà‡∏ù‡∏±‡∏á‡∏°‡∏≤)
        else if (fileData.startsWith('data:') || fileData.includes('base64')) {
            const newWindow = window.open();
            if (newWindow) {
                newWindow.document.write(`
                    <html>
                    <head><title>${fileName || 'Document'}</title></head>
                    <body style="margin:0; background: #f0f0f0; display: flex; justify-content: center; height: 100vh;">
                        <iframe src="${fileData}" style="width:100%; height:100%; border:none;"></iframe>
                    </body>
                    </html>
                `);
            }
        } 
        // 2.3 ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á (Mock Data)
        else {
            showToast(`[Mock] ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå: ${fileData}`, 'info');
        }
    }
  };

  // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏• (Logic: True = ‡∏ú‡πà‡∏≤‡∏ô, False = ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô)
  const isVerificationPass = () => {
      const { checks } = verificationData;
      // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô True ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ú‡πà‡∏≤‡∏ô
      return checks.quotation && checks.email && checks.details;
  };

// --- LOGIC: UPDATE ASSET IMAGE (NEW) ---
      const handleUpdateImage = async (e) => {
          if (!e.target.files || e.target.files.length === 0) return;
          if (!viewingItem) return;

          const file = e.target.files[0];
          setIsLoading(true); // ‡∏´‡∏°‡∏∏‡∏ô‡πÜ ‡∏£‡∏≠

          try {
              const base64 = await fileToBase64(file);
              // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Server function ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
              const result = await new Promise((resolve, reject) => {
                  google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .uploadAssetImage(base64, file.name); 
              });

              if (result.error) throw new Error(result.error);

              // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô State (Assets ‡∏´‡∏£‡∏∑‡∏≠ Inventory)
              const date = new Date().toLocaleString('th-TH');
              const updatedItem = { 
                  ...viewingItem, 
                  image: result.name, // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                  lastUpdated: date 
              };

              // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô List ‡∏´‡∏•‡∏±‡∏Å
              if (viewingItem.serial !== undefined) {
                  // ‡πÄ‡∏õ‡πá‡∏ô Asset
                  setAssets(prev => prev.map(a => a.id === viewingItem.id ? updatedItem : a));
                  saveAssetToSheet(updatedItem);
              } else {
                  // ‡πÄ‡∏õ‡πá‡∏ô Inventory
                  setInventory(prev => prev.map(i => i.id === viewingItem.id ? updatedItem : i));
                  saveInventoryToSheet(updatedItem);
              }

              // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ
              addInvLog('Update Image', viewingItem.name, 'Photo', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î', [{name: result.name, type: 'image/jpeg'}]);

              // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà
              setViewingItem(updatedItem);
              setPreviewImage(null); // Reset preview ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
              
              showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

          } catch (err) {
              console.error(err);
              showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
          } finally {
              setIsLoading(false);
          }
      };

// --- LOGIC: VERIFICATION (FIXED & UPDATED) ---
const openVerificationModal = (reqId, isChangeMode = false) => { // ‚≠ê ‡∏£‡∏±‡∏ö param ‡πÄ‡∏û‡∏¥‡πà‡∏°
    const req = requests.find(r => r.id === reqId);
    if(!req) return;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Boolean)
    const hasQuotation = !!req.quotation;
    const hasEmail = !!req.attachment;
    
    setVerificationData({
        requestId: reqId,
        isChangeMode: isChangeMode, // ‚≠ê ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Local -> HO
        filesExist: { 
            quotation: hasQuotation, 
            email: hasEmail 
        },
        checks: { 
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÉ‡∏´‡πâ Default ‡πÄ‡∏õ‡πá‡∏ô False (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏≠‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á)
            // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ True
            quotation: hasQuotation ? true : (isChangeMode ? false : false), 
            email: hasEmail ? true : (isChangeMode ? false : false), 
            details: true 
        },

needApproval: req.isPreviouslyApproved ? false : !hasEmail, 
    
    needContract: req.purchaseType === 'Rent', 
    note: ''
    });
    
    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
    setShowVerificationModal(true);
};

// [‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleConfirmVerification ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ]

// [index.html] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleConfirmVerification (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1340)

const handleConfirmVerification = () => {
    const { requestId, needApproval, needContract, note, checks, filesExist, isChangeMode } = verificationData;
    const req = requests.find(r => r.id === requestId);
    if (!req) return;
    
    const actionBy = user ? `${user.empId} ${user.firstName} ${user.lastName}` : currentUserRole;
    let updatedReq = null;
    let toastMessage = '';
    let toastType = 'success';

// üî¥ 1. ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô" -> ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Revise Needed)
    if (!isVerificationPass()) {
         let failureReasons = [];
         if (!checks.quotation) failureReasons.push(filesExist.quotation ? "‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" : "‡∏Ç‡∏≤‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤");
         if (!checks.email) failureReasons.push(filesExist.email ? "‡πÄ‡∏°‡∏•‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" : "‡∏Ç‡∏≤‡∏î‡πÄ‡∏°‡∏•‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥");
         if (!checks.details) failureReasons.push("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
         const combinedNote = `‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${failureReasons.join(', ')} ${note ? `(‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${note})` : ''}`;
         
         if (isChangeMode) {
             // ‚≠ê‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô HO: ‡πÉ‡∏ä‡πâ handleUpdateStatus ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Backend ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç HPO ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
             // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Backend -> Backend ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç -> ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
             handleUpdateStatus(
                 req.id, 
                 'Revise Needed', 
                 combinedNote, 
                 [], 
                 { 
                     type: 'HO', 
                     // ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Backend ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà)
                     docNumber: null, 
                     isPreviouslyApproved: true 
                 }
             );
         } else {
             // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó): ‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
             updatedReq = { 
                 ...req, 
                 status: 'Revise Needed', 
                 history: [...req.history, createLog('Return for Revision', actionBy, combinedNote)] 
             };
             saveRequestToSheet(updatedReq);
             setRequests(prev => prev.map(r => r.id === updatedReq.id ? updatedReq : r));
             showToast('‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'error');
         }
    }
    // üü¢ 2. ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö "‡∏ú‡πà‡∏≤‡∏ô" (Pass)
    else {
         if (!filesExist.email && !needApproval) {
             showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏°‡∏•‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Level 1/Level 2 ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Full Flow)'", 'error');
             return; 
         }

        if (isChangeMode) {
    handleUpdateStatus(
        req.id, 
        'Approved', 
        `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô HO ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß: ${note}`, 
        [], 
        { 
            type: 'HO', 
            purchaseType: 'Buy', 
            needContract: needContract, 
            docNumber: null, // ‚≠ê ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            isPreviouslyApproved: true, 
            isFullApprovalFlow: true 
        }
    );


         }
         else if (needApproval) {
             
             handleUpdateStatus(
                 req.id, 
                 'Pending Head', 
                 `‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${note}`, 
                 [], 
                 { isFullApprovalFlow: true, needContract: needContract }
             );
         } 
         else {
             // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥: ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏¢
             handleUpdateStatus(
                 req.id, 
                 'Approved', 
                 `‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô: ${note}`, 
                 [], 
                 { needContract: needContract }
             );
         }
    }

    if (updatedReq) {
        showToast(toastMessage, toastType);
    }
    setShowVerificationModal(false);
};


      const handleChecklistChange = (field) => {
          setVerificationData(prev => ({...prev, checks: {...prev.checks, [field]: !prev.checks[field]}}));
      };
      





      const handleApprovalUpdate = (id, newStatus) => { handleUpdateStatus(id, newStatus); };


// --- LOGIC: RECEIVE GOODS (PARTIAL & ASSET) ---

  // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Calculate Remaining)
// --- LOGIC: RECEIVE GOODS (UPDATED MULTI-IMAGE) ---
  const openReceiveModal = (req) => {
      const defaultTarget = req.type === 'HO' ? 'Asset' : 'Inventory';
      
      const items = req.items.map(item => {
          const receivedSoFar = item.receivedTotal || 0;
          const remaining = Math.max(0, item.qty - receivedSoFar);
          
          // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Array ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢
          const assetsReg = Array.from({ length: remaining }, (_, i) => ({ 
              id: '', 
              isAutoId: false, 
              serial: '', 
              name: item.name, 
              note: '', 
              images: [], // ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å image: null ‡πÄ‡∏õ‡πá‡∏ô images: [] (Array)
              price: item.unitPrice, 
              rentalStart: '', 
              rentalEnd: '', 
              rentalPrice: req.purchaseType === 'Rent' ? item.unitPrice : 0, 
              rentalUnit: 'Month' 
          }));

const existingInv = inventory.find(inv => inv.name === item.name && inv.project === req.job);
          
          // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ: ‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤, ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡πä‡∏Å Auto
          // 3. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ: ‡∏£‡∏´‡∏±‡∏™‡∏ß‡πà‡∏≤‡∏á, ‡∏ï‡∏¥‡πä‡∏Å Auto ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
          const defaultInvId = existingInv ? getDisplayId(existingInv.id) : '';
          const defaultAuto = false;


    return { 
              ...item,
              originalName: item.name, 
              targetType: defaultTarget, 
              receiveImages: [], 
              assetsToRegister: assetsReg, 
              isRent: req.purchaseType === 'Rent', 
              receivedQty: remaining, 
              actualPrice: item.unitPrice, 
              orderedQty: item.qty,
              receivedSoFar: receivedSoFar,
              inventoryId: defaultInvId,
              isInvAutoId: defaultAuto,
              supplier: '' // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
          };
      });

      setReceiveItems(items);
      setIsForceClose(false);
      setSelectedRequest(req);
      setShowReceiveGoodsModal(true);
  };

// --- LOGIC: CONFIRM RECEIVE (FIXED: qtyToReceive Scope) ---
const handleConfirmReceive = async () => {
    if (!selectedRequest) return;

    setIsLoading(true);
    try {
        const date = new Date().toLocaleString('th-TH');
        const project = selectedRequest.job;
        
        // ‚≠ê ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° List ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Import)
        let currentInvList = [...inventory];
        let runNoCount = inventory.length;
        
        // ‚≠ê ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏±‡∏ö Asset ‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å Loop ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        let currentAssetCount = assets.length;

        for (const item of receiveItems) {
            // ‚≠ê [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
            if (item.receivedQty > 0 && !item.supplier) {
                alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${item.name}`);
                setIsLoading(false);
                return;
            }
            
            const qtyToReceive = item.receivedQty;

            if (item.targetType === 'Inventory') {
                
                // --- ‡∏™‡πà‡∏ß‡∏ô Upload Image (Inventory) ---
                let logImages = [];
                if (item.receiveImages && item.receiveImages.length > 0) {
                    const uploadPromises = item.receiveImages.map(imgObj => {
                        return new Promise((resolve, reject) => {
                           google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).uploadAssetImage(imgObj.base64, imgObj.name);
                        });
                    });
                    const uploaded = await Promise.all(uploadPromises);
                    logImages = uploaded.map(u => ({ name: u.name, type: 'image/jpeg', url: u.url }));
                }

                // const qtyToReceive = item.receivedQty; // ‚ùå ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
                const targetType = 'System'; // ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á = System ‡πÄ‡∏™‡∏°‡∏≠

                // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
                const existingIndex = currentInvList.findIndex(inv => 
                    inv.name === item.name && 
                    inv.project === project && 
                    (inv.stockType === targetType || (!inv.stockType && targetType === 'System'))
                );

                const existing = existingIndex !== -1 ? currentInvList[existingIndex] : null;
                const mainImageName = logImages.length > 0 ? logImages[0].name : (existing ? existing.image : null);

                if (existing) {
                    // ‚úÖ MERGE (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
                    const updatedInv = { 
                        ...existing, 
                        id: existing.id, 
                        qty: existing.qty + qtyToReceive, 
                        lastUpdated: date, 
                        image: mainImageName 
                    };
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï List ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    currentInvList[existingIndex] = updatedInv;
                    await saveInventoryToSheet(updatedInv);
                    
                    const fullNote = `‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${project} (System) | ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ${item.supplier}`;

    await addInvLog(
        'Stock In (Merge)', 
        item.name, 
        `+${qtyToReceive}`, 
        fullNote, // ‡πÉ‡∏ä‡πâ Note ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô
        logImages, 
        selectedRequest.id, 
        existing.id,
        { supplier: item.supplier } // ‡πÄ‡∏û‡∏¥‡πà‡∏° parameter ‡∏ô‡∏µ‡πâ
    );

                } else {
                    // ‚úÖ NEW ITEM (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏ï‡πâ‡∏≠‡∏á Gen ID)
                    let baseId = item.inventoryId; // ‡∏•‡∏≠‡∏á‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏£‡∏≠‡∏Å‡∏°‡∏≤‡πÑ‡∏´‡∏°
                    
                    if (item.isInvAutoId || !baseId) {
                        runNoCount++;
                        baseId = `INV-${String(runNoCount).padStart(3, '0')}`;
                        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô List ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                        while (currentInvList.some(inv => getDisplayId(inv.id) === baseId)) {
                            runNoCount++;
                            baseId = `INV-${String(runNoCount).padStart(3, '0')}`;
                        }
                    }

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÄ‡∏ï‡πá‡∏°
                    const finalInvId = `${baseId}|${project}|${targetType}`;

                    const newInv = { 
                        id: finalInvId, 
                        name: item.name, 
                        qty: qtyToReceive, 
                        unit: item.unit || '‡∏´‡∏ô‡πà‡∏ß‡∏¢', 
                        minStock: 0, 
                        price: item.actualPrice, 
                        lastUpdated: date, 
                        image: mainImageName,
                        project: project,
                        stockType: targetType
                    };
                    
                    currentInvList.push(newInv); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ List
                    await saveInventoryToSheet(newInv);


                    const fullNote = `‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${project} (System) | ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ${item.supplier}`;

    await addInvLog(
        'Stock In (New)', 
        item.name, 
        `Start: ${qtyToReceive}`, 
        fullNote, // ‡πÉ‡∏ä‡πâ Note ‡πÉ‡∏´‡∏°‡πà
        logImages, 
        selectedRequest.id, 
        finalInvId,
        { supplier: item.supplier } // ‡πÄ‡∏û‡∏¥‡πà‡∏° parameter ‡∏ô‡∏µ‡πâ
    );
                }
            }
             else {
                // --- ‡∏Å‡∏£‡∏ì‡∏µ Asset (‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô) ---
                // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ qtyToReceive ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                const assetsToProcess = item.assetsToRegister.slice(0, qtyToReceive);
                
                for (const assetReg of assetsToProcess) {
                    currentAssetCount++; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ô
                    
                    let assetLogImages = [];
                    // ... (Image Upload Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Asset) ...
                    if (assetReg.images && assetReg.images.length > 0) {
                        const uploadPromises = assetReg.images.map(imgObj => {
                            return new Promise((resolve, reject) => {
                                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).uploadAssetImage(imgObj.base64, imgObj.name);
                            });
                        });
                        const uploaded = await Promise.all(uploadPromises);
                        assetLogImages = uploaded.map(u => ({ name: u.name, type: 'image/jpeg', url: u.url }));
                    }

                    const assetId = assetReg.isAutoId 
                        ? `AST-${new Date().getFullYear().toString().slice(-2)}${(new Date().getMonth()+1).toString().padStart(2,'0')}-${String(currentAssetCount).padStart(3,'0')}` 
                        : assetReg.id;
                    const mainImageName = assetLogImages.length > 0 ? assetLogImages[0].name : null;
                    
                    const newAsset = { 
                        id: assetId,
                        name: assetReg.name,
                        serial: assetReg.serial,
                        status: 'Available',
                        condition: 'Good',
                        holder: '-',
                        currentRequestId: selectedRequest.id,
                        price: item.isRent ? 0 : assetReg.price,
                        image: mainImageName,
                        lastUpdated: date,
                        ownerType: item.isRent ? 'Rent' : 'Company',
                        rentalStart: assetReg.rentalStart || null,
                        rentalEnd: assetReg.rentalEnd || null,
                        rentalPrice: assetReg.rentalPrice || 0,
                        rentalUnit: assetReg.rentalUnit || 'Month',
                        duration: item.isRent ? (assetReg.duration || 1) : 1,
                        note: assetReg.note,
                        project: project // ‚≠ê ‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                    };
                    setAssets(prev => [...prev, newAsset]);
                    saveAssetToSheet(newAsset);


                    const logAction = `‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${project} | ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ${item.supplier}`;

        addInvLog(
            'Register Asset', 
            newAsset.name, 
            'New', 
            logAction, // ‡πÉ‡∏ä‡πâ Action note ‡πÉ‡∏´‡∏°‡πà
            assetLogImages, 
            selectedRequest.id, 
            assetId,
            { supplier: item.supplier } // ‡πÄ‡∏û‡∏¥‡πà‡∏° parameter ‡∏ô‡∏µ‡πâ
        );
                }
            }
        } 

const updatedItems = selectedRequest.items.map(originalItem => {
    const receivingItem = receiveItems.find(ri => ri.originalName === originalItem.name);
    if (receivingItem && receivingItem.receivedQty > 0) {
            
            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πà‡∏≠‡∏¢
            const newLog = {
                date: new Date().toLocaleString('th-TH'),
                qty: receivingItem.receivedQty,
                price: receivingItem.actualPrice,
                duration: receivingItem.duration || 1
            };

            // 2. ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
            const prevLogs = originalItem.receivedLog || [];

            return { 
                ...originalItem, 
                receivedTotal: (originalItem.receivedTotal || 0) + receivingItem.receivedQty,
                receivedLog: [...prevLogs, newLog] // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡∏•‡∏á Item
            };
    }
    return originalItem;
});

        const allComplete = updatedItems.every(item => (item.receivedTotal || 0) >= item.qty);
        let newStatus = 'Completed';
        if (!allComplete && !isForceClose) newStatus = 'Partially Received';

        const updatedReq = { 
             ...selectedRequest, 
             items: updatedItems,
             status: newStatus,
             history: [...selectedRequest.history, createLog(STATUS_LABELS[newStatus] || newStatus, `${user.empId} ${user.firstName}`, `‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${newStatus})`)]
        };
        await saveRequestToSheet(updatedReq);
        setRequests(prev => prev.map(r => r.id === updatedReq.id ? updatedReq : r));
        setInventory(currentInvList); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Inventory State ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

        setIsLoading(false);
        setShowReceiveGoodsModal(false);
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    } catch (error) {
        setIsLoading(false);
        console.error(error);
        showToast("Error: " + error.message, 'error');
    }
};
      // --- Helper: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö) ---
      
      // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Inventory ‡πÅ‡∏•‡∏∞ Asset ‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß)
      const handleReceiveImageSelect = async (e, itemIdx, assetIdx = null) => {
          if (!e.target.files || e.target.files.length === 0) return;
          
          // ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
          const files = Array.from(e.target.files);
          const newImages = await Promise.all(files.map(file => new Promise(resolve => {
              const reader = new FileReader();
              reader.onload = (x) => resolve({ base64: x.target.result, file, name: file.name });
              reader.readAsDataURL(file);
          })));

          setReceiveItems(prev => {
              const newData = [...prev];
              if (assetIdx === null) {
                  // ‡∏Å‡∏£‡∏ì‡∏µ: Inventory (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤ Array ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
                  const current = newData[itemIdx].receiveImages || [];
                  newData[itemIdx].receiveImages = [...current, ...newImages];
              } else {
                  // ‡∏Å‡∏£‡∏ì‡∏µ: Asset ‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß
                  const current = newData[itemIdx].assetsToRegister[assetIdx].images || [];
                  newData[itemIdx].assetsToRegister[assetIdx].images = [...current, ...newImages];
              }
              return newData;
          });
          
          e.target.value = ''; // Reset input
      };

      // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏π‡∏õ
      const handleRemoveReceiveImage = (itemIdx, imgIdx, assetIdx = null) => {
          setReceiveItems(prev => {
              const newData = [...prev];
              if (assetIdx === null) {
                  // ‡∏•‡∏ö‡∏£‡∏π‡∏õ Inventory
                  newData[itemIdx].receiveImages = newData[itemIdx].receiveImages.filter((_, i) => i !== imgIdx);
              } else {
                  // ‡∏•‡∏ö‡∏£‡∏π‡∏õ Asset
                  newData[itemIdx].assetsToRegister[assetIdx].images = newData[itemIdx].assetsToRegister[assetIdx].images.filter((_, i) => i !== imgIdx);
              }
              return newData;
          });
      };    


// --- Helper: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠" (tempItem) ---
      const handleTempItemImageSelect = async (e) => {
          if (!e.target.files || e.target.files.length === 0) return;
          
          const files = Array.from(e.target.files);
          const newImages = await Promise.all(files.map(file => new Promise(resolve => {
              const reader = new FileReader();
              reader.onload = (x) => resolve({ base64: x.target.result, file, name: file.name });
              reader.readAsDataURL(file);
          })));

          setTempItem(prev => ({
              ...prev,
              images: [...(prev.images || []), ...newImages]
          }));
          
          e.target.value = ''; // Reset input
      };

      const handleRemoveTempItemImage = (index) => {
          setTempItem(prev => ({
              ...prev,
              images: prev.images.filter((_, i) => i !== index)
          }));
      };

      // --- LOGIC: OPEN DISBURSE MODAL (UPDATED: SPLIT STOCK) ---
// --- LOGIC: OPEN DISBURSE MODAL (UPDATED: REJECT & PARTIAL) ---
const openDisburseModal = (reqId) => {
    const req = requests.find(r => r.id === reqId);
    if (!req) return;

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    const itemsWithSplit = req.items.map(item => {
        // 1. ‡∏´‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å "‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" (System)
        const sysStock = inventory.find(i => 
            i.name === item.name && 
            i.project === req.job && 
            (i.stockType === 'System' || !i.stockType)
        );
        
        // 2. ‡∏´‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å "‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö" (NonSystem)
        const nonStock = inventory.find(i => 
            i.name === item.name && 
            i.project === req.job && 
            i.stockType === 'NonSystem'
        );

        const sysQtyAvailable = sysStock ? sysStock.qty : 0;
        const nonQtyAvailable = nonStock ? nonStock.qty : 0;

        // 3. Logic: Default ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î "‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" ‡∏Å‡πà‡∏≠‡∏ô
        let useSys = 0;
        let useNon = 0;

        if (sysQtyAvailable >= item.qty) {
            useSys = item.qty;
        } else {
            useSys = sysQtyAvailable;
            const needed = item.qty - useSys;
            useNon = Math.min(needed, nonQtyAvailable);
        }

        return {
            ...item,
            sysStockId: sysStock ? sysStock.id : null,
            nonStockId: nonStock ? nonStock.id : null,
            sysAvailable: sysQtyAvailable,
            nonAvailable: nonQtyAvailable,
            useSys: useSys,
            useNon: useNon,
            // ‚≠ê ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Checkbox ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
            isRejected: false,
            rejectReason: ''
        };
    });

    setDisburseItems(itemsWithSplit);
    setDisburseData({ requestId: reqId, note: '', images: [] });
    setShowDisburseModal(true);
};


      
      // --- HELPER: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á (Disburse) ---
const handleDisburseImageSelect = async (e) => {
    if (!e.target.files || e.target.files.length === 0) return;
    const files = Array.from(e.target.files);
    const newImages = await Promise.all(files.map(file => new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = (x) => resolve({ base64: x.target.result, file, name: file.name });
        reader.readAsDataURL(file);
    })));
    setDisburseData(prev => ({
        ...prev,
        images: [...(prev.images || []), ...newImages]
    }));
    e.target.value = ''; // Reset input
};

const handleRemoveDisburseImage = (index) => {
    setDisburseData(prev => ({
        ...prev,
        images: prev.images.filter((_, i) => i !== index)
    }));
};

// --- LOGIC: CONFIRM DISBURSE (UPDATED: SAVE REJECT INFO TO ITEM) ---
const handleConfirmDisburse = async () => {
    const req = requests.find(r => r.id === disburseData.requestId);
    if (!req) return;

    // --- Validation 1: ‡∏´‡πâ‡∏≤‡∏°‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ ---
    if (req.type === 'Withdraw') {
        const overQtyItems = disburseItems.filter(item => !item.isRejected && (item.useSys + item.useNon) > item.qty);
        if (overQtyItems.length > 0) {
            const msg = overQtyItems.map(i => `- ${i.name}: ‡∏Ç‡∏≠ ${i.qty} ‡πÅ‡∏ï‡πà‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° ${i.useSys + i.useNon}`).join('\n');
            alert(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô" ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠:\n\n${msg}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
            return;
        }

        // --- Validation 2: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≠‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å ---
        const overStockItems = [];
        disburseItems.forEach(item => {
            if (!item.isRejected) {
                if (item.useSys > item.sysAvailable) overStockItems.push(`- ${item.name} (‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö): ‡∏Å‡∏£‡∏≠‡∏Å ${item.useSys} / ‡∏°‡∏µ ${item.sysAvailable}`);
                if (item.useNon > item.nonAvailable) overStockItems.push(`- ${item.name} (‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö): ‡∏Å‡∏£‡∏≠‡∏Å ${item.useNon} / ‡∏°‡∏µ ${item.nonAvailable}`);
            }
        });

        if (overStockItems.length > 0) {
            alert(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:\n\n${overStockItems.join('\n')}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
            return;
        }
    }

    // --- Validation 3: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡πä‡∏Å "‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏¥‡∏Å" ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• ---
    const missingReason = disburseItems.filter(item => item.isRejected && !item.rejectReason.trim());
    if (missingReason.length > 0) {
        alert(`‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏°:\n\n${missingReason.map(i => `- ${i.name}`).join('\n')}`);
        return;
    }

    // --- Confirm Dialog ---
    if (req.type === 'Withdraw') {
        const shortItems = disburseItems.filter(item => !item.isRejected && (item.useSys + item.useNon) < item.qty);
        if (shortItems.length > 0) {
            if (!confirm(`‚ö†Ô∏è ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà "‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö" ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠ (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á):\n\n‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
        }
    }

    setIsLoading(true);
    try {
        // Upload Images
        let logImages = [];
        if (disburseData.images && disburseData.images.length > 0) {
            const uploadPromises = disburseData.images.map(imgObj => {
                return new Promise((resolve, reject) => {
                    google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).uploadAssetImage(imgObj.base64, imgObj.name);
                });
            });
            const uploaded = await Promise.all(uploadPromises);
            logImages = uploaded.map(u => ({ name: u.name, type: 'image/jpeg', url: u.url }));
        }

        let logDetails = [];

        // 1. Process Logic (Withdraw / Borrow)
        if (req.type === 'Withdraw') {
            const currentInv = [...inventory];
            for (const item of disburseItems) {
                if (item.isRejected) {
                    logDetails.push(`‚ùå ${item.name}: ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏¥‡∏Å [‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${item.rejectReason}]`);
                    continue;
                }
                let itemLogParts = [];
                // ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å (System/NonSystem) ... (Logic ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
                if (item.useSys > 0 && item.sysStockId) {
                    const targetIdx = currentInv.findIndex(i => i.id === item.sysStockId);
                    if (targetIdx !== -1) {
                        const updated = { ...currentInv[targetIdx], qty: Math.max(0, currentInv[targetIdx].qty - item.useSys), lastUpdated: new Date().toLocaleString('th-TH') };
                        currentInv[targetIdx] = updated;
                        await new Promise(r => google.script.run.withSuccessHandler(r).syncInventory(updated));
                        await addInvLog('Withdraw', item.name, `-${item.useSys}`, `‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á (‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö) Ref: ${req.docNumber || req.id}`, [], req.id, item.sysStockId);
                        itemLogParts.push(`‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ${item.useSys}`);
                    }
                }
                if (item.useNon > 0 && item.nonStockId) {
                    const targetIdx = currentInv.findIndex(i => i.id === item.nonStockId);
                    if (targetIdx !== -1) {
                        const updated = { ...currentInv[targetIdx], qty: Math.max(0, currentInv[targetIdx].qty - item.useNon), lastUpdated: new Date().toLocaleString('th-TH') };
                        currentInv[targetIdx] = updated;
                        await new Promise(r => google.script.run.withSuccessHandler(r).syncInventory(updated));
                        await addInvLog('Withdraw', item.name, `-${item.useNon}`, `‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á (‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö) Ref: ${req.docNumber || req.id}`, [], req.id, item.nonStockId);
                        itemLogParts.push(`‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö: ${item.useNon}`);
                    }
                }
                const totalPaid = (item.useSys || 0) + (item.useNon || 0);
                logDetails.push(`‚úÖ ${item.name} (‡∏Ç‡∏≠ ${item.qty} | ‡∏à‡πà‡∏≤‡∏¢ ${totalPaid}) [${itemLogParts.join(', ')}]`);
            }
            setInventory(currentInv);
            const finalNote = `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á:\n` + logDetails.join('\n') + (disburseData.note ? `\nNote: ${disburseData.note}` : '');
            await addInvLog('Withdraw', 'Multiple Items', 'Out', finalNote, logImages, req.id);

        } else if (req.type === 'Borrow') {
            const targetAssetsMap = new Map();
            req.items.forEach((item, idx) => {
                const dItem = disburseItems[idx];
                if (item.assetId && !dItem.isRejected) targetAssetsMap.set(item.assetId, item);
            });
            const updatedAssets = assets.map(asset => {
                if (targetAssetsMap.has(asset.id)) return { ...asset, status: 'Borrowed', holder: req.requester, currentRequestId: req.id, lastUpdated: new Date().toLocaleString('th-TH'), image: logImages.length > 0 ? logImages[0].name : asset.image };
                return asset;
            });
            for (let i = 0; i < disburseItems.length; i++) {
                const dItem = disburseItems[i];
                if (dItem.isRejected) logDetails.push(`‚ùå ${dItem.name}: ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏° [‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${dItem.rejectReason}]`);
                else {
                    const asset = updatedAssets.find(a => a.id === dItem.assetId);
                    if (asset) {
                        await new Promise(r => google.script.run.withSuccessHandler(r).syncAsset(asset));
                        await addInvLog('Borrow', asset.name, 'Out', `‡∏¢‡∏∑‡∏°‡πÇ‡∏î‡∏¢ ${req.requester}`, logImages, req.id, asset.id);
                        logDetails.push(`‚úÖ ${dItem.name}: ‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                    }
                }
            }
            setAssets(updatedAssets);
            const finalNote = `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°:\n` + logDetails.join('\n') + (disburseData.note ? `\nNote: ${disburseData.note}` : '');
            await addInvLog('Borrow', 'Multiple Items', 'Out', finalNote, logImages, req.id);
        }

        // ‚≠ê 4. Update Request Status & Save Item Info (Rejected & Qty)
        const updatedItems = req.items.map((item, idx) => {
            const dItem = disburseItems[idx];
            let totalPaid = 0;
            if (dItem.isRejected) totalPaid = 0;
            else if (req.type === 'Withdraw') totalPaid = (dItem.useSys || 0) + (dItem.useNon || 0);
            else totalPaid = item.qty;

            return { 
                ...item, 
                receivedTotal: totalPaid,
                // ‚≠ê ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Reject ‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô Item
                isItemRejected: dItem.isRejected || false,
                rejectReason: dItem.isRejected ? dItem.rejectReason : null
            };
        });

        handleUpdateStatus(req.id, 'Completed', `‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á/‡∏¢‡∏∑‡∏°‡∏Ç‡∏≠‡∏á`, logImages, { items: updatedItems });
        
        setShowDisburseModal(false);
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

    } catch (err) {
        console.error(err);
        showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message, 'error');
    } finally {
        setIsLoading(false);
    }
};

      const openRejectModal = (reqId) => { setRejectData({ requestId: reqId, reason: '' }); setShowRejectModal(true); };
      const handleConfirmReject = () => { handleUpdateStatus(rejectData.requestId, 'Rejected', `‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${rejectData.reason}`); setShowRejectModal(false); showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); };

// --- Helper: Update Status & History (SECURE VERSION) ---
      const handleUpdateStatus = async (id, newStatus, note = '', images = [], extraUpdates = null) => {
        setIsLoading(true); // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
        
        const userSignature = `${user.empId} ${user.firstName} ${user.lastName}`;
        const logObj = createLog(STATUS_LABELS[newStatus] || newStatus, userSignature, note, images);

        try {
            // ‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà Backend
            const result = await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .updateStatusSecurely(id, newStatus, logObj, extraUpdates);
            });

            if (result.success) {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Server (‡∏ó‡∏µ‡πà‡∏°‡∏µ Doc No. ‡πÅ‡∏•‡πâ‡∏ß)
                const updatedReq = result.request;
                
                setRequests(prev => prev.map(r => r.id === id ? updatedReq : r));
                if (selectedRequest && selectedRequest.id === id) setSelectedRequest(updatedReq);
                
                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                const docMsg = updatedReq.docNumber ? ` (‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${updatedReq.docNumber})` : '';
                showToast(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢${docMsg}`);
            } else {
                showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.message}`, 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Error: ' + err.message, 'error');
        } finally {
            setIsLoading(false); // ‡∏õ‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î
        }
      };

      const openPRModal = (id) => { setPrData({ requestId: id, file: null, prNumber: '' }); setShowPRModal(true); };


      // --- LOGIC: SUPER ADMIN ROLLBACK ---
const handleSuperRollbackConfirm = async () => {
    if (!rollbackTarget) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á', 'error'); return; }
    if (!rollbackReason) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•', 'error'); return; }

    if (!confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Rollback?\n\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞:\n1. ‡∏î‡∏∂‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≤‡∏Å‡∏™‡∏ï‡πá‡∏≠‡∏Å/‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß)\n2. ‡∏•‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà\n3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`)) return;

    setIsLoading(true);
    const adminInfo = `${user.empId} ${user.firstName} ${user.lastName}`;

    try {
        const result = await new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .processSuperAdminRollback(selectedRequest.id, rollbackTarget, rollbackReason, adminInfo);
        });

        if (result.success) {
            showToast(result.message);
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            setRequests(prev => prev.map(r => r.id === result.request.id ? result.request : r));
            setSelectedRequest(result.request);
            setShowSuperRollbackModal(false);
            setRollbackReason('');
            
            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Inventory/Assets ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á
            handleRefresh(); 
        } else {
            showToast(result.message, 'error');
        }
    } catch (err) {
        console.error(err);
        showToast('Error: ' + err.message, 'error');
    } finally {
        setIsLoading(false);
    }
};


const handleSubmitPR = async () => { 
        if (!prData.prNumber && !prData.file) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå', 'error'); return; }
        
        setIsLoading(true); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î
        let uploadedFile = null;

        try {
            // 1. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (prData.file) {
                const base64 = await fileToBase64(prData.file);
                const result = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .uploadFileToDrive(base64, prData.file.name);
                });
                
                if (result.error) throw new Error(result.error);
                uploadedFile = result; // ‡πÑ‡∏î‡πâ object {name, url, id} ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            }

            const note = `PR: ${prData.prNumber}`;
            
            // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
setRequests(prev => prev.map(r => {
                if (r.id === prData.requestId) {
                    const updatedReq = { 
                        ...r, 
                        status: 'PR Issued', 
                        prFile: uploadedFile || r.prFile,
                        prNumber: prData.prNumber,
                        // ‚≠ê ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                        history: [...r.history, createLog('PR Issued', `${user.empId} ${user.firstName} ${user.lastName}`, note)] 
                    };
                    saveRequestToSheet(updatedReq);
                    return updatedReq;
                }
                return r;
            }));

            setShowPRModal(false); 
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PR ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

        } catch (err) {
            console.error(err);
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î: ' + err.message, 'error');
        } finally {
            setIsLoading(false);
        }
      };

      const openPOModal = (id) => { setPoData({ requestId: id, file: null, poNumber: '' }); setShowPOModal(true); };

// --- LOGIC: ISSUE PO (UPDATED: Upload File) ---
      const handleSubmitPO = async () => { 
        if (!poData.poNumber && !poData.file) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå', 'error'); return; }
        
        setIsLoading(true); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î
        let uploadedFile = null;

        try {
            // 1. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (poData.file) {
                const base64 = await fileToBase64(poData.file);
                const result = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .uploadFileToDrive(base64, poData.file.name);
                });

                if (result.error) throw new Error(result.error);
                uploadedFile = result; // ‡πÑ‡∏î‡πâ object {name, url, id} ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            }

            const note = `PO: ${poData.poNumber}`;
            
            // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
setRequests(prev => prev.map(r => {
                if (r.id === poData.requestId) {
                    const updatedReq = { 
                        ...r, 
                        status: 'PO Issued', 
                        poFile: uploadedFile || r.poFile,
                        poNumber: poData.poNumber,
                        // ‚≠ê ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                        history: [...r.history, createLog('PO Issued', `${user.empId} ${user.firstName} ${user.lastName}`, note)] 
                    };
                    saveRequestToSheet(updatedReq); 
                    return updatedReq;
                }
                return r;
}));
            setShowPOModal(false); 
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PO ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

        } catch (err) {
            console.error(err);
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î: ' + err.message, 'error');
        } finally {
            setIsLoading(false);
        }
      };

      // --- LOGIC: CONTRACT SIGNED (With File Upload) ---
const openContractModal = (id) => { 
    setContractData({ requestId: id, file: null });
    setShowContractModal(true); 
};

const handleSubmitContract = async () => {
    setIsLoading(true);
    let uploadedFile = null;
    try {
        // 1. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (contractData.file) {
            const base64 = await fileToBase64(contractData.file);
            const result = await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .uploadFileToDrive(base64, contractData.file.name);
            });
            if (result.error) throw new Error(result.error);
            uploadedFile = result;
        }

        const note = uploadedFile ? `‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤: ${uploadedFile.name}` : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß';
        const userSignature = `${user.empId} ${user.firstName} ${user.lastName}`;

        // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        setRequests(prev => prev.map(r => {
            if (r.id === contractData.requestId) {
                const updatedReq = { 
                    ...r, 
                    status: 'Contract Signed', 
                    contractFile: uploadedFile || r.contractFile, // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤
                    history: [...r.history, createLog('Contract Signed', userSignature, note)] 
                };
                saveRequestToSheet(updatedReq); 
                return updatedReq;
            }
            return r;
        }));

        setShowContractModal(false); 
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    } catch (err) {
        console.error(err);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
    } finally {
        setIsLoading(false);
    }
};

      const openViewItem = (item) => { setViewingItem(item); setHistoryFilterItem(null); setHistorySearch(''); setShowItemDetailModal(true); };
      const openGeneralHistory = () => { setViewingItem(null); setHistoryFilterItem(null); setHistorySearch(''); setShowItemDetailModal(true); }
      const openImagePreview = (imageName) => { setPreviewImage(imageName); };
      const handleCardClick = (status) => { if (dashboardStatusFilter === status) setDashboardStatusFilter('All'); else setDashboardStatusFilter(status); };
      const handlePrint = () => { window.print(); };
      const openPOPreview = (req) => { setSelectedRequest(req); setShowPOPreviewModal(true); };

   // --- LOGIC: Dashboard Stats (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó) ---
const dashboardStats = useMemo(() => {
    // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° && r.status !== 'Cancelled' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏ö‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    let activeRequests = requests.filter(r => r.status !== 'Draft' && r.status !== 'Cancelled'); 
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Project ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    if (globalProjectFilter !== 'All') {
        activeRequests = activeRequests.filter(r => r.job === globalProjectFilter);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
    return {
        total: activeRequests.length,
        pending: activeRequests.filter(r => r.status.includes('Pending') || r.status === 'PR Issued' || r.status === 'Approved' || r.status === 'Revise Needed' || r.status === 'Contract Pending').length,
        processing: activeRequests.filter(r => ['Ordered', 'PO Issued', 'Shipping', 'Ready to Disburse', 'Contract Signed', 'Partially Received'].includes(r.status)).length,
        ready: activeRequests.filter(r => r.status === 'Ready to Disburse').length,
        completed: activeRequests.filter(r => r.status === 'Completed' || r.status === 'Returned').length
    };
}, [requests, globalProjectFilter]);

    // --- LOGIC: Dashboard Requests List (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó) ---
const dashboardRequests = useMemo(() => {
    let data = requests.filter(r => r.status !== 'Draft' && r.status !== 'Cancelled');

    // 1. ‡∏Å‡∏£‡∏≠‡∏á Project (Global)
    if (globalProjectFilter !== 'All') {
        data = data.filter(r => r.job === globalProjectFilter);
    }

    // ‚ùå ‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Purchase/Withdraw ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î)

    // 2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    if (dashboardSearch) { 
        const lowerQ = dashboardSearch.toLowerCase(); 
        data = data.filter(r => 
            r.id.toLowerCase().includes(lowerQ) || 
            r.items.some(i => i.name.toLowerCase().includes(lowerQ)) || 
            (r.docNumber && r.docNumber.toLowerCase().includes(lowerQ)) || 
            r.requester.toLowerCase().includes(lowerQ) || 
            (STATUS_LABELS[r.status] || r.status).toLowerCase().includes(lowerQ)
        ); 
    }

    // 3. ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    if (dashboardStatusFilter !== 'All') {
       if (dashboardStatusFilter === 'Pending') data = data.filter(r => r.status.includes('Pending') || r.status === 'PR Issued' || r.status === 'Approved' || r.status === 'Revise Needed' || r.status === 'Contract Pending');
       else if (dashboardStatusFilter === 'Processing') data = data.filter(r => ['Ordered', 'PO Issued', 'Shipping', 'Ready to Disburse', 'Contract Signed', 'Partially Received'].includes(r.status));
       else if (dashboardStatusFilter === 'Ready') data = data.filter(r => r.status === 'Ready to Disburse');
       else if (dashboardStatusFilter === 'Completed') data = data.filter(r => r.status === 'Completed' || r.status === 'Returned');
    }
    return data;
}, [requests, dashboardSearch, dashboardStatusFilter, globalProjectFilter]); // ‡∏•‡∏ö dashboardView ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å dependency

// --- LOGIC: BUDGET CHART DATA PREPARATION (FIXED: PROJECT SCOPE) ---
      const budgetChartData = useMemo(() => {
          let targetProjects = projects;
          if (globalProjectFilter !== 'All') {
              targetProjects = projects.filter(p => p.name === globalProjectFilter);
          }

          // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á (Used) ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏∏ Project
          const calculateUsedForProject = (projectName, code, type) => {
              return requests.reduce((sum, req) => {
                  // ‚≠ê 1. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Request ‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Double Count)
                  if (req.job !== projectName) return sum;
                  
                  if (!['Local', 'HO'].includes(req.type)) return sum;
                  
                  // ‡∏Ñ‡∏¥‡∏î‡∏á‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà "Completed" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                  if (req.status !== 'Completed') return sum; 

                  const isRent = req.type === 'HO' && req.purchaseType === 'Rent';
                  const items = req.items.filter(i => (type === 'SubJob' ? i.subJob : i.matCode) === code);

                  const reqTotal = items.reduce((iSum, item) => {
                      // Logic ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Assets > Logs > Estimate)
                      const relatedAssets = assets.filter(a => a.currentRequestId === req.id && a.name === item.name);
                      const receivedLogs = item.receivedLog || [];
                      
                      let itemVal = 0;
                      let cnt = 0;

                      // A. Assets
                      if (relatedAssets.length > 0) {
                          itemVal += relatedAssets.reduce((s, asset) => {
                               const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                               const duration = isRent ? (asset.duration || item.duration || 1) : 1;
                               return s + (price * duration);
                          }, 0);
                          cnt = relatedAssets.length;
                      } 
                      // B. Logs
                      else if (receivedLogs.length > 0) {
                          itemVal += receivedLogs.reduce((s, log) => {
                               const duration = isRent ? (log.duration || 1) : 1;
                               return s + (log.qty * log.price * duration);
                          }, 0);
                          cnt = item.receivedTotal || 0;
                      }

                      // C. Estimate
                      // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà] ‡∏ñ‡πâ‡∏≤‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡∏¢‡∏≠‡∏î Estimate ‡πÄ‡∏û‡∏¥‡πà‡∏° (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Completed ‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Used ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
                      if (req.status !== 'Completed') {
                          const rem = Math.max(0, item.qty - cnt);
                          const dur = isRent ? (item.duration || 1) : 1;
                          itemVal += (rem * (item.unitPrice || 0) * dur);
                      }
                      
                      return iSum + itemVal;
                  }, 0);

                  return sum + reqTotal;
              }, 0);
          };

          // 1. SubJob Data
          const subJobData = [];
          targetProjects.forEach(p => {
              (p.subJobs || []).forEach(sj => {
                  const existing = subJobData.find(x => x.code === sj.code);
                  // ‚≠ê ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (p.name) ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡πâ‡∏ß‡∏¢
                  const used = calculateUsedForProject(p.name, sj.code, 'SubJob'); 
                  
                  if (existing) {
                      existing.budget += (sj.budget || 0);
                      existing.used += used; 
                  } else {
                      // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° group: sj.group || 'Others'
                      subJobData.push({ code: sj.code, budget: sj.budget || 0, used: used, group: sj.group || 'Others' });
                  }
              });
          });

          // 2. Mat. Code Data
          const matCodeData = [];
          targetProjects.forEach(p => {
              (p.matCodes || []).forEach(ep => {
                  const existing = matCodeData.find(x => x.code === ep.code);
                  // ‚≠ê ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (p.name) ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡πâ‡∏ß‡∏¢
                  const used = calculateUsedForProject(p.name, ep.code, 'matCode');
                  
                  if (existing) {
                      existing.budget += (ep.budget || 0);
                      existing.used += used;
                  } else {
                      // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° group: ep.group || 'Others'
                      matCodeData.push({ code: ep.code, budget: ep.budget || 0, used: used, group: ep.group || 'Others' });
                  }
              });
          });

        subJobData.sort((a,b) => a.code.localeCompare(b.code));
          matCodeData.sort((a,b) => a.code.localeCompare(b.code));

        // ‚≠ê 3. Project Summary (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ All Projects)
          const projectSummary = projects.map(p => {
              let pBudget = 0;
              let pUsed = 0;
              
              // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡πÅ‡∏¢‡∏Å
              let subBudget = 0;
              let subUsed = 0;
              let matBudget = 0;
              let matUsed = 0;

              // ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î SubJob
              (p.subJobs || []).forEach(sj => {
                  const b = (sj.budget || 0);
                  const u = calculateUsedForProject(p.name, sj.code, 'SubJob');
                  
                  pBudget += b;
                  pUsed += u;
                  
                  // ‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡πÅ‡∏¢‡∏Å SubJob
                  subBudget += b;
                  subUsed += u;
              });

              // ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î matCode
              (p.matCodes || []).forEach(ep => {
                  const b = (ep.budget || 0);
                  const u = calculateUsedForProject(p.name, ep.code, 'matCode');
                  
                  pBudget += b;
                  pUsed += u;
                  
                  // ‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡πÅ‡∏¢‡∏Å MatCode
                  matBudget += b;
                  matUsed += u;
              });

              return { 
                  id: p.id, 
                  name: p.name, 
                  budget: pBudget, 
                  used: pUsed,
                  // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                  subBudget, subUsed,
                  matBudget, matUsed
              };
          }).sort((a, b) => b.budget - a.budget);

          return { subJobData, matCodeData, projectSummary };
      }, [projects, requests, globalProjectFilter, assets]);
// --- HELPER: ‡πÅ‡∏õ‡∏•‡∏á Google Drive URL ‡πÄ‡∏õ‡πá‡∏ô Image Link ---
      const getDriveImageUrl = (src) => {
          if (!src) return null;
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Base64 ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢
          if (src.startsWith('data:') || src.startsWith('blob:')) return src;
          
          // ‡∏î‡∏∂‡∏á ID ‡∏à‡∏≤‡∏Å Google Drive URL
          let id = null;
          if (src.includes('/file/d/')) {
              id = src.split('/file/d/')[1].split('/')[0];
          } else if (src.includes('id=')) {
              id = src.split('id=')[1].split('&')[0];
          }

          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ ID ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå Thumbnail
          if (id) return `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
          
          return src; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Google Drive ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
      };

      // --- HELPER: ‡πÅ‡∏õ‡∏•‡∏á Google Drive URL ‡πÄ‡∏õ‡πá‡∏ô Download Link ---
      const getDownloadUrl = (url) => {
          if (!url) return null;
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Base64 ‡∏´‡∏£‡∏∑‡∏≠ Blob ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° (‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
          if (url.startsWith('data:') || url.startsWith('blob:')) return url;
          
          // ‡∏î‡∏∂‡∏á ID ‡∏à‡∏≤‡∏Å Google Drive URL
          let id = null;
          if (url.includes('/file/d/')) {
              id = url.split('/file/d/')[1].split('/')[0];
          } else if (url.includes('id=')) {
              id = url.split('id=')[1].split('&')[0];
          }

          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ ID ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå Download
          if (id) return `https://drive.google.com/uc?export=download&id=${id}`;
          
          return url; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Google Drive ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
      };

      // --- RENDER ---
// ‚≠ê 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Login (‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á requests ‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)

const PublicAnnouncementPopup = () => (
        showPublicAnnounce && publicAnnounces.length > 0 && (
            <div className="fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-300">
                <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden border-t-8 border-indigo-600 animate-in zoom-in-95 flex flex-col max-h-[90vh]">
                    
                    {/* Header */}
                    <div className="p-6 pb-2 text-center shrink-0">
                        <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                            <Megaphone className="w-8 h-8 animate-bounce" />
                        </div>
                        <h2 className="text-2xl font-extrabold text-gray-800">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</h2>
                        <p className="text-gray-500 text-xs mt-1">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</p>
                    </div>

                    {/* Scrollable Content Area */}
                    <div className="px-6 py-2 overflow-y-auto space-y-4 custom-scrollbar">
                        {publicAnnounces.map((item, idx) => (
                            <div key={idx} className="bg-slate-50 border border-slate-200 rounded-xl p-4 shadow-sm">
                                <h3 className="font-bold text-lg text-indigo-700 mb-2">{item.title}</h3>
                                <div className="text-sm text-gray-600 whitespace-pre-wrap leading-relaxed">
                                    {item.detail}
                                </div>
                                <div className="mt-3 pt-3 border-t border-slate-200 flex justify-between items-center text-[10px] text-gray-400">
                                    <span>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏°‡∏∑‡πà‡∏≠: {item.timestamp}</span>
                                    <span>‡πÇ‡∏î‡∏¢: {item.updatedBy}</span>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Footer Close Button */}
                    <div className="p-6 shrink-0">
                        <button 
                            onClick={() => setShowPublicAnnounce(false)}
                            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition-all active:scale-95 flex items-center justify-center gap-2"
                        >
                            ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö / ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö <ArrowRight className="w-5 h-5"/>
                        </button>
                    </div>
                </div>
            </div>
        )
      );

      
      
      if (isLoading) {
         return (
             <div className="flex h-screen items-center justify-center bg-gray-50">
                 <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
             </div>
         );
      }
      
// ‚≠ê ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Error ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      if (isError) {
         return (
             <div className="flex h-screen flex-col items-center justify-center bg-gray-50 p-6 text-center">
                 <div className="bg-red-100 p-4 rounded-full mb-4">
                     <AlertCircle className="w-10 h-10 text-red-600" />
                 </div>
                 <h2 className="text-xl font-bold text-gray-800 mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                 <p className="text-gray-500 mb-6 max-w-md text-sm">{errorMessage}</p>
                 
                 <button 
                    onClick={() => window.location.reload()} // ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å handleRefresh() ‡∏ñ‡πâ‡∏≤ logic ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
                    className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition-transform active:scale-95 flex items-center gap-2"
                 >
                    <RefreshCw className="w-5 h-5"/> ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (Retry)
                 </button>
             </div>
         );
      }

      
      // ‚≠ê 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Login (‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Popup ‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Login)
      if (!user) {
          return (
            <>
                <PublicAnnouncementPopup />
                <AuthScreen 
                    requests={requests} 
                    onLoginSuccess={(userData) => {
                        setUser(userData);
                        setCurrentUserRole(userData.role || ROLES.USER); 
                        // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Admin view) ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                        google.script.run.withSuccessHandler(setAnnouncements).getAllAnnouncements();
                    }} 
                />
            </>
          );
      }



      
      if (!user) {
          return <AuthScreen 
            requests={requests} // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            onLoginSuccess={(userData) => {
              setUser(userData);
              setCurrentUserRole(userData.role || ROLES.USER); 
          }} />;
      }
      
     
      return (
        <div className="flex h-screen bg-gray-50 font-sans text-gray-800 overflow-hidden relative print:bg-white print:h-auto print:overflow-visible">
          
          {/* Print Styles */}
          <style>{`
            @media print {
              @page { size: A4; margin: 10mm; }
              body { background: white; -webkit-print-color-adjust: exact; }
              .no-print, aside, header, .modal-backdrop { display: none !important; }
              .print-only { display: block !important; position: static !important; width: 100% !important; height: auto !important; overflow: visible !important; }
              .print-container { width: 100%; padding: 0; margin: 0; border: none; shadow: none; }
            }
            .print-only { display: none; }
          `}</style>
    
          {/* Notification - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Z-Index ‡πÄ‡∏õ‡πá‡∏ô 9999 ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ fixed ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠ */}
          {notification && (
           <div className="fixed top-4 right-4 z-[9999] px-4 py-3 rounded-lg shadow-2xl flex items-center gap-3 bg-gray-900 text-white animate-in slide-in-from-top-5 no-print border border-gray-700">
               {notification.type === 'error' ? <AlertCircle className="w-5 h-5 text-red-400"/> : <Bell className="w-5 h-5 text-green-400"/>}
               <p className="text-sm font-medium">{notification.message}</p>
            </div>
          )}

    
          {/* Sidebar */}
          <aside className={`bg-white border-r border-gray-200 flex flex-col shadow-lg z-20 no-print transition-all duration-300 ease-in-out overflow-hidden ${isSidebarOpen ? 'w-64 translate-x-0' : 'w-0 -translate-x-full border-none'}`}>
            <div className="p-6 border-b border-gray-100 min-w-[256px]"> {/* min-w ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡∏≠‡∏ô‡∏´‡∏î */}
                <h1 className="text-2xl font-bold text-blue-700 flex items-center gap-2">
                    <Package className="w-8 h-8" /> Purchase<span className="text-gray-800">Hub</span>
                </h1>
            </div>
            <div className="min-w-[256px] flex-1 flex flex-col">
            <div className="px-4 pt-4 pb-2">
                <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block ml-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project)</label>
                <div className="relative">
                    <Building className="absolute left-3 top-2.5 w-4 h-4 text-gray-500 pointer-events-none"/>
                    <select 
    value={globalProjectFilter} 
    onChange={(e) => setGlobalProjectFilter(e.target.value)}
    className="w-full pl-9 pr-8 py-2 border border-gray-300 rounded-lg text-sm appearance-none bg-white focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer font-bold text-gray-700 shadow-sm"
>
    <option value="All">üìÇ ‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (All)</option>
    {/* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á p.id (‡∏£‡∏´‡∏±‡∏™) ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */}
    {projects.map(p => (
        <option key={p.id} value={p.name}>
            {p.id} : {p.name}
        </option>
    ))}
</select>
                    <ChevronRight className="absolute right-3 top-3 w-3 h-3 text-gray-400 rotate-90 pointer-events-none"/>
                </div>
            </div>
            <nav className="flex-1 p-4 space-y-1">
           
              <button onClick={() => setActiveTab('dashboard')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'dashboard' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}><LayoutDashboard className="w-5 h-5" /> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Dashboard)</button>
              <button onClick={() => setActiveTab('orders')} className={`flex items-center justify-between w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'orders' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}>
                  <div className="flex items-center gap-3"><ShoppingCart className="w-5 h-5" /> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡πÄ‡∏ö‡∏¥‡∏Å</div>

                  {myPendingCount > 0 && (
                      <span className="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm min-w-[20px] text-center">
                          {myPendingCount}
                      </span>
                  )}
              </button>

              <button onClick={() => setActiveTab('inventory')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'inventory' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}><Box className="w-5 h-5" /> ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Store)</button>
              <button onClick={() => setActiveTab('assets')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'assets' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}><Monitor className="w-5 h-5" /> ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</button>
              {hasPermission(26) && (
              <button onClick={() => setActiveTab('projects')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'projects' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}><Settings className="w-5 h-5" /> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Projects)</button>
              )}

              {hasPermission(28) && (
              <button onClick={() => setActiveTab('announcement')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'announcement' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}>
                  <Megaphone className="w-5 h-5" /> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (Announce)
              </button>
              )}
               
                
<button 
    onClick={() => setActiveTab('users')} 
    className={`flex items-center justify-between w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'users' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}
>
    <div className="flex items-center gap-3">
        <User className="w-5 h-5" /> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Users)
    </div>
    {/* Badge ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô User ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin/Sub-Admin ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô) */}
    {(user?.isSuperAdmin || hasPermission(2) || hasPermission(3)) && newUsersCount > 0 && (
        <span className="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm min-w-[20px] text-center animate-pulse">
            {newUsersCount}
        </span>
    )}
</button>
              
            </nav>
           {/* ‚≠ê 3. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° Logout (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà Role Simulation) */}
            <div className="p-4 bg-slate-50 border-t border-gray-200 m-0"> {/* ‡∏õ‡∏£‡∏±‡∏ö style ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */}
                <div className="flex items-center gap-3 mb-3">
                    <div className="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold shadow-sm">
                        {user?.firstName?.charAt(0) || 'U'}
                    </div>
                    <div className="overflow-hidden">
                        <p className="text-sm font-bold text-gray-800 truncate">{user?.firstName} {user?.lastName}</p>
                        <p className="text-xs text-gray-500 font-mono truncate">{user?.empId}</p>
                    </div>
                </div>
                <button 
                    onClick={() => {
                        if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?')) {
                            setUser(null);
                            setGlobalProjectFilter('All'); // Reset filter
                        }
                    }} 
                    className="w-full py-2 bg-white border border-gray-300 text-red-600 rounded-lg text-sm font-bold hover:bg-red-50 flex items-center justify-center gap-2 transition-colors"
                >
                    <LogOut className="w-4 h-4"/> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
            </div>
          </aside>
    
          <main className="flex-1 flex flex-col overflow-hidden relative no-print">
            {/* Header */}
            <header className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm z-10">
              <div className="flex items-center gap-4">
                  {/* ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≤‡∏°‡∏Ç‡∏µ‡∏î */}
                  <button 
                      onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                      className="p-2 rounded-lg hover:bg-gray-100 text-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-200"
                  >
                      {/* üëá ‡∏•‡∏ö‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á SVG ‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö üëá */}
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6">
                          <line x1="3" x2="21" y1="6" y2="6" />
                          <line x1="3" x2="21" y1="12" y2="12" />
                          <line x1="3" x2="21" y1="18" y2="18" />
                      </svg>
                  </button>

                  <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                     {/* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Title ‡πÄ‡∏î‡∏¥‡∏° */}
                     {activeTab === 'dashboard' && '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö'}
                     {activeTab === 'orders' && `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ (${currentUserRole === ROLES.USER ? '‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô' : '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'})`}
                     {activeTab === 'inventory' && '‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Inventory)'}
                     {activeTab === 'assets' && '‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Assets)'}
                     {/* ... (Tab ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ... */}
                  </h2>
              </div>

            <div className="flex items-center gap-4">
            <button 
                     onClick={handleRefresh} 
                     className="bg-white text-gray-600 hover:text-blue-600 hover:bg-blue-50 p-2.5 rounded-lg border border-gray-200 shadow-sm transition-all flex items-center gap-2"
                     title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î"
                 >
                     <RefreshCw className="w-5 h-5"/>
                     <span className="hidden md:inline text-sm font-bold">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span>
                 </button>
                
                 {(hasPermission(4) || hasPermission(5) || hasPermission(6) || hasPermission(7)) && (
                     <button onClick={handleOpenCreateModal} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-md">
                         <Plus className="w-4 h-4" /> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏°
                     </button>
                 )}
              </div>
            </header>
    
            {/* Content */}
            <div className="flex-1 overflow-auto p-6 bg-slate-50">


            
            
    {activeTab === 'dashboard' && (
    <div key={globalProjectFilter} className="space-y-6 max-w-7xl mx-auto pb-20 animate-in fade-in">
                 <div className="space-y-6 max-w-7xl mx-auto pb-20">
                   
                   {/* Styles */}
                   <style>{`
                      .custom-scrollbar::-webkit-scrollbar { height: 12px; }
                      .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 6px; }
                      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; border: 3px solid #f1f5f9; }
                      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
                      .chart-tooltip { z-index: 9999 !important; pointer-events: none; }
                   `}</style>

                   {/* 1. ‚≠ê Budget Tracking Charts (‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1) */}
{/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Admin(2), 8, 9, 26, 29) */}
{(hasPermission(2) || hasPermission(8) || hasPermission(9) || hasPermission(26) || hasPermission(29)) && 
 (budgetChartData.subJobData.length > 0 || budgetChartData.matCodeData.length > 0) && (
   <div className="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm animate-in fade-in">
                           
                           {/* Header & Summary */}
                           <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-gray-100 pb-4 gap-4">
                               <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2">
                                   <div className="bg-indigo-100 p-2 rounded-lg text-indigo-600"><CreditCard className="w-5 h-5" /></div>
                                   ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Budget Tracking)
                               </h3>
                               
                               <div className="flex gap-2 bg-gray-50 p-1.5 rounded-lg border border-gray-200">
                                   {['SubJob', 'matCode'].map(type => {
                                       const data = type === 'SubJob' ? budgetChartData.subJobData : budgetChartData.matCodeData;
                                       const totalBudget = data.reduce((s, i) => s + i.budget, 0);
                                       const totalUsed = data.reduce((s, i) => s + i.used, 0);
                                       const pct = totalBudget > 0 ? (totalUsed / totalBudget) * 100 : 0;
                                       
                                       if(data.length === 0) return null;

                                       return (
                                           <div key={type} className="px-3 py-1 border-r last:border-0 border-gray-300">
                                               <div className="text-[10px] font-bold text-gray-500 uppercase flex justify-between gap-4">
                                                   <span>{type} TOTAL</span>
                                                   <span className={pct > 100 ? 'text-red-500' : 'text-green-600'}>{pct.toFixed(1)}%</span>
                                               </div>
                                               <div className="font-mono text-sm font-bold text-gray-800">
                                                   {totalUsed.toLocaleString()} <span className="text-gray-400 text-xs font-normal">/ {totalBudget.toLocaleString()}</span>
                                               </div>
                                           </div>
                                       );
                                   })}
                               </div>
                           </div>

                      {globalProjectFilter !== 'All' ? (
                               <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
                                   {[
                                       { type: 'SubJob', title: 'SubJob Breakdown', rawData: budgetChartData.subJobData, color: 'bg-indigo-600' },
                                       { type: 'matCode', title: 'Mat. Code Breakdown', rawData: budgetChartData.matCodeData, color: 'bg-purple-600' }
                                   ].map((chart, cIdx) => {
                                       // --- Logic: Grouping & Drill-down ---
                                       const activeGroup = drillDownState[chart.type];
                                       
                                       // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                       const getGroupedData = (data) => {
                                            const groups = {};
                                            data.forEach(d => {
                                                const g = d.group;
                                                if(!groups[g]) groups[g] = { code: g, budget: 0, used: 0, isGroup: true }; // ‡πÉ‡∏ä‡πâ code ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠ group ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
                                                groups[g].budget += d.budget;
                                                groups[g].used += d.used;
                                            });
                                            return Object.values(groups).sort((a,b) => a.code.localeCompare(b.code));
                                       };

                                       // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á (‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)
                                       const displayData = activeGroup 
                                            ? chart.rawData.filter(d => (d.group) === activeGroup)
                                            : getGroupedData(chart.rawData);

                                       return (
                                       <div key={cIdx} className="flex flex-col relative group/chart">
                                           <div className="flex justify-between items-end mb-2">
                                                <h4 className="font-bold text-gray-700 text-sm flex items-center gap-2">
                                                   {chart.title} 
                                                   {activeGroup && <span className="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">Group: {activeGroup}</span>}
                                                   
                                                   {/* ‡∏õ‡∏∏‡πà‡∏° Back ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Drill-down */}
                                                   {activeGroup ? (
                                                       <button 
                                                            onClick={() => setDrillDownState(prev => ({ ...prev, [chart.type]: null }))}
                                                            className="bg-gray-100 text-gray-600 hover:text-red-600 p-1 rounded-lg border border-gray-200 hover:bg-red-50 transition-colors shadow-sm ml-2 flex items-center gap-1 text-[10px] font-bold px-2"
                                                       >
                                                            <RotateCcw size={10}/> ‡∏Å‡∏•‡∏±‡∏ö
                                                       </button>
                                                   ) : (
                                                       <button 
                                                            // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡πà‡∏á chart object ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô (‡∏ó‡∏µ‡πà‡∏°‡∏µ rawData) ‡πÑ‡∏õ‡πÉ‡∏´‡πâ Expanded Chart
                                                            onClick={() => setExpandedChart(chart)} 
                                                            className="bg-gray-100 text-gray-600 hover:text-blue-600 p-1.5 rounded-lg border border-gray-200 hover:bg-blue-50 transition-colors shadow-sm ml-2"
                                                            title="‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠"
                                                       >
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                                                       </button>
                                                   )}
                                               </h4>
                                              <div className="text-[10px] text-gray-400 flex gap-2">
                                                   <span className="flex items-center gap-1"><div className="w-2 h-2 bg-gray-300 rounded-sm"></div> ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
                                                   <span className="flex items-center gap-1"><div className={`w-2 h-2 rounded-sm ${chart.color}`}></div> ‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á</span>
                                               </div>
                                            </div>
                                           
                                           <div className="relative border-b border-l border-gray-200 bg-gray-50/30 rounded-bl-lg">
                                               {/* Grid Lines */}
                                               <div className="absolute inset-0 flex flex-col justify-between pointer-events-none opacity-30">
                                                   <div className="border-t border-dashed border-gray-300 w-full h-full"></div>
                                                   <div className="border-t border-dashed border-gray-300 w-full h-full"></div>
                                               </div>

                                               <div className="relative h-64 w-full flex items-end gap-6 overflow-x-auto pb-4 px-4 pt-16 custom-scrollbar">
                                                   {displayData.length === 0 && <div className="absolute inset-0 flex items-center justify-center text-gray-300 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>}
                                                   
                                                   {displayData.map((item, i) => {
                                                       const groupMax = Math.max(...displayData.map(d => Math.max(d.budget, d.used))) || 1;
                                                       const budgetH = (item.budget / groupMax) * 100;
                                                       const usedH = (item.used / groupMax) * 100;
                                                       const percent = item.budget > 0 ? (item.used / item.budget) * 100 : 0;
                                                       const isOver = item.used > item.budget;
                                                       return (
                                                           <div 
    key={i} 
    // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° hover:z-20 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏µ‡πâ‡∏•‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ä‡∏±‡πâ‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î Tooltip ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏ö‡∏±‡∏á
    className={`group relative flex flex-col justify-end items-center h-full min-w-[40px] flex-1 hover:z-20 ${!activeGroup && item.isGroup ? 'cursor-pointer hover:bg-gray-100/50 rounded-t transition-colors' : ''}`}
    onClick={() => {
        if (!activeGroup && item.isGroup) {
            setDrillDownState(prev => ({ ...prev, [chart.type]: item.code }));
        }
    }}
>
                                                                 {/* Percent Label */}
                                                               <div 
                                                                   className="absolute text-center transition-all duration-300 z-10 w-20 pointer-events-none"
                                                                   style={{ bottom: `${Math.max(budgetH, usedH) + 5}%` }} 
                                                               >
                                                                   <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded shadow-sm border ${isOver ? 'text-red-600 bg-red-50 border-red-200' : 'text-gray-600 bg-white border-gray-200'}`}>
                                                                        {percent.toFixed(0)}%
                                                                   </span>
                                                               </div>

                                                                 {/* Bar */}
                                                               <div className="relative w-8 h-full flex items-end justify-center pointer-events-none">
                                                                   <div className="absolute bottom-0 w-full bg-gray-300 rounded-t-sm transition-all" style={{ height: `${budgetH}%`, minHeight: '4px' }}></div>
                                                                   <div className={`absolute bottom-0 w-3/5 rounded-t-sm transition-all opacity-90 ${isOver ? 'bg-red-500' : chart.color}`} style={{ height: `${usedH}%`, minHeight: '1px' }}></div>
                                                               </div>

                                                                 {/* Label */}
                                                               <div className="mt-3 text-[10px] font-bold text-gray-500 -rotate-45 origin-top-left translate-y-2 whitespace-nowrap w-0 overflow-visible">
                                                                   {item.code} {/* code ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠ Group ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠ SubJob */}
                                                               </div>

{/* Tooltip Small (Overlay on Bar) */}
<div className="chart-tooltip absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 hidden group-hover:block pointer-events-none">
    <div className="bg-gray-900/95 backdrop-blur text-white p-2.5 rounded-lg shadow-xl relative min-w-[140px] whitespace-nowrap border border-gray-700">
        {/* Header Title */}
        <div className="font-bold text-yellow-300 text-xs mb-1.5 border-b border-gray-600 pb-1">
            {item.isGroup ? 'Group: ' : ''}{item.code}
        </div>
        
        {/* Body Content */}
        <div className="space-y-0.5 text-[10px]">
            <div className="flex justify-between gap-3">
                <span className="text-gray-400">‡∏á‡∏ö:</span> 
                <span className="font-mono font-bold">{item.budget.toLocaleString()}</span>
            </div>
            
            <div className="flex justify-between gap-3">
                <span className="text-gray-400">‡πÉ‡∏ä‡πâ:</span> 
                <span className="font-mono font-bold text-blue-300">{item.used.toLocaleString()}</span>
            </div>
            
            <div className="flex justify-between gap-3">
                <span className="text-gray-400">‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span> 
                <span className={`font-mono font-bold ${item.budget - item.used < 0 ? 'text-red-400' : 'text-green-400'}`}>
                    {(item.budget - item.used).toLocaleString()}
                </span>
            </div>
        </div>

        {!activeGroup && <div className="text-[8px] text-gray-500 mt-1.5 text-center pt-1 border-t border-gray-700/50">*‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>}
    </div>
</div>
                                                           </div>
                                                       );
                                                   })}
                                               </div>
                                           </div>
                                      </div>
                                   )})}
                               
                               </div>
      
                  ) : (
                               // ‚≠ê ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Overview Chart)
                               <div className="mt-6">
                                   <div className="flex justify-between items-end mb-2">
                                       <h4 className="font-bold text-gray-700 text-sm flex items-center gap-2">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project Overview)</h4>
                                       <div className="text-[10px] text-gray-400 flex gap-2">
                                           <span className="flex items-center gap-1"><div className="w-2 h-2 bg-gray-300 rounded-sm"></div> ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
                                           <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-sm bg-teal-600"></div> ‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á</span>
                                       </div>
                                   </div>

                                   <div className="relative border-b border-l border-gray-200 bg-gray-50/30 rounded-bl-lg">
                                       {/* Grid Lines */}
                                       <div className="absolute inset-0 flex flex-col justify-between pointer-events-none opacity-30">
                                           <div className="border-t border-dashed border-gray-300 w-full h-full"></div>
                                           <div className="border-t border-dashed border-gray-300 w-full h-full"></div>
                                       </div>

                                       <div className="relative h-64 w-full flex items-end gap-6 overflow-x-auto pb-4 px-4 pt-16 custom-scrollbar">
                                           {budgetChartData.projectSummary.length === 0 && <div className="absolute inset-0 flex items-center justify-center text-gray-300 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>}
                                           
                                           {budgetChartData.projectSummary.map((proj, i) => {
                                               // ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ Max ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏£‡∏≤‡∏ü
                                               const maxVal = Math.max(...budgetChartData.projectSummary.map(d => Math.max(d.budget, d.used))) || 1;
                                               const budgetH = (proj.budget / maxVal) * 100;
                                               const usedH = (proj.used / maxVal) * 100;
                                               const percent = proj.budget > 0 ? (proj.used / proj.budget) * 100 : 0;
                                               const isOver = proj.used > proj.budget;

                                               return (
                                                   <div 
                                                       key={i} 
                                                       className="group relative flex flex-col justify-end items-center h-full min-w-[60px] flex-1 hover:z-20 cursor-pointer hover:bg-gray-100/50 rounded-t transition-colors"
                                                       onClick={() => setGlobalProjectFilter(proj.name)} // ‚≠ê ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Filter ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô
                                                   >
                                                       {/* Percent Label */}
<div 
    // ‚≠ê ‡∏•‡∏ö opacity-0 ‡πÅ‡∏•‡∏∞ group-hover ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤
    className="absolute text-center z-10 w-24 pointer-events-none mb-2"
    // ‚≠ê ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á bottom ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏¢‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡πÅ‡∏ó‡πà‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏û‡∏≠‡∏î‡∏µ
    style={{ bottom: `${Math.max(budgetH, usedH)}%` }} 
>
     <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${isOver ? 'text-red-600' : 'text-teal-700'}`}>
         {percent.toFixed(0)}%
     </span>
</div>

                                                       {/* Bar */}
                                                       <div className="relative w-10 h-full flex items-end justify-center pointer-events-none">
                                                           <div className="absolute bottom-0 w-full bg-gray-300 rounded-t-sm transition-all" style={{ height: `${budgetH}%`, minHeight: '4px' }}></div>
                                                           <div className={`absolute bottom-0 w-3/5 rounded-t-sm transition-all opacity-90 ${isOver ? 'bg-red-500' : 'bg-teal-600'}`} style={{ height: `${usedH}%`, minHeight: '1px' }}></div>
                                                       </div>

                                                       {/* Label */}
                                                       <div className="mt-3 text-[10px] font-bold text-gray-500 -rotate-45 origin-top-left translate-y-2 whitespace-nowrap w-0 overflow-visible group-hover:text-teal-700 transition-colors">
                                                           {proj.id} {/* ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å name ‡πÄ‡∏õ‡πá‡∏ô id */}
                                                       </div>

                                                       {/* Tooltip */}
                                                       <div className="chart-tooltip absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 hidden group-hover:block pointer-events-none">
                                                           <div className="bg-gray-900/95 backdrop-blur text-white p-2.5 rounded-lg shadow-xl relative min-w-[150px] whitespace-nowrap border border-gray-700">
                                                               <div className="font-bold text-yellow-300 text-xs mb-1.5 border-b border-gray-600 pb-1">
                                                                   {proj.name}
                                                               </div>
                                                               <div className="space-y-0.5 text-[10px]">
                                                                  <div className="flex justify-between gap-3">
                                                                       <span className="text-gray-400">‡∏á‡∏ö‡∏£‡∏ß‡∏°:</span> 
                                                                       <span className="font-mono font-bold">{proj.budget.toLocaleString()}</span>
                                                               </div>
                                                    
                                               <div className="flex justify-between gap-3">
                                                                       <span className="text-gray-400">‡πÉ‡∏ä‡πâ‡∏£‡∏ß‡∏°:</span> 
                                                                       <span className="font-mono font-bold text-blue-300">{proj.used.toLocaleString()}</span>
                                                               </div>
                                                                   <div className="flex justify-between gap-3 pb-2 border-b border-gray-600 mb-1">
                                                                       <span className="text-gray-400">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span> 
                                                                       <span className={`font-mono font-bold ${proj.budget - proj.used < 0 ?
'text-red-400' : 'text-green-400'}`}>
                                                                           {(proj.budget - proj.used).toLocaleString()}
                                                                       </span>
                                                                  </div>

                                                                  {/* ‚≠ê [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡πÅ‡∏¢‡∏Å SubJob (‡∏™‡∏µ‡∏Ñ‡∏£‡∏≤‡∏°) ‡πÅ‡∏•‡∏∞ Mat. Code (‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á) */}
                                                                  <div className="flex justify-between gap-3 text-[9px] text-indigo-300">
                                                                      <span>SubJob:</span>
                                                                      <span className="font-mono opacity-90">
                                                                          {proj.subUsed.toLocaleString()} / {proj.subBudget.toLocaleString()}
                                                                      </span>
                                                                  </div>
                                                                  <div className="flex justify-between gap-3 text-[9px] text-purple-300">
                                                                      <span>Mat.Code:</span>
                                                                      <span className="font-mono opacity-90">
                                                                          {proj.matUsed.toLocaleString()} / {proj.matBudget.toLocaleString()}
                                                                      </span>
                                                                  </div>
                                                                   
                                                               </div>
                                                               <div className="text-[8px] text-gray-500 mt-1.5 text-center pt-1 border-t border-gray-700/50">*‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                                                           </div>
                                                       </div>
                                                   </div>
                                               );
                                           })}
                                       </div>
                                   </div>
                               </div>
                           )}
                       </div>
                   )}

    {/* 2. ‚≠ê Stats Cards (Updated: ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î) */}
<div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div className={`p-5 rounded-2xl border bg-white shadow-sm cursor-pointer transition-all hover:shadow-md ${dashboardStatusFilter === 'Pending' ? 'ring-2 ring-amber-500 bg-amber-50' : ''}`} onClick={() => handleCardClick('Pending')}>
        <div className="flex justify-between items-start mb-2">
            <div className="p-2 bg-amber-100 rounded-lg"><Clock className="w-6 h-6 text-amber-600"/></div>
            {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ dashboardStats.pending ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ dashboardView) */}
            <span className="text-2xl font-bold text-gray-800">{dashboardStats.pending}</span>
        </div>
        <p className="text-sm text-gray-500 font-medium">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
    </div>

    <div className={`p-5 rounded-2xl border bg-white shadow-sm cursor-pointer transition-all hover:shadow-md ${dashboardStatusFilter === 'Processing' ? 'ring-2 ring-blue-500 bg-blue-50' : ''}`} onClick={() => handleCardClick('Processing')}>
        <div className="flex justify-between items-start mb-2">
            <div className="p-2 bg-blue-100 rounded-lg"><Truck className="w-6 h-6 text-blue-600"/></div>
            {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */}
            <span className="text-2xl font-bold text-gray-800">{dashboardStats.processing}</span>
        </div>
        <p className="text-sm text-gray-500 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£/‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
    </div>

    <div className={`p-5 rounded-2xl border bg-white shadow-sm cursor-pointer transition-all hover:shadow-md ${dashboardStatusFilter === 'Ready' ? 'ring-2 ring-purple-500 bg-purple-50' : ''}`} onClick={() => handleCardClick('Ready')}>
        <div className="flex justify-between items-start mb-2">
            <div className="p-2 bg-purple-100 rounded-lg"><Package className="w-6 h-6 text-purple-600"/></div>
            {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */}
            <span className="text-2xl font-bold text-gray-800">{dashboardStats.ready}</span>
        </div>
        <p className="text-sm text-gray-500 font-medium">‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á/‡πÄ‡∏ö‡∏¥‡∏Å</p>
    </div>

    <div className={`p-5 rounded-2xl border bg-white shadow-sm cursor-pointer transition-all hover:shadow-md ${dashboardStatusFilter === 'Completed' ? 'ring-2 ring-green-500 bg-green-50' : ''}`} onClick={() => handleCardClick('Completed')}>
        <div className="flex justify-between items-start mb-2">
            <div className="p-2 bg-green-100 rounded-lg"><CheckCircle className="w-6 h-6 text-green-600"/></div>
            {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */}
            <span className="text-2xl font-bold text-gray-800">{dashboardStats.completed}</span>
        </div>
        <p className="text-sm text-gray-500 font-medium">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô/‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</p>
    </div>
</div>

   {/* 3. ‚≠ê Filter Toolbar & Table */}
<div className="flex flex-col md:flex-row justify-between items-center gap-4 mt-8">
    
   <h3 className="font-bold text-gray-700 text-lg flex items-center gap-2">
        <List className="w-5 h-5 text-blue-600"/> 
        {dashboardStatusFilter === 'Pending' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' :
         dashboardStatusFilter === 'Processing' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' :
         dashboardStatusFilter === 'Ready' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á/‡πÄ‡∏ö‡∏¥‡∏Å' :
         dashboardStatusFilter === 'Completed' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô/‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß' :
         '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Requests)'}
         
         <span className="text-sm bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full font-bold border border-gray-200 ml-1">
             {dashboardRequests.length}
         </span>
    </h3>

    <div className="flex gap-2 w-full md:w-auto items-center">
        {/* ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ */}
        <div className="relative flex-1 md:w-80"> 
            <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
            <input type="text" className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." value={dashboardSearch} onChange={e => setDashboardSearch(e.target.value)}/>
        </div>

        {/* ‡∏õ‡∏∏‡πà‡∏° Export */}
        {(user.isSuperAdmin || hasPermission(2) || hasPermission(29)) && (
            <button onClick={() => setShowExportModal(true)} className="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm transition-colors whitespace-nowrap">
                <Download className="w-4 h-4"/> Export
            </button>
        )}
    </div>
</div>

      
                   {/* Table */}
                   {dashboardRequests.length > 0 ? (
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden mb-10">
                          <div className="overflow-x-auto">
                              <table className="w-full text-sm text-left">
                                  <thead className="bg-gray-100 text-gray-600 font-medium border-b">
                                      <tr>
                                          <th className="px-6 py-3">ID</th>
                                          <th className="px-6 py-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                          <th className="px-6 py-3">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                                          
                                          <th className="px-6 py-3">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th>
                                          <th className="px-6 py-3">
                                              <div className="flex items-center gap-1 cursor-pointer">
                                                  ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î <ArrowUpDown className="w-3 h-3 opacity-50"/>
                                              </div>
                                          </th>
                                          <th className="px-6 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                      </tr>
                                  </thead>
                                  <tbody className="divide-y">
                                      {dashboardRequests
                                          .map(req => {
                                              let lastUpdateStr = req.created;
                                              let displayTime = req.created;
                                              if (req.history && req.history.length > 0) {
                                                  const lastLog = req.history[req.history.length - 1];
                                                  lastUpdateStr = lastLog.date;
                                                  displayTime = lastLog.date;
                                              }
                                              const parseThaiDateToTs = (dStr) => {
                                                  if(!dStr) return 0;
                                                  try {
                                                      if(dStr.includes('/')) {
                                                          const parts = dStr.split(' ');
                                                          const dateParts = parts[0].split('/');
                                                          const timeParts = parts[1] ? parts[1].split(':') : [0,0,0];
                                                          let year = parseInt(dateParts[2]);
                                                          if(year > 2400) year -= 543;
                                                          return new Date(year, parseInt(dateParts[1])-1, parseInt(dateParts[0]), ...timeParts).getTime();
                                                      }
                                                      return new Date(dStr).getTime();
                                                  } catch(e) { return 0; }
                                              };
                                              return { ...req, _sortTime: parseThaiDateToTs(lastUpdateStr), _displayTime: displayTime };
                                          })
                                          .sort((a, b) => b._sortTime - a._sortTime)
                                          .map(req => {
                                              const getDaysDiff = (d) => {
                                                  if(!d) return 999;
                                                  const diff = new Date(d) - new Date();
                                                  return Math.ceil(diff / (1000 * 60 * 60 * 24));
                                              };
                                              const daysLeft = getDaysDiff(req.dateRequired);
let alertBadge = null;
// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏° 'Cancelled' ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô
if (!['Completed', 'Rejected', 'Returned', 'Draft', 'Cancelled'].includes(req.status)) {
    if (daysLeft < 0) alertBadge = { text: `‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${Math.abs(daysLeft)} ‡∏ß‡∏±‡∏ô`, color: 'bg-red-600 text-white animate-pulse' };
    else if (daysLeft <= 1) alertBadge = { text: '‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!', color: 'bg-red-500 text-white' };
    else if (daysLeft <= 3) alertBadge = { text: '‡∏î‡πà‡∏ß‡∏ô (3 ‡∏ß‡∏±‡∏ô)', color: 'bg-orange-50 text-orange-600 border-orange-200' };
}
                                              return (
                                                  <tr 
                                                      key={req.id} 
                                                      className="hover:bg-blue-50 cursor-pointer transition-colors group"
                                                      onClick={() => { setSelectedRequest(req); setShowDetailModal(true); }}
                                                  >
                                                      <td className="px-6 py-4 font-bold text-blue-600 group-hover:text-blue-800 underline decoration-dotted decoration-blue-300 underline-offset-4">
                                                          {req.id}
                                                          <div className="flex flex-col gap-1 mt-1">
                                                              {req.docNumber && <span className="text-[10px] text-gray-500 font-normal border px-1 rounded bg-gray-50 w-fit">{req.docNumber}</span>}
                                                              {alertBadge && (
                                                                  <span className={`text-[9px] px-1.5 py-0.5 rounded flex items-center gap-1 font-bold w-fit ${alertBadge.color}`}>
                                                                      <Clock className="w-3 h-3"/> {alertBadge.text}
                                                                  </span>
                                                              )}
                                                          </div>
                                                      </td>

                                                      <td className="px-6 py-4">
    {(() => {
        let label = req.type;
        let style = "bg-gray-100 text-gray-600 border-gray-200";
        
        if (req.type === 'Local') {
            label = '‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ Local';
            style = "bg-orange-50 text-orange-700 border-orange-200";
        } else if (req.type === 'HO') {
            if (req.purchaseType === 'Rent') {
                label = 'HO (‡πÄ‡∏ä‡πà‡∏≤)';
                style = "bg-indigo-50 text-indigo-700 border-indigo-200";
            } else {
                label = 'HO (‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏î)';
                style = "bg-purple-50 text-purple-700 border-purple-200";
            }
        } else if (req.type === 'Withdraw') {
            label = '‡πÄ‡∏ö‡∏¥‡∏Å';
            style = "bg-pink-50 text-pink-700 border-pink-200";
        } else if (req.type === 'Borrow') {
            label = '‡∏¢‡∏∑‡∏°';
            style = "bg-blue-50 text-blue-700 border-blue-200";
        }
        
        return (
            <span className={`text-[10px] px-2 py-1 rounded border font-bold whitespace-nowrap ${style}`}>
                {label}
            </span>
        );
    })()}
</td>
                                                      <td className="px-6 py-4">
                                                          <div className="font-bold text-gray-800">{req.items[0]?.name}</div>
                                                          {req.items.length > 1 && <span className="text-xs text-gray-500 bg-gray-100 px-1.5 rounded">+{req.items.length - 1} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>}
                                                      </td>
                                                      <td className="px-6 py-4">{req.requester}</td>
                                                      <td className="px-6 py-4 text-gray-500 text-xs font-mono">
                                                          <div className="font-bold text-gray-700">{req._displayTime.split(' ')[0]}</div>
                                                          <div className="text-[10px] text-gray-400">{req._displayTime.split(' ')[1]}</div>
                                                          {req.dateRequired && <div className="text-[10px] text-orange-400 mt-1">Due: {req.dateRequired}</div>}
                                                      </td>
                                                      <td className="px-6 py-4 text-center">
    {/* ‚≠ê ‡πÄ‡∏≠‡∏≤ StatusWithTooltip ‡∏°‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ */}
    <StatusWithTooltip request={req} allUsers={allUsers}>
        <StatusBadge status={req.status} type={req.type} />
    </StatusWithTooltip>
</td>
                                                  </tr>
                                              );
                                          })}
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  ) : (
                      <div className="text-center py-10 bg-white rounded-xl border border-dashed border-gray-300 text-gray-400">
                          <Package className="w-12 h-12 mx-auto mb-3 text-gray-300"/>
                          <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
                      </div>
                  )}
                 </div>

                 </div>
              )}

             {/* Expanded Chart Modal */}
              {expandedChart && (() => {
                   // ‚≠ê ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô Modal (Group -> Detail) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏î Drill-down
                   const activeGroup = drillDownState[expandedChart.type];
                   
                   const getGroupedData = (data) => {
                        const groups = {};
                        data.forEach(d => {
                            const g = d.group;
                            if(!groups[g]) groups[g] = { code: g, budget: 0, used: 0, isGroup: true };
                            groups[g].budget += d.budget;
                            groups[g].used += d.used;
                        });
                        return Object.values(groups).sort((a,b) => a.code.localeCompare(b.code));
                   };

                   const displayData = activeGroup 
                        ? expandedChart.rawData.filter(d => (d.group) === activeGroup)
                        : getGroupedData(expandedChart.rawData);

                   // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Summary Card
                   const totalBudget = displayData.reduce((s, i) => s + i.budget, 0);
                   const totalUsed = displayData.reduce((s, i) => s + i.used, 0);
                   const pct = totalBudget > 0 ? (totalUsed / totalBudget) * 100 : 0;

                   return (
                      <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[200] p-4 backdrop-blur-sm animate-in fade-in">
                          <div className="bg-white rounded-xl shadow-2xl w-full max-w-7xl h-[90vh] flex flex-col overflow-hidden">
                    
                              {/* Header */}
                              <div className="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
                                  <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2">
    <LayoutDashboard className="w-6 h-6 text-blue-600"/> {expandedChart.title} (Full View)
    
    {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */}
    <span className="text-sm bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full border border-indigo-100 shadow-sm">
        {globalProjectFilter === 'All' ? '‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (All Projects)' : globalProjectFilter}
    </span>

    {activeGroup && <span className="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-full">Group: {activeGroup}</span>}
</h3>
                                  <div className="flex gap-2">
                                      {/* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏î‡∏π‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°) */}
                                      {activeGroup && (
                                           <button 
                                                onClick={() => setDrillDownState(prev => ({ ...prev, [expandedChart.type]: null }))}
                                                className="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 font-bold hover:bg-gray-50 flex items-center gap-2 transition-colors"
                                           >
                                                <RotateCcw size={16}/> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö (Back)
                                           </button>
                                      )}
                                      <button onClick={() => setExpandedChart(null)} className="p-2 bg-white hover:bg-gray-200 rounded-full transition-colors">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-600">
                                              <line x1="18" y1="6" x2="6" y2="18"></line>
                                              <line x1="6" y1="6" x2="18" y2="18"></line>
                                          </svg>
                                      </button>
                                  </div>
                              </div>

                              <div className="flex-1 p-8 bg-white overflow-hidden flex flex-col">
                                  {/* Summary Card */}
                                  <div className="mb-6 flex justify-center">
                                      <div className="bg-blue-50 border border-blue-200 rounded-xl px-6 py-3 flex gap-8 items-center shadow-sm">
                                           <div>
                                              <div className="text-xs font-bold text-gray-500 uppercase">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Total Budget)</div>
                                              <div className="text-xl font-bold text-gray-800">{totalBudget.toLocaleString()}</div>
                                           </div>
                                           <div className="h-8 w-px bg-blue-200"></div>
                                           <div>
                                              <div className="text-xs font-bold text-gray-500 uppercase">‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á (Total Used)</div>
                                              <div className="text-xl font-bold text-indigo-700">{totalUsed.toLocaleString()}</div>
                                           </div>
                                           <div className="h-8 w-px bg-blue-200"></div>
                                           <div>
                                              <div className="text-xs font-bold text-gray-500 uppercase">% ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</div>
                                              <div className={`text-2xl font-bold ${pct > 100 ? 'text-red-600' : 'text-green-600'}`}>{pct.toFixed(2)}%</div>
                                           </div>
                                      </div>
                                  </div>

                                  {/* ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà */}
                                  <div className="relative flex-1 border-b border-l border-gray-300 bg-gray-50/20 w-full flex items-end gap-8 overflow-x-auto pb-4 px-8 pt-16 custom-scrollbar">
                                      {displayData.map((item, i) => {
                                           const groupMax = Math.max(...displayData.map(d => Math.max(d.budget, d.used))) || 1;
                                           const budgetH = (item.budget / groupMax) * 100;
                                           const usedH = (item.used / groupMax) * 100;
                                           const percent = item.budget > 0 ? (item.used / item.budget) * 100 : 0;
                                           const isOver = item.used > item.budget;

                                           return (
                                               <div 
                                                    key={i} 
                                                    className={`group relative flex flex-col justify-end items-center h-full min-w-[60px] flex-1 ${!activeGroup && item.isGroup ? 'cursor-pointer hover:bg-gray-100/50 rounded-t transition-colors' : ''}`}
                                                    onClick={() => {
                                                        if (!activeGroup && item.isGroup) {
                                                            setDrillDownState(prev => ({ ...prev, [expandedChart.type]: item.code }));
                                                        }
                                                    }}
                                               >
                                                   {/* Large Percent Label */}
                                                   <div className="absolute text-center transition-all duration-300 z-10 pointer-events-none" style={{ bottom: `${Math.max(budgetH, usedH) + 2}%` }}>
                                                      <span className={`text-sm font-bold px-2 py-1 rounded shadow border ${isOver ? 'text-red-600 bg-white border-red-200' : 'text-gray-700 bg-white border-gray-200'}`}>
                                                           {percent.toFixed(0)}%
                                                      </span>
                                                   </div>
                                             
                                                   <div className="relative w-16 h-full flex items-end justify-center pointer-events-none">
                                                      <div className="absolute bottom-0 w-full bg-gray-300 rounded-t transition-all" style={{ height: `${budgetH}%` }}></div>
                                                      <div className={`absolute bottom-0 w-3/4 rounded-t transition-all opacity-90 ${isOver ? 'bg-red-500' : expandedChart.color}`} style={{ height: `${usedH}%` }}></div>
                                                   </div>

                                                   <div className="mt-4 text-xs font-bold text-gray-600 -rotate-45 origin-top-left translate-y-2 whitespace-nowrap">
                                                       {item.code}
                                                   </div>
{/* Tooltip Expanded (Overlay on Bar) */}
<div className="chart-tooltip absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 hidden group-hover:block pointer-events-none">
    <div className="bg-gray-900/95 backdrop-blur text-white p-3 rounded-lg shadow-2xl relative min-w-[170px] whitespace-nowrap border border-gray-700">
        {/* Header Title */}
        <div className="font-bold text-yellow-300 text-sm mb-2 border-b border-gray-600 pb-1.5">
            {item.isGroup ? 'Group: ' : ''}{item.code}
        </div>
        
        {/* Body Content */}
        <div className="space-y-1 text-xs">
            <div className="flex justify-between gap-5">
                <span className="text-gray-400">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</span> 
                <span className="font-mono font-bold">{item.budget.toLocaleString()}</span>
            </div>
            
            <div className="flex justify-between gap-5">
                <span className="text-gray-400">‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á:</span> 
                <span className="font-mono font-bold text-blue-300">{item.used.toLocaleString()}</span>
            </div>
            
            <div className="flex justify-between gap-5">
                <span className="text-gray-400">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span> 
                <span className={`font-mono font-bold ${item.budget - item.used < 0 ? 'text-red-400' : 'text-green-400'}`}>
                    {(item.budget - item.used).toLocaleString()}
                </span>
            </div>
        </div>

        {!activeGroup && <div className="text-[9px] text-gray-500 mt-2 text-center pt-1.5 border-t border-gray-700/50">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ó‡πà‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>}
    </div>
</div>
                                               </div>
                                           );
                                      })}
                                  </div>
                              </div>
                          </div>
                      </div>
                  );
              })()}


              {/* --- ANNOUNCEMENT MANAGEMENT TAB (UPDATED: MULTI-TOPIC) --- */}
{activeTab === 'announcement' && hasPermission(28) && (
    <div className="space-y-6 max-w-5xl mx-auto">
        <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col h-[85vh]">
            <div className="px-6 py-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">
                   <Megaphone className="w-5 h-5 text-indigo-600"/> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ (System Announcement)
                </h3>
                <button 
                    onClick={() => setAnnounceForm({ id: '', title: '', detail: '', active: true })}
                    className="bg-indigo-600 text-white text-sm font-bold px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-2"
                >
                    <Plus className="w-4 h-4"/> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
            
            <div className="flex flex-1 overflow-hidden">
                {/* Left: List of Announcements */}
                <div className="w-1/3 border-r border-gray-200 overflow-y-auto bg-gray-50">
                    {announcements.length === 0 && <div className="p-8 text-center text-gray-400 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</div>}
                    {announcements.map((item) => (
                        <div 
                            key={item.id}
                            onClick={() => setAnnounceForm(item)}
                            className={`p-4 border-b cursor-pointer transition-colors hover:bg-white ${announceForm.id === item.id ? 'bg-white border-l-4 border-l-indigo-600 shadow-sm' : ''}`}
                        >
                            <div className="flex justify-between items-start mb-1">
                                <h4 className={`font-bold text-sm ${announceForm.id === item.id ? 'text-indigo-700' : 'text-gray-700'}`}>{item.title}</h4>
                                <span className={`text-[10px] px-2 py-0.5 rounded-full border ${item.active ? 'bg-green-50 text-green-600 border-green-200' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>
                                    {item.active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                            <p className="text-xs text-gray-500 line-clamp-2">{item.detail}</p>
                            <div className="mt-2 text-[10px] text-gray-400 flex justify-between">
    <span>{item.timestamp}</span>
</div>
                        </div>
                    ))}
                </div>

                {/* Right: Edit Form */}
                <div className="w-2/3 p-6 overflow-y-auto bg-white">
                    <div className="max-w-xl mx-auto space-y-4">
                        <div className="flex justify-between items-center mb-4">
                            <h4 className="font-bold text-gray-800 text-lg">
                                {announceForm.id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà'}
                            </h4>
                            {announceForm.id && (
                                <span className="text-xs font-mono text-gray-400 bg-gray-100 px-2 py-1 rounded">{announceForm.id}</span>
                            )}
                        </div>

                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Title)</label>
                            <input 
                                type="text" 
                                className="w-full p-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á..."
                                value={announceForm.title}
                                onChange={e => setAnnounceForm({...announceForm, title: e.target.value})}
                            />
                        </div>
                        <div>
                             <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Details)</label>
                            <textarea 
                                rows="8"
                                className="w-full p-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..."
                                value={announceForm.detail}
                                onChange={e => setAnnounceForm({...announceForm, detail: e.target.value})}
                             ></textarea>
                        </div>

                        <div className="flex gap-3 pt-4 border-t border-gray-100 mt-6">
                            {announceForm.id && (
                                <>
                                    <button 
                                        onClick={() => {
                                            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ?')) return;
                                            setIsAnnounceLoading(true);
                                            google.script.run.withSuccessHandler(() => {
                                                setAnnouncements(prev => prev.filter(a => a.id !== announceForm.id));
                                                setAnnounceForm({ id: '', title: '', detail: '', active: true });
                                                setIsAnnounceLoading(false);
                                                showToast('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                                            }).deleteAnnouncementItem(announceForm.id);
                                        }}
                                        className="bg-white border border-red-200 text-red-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-50"
                                        disabled={isAnnounceLoading}
                                    >
                                        ‡∏•‡∏ö
                                    </button>

                                    <button 
                                        onClick={() => {
                                            const newStatus = !announceForm.active;
                                            setIsAnnounceLoading(true);
                                            google.script.run.withSuccessHandler((res) => {
                                                setAnnouncements(prev => prev.map(a => a.id === announceForm.id ? {...a, active: newStatus} : a));
                                                setAnnounceForm({...announceForm, active: newStatus});
                                                setIsAnnounceLoading(false);
                                                showToast(res.message);
                                            }).toggleAnnouncementStatus(announceForm.id, newStatus);
                                        }}
                                        className={`px-4 py-2 rounded-lg text-sm font-bold border transition-colors ${announceForm.active ? 'bg-orange-50 text-orange-600 border-orange-200 hover:bg-orange-100' : 'bg-green-50 text-green-600 border-green-200 hover:bg-green-100'}`}
                                        disabled={isAnnounceLoading}
                                    >
                                        {announceForm.active ? '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (Unpublish)' : '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (Publish)'}
                                    </button>
                                </>
                            )}
                            
                            <div className="flex-1"></div>

                            <button 
                                onClick={() => {
                                    if(!announceForm.title || !announceForm.detail) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error'); return; }
                                    setIsAnnounceLoading(true);
                                    const payload = { ...announceForm, updatedBy: `${user.firstName} ${user.lastName}` };
                                    google.script.run.withSuccessHandler((res) => {
                                        if (announceForm.id) {
                                            setAnnouncements(prev => prev.map(a => a.id === res.data.id ? res.data : a));
                                        } else {
                                            setAnnouncements(prev => [res.data, ...prev]);
                                            setAnnounceForm(res.data); // Set current to saved one
                                        }
                                        setIsAnnounceLoading(false);
                                        showToast(res.message);
                                    }).saveAnnouncementItem(payload);
                                }}
                                className="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 shadow-md flex items-center gap-2"
                                disabled={isAnnounceLoading}
                            >
                                <Save className="w-4 h-4"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
)}

{activeTab === 'orders' && (
  <div className="space-y-6 max-w-7xl mx-auto pb-24 relative">
    
    {/* --- 1. SEARCH & FILTER BAR --- */}
    <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-wrap gap-4 items-center justify-between">
      <div className="flex items-center gap-4 flex-1 min-w-[200px]">
        {/* ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ */}
        <div className="relative flex-1">
          <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
          <input 
            type="text" 
            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500" 
            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (ID, ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)..." 
            value={searchQuery} 
            onChange={e => setSearchQuery(e.target.value)}
          />
        </div>
        
        {/* Dropdown ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */}
        <select 
          value={statusFilter} 
          onChange={(e) => setStatusFilter(e.target.value)}
          className="p-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500 bg-white cursor-pointer min-w-[150px]"
        >
          <option value="All">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
          {Object.keys(STATUS_LABELS).map(key => <option key={key} value={key}>{STATUS_LABELS[key]}</option>)}
        </select>
      </div>
    </div>
    
    {/* --- 2. ORDERS LIST --- */}
    <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
      <div className="divide-y divide-gray-100">
        
        {/* ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */}
        {filteredRequests.length === 0 ? (
          <div className="p-12 text-center text-gray-400 bg-white border-t border-gray-100">
            <div className="bg-gray-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
              <FileText className="w-8 h-8 text-gray-300"/>
            </div>
            <p className="text-lg font-bold text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
            <p className="text-sm">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
          </div>
        ) : (
          
          /* Loop ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
          filteredRequests.map(req => {
            
            // --- Logic 1: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Badge Alerts) ---
            const getDaysDiff = (d) => {
              if(!d) return 999;
              const diff = new Date(d) - new Date();
              return Math.ceil(diff / (1000 * 60 * 60 * 24));
            };
            const daysLeft = getDaysDiff(req.dateRequired);
            
            let alertBadge = null;
            if (!['Completed', 'Rejected', 'Returned', 'Draft', 'Cancelled'].includes(req.status)) {
              if (daysLeft < 0) alertBadge = { text: `‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${Math.abs(daysLeft)} ‡∏ß‡∏±‡∏ô`, color: 'bg-red-600 text-white animate-pulse border-red-700' };
              else if (daysLeft <= 1) alertBadge = { text: '‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ/‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ!', color: 'bg-red-500 text-white' };
              else if (daysLeft <= 3) alertBadge = { text: '‡∏≠‡∏µ‡∏Å 3 ‡∏ß‡∏±‡∏ô', color: 'bg-red-100 text-red-700' };
              else if (daysLeft <= 7) alertBadge = { text: '‡∏≠‡∏µ‡∏Å 1 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', color: 'bg-orange-100 text-orange-700' };
              else if (daysLeft <= 14) alertBadge = { text: '‡∏≠‡∏µ‡∏Å 2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', color: 'bg-yellow-100 text-yellow-800' };
              else if (daysLeft <= 30) alertBadge = { text: '‡∏≠‡∏µ‡∏Å 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', color: 'bg-blue-50 text-blue-600' };
            }
            
            // --- Logic 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Checkbox ---
            const canSelect = canUserManageRequest(req);

            return (
              <div key={req.id} className={`p-5 hover:bg-slate-50 transition-colors group ${selectedOrderIds.includes(req.id) ? 'bg-blue-50/50' : ''}`}>
                
                <div className="flex gap-4">
                    
                    {/* ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: Checkbox */}
                    {canSelect && (
                        <div className="pt-1">
                            <input 
                                type="checkbox" 
                                className="w-5 h-5 accent-blue-600 cursor-pointer rounded border-gray-300"
                                checked={selectedOrderIds.includes(req.id)}
                                onChange={() => toggleSelectOrder(req.id)}
                                onClick={(e) => e.stopPropagation()} 
                            />
                        </div>
                    )}

                    {/* ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î */}
                    <div className="flex-1 min-w-0">
                        
                        {/* Header Line */}
                        <div className="flex justify-between mb-2">
                           <div className="flex items-center gap-3 flex-wrap">
                            <span className={`text-[10px] px-2 py-0.5 rounded-full border font-bold ${req.type === 'Local' ? 'bg-orange-50 text-orange-700' : req.type === 'Withdraw' ? 'bg-pink-50 text-pink-700' : req.type === 'Borrow' ? 'bg-blue-50 text-blue-700' : 'bg-purple-50 text-purple-700'}`}>
                                {req.type === 'HO' ? `HO (${req.purchaseType || 'Buy'})` : req.type}
                            </span>
                            
                            {alertBadge && (
                              <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center gap-1 ${alertBadge.color}`}>
                                 <Clock className="w-3 h-3"/> {alertBadge.text}
                              </span>
                            )}

                            <span className="text-xs text-gray-400 font-mono">{req.id}</span>
                            <DocIdBadge type={req.type} id={req.docNumber} />

                            {req.dateRequired && (
                               <span className="text-[10px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded border flex items-center gap-1" title="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á">
                                   <Calendar className="w-3 h-3"/> {req.dateRequired}
                               </span>
                            )}

                            <h4 className="font-bold text-gray-900 text-sm flex items-center truncate">
                                {req.items[0]?.name}
                                {req.items.length > 1 && (
                                     <span className="text-gray-500 font-normal text-xs ml-1 bg-gray-200 px-1.5 rounded-full">+{req.items.length - 1}</span>
                                )}
                            </h4>
                          </div>
                          
                          <StatusWithTooltip request={req} allUsers={allUsers}>
                              <StatusBadge status={req.status} type={req.type} />
                          </StatusWithTooltip>
                        </div>
                        
                        <ProgressBar request={req} />

                        {/* User & Actions */}
                        <div className="flex flex-col md:flex-row justify-between items-end mt-3 gap-3">
                            <div className="flex items-center gap-2 text-xs text-slate-500 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100 w-full md:w-auto">
                                <div className="bg-white p-1 rounded-full border border-slate-200 shadow-sm">
                                    <User size={12} className="text-blue-500"/>
                                </div>
                                <span>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: <span className="font-bold text-slate-700">{req.requester}</span></span>
                            </div>

                            <div className="flex justify-end gap-2 flex-wrap flex-1">
                                
                                {/* Rollback */}
                                {(() => {
                                    const getPrevStatus = (r) => {
                                        if (r.status === 'Ordered') return 'Approved';
                                        if (r.status === 'PR Issued') return 'Approved';
                                        if (r.status === 'PO Issued') return 'PR Issued';
                                        if (r.status === 'Contract Pending') return 'Approved';
                                        if (r.status === 'Contract Signed') return 'Contract Pending';
                                        if (r.status === 'Shipping') return r.purchaseType === 'Rent' ? 'Contract Signed' : 'PO Issued';
                                        // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° Rollback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Local: Check -> PM
                                        if (r.status === 'Pending Check' && r.type === 'Local') return 'Pending PM';
                                        return null;
                                    };
                                    const prevStatus = getPrevStatus(req);
                                    
                                    if (prevStatus) {
                                        const lastLog = [...req.history].reverse().find(h => h.action === req.status || h.action === STATUS_LABELS[req.status]);
                                        const isActor = lastLog && user && (lastLog.user.includes(user.empId) || lastLog.user.includes(user.firstName));

                                        if (isActor) {
                                            return (
                                                <button type="button" onClick={() => { if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞?`)) handleUpdateStatus(req.id, prevStatus, `‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å ${req.status}`); }} className="flex items-center gap-2 px-3 py-1.5 bg-orange-50 border border-orange-200 text-orange-700 text-xs font-bold rounded-lg hover:bg-orange-100 shadow-sm transition-colors">
                                                    <RotateCcw className="w-3 h-3"/> Rollback
                                                </button>
                                            );
                                        }
                                    }
                                    return null;
                                })()}


                                {(() => {
                                    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå 15 (‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á) ‡∏´‡∏£‡∏∑‡∏≠ 24 (‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á)
                                    const myName = `${user.firstName} ${user.lastName}`;
                                    const isOwner = req.requester === myName || req.requester === 'Current User';
                                    const hasRight = isOwner || hasPermission(15) || hasPermission(24);
                                    
                                    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Draft, Completed, ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                                    const isActive = !['Draft', 'Completed', 'Cancelled', 'Rejected', 'Returned'].includes(req.status);

                                    if (hasRight && isActive) {
                                        return (
                                            <button 
                                                type="button" 
                                                onClick={() => handleCancelOrder(req)} 
                                                className="flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-300 text-gray-700 text-xs font-bold rounded-lg hover:bg-gray-100 hover:text-red-600 shadow-sm transition-colors"
                                                title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ"
                                            >
                                                <XCircle className="w-3 h-3"/> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                            </button>
                                        );
                                    }
                                    return null;
                                })()}

                                {/* Standard Edit/Print/Detail Buttons */}
                                {((req.requester === `${user.firstName} ${user.lastName}`) || user.isSuperAdmin || hasPermission(2, req.job)) && req.status === 'Draft' && (
                                    <button type="button" onClick={() => handleEditDraft(req)} className="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 text-white text-xs font-bold rounded-lg hover:bg-indigo-700 shadow-sm"><Edit className="w-3 h-3"/> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                )}
                                {((req.requester === `${user.firstName} ${user.lastName}`) || user.isSuperAdmin || hasPermission(2, req.job)) && req.status === 'Revise Needed' && (
                                    <button type="button" onClick={() => handleRevise(req)} className="flex items-center gap-2 px-3 py-1.5 bg-red-600 text-white text-xs font-bold rounded-lg hover:bg-red-700 shadow-sm animate-pulse"><Edit className="w-3 h-3"/> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                                )}
                                {(() => {
                                    const isOwner = req.requester === `${user.firstName} ${user.lastName}`;

const canRecall = ['Pending Check', 'Pending Head', 'Pending PM'].includes(req.status);

if (isOwner && canRecall) return (
    <button type="button" onClick={() => initiateRecall(req.id)} className="flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-300 text-gray-700 text-xs font-bold rounded-lg hover:bg-gray-50 shadow-sm">
        <RotateCcw className="w-3 h-3"/> ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô
    </button>
);
                                })()}
                               {['Approved', 'Ordered', 'PR Issued', 'PO Issued', 'Shipping', 'Contract Signed', 'Partially Received', 'Ready to Disburse', 'Completed', 'Returned'].includes(req.status) && 
                                 (req.type === 'Local' ||
                                  req.type === 'Withdraw' || 
                                  req.type === 'Borrow' || 
                                  // ‚≠ê ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç HO: ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Full Flow ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
                                  (req.type === 'HO' && (req.isFullApprovalFlow || req.isPreviouslyApproved))
                                 ) && (
                                    <button 
                                        type="button" 
                                        onClick={() => handleOpenPrintPreview(req)} 
                                        className="flex items-center gap-2 px-3 py-1.5 bg-blue-50 text-blue-700 border border-blue-200 text-xs font-bold rounded-lg hover:bg-blue-100 shadow-sm"
                                        title="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"
                                    >
                                        <Printer className="w-3 h-3"/> 
                                        ‡∏û‡∏¥‡∏°‡∏û‡πå
                                    </button>
                                )}
                                <button type="button" onClick={() => { setSelectedRequest(req); setShowDetailModal(true); }} className="flex items-center gap-2 px-3 py-1.5 bg-gray-100 text-gray-700 text-xs font-bold rounded-lg hover:bg-gray-200 shadow-sm"><History className="w-3 h-3"/> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                                
                                {/* ‚≠ê‚≠ê [Action Buttons Logic] ‚≠ê‚≠ê */}
                                {req.status !== 'Draft' && (
                                  <>
                                    {/* 1. Pending Head */}
                                    {req.status === 'Pending Head' && ((['Local', 'HO'].includes(req.type) && hasPermission(8)) || (['Withdraw', 'Borrow'].includes(req.type) && (hasPermission(8) || hasPermission(9)))) && (
                                      <>
                                        <button type="button" onClick={() => openRejectModal(req.id)} className="px-3 py-1.5 border border-red-300 text-red-600 text-xs font-bold rounded-lg hover:bg-red-50 shadow-sm">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                        <button type="button" onClick={() => handleUpdateStatus(req.id, (req.type === 'Withdraw' || req.type === 'Borrow') ? 'Ready to Disburse' : 'Pending PM')} className="px-3 py-1.5 bg-orange-600 text-white text-xs font-bold rounded-lg hover:bg-orange-700 shadow-sm">{(req.type === 'Withdraw' || req.type === 'Borrow') ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approve)' : '‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ L2'}</button>
                                      </>
                                    )}
                                    
                                    {/* 2. Pending PM */}
                                    {hasPermission(9) && req.status === 'Pending PM' && (
                                      <>
                                        <button type="button" onClick={() => openRejectModal(req.id)} className="px-3 py-1.5 border border-red-300 text-red-600 text-xs font-bold rounded-lg hover:bg-red-50 shadow-sm">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                        {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Local ‡∏™‡πà‡∏á‡πÑ‡∏õ Check, HO ‡∏™‡πà‡∏á‡πÑ‡∏õ Approved (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ HO ‡∏ï‡∏£‡∏ß‡∏à‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß) */}
                                        <button type="button" onClick={() => handleApprovalUpdate(req.id, req.type === 'Local' ? 'Pending Check' : 'Approved')} className="px-3 py-1.5 bg-green-600 text-white text-xs font-bold rounded-lg hover:bg-green-700 shadow-sm">
                                            {req.type === 'Local' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approve)'}
                                        </button>
                                      </>
                                    )}

                                    {/* 3. Pending Check (HO) - ‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏° */}
                                    {hasPermission(10) && req.status === 'Pending Check' && req.type === 'HO' && (
                                      <button type="button" onClick={() => openVerificationModal(req.id)} className="flex items-center gap-1 px-3 py-1.5 bg-indigo-600 text-white text-xs font-bold rounded-lg hover:bg-indigo-700 shadow-sm"><CheckSquare className="w-3 h-3"/> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Verify)</button>
                                    )}

                                    {/* ‚≠ê 4. Pending Check (Local) - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ */}
                                    {hasPermission(10) && req.status === 'Pending Check' && req.type === 'Local' && (
                                      <>
                                        {/* ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô -> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */}
                                        <button type="button" onClick={() => {
                                            const reason = prompt("‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Revise Reason):");
                                            if (reason) handleUpdateStatus(req.id, 'Revise Needed', `‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: ${reason}`);
                                        }} className="px-3 py-1.5 border border-red-300 text-red-600 text-xs font-bold rounded-lg hover:bg-red-50 shadow-sm">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</button>
                                        
                                        {/* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô HO (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏à‡∏≤‡∏Å Approved) */}
                                        <button type="button" onClick={() => openVerificationModal(req.id, true)} className="px-3 py-1.5 bg-purple-600 text-white text-xs font-bold rounded-lg hover:bg-purple-700 shadow-sm flex items-center gap-1">
                                            <RefreshCw className="w-3 h-3"/> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô HO
                                        </button>

                                        {/* ‡∏õ‡∏∏‡πà‡∏°‡∏ú‡πà‡∏≤‡∏ô -> ‡πÑ‡∏õ Approved */}
                                        <button 
    type="button" 
    onClick={() => handleUpdateStatus(req.id, 'Approved', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô (Verified by Purchasing)')} 
    className="px-3 py-1.5 bg-green-600 text-white text-xs font-bold rounded-lg hover:bg-green-700 shadow-sm"
>
    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô
</button>
                                      </>
                                    )}

                                    {/* 5. Process Buttons (Ordered, PR, PO...) */}
                                    {hasPermission(24) && (req.type === 'Withdraw' || req.type === 'Borrow') && req.status === 'Ready to Disburse' && (
                                      <button type="button" onClick={() => openDisburseModal(req.id)} className="px-3 py-1.5 bg-teal-600 text-white text-xs font-bold rounded-lg hover:bg-teal-700 shadow-sm">‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á & ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                                    )}
                                    {hasPermission(12) && req.type === 'Local' && req.status === 'Approved' && (
                                      <button type="button" onClick={() => handleUpdateStatus(req.id, 'Ordered')} className="px-3 py-1.5 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 shadow-sm">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Local)</button>
                                    )}
                                    {hasPermission(15) && req.type === 'Local' && (req.status === 'Ordered' || req.status === 'Partially Received') && (
                                      <button type="button" onClick={() => openReceiveModal(req)} className="px-3 py-1.5 bg-teal-600 text-white text-xs font-bold rounded-lg hover:bg-teal-700 shadow-sm">‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á/‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>
                                    )}
                                    {hasPermission(11) && req.type === 'HO' && req.status === 'Approved' && req.purchaseType === 'Buy' && (
                                      <button type="button" onClick={() => openPRModal(req.id)} className="flex items-center gap-1 px-3 py-1.5 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 shadow-sm">‡∏≠‡∏≠‡∏Å PR</button>
                                    )}
                                    {hasPermission(12) && req.type === 'HO' && req.purchaseType === 'Buy' && req.status === 'PR Issued' && (
                                      <button type="button" onClick={() => openPOModal(req.id)} className="flex items-center gap-1 px-3 py-1.5 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 shadow-sm">‡∏≠‡∏≠‡∏Å PO</button>
                                    )}
                                    {hasPermission(13) && req.type === 'HO' && req.purchaseType === 'Buy' && req.status === 'PO Issued' && (
                                      <button type="button" onClick={() => handleUpdateStatus(req.id, 'Shipping')} className="px-3 py-1.5 bg-indigo-600 text-white text-xs font-bold rounded-lg hover:bg-indigo-700 shadow-sm">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</button>
                                    )}
                                    {hasPermission(14) && req.type === 'HO' && req.purchaseType === 'Rent' && req.status === 'Contract Pending' && (
                                      <button type="button" onClick={() => openContractModal(req.id)} className="flex items-center gap-1 px-3 py-1.5 bg-teal-600 text-white text-xs font-bold rounded-lg hover:bg-teal-700 shadow-sm"><FileSignature className="w-3 h-3"/> ‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß</button>
                                    )}
                                    {hasPermission(13) && req.type === 'HO' && req.purchaseType === 'Rent' && req.status === 'Contract Signed' && (
                                      <button type="button" onClick={() => handleUpdateStatus(req.id, 'Shipping')} className="flex items-center gap-1 px-3 py-1.5 bg-indigo-600 text-white text-xs font-bold rounded-lg hover:bg-indigo-700 shadow-sm"><Truck className="w-3 h-3"/> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</button>
                                    )}
                                    {hasPermission(15) && req.type === 'HO' && (req.status === 'Shipping' || req.status === 'Partially Received') && (
                                      <button type="button" onClick={() => openReceiveModal(req)} className="px-3 py-1.5 bg-green-600 text-white text-xs font-bold rounded-lg hover:bg-green-700 shadow-sm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</button>
                                    )}
                                    {(hasPermission(14) || hasPermission(13)) && req.type === 'HO' && req.purchaseType === 'Rent' && req.status === 'Approved' && (
                                      req.needContract !== false 
                                      ? (hasPermission(14) && <button type="button" onClick={() => handleUpdateStatus(req.id, 'Contract Pending')} className="flex items-center gap-1 px-3 py-1.5 bg-teal-600 text-white text-xs font-bold rounded-lg hover:bg-teal-700 shadow-sm">‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ï‡πà‡∏≠</button>)
                                      : (hasPermission(13) && <button type="button" onClick={() => handleUpdateStatus(req.id, 'Shipping')} className="flex items-center gap-1 px-3 py-1.5 bg-indigo-600 text-white text-xs font-bold rounded-lg hover:bg-indigo-700 shadow-sm">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</button>)
                                    )}
                                  </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
              </div>
            );
          })
        )}
      </div>
    </div>

    {/* --- 3. FLOATING ACTION BAR (BULK ACTION) --- */}
    {selectedOrderIds.length > 0 && (
        <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-6 z-[60] animate-in slide-in-from-bottom-4 border border-gray-700">
            <div className="flex items-center gap-3 border-r border-gray-600 pr-6">
                <span className="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                    {selectedOrderIds.length}
                </span>
                <span className="font-bold text-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
                <button onClick={() => setSelectedOrderIds([])} className="text-xs text-gray-400 hover:text-white underline ml-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
            
            <div className="flex gap-3">
                <button 
                    onClick={() => handleBulkAction('Reject')}
                    className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transition-colors flex items-center gap-2"
                >
                    <XCircle className="w-4 h-4"/> ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                <button 
                    onClick={() => handleBulkAction('Approve')}
                    className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transition-colors flex items-center gap-2"
                >
                    <CheckCircle className="w-4 h-4"/> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
        </div>
    )}

  </div>
)}
    
{/* INVENTORY TAB (UPDATED WITH MULTI-DELETE) */}
              {activeTab === 'inventory' && (
                <div className="space-y-6 max-w-7xl mx-auto">
                   <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                      <div className="px-6 py-4 border-b bg-gray-50 flex flex-col md:flex-row justify-between items-center gap-4">

         
                         
                         {/* Left: Title & Delete Button */}
                         <div className="flex items-center gap-4">
                             <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2">
                                 <Box className="w-5 h-5"/> ‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á 
                                 {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */}
                                 <span className="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full font-normal">
                                     {filteredInventory.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                 </span>
                             </h3>
                             
                             {/* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */}
                             {selectedInventory.length > 0 && invTabMode !== 'Summary' && hasPermission(18) && (
                                 <button 
                                    onClick={() => handleDeleteInventory()} 
                                    className="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-sm font-bold border border-red-200 hover:bg-red-100 flex items-center gap-2 animate-in fade-in"
                                >
                                     <Trash2 className="w-4 h-4"/> ‡∏•‡∏ö {selectedInventory.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                 </button>
                             )}
                         </div>
                         
                         {/* Middle: Tabs Selection */}
                         <div className="flex bg-gray-200 p-1 rounded-lg">
                            <button onClick={() => { setInvTabMode('System'); setSelectedInventory([]); }} className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${invTabMode === 'System' ? 'bg-white text-blue-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</button>
                            <button onClick={() => { setInvTabMode('NonSystem'); setSelectedInventory([]); }} className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${invTabMode === 'NonSystem' ? 'bg-white text-orange-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>‡∏Ç‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                            <button onClick={() => { setInvTabMode('Summary'); setSelectedInventory([]); }} className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${invTabMode === 'Summary' ? 'bg-white text-purple-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>‡∏£‡∏ß‡∏° (Summary)</button>
                         </div>

                         {/* Right: Search & Actions */}
                         <div className="flex gap-2 items-center">
                           <div className="relative w-48">
                                <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                                <input type="text" className="w-full pl-10 pr-4 py-1.5 border border-gray-300 rounded-lg text-sm outline-none" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." value={invSearch} onChange={e => setInvSearch(e.target.value)}/>
                           </div>
                           <button onClick={() => openGeneralHistory()} className="text-gray-600 text-sm font-medium flex items-center gap-1 hover:bg-gray-100 px-3 py-1.5 rounded"><ClipboardList className="w-4 h-4"/> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>



{/* ‡∏õ‡∏∏‡πà‡∏° Checklist - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin (2) ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (16, 17, 18) */}
{(hasPermission(2) || hasPermission(16) || hasPermission(17) || hasPermission(18)) && (
    <button 
        onClick={() => openChecklistModal('Inventory')} 
        className="bg-indigo-50 text-indigo-700 text-sm font-medium flex items-center gap-1 px-3 py-1.5 rounded hover:bg-indigo-100 border border-indigo-200 shadow-sm"
        title="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (Print Checklist)" // ‚≠ê Tooltip
    >
        <ClipboardList className="w-4 h-4"/> ‡∏û‡∏¥‡∏°‡∏û‡πå
    </button>
)}
                           
{/* ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Inventory) - ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå 16 */}
{hasPermission(16) && (
    <button 
        onClick={() => { 
            setShowAddInvModal(true); 
            setNewStockItem({ 
                name: '', qty: 0, unit: '‡∏ä‡∏¥‡πâ‡∏ô', minStock: 0, price: 0, images: [], stockType: 'System',
                project: globalProjectFilter !== 'All' ? globalProjectFilter : '',
                id: '', 
                isAutoId: true 
            });
        }}
        className="bg-green-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-1.5 rounded hover:bg-green-700"
        title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Add New Item)" // ‚≠ê Tooltip
    >
        <Plus className="w-4 h-4"/> ‡πÄ‡∏û‡∏¥‡πà‡∏°
    </button>
)}

{hasPermission(17) && ( // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    <button 
        onClick={() => {
            const itemsToAudit = filteredInventory.map(i => ({
                ...i,
                countedQty: i.qty,
                reason: ''
            }));
            setAuditItems(itemsToAudit);
            setShowAuditModal(true);
        }}
        className="bg-orange-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-1.5 rounded hover:bg-orange-700 shadow-sm"
        title="‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≠‡∏î (Stock Audit)" // ‚≠ê Tooltip
    >
        <ClipboardList className="w-4 h-4"/> ‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö
    </button>
)}

{hasPermission(22) && (
    <>
        <button 
            onClick={() => setShowImportInvModal(true)} 
            className="bg-teal-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-1.5 rounded hover:bg-teal-700 transition-colors shadow-sm"
            title="‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV (Import)"
        >
            <Download className="w-4 h-4 rotate-180"/> Import
        </button>
        
        {/* ‚≠ê ‡∏õ‡∏∏‡πà‡∏° Export Inventory */}
        <button 
            onClick={handleExportInventory} 
            className="bg-blue-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-1.5 rounded hover:bg-blue-700 transition-colors shadow-sm"
            title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV (Export)"
        >
            <Download className="w-4 h-4"/> Export
        </button>
    </>
)}


                         </div>
                      </div>

                      {/* TABLE */}
                      <table className="w-full text-sm text-left">
                         <thead className="bg-gray-100 text-gray-600">
                            <tr>
                                {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç hasPermission(18) */}
                                {invTabMode !== 'Summary' && hasPermission(18) && (
                                    <th className="px-4 py-3 w-10 text-center">
                                        <input type="checkbox" className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                                            checked={filteredInventory.length > 0 && selectedInventory.length === filteredInventory.length}
                                            onChange={toggleSelectAllInventory}
                                        />
                                    </th>
                                )}
                                
                                <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('id', invSort, setInvSort)}>‡∏£‡∏´‡∏±‡∏™ <ArrowUpDown className="w-3 h-3 inline"/></th>
                                <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('name', invSort, setInvSort)}>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <ArrowUpDown className="w-3 h-3 inline"/></th>
{globalProjectFilter === 'All' && invTabMode !== 'Summary' && (
    <th className="px-6 py-3 text-center cursor-pointer hover:bg-gray-200" onClick={() => handleSort('project', invSort, setInvSort)}>
    ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
</th>
)}

                                <th className="px-6 py-3 text-center cursor-pointer hover:bg-gray-200" onClick={() => handleSort('qty', invSort, setInvSort)}>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <ArrowUpDown className="w-3 h-3 inline"/></th>
                                <th className="px-6 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th className="px-6 py-3 text-center">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                            </tr>
                         </thead>
                         <tbody className="divide-y">
                             {filteredInventory.map(inv => (
                               <tr key={inv.id} onClick={() => openViewItem(inv)} className="hover:bg-gray-50 cursor-pointer">
                                  
                                  {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç hasPermission(18) */}
                                  {invTabMode !== 'Summary' && hasPermission(18) && (
                                      <td className="px-4 py-4 text-center" onClick={(e) => e.stopPropagation()}>
                                           <input type="checkbox" className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                                               checked={selectedInventory.includes(inv.id)}
                                               onChange={() => toggleSelectInventory(inv.id)}
                                          />
                                      </td>
                                  )}

                                  <td className="px-6 py-4 font-medium text-gray-500">
    {/* ‚≠ê ‡πÉ‡∏ä‡πâ getDisplayId ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà‡∏£‡∏´‡∏±‡∏™‡∏™‡∏±‡πâ‡∏ô */}
    {inv.isSummary ? <span className="italic text-gray-400">Sum</span> : getDisplayId(inv.id)}
</td>
                                  <td className="px-6 py-4">
                                       <div className="font-medium text-gray-900">{inv.name}</div>
                                       
                                       {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á Summary */}
                                       {inv.isSummary ? (
                                           <div className="mt-1 space-y-1">
                                               {/* ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó System / NonSystem */}
                                               <div className="flex gap-2 text-[10px]">
                                                   <span className="bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded border border-blue-100 font-bold">
                                                       ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: {inv.systemQty}
                                                   </span>
                                                   <span className="bg-orange-50 text-orange-700 px-1.5 py-0.5 rounded border border-orange-100 font-bold">
                                                       ‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö: {inv.nonSystemQty}
                                                   </span>
                                               </div>
                                               
                                               {/* ‡πÅ‡∏¢‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£) */}
                                               {globalProjectFilter === 'All' && inv.projectBreakdown && (
                                                   <div className="flex flex-wrap gap-1 mt-1">
                                                       {Object.entries(inv.projectBreakdown).map(([proj, qty]) => (
                                                           <span key={proj} className="text-[9px] bg-gray-100 text-gray-600 px-1.5 rounded border border-gray-200" title={`‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${proj}`}>
                                                               {proj}: <b>{qty}</b>
                                                           </span>
                                                       ))}
                                                   </div>
                                               )}
                                           </div>
                                       ) : (
                                           /* ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡πÅ‡∏™‡∏î‡∏á ID ‡∏£‡∏ß‡∏°) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Summary ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏∞‡πÑ‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏° */
                                           null
                                       )}
                                  </td>

                                  {globalProjectFilter === 'All' && invTabMode !== 'Summary' && (
    <td className="px-6 py-4 text-center">
        <span className="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs font-bold border border-indigo-100">
            {inv.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á'}
        </span>
    </td>
)}
                                  <td className="px-6 py-4 text-center">
                                      <span className={`text-lg font-bold ${inv.isSummary ? 'text-purple-600' : 'text-blue-600'}`}>
                                          {inv.qty}
                                      </span> 
                                      <span className="text-gray-500 text-xs ml-1">{inv.unit}</span>
                                  </td>
                                  <td className="px-6 py-4 text-center">
                                      {inv.qty < inv.minStock ? <span className="text-red-600 text-xs font-bold bg-red-50 px-2 py-1 rounded">‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå</span> : <span className="text-green-600 text-xs bg-green-50 px-2 py-1 rounded">‡∏õ‡∏Å‡∏ï‡∏¥</span>}
                                  </td>
                                  <td className="px-6 py-4 text-center text-xs text-gray-500">{inv.lastUpdated || '-'}</td>
                               </tr>
                            ))}
                            {filteredInventory.length === 0 && (
                                <tr>
                                    <td colSpan={invTabMode !== 'Summary' ? 6 : 5} className="text-center py-8 text-gray-400">
                                        ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                    </td>
                                </tr>
                            )}
                         </tbody>
                      </table>
                   </div>
                </div>
              )}
    
{/* ASSETS TAB (UPDATED: Summary No Action Column) */}
      {activeTab === 'assets' && (
        <div className="space-y-6 max-w-7xl mx-auto">
           <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
              <div className="px-6 py-4 border-b bg-gray-50 flex flex-col md:flex-row justify-between items-center gap-4">


                 
                 {/* Left Side */}
                 <div className="flex items-center gap-4">
                     <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2">
                         <Monitor className="w-5 h-5"/> ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô
                         
                         {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */}
                         <span className="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full font-normal">
                             {filteredAssets.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                         </span>
                     </h3>
                     {/* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡∏ã‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Summary) */}
                     {selectedAssets.length > 0 && assetTabMode !== 'Summary' && hasPermission(21) && (
                         <button onClick={() => handleDeleteAssets()} className="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-sm font-bold border border-red-200 hover:bg-red-100 flex items-center gap-2 animate-in fade-in">
                             <Trash2 className="w-4 h-4"/> ‡∏•‡∏ö {selectedAssets.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                         </button>
                     )}
                 </div>
                 
                 {/* Middle: Search */}
                 <div className="flex items-center gap-3 flex-1 justify-end w-full md:w-auto">
                    <div className="relative w-full md:w-64">
                        <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                        <input type="text" className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™, ‡∏ä‡∏∑‡πà‡∏≠..." value={assetSearch} onChange={e => setAssetSearch(e.target.value)}/>
                    </div>
                 </div>

                 {/* Right: Actions & Tabs */}
                 <div className="flex gap-3">
                    <div className="flex bg-gray-100 p-1 rounded-lg">
                        <button onClick={() => setAssetTabMode('Company')} className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${assetTabMode === 'Company' ? 'bg-white text-blue-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</button>
                        <button onClick={() => setAssetTabMode('Rent')} className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${assetTabMode === 'Rent' ? 'bg-white text-teal-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>‡πÄ‡∏ä‡πà‡∏≤</button>
                        <button onClick={() => setAssetTabMode('Summary')} className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${assetTabMode === 'Summary' ? 'bg-white text-purple-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>‡∏£‡∏ß‡∏°</button>
                    </div>

                    <button onClick={() => openGeneralHistory()} className="text-gray-600 text-sm font-medium flex items-center gap-1 hover:bg-gray-100 px-3 py-1.5 rounded"><ClipboardList className="w-4 h-4"/> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>


                {/* ‡∏õ‡∏∏‡πà‡∏° Checklist - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin (2) ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (19, 20, 21) */}
{(hasPermission(2) || hasPermission(19) || hasPermission(20) || hasPermission(21)) && (
    <button 
        onClick={() => openChecklistModal('Asset')} 
        className="bg-indigo-50 text-indigo-700 text-sm font-medium flex items-center gap-1 px-3 py-1.5 rounded hover:bg-indigo-100 border border-indigo-200 shadow-sm"
        title="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Print Asset List)" // ‚≠ê Tooltip
    >
        <ClipboardList className="w-4 h-4"/> ‡∏û‡∏¥‡∏°‡∏û‡πå
    </button>
)}
                    

               {/* ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Asset) - ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå 19 */}
{hasPermission(19) && (
    <button 
        onClick={() => { 
            setShowAssetModal(true); 
            setNewAssetItem({ 
                id: '', isAutoId: false, name: '', serial: '', status: 'Available', condition: 'Good', ownerType: '', price: 0, rentalPrice: 0, rentalUnit: 'Month', images: [],
                project: globalProjectFilter !== 'All' ? globalProjectFilter : '' 
            });
        }} 
        className="bg-indigo-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-1.5 rounded hover:bg-indigo-700"
        title="‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà (Register New Asset)" // ‚≠ê Tooltip
    >
        <Plus className="w-4 h-4"/> ‡πÄ‡∏û‡∏¥‡πà‡∏°
    </button>
)}

{/* ‚≠ê ‡∏õ‡∏∏‡πà‡∏° Import ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Asset) - ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå 23 */}
{hasPermission(23) && (
    <>
        <button 
            onClick={() => setShowImportAssetModal(true)} 
            className="bg-green-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-1.5 rounded hover:bg-green-700"
            title="‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV (Import)"
        >
            <Download className="w-4 h-4 rotate-180"/> Import
        </button>

        {/* ‚≠ê ‡∏õ‡∏∏‡πà‡∏° Export Assets */}
        <button 
            onClick={handleExportAssets} 
            className="bg-blue-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-1.5 rounded hover:bg-blue-700"
            title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV (Export)"
        >
            <Download className="w-4 h-4"/> Export
        </button>
    </>
)}
                 </div>
              </div>
              
              <div className="overflow-x-auto">
                  <table className="w-full text-sm text-left min-w-[1000px]">
                     <thead className="bg-gray-100 text-gray-600">
                        <tr>
                            {/* Checkbox Header (‡∏ã‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤ Summary) */}
                            {assetTabMode !== 'Summary' && hasPermission(21) && (
                                
                                <th className="px-4 py-3 w-10 text-center">
                                    <input type="checkbox" className="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer" 
                                        checked={filteredAssets.length > 0 && selectedAssets.length === filteredAssets.length}
                                        onChange={toggleSelectAllAssets}
                                    />
                                </th>
                            )}
                            
                            {assetTabMode === 'Summary' ? (
                                /* ‚≠ê Header ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î Summary (‡∏ï‡∏±‡∏î Action ‡∏≠‡∏≠‡∏Å) */
                                <>
                                    <th className="px-6 py-3 text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Name)</th>
                                    <th className="px-6 py-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°</th>
                                    <th className="px-6 py-3 text-center text-blue-700">‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
                                    <th className="px-6 py-3 text-center text-orange-700">‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤</th>
                                </>
                            ) : (
                                /* Header ‡∏õ‡∏Å‡∏ï‡∏¥ */
                                <>
                                    <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('id', assetSort, setAssetSort)}>‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô <ArrowUpDown className="w-3 h-3 inline"/></th>
                                    <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('name', assetSort, setAssetSort)}>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <ArrowUpDown className="w-3 h-3 inline"/></th>
{globalProjectFilter === 'All' && assetTabMode !== 'Summary' && (
    <th className="px-6 py-3 text-center cursor-pointer hover:bg-gray-200" onClick={() => handleSort('project', assetSort, setAssetSort)}>
    ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
</th>
)}

                                    <th className="px-6 py-3">Serial No.</th>
                                    <th className="px-6 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    {assetTabMode === 'Rent' && <th className="px-6 py-3">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πà‡∏≤</th>}
                                    {assetTabMode === 'Rent' && <th className="px-6 py-3 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ä‡πà‡∏≤</th>}
                                    <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('holder', assetSort, setAssetSort)}>‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á <ArrowUpDown className="w-3 h-3 inline"/></th>
                                    <th className="px-6 py-3 text-center">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                </>
                            )}
                        </tr>
                     </thead>
                     <tbody className="divide-y">
                        {filteredAssets.map(ast => (
                            <tr key={ast.id} 
                                onClick={() => {
                                    if (assetTabMode === 'Summary') {
                                        setSelectedAssetGroup(ast);
                                        setShowAssetGroupModal(true);
                                    } else {
                                        openViewItem(ast);
                                    }
                                }} 
                                className={`cursor-pointer transition-colors ${
                                    !ast.isSummary && ast.priority === 2 ? 'bg-red-50 hover:bg-red-100 border-l-4 border-red-500' : 
                                    !ast.isSummary && ast.priority === 1 ? 'bg-orange-50 hover:bg-orange-100 border-l-4 border-orange-400' : 
                                    'hover:bg-gray-50'
                                }`}
                            >
                               {assetTabMode === 'Summary' ? (
                                   /* ‚≠ê Body ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î Summary (‡∏ï‡∏±‡∏î Action ‡∏≠‡∏≠‡∏Å) */
                                   <>
                                       <td className="px-6 py-4 font-bold text-gray-800">{ast.name}</td>
                                       <td className="px-6 py-4 text-center">
                                           <span className="bg-purple-100 text-purple-800 px-3 py-1 rounded-full font-bold">{ast.totalQty}</span>
                                       </td>
                                       <td className="px-6 py-4 text-center font-bold text-blue-600">{ast.companyQty}</td>
                                       <td className="px-6 py-4 text-center font-bold text-orange-600">{ast.rentQty}</td>
                                   </>
                               ) : (
                                   /* Body ‡∏õ‡∏Å‡∏ï‡∏¥ */
                                   <>
                                       {assetTabMode !== 'Summary' && hasPermission(21) && (
                                       <td className="px-4 py-4 text-center" onClick={(e) => e.stopPropagation()}>
                                           <input type="checkbox" className="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer" 
                                               checked={selectedAssets.includes(ast.id)}
                                               onChange={() => toggleSelectAsset(ast.id)}
                                           />
                                       </td>
                                       )}
<td className="px-6 py-4 font-medium text-gray-500">
    {ast.id}
    
    {/* ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (Contract Alerts) */}
    {ast.alertType === 'expired' && <span className="block text-[9px] text-red-600 font-bold bg-red-50 px-1 rounded w-fit mt-1">‡∏´‡∏°‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß</span>}
    {ast.alertType === 'expiring' && <span className="block text-[9px] text-orange-600 font-bold bg-orange-50 px-1 rounded w-fit mt-1">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {ast.daysLeft} ‡∏ß‡∏±‡∏ô</span>}
    
    {/* ‚≠ê ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏¢‡∏∑‡∏°‡πÄ‡∏Å‡∏¥‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ isOverdue = true) */}
    {ast.isOverdue && (
        <span className="block text-[9px] text-purple-600 font-bold bg-purple-50 px-1 rounded w-fit mt-1">
            ‡∏¢‡∏∑‡∏°‡πÄ‡∏Å‡∏¥‡∏ô {ast.overdueDays} ‡∏ß‡∏±‡∏ô
        </span>
    )}
</td>
                                       <td className="px-6 py-4 font-medium text-gray-900">{ast.name}</td>
{globalProjectFilter === 'All' && assetTabMode !== 'Summary' && (
    <td className="px-6 py-4 text-center">
        <span className="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs font-bold border border-indigo-100">
            {ast.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á'}
        </span>
    </td>
)}

                                       <td className="px-6 py-4 text-gray-500">{ast.serial}</td>
                                       <td className="px-6 py-4 text-center">
    <span className={`px-2 py-1 rounded text-xs font-bold ${
        ast.status === 'Available' ? 'bg-green-100 text-green-700' :
        ast.status === 'Borrowed' ? 'bg-orange-100 text-orange-700' :
        ast.status === 'Lost' ? 'bg-gray-800 text-white' :
        ast.status === 'Damaged' ? 'bg-red-100 text-red-700' : 'bg-gray-100'
    }`}>
        {/* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å {ast.status} ‡πÄ‡∏õ‡πá‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */}
        {ASSET_STATUS_LABELS[ast.status] || ast.status}
    </span>
</td>
                                       {assetTabMode === 'Rent' && (
                                            <td className="px-6 py-4 text-xs">
                                                <div className="flex flex-col gap-1">
                                                    <span className="flex items-center gap-1 text-green-700"><Calendar className="w-3 h-3"/> {ast.rentalStart || '-'}</span>
                                                    <span className="flex items-center gap-1 text-red-700"><CalendarClock className="w-3 h-3"/> {ast.rentalEnd || '-'}</span>
                                                </div>
                                            </td>
                                       )}
                                       {assetTabMode === 'Rent' && (
                                            <td className="px-6 py-4 text-right font-medium text-gray-900">
                                                {ast.rentalPrice?.toLocaleString()} <span className="text-gray-400 text-xs font-normal">{RENTAL_UNITS[ast.rentalUnit]}</span>
                                            </td>
                                       )}
                                       <td className="px-6 py-4">{ast.holder}</td>
                                       <td className="px-6 py-4 text-center text-xs text-gray-500">{ast.lastUpdated || '-'}</td>
                                   </>
                               )}
                            </tr>
                         ))}
                     </tbody>
                  </table>
              </div>
           </div>
        </div>
      )}

 {/* --- PROJECT SETTINGS TAB --- */}
      {activeTab === 'projects' && (
        <div className="space-y-6 max-w-7xl mx-auto">
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
<div className="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
    <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2"><Settings className="w-5 h-5"/> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project Settings)</h3>
    
    {/* ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå 26 (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà */}
    {hasPermission(26) && (
        <button 
            onClick={() => { 
                const newId = `PJ-${Date.now().toString().slice(-4)}`;
                // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° budget ‡πÉ‡∏ô object ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô) ‡πÅ‡∏ï‡πà array ‡∏ß‡πà‡∏≤‡∏á‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ
                setEditingProject({ id: newId, originalId: newId, name: '', subJobs: [], matCodes: [], isNew: true });
                setProjectFormTab('General');
                setShowProjectModal(true); 
            }} 
            className="bg-indigo-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-sm"
        >
            <Plus className="w-4 h-4"/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
        </button>
    )}
</div>

                <div className="p-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {projects.map(proj => (
                            <div 
                                key={proj.id} 
                                onClick={() => { setViewingProject(proj); setShowProjectDetailModal(true); }}
                                className="bg-white border border-gray-200 rounded-xl p-5 shadow-sm hover:shadow-md hover:border-indigo-300 transition-all group relative cursor-pointer"
                            >
                                <div className="flex justify-between items-start mb-2">
                                    <div>
                                        <h4 className="font-bold text-gray-800 text-lg group-hover:text-indigo-700 transition-colors">{proj.name}</h4>
                                        <span className="text-xs font-mono text-gray-500 bg-gray-100 px-2 py-0.5 rounded border border-gray-200">{proj.id}</span>
                                    </div>
                                    <div className="bg-gray-50 p-1.5 rounded-lg text-gray-400 group-hover:text-indigo-600 transition-colors">
                                        <ChevronRight className="w-5 h-5"/>
                                    </div>
                                </div>
                                <div className="space-y-2 mt-4 pt-4 border-t border-gray-100">
                                    <div className="flex justify-between text-sm text-gray-600">
                                        <span className="flex items-center gap-1"><List className="w-3 h-3"/> SubJobs</span>
                                        <span className="font-bold bg-indigo-50 text-indigo-700 px-2 rounded-full text-xs">{proj.subJobs?.length || 0}</span>
                                    </div>
                                    <div className="flex justify-between text-sm text-gray-600">
                                        <span className="flex items-center gap-1"><Tag className="w-3 h-3"/> Mat. Codes</span>
                                        <span className="font-bold bg-purple-50 text-purple-700 px-2 rounded-full text-xs">{proj.matCodes?.length || 0}</span>
                                    </div>
                                </div>
                            </div>
                        ))}
                        {projects.length === 0 && (
                            <div className="col-span-full py-16 text-center text-gray-400 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                                <Settings className="w-12 h-12 mx-auto mb-3 opacity-20"/>
                                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                                <p className="text-xs mt-1">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
      )}

{/* --- USER MANAGEMENT TAB (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ + ‡πÅ‡∏¢‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô) --- */}
      {activeTab === 'users' && (
          <div className="space-y-6 max-w-7xl mx-auto">
              <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                  
                  {/* Header & Search Bar */}
                  <div className="px-6 py-4 border-b bg-gray-50 flex flex-col md:flex-row justify-between items-center gap-4">
                      <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2">
                          <User className="w-5 h-5"/> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (User Management)
                      </h3>
                      
                      {/* ‚≠ê ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ User */}
                      <div className="relative w-full md:w-64">
                          <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                          <input 
                              type="text" 
                              className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500 bg-white" 
                              placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™..." 
                              value={userSearch} 
                              onChange={e => setUserSearch(e.target.value)}
                          />
                      </div>
                  </div>

                  <div className="overflow-x-auto">
                      <table className="w-full text-sm text-left">
                          <thead className="bg-gray-100 text-gray-600 font-bold border-b">
                              <tr>
                                  <th className="px-6 py-3">Username</th>
                                  <th className="px-6 py-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                  <th className="px-6 py-3">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                                  <th className="px-6 py-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                  <th className="px-6 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
                              </tr>
                          </thead>
                          <tbody className="divide-y">
                              {(() => {
                                  // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                                  let filtered = allUsers;
                                  if (userSearch) {
                                      const lower = userSearch.toLowerCase();
                                      filtered = filtered.filter(u => 
                                          u.username.toLowerCase().includes(lower) ||
                                          u.firstName.toLowerCase().includes(lower) ||
                                          u.lastName.toLowerCase().includes(lower) ||
                                          u.empId.toLowerCase().includes(lower)
                                      );
                                  }

                                  // 2. ‚≠ê ‡πÅ‡∏¢‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Current User) ‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î
                                  const myUser = filtered.find(u => u.id === user.id);
                                  const others = filtered.filter(u => u.id !== user.id);
                                  
                                  // ‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å
                                  const displayList = myUser ? [myUser, ...others] : others;

                                  if (displayList.length === 0) {
                                      return <tr><td colSpan="5" className="p-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td></tr>;
                                  }

                                  return displayList.map((u) => {
                                      const isMe = u.id === user.id; // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                                      return (
                                          <tr 
                                              key={u.id} 
                                              className={`border-b cursor-pointer transition-colors ${isMe ? 'bg-blue-50/60 hover:bg-blue-100' : 'hover:bg-blue-50'}`}
                                              onClick={() => {
                                                  setViewingUser(u);
                                                  setUserDetailTab('info');
                                                  setDetailSearch('');
                                              }}
                                          >
                                              <td className="px-6 py-4 font-bold text-gray-800 flex items-center gap-2">
                                                  {u.username}
                                                  {/* ‚≠ê ‡∏ï‡∏¥‡∏î‡∏õ‡πâ‡∏≤‡∏¢ Me ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏≤ */}
                                                  {isMe && <span className="text-[10px] bg-blue-600 text-white px-2 py-0.5 rounded-full shadow-sm">Me</span>}
                                              </td>
                                              <td className="px-6 py-4">{u.firstName} {u.lastName}</td>
                                              <td className="px-6 py-4 font-mono text-gray-500">{u.empId}</td>
                                              <td className="px-6 py-4">
                                                  {/* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin */}
                                                  {(user.isSuperAdmin || hasPermission(2) || hasPermission(3)) ? (
                                                      <button 
                                                          onClick={(e) => {
                                                              e.stopPropagation();
                                                              const newStatus = u.status === 'Activated' ? 'Deactivated' : 'Activated';
                                                              const updatedUser = { ...u, status: newStatus };
                                                              setAllUsers(prev => prev.map(x => x.id === u.id ? updatedUser : x));
                                                              google.script.run.saveUserData(updatedUser);
                                                          }}
                                                          className={`px-3 py-1 rounded-full text-xs font-bold border transition-colors ${u.status === 'Activated' ? 'bg-green-100 text-green-700 border-green-200 hover:bg-green-200' : u.status === 'New' ? 'bg-blue-100 text-blue-700 border-blue-200 hover:bg-blue-200' : 'bg-red-100 text-red-700 border-red-200 hover:bg-red-200'}`}
                                                      >
                                                          {u.status}
                                                      </button>
                                                  ) : (
                                                      <span className={`px-3 py-1 rounded-full text-xs font-bold border ${u.status === 'Activated' ? 'bg-green-50 text-green-600 border-green-100' : u.status === 'New' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-red-50 text-red-600 border-red-100'}`}>
                                                          {u.status}
                                                      </span>
                                                  )}
                                              </td>
                                              <td className="px-6 py-4 text-center">
                                                  <button 
                                                      onClick={(e) => {
    e.stopPropagation();
    setSelectedUserForEdit(u);
    // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠
    if (projects && projects.length > 0) {
        setPermissionTab(projects[0].name); 
    } else {
        setPermissionTab('');
    }
    setShowPermissionModal(true);
}}
                                                      className="bg-blue-50 text-blue-600 p-2 rounded-lg hover:bg-blue-100 transition-colors border border-blue-200"
                                                      title="‡∏î‡∏π/‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå"
                                                  >
                                                      <Settings className="w-4 h-4"/>
                                                  </button>
                                              </td>
                                          </tr>
                                      );
                                  });
                              })()}
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      )}

{/* --- PROJECT DETAIL MODAL (UPDATED: Clickable Cards & Fixed Close Button) --- */}
      {showProjectDetailModal && viewingProject && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-in fade-in">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl h-[85vh] flex flex-col overflow-hidden animate-in zoom-in-95">
                  
                  {/* Header & Fixed Close Button */}
                  <div className="px-6 py-4 border-b bg-white flex justify-between items-start sticky top-0 z-10">
                      <div>
                          <h3 className="font-bold text-xl text-gray-800">{viewingProject.name}</h3>
                          <span className="text-sm font-mono text-gray-500 bg-gray-100 px-2 py-0.5 rounded border mt-1 inline-block">{viewingProject.id}</span>
                      </div>
                      <button 
                          onClick={() => setShowProjectDetailModal(false)} 
                          className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
                          title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á"
                      >
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                              <line x1="18" y1="6" x2="6" y2="18"></line>
                              <line x1="6" y1="6" x2="18" y2="18"></line>
                          </svg>
                      </button>
                  </div>

                  <div className="flex-1 overflow-y-auto p-6 bg-slate-50 space-y-6">
                      
                      {/* Clickable Stats Cards */}
                      <div className="grid grid-cols-2 gap-4">
                          <div 
                              onClick={() => setProjectDetailTab('SubJob')}
                              className={`p-4 rounded-xl border shadow-sm cursor-pointer transition-all flex flex-col items-center justify-center gap-2 group ${projectDetailTab === 'SubJob' ? 'bg-indigo-50 border-indigo-200 ring-2 ring-indigo-100' : 'bg-white border-gray-200 hover:border-indigo-200'}`}
                          >
                              <div className={`p-3 rounded-full ${projectDetailTab === 'SubJob' ? 'bg-indigo-200 text-indigo-700' : 'bg-gray-100 text-gray-400 group-hover:bg-indigo-50 group-hover:text-indigo-600'}`}>
                                  <List className="w-6 h-6"/>
                              </div>
                              <div className="text-center">
                                  <p className={`text-2xl font-bold ${projectDetailTab === 'SubJob' ? 'text-indigo-700' : 'text-gray-800'}`}>
                                      {viewingProject.subJobs?.length || 0}
                                  </p>
                                  <p className="text-xs font-bold text-gray-500">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ SubJobs</p>
                              </div>
                          </div>

                          <div 
                              onClick={() => setProjectDetailTab('matCode')}
                              className={`p-4 rounded-xl border shadow-sm cursor-pointer transition-all flex flex-col items-center justify-center gap-2 group ${projectDetailTab === 'matCode' ? 'bg-purple-50 border-purple-200 ring-2 ring-purple-100' : 'bg-white border-gray-200 hover:border-purple-200'}`}
                          >
                              <div className={`p-3 rounded-full ${projectDetailTab === 'matCode' ? 'bg-purple-200 text-purple-700' : 'bg-gray-100 text-gray-400 group-hover:bg-purple-50 group-hover:text-purple-600'}`}>
                                  <Tag className="w-6 h-6"/>
                              </div>
                              <div className="text-center">
                                  <p className={`text-2xl font-bold ${projectDetailTab === 'matCode' ? 'text-purple-700' : 'text-gray-800'}`}>
                                      {viewingProject.matCodes?.length || 0}
                                  </p>
                                  <p className="text-xs font-bold text-gray-500">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Mat. Codes</p>
                              </div>
                          </div>
                      </div>

                 {/* Full List Table */}
                      <div className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm animate-in fade-in">
                          {/* ... (Header div ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ... */}
                          
                          <div className="max-h-[300px] overflow-y-auto">
                              <table className="w-full text-sm text-left">
                                  <thead className="bg-gray-50 text-gray-600 sticky top-0 shadow-sm">
                                      <tr>
                                          {/* ‚≠ê ‡∏¢‡πâ‡∏≤‡∏¢ Group ‡∏°‡∏≤‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å */}
                                          <th className="px-4 py-2 w-32">Group</th>
                                          <th className="px-4 py-2 w-24">Code</th>
                                          <th className="px-4 py-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Description)</th>
                                          <th className="px-4 py-2 text-right">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Budget)</th> 
                                      </tr>
                                  </thead>
                                  <tbody className="divide-y">
                                      {(projectDetailTab === 'SubJob' ? (viewingProject.subJobs || []) : (viewingProject.matCodes || [])).map((item, i) => (
                                          <tr key={i} className="hover:bg-gray-50">
                                              {/* ‚≠ê ‡πÅ‡∏™‡∏î‡∏á Group ‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å */}
                                              <td className="px-4 py-2 text-gray-600 font-bold text-xs">{item.group || '-'}</td>
                                              <td className={`px-4 py-2 font-mono text-xs font-bold ${projectDetailTab === 'SubJob' ? 'text-indigo-600' : 'text-purple-600'}`}>{item.code}</td>
                                              <td className="px-4 py-2 text-gray-700">{item.description}</td>
                                              <td className="px-4 py-2 text-right font-mono text-gray-600">
                                                  {item.budget ? item.budget.toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}
                                              </td>
                                          </tr>
                                      ))}

                                      {(projectDetailTab === 'SubJob' ? (viewingProject.subJobs || []) : (viewingProject.matCodes || [])).length === 0 && (
                                          <tr><td colSpan="2" className="px-4 py-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                                      )}
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>


<div className="p-5 border-t bg-white flex gap-3">
    {/* ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå 26 ‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà (viewingProject.name) */}
    {hasPermission(26, viewingProject.name) && (
        <button 
            onClick={() => handleDeleteProject(viewingProject.id)} 
            className="flex-1 py-2.5 border border-red-200 text-red-600 rounded-xl font-bold hover:bg-red-50 flex items-center justify-center gap-2 transition-colors"
        >
            <Trash2 className="w-4 h-4"/> ‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
        </button>
    )}
    
    {/* ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå 26 ‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà */}
    {hasPermission(26, viewingProject.name) && (
        <button 
            onClick={() => { 
                setEditingProject({...viewingProject, originalId: viewingProject.id, isNew: false});
                setProjectFormTab('General'); 
                setShowProjectModal(true); 
            }} 
            className="flex-1 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md flex items-center justify-center gap-2 transition-colors"
        >
            <Edit className="w-4 h-4"/> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
    )}
</div>
              </div>
          </div>
      )}

{/* --- PROJECT MODAL (UPDATED: Visible Delete Button) --- */}
      {showProjectModal && editingProject && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[110] p-4 backdrop-blur-sm animate-in fade-in">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col overflow-hidden">
                  
                  {/* Header */}
                  <div className="px-6 py-4 border-b bg-white flex justify-between items-center">
                      <h3 className="font-bold text-xl text-indigo-800">{editingProject.isNew ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£'}</h3>
                      <button onClick={() => setShowProjectModal(false)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-gray-500"/></button>
                  </div>

                  {/* Tabs */}
                  <div className="flex border-b bg-gray-50 px-6 pt-2">
                      {['General', 'SubJob', 'matCode'].map(tab => (
                          <button 
                            key={tab}
                            onClick={() => setProjectFormTab(tab)}
                            className={`px-6 py-3 text-sm font-bold border-b-2 transition-colors ${projectFormTab === tab ? 'border-indigo-600 text-indigo-700 bg-white rounded-t-lg' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                          >
                              {tab === 'General' ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' : tab === 'SubJob' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ SubJob' : '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Mat. Code'}
                          </button>
                      ))}
                  </div>

                  {/* Content */}
                  <div className="flex-1 overflow-y-auto p-8 bg-slate-50">
                      {projectFormTab === 'General' && (
                          <div className="space-y-4 max-w-lg mx-auto bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                              <div>
                                  <label className="block text-sm font-bold text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project ID)</label>
                                  <input 
                                      type="text" 
                                      className="w-full p-2.5 border rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 font-mono" 
                                      value={editingProject.id} 
                                      onChange={e => setEditingProject({...editingProject, id: e.target.value})}
                                      placeholder="‡πÄ‡∏ä‡πà‡∏ô PJ-001"
                                  />
                                  <p className="text-xs text-gray-400 mt-1">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô</p>
                              </div>
                              <div>
                                  <label className="block text-sm font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project Name)</label>
                                  <input type="text" className="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500" value={editingProject.name} onChange={e => setEditingProject({...editingProject, name: e.target.value})} autoFocus />
                              </div>
                          </div>
                      )}

                      {(projectFormTab === 'SubJob' || projectFormTab === 'matCode') && (
                          <div className="space-y-4">
                              {/* CSV Note */}
                              {/* CSV Note */}
                              <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 flex gap-3 text-sm text-blue-800 items-start">
                                  <Info className="w-5 h-5 shrink-0 mt-0.5"/>
                                  <div>
                                      <p className="font-bold">‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå CSV</p>
                                      {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ */}
                                      <ul className="list-disc pl-4 mt-1 text-xs">
                                          <li>‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Header) ‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å ‡πÄ‡∏ä‡πà‡∏ô <code>Group, Code, Description, Budget</code></li>
                                          <li>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏•‡∏∏‡πà‡∏° (Group) | ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 2: ‡∏£‡∏´‡∏±‡∏™ (Code) | ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 3: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î | <b>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 4: ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</b></li>
                                          <li>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (UTF-8)</li>
                                      </ul>
                                  </div>
                              </div>

                              <div className="flex justify-between items-center mb-4">
    <div className="flex gap-2">
        <h4 className="font-bold text-gray-800">
            {projectFormTab === 'SubJob' ? 'SubJob' : 'Mat. Code'} List
        </h4>
        <span className="bg-gray-200 text-gray-600 px-2 py-0.5 rounded text-xs font-bold flex items-center">
            {/* ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ matCodes ‡πÅ‡∏ó‡∏ô epCodes */}
            {editingProject[projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes']?.length || 0}
        </span>
    </div>
    
    <label className="cursor-pointer bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm transition-colors">
        <Upload className="w-4 h-4"/> Import CSV
        <input 
            type="file" 
            accept=".csv" 
            className="hidden" 
            // ‚≠ê ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ 'matCodes' ‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô import
            onChange={(e) => handleImportProjectData(e, projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes')} 
        />
    </label>
</div>
                              {/* --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏¢‡πâ‡∏≤‡∏¢ Group ‡πÑ‡∏õ‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å) --- */}
                              <div className="bg-white border rounded-xl overflow-hidden shadow-sm">
                                  <table className="w-full text-sm text-left">
                                      <thead className="bg-gray-100 text-gray-600">
                                          <tr>
                                              <th className="px-4 py-2 w-10 text-center">#</th>
                                              {/* ‚≠ê ‡∏¢‡πâ‡∏≤‡∏¢ Group ‡∏°‡∏≤‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å */}
                                              <th className="px-4 py-2 w-32">Group</th>
                                              <th className="px-4 py-2 w-40">Code</th>
                                              <th className="px-4 py-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Description)</th>
                                              <th className="px-4 py-2 w-32 text-right">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</th>
                                              <th className="px-4 py-2 w-20 text-center">Action</th>
                                          </tr>
                                      </thead>
                                      <tbody className="divide-y">
                                          {(editingProject[projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes'] || []).map((item, idx) => (
                                              <tr key={idx} className="hover:bg-gray-50 group">
                                                  {/* 1. ‡∏•‡∏≥‡∏î‡∏±‡∏ö */}
                                                  <td className="px-4 py-2 text-center text-gray-400 text-xs">{idx+1}</td>
                                                  
                                                  {/* ‚≠ê 2. Group (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) */}
                                                  <td className="px-4 py-2">
                                                      <input 
                                                          type="text" 
                                                          className="w-full bg-transparent outline-none border-b border-transparent focus:border-gray-300 text-sm font-bold text-gray-700" 
                                                          value={item.group || ''} 
                                                          onChange={(e) => {
                                                              const list = [...(editingProject[projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes'])];
                                                              list[idx].group = e.target.value;
                                                              setEditingProject({...editingProject, [projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes']: list});
                                                          }}
                                                          placeholder="Group"
                                                      />
                                                  </td>

                                                  {/* 3. Code */}
                                                  <td className="px-4 py-2">
                                                      <input 
                                                          type="text" 
                                                          className="w-full bg-transparent outline-none focus:text-indigo-800 border-b border-transparent focus:border-indigo-300 font-mono font-bold text-indigo-600" 
                                                          value={item.code} 
                                                          onChange={(e) => {
                                                              const list = [...(editingProject[projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes'])];
                                                              list[idx].code = e.target.value;
                                                              setEditingProject({...editingProject, [projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes']: list});
                                                          }}
                                                          placeholder="Code"
                                                      />
                                                  </td>

                                                  {/* 4. Description */}
                                                  <td className="px-4 py-2">
                                                      <input 
                                                          type="text" 
                                                          className="w-full bg-transparent outline-none border-b border-transparent focus:border-gray-300" 
                                                          value={item.description} 
                                                          onChange={(e) => {
                                                              const list = [...(editingProject[projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes'])];
                                                              list[idx].description = e.target.value;
                                                              setEditingProject({...editingProject, [projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes']: list});
                                                          }}
                                                          placeholder="Description"
                                                      />
                                                  </td>

                                                  {/* 5. Budget */}
                                                  <td className="px-4 py-2">
                                                      <input 
                                                          type="number" 
                                                          min="0"
                                                          className="w-full bg-transparent outline-none border-b border-transparent focus:border-gray-300 text-right font-mono" 
                                                          value={item.budget || ''} 
                                                          onChange={(e) => {
                                                              const list = [...(editingProject[projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes'])];
                                                              list[idx].budget = parseFloat(e.target.value) || 0;
                                                              setEditingProject({...editingProject, [projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes']: list});
                                                          }}
                                                          placeholder="0.00"
                                                      />
                                                  </td>

            {/* 6. Action Delete */}
            <td className="px-4 py-2 text-center">
               {/* ... (‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ... */}
                <button 
                    type="button"
                    onClick={() => {
                        const currentList = editingProject[projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes'];
                        const newList = currentList.filter((_, i) => i !== idx);
                        setEditingProject({
                            ...editingProject, 
                            [projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes']: newList
                        });
                    }}
                    className="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors flex items-center justify-center mx-auto"
                    title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M3 6h18"/>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                        <line x1="10" x2="10" y1="11" y2="17"/>
                        <line x1="14" x2="14" y1="11" y2="17"/>
                    </svg>
                </button>
            </td>
        </tr>
    ))}
</tbody>

    </table>
    
    <button 
        type="button"
        onClick={() => {
            const key = projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes';
            // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° group: '' ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô object ‡πÉ‡∏´‡∏°‡πà
            setEditingProject({...editingProject, [key]: [...(editingProject[key] || []), { code: '', description: '', group: '', budget: 0 }]});
        }}
        className="w-full py-3 text-sm text-gray-500 hover:bg-gray-50 border-t flex items-center justify-center gap-2 font-bold transition-colors"
    >
        <Plus className="w-4 h-4"/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà
    </button>
</div>
                          </div>
                      )}
                  </div>

                  {/* Footer */}
                  <div className="p-5 border-t bg-white flex justify-end gap-3">
                      <button onClick={() => setShowProjectModal(false)} className="px-6 py-2.5 border border-gray-300 rounded-xl text-gray-600 hover:bg-gray-50 font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                      <button onClick={handleSaveProject} className="px-6 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 shadow-md font-bold flex items-center gap-2">
                          <Save className="w-4 h-4"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                      </button>
                  </div>
              </div>
          </div>
      )}


 
            </div>

{/* ‡∏õ‡∏∏‡πà‡∏° Go to Bottom (Minimal - ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° Top) */}
            {showGoBottom && (
                <button
                    onClick={scrollToBottom}
                    className="fixed bottom-20 right-6 z-[100] bg-white text-gray-600 border border-gray-200 hover:bg-gray-100 hover:text-black p-3 rounded-full shadow-lg transition-all transform hover:scale-110 flex items-center justify-center no-print"
                    title="‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                        <path d="m6 9 6 6 6-6"/>
                    </svg>
                </button>
            )}

            {/* ‡∏õ‡∏∏‡πà‡∏° Go to Top (Minimal - ‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î) */}
            {showGoTop && (
                <button
                    onClick={scrollToTop}
                    className="fixed bottom-6 right-6 z-[100] bg-blue-600 text-white hover:bg-blue-700 p-3 rounded-full shadow-lg transition-all transform hover:scale-110 flex items-center justify-center no-print"
                    title="‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                        <path d="m18 15-6-6-6 6"/>
                    </svg>
                </button>
            )}

          </main>
    
       {/* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô z-[80] ‡πÄ‡∏õ‡πá‡∏ô z-[250] ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Verification ‡πÑ‡∏î‡πâ */}
{showCreateModal && (
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[250] p-4 backdrop-blur-sm animate-in fade-in">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden max-h-[90vh] flex flex-col">
            
            {/* --- HEADER --- */}
            <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-start bg-white sticky top-0 z-10">
                 <div>
                     <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2">
                        {editingId ? <Edit className="w-6 h-6 text-blue-600"/> : <Plus className="w-6 h-6 text-blue-600"/>} 
                        {editingId ? `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á` : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà'}
                     </h3>
                     <p className="text-sm text-gray-500 mt-1">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</p>
                 </div>
                 
                 <button 
                    type="button"
                    onClick={handleCloseCreateModal} 
                    className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
                 >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M18 6 6 18"/>
                        <path d="m6 6 12 12"/>
                    </svg>
                 </button>
            </div>

            <div className="flex-1 overflow-y-auto p-8 bg-slate-50">
            <form className="space-y-6">
              {/* Type Selection */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-2">
                
                 {hasPermission(4) && (
                 <button type="button" onClick={() => setNewOrderMeta({
                     ...newOrderMeta, 
                     type: 'Local',
                     dateRequired: getFutureDate(7), // ‚≠ê Local: ‡∏≠‡∏µ‡∏Å 15 ‡∏ß‡∏±‡∏ô
                     priority: 'Urgent' // 8-30 ‡∏ß‡∏±‡∏ô = Urgent
                 })} className={`p-3 rounded-xl border-2 text-center transition-all ${newOrderMeta.type === 'Local' ? 'bg-orange-50 border-orange-500 text-orange-800 shadow-sm' : 'border-gray-200 bg-white hover:border-orange-200'}`}><HardHat className="w-5 h-5 mx-auto mb-1"/> ‡∏ã‡∏∑‡πâ‡∏≠ (Local)</button>
                  )}

                 {hasPermission(5) && (
                 <button type="button" onClick={() => setNewOrderMeta({
                     ...newOrderMeta, 
                     type: 'HO',
                     dateRequired: getFutureDate(15), // ‚≠ê HO: ‡∏≠‡∏µ‡∏Å 15 ‡∏ß‡∏±‡∏ô
                     priority: 'Urgent'
                 })} className={`p-3 rounded-xl border-2 text-center transition-all ${newOrderMeta.type === 'HO' ? 'bg-purple-50 border-purple-500 text-purple-800 shadow-sm' : 'border-gray-200 bg-white hover:border-purple-200'}`}><Building className="w-5 h-5 mx-auto mb-1"/> ‡∏ã‡∏∑‡πâ‡∏≠ (HO)</button>
                 )}

                 {hasPermission(6) && (
                <button type="button" onClick={() => setNewOrderMeta({
                    ...newOrderMeta, 
                    type: 'Withdraw',
                    dateRequired: getFutureDate(0), // ‚≠ê ‡πÄ‡∏ö‡∏¥‡∏Å: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Today)
                    priority: 'Critical' // 0-7 ‡∏ß‡∏±‡∏ô = Critical
                })} className={`p-3 rounded-xl border-2 text-center transition-all ${newOrderMeta.type === 'Withdraw' ? 'bg-pink-50 border-pink-500 text-pink-800 shadow-sm' : 'border-gray-200 bg-white hover:border-pink-200'}`}><Package className="w-5 h-5 mx-auto mb-1"/> ‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏</button>
                )}

                 {hasPermission(7) && (
                 <button type="button" onClick={() => setNewOrderMeta({
                     ...newOrderMeta, 
                     type: 'Borrow',
                     dateRequired: getFutureDate(0), // ‚≠ê ‡∏¢‡∏∑‡∏°: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Today)
                     priority: 'Critical' // 0-7 ‡∏ß‡∏±‡∏ô = Critical
                 })} className={`p-3 rounded-xl border-2 text-center transition-all ${newOrderMeta.type === 'Borrow' ? 'bg-blue-50 border-blue-500 text-blue-800 shadow-sm' : 'border-gray-200 bg-white hover:border-blue-200'}`}><Monitor className="w-5 h-5 mx-auto mb-1"/> ‡∏¢‡∏∑‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</button>
                 )}
              </div>
              
              {/* HO Purchase Type */}
              {newOrderMeta.type === 'HO' && (
                  <div className="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100 mb-2 flex gap-4 animate-in fade-in">
                      <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="purchaseType" className="accent-indigo-600 w-4 h-4" checked={newOrderMeta.purchaseType === 'Buy'} onChange={() => setNewOrderMeta({...newOrderMeta, purchaseType: 'Buy'})} /><span className="text-sm font-bold text-indigo-900">‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏î (Buy)</span></label>
                      <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="purchaseType" className="accent-indigo-600 w-4 h-4" checked={newOrderMeta.purchaseType === 'Rent'} onChange={() => setNewOrderMeta({...newOrderMeta, purchaseType: 'Rent'})} /><span className="text-sm font-bold text-indigo-900">‡πÄ‡∏ä‡πà‡∏≤ (Rent)</span></label>
                  </div>
              )}

              {newOrderMeta.type === 'Withdraw' && (
                  <div className="bg-pink-50 p-3 rounded-xl border border-pink-100 mb-2 flex gap-4 animate-in fade-in">
                      <label className="flex items-center gap-2 cursor-pointer">
                          <input type="radio" name="withdrawStockType" className="accent-pink-600 w-4 h-4" 
                              checked={newOrderMeta.withdrawStockType === 'System'} 
                              onChange={() => { setNewOrderMeta({...newOrderMeta, withdrawStockType: 'System'}); setTempItem({...tempItem, name: '', id: ''}); setOrderItems([]); }} 
                          />
                          <span className="text-sm font-bold text-pink-900">‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (System)</span>
                      </label>
                      <label className="flex items-center gap-2 cursor-pointer">
                          <input type="radio" name="withdrawStockType" className="accent-pink-600 w-4 h-4" 
                              checked={newOrderMeta.withdrawStockType === 'NonSystem'} 
                              onChange={() => { setNewOrderMeta({...newOrderMeta, withdrawStockType: 'NonSystem'}); setTempItem({...tempItem, name: '', id: ''}); setOrderItems([]); }} 
                          />
                          <span className="text-sm font-bold text-pink-900">‡∏Ç‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (NonSystem)</span>
                      </label>
                  </div>
              )}
              
              {/* Form Fields */}
              <div className="grid grid-cols-2 gap-4 bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                <div className="col-span-2">
                    <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project Name)</label>
                                  <select 
    required 
    className="w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white"
    value={newOrderMeta.job} 
    onChange={e => {
        setNewOrderMeta({...newOrderMeta, job: e.target.value});
        setTempItem(prev => ({...prev, subJob: '', matCode: ''}));
    }}
>
    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ --</option>
    
    {/* ‚≠ê ‡∏Å‡∏£‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà */}
{projects.filter(p => {
    // 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏Ç‡∏≠
    let requiredPerm = 4; // Default: ‡∏ã‡∏∑‡πâ‡∏≠ Local (4)
    if (newOrderMeta.type === 'HO') requiredPerm = 5; // ‡∏ã‡∏∑‡πâ‡∏≠ HO (5)
    else if (newOrderMeta.type === 'Withdraw') requiredPerm = 6; // ‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏ (6)
    else if (newOrderMeta.type === 'Borrow') requiredPerm = 7; // ‡∏¢‡∏∑‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (7)

    // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    return hasPermission(requiredPerm, p.name);
}).map(p => (
    <option key={p.id} value={p.name}>{p.name}</option>
))}
</select>
                
                </div>
                
                {newOrderMeta.type !== 'Borrow' && (
                    <div className="col-span-1">
                        <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Priority)</label>
                        <div className="flex gap-2">
                            {Object.entries(PRIORITIES).map(([key, conf]) => (
                                <button key={key} type="button" onClick={() => setNewOrderMeta({...newOrderMeta, priority: key})} className={`flex-1 py-2 rounded-lg text-xs font-bold border transition-all ${newOrderMeta.priority === key ? `${conf.color} border-current` : 'bg-gray-50 border-gray-200 text-gray-500 hover:bg-gray-100'}`}>
                                    {conf.label}
                                </button>
                            ))}
                        </div>
                    </div>
                )}
                
                <div className={newOrderMeta.type === 'Borrow' ? "col-span-2" : "col-span-1"}>
                    <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (Date Required)</label>
                    <input 
                        required 
                        type="date" 
                        className="w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" 
                        value={newOrderMeta.dateRequired} 
                        onChange={handleDateChange} // ‚≠ê ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Smart Priority ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                        min={new Date().toISOString().split('T')[0]} // ‚≠ê ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
                    />
                </div>
              </div>

{/* Suggestion Alert (Multi-Project List) */}
{foundSuggestions.length > 0 && (
    <div className="bg-green-50 border border-green-200 rounded-xl p-3 mb-4 animate-in zoom-in-95 shadow-sm">
        <div className="flex items-center gap-2 mb-2 pb-2 border-b border-green-200">
            <div className="bg-green-100 p-1.5 rounded-full text-green-600"><CheckCircle className="w-4 h-4"/></div>
            <p className="text-sm font-bold text-green-800">‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ({foundSuggestions.length})</p>
        </div>
        
        <div className="max-h-40 overflow-y-auto space-y-2 pr-1">
            {foundSuggestions.map((item, idx) => (
                <div key={idx} className="flex justify-between items-center bg-white p-2 rounded-lg border border-green-100 shadow-sm">
                    <div className="flex-1 min-w-0 mr-2">
                        <div className="flex items-center gap-2">
                            <span className="font-bold text-sm text-gray-800 truncate">{item.name}</span>
                            <span className={`text-[10px] px-1.5 rounded border ${item.matchType === 'Withdraw' ? 'bg-pink-50 text-pink-700 border-pink-200' : 'bg-blue-50 text-blue-700 border-blue-200'}`}>
                                {item.matchType === 'Withdraw' ? '‡∏ß‡∏±‡∏™‡∏î‡∏∏' : '‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô'}
                            </span>
                        </div>
                        <div className="text-xs text-gray-500 flex items-center gap-1 mt-0.5">
                            <Building className="w-3 h-3"/> ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: <span className="font-bold text-gray-700">{item.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á'}</span>
                        </div>
                        <div className="text-xs text-gray-500 mt-0.5">
                            ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà: <span className="font-bold text-green-600">{item.qty} {item.unit}</span> 
                            
                            {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) */}
                            {(item.sysQty !== undefined || item.nonQty !== undefined) && (
                                <span className="text-[10px] text-gray-400 ml-1">
                                    (‡πÉ‡∏ô: <b>{item.sysQty || 0}</b>, ‡∏ô‡∏≠‡∏Å: <b>{item.nonQty || 0}</b>)
                                </span>
                            )}
                            
                            {' '}({item.sourceLabel})
                        </div>
                    </div>
                    
                    <button 
                        type="button" 
                        onClick={() => selectSuggestion(item)} 
                        className="bg-green-600 text-white text-xs px-3 py-1.5 rounded-lg font-bold hover:bg-green-700 shadow-sm whitespace-nowrap transition-colors"
                    >
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ({item.matchType === 'Withdraw' ? '‡πÄ‡∏ö‡∏¥‡∏Å' : '‡∏¢‡∏∑‡∏°'})
                    </button>
                </div>
            ))}
        </div>
    </div>
)}

              {/* Item Input Section */}
              <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm relative">
                  <h4 className="font-bold text-gray-700 mb-3 flex items-center gap-2 border-b pb-2"><ShoppingCart className="w-5 h-5 text-blue-600"/> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</h4>
                  
                  {/* General Input */}
                  <div className="space-y-3">
                      <div className="grid grid-cols-12 gap-3">
                          <div className="col-span-8">
                              <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ {newOrderMeta.type === 'Borrow' && '(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô)'}</label>
                              <div className="relative">
                                {(() => {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà "‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏°)
            const isStrictSelection = ['Withdraw', 'Borrow'].includes(newOrderMeta.type);

            return (
                <input 
                    type="text" 
                    // 1. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏° ‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Å ReadOnly ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î Modal
                    readOnly={isStrictSelection}
                    onClick={() => {
                        if (isStrictSelection) setShowSelectionModal(true);
                    }}
                    
                    // 2. ‡∏õ‡∏£‡∏±‡∏ö Style: ‡∏ñ‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÅ‡∏•‡∏∞‡∏°‡∏µ cursor pointer, ‡∏ñ‡πâ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏õ‡∏Å‡∏ï‡∏¥
                    className={`w-full p-2.5 pl-3 pr-10 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none ${
                        isStrictSelection 
                        ? 'bg-gray-50 cursor-pointer font-bold text-gray-700' // ‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏° (‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå)
                        : 'bg-white' // ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥)
                    }`}
                    
                    // 3. Placeholder ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
                    placeholder={isStrictSelection ? "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." : "‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."}
                    
                    value={tempItem.name} 
                    
                    // 4. OnChange: ‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô "‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                    onChange={e => {
                        if (!isStrictSelection) {
                            setTempItem({...tempItem, name: e.target.value});
                        }
                    }} 
                />
            );
        })()}
                                <button 
                                    type="button"
                                    onClick={() => setShowSelectionModal(true)} 
                                    className="absolute right-1.5 top-1.5 p-1.5 bg-gray-100 text-gray-600 hover:bg-blue-100 hover:text-blue-600 rounded-md transition-colors"
                                    title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
                                >
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/>
                                    </svg>
                                </button>
                              </div>
                          </div>

                          <div className="col-span-2">
                              <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                              <input type="number" min="1" className="w-full p-2.5 border border-gray-300 rounded-lg text-sm text-center" value={tempItem.qty} onChange={e => setTempItem({...tempItem, qty: parseInt(e.target.value) || 0})} disabled={newOrderMeta.type === 'Borrow'} />
                          </div>
                         <div className="col-span-2">
    <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label>
    <select 
        className="w-full p-2.5 border border-gray-300 rounded-lg text-sm bg-white" 
        value={tempItem.unit} 
        onChange={e => setTempItem({...tempItem, unit: e.target.value})} 
        disabled={newOrderMeta.type === 'Borrow'}
    >
        {ITEM_UNITS.map(u => <option key={u} value={u}>{u}</option>)}
    </select>
</div>


                      </div>

            {newOrderMeta.type !== 'Borrow' && (
                        <div className="grid grid-cols-12 gap-3">
                            {/* Logic ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */}
                            {(() => {
                                const selectedProjectData = projects.find(p => p.name === newOrderMeta.job);
                                return (
                                    <>
                                        {/* ‚≠ê ‡πÉ‡∏ä‡πâ SearchableDropdown ‡πÅ‡∏ó‡∏ô Select ‡πÄ‡∏î‡∏¥‡∏° */}
                                        <div className="col-span-4">
                                            <SearchableDropdown
                                                label="SubJob"
                                                placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å..."
                                                options={selectedProjectData?.subJobs || []}
                                                value={tempItem.subJob}
                                                onChange={(val) => setTempItem({...tempItem, subJob: val})}
                                                disabled={!newOrderMeta.job || (newOrderMeta.type === 'Withdraw' && !!tempItem.matCode)}
                                            />
                                        </div>

                                        <div className="col-span-4">
                                            <SearchableDropdown
                                                label="Mat. Code"
                                                placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å..."
                                                options={selectedProjectData?.matCodes || []}
                                                value={tempItem.matCode}
                                                onChange={(val) => setTempItem({...tempItem, matCode: val})}
                                                disabled={!newOrderMeta.job || (newOrderMeta.type === 'Withdraw' && !!tempItem.subJob)}
                                            />
                                        </div>
                                    </>
                                );
                            })()}
                            
<div className="col-span-4">
    <label className="text-xs font-bold text-gray-500 mb-1 block">
        {newOrderMeta.type === 'HO' && newOrderMeta.purchaseType === 'Rent' 
            ? '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)' 
            : '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)'}
    </label>
    
    <div className="flex gap-2">
        {/* ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏≤‡∏Ñ‡∏≤ */}
        <input 
            type="number" min="0" 
            disabled={newOrderMeta.type === 'Withdraw'} 
            className="w-full p-2.5 border border-gray-300 rounded-lg text-sm" 
            value={tempItem.unitPrice} 
            onChange={e => setTempItem({...tempItem, unitPrice: parseFloat(e.target.value) || 0})} 
        />
        
        {/* Dropdown ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏ß‡∏•‡∏≤ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ HO Rent) */}
        {newOrderMeta.type === 'HO' && newOrderMeta.purchaseType === 'Rent' && (
            <select 
                className="w-24 p-2.5 border border-gray-300 rounded-lg text-sm bg-white text-gray-700 font-medium"
                value={tempItem.rentalUnit || 'Month'}
                onChange={e => setTempItem({...tempItem, rentalUnit: e.target.value})}
            >
                <option value="Day">/ ‡∏ß‡∏±‡∏ô</option>
                <option value="Month">/ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                <option value="Year">/ ‡∏õ‡∏µ</option>
            </select>
        )}
    </div>
</div>

                      {/* --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ HO Rent) --- */}
{newOrderMeta.type === 'HO' && newOrderMeta.purchaseType === 'Rent' && (
    <div className="col-span-2">
        <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πà‡∏≤</label>
        <input 
            type="number" min="1" 
            className="w-full p-2.5 border border-gray-300 rounded-lg text-sm text-center font-bold text-indigo-700 bg-indigo-50"
            value={tempItem.duration || 1} 
            onChange={e => setTempItem({...tempItem, duration: parseFloat(e.target.value) || 1})} 
        />
    </div>
)}
                        </div>
                      )}
                      

                      <div> {/* üü¢ ‡∏•‡∏ö {newOrderMeta.type !== 'Borrow' && ( ‡∏≠‡∏≠‡∏Å */}
    <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
    <input type="text" className="w-full p-2.5 border border-gray-300 rounded-lg text-sm" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..." value={tempItem.note} onChange={e => setTempItem({...tempItem, note: e.target.value})} />
</div> {/* üü¢ ‡∏•‡∏ö )} ‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å */}

                      {/* Image Upload: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Local ‡πÅ‡∏•‡∏∞ HO (Updated: Multi-Image UI) */}
                      {(newOrderMeta.type === 'Local' || newOrderMeta.type === 'HO') && (
                          <div className="animate-in fade-in mb-4">
                              <label className="text-xs font-bold text-gray-500 mb-1 flex items-center gap-1">
                                  <ImageIcon className="w-3 h-3"/> ‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ)
                              </label>
                              
                              <div className="flex flex-col gap-2">
                                  {/* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ */}
                                  <label className="cursor-pointer bg-blue-50 text-blue-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-100 border border-blue-200 flex items-center gap-2 transition-colors">
            <ImageIcon className="w-4 h-4"/> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°
            <input type="file" multiple accept="image/*" className="hidden" onChange={handleTempItemImageSelect}/>
        </label>
        {/* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á */}
        <label className="cursor-pointer bg-green-50 text-green-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-green-100 border border-green-200 flex items-center gap-2 transition-colors">
            <Camera className="w-4 h-4"/> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
            <input type="file" multiple accept="image/*" capture="environment" className="hidden" onChange={handleTempItemImageSelect}/>
        </label>

                                  {/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ (Preview Grid) */}
                                  {tempItem.images && tempItem.images.length > 0 && (
                                      <div className="grid grid-cols-4 md:grid-cols-6 gap-2 mt-2">
                                          {tempItem.images.map((img, idx) => (
                                              <div key={idx} className="relative group w-full h-20 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                                                  <img src={img.base64 || img.url} alt="preview" className="w-full h-full object-cover" />
                                                  <button 
                                                      type="button"
                                                      onClick={() => handleRemoveTempItemImage(idx)} 
                                                      className="absolute top-0 right-0 bg-red-500 text-white p-0.5 rounded-bl opacity-0 group-hover:opacity-100 transition-all hover:scale-110" 
                                                      title="‡∏•‡∏ö‡∏£‡∏π‡∏õ"
                                                  >
                                                      <X size={12} strokeWidth={3}/>
                                                  </button>
                                              </div>
                                          ))}
                                      </div>
                                  )}
                              </div>
                          </div>
                      )}
                  </div>

                  <button type="button" onClick={handleAddItem} className="w-full bg-gray-900 text-white p-3 rounded-xl text-sm font-bold hover:bg-black mt-4 shadow-md flex items-center justify-center gap-2"><Plus className="w-4 h-4"/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>

                  {/* Items Table */}
                  <div className="bg-gray-50 border border-gray-200 rounded-xl overflow-hidden mt-6">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-100 text-gray-600 text-left text-xs uppercase tracking-wider">
                            <tr>
                                <th className="p-3 font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                {newOrderMeta.type === 'Borrow' ? (
                                    <>
                                        <th className="p-3 font-bold">Asset ID</th>
                                        <th className="p-3 font-bold">Serial No.</th>
                                        <th className="p-3 font-bold text-center">‡∏£‡∏π‡∏õ</th>
                                        <th className="p-3 font-bold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                    </>
                                ) : (
                                    <><th className="p-3 font-bold">SubJob/Mat</th><th className="p-3 font-bold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></>
                                )}
                                {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ */}
                                <th className="p-3 text-right font-bold">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                                <th className="p-3 text-center font-bold">Qty</th>
                                <th className="p-3 text-right font-bold">Unit</th>
                                <th className="p-3"></th>
                            </tr>
                        </thead>
 <tbody className="divide-y divide-gray-200 bg-white">
                            {orderItems.map((itm, idx) => (
                            <tr key={idx}>
                                <td className="p-3 text-gray-800 font-bold">{itm.name}</td>
                                
                                {newOrderMeta.type === 'Borrow' ? (
                                   <>
    <td className="p-3 text-xs text-gray-500 font-mono">{itm.assetId || '-'}</td>
    <td className="p-3 text-xs text-gray-500 font-mono">{itm.serial || '-'}</td>
    <td className="p-3 text-center">
        {itm.images && itm.images.length > 0 ? (
            <button type="button" onClick={() => setViewingAttachments({ attachments: itm.images })} className="text-blue-600 hover:text-blue-800"><ImageIcon className="w-4 h-4 mx-auto"/></button>
        ) : '-'}
    </td>
    <td className="p-3 text-xs text-gray-500 break-words whitespace-pre-wrap max-w-[200px]">{itm.note || '-'}</td> {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° Cell ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ */}
</>
                                ) : (
                                    <>
                                        <td className="p-3 text-xs text-gray-500">
                                            {itm.subJob && <div>S: {itm.subJob}</div>}
                                            {itm.matCode && <div>M: {itm.matCode}</div>}
                                            {!itm.subJob && !itm.matCode && '-'}
                                        </td>
                                        <td className="p-3 text-xs text-gray-500 break-words whitespace-pre-wrap max-w-[200px]">{itm.note || '-'}</td>
                                   </>
                                )}

                                {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ */}
                                <td className="p-3 text-right text-gray-700">
                                    {itm.unitPrice > 0 ? (
                                        <div className="flex flex-col items-end">
                                            {/* ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏≤‡∏Ñ‡∏≤ */}
                                            <span className="font-mono font-bold">{itm.unitPrice.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                                            
                                            <span className="text-[10px] text-gray-500">
    {newOrderMeta.type === 'HO' && newOrderMeta.purchaseType === 'Rent'
        ? `/${itm.rentalUnit === 'Day' ? '‡∏ß‡∏±‡∏ô' : itm.rentalUnit === 'Year' ? '‡∏õ‡∏µ' : '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'}/${itm.unit}`
        : `/${itm.unit}`
    }
</span>
                                        </div>
                                    ) : '-'}
                                </td>

                                <td className="p-3 text-center font-bold">{itm.qty}</td>
                                <td className="p-3 text-right text-xs text-gray-500">{itm.unit}</td>
                                <td className="p-3 text-center flex items-center justify-center gap-1">
                                    {/* ... (‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ... */}
                                    <button type="button" onClick={() => handleEditItem(idx)} className="text-blue-600 hover:bg-blue-50 p-1.5 rounded-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                                    <button type="button" onClick={() => handleRemoveItem(idx)} className="text-red-500 hover:text-red-700 hover:bg-red-50 p-1.5 rounded-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>
                                </td>
                            </tr>
                        ))}</tbody>
                    </table>
                    {orderItems.length === 0 && <div className="p-8 text-center text-gray-400 text-xs bg-white">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>}
                  </div>
              </div>
              
              {/* Attachment for HO */}
              {newOrderMeta.type === 'HO' && (
                  <div className="bg-amber-50 p-4 rounded-xl border border-amber-200 mt-2 space-y-3">
                    <div>
                        <label className="block text-sm font-bold text-amber-800 mb-1 flex items-center gap-2"><AttachmentIcon className="w-4 h-4" /> 1. ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approval Email)</label>
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => setUploadFiles({...uploadFiles, email: e.target.files[0]})} className="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-amber-100 file:text-amber-800 hover:file:bg-amber-200 cursor-pointer"/>
                         {editingId && newOrderMeta.attachment && <p className="text-xs text-green-600 mt-1 pl-2">‚úî ‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°: {newOrderMeta.attachment.name}</p>}
                    </div>
                    <div>
                        <label className="block text-sm font-bold text-amber-800 mb-1 flex items-center gap-2"><FileText className="w-4 h-4" /> 2. ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (Quotation)</label>
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => setUploadFiles({...uploadFiles, quotation: e.target.files[0]})} className="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-amber-100 file:text-amber-800 hover:file:bg-amber-200 cursor-pointer"/>
                        {editingId && newOrderMeta.quotation && <p className="text-xs text-green-600 mt-1 pl-2">‚úî ‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°: {newOrderMeta.quotation.name}</p>}
                    </div>
                  </div>
              )}

             {/* Bottom Actions */}
              <div className="flex gap-3 pt-4 border-t border-gray-100">
                  <button type="button" onClick={(e) => handleCreateOrder(e, true)} className="flex-1 bg-white border border-gray-300 text-gray-700 font-bold py-3.5 rounded-xl shadow-sm hover:bg-gray-50 flex items-center justify-center gap-2 transition-colors">
                      <Save className="w-5 h-5"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πà‡∏≤‡∏á
                  </button>
                  
                  {/* ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó (‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ vs ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) */}
                  <button type="button" onClick={(e) => handleCreateOrder(e, false)} className="flex-1 bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-blue-700 flex items-center justify-center gap-2 transition-transform active:scale-95">
                      <Send className="w-5 h-5"/> {editingId ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠'}
                  </button>
              </div>
            </form>
          </div>
          </div>
        </div>
      )}


      {showSelectionModal && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[300] p-4 animate-in fade-in"> {/* ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */}
      <div className="bg-white rounded-2xl shadow-xl w-full max-w-2xl h-[80vh] flex flex-col overflow-hidden">
             
             {/* --- HEADER: ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î X ‡πÅ‡∏ö‡∏ö Clean Style (SVG) --- */}
             <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-white">
                 <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">
                    <List className="w-5 h-5 text-blue-600"/> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Select Item)
                 </h3>
                 {/* ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏Å‡∏ö‡∏≤‡∏ó (X) ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */}
                 <button 
                    onClick={() => setShowSelectionModal(false)} 
                    className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
                 >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M18 6 6 18"/>
                        <path d="m6 6 12 12"/>
                    </svg>
                 </button>
             </div>

             <div className="p-4 border-b bg-white">
                 <div className="relative">
                     <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                     <input type="text" className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™..." value={selectionSearch} onChange={e => setSelectionSearch(e.target.value)} autoFocus />
                 </div>
                 {newOrderMeta.type === 'Borrow' && (
                     <div className="mt-2 text-xs text-orange-600 bg-orange-50 p-2 rounded flex items-center gap-1 font-bold">
                         <Info className="w-3 h-3"/> ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á (Available)
                     </div>
                 )}
                 {newOrderMeta.type === 'HO' && (
                     <div className="mt-2 text-xs text-purple-600 bg-purple-50 p-2 rounded flex items-center gap-1 font-bold">
                         <Info className="w-3 h-3"/> ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô
                     </div>
                 )}
             </div>

             <div className="flex-1 overflow-y-auto p-4 bg-gray-50">
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                     {getSelectionItems().map((item, idx) => (
                         <div key={idx} onClick={() => handleSelectFromModal(item)} className="bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:border-blue-400 hover:shadow-md cursor-pointer transition-all flex gap-3 items-center group">
                             {/* ‚≠ê ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Updated) */}
 <div 
    className="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0 border overflow-hidden relative cursor-pointer hover:ring-2 hover:ring-blue-400 transition-all"
    onClick={(e) => {
        // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
        const images = getItemLatestImages(item);
        if (images.length > 0) {
            e.stopPropagation();
            setViewingAttachments({ attachments: images });
        }
    }}
    title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
>
    {(() => {
        // Preview ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏£‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        const img = getItemLatestImage(item);
        if (img) {
            return (
                <>
                    <img 
                        src={getDriveImageUrl(img.url || img.base64)} 
                        alt="preview" 
                        className="w-full h-full object-cover hover:scale-110 transition-transform duration-300" 
                        onError={(e) => e.target.style.display = 'none'}
                    />
                    {/* ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 */}
                    {getItemLatestImages(item).length > 1 && (
                        <div className="absolute top-0 left-0 bg-black/60 text-white px-1 text-[9px] rounded-br">
                            +{getItemLatestImages(item).length - 1}
                        </div>
                    )}
                    <div className="absolute bottom-0 right-0 bg-black/50 text-white p-0.5 rounded-tl-md">
                        <ImageIcon className="w-3 h-3"/>
                    </div>
                </>
            );
        } else {
            return <span className="text-[10px] text-gray-400 font-bold">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û</span>;
        }
    })()}
</div>

                 <div className="flex-1 min-w-0">
    <h4 className="font-bold text-gray-900 text-sm truncate group-hover:text-blue-600 transition-colors">{item.name}</h4>
    {/* ‚≠ê ‡πÉ‡∏ä‡πâ getDisplayId ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */}
    <p className="text-xs text-gray-500 truncate font-mono">{getDisplayId(item.id) || item.serial || '-'}</p>          
    
    {/* ‚≠ê ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏¢‡∏Å‡∏Å‡∏£‡∏ì‡∏µ Withdraw ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå breakdown */}
{(newOrderMeta.type === 'Withdraw') ? (
    <div className="mt-1">
        {/* ‡πÇ‡∏ä‡∏ß‡πå‡∏¢‡∏≠‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ö‡∏¥‡∏Å ‡∏ã‡∏∂‡πà‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° '‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö/‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö' ‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏à‡∏≠‡∏á‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß */}
        <p className="text-xs text-green-600 font-bold">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ö‡∏¥‡∏Å: {item.qty} {item.unit}</p>
        
        {/* (Optional) ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ User ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏µ‡πà‡∏ä‡∏¥‡πâ‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏õ‡πÄ‡∏•‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö */}
        {item.reserved > 0 && (
            <p className="text-[10px] text-orange-500">‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà: {item.reserved} {item.unit}</p>
        )}
    </div>
    ) : (newOrderMeta.type !== 'Borrow') && (
        <p className="text-xs text-green-600 mt-1 font-bold">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: {item.qty} {item.unit}</p>
    )}

    {(newOrderMeta.type === 'Borrow') && (
        <p className="text-xs text-indigo-600 mt-1 font-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {item.status}</p>
    )}
</div>
                         </div>
                     ))}
                 </div>
                 {getSelectionItems().length === 0 && (
                     <div className="text-center text-gray-400 mt-10">
                         <Search className="w-10 h-10 mx-auto mb-2 opacity-20"/>
                         <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
                     </div>
                 )}
             </div>
          </div>
        </div>
      )}
          
{showDetailModal && selectedRequest && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[200] p-4 backdrop-blur-sm animate-in fade-in no-print">
         <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col overflow-hidden animate-in zoom-in-95">
                 <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-start bg-white sticky top-0 z-10">
                     <div>
                         <div className="flex items-center gap-3">
                             <h3 className="font-bold text-xl text-gray-800">{selectedRequest.id}</h3>
                             <StatusBadge 
    status={selectedRequest.status} 
    type={selectedRequest.type} 
    onClick={() => handleShowActors(selectedRequest)}
/>
                         </div>
                         <p className="text-sm text-gray-500 mt-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {selectedRequest.created} | ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: {selectedRequest.requester}</p>
                     </div>
                     
                    <div className="flex items-center gap-2">

                    {user.isSuperAdmin && (
    <button 
        onClick={() => {
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Default Target ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            let defaultTarget = 'Approved';
            if (selectedRequest.type === 'Withdraw' || selectedRequest.type === 'Borrow') defaultTarget = 'Approved'; // = Ready to Disburse ‡∏à‡∏£‡∏¥‡∏á‡πÜ‡∏Ñ‡∏∑‡∏≠ Approved ‡πÉ‡∏ô Logic ‡πÄ‡∏î‡∏¥‡∏°
            else if (['Local', 'HO'].includes(selectedRequest.type)) defaultTarget = 'Approved';
            
            setRollbackTarget(defaultTarget);
            setRollbackReason('');
            setShowSuperRollbackModal(true);
        }}
        className="flex items-center gap-1 px-3 py-1.5 bg-red-600 text-white text-xs font-bold rounded-lg hover:bg-red-700 shadow-md transition-colors"
        title="Admin Rollback (‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á/‡∏¢‡πâ‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)"
    >
        <RotateCcw className="w-4 h-4"/> Admin Rollback
    </button>
)}

{/* --- [START] ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Cost --- */}
                        {/* 1. ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå 29 ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) */}
                        {!isCostEditMode && hasPermission(29) && (
                            <button 
                                onClick={handleStartCostEdit}
                                className="flex items-center gap-1 px-3 py-1.5 bg-yellow-50 text-yellow-700 border border-yellow-200 text-xs font-bold rounded-lg hover:bg-yellow-100 transition-colors shadow-sm"
                            >
                                <Edit className="w-4 h-4"/> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Cost
                            </button>
                        )}

                        {/* 2. ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) */}
                        {isCostEditMode && (
                            <>
                                <button onClick={handleSaveCostEdit} className="flex items-center gap-1 px-3 py-1.5 bg-green-600 text-white text-xs font-bold rounded-lg hover:bg-green-700 shadow-md animate-in fade-in">
                                    <Save className="w-4 h-4"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                </button>
                                <button onClick={handleCancelCostEdit} className="px-3 py-1.5 bg-gray-100 text-gray-600 text-xs font-bold rounded-lg hover:bg-gray-200 animate-in fade-in">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                            </>
                        )}



{['Approved', 'Ordered', 'PR Issued', 'PO Issued', 'Shipping', 'Contract Signed', 'Partially Received', 'Ready to Disburse', 'Completed', 'Returned'].includes(selectedRequest.status) && 
 (selectedRequest.type === 'Local' ||
  selectedRequest.type === 'Withdraw' || 
  selectedRequest.type === 'Borrow' || 
  // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç HO: ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Full Flow ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏Ñ‡∏™‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Local)
  (selectedRequest.type === 'HO' && (selectedRequest.isFullApprovalFlow || selectedRequest.isPreviouslyApproved))
 ) && (
    <button 
        onClick={() => handleOpenPrintPreview(selectedRequest)}
        className="flex items-center gap-1 px-3 py-1.5 bg-blue-50 text-blue-600 border border-blue-200 text-xs font-bold rounded-lg hover:bg-blue-100 transition-colors"
        title="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"
    >
        <Printer className="w-4 h-4"/> 
        ‡∏û‡∏¥‡∏°‡∏û‡πå
    </button>
)}

                       <button 
    type="button" 
    onClick={() => {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
        setIsCostEditMode(false);
        setTempCostRequest(null);
        setShowDetailModal(false);
    }} 
    className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors" 
    title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á"
>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                     </div>
                 </div>
                 {/* ... Body Content ‡πÄ‡∏î‡∏¥‡∏° ... */}
                 <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                    {/* (‡πÉ‡∏ä‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ) */}
                    {/* ... */}
                    {/* ... (Copy ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô Content ‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏™‡πà) ... */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 space-y-6">
                            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                                <h4 className="font-bold text-gray-700 mb-4 flex items-center gap-2 border-b pb-2"><Info className="w-4 h-4"/> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h4>
                                <div className="grid grid-cols-2 gap-y-4 text-sm">
                                    <div><span className="text-gray-500 block mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span><span className="font-medium bg-gray-100 px-2 py-1 rounded">{selectedRequest.type} {selectedRequest.purchaseType ? `(${selectedRequest.purchaseType})` : ''}</span></div>
                                    <div><span className="text-gray-500 block mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</span><span className={`font-bold ${selectedRequest.priority === 'Critical' ? 'text-red-600' : selectedRequest.priority === 'Urgent' ? 'text-orange-600' : 'text-blue-600'}`}>{PRIORITIES[selectedRequest.priority]?.label}</span></div>
                                    <div className="col-span-2"><span className="text-gray-500 block mb-1">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Job)</span><span className="font-medium text-gray-900">{selectedRequest.job}</span></div>
                                    <div><span className="text-gray-500 block mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</span><span className="font-medium">{selectedRequest.dateRequired}</span></div>
                                    <div><span className="text-gray-500 block mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span><span className="font-mono bg-yellow-50 px-2 py-1 rounded border border-yellow-100 text-yellow-800">{selectedRequest.docNumber || '-'}</span></div>
                                </div>
                            </div>
                            {(() => {
                                const existingDocs = [
                                    { label: '‡πÄ‡∏°‡∏•‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', file: selectedRequest.attachment, icon: Mail },
                                    { label: '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤', file: selectedRequest.quotation, icon: FileText },
                                    { label: '‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠ (PR)', file: selectedRequest.prFile, icon: FileText, sub: selectedRequest.prNumber },
                                    { label: '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (PO)', file: selectedRequest.poFile, icon: ShoppingCart, sub: selectedRequest.poNumber },
                                    { label: '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ä‡πà‡∏≤', file: selectedRequest.contractFile, icon: FileSignature }
                                ].filter(doc => doc.file);
                                if (existingDocs.length === 0) return null;
                                return (
                                    <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                                        <h4 className="font-bold text-gray-700 mb-4 flex items-center gap-2 border-b pb-2"><AttachmentIcon className="w-4 h-4"/> ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (Documents)</h4>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                            {existingDocs.map((doc, idx) => (
                                                <div key={idx} className="p-3 rounded-lg border bg-white border-gray-200 flex items-center gap-3 hover:border-blue-300 transition-colors cursor-pointer group" onClick={() => handleViewFile(doc.file, doc.label)}>
                                                    <div className="w-10 h-10 rounded-lg flex items-center justify-center shrink-0 bg-blue-50 text-blue-600 group-hover:bg-blue-100"><doc.icon className="w-5 h-5"/></div>
                                                    <div className="flex-1 min-w-0">
                                                        <p className="text-xs font-bold text-gray-700 truncate">{doc.label}</p>
                                                        {doc.sub && <p className="text-[10px] text-gray-500 truncate">{doc.sub}</p>}
                                                        <span className="text-[10px] text-blue-600 flex items-center gap-1 mt-0.5 group-hover:underline"><Eye className="w-3 h-3"/> ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })()}

{/* ‚≠ê INSERT: ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Budget Tracking) - Grouping Mode with Expand Button ‚≠ê */}
{(() => {
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    if (!['Local', 'HO'].includes(selectedRequest.type)) return null;

    // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô (Admin(2), 8, 9, 26, 29) ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ
    const canViewBudget = hasPermission(2, selectedRequest.job) || 
                          hasPermission(8, selectedRequest.job) || 
                          hasPermission(9, selectedRequest.job) || 
                          hasPermission(26, selectedRequest.job) || 
                          hasPermission(29, selectedRequest.job);

    if (!canViewBudget) return null; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
    
    const items = selectedRequest.items || [];
    const targetProjectName = selectedRequest.job;
    const projectData = projects.find(p => p.name === targetProjectName);
    
    if (!projectData) return null;

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° Code ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Grouping Logic)
    const groups = {}; 

    const processCodes = (codeList, type) => {
        const uniqueCodes = [...new Set(codeList.filter(c => c))];
        uniqueCodes.forEach(code => {
            // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Group ‡∏à‡∏≤‡∏Å Project Data
            const defs = type === 'SubJob' ? projectData.subJobs : projectData.matCodes;
            const target = defs?.find(d => d.code === code);
            const groupName = target?.group || 'Others (‡∏≠‡∏∑‡πà‡∏ô‡πÜ)'; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô Others
            
            const groupKey = `${type}|${groupName}`;
            if (!groups[groupKey]) {
                groups[groupKey] = {
                    type,
                    name: groupName,
                    codes: []
                };
            }
            groups[groupKey].codes.push(code);
        });
    };

    processCodes(items.map(i => i.subJob), 'SubJob');
    processCodes(items.map(i => i.matCode), 'matCode');

    const groupKeys = Object.keys(groups).sort();
    if (groupKeys.length === 0) return null;

    // 3. Helper Function: ‡∏ß‡∏≤‡∏î Progress Bar (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á Group ‡πÅ‡∏•‡∏∞ Code)
    const renderProgressBar = (stats, label, badgeColor, isGroup, groupKey) => {
        if (!stats || stats.budget === 0) return null;

        const totalUsed = stats.used + stats.pending + stats.current;
        const isOver = totalUsed > stats.budget;
        const remaining = stats.budget - totalUsed;

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
        const usedPercent = Math.min((stats.used / stats.budget) * 100, 100);
        const pendingPercent = Math.min((stats.pending / stats.budget) * 100, 100 - usedPercent);
        const currentPercent = Math.min((stats.current / stats.budget) * 100, 100 - usedPercent - pendingPercent);

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
        const isExpanded = expandedBudgetGroups[groupKey];

        return (
            <div className={`p-3 rounded-xl border transition-all ${isGroup ? 'bg-slate-50 border-slate-200' : 'bg-white border-slate-100 ml-4 mt-2 border-l-4 border-l-slate-300'}`}>
                
                {/* Header Row: Label & Stats */}
                <div className="flex justify-between items-center mb-2">
                    <div className="flex items-center gap-2">
                        {/* ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏Ç‡∏¢‡∏≤‡∏¢ (SVG) - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Group */}
                        {isGroup && (
                            <button 
                                onClick={() => setExpandedBudgetGroups(prev => ({...prev, [groupKey]: !prev[groupKey]}))}
                                className="p-1 hover:bg-gray-200 rounded-full transition-colors text-gray-500 flex items-center justify-center bg-white border border-gray-300 shadow-sm"
                                title={isExpanded ? "‡∏¢‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö" : "‡∏Ç‡∏¢‡∏≤‡∏¢‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"}
                            >
                                {/* SVG Chevron Icon (‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î) */}
                                <svg 
                                    xmlns="http://www.w3.org/2000/svg" 
                                    width="14" height="14" 
                                    viewBox="0 0 24 24" 
                                    fill="none" 
                                    stroke="currentColor" 
                                    strokeWidth="2" 
                                    strokeLinecap="round" 
                                    strokeLinejoin="round"
                                    className={`transition-transform duration-200 ${isExpanded ? 'rotate-90' : ''}`}
                                >
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </button>
                        )}
                        
                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${badgeColor} border border-opacity-20`}>
    {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô matCode ‡πÄ‡∏õ‡πá‡∏ô Mat. Code */}
    {isGroup ? (label.split('|')[0] === 'matCode' ? 'Mat. Code' : label.split('|')[0]) : 'Code'}
</span>
                        
                        <span className="font-bold text-gray-800 text-sm">
                            {isGroup ? label.split('|')[1] : label}
                        </span>
                        
                        <span className="text-xs text-gray-500 hidden sm:inline-block">
                            (‡∏á‡∏ö: {stats.budget.toLocaleString()})
                        </span>
                    </div>
                    
                    <div className={`text-sm font-bold ${isOver ? 'text-red-600' : 'text-gray-700'}`}>
                        ‡πÉ‡∏ä‡πâ‡∏£‡∏ß‡∏° {totalUsed.toLocaleString()} {isOver && <span className="text-[10px] bg-red-100 px-1.5 py-0.5 rounded ml-1 text-red-600 border border-red-200">‡πÄ‡∏Å‡∏¥‡∏ô‡∏á‡∏ö!</span>}
                    </div>
                </div>
                
                {/* Progress Bar Visual */}
                <div className="h-3 w-full bg-gray-200 rounded-full overflow-hidden flex relative shadow-inner">
                    <div className="h-full bg-green-500" style={{ width: `${usedPercent}%` }} title={`‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß: ${stats.used.toLocaleString()}`}></div>
                    <div className="h-full bg-yellow-400" style={{ width: `${pendingPercent}%` }} title={`‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${stats.pending.toLocaleString()}`}></div>
                    <div className="h-full bg-orange-500" style={{ width: `${currentPercent}%` }} title={`‡πÉ‡∏ö‡∏ô‡∏µ‡πâ: ${stats.current.toLocaleString()}`}></div>
                    {isOver && <div className="absolute right-0 top-0 h-full w-1 bg-red-600 animate-pulse"></div>}
                </div>
                
                {/* Legend Text */}
                <div className="flex flex-wrap gap-x-3 gap-y-1 text-[10px] text-gray-500 mt-2">
                    <span className="flex items-center gap-1"><div className="w-2 h-2 bg-green-500 rounded-full"></div> ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ({stats.used.toLocaleString()})</span>
                    <span className="flex items-center gap-1"><div className="w-2 h-2 bg-yellow-400 rounded-full"></div> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ({stats.pending.toLocaleString()})</span>
                    <span className="flex items-center gap-1"><div className="w-2 h-2 bg-orange-500 rounded-full"></div> ‡πÉ‡∏ö‡∏ô‡∏µ‡πâ ({stats.current.toLocaleString()})</span>
                    <span className="ml-auto font-bold">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span className={remaining < 0 ? 'text-red-500' : 'text-green-600'}>{remaining.toLocaleString()}</span></span>
                </div>
            </div>
        );
    };

    return (
        <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm animate-in fade-in mb-6">
            <h4 className="font-bold text-gray-700 mb-4 flex items-center gap-2 border-b pb-2">
                <div className="bg-orange-100 p-1.5 rounded-lg text-orange-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v20"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                </div> 
                ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Budget Tracking)
            </h4>
            
            <div className="space-y-3">
               
{groupKeys.map((key) => {
    const group = groups[key];
    const badgeColor = group.type === 'SubJob' ? 'bg-indigo-100 text-indigo-700 border-indigo-200' : 'bg-purple-100 text-purple-700 border-purple-200';
    
    // üü¢ 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏™‡πà‡∏á isGroup = true)
    const groupStats = getBudgetStats(selectedRequest, group.name, group.type, true);

    return (
        <div key={key} className="animate-in fade-in">
            {/* ‡πÅ‡∏™‡∏î‡∏á Progress Bar ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° */}
            {renderProgressBar(
                groupStats, 
                `${group.type}|${group.name}`, 
                badgeColor, 
                true, // ‡πÄ‡∏õ‡πá‡∏ô Group
                key
            )}

            {/* ‡∏™‡πà‡∏ß‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏Ç‡∏¢‡∏≤‡∏¢) */}
            {expandedBudgetGroups[key] && (
                <div className="space-y-1 animate-in slide-in-from-top-2 duration-200 origin-top">
                    {group.codes.map(code => {
                        // üîµ 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢ Code (‡∏™‡πà‡∏á isGroup = false ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ Default)
                        const codeStats = getBudgetStats(selectedRequest, code, group.type, false);
                        
                        return (
                            <div key={code}>
                                {renderProgressBar(
                                    codeStats, 
                                    code, 
                                    'bg-gray-100 text-gray-600 border-gray-300', 
                                    false, // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Group
                                    null
                                )}
                            </div>
                        );
                    })}
                </div>
            )}
        </div>
    );
})}
            </div>
        </div>
    );
})()}

                            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
    <h4 className="font-bold text-gray-700 mb-4 flex items-center gap-2 border-b pb-2">
        <ShoppingCart className="w-4 h-4"/> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ({selectedRequest.items.length})
    </h4>
    
    <div className="overflow-x-auto border border-gray-200 rounded-lg">
        <table className="w-full text-sm">
            {/* ‚≠ê 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Header: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå Column ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á */}
            <thead className="bg-gray-100 text-gray-700 border-b">
                <tr>
                    <th className="p-3 text-left font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    
                    {/* ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏ã‡∏∑‡πâ‡∏≠ (Local/HO) */}
                    {['Local', 'HO'].includes(selectedRequest.type) && (
                        <th className="p-3 text-right font-bold">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    )}
                    
                    <th className="p-3 text-center font-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    
                    {/* ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏ã‡∏∑‡πâ‡∏≠ */}
                    {['Local', 'HO'].includes(selectedRequest.type) && (
                        <th className="p-3 text-right font-bold">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</th>
                    )}
                    
                    <th className="p-3 text-left font-bold w-32">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr>
            </thead>

    <tbody className="divide-y divide-gray-100">
                {/* ‚≠ê ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å tempCostRequest ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Cost */}
                {(isCostEditMode ? tempCostRequest.items : selectedRequest.items).map((item, idx) => {
                    const isBuy = ['Local', 'HO'].includes(selectedRequest.type);
                    const isBorrow = selectedRequest.type === 'Borrow';
                    const isRent = selectedRequest.type === 'HO' && selectedRequest.purchaseType === 'Rent';
                    
                    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Project ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å SubJob/MatCode
                    const currentJob = isCostEditMode ? tempCostRequest.job : selectedRequest.job;
                    const projectData = projects.find(p => p.name === currentJob);

                   
const sourceAssets = (isCostEditMode && tempCostRequest?.tempAssets) ? tempCostRequest.tempAssets : assets;
    
    // üü¢ ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ:
const relatedAssets = sourceAssets.filter(a => 
        a.currentRequestId === selectedRequest.id && // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠
        (
            // ‚≠ê 2. ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å _tempItemId ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ù‡∏±‡∏á‡πÑ‡∏ß‡πâ (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ 100% ‡πÅ‡∏°‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
            (isCostEditMode && a._tempItemId !== undefined)
                ? a._tempItemId === idx 
                : ( 
                    // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥: ‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏° (‡∏ä‡∏∑‡πà‡∏≠ + ‡∏£‡∏≤‡∏Ñ‡∏≤)
                    a.name === item.name && 
                    (a.price === item.unitPrice || a.rentalPrice === item.unitPrice)
                  )
        )
    );

    const receivedLogs = item.receivedLog || [];
                    
                    const hasAssets = relatedAssets.length > 0;
                    const hasLogs = receivedLogs.length > 0;
                    const hasDetails = hasAssets || hasLogs;
                    const isExpanded = expandedItems.has(idx);
                    
                    let lineTotal = 0;
                    let lineReceivedCount = 0;
                    if (isBuy) {
                        if (hasAssets) {
                             lineTotal += relatedAssets.reduce((sum, asset) => {
                                 const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                                 const duration = isRent ? (asset.duration || item.duration || 1) : 1;
                                 return sum + (price * duration);
                              }, 0);
                             lineReceivedCount = relatedAssets.length;
                        } else if (hasLogs) {
                             lineTotal += receivedLogs.reduce((sum, log) => {
                                 const duration = isRent ? (log.duration || 1) : 1;
                                 return sum + (log.qty * log.price * duration);
                              }, 0);
                             lineReceivedCount = item.receivedTotal || 0;
                        }
                        if (!['Completed', 'Partially Received'].includes(selectedRequest.status)) {
    const remainingQty = Math.max(0, item.qty - lineReceivedCount);
    const estimateDuration = isRent ? (item.duration || 1) : 1;
    lineTotal += (remainingQty * item.unitPrice * estimateDuration);
}
                    }

                    return (
                        <React.Fragment key={idx}>
                        <tr className={isExpanded ? "bg-blue-50/30 transition-colors" : "transition-colors hover:bg-slate-50"}>
                            
                            {/* 1. Column ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */}
                            <td className="p-3 align-top">
                                <div className="flex items-start gap-2">
                                    {hasDetails && (
                                       <button 
                                            onClick={() => toggleExpandItem(idx)}
                                            className={`mt-0.5 p-0.5 rounded border transition-all ${isExpanded ? 'bg-blue-100 text-blue-700 border-blue-200' : 'bg-white text-gray-400 border-gray-200 hover:text-blue-600 hover:border-blue-300'}`}
                                        >
                                            {isExpanded ? 
                                              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"/></svg> 
                                              : <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                                            }
                                        </button>
                                    )}
                                    
                                    <div className="flex-1">
                                        <div className="font-bold text-gray-900">{item.name}</div>

                                        {selectedRequest.type === 'Withdraw' && (() => {
        // 1. ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Inventory ID)
        const stockItem = inventory.find(i => i.name === item.name && i.project === selectedRequest.job);
        const invId = stockItem ? getDisplayId(stockItem.id) : null;
        
        // 2. ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Mat. Code ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏°‡∏≤‡∏ï‡∏≠‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å
        const displayCode = invId || item.matCode;

        if (displayCode) {
            return (
                <div className="text-[10px] font-mono font-bold text-slate-600 mt-1 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-300 w-fit flex items-center gap-1">
                    <span className="opacity-70">‡∏£‡∏´‡∏±‡∏™:</span> {displayCode}
                </div>
            );
        }
        return null;
    })()}
                                        
                                        {/* ‡∏Å‡∏£‡∏ì‡∏µ Borrow */}
                                        {isBorrow && (item.assetId || item.serial) && (
                                            <div className="text-xs font-mono text-indigo-600 mt-1 flex flex-wrap gap-2">
                                                {item.assetId && <span className="bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100">ID: {item.assetId}</span>}
                                                {item.serial && <span className="bg-slate-50 text-slate-600 px-1.5 py-0.5 rounded border border-slate-200">S/N: {item.serial}</span>}
                                            </div>
                                        )}

                                        {/* ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ Buy: ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç SubJob / Mat. Code */}
                                        {isBuy && (
                                            <div className="text-xs text-gray-500 mt-1">
                                                <div className="flex flex-col gap-2">
                                                    
                                                    {/* --- SUBJOB EDITOR --- */}
                                                    {isCostEditMode ? (
                                                        <div className="flex items-center gap-1">
                                                            <span className="font-bold w-8 text-gray-400">Sub:</span>
                                                            <select 
                                                                className="border border-indigo-300 rounded px-1 py-1 text-xs bg-indigo-50 text-indigo-700 w-full max-w-[250px] outline-none focus:ring-1 focus:ring-indigo-500"
                                                                value={item.subJob}
                                                                onChange={(e) => {
                                                                    const newData = {...tempCostRequest};
                                                                    newData.items[idx].subJob = e.target.value;
                                                                    setTempCostRequest(newData);
                                                                }}
                                                            >
                                                                <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
                                                                {projectData?.subJobs?.map(s => <option key={s.code} value={s.code}>{s.code}: {s.description}</option>)}
                                                            </select>
                                                        </div>
                                                    ) : (
                                                        (item.subJob || item.matCode) && (
                                                            <div className="flex gap-2">
                                                                {item.subJob && <span className="bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded border border-indigo-100">Sub: {item.subJob}</span>}
                                                            </div>
                                                        )
                                                    )}

                                                    {/* --- MAT. CODE EDITOR --- */}
                                                    {isCostEditMode ? (
                                                        <div className="flex items-center gap-1">
                                                            <span className="font-bold w-8 text-gray-400">Mat.:</span>
                                                            <select 
                                                                className="border border-purple-300 rounded px-1 py-1 text-xs bg-purple-50 text-purple-700 w-full max-w-[250px] outline-none focus:ring-1 focus:ring-purple-500"
                                                                value={item.matCode}
                                                                onChange={(e) => {
                                                                    const newData = {...tempCostRequest};
                                                                    newData.items[idx].matCode = e.target.value;
                                                                    setTempCostRequest(newData);
                                                                }}
                                                            >
                                                                <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
                                                                {projectData?.matCodes?.map(m => <option key={m.code} value={m.code}>{m.code}: {m.description}</option>)}
                                                            </select>
                                                        </div>
                                                    ) : (
                                                        (item.matCode) && (
                                                            <div className="flex gap-2">
                                                                <span className="bg-purple-50 text-purple-700 px-1.5 py-0.5 rounded border border-purple-100">Mat.: {item.matCode}</span>
                                                            </div>
                                                        )
                                                    )}

                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </td>

                            {/* 2. Column ‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏ã‡∏∑‡πâ‡∏≠) - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡∏•‡∏∞ (Mixed Price) */}
                            {isBuy && (
                                <td className="p-3 text-right text-gray-700 align-top">
                                    {(() => {
                                        // 1. ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                        const rLogs = item.receivedLog || [];
                                        const actualPrices = rLogs.map(l => l.price).filter(p => p !== undefined && p !== null);
                                        
                                        // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏µ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
                                        const uniquePrices = [...new Set(actualPrices)];
                                        const isMixed = uniquePrices.length > 1;
                                        
                                        // 3. ‡∏´‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô unitPrice)
                                        const displayPrice = uniquePrices.length === 1 ? uniquePrices[0] : item.unitPrice;

                                        return (
                                            <div className="flex flex-col items-end">
                                                {isMixed ? (
                                                    // ‡∏Å‡∏£‡∏ì‡∏µ A: ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏Ñ‡∏•‡∏∞‡∏Å‡∏±‡∏ô) -> ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                                                    <>
                                                        <span className="text-xs font-bold text-orange-700 bg-orange-100 px-2 py-1 rounded border border-orange-200 shadow-sm mb-1">
                                                            ‡∏Ñ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤
                                                        </span>
                                                        <span className="text-[9px] text-gray-400">(Mixed Price)</span>
                                                    </>
                                                ) : (
                                                    // ‡∏Å‡∏£‡∏ì‡∏µ B: ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á) -> ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏õ‡∏Å‡∏ï‡∏¥
                                                    <>
                                                        <span className="font-mono font-bold text-gray-900">
                                                            {displayPrice > 0 ? displayPrice.toLocaleString() : '-'}
                                                        </span>
                                                        {displayPrice > 0 && (
                                                            <span className="text-[10px] text-gray-500">
                                                                {isRent ? `/${item.rentalUnit || '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'}` : `‡∏ö‡∏≤‡∏ó`}
                                                            </span>
                                                        )}
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })()}
                                </td>
                            )}

{/* 3. Column ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô */}
<td className="p-3 text-center align-top">
    {isCostEditMode ? (
        // ‚≠ê [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á Input ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Qty) ‡πÅ‡∏•‡∏∞ Dropdown ‡∏´‡∏ô‡πà‡∏ß‡∏¢
        <div className="flex flex-col items-center gap-1">
            <input 
                type="number" 
                min={item.receivedTotal || 1} // ‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                className="border border-blue-300 rounded px-1 py-1 text-sm font-bold text-blue-700 bg-blue-50 outline-none w-20 text-center focus:ring-2 focus:ring-blue-500"
                value={item.qty}
                onChange={(e) => {
                    const val = parseInt(e.target.value) || 0;
                    const newData = {...tempCostRequest};
                    newData.items[idx].qty = val; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ Qty ‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á Temp
                    setTempCostRequest(newData);
                }}
                onClick={(e) => e.stopPropagation()}
            />
            
            <select 
                className="border border-indigo-300 rounded px-1 py-0.5 text-xs bg-indigo-50 text-indigo-700 outline-none w-20 text-center cursor-pointer hover:bg-indigo-100"
                value={item.unit}
                onChange={(e) => {
                    const newData = {...tempCostRequest};
                    newData.items[idx].unit = e.target.value;
                    setTempCostRequest(newData);
                }}
                onClick={(e) => e.stopPropagation()}
            >
                {ITEM_UNITS.map(u => <option key={u} value={u}>{u}</option>)}
            </select>
        </div>
    ) : (
        <div className="font-bold text-blue-700 text-base">
            {item.qty} <span className="text-xs text-gray-500 font-normal">{item.unit}</span>
        </div>
    )}
    
    {isRent && isBuy && (
        <div className="text-[10px] mt-0.5 text-indigo-600 font-bold">
            x {item.duration || 1} {item.rentalUnit === 'Day' ? '‡∏ß‡∏±‡∏ô' : item.rentalUnit === 'Year' ? '‡∏õ‡∏µ' : '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'}
        </div>
    )}
</td>

                            {/* 4. Column ‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô */}
                            {isBuy && (
                                <td className="p-3 text-right font-bold text-gray-900 align-top bg-gray-50/50">
                                    {lineTotal.toLocaleString()}
                                </td>
                            )}

{/* 5. Column ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ */}
                            <td className="p-3 text-xs text-gray-500 align-top break-words whitespace-pre-wrap max-w-[200px]">
                                {item.note || '-'}
                                
                                {/* ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ö‡∏ö Real-time (‡∏´‡∏±‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß) */}
                                {['Local', 'HO'].includes(selectedRequest.type) && (() => {
                                    // --- 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏™‡∏î‡∏∏ (Inventory) ---
                                    const stockItem = inventory.find(inv => inv.name === item.name && inv.project === selectedRequest.job);
                                    let invDisplay = null;
                                    
                                    if (stockItem) {
                                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á (Reserved) ‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô
                                        const reservedQty = requests
                                            .filter(r => 
                                                r.type === 'Withdraw' && 
                                                r.job === selectedRequest.job && 
                                                !['Draft', 'Completed', 'Rejected', 'Returned', 'Cancelled'].includes(r.status) &&
                                                r.id !== selectedRequest.id // ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡πÉ‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
                                            )
                                            .reduce((sum, req) => {
                                                const match = req.items.find(i => i.name === item.name);
                                                return sum + (match ? (match.qty || 0) : 0);
                                            }, 0);
                                        
                                        // ‡∏¢‡∏≠‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ö‡∏¥‡∏Å = ‡∏¢‡∏≠‡∏î‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á - ‡∏¢‡∏≠‡∏î‡∏à‡∏≠‡∏á
                                        const available = Math.max(0, stockItem.qty - reservedQty);
                                        invDisplay = { available, unit: stockItem.unit, reserved: reservedQty };
                                    }

                                    // --- 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Assets) ---
                                    // ‡∏ô‡∏±‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏ß‡πà‡∏≤‡∏á" (Available)
                                    const availableAssetsCount = assets.filter(a => 
                                        a.name === item.name && 
                                        a.project === selectedRequest.job && 
                                        a.status === 'Available'
                                    ).length;
                                    
                                    // ‡∏ô‡∏±‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏∑‡∏°" (‡πÅ‡∏ï‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô Available ‡∏≠‡∏¢‡∏π‡πà)
                                    const pendingBorrowCount = requests
                                        .filter(r => 
                                            r.type === 'Borrow' && 
                                            r.job === selectedRequest.job && 
                                            !['Draft', 'Completed', 'Rejected', 'Returned', 'Cancelled'].includes(r.status) &&
                                            r.id !== selectedRequest.id
                                        )
                                        .reduce((sum, req) => {
                                            const count = req.items.filter(i => i.name === item.name).length;
                                            return sum + count;
                                        }, 0);

                                    // ‡∏¢‡∏≠‡∏î‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á = ‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î - ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                    const netAvailableAssets = Math.max(0, availableAssetsCount - pendingBorrowCount);

                                    // --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
                                    if (invDisplay || netAvailableAssets > 0 || pendingBorrowCount > 0) {
                                        return (
                                            <div className="flex flex-col gap-1 mt-1">
                                                {invDisplay && (
                                                    <div className="text-[10px] text-teal-600 bg-teal-50 border border-teal-200 px-1.5 py-0.5 rounded w-fit font-bold flex flex-wrap items-center gap-1" 
                                                         title={`‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${stockItem.qty}, ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß: ${invDisplay.reserved}`}>
                                                        <Box size={10}/> 
                                                        <span>‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á: {invDisplay.available} {invDisplay.unit}</span>
                                                        {invDisplay.reserved > 0 && (
                                                            <span className="text-orange-500 text-[9px]">(‡∏à‡∏≠‡∏á {invDisplay.reserved})</span>
                                                        )}
                                                    </div>
                                                )}
                                                
                                                {(netAvailableAssets > 0 || pendingBorrowCount > 0) && (
                                                    <div className="text-[10px] text-indigo-600 bg-indigo-50 border border-indigo-200 px-1.5 py-0.5 rounded w-fit font-bold flex flex-wrap items-center gap-1"
                                                         title={`‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏á: ${availableAssetsCount}, ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${pendingBorrowCount}`}>
                                                        <Monitor size={10}/> 
                                                        <span>‡∏ß‡πà‡∏≤‡∏á: {netAvailableAssets}</span>
                                                        {pendingBorrowCount > 0 && (
                                                            <span className="text-orange-500 text-[9px]">(‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß {pendingBorrowCount})</span>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    }
                                    return null;
                                })()}

                                {/* ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */}
                                {['Completed', 'Partially Received'].includes(selectedRequest.status) && (item.receivedTotal || 0) < item.qty && (
                                    <div className="mt-1 text-[10px] text-orange-700 bg-orange-50 border border-orange-200 px-1.5 py-0.5 rounded w-fit font-bold">
                                        * ‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (‡∏Ñ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏à‡∏£‡∏¥‡∏á)
                                    </div>
                                )}

                                {item.images && item.images.length > 0 && (
                                    <div className="mt-1">
                                        <button onClick={(e) => { e.stopPropagation(); setViewingAttachments({ attachments: item.images }); }} className="text-[10px] text-blue-600 flex items-center gap-1 hover:underline">
                                            <ImageIcon className="w-3 h-3"/> ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ({item.images.length})
                                        </button>
                                    </div>
                                )}
                            </td>
                        </tr>
                        
                        {/* Expanded Details Row */}
                        {isExpanded && hasDetails && (
                            <tr className="bg-gray-50/50 animate-in fade-in">
                                <td colSpan={isBuy ? 5 : 3} className="p-4 border-t border-gray-200 shadow-inner">
                                    <div className="bg-white border border-gray-200 rounded-lg overflow-hidden max-w-4xl mx-auto">
                                        <div className="px-4 py-2 bg-gray-100/80 border-b flex justify-between items-center">
                                            <h5 className="font-bold text-gray-700 text-xs flex items-center gap-2">
                                                <List className="w-3 h-3 text-gray-500"/> 
                                                {hasAssets ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏¥‡πâ‡∏ô (Asset Details)' : '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (Receive History)'}
                                            </h5>
                                            {/* ‚≠ê ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏Ñ‡∏≤ */}
                                            {isCostEditMode && hasLogs && <span className="text-[10px] text-orange-600 font-bold flex items-center gap-1 bg-orange-50 px-2 py-0.5 rounded border border-orange-200"><Edit className="w-3 h-3"/> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏£‡∏¥‡∏á (Actual Price) ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</span>}
                                        </div>
                                        
                                        <table className="w-full text-xs text-left">
                                            <thead className="bg-gray-50 text-gray-500 font-semibold">
                                                <tr>
                                                    <th className="px-4 py-2 w-10 text-center">#</th>
                                                    <th className="px-4 py-2 w-28">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th> 
                                                    {hasAssets ? (
                                                        <>
                                                            <th className="px-4 py-2 w-32">Asset ID</th>
                                                            <th className="px-4 py-2 w-32">Serial No.</th>
                                                        </>
                                                    ) : (
                                                        <th className="px-4 py-2" colSpan="2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö (Batch Info)</th>
                                                    )}
                                                    {isBuy && (
                                                        <>
                                                            <th className="px-4 py-2 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏£‡∏¥‡∏á (Price)</th>
                                                            {isRent && <th className="px-4 py-2 text-center w-28">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th>}
                                                            <th className="px-4 py-2 text-right w-32">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô (Total)</th>
                                                        </>
                                                    )}
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                              {(() => {
                                                    if (hasAssets) {
                                                        return relatedAssets.map((asset, aIdx) => {
                                                            const assetPrice = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                                                            const assetDuration = isRent ? (asset.duration || item.duration || 1) : 1;
                                                            const totalRow = assetPrice * assetDuration;
                                                            const unitMap = { 'Day': '‡∏ß‡∏±‡∏ô', 'Month': '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', 'Year': '‡∏õ‡∏µ' };
                                                            const unitLabel = unitMap[asset.rentalUnit] || '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';

                                                            return (
                                                                <tr key={`ast-${aIdx}`} className="hover:bg-blue-50/50">
                                                                    <td className="px-4 py-2.5 text-center text-gray-400">{aIdx + 1}</td>
                                                                    <td className="px-4 py-2.5 text-gray-500 font-mono">
                                                                        {asset.lastUpdated ? asset.lastUpdated.split(' ')[0] : '-'}
                                                                    </td>
                                                                    <td className="px-4 py-2.5">
                                                                        <span className="font-mono text-blue-600 font-bold bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100">
                                                                            {asset.id}
                                                                        </span>
                                                                    </td>
                                                                    <td className="px-4 py-2.5 font-mono text-gray-600">
                                                                        {asset.serial || '-'}
                                                                    </td>
                                                                    {isBuy && (
                                                                        <>
                                                                            <td className="px-4 py-2.5 text-right font-mono">
                                                                                {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Edit Mode ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Input ‡∏£‡∏≤‡∏Ñ‡∏≤ */}
                                                                                {isCostEditMode ? (
                                                                                    <input 
                                                                                        type="number" 
                                                                                        className="border border-blue-300 rounded px-1 py-0.5 text-right w-24 text-sm font-bold text-blue-700 bg-blue-50 focus:ring-2 focus:ring-blue-500 outline-none"
                                                                                        value={isRent ? asset.rentalPrice : asset.price}
                                                                                        onChange={(e) => {
    const val = parseFloat(e.target.value) || 0;
    setTempCostRequest(prev => {
        const newAssets = prev.tempAssets.map(item => 
            item.id === asset.id 
                ? { ...item, [isRent ? 'rentalPrice' : 'price']: val }
                : item
        );
        return { ...prev, tempAssets: newAssets };
    });
}}
                                                                                    />
                                                                                ) : (
                                                                                    assetPrice.toLocaleString()
                                                                                )}
                                                                            </td>
                                                                            
                                                                            {isRent && (
                                                                                <td className="px-4 py-2.5 text-center text-indigo-600 font-bold bg-indigo-50/30">
                                                                                    {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Edit Mode ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Input ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢ */}
                                                                                    {isCostEditMode ? (
                                                                                        <div className="flex items-center gap-1 justify-center">
                                                                                            <input 
                                                                                                type="number"
                                                                                                min="1"
                                                                                                className="border border-indigo-300 rounded px-1 py-0.5 text-center w-12 text-xs font-bold text-indigo-700 bg-white focus:ring-1 focus:ring-indigo-500"
                                                                                                value={asset.duration || 1}
                                                                                               onChange={(e) => {
    const val = parseFloat(e.target.value) || 1;
    setTempCostRequest(prev => {
        const newAssets = prev.tempAssets.map(item => 
            item.id === asset.id 
                ? { ...item, duration: val }
                : item
        );
        return { ...prev, tempAssets: newAssets };
    });
}}
                                                                                            />
                                                                                            <select
                                                                                                className="border border-indigo-300 rounded px-0 py-0.5 text-xs bg-white text-indigo-700 outline-none"
                                                                                                value={asset.rentalUnit || 'Month'}
                                                                                           onChange={(e) => {
    const val = e.target.value;
    setTempCostRequest(prev => {
        const newAssets = prev.tempAssets.map(item => 
            item.id === asset.id 
                ? { ...item, rentalUnit: val }
                : item
        );
        return { ...prev, tempAssets: newAssets };
    });
}}
                                                                                            >
                                                                                                <option value="Day">‡∏ß‡∏±‡∏ô</option>
                                                                                                <option value="Month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                                                                                <option value="Year">‡∏õ‡∏µ</option>
                                                                                            </select>
                                                                                        </div>
                                                                                    ) : (
                                                                                        `${assetDuration} ${unitLabel}`
                                                                                    )}
                                                                                </td>
                                                                            )}
                                                                            
                                                                            <td className="px-4 py-2.5 text-right font-bold text-gray-800">
                                                                                {totalRow.toLocaleString()}
                                                                            </td>
                                                                        </>
                                                                    )}
                                                                </tr>
                                                            );
                                                        });
                                                    }
                                                     else if (hasLogs) {
                                                        return receivedLogs.map((log, lIdx) => {
                                                            const logDuration = isRent ? (log.duration || 1) : 1;
                                                            const totalRow = log.qty * log.price * logDuration;

                                                            return (
                                                                <tr key={`log-${lIdx}`} className="hover:bg-gray-50">
                                                                    <td className="px-4 py-2.5 text-center text-gray-400">{lIdx + 1}</td>
                                                                    <td className="px-4 py-2.5 text-gray-500 font-mono">
                                                                        {log.date.split(' ')[0]}
                                                                    </td>
                                                                    <td className="px-4 py-2.5 text-gray-500" colSpan="2">
                                                                        <span className="ml-2 text-gray-400 italic">(Lot/Batch Inventory)</span>
                                                                    </td>
                                                                    {isBuy && (
                                                                        <>
                                                                            <td className="px-4 py-2.5 text-right font-mono text-gray-600">
                                                                                {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Input ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏£‡∏¥‡∏á (Lot Price) */}
                                                                                {isCostEditMode ? (
                                                                                    <div className="flex items-center justify-end gap-1">
                                                                                        <input 
                                                                                            type="number" 
                                                                                            className="border border-blue-300 rounded px-1 py-0.5 text-right w-24 text-sm font-bold text-blue-700 bg-blue-50 focus:ring-2 focus:ring-blue-500 outline-none"
                                                                                            value={log.price}
                                                                                            onChange={(e) => {
                                                                                                const newData = {...tempCostRequest};
                                                                                                // ‡πÅ‡∏Å‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô Log ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ
                                                                                                newData.items[idx].receivedLog[lIdx].price = parseFloat(e.target.value) || 0;
                                                                                                setTempCostRequest(newData);
                                                                                            }}
                                                                                        />
                                                                                        <span className="text-[10px] text-gray-400">x {log.qty}</span>
                                                                                    </div>
                                                                                ) : (
                                                                                    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏Å‡∏ï‡∏¥
                                                                                    <>
                                                                                        {log.price.toLocaleString()} <span className="text-[10px] text-gray-400">x {log.qty}</span>
                                                                                    </>
                                                                                )}
                                                                            </td>
                                                                            {isRent && (
                                                                                <td className="px-4 py-2.5 text-center text-indigo-600 font-bold">
                                                                                    {logDuration}
                                                                                </td>
                                                                            )}
                                                                            <td className="px-4 py-2.5 text-right font-bold text-gray-800">
                                                                                {totalRow.toLocaleString()}
                                                                            </td>
                                                                        </>
                                                                    )}
                                                                </tr>
                                                            );
                                                        });
                                                    }
                                                    return <tr><td colSpan="7" className="p-4 text-center text-gray-400 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</td></tr>;
                                                })()}
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        )}
                        </React.Fragment>
                    );
                })}
            </tbody>

{/* ‚≠ê 4. Footer: ‡πÅ‡∏™‡∏î‡∏á Grand Total */}
{['Local', 'HO'].includes(selectedRequest.type) && (
    <tfoot className="bg-gray-50 border-t-2 border-gray-200">
        <tr>
            <td colSpan="3" className="p-4 text-right text-gray-600 text-sm align-top pt-5">
                ‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô (Grand Total)
            </td>
            <td className="p-4 text-right">
                <div className="font-bold text-xl text-blue-700">
                    {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Grand Total */}
                    {(isCostEditMode && tempCostRequest ? tempCostRequest.items : selectedRequest.items).reduce((sum, item) => {
                        const isRent = selectedRequest.type === 'HO' && selectedRequest.purchaseType === 'Rent';
                        const sourceAssets = (isCostEditMode && tempCostRequest?.tempAssets) ? tempCostRequest.tempAssets : assets;
                        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏Ñ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
const relatedAssets = sourceAssets.filter(a => 
        a.currentRequestId === selectedRequest.id && // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠
        a.name === item.name && // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        // 3. ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ _originalPrice ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ó‡∏ô)
        (
            (isCostEditMode && a._originalPrice !== undefined)
                ? (a._originalPrice === item.unitPrice) 
                : (a.price === item.unitPrice || a.rentalPrice === item.unitPrice)
        )
    );

    const receivedLogs = item.receivedLog || [];
                        
                        let itemTotal = 0;
                        let receivedCount = 0;

                        // A. Assets
                        if (relatedAssets.length > 0) {
                            itemTotal += relatedAssets.reduce((aSum, asset) => {
                                const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                                const duration = isRent ? (asset.duration || item.duration || 1) : 1;
                                return aSum + (price * duration);
                            }, 0);
                            receivedCount = relatedAssets.length;
                        } 
                        // B. Logs
                        else if (receivedLogs.length > 0) {
                            itemTotal += receivedLogs.reduce((lSum, log) => {
                                const duration = isRent ? (log.duration || 1) : 1;
                                return lSum + (log.qty * log.price * duration);
                            }, 0);
                            receivedCount = item.receivedTotal || 0;
                        }
                        
                        // ‚≠ê C. Estimate: ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà" ‡∏à‡∏ö‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô
                        // (Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô)
                        if (!['Completed', 'Partially Received'].includes(selectedRequest.status)) {
                            const remainingQty = Math.max(0, item.qty - receivedCount);
                            const estimateDuration = isRent ? (item.duration || 1) : 1;
                            itemTotal += (remainingQty * item.unitPrice * estimateDuration);
                        }

                        return sum + itemTotal;
                    }, 0).toLocaleString()}
                </div>

                {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡πâ‡∏≤‡∏¢‡∏ö‡∏¥‡∏• */}
                {['Completed', 'Partially Received'].includes(selectedRequest.status) && (
                    <div className="text-[10px] text-orange-600 font-bold mt-1 bg-orange-50 px-2 py-1 rounded border border-orange-200 inline-block">
                        * ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)
                    </div>
                )}
            </td>
            <td className="bg-gray-50"></td> 
        </tr>
    </tfoot>
)}
        </table>
    </div>
</div>
                        </div>
                        <div className="space-y-6">
                            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm h-full flex flex-col">
                                <h4 className="font-bold text-gray-700 mb-4 flex items-center gap-2 border-b pb-2"><History className="w-4 h-4"/> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h4>
                                <div className="relative border-l-2 border-gray-100 ml-2 space-y-6 pb-2 flex-1 overflow-y-auto pr-2">
                                    {selectedRequest.history.slice().reverse().map((log, idx) => (
                                        <div key={idx} className="ml-6 relative">
                                            <div className={`absolute -left-[31px] top-0 w-4 h-4 rounded-full border-2 border-white ${idx===0 ? 'bg-blue-500 ring-2 ring-blue-100' : 'bg-gray-300'}`}></div>
                                            <div className="flex justify-between items-start">
    <span className="text-xs font-bold text-gray-900">
        {/* ‚≠ê ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ Pending PM ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Pending Level 2 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ */}
        {log.action === 'Pending PM' ? 'Pending Level 2' : log.action}
    </span>
    {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° Timestamp ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */}
    <span className="text-[10px] text-gray-400 whitespace-nowrap ml-2 font-mono">
        {log.date}
    </span>
</div>
                                            <p className="text-xs text-gray-500 mt-0.5">‡πÇ‡∏î‡∏¢: {log.user}</p>
                                            {log.note && (<div className={`mt-2 text-xs p-3 rounded-lg border ${log.action === 'Return for Revision' || log.note.includes('‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç') ? 'bg-red-50 text-red-700 border-red-200 font-medium' : 'bg-gray-50 text-gray-600 border-gray-100'}`}>{log.action === 'Return for Revision' && <AlertCircle className="w-3 h-3 inline mr-1 mb-0.5"/>}{log.note}</div>)}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
             </div>
        </div>
      )}

{showVerificationModal && (
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[80] p-4 backdrop-blur-sm animate-in fade-in">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-in zoom-in-95 duration-200 flex flex-col max-h-[90vh]">
             
             {/* --- HEADER --- */}
             <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-start bg-white sticky top-0 z-10">
                 <div>
                     <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2">
                         <CheckSquare className="w-5 h-5 text-indigo-600"/> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                     </h3>
                     <p className="text-sm text-gray-500 mt-1">Verification Process</p>
                 </div>
                 
                 <div className="flex items-center gap-2">
                    

                     <button 
                        type="button"
                        onClick={() => setShowVerificationModal(false)} 
                        className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
                        title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á"
                     >
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                 </div>
             </div>
             
             {/* --- BODY --- */}
             <div className="p-6 overflow-y-auto bg-gray-50 flex-1 space-y-4">
                 
                 {/* Checklist Section */}
                 <div className="space-y-3">
                     {/* Quotation Check */}
                     <div className={`p-3 rounded-xl border shadow-sm flex items-center justify-between transition-colors ${verificationData.checks.quotation ? 'bg-white border-gray-200' : 'bg-red-50 border-red-200'}`}>
                         <div className="flex items-center gap-3">
                             <div className={`w-8 h-8 rounded-full flex items-center justify-center ${verificationData.filesExist.quotation ? 'bg-indigo-50 text-indigo-600' : 'bg-gray-100 text-gray-400'}`}>
                                 <FileText className="w-4 h-4"/>
                             </div>
                             <div>
                                 <p className="text-sm font-bold text-gray-700">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (Quotation)</p>
                                 {!verificationData.filesExist.quotation && <span className="text-[10px] text-red-500 font-bold">* ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</span>}
                                 {verificationData.filesExist.quotation && 
                                     <button 
                                         type="button"
                                         onClick={(e) => {
                                             e.preventDefault();
                                             const req = requests.find(r => r.id === verificationData.requestId);
                                             handleViewFile(req?.quotation, 'Quotation');
                                         }}
                                         className="text-[10px] text-indigo-600 hover:underline flex items-center gap-1"
                                     >
                                         <Eye className="w-3 h-3"/> ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå
                                     </button>
                                 }
                             </div>
                         </div>
                         <label className={`cursor-pointer px-3 py-1.5 rounded-lg border text-xs font-bold transition-all flex items-center gap-1.5 ${verificationData.checks.quotation ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-red-300 text-red-600 shadow-sm'}`}>
                             <input 
                                 type="checkbox" className="hidden"
                                 checked={verificationData.checks.quotation} 
                                 onChange={() => handleChecklistChange('quotation')} 
                             />
                             {verificationData.checks.quotation 
                                 ? (verificationData.filesExist.quotation ? <><CheckCircle className="w-3 h-3"/> ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</> : <><CheckSquare className="w-3 h-3"/> ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÉ‡∏´‡πâ (Waive)</>)
                                 : (verificationData.filesExist.quotation ? '‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' : '‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ')
                             }
                         </label>
                     </div>

                     {/* Email Check */}
                     <div className={`p-3 rounded-xl border shadow-sm flex items-center justify-between transition-colors ${verificationData.checks.email ? 'bg-white border-gray-200' : 'bg-red-50 border-red-200'}`}>
                         <div className="flex items-center gap-3">
                             <div className={`w-8 h-8 rounded-full flex items-center justify-center ${verificationData.filesExist.email ? 'bg-indigo-50 text-indigo-600' : 'bg-gray-100 text-gray-400'}`}>
                                 <Mail className="w-4 h-4"/>
                             </div>
                             <div>
                                 <p className="text-sm font-bold text-gray-700">‡πÄ‡∏°‡∏•‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approval Email)</p>
                                 {!verificationData.filesExist.email && <span className="text-[10px] text-red-500 font-bold">* ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</span>}
                                 {verificationData.filesExist.email && 
                                     <button 
                                         type="button"
                                         onClick={(e) => {
                                             e.preventDefault();
                                             const req = requests.find(r => r.id === verificationData.requestId);
                                             handleViewFile(req?.attachment, 'Approval Email');
                                         }}
                                         className="text-[10px] text-indigo-600 hover:underline flex items-center gap-1"
                                     >
                                         <Eye className="w-3 h-3"/> ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå
                                     </button>
                                 }
                             </div>
                         </div>
                         <label className={`cursor-pointer px-3 py-1.5 rounded-lg border text-xs font-bold transition-all flex items-center gap-1.5 ${verificationData.checks.email ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-red-300 text-red-600 shadow-sm'}`}>
                             <input 
                                 type="checkbox" className="hidden"
                                 checked={verificationData.checks.email} 
                                 onChange={() => handleChecklistChange('email')} 
                             />
                             {verificationData.checks.email 
                                 ? (verificationData.filesExist.email ? <><CheckCircle className="w-3 h-3"/> ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</> : <><CheckSquare className="w-3 h-3"/> ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÉ‡∏´‡πâ (Waive)</>)
                                 : (verificationData.filesExist.email ? '‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' : '‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ')
                             }
                         </label>
                     </div>

                     {/* Details Check */}
                     <div className={`p-3 rounded-xl border shadow-sm flex items-center justify-between transition-colors ${verificationData.checks.details ? 'bg-white border-gray-200' : 'bg-red-50 border-red-200'}`}>
                         <div className="flex items-center gap-3">
                             <div className="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
                                 <List className="w-4 h-4"/>
                             </div>
                             <p className="text-sm font-bold text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (Details)</p>
                         </div>
                         <label className={`cursor-pointer px-3 py-1.5 rounded-lg border text-xs font-bold transition-all flex items-center gap-1.5 ${verificationData.checks.details ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-red-300 text-red-600 shadow-sm'}`}>
                             <input 
                                 type="checkbox" className="hidden"
                                 checked={verificationData.checks.details} 
                                 onChange={() => handleChecklistChange('details')} 
                             />
                             {verificationData.checks.details 
                                 ? <><CheckCircle className="w-3 h-3"/> ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</>
                                 : '‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Revise)'
                             }
                         </label>
                     </div>
                 </div>

                 {/* Additional Options */}
                 <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm space-y-3">
                     
                     
{!verificationData.isChangeMode && !requests.find(r => r.id === verificationData.requestId)?.isPreviouslyApproved && (
    <label className={`flex items-start gap-3 cursor-pointer group ${!isVerificationPass() ? 'opacity-50 pointer-events-none' : ''}`}>
        <div className="pt-0.5 relative">
            <input 
                type="checkbox" 
                className="peer w-5 h-5 appearance-none border-2 border-gray-300 rounded checked:bg-blue-600 checked:border-blue-600 transition-colors"
                checked={verificationData.needApproval}
                onChange={(e) => setVerificationData({...verificationData, needApproval: e.target.checked})}
            />
            <CheckCircle className="w-3.5 h-3.5 text-white absolute top-[3px] left-[3px] opacity-0 peer-checked:opacity-100 pointer-events-none"/>
        </div>
        <div>
            <p className="text-sm font-bold text-gray-800 group-hover:text-blue-700 transition-colors">
                ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Level 1/Level 2 ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Full Flow)
            </p>
            <p className="text-xs text-gray-500">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>
        </div>
    </label>
)}
                     {/* Contract Option (Only for Rent) */}
                     {requests.find(r => r.id === verificationData.requestId)?.purchaseType === 'Rent' && (
                         <>
                             <hr className="border-gray-100"/>
                             <label className={`flex items-start gap-3 cursor-pointer group ${!isVerificationPass() ? 'opacity-50 pointer-events-none' : ''}`}>
                                 <div className="pt-0.5 relative">
                                     <input 
                                         type="checkbox" 
                                         className="peer w-5 h-5 appearance-none border-2 border-gray-300 rounded checked:bg-blue-600 checked:border-blue-600 transition-colors"
                                         checked={verificationData.needContract}
                                         onChange={(e) => setVerificationData({...verificationData, needContract: e.target.checked})}
                                     />
                                     <CheckCircle className="w-3.5 h-3.5 text-white absolute top-[3px] left-[3px] opacity-0 peer-checked:opacity-100 pointer-events-none"/>
                                 </div>
                                 <div>
                                     <p className="text-sm font-bold text-gray-800 group-hover:text-blue-700 transition-colors">
                                         ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (Require Contract)
                                     </p>
                                     <p className="text-xs text-gray-500">‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡∏à‡∏∞‡∏°‡∏µ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏±‡∏ç‡∏ç‡∏≤, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</p>
                                 </div>
                             </label>
                         </>
                     )}
                 </div>

                 {/* Note */}
                 <div>
                     <label className="text-xs font-bold text-gray-500 mb-1.5 block">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Note)</label>
                     <textarea 
                        className="w-full p-3 text-sm border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all shadow-sm bg-white" 
                        rows="3"
                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."
                        value={verificationData.note}
                        onChange={e => setVerificationData({...verificationData, note: e.target.value})}
                     ></textarea>
                 </div>
             </div>

             {/* --- FOOTER ACTION --- */}
             <div className="p-5 border-t border-gray-100 bg-white">
                 <button 
                     onClick={handleConfirmVerification} 
                     className={`w-full py-3.5 rounded-xl text-white font-bold shadow-lg flex items-center justify-center gap-2 transition-all transform hover:scale-[1.01] ${
                         !isVerificationPass() 
                         ? 'bg-red-500 hover:bg-red-600 shadow-red-200' // Fail
                         : verificationData.needApproval
                             ? 'bg-orange-500 hover:bg-orange-600 shadow-orange-200' // Pass & Forward
                             : 'bg-green-600 hover:bg-green-700 shadow-green-200' // Pass & Approve
                     }`}
                 >
                     {!isVerificationPass() ? (
                         <><RotateCcw className="w-5 h-5"/> ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Return)</>
                     ) : verificationData.needApproval ? (
                         <><ArrowUpRight className="w-5 h-5"/> ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Forward)</>
                     ) : (
                         <><CheckCircle className="w-5 h-5"/> ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠ (Pass)</>
                     )}
                 </button>
             </div>
          </div>
        </div>
      )}

{showReceiveGoodsModal && selectedRequest && (
  <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[80] p-4 backdrop-blur-sm animate-in fade-in">
    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[95vh] flex flex-col overflow-hidden">
      
      {/* Data Lists */}
      <datalist id="inventory-list">{inventory.map((inv, i) => <option key={i} value={inv.name} />)}</datalist>
      <datalist id="asset-list">{[...new Set(assets.map(a => a.name))].map((name, i) => <option key={i} value={name} />)}</datalist>

      <datalist id="supplier-list-options">
          {[...new Set(invLogs.map(l => l.supplier).filter(s => s))].map((s, i) => (
              <option key={i} value={s} />
          ))}
      </datalist>

      {/* HEADER */}
      <div className="px-6 py-4 border-b flex justify-between items-center bg-white">
          <div>
              <h3 className="font-bold text-lg text-teal-700 flex items-center gap-2">
                  <Download className="w-5 h-5"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (Receive Goods)
              </h3>
              <p className="text-xs text-gray-500">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ {selectedRequest.id}</p>
          </div>
          <button onClick={() => setShowReceiveGoodsModal(false)} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors">
              <X className="w-6 h-6"/>
          </button>
      </div>

      {/* BODY */}
      <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
          <div className="space-y-6">
          
          {receiveItems.map((item, idx) => (
              <div key={idx} className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                  
                  {/* Row 1: Header Item & Qty */}
                  <div className="flex flex-wrap md:flex-nowrap gap-4 mb-4 pb-4 border-b border-dashed border-gray-200">
                      <div className="flex-1 min-w-[250px]">
                          <label className="text-xs text-gray-500 font-bold mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Item Name)</label>
                          {item.targetType === 'Inventory' ? (
                              <div className="relative">
                                  <input 
    type="text" 
    list="inventory-list" 
    className="w-full p-2 border border-gray-300 rounded-lg text-sm font-bold text-gray-800 focus:ring-2 focus:ring-blue-500 outline-none" 
    value={item.name} 
    onChange={(e) => { 
        const val = e.target.value;
        const n = [...receiveItems];
        n[idx].name = val; 

        // ‚≠ê‚≠ê [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] Logic: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚≠ê‚≠ê
        if (item.targetType === 'Inventory') {
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const existingInv = inventory.find(inv => inv.name === val && inv.project === selectedRequest.job);
            
            if (existingInv) {
    // ‚úÖ ‡πÄ‡∏à‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°: ‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡∏°‡∏≤‡πÉ‡∏™‡πà (‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô) + ‡∏õ‡∏•‡∏î‡∏ï‡∏¥‡πä‡∏Å Auto
    n[idx].inventoryId = getDisplayId(existingInv.id); // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    n[idx].isInvAutoId = false; 
} else {
                // ‚ùå ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà): ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏´‡∏±‡∏™ + ‡∏ï‡∏¥‡πä‡∏Å Auto (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ)
                // n[idx].inventoryId = ''; 
                // n[idx].isInvAutoId = true;
            }
        }

        setReceiveItems(n); 
    }} 
/>
                              </div>
                          ) : (
                              <div className="p-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-gray-600">
                                  {item.name} <span className="text-xs font-normal text-gray-400">(‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏¥‡πâ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)</span>
                              </div>
                          )}
                      </div>

                      <div className="flex gap-2">
                          <div className="w-20 text-center bg-gray-50 rounded-lg p-1 border">
                              <label className="text-[9px] text-gray-400 font-bold block">‡∏™‡∏±‡πà‡∏á (Order)</label>
                              <div className="text-sm font-bold text-gray-600">{item.orderedQty}</div>
                          </div>
                          <div className="w-20 text-center bg-green-50 rounded-lg p-1 border border-green-100">
                               <label className="text-[9px] text-green-600 font-bold block">‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</label>
                               <div className="text-sm font-bold text-green-700">{item.receivedSoFar}</div>
                          </div>
                      </div>

                      <div className="w-32">
                          <label className="text-xs text-teal-700 font-bold mb-1 block">‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ (Qty)</label>
                          <input 
                              type="number" min="0" max={Math.max(0, item.orderedQty - item.receivedSoFar)}
                              className="w-full p-2 border-2 border-teal-500 rounded-lg text-center font-bold text-teal-800 focus:ring-4 focus:ring-teal-100 outline-none text-lg" 
                              value={item.receivedQty} 
                              onChange={(e) => {
                                  const val = Math.min(Math.max(0, parseInt(e.target.value) || 0), item.orderedQty - item.receivedSoFar);
                                  const newItems = [...receiveItems];
                                  newItems[idx].receivedQty = val;
                                  // Re-generate asset rows
                                  if(item.targetType === 'Asset') {
                                      const currentLen = newItems[idx].assetsToRegister.length;
                                      if(val > currentLen) {
                                          const addCount = val - currentLen;
                                          const newRows = Array.from({length: addCount}, () => ({ 
                                              id: '', isAutoId: false, serial: '', name: item.name, note: '', images: [],
                                              rentalStart: '', rentalEnd: '', rentalPrice: item.isRent ? item.actualPrice : 0, rentalUnit: 'Month', price: item.actualPrice
                                          }));
                                          newItems[idx].assetsToRegister = [...newItems[idx].assetsToRegister, ...newRows];
                                      }
                                  }
                                  setReceiveItems(newItems);
                              }}
                          />
                      </div>
                  </div>

                  <div className="flex flex-col md:flex-row gap-4 mb-4 items-end">
                      
                      {/* ‚≠ê‚≠ê [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏ (Inventory ID) ‚≠ê‚≠ê */}
                      {item.targetType === 'Inventory' && (
                          <div className="w-full md:w-1/3">
                              <div className="flex justify-between items-center mb-1">
                                  <label className="text-xs text-gray-500 font-bold">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏ (Material Code)</label>
                                  <label className="flex items-center gap-1 cursor-pointer">
                                      <input 
                                          type="checkbox" 
                                          className="w-3 h-3 accent-teal-600"
                                          checked={item.isInvAutoId}
                                          onChange={(e) => {
                                              const n = [...receiveItems];
                                              n[idx].isInvAutoId = e.target.checked;
                                              // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡πä‡∏Å Auto ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà design)
                                              if(e.target.checked) n[idx].inventoryId = '';
                                              setReceiveItems(n);
                                          }}
                                      />
                                      <span className="text-[10px] text-teal-600 font-bold">Auto Gen No.</span>
                                  </label>
                              </div>
                              <input 
                                  type="text" 
                                  className={`w-full p-2 border border-gray-300 rounded-lg text-sm font-mono ${item.isInvAutoId ? 'bg-gray-100 text-gray-400' : 'bg-white text-gray-800 focus:ring-2 focus:ring-teal-500'}`}
                                  placeholder={item.isInvAutoId ? "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (INV-xxx)" : "‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏..."}
                                  value={item.inventoryId}
                                  disabled={item.isInvAutoId}
                                  onChange={(e) => {
                                      const n = [...receiveItems];
                                      n[idx].inventoryId = e.target.value;
                                      setReceiveItems(n);
                                  }}
                              />
                          </div>
                      )}

                      {/* (‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏° - ‡∏õ‡∏£‡∏±‡∏ö layout ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô) */}
                      {item.targetType === 'Inventory' ? (
                          <div className="w-full md:w-1/3">
                              <label className="text-xs text-gray-500 font-bold mb-1 block">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (Actual Price)</label>
                              <input type="number" className="w-full p-2 border border-gray-300 rounded-lg text-sm" value={item.actualPrice} onChange={(e) => { const n = [...receiveItems]; n[idx].actualPrice = parseFloat(e.target.value) || 0; setReceiveItems(n); }} />
                          </div>
                      ) : (
                          <div className="w-full md:w-1/3"></div>
                      )}



                      <div className="w-full md:w-1/3">
                          <label className="text-xs text-gray-500 font-bold mb-1 block">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Supplier) <span className="text-red-500">*</span></label>
                          <input 
                              type="text" 
                              list="supplier-list-options" // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö Datalist
                              className="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-teal-500 outline-none"
                              placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤..."
                              value={item.supplier}
                              onChange={(e) => {
                                  const n = [...receiveItems];
                                  n[idx].supplier = e.target.value;
                                  setReceiveItems(n);
                              }}
                          />
                      </div>
                      <div className="w-full md:w-2/3">
                          <label className="text-xs text-gray-500 font-bold mb-1 block">‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (Target Storage)</label>
                          <div className="flex bg-gray-100 p-1 rounded-lg border border-gray-200">
                              <button onClick={() => { const n = [...receiveItems]; n[idx].targetType = 'Inventory'; setReceiveItems(n); }} className={`flex-1 py-2 text-sm rounded-md transition-all flex items-center justify-center gap-2 ${item.targetType === 'Inventory' ? 'bg-white shadow-sm text-blue-700 font-bold' : 'text-gray-500 hover:text-gray-700'}`}>
                                  <Box className="w-4 h-4"/> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                              </button>
                              <button onClick={() => { const n = [...receiveItems]; n[idx].targetType = 'Asset'; setReceiveItems(n); }} className={`flex-1 py-2 text-sm rounded-md transition-all flex items-center justify-center gap-2 ${item.targetType === 'Asset' ? 'bg-white shadow-sm text-indigo-700 font-bold' : 'text-gray-500 hover:text-gray-700'}`}>
                                  <Monitor className="w-4 h-4"/> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô
                              </button>
                          </div>
                      </div>
                  </div>

                  
                  {/* Row 3: Image (For Inventory) - ‚≠ê Updated Grid Preview */}
                  {item.targetType === 'Inventory' && (
                      <div className="mb-2">
                           <label className="text-xs text-gray-500 font-bold mb-1 flex items-center gap-1"><ImageIcon className="w-3 h-3"/> ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Stock) - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ</label>
                           
                           <div className="flex flex-col gap-2">
                               {/* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ */}
                               <label className="flex-1 cursor-pointer bg-gray-50 text-gray-600 px-2 py-2 rounded-lg text-xs font-bold hover:bg-gray-100 border border-gray-300 flex flex-col items-center justify-center gap-1 transition-colors">
                   <ImageIcon className="w-4 h-4"/> 
                   <span>‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°</span>
                   <input type="file" multiple accept="image/*" className="hidden" onChange={(e) => handleReceiveImageSelect(e, idx)}/>
               </label>
               {/* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á */}
               <label className="flex-1 cursor-pointer bg-blue-50 text-blue-600 px-2 py-2 rounded-lg text-xs font-bold hover:bg-blue-100 border border-blue-300 flex flex-col items-center justify-center gap-1 transition-colors">
                   <Camera className="w-4 h-4"/>
                   <span>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</span>
                   <input type="file" multiple accept="image/*" capture="environment" className="hidden" onChange={(e) => handleReceiveImageSelect(e, idx)}/>
               </label>
                               
                               {/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ (Preview Grid) */}
                               {item.receiveImages && item.receiveImages.length > 0 && (
                                   <div className="grid grid-cols-4 md:grid-cols-6 gap-2">
                                       {item.receiveImages.map((img, imgI) => (
                                           <div key={imgI} className="relative group w-full h-20 bg-gray-100 rounded border overflow-hidden">
                                               <img src={img.base64} className="w-full h-full object-cover" />
                                               <button onClick={() => handleRemoveReceiveImage(idx, imgI)} className="absolute top-0 right-0 bg-red-500 text-white p-0.5 rounded-bl opacity-0 group-hover:opacity-100 transition-all hover:scale-110" title="‡∏•‡∏ö‡∏£‡∏π‡∏õ">
                                                   <X size={12} strokeWidth={3}/>
                                               </button>
                                           </div>
                                       ))}
                                   </div>
                               )}
                           </div>
                      </div>
                  )}

                  {/* Row 4: Asset Registration Table (Detailed) */}
                  {item.targetType === 'Asset' && item.receivedQty > 0 && (
                      <div className="mt-6 border rounded-xl overflow-hidden animate-in fade-in slide-in-from-top-2 shadow-sm">
                          <div className="bg-indigo-50 px-4 py-3 border-b border-indigo-100 flex justify-between items-center">
                              <p className="text-sm font-bold text-indigo-800 flex items-center gap-2"><List className="w-4 h-4"/> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô ({item.receivedQty} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</p>
                              {item.isRent && <span className="text-[10px] bg-white text-orange-700 px-2 py-0.5 rounded-full border border-orange-200 shadow-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤ (Rent)</span>}
                          </div>
                          
                          <div className="bg-slate-50 p-4 space-y-4">
                              {item.assetsToRegister.slice(0, item.receivedQty).map((assetReg, assetIdx) => (
                                  <div key={assetIdx} className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm relative group">
                                      <div className="absolute -left-2 top-4 w-6 h-6 bg-indigo-600 text-white rounded-full flex items-center justify-center text-xs font-bold shadow-sm z-10">{assetIdx + 1}</div>
                                      
                                      <div className="ml-3 grid grid-cols-1 md:grid-cols-12 gap-3">
                                          {/* Col 1: Asset ID (+ Auto Gen Checkbox) */}
                                          <div className="md:col-span-4">
                                              <div className="flex justify-between items-center mb-1">
                                                  <label className="text-[10px] font-bold text-gray-400">‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Asset ID)</label>
                                                  <label className="flex items-center gap-1 cursor-pointer">
                                                      <input type="checkbox" className="w-3 h-3 accent-indigo-600" checked={assetReg.isAutoId} 
                                                          onChange={(e) => {
                                                              const n = [...receiveItems];
                                                              n[idx].assetsToRegister[assetIdx].isAutoId = e.target.checked;
                                                              if(e.target.checked) n[idx].assetsToRegister[assetIdx].id = ''; 
                                                              setReceiveItems(n);
                                                          }} 
                                                      />
                                                      <span className="text-[9px] text-indigo-600 font-bold">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç/Auto Gen</span>
                                                  </label>
                                              </div>
                                              <input 
                                                  type="text" 
                                                  className={`w-full border border-gray-300 rounded px-2 py-1.5 text-sm font-mono ${assetReg.isAutoId ? 'bg-gray-100 text-gray-400' : 'focus:ring-1 focus:ring-indigo-500'}`}
                                                  placeholder={assetReg.isAutoId ? "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" : `AST-...-${assetIdx+1}`}
                                                  value={assetReg.id}
                                                  disabled={assetReg.isAutoId}
                                                  onChange={(e) => {
                                                      const n = [...receiveItems];
                                                      n[idx].assetsToRegister[assetIdx].id = e.target.value;
                                                      setReceiveItems(n);
                                                  }}
                                              />
                                          </div>

                                          {/* Col 2: Name (Editable) */}
                                          <div className="md:col-span-4">
                                              <label className="text-[10px] font-bold text-gray-400 block mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å (Name)</label>
                                              <div className="relative">
                                                  <input type="text" list="asset-list" className="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-1 focus:ring-indigo-500" value={assetReg.name} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].name = e.target.value; setReceiveItems(n); }} />
                                              </div>
                                          </div>

                                          {/* Col 3: Serial Number */}
                                          <div className="md:col-span-4">
                                              <label className="text-[10px] font-bold text-gray-400 block mb-1">Serial Number (S/N)</label>
                                              <input type="text" className="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-1 focus:ring-indigo-500" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ S/N..." value={assetReg.serial} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].serial = e.target.value; setReceiveItems(n); }} />
                                          </div>
                                          
{item.isRent ? (
                                              <div className="md:col-span-12 grid grid-cols-4 gap-3 bg-orange-50 p-2 rounded border border-orange-100">
                                                  <div>
                                                      <label className="text-[9px] text-orange-800 font-bold">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                                                      <input type="date" className="w-full bg-white border border-orange-200 rounded px-2 py-1 text-xs" value={assetReg.rentalStart} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].rentalStart = e.target.value; setReceiveItems(n); }} />
                                                  </div>
                                                  <div>
                                                      <label className="text-[9px] text-orange-800 font-bold">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                                                      <input type="date" className="w-full bg-white border border-orange-200 rounded px-2 py-1 text-xs" value={assetReg.rentalEnd} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].rentalEnd = e.target.value; setReceiveItems(n); }} />
                                                  </div>
                                                  
                                                  {/* ‚≠ê ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á ‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢ / ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ */}
                                                  <div className="col-span-2 flex gap-2">
                                                      <div className="flex-1">
                                                          <label className="text-[9px] text-orange-800 font-bold">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤</label>
                                                          <input type="number" className="w-full bg-white border border-orange-200 rounded px-2 py-1 text-xs" value={assetReg.rentalPrice} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].rentalPrice = parseFloat(e.target.value); setReceiveItems(n); }} />
                                                      </div>
                                                      <div className="flex-1">
                                                          <label className="text-[9px] text-orange-800 font-bold">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                                                          <select className="w-full bg-white border border-orange-200 rounded px-2 py-1 text-xs" value={assetReg.rentalUnit} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].rentalUnit = e.target.value; setReceiveItems(n); }}>
                                                             <option value="Day">‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô</option>
                                                             <option value="Month">‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                                             <option value="Year">‡∏ö‡∏≤‡∏ó/‡∏õ‡∏µ</option>
                                                          </select>
                                                      </div>
                                                      
                                                      {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (Duration) ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */}
                                                      <div className="flex-1">
                                                          <label className="text-[9px] text-orange-800 font-bold">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                                                          <input 
                                                              type="number" min="1"
                                                              className="w-full bg-white border border-orange-200 rounded px-2 py-1 text-xs text-center font-bold text-indigo-700" 
                                                              value={assetReg.duration !== undefined ? assetReg.duration : (item.duration || 1)} 
                                                              onChange={(e) => { 
                                                                  const n = [...receiveItems]; 
                                                                  n[idx].assetsToRegister[assetIdx].duration = parseFloat(e.target.value) || 1; 
                                                                  setReceiveItems(n); 
                                                              }} 
                                                          />
                                                      </div>
                                                  </div>
                                              </div>
                                          ) : (
                                              /* For Buy: Show Price Field Here */
                                              <div className="md:col-span-4">
                                                  <label className="text-[10px] font-bold text-gray-400 block mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (Price)</label>
                                                  <input type="number" className="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-1 focus:ring-indigo-500" value={assetReg.price} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].price = parseFloat(e.target.value); setReceiveItems(n); }} />
                                              </div>
                                          )}

                                          {/* Note & Image (Updated Multiple) */}
                                          <div className={`${item.isRent ? 'md:col-span-8' : 'md:col-span-4'}`}>
                                              <label className="text-[10px] font-bold text-gray-400 block mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Note)</label>
                                              <input type="text" className="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-1 focus:ring-indigo-500" placeholder="‡∏™‡∏†‡∏≤‡∏û, ‡∏™‡∏µ, ‡∏ï‡∏≥‡∏´‡∏ô‡∏¥..." value={assetReg.note} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].note = e.target.value; setReceiveItems(n); }} />
                                          </div>
                                          
                                          <div className="md:col-span-4">
                                          <label className="text-[10px] font-bold text-gray-400 block mb-1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Images)</label>
                                          
                                          <div className="flex flex-col gap-2">
                                              
                                              {/* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ */}
                                              <label className="flex-1 cursor-pointer bg-white border border-gray-300 text-gray-600 px-2 py-1.5 rounded text-xs hover:bg-gray-50 flex items-center justify-center gap-1 shadow-sm">
              <ImageIcon className="w-3 h-3"/> ‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°
              <input type="file" multiple accept="image/*" className="hidden" onChange={(e) => handleReceiveImageSelect(e, idx, assetIdx)}/>
          </label>
          {/* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á */}
          <label className="flex-1 cursor-pointer bg-indigo-50 border border-indigo-200 text-indigo-600 px-2 py-1.5 rounded text-xs hover:bg-indigo-100 flex items-center justify-center gap-1 shadow-sm">
              <Camera className="w-3 h-3"/> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
              <input type="file" multiple accept="image/*" capture="environment" className="hidden" onChange={(e) => handleReceiveImageSelect(e, idx, assetIdx)}/>
          </label>

                                              {/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ (Preview Grid) */}
                                              {assetReg.images && assetReg.images.length > 0 && (
                                                  <div className="grid grid-cols-3 gap-1">
                                                      {assetReg.images.map((img, imgI) => (
                                                          <div key={imgI} className="relative group w-full h-12 bg-gray-100 rounded border overflow-hidden">
                                                              <img src={img.base64} className="w-full h-full object-cover"/>
                                                              <button onClick={() => handleRemoveReceiveImage(idx, imgI, assetIdx)} className="absolute top-0 right-0 bg-red-500 text-white p-0.5 rounded-bl opacity-0 group-hover:opacity-100 transition-all hover:scale-110" title="‡∏•‡∏ö‡∏£‡∏π‡∏õ">
                                                                  <X size={10} strokeWidth={3}/>
                                                              </button>
                                                          </div>
                                                      ))}
                                                  </div>
                                              )}
                                          </div>
                                      </div>
                                      </div>
                                  </div>
                              ))}
                          </div>
                      </div>
                  )}
              </div>
          ))}
          </div>
      </div>

      {/* FOOTER */}
      <div className="p-5 border-t bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-10">
           {receiveItems.some(i => i.receivedQty < (i.qty - i.receivedSoFar)) && (
               <div className="mb-4 bg-orange-50 p-3 rounded-lg border border-orange-200 flex items-start gap-3">
                   <div className="pt-0.5"><input type="checkbox" className="w-4 h-4 text-orange-600 rounded focus:ring-orange-500 cursor-pointer" checked={isForceClose} onChange={(e) => setIsForceClose(e.target.checked)}/></div>
                   <div>
                       <label className="block text-sm font-bold text-orange-800 cursor-pointer" onClick={() => setIsForceClose(!isForceClose)}>‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (Force Close)</label>
                       <p className="text-xs text-orange-600 mt-1">‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡∏≠‡∏á‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß</p>
                   </div>
               </div>
           )}
           <div className="flex gap-3">
             <button onClick={() => setShowReceiveGoodsModal(false)} className="flex-1 py-3 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
             <button onClick={handleConfirmReceive} className="flex-1 py-3 bg-teal-600 text-white rounded-xl font-bold hover:bg-teal-700 shadow-md shadow-teal-200 transition-all transform hover:scale-[1.01]">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</button>
           </div>
       </div>
    </div>
  </div>
)}


{showAddInvModal && (
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm animate-in fade-in">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <datalist id="existing-inventory">
                {[...new Set(inventory.map(i => i.name))].map((name, i) => (
                    <option key={i} value={name}/>
                ))}
            </datalist>

            <datalist id="supplier-list-options-add-inv">
                {[...new Set(invLogs.map(l => l.supplier).filter(s => s))].map((s, i) => (
                    <option key={i} value={s} />
                ))}
            </datalist>
                
                {/* Header */}
                <div className="px-6 py-4 border-b bg-green-50 flex justify-between items-center sticky top-0 z-10">
                    <h3 className="font-bold text-lg text-green-800 flex items-center gap-2"><Plus className="w-5 h-5"/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (Inventory)</h3>
                    <button onClick={() => setShowAddInvModal(false)} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-green-100 transition-colors">
                        <X className="w-6 h-6"/>
                    </button>
                </div>

                <div className="p-6 overflow-y-auto bg-slate-50 space-y-5">

                {/* Project Selection */}
                    <div>
                        <label className="block text-sm font-bold text-gray-700 mb-1.5">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project)</label>
                        <select 
    className="w-full p-2.5 border rounded-xl text-sm bg-white" 
    value={newStockItem.project || ''} 
    onChange={e => setNewStockItem({...newStockItem, project: e.target.value})}
>
    <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
    {/* ‚≠ê ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (16)" */}
    {projects.filter(p => hasPermission(16, p.name)).map(p => (
        <option key={p.id} value={p.name}>{p.name}</option>
    ))}
</select>
                    </div>
                    
                    {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Type Selection) */}
                    <div className="bg-white p-1 rounded-xl border border-gray-200 flex shadow-sm">
                        <button 
                            onClick={() => setNewStockItem({...newStockItem, stockType: 'System'})} 
                            className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${(!newStockItem.stockType || newStockItem.stockType === 'System') ? 'bg-blue-50 text-blue-700 shadow-sm border border-blue-100' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'}`}
                        >
                            ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                        <button 
                            onClick={() => setNewStockItem({...newStockItem, stockType: 'NonSystem'})} 
                            className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${newStockItem.stockType === 'NonSystem' ? 'bg-orange-50 text-orange-700 shadow-sm border border-orange-100' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'}`}
                        >
                            ‡∏Ç‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </div>




{/* ‚≠ê‚≠ê [1] ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (ID + Auto Gen) ‚≠ê‚≠ê */}
<div className="flex flex-col gap-1 mb-2">
    <div className="flex justify-between items-center">
        <label className="text-sm font-bold text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏ (Material Code)</label>
        <label className="flex items-center gap-1.5 cursor-pointer bg-green-50 px-2 py-0.5 rounded border border-green-100">
            <input 
                type="checkbox" 
                className="accent-green-600 w-3.5 h-3.5" 
                checked={newStockItem.isAutoId} 
                onChange={(e) => {
                    // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡πä‡∏Å Auto ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤, ‡∏ñ‡πâ‡∏≤‡∏õ‡∏•‡∏î ‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    setNewStockItem({...newStockItem, isAutoId: e.target.checked, id: e.target.checked ? '' : newStockItem.id});
                }}
            />
            <span className="text-xs font-bold text-green-700">Auto Gen</span>
        </label>
    </div>
    <input 
        type="text" 
        className={`w-full p-2.5 border rounded-xl text-sm font-mono ${newStockItem.isAutoId ? 'bg-gray-100 text-gray-400' : 'bg-white text-gray-800 focus:ring-2 focus:ring-green-500'}`}
        placeholder={newStockItem.isAutoId ? "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (INV-xxx)" : "‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."} 
        value={newStockItem.id} 
        disabled={newStockItem.isAutoId}
        onChange={e => setNewStockItem({...newStockItem, id: e.target.value})} 
    />
</div>

{/* ‚≠ê‚≠ê [2] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Name) ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚≠ê‚≠ê */}
<div>
    <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
    <input 
        type="text" 
        list="existing-inventory"
        className="w-full p-2.5 border rounded-xl text-sm focus:ring-2 focus:ring-green-500 outline-none" 
        value={newStockItem.name} 
        onChange={e => {
    const val = e.target.value;
    let updates = { name: val };
    
    // Check Existing
    if (newStockItem.project) {
        const existing = inventory.find(i => i.name === val && i.project === newStockItem.project);
        if (existing) {
            // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏™‡∏±‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á
            updates.id = getDisplayId(existing.id); 
            updates.isAutoId = false;
            updates.unit = existing.unit;
            updates.price = existing.price;
        }
    }
    
    setNewStockItem(prev => ({...prev, ...updates}));
}}
        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." 
        autoFocus
    />
</div>


                    {/* Qty & Unit */}
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                            <input type="number" min="0" className="w-full p-2.5 border rounded-xl text-sm" value={newStockItem.qty} onChange={e => setNewStockItem({...newStockItem, qty: parseInt(e.target.value)||0})}/>
                        </div>

                      <div>
                        <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Supplier)</label>
                        <input 
                type="text" 
                list="supplier-list-options-add-inv" // ‚≠ê ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö ID ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô
                className="w-full p-2.5 border rounded-xl text-sm" 
                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)..."
                value={newStockItem.supplier || ''} 
                onChange={e => setNewStockItem({...newStockItem, supplier: e.target.value})}
            />
                    </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label>
                            <select className="w-full p-2.5 border rounded-xl text-sm bg-white" value={newStockItem.unit} onChange={e => setNewStockItem({...newStockItem, unit: e.target.value})}>
                                {ITEM_UNITS.map(u => <option key={u} value={u}>{u}</option>)}
                            </select>
                        </div>
                    </div>

                    {/* Min Stock & Price */}
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1.5">Min Stock (‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠)</label>
                            <input type="number" min="0" className="w-full p-2.5 border rounded-xl text-sm" value={newStockItem.minStock} onChange={e => setNewStockItem({...newStockItem, minStock: parseInt(e.target.value)||0})}/>
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" min="0" className="w-full p-2.5 border rounded-xl text-sm" value={newStockItem.price} onChange={e => setNewStockItem({...newStockItem, price: parseFloat(e.target.value)||0})}/>
                        </div>
                    </div>

                   <div>
    <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ({newStockItem.images ? newStockItem.images.length : 0})</label>
    <div className="flex gap-2">
        {/* ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏° */}
        <label className="flex-1 cursor-pointer flex flex-col items-center justify-center h-16 border-2 border-dashed border-green-300 bg-green-50 rounded-xl hover:bg-green-100 transition-colors text-green-700 group">
            <ImageIcon className="w-5 h-5 mb-1 group-hover:scale-110 transition-transform"/>
            <span className="text-[10px] font-bold">‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°</span>
            <input type="file" multiple accept="image/*" className="hidden" onChange={handleStockImageSelect}/>
        </label>
        {/* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á */}
        <label className="flex-1 cursor-pointer flex flex-col items-center justify-center h-16 border-2 border-dashed border-teal-400 bg-teal-50 rounded-xl hover:bg-teal-100 transition-colors text-teal-700 group">
            <Camera className="w-5 h-5 mb-1 group-hover:scale-110 transition-transform"/>
            <span className="text-[10px] font-bold">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</span>
            <input type="file" multiple accept="image/*" capture="environment" className="hidden" onChange={handleStockImageSelect}/>
        </label>
    </div>
</div>

                    {/* Image Preview Grid */}
                    {newStockItem.images && newStockItem.images.length > 0 && (
                        <div className="grid grid-cols-4 gap-2">
                            {newStockItem.images.map((img, idx) => (
                                <div key={idx} className="relative group w-full h-20 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden">
                                    <img src={img.base64} alt="preview" className="w-full h-full object-cover" />
                                    {/* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö */}
                                    <button 
                                        onClick={() => handleRemoveStockImage(idx)}
                                        className="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md opacity-0 group-hover:opacity-100 transition-all hover:bg-red-600 hover:scale-110"
                                        title="‡∏•‡∏ö‡∏£‡∏π‡∏õ"
                                    >
                                        <X size={14} strokeWidth={3}/>
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Note */}
                    <div>
                         <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                         <textarea className="w-full p-2.5 border rounded-xl text-sm" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..." value={newStockItem.note || ''} onChange={e => setNewStockItem({...newStockItem, note: e.target.value})}></textarea>
                    </div>

                </div>

                {/* Footer Buttons */}
                <div className="p-5 border-t border-gray-100 bg-white flex gap-3">
                    <button 
                        onClick={() => setShowAddInvModal(false)} 
                        className="flex-1 py-3 border border-gray-300 rounded-xl text-gray-600 font-bold hover:bg-gray-50 transition-colors"
                    >
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button 
    onClick={() => {
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ)
        if (!newStockItem.name || !newStockItem.unit) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏ä‡∏∑‡πà‡∏≠, ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö)', 'error');
            return;
        }

        // ‚≠ê 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"
        if (!newStockItem.project) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project)', 'error');
            return;
        }

        // 3. ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        handleAddNewProduct();
    }} 
    className="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95"
>
    <Save className="w-5 h-5"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
</button>
                </div>
            </div>
        </div>
      )}


{showAssetModal && (
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm animate-in fade-in">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                
                <datalist id="existing-assets">{[...new Set(assets.map(a => a.name))].map((name, i) => <option key={i} value={name}/>)}</datalist>
                {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° Datalist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ */}
                <datalist id="user-list-options">
                    {allUsers.map((u, i) => (
                        <option key={i} value={`${u.firstName} ${u.lastName}`}>{u.empId}</option>
                    ))}
                </datalist>

                <datalist id="supplier-list-options-add-asset">
                {[...new Set(invLogs.map(l => l.supplier).filter(s => s))].map((s, i) => (
                    <option key={i} value={s} />
                ))}
            </datalist>

                {/* Header */}
                <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                    <h3 className="font-bold text-lg text-indigo-800 flex items-center gap-2"><Plus className="w-5 h-5"/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                    <button type="button" onClick={() => setShowAssetModal(false)} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100" title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                
                <div className="p-6 overflow-y-auto bg-slate-50 space-y-5">
{/* Project Selection */}
                    <div>
                        <label className="block text-sm font-bold text-gray-700 mb-1.5">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project)</label>
                        <select 
    className="w-full p-2.5 border rounded-xl text-sm bg-white" 
    value={newAssetItem.project || ''} 
    onChange={e => setNewAssetItem({...newAssetItem, project: e.target.value})}
>
    <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
    {/* ‚≠ê ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (19)" */}
    {projects.filter(p => hasPermission(19, p.name)).map(p => (
        <option key={p.id} value={p.name}>{p.name}</option>
    ))}
</select>
                    </div>

                    {/* Owner Type */}
                    <div className="bg-white p-1 rounded-lg border border-gray-200 flex shadow-sm">
                        <button onClick={() => setNewAssetItem({...newAssetItem, ownerType: 'Company'})} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${newAssetItem.ownerType === 'Company' ? 'bg-indigo-50 text-indigo-700 shadow-sm' : 'text-gray-500'}`}>‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</button>
                        <button onClick={() => setNewAssetItem({...newAssetItem, ownerType: 'Rent'})} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${newAssetItem.ownerType === 'Rent' ? 'bg-orange-50 text-orange-700 shadow-sm' : 'text-gray-500'}`}>‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡πà‡∏≤</button>
                    </div>

                    {/* ID */}
                    <div>
                        <div className="flex justify-between items-center mb-1.5">
                            <label className="text-sm font-bold text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Asset ID)</label>
                            <label className="flex items-center gap-1.5 cursor-pointer bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100"><input type="checkbox" className="accent-indigo-600 w-3.5 h-3.5" checked={newAssetItem.isAutoId} onChange={(e) => setNewAssetItem({...newAssetItem, isAutoId: e.target.checked, id: e.target.checked ? '' : newAssetItem.id})}/><span className="text-xs font-bold text-indigo-700">Auto Gen</span></label>
                        </div>
                        <input type="text" className="w-full p-2.5 border rounded-xl font-mono text-sm" placeholder={newAssetItem.isAutoId ? "Auto Gen..." : "‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™ ‡πÄ‡∏ä‡πà‡∏ô AST-001"} value={newAssetItem.id} disabled={newAssetItem.isAutoId} onChange={e => setNewAssetItem({...newAssetItem, id: e.target.value})} />
                    </div>

                    {/* Name & Serial */}
                    <div className="space-y-3">
                        <div><label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Name)</label><input type="text" list="existing-assets" className="w-full p-2.5 border rounded-xl text-sm" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô..." value={newAssetItem.name} onChange={e => setNewAssetItem({...newAssetItem, name: e.target.value})}/></div>
                        <div><label className="block text-sm font-bold text-gray-700 mb-1.5">Serial Number (S/N)</label><input type="text" className="w-full p-2.5 border rounded-xl text-sm" value={newAssetItem.serial} onChange={e => setNewAssetItem({...newAssetItem, serial: e.target.value})}/></div>
                    </div>

                    <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Supplier)</label>
                            <input 
                type="text" 
                list="supplier-list-options-add-asset" // ‚≠ê ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö ID ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô
                className="w-full p-2.5 border rounded-xl text-sm" 
                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)..."
                value={newAssetItem.supplier || ''} 
                onChange={e => setNewAssetItem({...newAssetItem, supplier: e.target.value})}
            />
                        </div>

                    {/* Price & Rent Details */}
                    <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                        {newAssetItem.ownerType === 'Company' ? (
                            <div><label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠</label><input type="number" className="w-full p-2.5 border rounded-xl text-sm" value={newAssetItem.price} onChange={e => setNewAssetItem({...newAssetItem, price: parseFloat(e.target.value)||0})}/></div>
                        ) : (
                            <>
                                <div className="grid grid-cols-2 gap-3 mb-3">
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ä‡πà‡∏≤</label><input type="number" className="w-full p-2.5 border rounded-xl text-sm" value={newAssetItem.rentalPrice} onChange={e => setNewAssetItem({...newAssetItem, rentalPrice: parseFloat(e.target.value)||0})}/></div>
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label><select className="w-full p-2.5 border rounded-xl text-sm bg-gray-50" value={newAssetItem.rentalUnit} onChange={e => setNewAssetItem({...newAssetItem, rentalUnit: e.target.value})}><option value="Day">‡∏ö‡∏≤‡∏ó / ‡∏ß‡∏±‡∏ô</option><option value="Month">‡∏ö‡∏≤‡∏ó / ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option><option value="Year">‡∏ö‡∏≤‡∏ó / ‡∏õ‡∏µ</option></select></div>
                                </div>
                                <div className="grid grid-cols-2 gap-3 pt-3 border-t border-dashed">
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label><input type="date" className="w-full p-2.5 border rounded-xl text-sm" value={newAssetItem.rentalStart || ''} onChange={e => setNewAssetItem({...newAssetItem, rentalStart: e.target.value})}/></div>
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input type="date" className="w-full p-2.5 border rounded-xl text-sm" value={newAssetItem.rentalEnd || ''} onChange={e => setNewAssetItem({...newAssetItem, rentalEnd: e.target.value})}/></div>
                                </div>
                            </>
                        )}
                    </div>

                    {/* Status & Images */}
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status)</label>
                            <select className="w-full p-2.5 border border-gray-300 rounded-xl text-sm bg-white" value={newAssetItem.status} onChange={e => setNewAssetItem({...newAssetItem, status: e.target.value})}>
                                <option value="Available">‡∏ß‡πà‡∏≤‡∏á (Available)</option>
                                <option value="Lost">‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢ (Lost)</option>
                                <option value="Damaged">‡∏ä‡∏≥‡∏£‡∏∏‡∏î (Damaged)</option>
                                <option value="Borrowed">‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏° (Borrowed)</option>
                            </select>
                        </div>
                        <div>
    <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ({newAssetItem.images.length})</label>
    <div className="flex gap-2">
        {/* ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏° */}
        <label className="flex-1 cursor-pointer flex flex-col items-center justify-center h-14 border-2 border-dashed border-indigo-300 bg-indigo-50 rounded-xl hover:bg-indigo-100 text-indigo-600 transition-colors group">
            <ImageIcon className="w-4 h-4 mb-0.5 group-hover:scale-110 transition-transform"/>
            <span className="text-[10px] font-bold">‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°</span>
            <input type="file" multiple accept="image/*" className="hidden" onChange={(e) => handleAssetImageSelect(e, false)}/>
        </label>
        {/* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á */}
        <label className="flex-1 cursor-pointer flex flex-col items-center justify-center h-14 border-2 border-dashed border-blue-400 bg-blue-50 rounded-xl hover:bg-blue-100 text-blue-600 transition-colors group">
            <Camera className="w-4 h-4 mb-0.5 group-hover:scale-110 transition-transform"/>
            <span className="text-[10px] font-bold">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</span>
            <input type="file" multiple accept="image/*" capture="environment" className="hidden" onChange={(e) => handleAssetImageSelect(e, false)}/>
        </label>
    </div>
</div>
                        
                        
                        {/* ‚≠ê Show Holder input only when 'Borrowed' */}
                        {newAssetItem.status === 'Borrowed' && (
                            <div className="col-span-2 animate-in fade-in slide-in-from-top-1">
                                <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏° (Holder) <span className="text-red-500">*</span></label>
                                <input 
                                    type="text" 
                                    list="user-list-options" 
                                    className="w-full p-2.5 border border-orange-300 bg-orange-50 rounded-xl text-sm focus:ring-2 focus:ring-orange-500 text-orange-900 placeholder-orange-300" 
                                    placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." 
                                    value={newAssetItem.holder || ''} 
                                    onChange={e => setNewAssetItem({...newAssetItem, holder: e.target.value})}
                                    autoFocus
                                />
                                <p className="text-[10px] text-orange-600 mt-1">* ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                            </div>
                        )}
                    </div>

                    {/* Image Previews */}
                    {newAssetItem.images.length > 0 && (
                        <div className="grid grid-cols-4 gap-2">
                            {newAssetItem.images.map((img, idx) => (
                                <div key={idx} className="relative group w-full h-20 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden">
                                    <img src={img.base64} alt="preview" className="w-full h-full object-cover" />
                                    <button 
                                        onClick={() => handleRemoveAssetImage(idx, false)}
                                        className="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md opacity-0 group-hover:opacity-100 transition-all hover:bg-red-600 hover:scale-110"
                                        title="‡∏•‡∏ö‡∏£‡∏π‡∏õ"
                                    >
                                        <X size={14} strokeWidth={3}/>
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}

                    <div>
                         <label className="block text-sm font-bold text-gray-700 mb-1.5">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                         <textarea className="w-full p-2.5 border rounded-xl text-sm" rows="2" value={newAssetItem.note} onChange={e => setNewAssetItem({...newAssetItem, note: e.target.value})}></textarea>
                    </div>
                </div>

                <div className="p-5 border-t border-gray-100 bg-white flex gap-3">
                    <button onClick={() => setShowAssetModal(false)} className="flex-1 py-3 border border-gray-300 rounded-xl text-gray-600 font-bold hover:bg-gray-50 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button 
    onClick={() => {
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        if (!newAssetItem.name) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô', 'error');
            return;
        }

        // ‚≠ê 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"
        if (!newAssetItem.project) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project)', 'error');
            return;
        }

        // 3. ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        handleAddAsset();
    }} 
    className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95"
>
    <Save className="w-5 h-5"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
</button>
                </div>
            </div>
        </div>
      )}


{/* --- ITEM DETAIL & HISTORY MODAL (FIXED CLOSE BUTTON & REF LINK) --- */}
      {showItemDetailModal && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[150] p-4 backdrop-blur-sm animate-in fade-in">
             <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden animate-in zoom-in-95 relative">
                
                {/* --- HEADER (FIXED: Added Close Button) --- */}
                <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-20">
                    <div className="flex items-center gap-2">
                        <div className="bg-blue-50 p-2 rounded-lg text-blue-600">
                            <History className="w-5 h-5"/>
                        </div>
                        <h3 className="font-bold text-lg text-gray-800">
                            {viewingItem ? `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: ${viewingItem.name}` : `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏° (All Logs)`}
                        </h3>
                    </div>
                    
                   

<div className="flex items-center gap-2">
    {/* ‚≠ê ‡∏õ‡∏∏‡πà‡∏° Export CSV ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */}
    {viewingItem && (
        <button 
            onClick={handleExportItemHistory}
            className="flex items-center gap-1 bg-green-50 text-green-700 border border-green-200 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-green-100 transition-colors mr-2"
            title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô CSV"
        >
            <Download className="w-4 h-4"/> Export History
        </button>
    )}

    {/* ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡πÄ‡∏î‡∏¥‡∏° */}
    <button 
        onClick={() => setShowItemDetailModal(false)} 
        className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
        title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á"
    >
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
</div>
                </div>
                
                <div id="history-modal-scroll" className="flex-1 overflow-y-auto bg-slate-50 scroll-smooth">
                    
{viewingItem && (
    <div className="p-6 pb-0">
        <div className="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm relative">
            
            {/* ‚≠ê‚≠ê‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] Action Buttons: ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ö Summary (isSummary = true) ‚≠ê‚≠ê‚≠ê */}
            {!viewingItem.isSummary && (
                <div className="absolute top-6 right-6 flex gap-2">
                    
                    {/* (Code ‡∏õ‡∏∏‡πà‡∏° Snooze / Disable Alert / Enable Alert / ‡∏•‡∏ö / ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ô‡∏µ‡πâ) */}
                    
                    {/* ... (Start: Copy ‡πÑ‡∏™‡πâ‡πÉ‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏™‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ div ‡∏ô‡∏µ‡πâ) ... */}
                    {(() => {
                        const isSnoozed = viewingItem.snoozeUntil && new Date(viewingItem.snoozeUntil) > new Date();
                        return (
                            <>
                                {/* 1. ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Alert */}
                                {viewingItem.isOverdue && viewingItem.alertType !== 'expired' && hasPermission(17) && (
                                    <>
                                        <button 
                                            onClick={async () => {
                                                setIsLoading(true);
                                                try {
                                                    const nextWeek = new Date();
                                                    nextWeek.setDate(nextWeek.getDate() + 7);
                                                    const snoozeDateStr = nextWeek.toISOString().split('T')[0];
                                                    const updatedAsset = { ...viewingItem, snoozeUntil: snoozeDateStr };
                                                    await new Promise(r => google.script.run.withSuccessHandler(r).syncAsset(updatedAsset));
                                                    await addInvLog('Snooze Alert', updatedAsset.name, 'Update', `‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á ${snoozeDateStr}`, [], null, updatedAsset.id);
                                                    setAssets(prev => prev.map(a => a.id === updatedAsset.id ? { ...updatedAsset, alertType: null, isOverdue: false } : a));
                                                    setViewingItem({ ...updatedAsset, alertType: null, isOverdue: false });
                                                    showToast(`‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô 7 ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
                                                } catch (err) { console.error(err); showToast('Error: ' + err.message, 'error'); } finally { setIsLoading(false); }
                                            }}
                                            className="bg-orange-50 text-orange-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-orange-100 border border-orange-200 flex items-center gap-1 shadow-sm"
                                            title="‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å 7 ‡∏ß‡∏±‡∏ô"
                                        >
                                            <Clock className="w-3 h-3"/> ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô 7 ‡∏ß‡∏±‡∏ô
                                        </button>
                                        <button 
                                            onClick={async () => {
                                                if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô "‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ? \n(‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏µ‡∏Å ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏≤‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà)')) return;
                                                setIsLoading(true);
                                                try {
                                                    const foreverDateStr = '9999-12-31';
                                                    const updatedAsset = { ...viewingItem, snoozeUntil: foreverDateStr };
                                                    await new Promise(r => google.script.run.withSuccessHandler(r).syncAsset(updatedAsset));
                                                    await addInvLog('Disable Alert', updatedAsset.name, 'Update', `‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏≤‡∏ß‡∏£`, [], null, updatedAsset.id);
                                                    setAssets(prev => prev.map(a => a.id === updatedAsset.id ? { ...updatedAsset, alertType: null, isOverdue: false } : a));
                                                    setViewingItem({ ...updatedAsset, alertType: null, isOverdue: false });
                                                    showToast(`‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
                                                } catch (err) { console.error(err); showToast('Error: ' + err.message, 'error'); } finally { setIsLoading(false); }
                                            }}
                                            className="bg-gray-100 text-gray-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-gray-200 border border-gray-300 flex items-center gap-1 shadow-sm"
                                            title="‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏µ‡∏Å"
                                        >
                                            <BellOff className="w-3 h-3"/> ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                                        </button>
                                    </>
                                )}

                                {/* 2. ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î Alert ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ */}
                                {isSnoozed && hasPermission(17) && (
                                    <button 
                                        onClick={async () => {
                                            if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ "‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô" ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á?')) return;
                                            setIsLoading(true);
                                            try {
                                                const updatedAsset = { ...viewingItem, snoozeUntil: '' };
                                                await new Promise(r => google.script.run.withSuccessHandler(r).syncAsset(updatedAsset));
                                                await addInvLog('Enable Alert', updatedAsset.name, 'Update', `‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`, [], null, updatedAsset.id);
                                                const today = new Date(); today.setHours(0,0,0,0);
                                                let isNowOverdue = false;
                                                if (updatedAsset.status === 'Borrowed' && updatedAsset.lastUpdated) {
                                                    const borrowDate = parseThaiDate(updatedAsset.lastUpdated);
                                                    if (borrowDate) {
                                                        const diff = Math.ceil(Math.abs(today - borrowDate) / (86400000));
                                                        if (diff > 7) isNowOverdue = true;
                                                    }
                                                }
                                                setAssets(prev => prev.map(a => a.id === updatedAsset.id ? { ...updatedAsset, snoozeUntil: '', isOverdue: isNowOverdue } : a));
                                                setViewingItem({ ...updatedAsset, snoozeUntil: '', isOverdue: isNowOverdue });
                                                showToast(`‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
                                            } catch (err) { console.error(err); showToast('Error: ' + err.message, 'error'); } finally { setIsLoading(false); }
                                        }}
                                        className="bg-purple-50 text-purple-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-purple-100 border border-purple-200 flex items-center gap-1 shadow-sm"
                                    >
                                        <Bell className="w-3 h-3"/> ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                                    </button>
                                )}
                            </>
                        );
                    })()}
                    
                    {/* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö */}
                    {((viewingItem.serial !== undefined && hasPermission(21)) || 
                      (viewingItem.serial === undefined && hasPermission(18))) && (
                        <button 
                          onClick={() => {
                            if (viewingItem.serial !== undefined) handleDeleteAssets([viewingItem.id]);
                            else handleDeleteInventory([viewingItem.id]);
                          }}
                          className="bg-white text-red-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-red-50 border border-red-200 flex items-center gap-1"
                        >
                          <Trash2 className="w-3 h-3"/> ‡∏•‡∏ö (Delete)
                        </button>
                    )}

                    {/* ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô */}
                    {hasPermission(25) && viewingItem.status === 'Borrowed' && (
                        <button onClick={() => { setShowItemDetailModal(false); initiateReturnAsset(viewingItem); }} className="bg-teal-50 text-teal-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-teal-100 border border-teal-200">‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</button>
                    )}
                    
                    {/* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */}
                    {((viewingItem.serial !== undefined && hasPermission(20)) || 
                      (viewingItem.serial === undefined && hasPermission(17))) && (
                        <button onClick={() => { 
                            setShowItemDetailModal(false);
                            if (viewingItem.serial !== undefined) {
                                setEditingAssetItem({...viewingItem, originalId: viewingItem.id, newImages: []});
                                setShowEditAssetModal(true); 
                            } else {
                                setEditingStockItem({
                                    ...viewingItem, 
                                    originalId: viewingItem.id, 
                                    originalName: viewingItem.name,
                                    originalProject: viewingItem.project,
                                    newImages: []
                                });
                                setShowEditInvModal(true);
                            }
                        }} className="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-100 border border-blue-200">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    )}
                                </div>
                                )}

                                <h4 className="font-bold text-gray-800 border-b pb-2 mb-4 flex items-center gap-2"><Info className="w-4 h-4 text-blue-600"/> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</h4>

<div className="mb-6 flex justify-center">
    <div 
        className="w-full max-w-sm h-64 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden relative cursor-pointer hover:border-blue-400 hover:shadow-lg transition-all group"
        onClick={(e) => {
            const images = getItemLatestImages(viewingItem);
            if (images.length > 0) {
                e.stopPropagation();
                setViewingAttachments({ attachments: images });
            }
        }}
        title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
    >
        {(() => {
            const img = getItemLatestImage(viewingItem);
            const allImages = getItemLatestImages(viewingItem);

            if (img) {
                return (
                    <>
                        {/* ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å */}
                        <img 
                            src={getDriveImageUrl(img.url || img.base64)} 
                            alt="preview" 
                            className="w-full h-full object-contain group-hover:scale-105 transition-transform duration-500" 
                            onError={(e) => e.target.style.display = 'none'}
                        />
                        
                        {/* Overlay ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ */}
                        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center">
                             <div className="bg-white/90 backdrop-blur text-gray-800 px-4 py-2 rounded-full font-bold text-sm shadow-xl opacity-0 group-hover:opacity-100 transform translate-y-4 group-hover:translate-y-0 transition-all flex items-center gap-2">
                                <Eye size={16} className="text-blue-600"/> ‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏≤‡∏¢
                             </div>
                        </div>

                        {/* Badge ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1) */}
                        {allImages.length > 1 && (
                            <div className="absolute bottom-3 right-3 bg-black/70 text-white px-3 py-1.5 text-xs rounded-lg font-bold flex items-center gap-1.5 backdrop-blur-sm shadow-sm">
                                <ImageIcon size={14}/> +{allImages.length - 1} ‡∏£‡∏π‡∏õ
                            </div>
                        )}
                    </>
                );
            } else {
                return (
                    <div className="text-gray-400 flex flex-col items-center gap-2 opacity-50">
                        <div className="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center">
                            <ImageIcon size={32}/>
                        </div>
                        <span className="text-sm font-bold">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
                    </div>
                );
            }
        })()}
    </div>
</div>

                                <div className="grid grid-cols-2 md:grid-cols-4 gap-y-6 gap-x-8 text-sm">
                                    <div>
    <span className="text-gray-500 block text-xs mb-1">‡∏£‡∏´‡∏±‡∏™ (ID)</span>
    {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ getDisplayId ‡∏Ñ‡∏£‡∏≠‡∏ö */}
    <span className="font-mono font-bold text-gray-700">{getDisplayId(viewingItem.id)}</span>
</div>
<div className="col-span-2 md:col-span-1">
    <span className="text-gray-500 block text-xs mb-1">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project)</span>
    <span className="font-bold text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded">
        {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Summary ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á "‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£" */}
        {viewingItem.isSummary && globalProjectFilter === 'All' 
            ? '‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£' 
            : (viewingItem.project || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')}
    </span>
</div>

                                    <div><span className="text-gray-500 block text-xs mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span><span className="font-bold text-gray-900">{viewingItem.name}</span></div>
                                    
                                    {viewingItem.serial !== undefined ? (
                                        // ... (Asset Fields ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
                                       <> 
        {/* 1. ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (‡∏ã‡∏∑‡πâ‡∏≠/‡πÄ‡∏ä‡πà‡∏≤) */}
        <div>
            <span className="text-gray-500 block text-xs mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</span>
            <span className={`px-2 py-0.5 rounded text-xs font-bold border ${viewingItem.ownerType === 'Rent' ? 'bg-orange-50 text-orange-700 border-orange-200' : 'bg-blue-50 text-blue-700 border-blue-200'}`}>
                {viewingItem.ownerType === 'Rent' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤ (Rent)' : '‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (Company)'}
            </span>
        </div>

        <div><span className="text-gray-500 block text-xs mb-1">Serial Number</span><span className="font-mono text-gray-700">{viewingItem.serial || '-'}</span></div>
        
        <div>
            <span className="text-gray-500 block text-xs mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
            <span className={`font-bold ${
                viewingItem.status === 'Available' ? 'text-green-600' :
                viewingItem.status === 'Borrowed' ? 'text-orange-600' :
                viewingItem.status === 'Lost' ? 'text-gray-800' : 'text-red-600'
            }`}>
                {ASSET_STATUS_LABELS[viewingItem.status] || viewingItem.status}
            </span>
        </div>

        {/* 2. ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤) */}
        {viewingItem.ownerType === 'Rent' && (
            <div>
                <span className="text-gray-500 block text-xs mb-1">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πà‡∏≤</span>
                <div className="text-sm font-medium flex flex-col">
                    <span className="text-green-700 text-xs flex items-center gap-1">‡πÄ‡∏£‡∏¥‡πà‡∏°: {viewingItem.rentalStart || '-'}</span>
                    <span className="text-red-700 text-xs flex items-center gap-1">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: {viewingItem.rentalEnd || '-'}</span>
                </div>
            </div>
        )}

        {/* 3. ‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó) */}
        <div>
            <span className="text-gray-500 block text-xs mb-1">{viewingItem.ownerType === 'Rent' ? '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ä‡πà‡∏≤' : '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠'}</span>
            <span className="font-medium text-gray-900 font-mono">
                {viewingItem.ownerType === 'Rent' 
                    ? `${(viewingItem.rentalPrice || 0).toLocaleString()} ${RENTAL_UNITS[viewingItem.rentalUnit] || ''}`
                    : `${(viewingItem.price || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó`
                }
            </span>
        </div>

        <div className="col-span-2"><span className="text-gray-500 block text-xs mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</span><span className="text-gray-600">{viewingItem.note || '-'}</span></div>
    </>
) : (
                                        // ‚≠ê Inventory Fields (Updated)
                                        <>
                                            <div><span className="text-gray-500 block text-xs mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Å</span>
    <span className={`px-2 py-0.5 rounded text-xs font-bold ${
        // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Summary (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏ô) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á
        viewingItem.isSummary 
            ? 'bg-purple-100 text-purple-700' 
            : (viewingItem.stockType === 'NonSystem' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700')
    }`}>
        {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Summary ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á "‡∏£‡∏ß‡∏°" ‡πÄ‡∏™‡∏°‡∏≠ */}
        {viewingItem.isSummary
            ? '‡∏£‡∏ß‡∏°' 
            : (viewingItem.stockType === 'NonSystem' ? '‡∏Ç‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö')}
    </span>
</div>
                                            <div><span className="text-gray-500 block text-xs mb-1">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span><span className="font-bold text-blue-600 text-lg">{viewingItem.qty} {viewingItem.unit}</span></div>
                                            <div><span className="text-gray-500 block text-xs mb-1">Min Stock</span><span className="font-medium text-red-600">{viewingItem.minStock}</span></div>
                                            <div><span className="text-gray-500 block text-xs mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</span><span className="font-medium text-gray-700">{viewingItem.price?.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span></div>
                                            <div className="col-span-2"><span className="text-gray-500 block text-xs mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</span><span className="text-gray-600">{viewingItem.note || '-'}</span></div>
                                        </>
                                    )}
                                </div>
                                <div className="text-xs text-gray-400 pt-4 border-t mt-4">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {viewingItem.lastUpdated}</div>
                            </div>
                        </div>
                    )}

{/* --- TOOLBAR --- */}
<div className="px-6 py-4 sticky top-0 z-10 bg-slate-50/95 backdrop-blur-sm border-b border-gray-200 mt-2">
    <div className="flex flex-wrap gap-3 items-center justify-between">
        <h4 className="font-bold text-gray-700 flex items-center gap-2"><History className="w-4 h-4"/> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ({filteredLogs.length})</h4>
        
        <div className="flex items-center gap-2 flex-1 justify-end min-w-[250px]">
            {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏î‡∏π All Logs) */}
            {!viewingItem && (
                <select 
                    className="p-2 border border-gray-300 rounded-lg text-sm bg-white outline-none cursor-pointer focus:ring-2 focus:ring-blue-500 max-w-[150px]"
                    value={globalProjectFilter} // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á state ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞ modal ‡∏Å‡πá‡πÑ‡∏î‡πâ (‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ global ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á)
                    onChange={e => setGlobalProjectFilter(e.target.value)}
                >
                    <option value="All">‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</option>
                    {projects.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                </select>
            )}

            <div className="relative w-48">
                <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                <input type="text" className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none bg-white focus:ring-2 focus:ring-blue-500" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." value={historySearch} onChange={e => setHistorySearch(e.target.value)}/>
            </div>
            
            <select className="p-2 border border-gray-300 rounded-lg text-sm bg-white outline-none cursor-pointer focus:ring-2 focus:ring-blue-500" value={historyActionFilter} onChange={e => setHistoryActionFilter(e.target.value)}>
                <option value="All">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                <option value="Stock In">‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤</option>
                <option value="Withdraw">‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å</option>
                <option value="Borrow">‡∏¢‡∏∑‡∏°</option>
                <option value="Return">‡∏Ñ‡∏∑‡∏ô</option>
                <option value="Add Asset">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</option>
                <option value="Delete Asset">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏•‡∏ö</option>
                <option value="Import Assets">Import (CSV)</option>
            </select>
        </div>
    </div>
</div>

                    {/* --- TABLE --- */}
                    <div className="px-6 pb-6">
                        {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô overflow-hidden ‡πÄ‡∏õ‡πá‡∏ô overflow-x-auto ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */}
                        <div className="bg-white rounded-xl border border-gray-200 overflow-x-auto shadow-sm">
                            {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° min-w-[1000px] ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏û‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ */}
                            <table className="w-full text-sm text-left min-w-[1000px]">
<thead className="bg-gray-100 text-gray-600 border-b">
    <tr>
        {/* Date */}
        <th className="px-4 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleHistorySort('date')}>
            Date <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
        </th>
        
        {/* Image (‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á) */}
        <th className="px-4 py-3 text-center">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
        
        {/* Action */}
        <th className="px-4 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleHistorySort('action')}>
            Action <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
        </th>
        
        {/* Item Info (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤ All Logs) */}
        {!viewingItem && (
            <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleHistorySort('item')}>
                Item Info <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
            </th>
        )}

        {/* Change */}
        <th className="px-4 py-3 text-center cursor-pointer hover:bg-gray-200" onClick={() => handleHistorySort('change')}>
            Change <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
        </th>
        
        {/* Ref Doc */}
        <th className="px-4 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleHistorySort('relatedRequestId')}>
            Ref Doc <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
        </th>
        
        {/* ‚≠ê User (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠) */}
        <th className="px-4 py-3 min-w-[120px] cursor-pointer hover:bg-gray-200" onClick={() => handleHistorySort('by')}>
            User <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
        </th>
        
        {/* Note */}
        <th className="px-4 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleHistorySort('note')}>
            Note <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
        </th>
    </tr>
</thead>
                                <tbody className="divide-y divide-gray-100">
                                    {filteredLogs.map((log, i) => (
                                    <tr key={i} className={`hover:bg-blue-50 transition-colors ${log.action === 'Delete Asset' ? 'bg-red-50/50' : ''}`}>
                                        <td className="px-4 py-3 text-gray-500 text-xs whitespace-nowrap">{log.date}</td>
                                        
                                        <td className="px-4 py-3 text-center">
                                            {log.images && log.images.length > 0 ? (
                                                <button 
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setViewingAttachments({ attachments: log.images }); 
                                                    }}
                                                    className="p-1.5 border rounded-lg hover:shadow-md transition-all group relative bg-white border-gray-200 text-blue-600 hover:border-blue-400"
                                                >
                                                    <ImageIcon className="w-4 h-4"/>
                                                </button>
                                            ) : <span className="text-gray-300">-</span>}
                                        </td>

                                        <td className="px-4 py-3">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                log.action.includes('In') || log.action.includes('Return') || log.action.includes('Add') || log.action.includes('Register') || log.action === 'Restore Asset' ? 'bg-green-100 text-green-700' :
                                                log.action.includes('Out') || log.action.includes('Withdraw') || log.action === 'Delete Asset' ? 'bg-red-100 text-red-700' :
                                                log.action.includes('Borrow') ? 'bg-blue-100 text-blue-700' :
                                                'bg-gray-100 text-gray-700'
                                            }`}>
                                                {log.action === 'Pending PM' ? 'Pending Level 2' : log.action}
                                            </span>
                                        </td>

                                        {!viewingItem && (
                                            <td className="px-6 py-3">
                                                <div className="font-medium text-gray-900">{log.item}</div>
                                                {(() => {
                                                    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ ID ‡∏à‡∏≤‡∏Å Asset ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≤‡∏Å Log (‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
                                                    let displayId = log.assetId;
                                                    if (!displayId) {
                                                        const matchedAsset = assets.find(a => a.name === log.item);
                                                        if (matchedAsset) displayId = matchedAsset.id;
                                                    }
                                                    
                                                    if (displayId) {
                                                        return <div className="text-xs text-gray-500 mt-0.5 font-mono">ID: {displayId}</div>;
                                                    }
                                                    return null;
                                                })()}
                                            </td>
                                        )}

                                        <td className={`px-4 py-3 text-center font-mono font-bold ${log.change === 'Delete' ? 'text-red-600' : 'text-blue-600'}`}>{log.change}</td>
                                        
                                        {/* ‚≠ê REF DOC LINK (FIXED) ‚≠ê */}
                                        <td className="px-4 py-3">
                                            {log.relatedRequestId ? (
                                                <button 
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤ z-index ‡∏Ç‡∏≠‡∏á Modal ‡∏ô‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏û‡∏≠)
                                                        handleOpenRequestDetail(log.relatedRequestId);
                                                    }}
                                                    className="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100 hover:bg-blue-100 hover:underline flex items-center gap-1 cursor-pointer transition-colors"
                                                    title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"
                                                >
                                                    <FileText className="w-3 h-3"/> {log.relatedRequestId}
                                                </button>
                                            ) : <span className="text-gray-300">-</span>}
                                        </td>
                                        
                                        <td className="px-4 py-3 text-gray-600 text-xs">{log.by}</td>
                                        
                                    <td className="px-4 py-3 text-xs">
                                            {log.action === 'Delete Asset' || log.action === 'Delete Inventory' ? (
                                                <div className="flex flex-col gap-1">
                                                    <span className="text-gray-500 italic">Backup Data Saved</span>
{hasPermission(27) && ( // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå 27
    <button 
        onClick={() => {
            if(log.action === 'Delete Asset') handleRestoreAsset(log);
            else handleRestoreInventory(log);
        }}
                                                            className="text-white bg-green-500 hover:bg-green-600 px-2 py-1 rounded w-fit flex items-center gap-1 font-bold shadow-sm text-[10px]"
                                                        >
                                                            <RotateCcw className="w-3 h-3"/> ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô
                                                        </button>
                                                    )}
                                                </div>
                                            ) : (
    <div className="text-gray-500 whitespace-pre-wrap break-words min-w-[200px]">
        {log.note}
    </div>
)}
                                        </td>
                                    </tr>
                                ))}</tbody>
                            </table>
                            {filteredLogs.length === 0 && <div className="p-12 text-center text-gray-400 flex flex-col items-center"><Search className="w-12 h-12 mb-3 opacity-20"/>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>}
                            
                         

                        </div>
                    </div>

                </div>
                <ModalScrollButtons targetId="history-modal-scroll" />
                {/* ‚≠ê ‡∏õ‡∏∏‡πà‡∏° Load More ‡πÅ‡∏ö‡∏ö‡∏•‡∏≠‡∏¢ (Floating Button) ‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏á */}
          
              <button 
                  onClick={() => {
                      if(!confirm('‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?')) return;
                      setIsLoading(true);
                      google.script.run.withSuccessHandler((logs) => {
                          if (logs) setInvLogs(logs);
                          setIsLoading(false);
                          showToast('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
                      }).getRecentLogs(2000);
                  }}
                  className="absolute bottom-6 left-6 z-[60] bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-600 hover:text-white px-4 py-3 rounded-full shadow-xl transition-all transform hover:scale-105 flex items-center gap-2 font-bold text-xs group no-print"
                  title="‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°"
              >
                  <RefreshCw size={16} className="group-hover:rotate-180 transition-transform duration-500"/> 
                  <span>‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏° (Load More)</span>
              </button>
          
             </div>
          </div>
      )}

      {showRejectModal && (
         <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
             <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                 <h3 className="font-bold text-lg text-red-600 mb-4 flex items-center gap-2"><AlertCircle className="w-5 h-5"/> ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
                 <textarea className="w-full p-3 border border-gray-300 rounded-lg text-sm mb-4 outline-none focus:ring-2 focus:ring-red-500" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥..." value={rejectData.reason} onChange={e => setRejectData({...rejectData, reason: e.target.value})} autoFocus></textarea>
                 <div className="flex gap-3">
                     <button onClick={() => setShowRejectModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                     <button onClick={handleConfirmReject} className="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                 </div>
             </div>
         </div>
      )}

{showDisburseModal && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm animate-in fade-in">
        <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto flex flex-col">
            <h3 className="font-bold text-lg text-teal-700 mb-4 flex items-center gap-2">
                <Package className="w-5 h-5"/> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á/‡πÄ‡∏ö‡∏¥‡∏Å
            </h3>

           {/* ‚≠ê ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡πà‡∏≤‡∏¢ (Updated: ‡πÅ‡∏¢‡∏Å Withdraw/Borrow) */}
            <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 mb-4 text-sm animate-in zoom-in-95">
                <div className="flex justify-between items-center border-b border-slate-200 pb-2 mb-2">
                    <span className="font-bold text-gray-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢ ({disburseItems.length})</span>
                    {(() => {
    const req = requests.find(r => r.id === disburseData.requestId);
    return (
        <span className="text-xs text-gray-500 bg-white px-2 py-0.5 rounded border font-bold">
            {disburseData.requestId}
            {req?.docNumber && <span className="text-teal-600"> | {req.docNumber}</span>}
        </span>
    );
})()}
                </div>
                
       <div className="space-y-4 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar">
                    {disburseItems.map((item, idx) => {
    const req = requests.find(r => r.id === disburseData.requestId);
    const itemForImage = { ...item, id: item.assetId || item.id };

    // ... (‡∏™‡πà‡∏ß‡∏ô ImageBlock ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...
    const ImageBlock = (
        <div 
            className="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0 border overflow-hidden relative cursor-pointer hover:ring-2 hover:ring-blue-400 transition-all shadow-sm"
            onClick={(e) => {
                const images = getItemLatestImages(itemForImage);
                if (images.length > 0) {
                    e.stopPropagation();
                    setViewingAttachments({ attachments: images });
                }
            }}
        >
            {(() => {
                const img = getItemLatestImage(itemForImage);
                const allImages = getItemLatestImages(itemForImage);
                if (img) {
                    return (
                        <>
                            <img src={getDriveImageUrl(img.url || img.base64)} className="w-full h-full object-cover" onError={(e) => e.target.style.display = 'none'} />
                            {allImages.length > 1 && <div className="absolute top-0 left-0 bg-black/60 text-white px-1 text-[9px] rounded-br">+{allImages.length - 1}</div>}
                            <div className="absolute bottom-0 right-0 bg-black/50 text-white p-0.5 rounded-tl-md"><ImageIcon className="w-3 h-3"/></div>
                        </>
                    );
                } else {
                    return <span className="text-[10px] text-gray-400 font-bold">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û</span>;
                }
            })()}
        </div>
    );

// üü¢ ‡∏Å‡∏£‡∏ì‡∏µ 1: Withdraw (‡πÄ‡∏û‡∏¥‡πà‡∏° Checkbox & Reject Input)
    if (req.type === 'Withdraw') {
        // 1. ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏°‡∏≤ (‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö/‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö)
        const itemStockType = item.stockType || req.withdrawStockType || 'System';
        const isNonSystem = itemStockType === 'NonSystem';
        
        // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞ ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
        const totalInput = isNonSystem ? (item.useNon || 0) : (item.useSys || 0);
        const availableQty = isNonSystem ? (item.nonAvailable || 0) : (item.sysAvailable || 0);
        const isMatch = totalInput === item.qty;
        const stockTypeLabel = isNonSystem ? '‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö' : '‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
        
        return (
            <div key={idx} className={`p-3 rounded-lg border shadow-sm flex gap-3 transition-colors ${item.isRejected ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200'}`}>
                {ImageBlock}

                <div className="flex-1 min-w-0">
                    <div className="flex justify-between mb-1">
                        <div className="flex flex-col">
                            <span className={`font-bold ${item.isRejected ? 'text-red-700 decoration-red-400 line-through' : 'text-gray-800'}`}>
                                {item.name} 
                                <span className={`ml-2 text-[10px] px-1.5 py-0.5 rounded border ${isNonSystem ? 'bg-orange-50 text-orange-600 border-orange-200' : 'bg-blue-50 text-blue-600 border-blue-200'}`}>
                                    {stockTypeLabel}
                                </span>
                            </span>
                            {/* Inventory ID Badge */}
                            {(() => {
                                const stockItem = inventory.find(i => i.name === item.name && i.project === req.job && (i.stockType || 'System') === itemStockType);
                                const displayId = stockItem ? getDisplayId(stockItem.id) : null;
                                return displayId ? <span className="text-[10px] text-gray-500 font-mono bg-gray-100 px-1.5 rounded border w-fit mt-0.5">‡∏£‡∏´‡∏±‡∏™: {displayId}</span> : null;
                            })()}
                        </div>
                        <span className="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-600 whitespace-nowrap ml-2 h-fit">‡∏Ç‡∏≠: <b>{item.qty}</b> {item.unit}</span>
                    </div>

                    {/* ‚≠ê Checkbox ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏¥‡∏Å */}
                    <div className="mb-2">
                        <label className="flex items-center gap-2 cursor-pointer w-fit">
                            <input 
                                type="checkbox" 
                                className="w-4 h-4 rounded text-red-600 focus:ring-red-500"
                                checked={item.isRejected}
                                onChange={(e) => {
                                    const n = [...disburseItems];
                                    n[idx].isRejected = e.target.checked;
                                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏¥‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô 0
                                    if(e.target.checked) {
                                        n[idx].useSys = 0;
                                        n[idx].useNon = 0;
                                    }
                                    setDisburseItems(n);
                                }}
                            />
                            <span className="text-xs font-bold text-red-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á / ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</span>
                        </label>
                    </div>

                    {/* ‚≠ê Input ‡∏´‡∏£‡∏∑‡∏≠ Reject Reason */}
                    {item.isRejected ? (
                        <div className="animate-in fade-in">
                            <input 
                                type="text" 
                                className="w-full p-2 border border-red-300 rounded text-xs bg-white text-red-700 placeholder-red-300 outline-none focus:ring-2 focus:ring-red-500"
                                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏¥‡∏Å (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)..."
                                value={item.rejectReason}
                                onChange={(e) => {
                                    const n = [...disburseItems];
                                    n[idx].rejectReason = e.target.value;
                                    setDisburseItems(n);
                                }}
                            />
                        </div>
                    ) : (
                        <>
                            <div className="flex gap-3 items-end">
                                {/* ‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏°‡∏≤ */}
                                <div className="flex-1">
                                    <label className={`text-[10px] font-bold block mb-1 ${totalInput > availableQty ? 'text-red-600' : (isNonSystem ? 'text-orange-600' : 'text-blue-600')}`}>
                                        ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á {stockTypeLabel} (‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏à‡πà‡∏≤‡∏¢: {availableQty})
                                    </label>
                                    <input 
                                        type="number" 
                                        min="0" 
                                        max={availableQty} 
                                        className={`w-1/2 p-1.5 border rounded text-center text-sm font-bold outline-none focus:ring-2 ${totalInput > availableQty ? 'border-red-500 text-red-600 focus:ring-red-200' : 'border-blue-200 text-gray-800 focus:ring-blue-500'}`} 
                                        value={totalInput.toString()} 
                                        onChange={(e) => { 
                                            let val = parseInt(e.target.value); 
                                            if (isNaN(val)) val = 0; 
                                            const newItems = [...disburseItems]; 
                                            
                                            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á property ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                                            if (isNonSystem) {
                                                newItems[idx].useNon = val;
                                                newItems[idx].useSys = 0;
                                            } else {
                                                newItems[idx].useSys = val;
                                                newItems[idx].useNon = 0;
                                            }
                                            setDisburseItems(newItems); 
                                        }} 
                                    />
                                </div>
                            </div>
                            <div className={`mt-2 text-xs font-bold ${isMatch ? 'text-green-600' : 'text-orange-600'}`}>
                                ‡∏£‡∏ß‡∏°‡∏à‡πà‡∏≤‡∏¢: {totalInput} / {item.qty} {!isMatch && '(‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö/‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)'}
                            </div>
                        </>
                    )}
                </div>
            </div>
        );
    }
    
    // üîµ ‡∏Å‡∏£‡∏ì‡∏µ 2: Borrow (‡πÄ‡∏û‡∏¥‡πà‡∏° Checkbox & Reject Input)
    else {
        return (
            <div key={idx} className={`p-3 rounded-lg border shadow-sm flex items-center gap-3 transition-colors ${item.isRejected ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200'}`}>
                {ImageBlock}

                <div className="flex-1">
                    <div className="flex justify-between items-start">
                        <div>
                            <div className={`font-bold ${item.isRejected ? 'text-red-700 decoration-red-400 line-through' : 'text-gray-800'}`}>{item.name}</div>
                            <div className="flex gap-2 mt-1">
                                {item.assetId && <span className="text-[10px] bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded border border-indigo-100 font-mono">ID: {item.assetId}</span>}
                                {item.serial && <span className="text-[10px] bg-slate-50 text-slate-600 px-2 py-0.5 rounded border border-slate-200 font-mono">S/N: {item.serial}</span>}
                            </div>
                        </div>
                        <div className="text-right">
                            <span className="font-bold text-lg text-blue-600">1</span>
                            <span className="text-xs text-gray-500 ml-1">{item.unit || '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á'}</span>
                        </div>
                    </div>

                    {/* ‚≠ê Checkbox ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏° */}
                    <div className="mt-2 pt-2 border-t border-dashed border-gray-200">
                        <label className="flex items-center gap-2 cursor-pointer w-fit mb-2">
                            <input 
                                type="checkbox" 
                                className="w-4 h-4 rounded text-red-600 focus:ring-red-500"
                                checked={item.isRejected}
                                onChange={(e) => {
                                    const n = [...disburseItems];
                                    n[idx].isRejected = e.target.checked;
                                    setDisburseItems(n);
                                }}
                            />
                            <span className="text-xs font-bold text-red-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á / ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°</span>
                        </label>

                        {item.isRejected && (
                            <input 
                                type="text" 
                                className="w-full p-1.5 border border-red-300 rounded text-xs bg-white text-red-700 placeholder-red-300 outline-none focus:ring-2 focus:ring-red-500 animate-in fade-in"
                                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)..."
                                value={item.rejectReason}
                                onChange={(e) => {
                                    const n = [...disburseItems];
                                    n[idx].rejectReason = e.target.value;
                                    setDisburseItems(n);
                                }}
                            />
                        )}
                    </div>
                </div>
            </div>
        );
    }
})}
                </div>

            </div>

            <p className="text-sm text-gray-600 mb-3 font-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</p>
            
            <div className="space-y-4 flex-1">
                {/* Note Input */}
                <textarea 
                    className="w-full p-3 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-teal-500" 
                    rows="2" 
                    placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢ (Optional)..." 
                    value={disburseData.note} 
                    onChange={e => setDisburseData({...disburseData, note: e.target.value})}
                ></textarea>

                {/* Image Upload Section */}
                <div>
                    <label className="text-xs font-bold text-gray-500 mb-2 block">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô/‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö ({disburseData.images?.length || 0})</label>
                    
                    <div className="grid grid-cols-4 gap-2 mb-2">
                        {/* Preview Images */}
                        {disburseData.images && disburseData.images.map((img, idx) => (
                            <div key={idx} className="relative group w-full h-16 bg-gray-100 rounded-lg border overflow-hidden">
                                <img src={img.base64} alt="preview" className="w-full h-full object-cover"/>
                                <button 
                                    onClick={() => handleRemoveDisburseImage(idx)} 
                                    className="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md opacity-0 group-hover:opacity-100 transition-all hover:bg-red-600 hover:scale-110"
                                >
                                    <X size={12} strokeWidth={3}/>
                                </button>
                            </div>
                        ))}
                        
                        {/* Upload Buttons (Album & Camera) */}
<div className="flex gap-3">
    {/* 1. ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏° (‡∏™‡∏µ‡∏ü‡πâ‡∏≤) */}
    <label className="flex-1 cursor-pointer flex flex-col items-center justify-center h-20 border-2 border-dashed border-blue-300 bg-blue-50 rounded-xl hover:bg-blue-100 transition-colors text-blue-600 group">
        <ImageIcon className="w-6 h-6 mb-1 group-hover:scale-110 transition-transform"/>
        <span className="text-xs font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°</span>
        {/* accept="image/*" ‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Gallery ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≤‡∏° */}
        <input type="file" multiple accept="image/*" className="hidden" onChange={handleDisburseImageSelect}/>
    </label>

    {/* 2. ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ (‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß - ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á) */}
    <label className="flex-1 cursor-pointer flex flex-col items-center justify-center h-20 border-2 border-dashed border-teal-300 bg-teal-50 rounded-xl hover:bg-teal-100 transition-colors text-teal-600 group">
        <Camera className="w-6 h-6 mb-1 group-hover:scale-110 transition-transform"/>
        <span className="text-xs font-bold">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span>
        {/* capture="environment" ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á */}
        <input type="file" multiple accept="image/*" capture="environment" className="hidden" onChange={handleDisburseImageSelect}/>
    </label>
</div>

                    </div>
                </div>
            </div>

            <div className="flex gap-3 mt-4">
                <button onClick={() => setShowDisburseModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onClick={handleConfirmDisburse} className="flex-1 py-2 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700 shadow-md">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á</button>
            </div>
        </div>
    </div>
)}


{showEditInvModal && editingStockItem && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[160] p-4 backdrop-blur-sm">
              <div className="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                  
                  <div className="px-6 py-4 border-b bg-white flex justify-between items-center sticky top-0 z-10">
                      <h3 className="font-bold text-lg text-blue-700 flex items-center gap-2"><Edit className="w-5 h-5"/> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                      <button onClick={() => setShowEditInvModal(false)} className="text-gray-400 hover:text-gray-600"><X className="w-5 h-5"/></button>
                  </div>

                  <div className="p-6 overflow-y-auto space-y-4">
                      {/* Type Selection */}
                      <div className="bg-gray-50 p-1 rounded-lg border border-gray-200 flex shadow-sm">
                        <button onClick={() => setEditingStockItem({...editingStockItem, stockType: 'System'})} className={`flex-1 py-1.5 text-sm font-bold rounded-md transition-all ${(!editingStockItem.stockType || editingStockItem.stockType === 'System') ? 'bg-white text-blue-700 shadow-sm' : 'text-gray-500'}`}>‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</button>
                        <button onClick={() => setEditingStockItem({...editingStockItem, stockType: 'NonSystem'})} className={`flex-1 py-1.5 text-sm font-bold rounded-md transition-all ${editingStockItem.stockType === 'NonSystem' ? 'bg-white text-orange-700 shadow-sm' : 'text-gray-500'}`}>‡∏Ç‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                      </div>

                    <div>
    <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</label>
    <input 
        type="text" 
        className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 font-mono text-blue-600 font-bold" 
        // ‚≠ê Value: ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà‡∏£‡∏´‡∏±‡∏™‡∏™‡∏±‡πâ‡∏ô
        value={getDisplayId(editingStockItem.id)} 
        // ‚≠ê OnChange: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏•‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡πÜ (Logic ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∞‡πÑ‡∏õ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á)
        onChange={e => setEditingStockItem({...editingStockItem, id: e.target.value})}
    />
</div>


                      <div><label className="text-xs font-bold text-gray-500 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={editingStockItem.name} onChange={e => setEditingStockItem({...editingStockItem, name: e.target.value})}/></div>
                      
                      <div className="grid grid-cols-2 gap-3">
                        <div><label className="text-xs font-bold text-gray-500 mb-1 block">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Qty)</label><input type="number" className="w-full p-2 border rounded" value={editingStockItem.qty} onChange={e => setEditingStockItem({...editingStockItem, qty: parseInt(e.target.value)||0})}/></div>
                        
                        
                        <div><label className="text-xs font-bold text-gray-500 mb-1 block">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label><select className="w-full p-2 border rounded bg-white" value={editingStockItem.unit} onChange={e => setEditingStockItem({...editingStockItem, unit: e.target.value})}>{ITEM_UNITS.map(u => <option key={u} value={u}>{u}</option>)}</select></div>
                      </div>
                      
                      <div className="grid grid-cols-2 gap-3">
                        <div><label className="text-xs font-bold text-gray-500 mb-1 block">Min Stock</label><input type="number" className="w-full p-2 border rounded" value={editingStockItem.minStock} onChange={e => setEditingStockItem({...editingStockItem, minStock: parseInt(e.target.value)||0})}/></div>
                       
                       
                        <div><label className="text-xs font-bold text-gray-500 mb-1 block">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</label><input type="number" className="w-full p-2 border rounded" value={editingStockItem.price} onChange={e => setEditingStockItem({...editingStockItem, price: parseFloat(e.target.value)||0})}/></div>
                      </div>

{/* Image Upload for Edit (UPDATED: Remove Current Image) */}
<div className="space-y-3">
    
    {/* ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏ô‡∏µ‡πâ) */}
    <div>
         <label className="flex-1 cursor-pointer flex flex-col items-center justify-center h-14 border-2 border-dashed rounded-xl bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors font-bold text-sm group">
             <ImageIcon className="w-4 h-4 mb-0.5 group-hover:scale-110 transition-transform"/>
             <span className="text-[10px]">‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°</span>
             <input type="file" multiple accept="image/*" className="hidden" onChange={(e) => {
                 if(e.target.files) {
                     const files = Array.from(e.target.files);
                     const promises = files.map(file => new Promise(resolve => { const r = new FileReader(); r.onload = (x) => resolve({ base64: x.target.result, file, name: file.name }); r.readAsDataURL(file); }));
                     Promise.all(promises).then(imgs => setEditingStockItem(prev => ({...prev, newImages: [...(prev.newImages || []), ...imgs]})));
                 }
             }}/>
         </label>
         {/* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á */}
         <label className="flex-1 cursor-pointer flex flex-col items-center justify-center h-14 border-2 border-dashed rounded-xl bg-teal-50 text-teal-600 hover:bg-teal-100 transition-colors font-bold text-sm group">
             <Camera className="w-4 h-4 mb-0.5 group-hover:scale-110 transition-transform"/>
             <span className="text-[10px]">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</span>
             <input type="file" multiple accept="image/*" capture="environment" className="hidden" onChange={(e) => {
                 if(e.target.files) {
                     const files = Array.from(e.target.files);
                     const promises = files.map(file => new Promise(resolve => { const r = new FileReader(); r.onload = (x) => resolve({ base64: x.target.result, file, name: file.name }); r.readAsDataURL(file); }));
                     Promise.all(promises).then(imgs => setEditingStockItem(prev => ({...prev, newImages: [...(prev.newImages || []), ...imgs]})));
                 }
             }}/>
         </label>
         {/* Preview New Images */}
         {editingStockItem.newImages && editingStockItem.newImages.length > 0 && (
             <div className="grid grid-cols-4 gap-2 mt-2">
                 {editingStockItem.newImages.map((img, idx) => (
                     <div key={idx} className="relative group w-full h-20 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden">
                         <img src={img.base64} className="w-full h-full object-cover"/>
                         <button 
                            onClick={() => handleRemoveEditStockNewImage(idx)} 
                            className="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md opacity-0 group-hover:opacity-100 transition-all hover:scale-110"
                         >
                            <X size={12}/>
                         </button>
                     </div>
                 ))}
             </div>
         )}
    </div>
</div>

                      <div><label className="text-xs font-bold text-gray-500 mb-1 block">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea className="w-full p-2 border rounded" rows="2" value={editingStockItem.note || ''} onChange={e => setEditingStockItem({...editingStockItem, note: e.target.value})}></textarea></div>
                  </div>

                  <div className="p-5 border-t border-gray-100 bg-white flex gap-3">
                      <button onClick={() => setShowEditInvModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                      <button onClick={handleUpdateInventory} className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                  </div>
              </div>
          </div>
      )}

{showEditAssetModal && editingAssetItem && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[160] p-4 backdrop-blur-sm">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                  
                  <div className="px-6 py-4 border-b bg-white flex justify-between items-center sticky top-0 z-10">
<datalist id="user-list-options">

                    {allUsers.map((u, i) => (

                        <option key={i} value={`${u.firstName} ${u.lastName}`}>{u.empId}</option>

                    ))}

                </datalist>

                      <h3 className="font-bold text-lg text-blue-700 flex items-center gap-2"><Edit className="w-5 h-5"/> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</h3>
                      <button onClick={() => setShowEditAssetModal(false)} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100"><X className="w-5 h-5"/></button>
                  </div>
                  
                  <div className="p-6 overflow-y-auto bg-slate-50 space-y-5">
                       {/* ... (‡∏™‡πà‡∏ß‡∏ô ID, Name, Serial, Price ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ... */}
                       <div className="space-y-3">
                          <div><label className="text-xs font-bold text-gray-500 mb-1 block">‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</label><input type="text" className="w-full p-2.5 border rounded-xl text-sm font-mono bg-white focus:ring-2 focus:ring-blue-500" value={editingAssetItem.id} onChange={e => setEditingAssetItem({...editingAssetItem, id: e.target.value})}/></div>
                          <div><label className="text-xs font-bold text-gray-500 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" className="w-full p-2.5 border rounded-xl text-sm" value={editingAssetItem.name} onChange={e => setEditingAssetItem({...editingAssetItem, name: e.target.value})}/></div>
                          <div><label className="text-xs font-bold text-gray-500 mb-1 block">Serial Number</label><input type="text" className="w-full p-2.5 border rounded-xl text-sm" value={editingAssetItem.serial} onChange={e => setEditingAssetItem({...editingAssetItem, serial: e.target.value})}/></div>
                       </div>
                       
                       <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
{editingAssetItem.ownerType === 'Rent' ? (
    <>
        <div className="grid grid-cols-2 gap-3">
            <div>
                <label className="block text-xs font-bold text-gray-500 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ä‡πà‡∏≤</label>
                <input 
                    type="number" 
                    className="w-full p-2 border rounded-lg text-sm" 
                    value={editingAssetItem.rentalPrice} 
                    onChange={e => setEditingAssetItem({...editingAssetItem, rentalPrice: parseFloat(e.target.value)||0})}
                />
            </div>
            <div>
                <label className="block text-xs font-bold text-gray-500 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                <select 
                    className="w-full p-2 border rounded-lg text-sm" 
                    value={editingAssetItem.rentalUnit} 
                    onChange={e => setEditingAssetItem({...editingAssetItem, rentalUnit: e.target.value})}
                >
                    <option value="Day">‡∏ö‡∏≤‡∏ó / ‡∏ß‡∏±‡∏ô</option>
                    <option value="Month">‡∏ö‡∏≤‡∏ó / ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="Year">‡∏ö‡∏≤‡∏ó / ‡∏õ‡∏µ</option>
                </select>
            </div>
        </div>

        {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Start/End Date) */}
        <div className="grid grid-cols-2 gap-3 mt-3 pt-3 border-t border-dashed border-gray-200">
            <div>
                <label className="block text-xs font-bold text-gray-500 mb-1">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                <input 
                    type="date" 
                    className="w-full p-2 border rounded-lg text-sm" 
                    value={editingAssetItem.rentalStart || ''} 
                    onChange={e => setEditingAssetItem({...editingAssetItem, rentalStart: e.target.value})}
                />
            </div>
            <div>
                <label className="block text-xs font-bold text-gray-500 mb-1">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                <input 
                    type="date" 
                    className="w-full p-2 border rounded-lg text-sm" 
                    value={editingAssetItem.rentalEnd || ''} 
                    onChange={e => setEditingAssetItem({...editingAssetItem, rentalEnd: e.target.value})}
                />
            </div>
        </div>
    </>
) : (
    <div>
        <label className="block text-xs font-bold text-gray-500 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠</label>
        <input 
            type="number" 
            className="w-full p-2 border rounded-lg text-sm" 
            value={editingAssetItem.price} 
            onChange={e => setEditingAssetItem({...editingAssetItem, price: parseFloat(e.target.value)||0})}
        />
    </div>
)}
                       </div>

<div className="grid grid-cols-2 gap-4">
                           {/* Status */}
                           <div>
                               <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status)</label>
                               {/* ‚≠ê ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÉ‡∏´‡πâ Super Admin (user.isSuperAdmin) ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠ */}
                               <select 
                                   className={`w-full p-2.5 border rounded-xl text-sm ${(editingAssetItem.status === 'Borrowed' && !user?.isSuperAdmin) ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : 'bg-white'}`}
                                   value={editingAssetItem.status} 
                                   onChange={e => {
                                       const newStatus = e.target.value;
                                       // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Borrowed ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô '-' ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                                       const newHolder = newStatus !== 'Borrowed' ? '-' : editingAssetItem.holder;
                                       setEditingAssetItem({...editingAssetItem, status: newStatus, holder: newHolder});
                                   }}
                                   disabled={editingAssetItem.status === 'Borrowed' && !user?.isSuperAdmin}
                               >
                                   <option value="Available">‡∏ß‡πà‡∏≤‡∏á (Available)</option>
                                   <option value="Lost">‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢ (Lost)</option>
                                   <option value="Damaged">‡∏ä‡∏≥‡∏£‡∏∏‡∏î (Damaged)</option>
                                   {/* ‡πÉ‡∏´‡πâ Super Admin ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠ */}
                                   {(editingAssetItem.status === 'Borrowed' || user?.isSuperAdmin) && <option value="Borrowed">‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏° (Borrowed)</option>}
                               </select>
                           </div>
                           
                           {/* Image Upload */}
                           <div>
                               <label className="text-xs font-bold text-gray-500 mb-1 block">
                                   ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û 
                                   {editingAssetItem.status === 'Damaged' && <span className="text-red-500 ml-1">*‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</span>}
                               </label>
                               <div className="flex gap-2">
                                   {/* ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏° */}
                                   <label className={`flex-1 cursor-pointer flex flex-col items-center justify-center h-14 border-2 border-dashed rounded-xl text-sm font-bold transition-colors group ${editingAssetItem.status === 'Damaged' && (!editingAssetItem.newImages || editingAssetItem.newImages.length === 0) ? 'border-red-300 bg-red-50 text-red-600' : 'border-blue-300 bg-blue-50 text-blue-600 hover:bg-blue-100'}`}>
                                       <ImageIcon className="w-4 h-4 mb-0.5 group-hover:scale-110 transition-transform"/>
                                       <span className="text-[10px]">‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°</span>
                                       <input type="file" multiple accept="image/*" className="hidden" onChange={(e) => handleAssetImageSelect(e, true)}/>
                                   </label>
                                   {/* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á */}
                                   <label className={`flex-1 cursor-pointer flex flex-col items-center justify-center h-14 border-2 border-dashed rounded-xl text-sm font-bold transition-colors group ${editingAssetItem.status === 'Damaged' && (!editingAssetItem.newImages || editingAssetItem.newImages.length === 0) ? 'border-red-400 bg-red-100 text-red-700' : 'border-indigo-300 bg-indigo-50 text-indigo-600 hover:bg-indigo-100'}`}>
                                       <Camera className="w-4 h-4 mb-0.5 group-hover:scale-110 transition-transform"/>
                                       <span className="text-[10px]">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</span>
                                       <input type="file" multiple accept="image/*" capture="environment" className="hidden" onChange={(e) => handleAssetImageSelect(e, true)}/>
                                   </label>
                               </div>
                           </div>
                       </div>
                       
{/* ‚≠ê [NEW] ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏° (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ = ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏° ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô Super Admin) */}
                       {editingAssetItem.status === 'Borrowed' && user?.isSuperAdmin && (
                           <div className="animate-in fade-in col-span-2">
                               <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏° / ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á (Holder) <span className="text-red-500">*</span></label>
                               <input 
                                   type="text" 
                                   list="user-list-options" /* ‚≠ê ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö datalist ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß */
                                   className="w-full p-2.5 border rounded-xl text-sm border-orange-300 bg-orange-50 focus:ring-2 focus:ring-orange-500 text-orange-900 placeholder-orange-300" 
                                   placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..."
                                   value={editingAssetItem.holder || ''} 
                                   onChange={e => setEditingAssetItem({...editingAssetItem, holder: e.target.value})}
                               />
                               <p className="text-[10px] text-orange-600 mt-1">* ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
                           </div>
                       )}

                       {/* ‚≠ê Note Field */}
                       <div>
                           <label className="text-xs font-bold text-gray-500 mb-1 block">
                               ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Note)
                               {(editingAssetItem.status === 'Lost' || editingAssetItem.status === 'Damaged') && <span className="text-red-500 ml-1">*‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</span>}
                           </label>
                           <textarea 
                               className={`w-full p-2.5 border rounded-xl text-sm ${(editingAssetItem.status === 'Lost' || editingAssetItem.status === 'Damaged') && !editingAssetItem.note ? 'border-red-300 bg-red-50 focus:border-red-500' : 'border-gray-300'}`} 
                               rows="2" 
                               value={editingAssetItem.note || ''} 
                               onChange={e => setEditingAssetItem({...editingAssetItem, note: e.target.value})}
                               placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞..."
                           ></textarea>
                       </div>
                       
                       {/* Preview New Images */}
                       {editingAssetItem.newImages && editingAssetItem.newImages.length > 0 && (
                           <div className="grid grid-cols-4 gap-2">
                               {editingAssetItem.newImages.map((img, idx) => (
                                   <div key={idx} className="relative group w-full h-16 bg-gray-100 rounded border overflow-hidden">
                                       <img src={img.base64} className="w-full h-full object-cover"/>
                                       <button onClick={() => handleRemoveAssetImage(idx, true)} className="absolute top-0 right-0 bg-red-500 text-white p-0.5 rounded-bl opacity-0 group-hover:opacity-100"><X size={10}/></button>
                                   </div>
                               ))}
                           </div>
                       )}
                  </div>

                  <div className="p-5 border-t border-gray-100 bg-white flex gap-3">
                      <button onClick={() => setShowEditAssetModal(false)} className="flex-1 py-3 border border-gray-300 rounded-xl text-gray-600 font-bold hover:bg-gray-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                      <button onClick={handleUpdateAsset} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                  </div>
              </div>
          </div>
      )}
      {showPRModal && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
             <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                 <h3 className="font-bold text-lg text-blue-800 mb-4">‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠ (Issue PR)</h3>
                 <div className="space-y-3">
                     <div><label className="block text-sm font-bold text-gray-700 mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PR (PR Number)</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="PR-XXXX" value={prData.prNumber} onChange={e => setPrData({...prData, prNumber: e.target.value})} autoFocus/></div>
                     <div><label className="block text-sm font-bold text-gray-700 mb-1">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå PR (PDF/Image)</label><input type="file" className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onChange={e => setPrData({...prData, file: e.target.files[0]})}/></div>
                 </div>
                 <button onClick={handleSubmitPR} className="w-full py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 mt-4 shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PR</button>
                 <button onClick={() => setShowPRModal(false)} className="w-full py-2 text-gray-500 text-sm mt-2 hover:underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
             </div>
          </div>
      )}

      {showPOModal && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
             <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                 <h3 className="font-bold text-lg text-indigo-800 mb-4">‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Issue PO)</h3>
                 <div className="space-y-3">
                     <div><label className="block text-sm font-bold text-gray-700 mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO (PO Number)</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="PO-XXXX" value={poData.poNumber} onChange={e => setPoData({...poData, poNumber: e.target.value})} autoFocus/></div>
                     <div><label className="block text-sm font-bold text-gray-700 mb-1">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå PO (PDF/Image)</label><input type="file" className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" onChange={e => setPoData({...poData, file: e.target.files[0]})}/></div>
                 </div>
                 <button onClick={handleSubmitPO} className="w-full py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 mt-4 shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PO</button>
                 <button onClick={() => setShowPOModal(false)} className="w-full py-2 text-gray-500 text-sm mt-2 hover:underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
             </div>
          </div>
      )}


      {/* --- CONTRACT MODAL (NEW) --- */}
{showContractModal && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm animate-in fade-in">
        <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
            <h3 className="font-bold text-lg text-teal-800 mb-4 flex items-center gap-2">
                <FileSignature className="w-5 h-5"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (Contract)
            </h3>
            
            <div className="space-y-4">
                <div className="bg-teal-50 border border-teal-100 p-3 rounded-lg text-sm text-teal-800">
                    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p>
                </div>

                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (PDF/‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û) <span className="text-gray-400 font-normal">(‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</span></label>
                    <input 
                        type="file" 
                        accept=".pdf,.jpg,.jpeg,.png"
                        className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100 cursor-pointer" 
                        onChange={e => setContractData({...contractData, file: e.target.files[0]})}
                    />
                </div>
            </div>

            <button onClick={handleSubmitContract} className="w-full py-2 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700 mt-6 shadow-md transition-colors">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </button>
            <button onClick={() => setShowContractModal(false)} className="w-full py-2 text-gray-500 text-sm mt-2 hover:underline">
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
        </div>
    </div>
)}

{showReturnAssetModal && returnAssetData && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
              <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                  <div className="flex justify-between items-center mb-4">
                      <h3 className="font-bold text-lg text-teal-800 flex items-center gap-2"><RotateCcw className="w-5 h-5"/> ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</h3>
                      <button onClick={() => setShowReturnAssetModal(false)}><X className="w-5 h-5 text-gray-400"/></button>
                  </div>
                  
                  <div className="bg-gray-50 p-3 rounded-lg mb-4 text-sm border border-gray-200">
                      <label className="text-xs font-bold text-gray-500 block mb-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</label>
                      <div className="font-bold text-gray-800 text-base">{returnAssetData.name}</div>
                      <div className="text-gray-600 font-mono text-xs mt-0.5">ID: {returnAssetData.id}</div>
                      <div className="text-gray-500 text-xs">S/N: {returnAssetData.serial || '-'}</div>
                  </div>
                  
                  <div className="space-y-4">
                      <div>
                          <label className="block text-sm font-bold text-gray-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô (Status)</label>
                          <select className="w-full p-2 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500" value={returnAssetData.condition} onChange={e => setReturnAssetData({...returnAssetData, condition: e.target.value})}>
                              <option value="Good">‡∏õ‡∏Å‡∏ï‡∏¥ / ‡∏î‡∏µ (Available)</option>
                              <option value="Damaged">‡∏ä‡∏≥‡∏£‡∏∏‡∏î (Damaged)</option>
                              <option value="Lost">‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢ (Lost)</option>
                          </select>
                      </div>
                      
                      <div>
                           <label className="block text-sm font-bold text-gray-700 mb-2">
                               ‡∏£‡∏π‡∏õ‡∏™‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ({returnAssetData.images?.length || 0})
                               {returnAssetData.condition === 'Damaged' && <span className="text-red-500 ml-1">*‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</span>}
                           </label>
                           <div className="grid grid-cols-4 gap-2 mb-2">
                               {returnAssetData.previews && returnAssetData.previews.map((preview, idx) => (
                                   <div key={idx} className="relative group w-full h-16 bg-gray-100 rounded-lg border overflow-hidden">
                                       <img src={preview.url} alt="preview" className="w-full h-full object-cover"/>
                                       <button onClick={() => handleRemoveReturnImage(idx)} className="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md opacity-0 group-hover:opacity-100 transition-all hover:bg-red-600 hover:scale-110"><X size={12} strokeWidth={3}/></button>
                                   </div>
                               ))}
                               <label className={`cursor-pointer flex flex-col items-center justify-center w-full h-16 border-2 border-dashed rounded-lg transition-all ${returnAssetData.condition === 'Damaged' && (!returnAssetData.images || returnAssetData.images.length === 0) ? 'border-red-400 bg-red-50 text-red-600' : 'border-teal-300 bg-teal-50 text-teal-600 hover:bg-teal-100'}`}>
                                   <Camera className="w-4 h-4"/>
                                   <input type="file" multiple className="hidden" onChange={handleReturnImageSelect}/>
                               </label>
                           </div>
                      </div>

                      <div>
                          <label className="block text-sm font-bold text-gray-700 mb-1">
                              ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
                              {(returnAssetData.condition === 'Lost' || returnAssetData.condition === 'Damaged') && <span className="text-red-500 ml-1">*‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</span>}
                          </label>
                          <textarea 
                              className={`w-full p-2 border rounded-lg text-sm ${(returnAssetData.condition === 'Lost' || returnAssetData.condition === 'Damaged') && !returnAssetData.note ? 'border-red-300 bg-red-50' : 'border-gray-300'}`} 
                              rows="2" 
                              value={returnAssetData.note} 
                              onChange={e => setReturnAssetData({...returnAssetData, note: e.target.value})}
                          ></textarea>
                      </div>
                  </div>
                  <div className="flex gap-3 mt-6">
                      <button onClick={() => setShowReturnAssetModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                      <button onClick={confirmReturnAsset} className="flex-1 py-2 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700 shadow-md">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</button>
                  </div>
              </div>
          </div>
      )}

{/* --- PRINT PREVIEW MODAL (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å Modal ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ) --- */}
{showPOPreviewModal && selectedRequest && (
  // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° class 'print:static print:h-auto print:overflow-visible print:block' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∂‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
  <div className="fixed inset-0 bg-white z-[200] overflow-auto print:static print:h-auto print:overflow-visible print:block">
      
      {/* 2. ‡πÄ‡∏û‡∏¥‡πà‡∏° class 'print:block print:w-full print:max-w-none print:p-0' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */}
      <div className="w-full max-w-none mx-auto p-4 md:p-8 print-container flex flex-col items-center print:block print:w-full print:h-auto print:p-0">
          
         <style>{`
    @media print {
        /* ‚≠ê 1. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© Browser ‡πÄ‡∏õ‡πá‡∏ô 0 (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡πÄ‡∏≠‡∏á) */
        @page { 
            size: A4; 
            margin: 0; 
        }
        
        /* ‡∏ã‡πà‡∏≠‡∏ô Element ‡∏≠‡∏∑‡πà‡∏ô */
        body * {
            visibility: hidden;
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö html/body ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏¢‡∏≤‡∏ß‡πÜ */
        html, body {
            height: auto !important;
            min-height: 100vh !important;
            overflow: visible !important;
            background: white !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Print Area */
        #print-area, #print-area * {
            visibility: visible;
        }

        /* ‚≠ê 2. ‡∏à‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÉ‡∏´‡∏°‡πà: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏° A4 + ‡∏Ç‡∏≠‡∏ö 15mm ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏î‡πâ‡∏≤‡∏ô */
        #print-area {
            position: absolute !important;
            left: 0 !important;
            top: 0 !important;
            
            /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á A4 */
            width: 210mm !important;
            max-width: 210mm !important;
            
            /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© (‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤/‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á) ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà */
            padding: 15mm !important; 
            
            height: auto !important;
            margin: 0 !important;
            background: white !important;
            overflow: visible !important;
            display: block !important;
            z-index: 9999 !important;
            box-sizing: border-box !important; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏´‡πâ padding ‡∏£‡∏ß‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô width */
        }

        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° */
        .no-print, button { 
            display: none !important;
        }
        
        /* ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
        table { 
            width: 100% !important;
            border-collapse: collapse !important; 
        }
        thead { 
            display: table-header-group !important; /* ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤ */
        }
        tr { 
            page-break-inside: avoid !important; /* ‡πÅ‡∏ñ‡∏ß‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏£‡∏∂‡πà‡∏á */
            break-inside: avoid !important;
        }
        
        /* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö */
        .preview-table th, .preview-table td, 
        td, th { 
            border: 1px solid black !important;
            padding: 6px 8px !important; 
            font-size: 10pt !important; 
            color: black !important;
        }
        
        .header-box {
            border: 1px solid black !important;
            color: black !important;
        }
    }

    /* CSS ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ */
    .preview-table th, .preview-table td { 
        border: 1px solid black;
        padding: 6px 8px; 
        font-size: 12px; 
        vertical-align: top;
    }
    .header-box { 
        border: 1px solid black;
        padding: 10px; 
        margin-bottom: 15px; 
    }
`}</style>


          {/* Toolbar */}
          <div className="w-full max-w-[210mm] flex justify-between items-center mb-6 border-b pb-4 no-print bg-gray-50 p-4 rounded-xl">
              <div>
                  <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                      <Printer className="w-6 h-6 text-blue-600"/> ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå
                  </h2>
                  <p className="text-sm text-gray-500">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</p>
              </div>
              <div className="flex gap-2">
                  <button onClick={handlePrint} className="flex items-center gap-2 px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md font-bold transition-all">
                      <Printer className="w-4 h-4"/> ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
                  </button>
                  <button onClick={() => setShowPOPreviewModal(false)} className="px-6 py-2.5 border border-gray-300 rounded-lg hover:bg-white bg-white text-gray-700 font-bold transition-all">
                      ‡∏õ‡∏¥‡∏î
                  </button>
              </div>
          </div>

          {/* --- DOCUMENT CONTENT --- */}
          <div id="print-area" className="print-content-wrapper bg-white text-black font-sans relative text-sm w-full max-w-[210mm]">{/* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ max-w-[210mm] ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ */}
              
              {(() => {
                  const formatDateTh = (d) => {
                      if(!d) return '';
                      let dateObj;
                      if (typeof d === 'string') {
                          const cleanDate = d.split(' ')[0];
                          if (cleanDate.includes('/')) {
                              const parts = cleanDate.split('/');
                              if (parts.length === 3) {
                                  let d = parts[0].padStart(2, '0');
                                  let m = parts[1].padStart(2, '0');
                                  let y = parseInt(parts[2]);
                                  if (y < 2400) y += 543;
                                  return `${d}/${m}/${y}`;
                              }
                          }
                          dateObj = new Date(d);
                      } else { dateObj = d; }
                      
                      if (!dateObj || isNaN(dateObj.getTime())) return d;
                      const day = dateObj.getDate().toString().padStart(2, '0');
                      const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                      const year = dateObj.getFullYear() < 2400 ? dateObj.getFullYear() + 543 : dateObj.getFullYear();
                      return `${day}/${month}/${year}`;
                  };

                 // --- DATA PREPARATION ---
                  const historyDesc = [...(selectedRequest.history || [])].reverse();
                  const isActionMatch = (logAction, statusKey) => {
                      if (!logAction) return false;
                      const label = STATUS_LABELS[statusKey] || '';
                      return logAction === statusKey || logAction === label || logAction.includes(label);
                  };
                  
                  // Helper: ‡πÅ‡∏¢‡∏Å EmpID/Name
                  const getUser = (log) => {
                      if(!log || !log.user) return null;
                      let txt = log.user.replace(' (Email)', '').trim();
                      const firstPart = txt.split(' ')[0];
                      return allUsers.find(u => 
                          (u.empId && u.empId === firstPart) || 
                          (u.username === txt) ||
                          (u.email && txt.includes(u.email)) ||
                          (`${u.firstName} ${u.lastName}` === txt)
                      );
                  };

                  const reqLog = historyDesc.find(h => h.action === 'Draft' || h.action === 'Create' || h.action.includes('‡∏™‡∏£‡πâ‡∏≤‡∏á')) || historyDesc[historyDesc.length - 1];
                  
                  let l1Log = historyDesc.find(h => 
                      isActionMatch(h.action, 'Pending PM') || 
                      ((selectedRequest.type === 'Withdraw' || selectedRequest.type === 'Borrow') && isActionMatch(h.action, 'Ready to Disburse'))
                  );
// Logic ‡∏´‡∏≤ L2 - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Flow ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Local->HO
                  let l2Log = null;
                  if (selectedRequest.type === 'Local') {
                      l2Log = historyDesc.find(h => isActionMatch(h.action, 'Pending Check')); 
                      if (!l2Log) l2Log = historyDesc.find(h => isActionMatch(h.action, 'Approved') && h !== l1Log); 
                  } else {
                      // HO Flow Logic (Updated):
                      
                      // 1. ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å "Pending Check" ‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™ Local -> HO)
                      const pendingCheckLog = historyDesc.find(h => isActionMatch(h.action, 'Pending Check'));
                      
                      if (pendingCheckLog) {
                          const uCheck = getUser(pendingCheckLog);
                          const uReq = getUser(reqLog); 
                          
                          // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏Å‡∏î Check ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ -> ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô L2 ‡∏à‡∏≤‡∏Å Local Flow
                          const isRequester = (uCheck && uReq && uCheck.id === uReq.id) || 
                                              (pendingCheckLog.user === reqLog.user);
                                              
                          if (!isRequester) {
                              l2Log = pendingCheckLog;
                          }
                      }

                      // 2. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏à‡∏≤‡∏Å Approved ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
                      if (!l2Log) {
                          l2Log = historyDesc.find(h => 
                              isActionMatch(h.action, 'Approved') && 
                              h !== l1Log &&
                              (!h.note || !h.note.includes('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô HO'))
                          );
                      }
                  }
                  // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç HO] Logic ‡∏´‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠ (Purchasing)
                  let purchasingLog = null;
                  if (['Local', 'HO'].includes(selectedRequest.type)) {
                      if (selectedRequest.type === 'Local') {
                          // Local: Ordered ‡∏´‡∏£‡∏∑‡∏≠ Approved
                          purchasingLog = historyDesc.find(h => isActionMatch(h.action, 'Ordered'));
                          if (!purchasingLog) {
                              purchasingLog = historyDesc.find(h => isActionMatch(h.action, 'Approved') && h !== l2Log && h !== l1Log);
                          }
                      } else {
                          // ‚≠ê HO: ‡∏î‡∏∂‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏™‡πà‡∏á‡πÑ‡∏õ "Pending Head" (‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° Flow ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)
                          purchasingLog = historyDesc.find(h => isActionMatch(h.action, 'Pending Head'));
                          
                          if (!purchasingLog) {
                              purchasingLog = historyDesc.find(h => 
                                  h.note && (h.note.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô') || h.note.includes('Verify') || h.note.includes('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô HO'))
                              );
                          }
                      }
                  }
                  
                  const userReq = getUser(reqLog);
                  const userL1 = getUser(l1Log);
                  const userL2 = getUser(l2Log);
                  const userPurchasing = getUser(purchasingLog);
                  
                  // ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Request / L1 / L2)
                  const nameReq = userReq ? `${userReq.firstName} ${userReq.lastName}` : (reqLog ? reqLog.user.replace(' (Email)', '') : selectedRequest.requester);
                  const nameL1 = userL1 ? `${userL1.firstName} ${userL1.lastName}` : (l1Log ? l1Log.user.replace(' (Email)', '') : '..........................');
                  const nameL2 = userL2 ? `${userL2.firstName} ${userL2.lastName}` : (l2Log ? l2Log.user.replace(' (Email)', '') : '..........................');
                  const dateReq = formatDateTh(reqLog ? reqLog.date : selectedRequest.created);
                  const dateL1 = l1Log ? formatDateTh(l1Log.date) : '....../....../......';
                  const dateL2 = l2Log ? formatDateTh(l2Log.date) : '....../....../......';
                  
                  // ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (Request / L1 / L2)
                  const sigReq = userReq?.signature ? getDriveImageUrl(userReq.signature) : null;
                  const sigL1 = userL1?.signature ? getDriveImageUrl(userL1.signature) : null;
                  const sigL2 = userL2?.signature ? getDriveImageUrl(userL2.signature) : null;

                  // --- ‡∏´‡∏≤ Issued By (‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á) ‡πÅ‡∏•‡∏∞ Returned By (‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô) ---
                  const getLogUser = (statusKey) => {
                      const log = historyDesc.find(h => isActionMatch(h.action, statusKey));
                      return { user: getUser(log), log: log };
                  };

                  // Issued: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 'Completed' (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Borrow/Withdraw)
                  const issuerData = getLogUser('Completed');
                  const userIssuer = issuerData.user;
                  const nameIssuer = userIssuer ? `${userIssuer.firstName} ${userIssuer.lastName}` : (issuerData.log ? issuerData.log.user : '');
                  const sigIssuer = userIssuer?.signature ? getDriveImageUrl(userIssuer.signature) : null;

                  // Returned: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 'Returned'
                  const returnerData = getLogUser('Returned');
                  const userReturner = returnerData.user;
                  const nameReturner = userReturner ? `${userReturner.firstName} ${userReturner.lastName}` : (returnerData.log ? returnerData.log.user : '');
                  const sigReturner = userReturner?.signature ? getDriveImageUrl(userReturner.signature) : null;
                  const dateReturn = returnerData.log ? formatDateTh(returnerData.log.date) : '....../....../......';

                  return (
                      <>
                      {/* ================================================================================== */}
                      {/* FORM TYPE 1: BORROW TOOL SHEET */}
                      {/* ================================================================================== */}

                      {selectedRequest.type === 'Borrow' ? (
                          <div className="font-sans text-black p-4 w-full">
                              
                              <div className="text-center mb-6">
                                  <h1 className="text-3xl font-bold uppercase tracking-widest mb-1">BORROW TOOL SHEET</h1>
                                  <h2 className="text-xl font-bold">‡πÉ‡∏ö‡∏¢‡∏∑‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</h2>
                              </div>

                              <div className="mb-6 border-b-2 border-black pb-4">
                                  <div className="flex items-end gap-6 mb-2 text-base w-full">
                                      {/* [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á Name, ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ Employee No ‡πÅ‡∏•‡∏∞ Date */}
                                      <div className="flex-1 flex flex-col">
                                          <div className="flex items-end w-full">
                                              <span className="font-bold whitespace-nowrap mr-2">Name:</span>
                                              <div className="border-b border-dotted border-black flex-1 text-center font-bold text-blue-900 px-2 truncate">
                                                  {nameReq}
                                              </div>
                                          </div>
                                          <div className="text-xs text-center text-gray-500 mt-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</div>
                                      </div>

                                      <div className="w-[35%] flex flex-col">
                                          <div className="flex items-end w-full">
                                              <span className="font-bold whitespace-nowrap mr-2">Employee No:</span>
                                              <div className="border-b border-dotted border-black flex-1 text-center font-mono">
                                                  {userReq?.empId || '-'}
                                              </div>
                                          </div>
                                          <div className="text-xs text-center text-gray-500 mt-1">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</div>
                                      </div>

                                      <div className="w-[25%] flex flex-col">
                                          <div className="flex items-end w-full">
                                              <span className="font-bold whitespace-nowrap mr-2">Date:</span>
                                              <div className="border-b border-dotted border-black flex-1 text-center">
                                                  {dateReq}
                                              </div>
                                          </div>
                                          <div className="text-xs text-center text-gray-500 mt-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
                                      </div>
                                  </div>

                                  <div className="flex justify-between items-end mt-4 mb-1 text-base">
                                      <div className="flex items-end w-full">
                                          <span className="font-bold w-16">Project:</span>
                                          <div className="border-b border-dotted border-black flex-1 text-left pl-2 font-bold text-black">
                                              {selectedRequest.job}
                                          </div>
                                      </div>
                                  </div>
                                  <div className="flex justify-between text-xs text-gray-500 font-normal">
                                      <div className="pl-16">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>
                                  </div>
                              </div>

                              {/* Table */}
                              <table className="w-full border-collapse border border-black mb-10">
                                  <thead>
                                      <tr>
                                          <th colSpan="4" className="border border-black p-2 bg-white text-right">
                                              <span className="font-bold text-base">Doc No: {selectedRequest.docNumber || selectedRequest.id}</span>
                                          </th>
                                      </tr>
                                      <tr className="bg-gray-100 text-center text-base">
                                          <th className="border border-black py-3 w-24">
                                              Quantity<br/><span className="text-xs font-normal">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>
                                          </th>
                                          <th className="border border-black py-3">
                                              Description<br/><span className="text-xs font-normal">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                          </th>
                                          <th className="border border-black py-3 w-32">
                                              Unit Price<br/><span className="text-xs font-normal">‡∏£‡∏≤‡∏Ñ‡∏≤</span>
                                          </th>
                                          <th className="border border-black py-3 w-32">
                                              Amount<br/><span className="text-xs font-normal">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                                          </th>
                                      </tr>
                                  </thead>
                                  <tbody>
    {selectedRequest.items.map((item, idx) => {
        // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Reject
        const isRejected = item.isItemRejected;
        
        return (
            <tr key={idx} className="text-base">
                <td className={`border border-black py-4 text-center align-top font-bold ${isRejected ? 'line-through text-gray-400' : ''}`}>
                    {item.qty} {item.unit}
                </td>
                <td className="border border-black py-4 px-4 align-top">
                    <div className={`font-bold text-lg ${isRejected ? 'line-through text-red-800' : ''}`}>
                        {item.name}
                    </div>
                    
                    {/* ‚≠ê ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏° */}
                    {isRejected && (
                        <div className="text-red-600 font-bold mt-1 text-sm bg-red-50 px-2 py-1 rounded border border-red-200 inline-block">
                            ** ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°: {item.rejectReason}
                        </div>
                    )}

                    <div className="text-sm mt-1 text-gray-600">
                        {item.serial && !isRejected && <span>S/N: {item.serial} </span>}
                        {item.assetId && !isRejected && <span>ID: {item.assetId}</span>}
                    </div>
                    {item.note && <div className="text-sm text-gray-500 italic mt-1">Note: {item.note}</div>}
                </td>
                <td className="border border-black py-4 text-right px-2 align-top text-gray-400">-</td>
                <td className="border border-black py-4 text-right px-2 align-top text-gray-400">-</td>
            </tr>
        );
    })}
</tbody>
                              </table>

                              {/* Signatures */}
                              <div className="grid grid-cols-2 gap-x-16 gap-y-8 mt-6">
                                  {/* Left Column */}
                                  <div className="flex flex-col gap-8">
                                      {/* Approved By */}
                                      <div className="relative">
                                          <div className="flex items-end mb-1">
                                              <span className="font-bold w-24 text-lg">Approved</span>
                                              <div className="border-b border-dotted border-black flex-1 relative h-10 text-center flex items-end justify-center">
                                                  {(sigL1 || sigL2) && <img src={sigL1 || sigL2} className="absolute bottom-0 left-1/2 -translate-x-1/2 max-h-16 object-contain"/>}
                                              </div>
                                          </div>
                                          <div className="text-center font-bold text-sm h-6 mt-1">
                                              {nameL1 && nameL1 !== '..........................' ? `(${nameL1})` : ''}
                                          </div>
                                          <div className="text-xs text-center -mt-1 text-gray-500">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approved By)</div>
                                      </div>

                                      {/* Issued By (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß) */}
                                      <div className="relative">
                                          <div className="flex items-end mb-1">
                                              <span className="font-bold w-24 text-lg">Issued</span>
                                              <div className="border-b border-dotted border-black flex-1 relative h-10 text-center flex items-end justify-center">
                                                  {sigIssuer && <img src={sigIssuer} className="absolute bottom-0 left-1/2 -translate-x-1/2 max-h-16 object-contain"/>}
                                              </div>
                                          </div>
                                          <div className="text-center font-bold text-sm h-6 mt-1">
                                              {nameIssuer ? `(${nameIssuer})` : ''}
                                          </div>
                                          <div className="text-xs text-center -mt-1 text-gray-500">‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢ (Issued By)</div>
                                      </div>
                                  </div>

                                {/* Right Column */}
                                  <div className="flex flex-col gap-8">
                                      {/* Borrowed By */}
                                      <div className="relative">
                                          <div className="flex items-end mb-1">
                                              <span className="font-bold w-24 text-lg">Borrowed</span>
                                              <div className="border-b border-dotted border-black flex-1 relative h-10 text-center flex items-end justify-center">
                                                  {sigReq ? <img src={sigReq} className="absolute bottom-0 left-1/2 -translate-x-1/2 max-h-16 object-contain"/> : ''}
                                              </div>
                                          </div>
                                          <div className="text-center font-bold text-sm h-6 mt-1">
                                              {nameReq ? `(${nameReq})` : ''}
                                          </div>
                                          <div className="text-xs text-center -mt-1 text-gray-500">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏° (Borrowed By)</div>
                                      </div>

                                      {/* Returned By (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß) */}
                                      <div className="relative">
                                          <div className="flex items-end mb-1">
                                              <span className="font-bold w-24 text-lg">Returned</span>
                                              <div className="border-b border-dotted border-black flex-1 relative h-10 text-center flex items-end justify-center">
                                                  {sigReturner && <img src={sigReturner} className="absolute bottom-0 left-1/2 -translate-x-1/2 max-h-16 object-contain"/>}
                                              </div>
                                          </div>
                                          <div className="text-center mt-1">
                                              <div className="font-bold text-sm h-6">
                                                  {nameReturner ? `(${nameReturner})` : ''}
                                              </div>
                                              <div className="text-xs text-gray-500 mb-2">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô (Received By)</div>
                                              <div className="text-sm font-bold">
                                                  {nameReturner ? (
                                                      <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô: {dateReturn}</span>
                                                  ) : (
                                                      <span className="text-transparent">.</span>
                                                  )}
                                              </div>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      ) : (
                                
  /* ================================================================================== */
/* ‚≠ê FORM TYPE 2 (ELSE): ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ‡∏™‡πÇ‡∏ï‡∏£‡πå + Partial + Closed Logic) */
/* ================================================================================== */

<> 
    {/* 1. ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡∏™‡πÇ‡∏ï‡∏£‡πå" ‡πÅ‡∏•‡∏∞ "‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠" */}
    {(() => {
        // --- A. Logic ‡∏´‡∏≤‡∏Ñ‡∏ô‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡πå ---
        let storeLog = null;
        let storeLabel = "‡∏™‡πÇ‡∏ï‡∏£‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á"; // Default

        if (selectedRequest.type === 'Withdraw') {
            storeLabel = "‡∏™‡πÇ‡∏ï‡∏£‡πå‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á";
            storeLog = historyDesc.find(h => 
                h.action === 'Completed' || 
                h.action === 'Received' ||  
                (h.note && h.note.includes('‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á'))
            );
        } else {
            storeLog = historyDesc.find(h => 
                h.action === 'Partially Received' || 
                h.action === 'Completed' || 
                h.action === 'Received' ||
                (h.note && h.note.includes('‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á'))
            );
        }
        
        const userStore = getUser(storeLog);
        const nameStore = userStore ? `${userStore.firstName} ${userStore.lastName}` : (storeLog ? storeLog.user.replace(' (Email)', '') : '..........................');
        const sigStore = userStore?.signature ? getDriveImageUrl(userStore.signature) : null;
        const dateStore = storeLog ? formatDateTh(storeLog.date) : '....../....../......';

        // --- B. ‚≠ê Logic ‡∏´‡∏≤‡∏Ñ‡∏ô‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠ (Purchasing) ---
      let purchasingLog = null;
        
        if (selectedRequest.type === 'HO') {
            // ‚úÖ HO ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Action "Pending Head" (‡∏Ñ‡∏∑‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ Level 1)
            // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
            purchasingLog = historyDesc.find(h => isActionMatch(h.action, 'Pending Head'));

            // Fallback: ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å Note (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏™‡πÄ‡∏Å‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏™‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Local)
            if (!purchasingLog) {
                purchasingLog = historyDesc.find(h => 
                    h.note && (
                        h.note.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô') || 
                        h.note.includes('Verify') || 
                        h.note.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£') ||
                        h.note.includes('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô HO')
                    )
                );
            }
        } 
        else if (selectedRequest.type === 'Local') {
            // ‚úÖ Local ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏î‡∏∂‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠ "Approved" (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à) ‡∏´‡∏£‡∏∑‡∏≠ "Ordered"
            
            // 1. ‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Ordered (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            purchasingLog = historyDesc.find(h => isActionMatch(h.action, 'Ordered'));

            // 2. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Approved (‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å Pending Check)
            if (!purchasingLog) {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Pending Check) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Flow ‡πÉ‡∏´‡∏°‡πà
                const hasCheckStep = historyDesc.some(h => isActionMatch(h.action, 'Pending Check'));
                
                if (hasCheckStep) {
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Pending Check -> ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏î Approved ‡∏ñ‡∏±‡∏î‡∏°‡∏≤‡∏Ñ‡∏∑‡∏≠ "‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠"
                    purchasingLog = historyDesc.find(h => isActionMatch(h.action, 'Approved'));
                } else {
                    // ‡∏Å‡∏£‡∏ì‡∏µ Flow ‡πÄ‡∏Å‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Check -> ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÉ‡∏ä‡πâ Approved ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ö L2)
                    // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Local ‡∏õ‡∏Å‡∏ï‡∏¥ L2 ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ Pending Check ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Approved
                    // ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô Approved ‡πÉ‡∏ô Local ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô Purchasing ‡πÄ‡∏™‡∏°‡∏≠
                    purchasingLog = historyDesc.find(h => isActionMatch(h.action, 'Approved'));
                }
            }
        }
        const userPurchasing = getUser(purchasingLog);
        const namePurchasing = userPurchasing ? `${userPurchasing.firstName} ${userPurchasing.lastName}` : (purchasingLog ? purchasingLog.user.replace(' (Email)', '') : '..........................');
        const sigPurchasing = userPurchasing?.signature ? getDriveImageUrl(userPurchasing.signature) : null;
        const datePurchasing = purchasingLog ? formatDateTh(purchasingLog.date) : '....../....../......';

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô
        const isJobClosed = ['Completed', 'Returned', 'Rejected'].includes(selectedRequest.status);
        const isPartial = selectedRequest.status === 'Partially Received';

        return (
        <>
            {/* --- Header --- */}
            <div className="w-full text-center mb-4">
                 <h1 className="text-2xl font-bold mb-2">‡πÉ‡∏ö‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å-‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h1>
            </div>

            <div className="w-full text-left font-normal mb-4">
                <span className="font-bold text-base">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project):</span> 
                <span className="border-b border-dotted border-black px-2 ml-2 min-w-[200px] inline-block font-bold">
                    {selectedRequest.job}
                </span>
            </div>

            {/* ‡∏Å‡∏•‡πà‡∏≠‡∏á Checkbox (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó) */}
            <div className="header-box text-left font-normal">
                 <div className="grid grid-cols-3 gap-2 mb-3">
                    <div className="flex justify-start">
                        <label className="flex items-center gap-2">
                            <div className={`w-5 h-5 border border-black flex items-center justify-center bg-white`}>
                                {(selectedRequest.type === 'Withdraw') && <span className="text-lg font-bold leading-none mb-1">‚úì</span>}
                            </div> 
                            {(() => {
                                const isNonSystem = selectedRequest.type === 'Withdraw' && 
                                    (selectedRequest.withdrawStockType === 'NonSystem' || 
                                    (selectedRequest.items && selectedRequest.items.some(i => i.stockType === 'NonSystem')));
                                
                                return (
                                    <span className={isNonSystem ? "font-bold underline" : ""}>
                                        {isNonSystem ? '‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (Withdraw)' : '‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏ (Withdraw)'}
                                    </span>
                                );
                            })()}
                        </label>
                    </div>
                    <div className="flex justify-center">
                        <label className="flex items-center gap-2">
                            <div className={`w-5 h-5 border border-black flex items-center justify-center bg-white`}>
                                {selectedRequest.type === 'Local' && <span className="text-lg font-bold leading-none mb-1">‚úì</span>}
                            </div> 
                            <span>‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (Local)</span>
                        </label>
                    </div>
                    <div className="flex justify-end">
                         <label className="flex items-center gap-2">
                            <div className={`w-5 h-5 border border-black flex items-center justify-center bg-white`}>
                                {selectedRequest.type === 'HO' && <span className="text-lg font-bold leading-none mb-1">‚úì</span>}
                            </div> 
                            <span>{selectedRequest.type === 'HO' && selectedRequest.purchaseType === 'Rent' ? '‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏ HO (‡πÄ‡∏ä‡πà‡∏≤)' : '‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏ HO (‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏î)'}</span>
                        </label>
                    </div>
                </div>
                <div className="border-t border-black pt-3 flex gap-8">
                    <span className="font-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</span>
                    {['Normal', 'Urgent', 'Critical'].map(p => (
                        <label key={p} className="flex items-center gap-2">
                             <div className="w-5 h-5 border border-black flex items-center justify-center bg-white">
                                {selectedRequest.priority === p && <span className="text-lg font-bold leading-none mb-1">‚úì</span>}
                            </div> 
                            <span>{p === 'Normal' ? '‡∏õ‡∏Å‡∏ï‡∏¥' : p === 'Urgent' ? '‡∏î‡πà‡∏ß‡∏ô' : '‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å'}</span>
                        </label>
                    ))}
                </div>
            </div>

            {/* --- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --- */}
            <table className="w-full border-collapse preview-table">
                <thead>
                    <tr>
                        <th colSpan="4" className="border-0 p-0">
                            <div className="flex justify-end items-center pb-2 pt-2 bg-white" style={{borderBottom: '1px solid black'}}>
                                <div className="text-right">
                                    <div className="text-sm">
                                        <span className="font-bold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</span> {selectedRequest.docNumber || selectedRequest.id}
                                    </div>
                                    <div className="text-sm">
                                        <span className="font-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span> {formatDateTh(selectedRequest.history?.[0]?.date || selectedRequest.created)}
                                    </div>
                                </div>
                            </div>
                        </th>
                    </tr>
                    <tr className="bg-gray-100 text-center font-bold">
                        <th className="w-12 border border-black">NO.</th>
                        <th className="border border-black">‡∏£‡∏´‡∏±‡∏™ / ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏ (Code / Description)</th>
                        <th className="w-32 border border-black">SUBJOB / Mat. Code</th>
                        <th className="w-48 border border-black">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                    </tr>
                </thead>
               
<tbody className="divide-y">
    {selectedRequest.items.map((item, i) => {
        // --- 1. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ---
        const isWithdraw = selectedRequest.type === 'Withdraw';
        const isOrder = ['HO', 'Local'].includes(selectedRequest.type);
        
        // --- 2. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ---
        const requested = item.qty;
        const paid = item.receivedTotal || 0; // ‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö/‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á
        const remaining = requested - paid;   // ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö
        const isRejected = item.isItemRejected; // ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        
        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏ö‡∏á‡∏≤‡∏ô (Withdraw ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö)
        const isClosed = ['Completed', 'Returned', 'Rejected', 'Partially Received'].includes(selectedRequest.status);

        const isAfterOrdered = ['Ordered', 'Shipping', 'Partially Received', 'Completed'].includes(selectedRequest.status);

        // --- 3. Logic ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
        
        // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç Partial ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Withdraw ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!! (‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏ö‡∏á‡∏≤‡∏ô + ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å Reject + ‡πÑ‡∏î‡πâ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡∏≠)
        const showWithdrawWarning = isWithdraw && isClosed && !isRejected && (paid < requested);

        return (
            <tr key={i}>
                {/* Col 1: ‡∏•‡∏≥‡∏î‡∏±‡∏ö */}
                <td className="text-center font-bold border border-black p-2">{i + 1}</td>
                
                {/* Col 2: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ */}
                <td className="border border-black p-2">
                    {/* ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) */}
                    {(() => {
                        const stockItem = inventory.find(inv => inv.name === item.name && inv.project === selectedRequest.job);
                        const displayId = stockItem ? getDisplayId(stockItem.id) : null;
                        return displayId ? <div className="text-[10px] font-mono font-bold text-slate-600 mb-1 bg-slate-100 px-1 rounded w-fit border border-slate-300">‡∏£‡∏´‡∏±‡∏™: {displayId}</div> : null;
                    })()}

                    {/* ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏Ç‡∏µ‡∏î‡∏Ü‡πà‡∏≤‡∏ñ‡πâ‡∏≤ Reject) */}
                    <div className={`font-bold text-black text-sm ${isRejected ? 'line-through text-red-800' : ''}`}>
                        {item.name}
                    </div>
                    
                    {/* ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£ Reject (‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó) */}
                    {isRejected && (
                        <div className="mt-1 text-xs font-bold text-red-600 bg-red-50 border border-red-200 px-2 py-1 rounded w-fit">
                            *** ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å: {item.rejectReason}
                        </div>
                    )}

                    {/* ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó) */}
                    <div className="mt-2 text-xs grid grid-cols-2 gap-4 w-fit">
                        <div>
                            <span className="text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠:</span> <span className="font-bold text-base">{requested}</span> {item.unit}
                        </div>
                        
                        {/* Withdraw: ‡πÇ‡∏ä‡∏ß‡πå‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏á‡∏≤‡∏ô) */}
                        {isWithdraw && isClosed && !isRejected && (
                            <div>
                                <span className="text-gray-500">‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á:</span> 
                                <span className={`font-bold text-base ml-1 ${showWithdrawWarning ? 'text-red-600' : 'text-green-700'}`}>
                                    {paid}
                                </span> {item.unit}
                            </div>
                        )}
                    </div>
                    
                    {/* ‚≠ê‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Withdraw ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚≠ê‚≠ê */}
                    {showWithdrawWarning && (
                        <div className="mt-1 text-[10px] text-orange-600 font-bold italic">
                            * ‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠ (Stock ‡πÑ‡∏°‡πà‡∏û‡∏≠/‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î)
                        </div>
                    )}
                </td>

                {/* Col 3: SubJob/Mat */}
                <td className="text-center align-middle border border-black p-2">
                    {item.subJob || item.matCode ? (
                        <div className="flex flex-col gap-1 text-xs font-bold">
                            {item.subJob && <span>Sub: {item.subJob}</span>}
                            {item.matCode && <span>Mat.: {item.matCode}</span>}
                        </div>
                    ) : '-'}
                </td>

     {/* Col 4: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ */}
                <td className="text-left align-top border border-black p-2">
                    <div className="font-bold text-center mb-1 bg-gray-50 rounded border border-gray-200 text-xs py-0.5">
                        {formatDateTh(selectedRequest.dateRequired)}
                    </div>
                    
                    {/* ‚≠ê‚≠ê HO/Local: ‡πÇ‡∏ä‡∏ß‡πå‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö/‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö ‡πÇ‡∏î‡∏¢‡πÄ‡∏ä‡πá‡∏Ñ isAfterOrdered ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ‚≠ê‚≠ê */}
                    {isOrder && !isRejected && isAfterOrdered && (paid > 0 || remaining > 0) && (
                         <div className="mt-1 pt-1 border-t border-dotted border-gray-400 text-[11px] leading-tight">
                            {paid > 0 && (
                                <div className="text-green-700 font-bold">
                                    ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß: {paid} {item.unit}
                                </div>
                            )}
                            {remaining > 0 ? (
                                <div className="text-red-600 font-bold">
                                    ‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö: {remaining} {item.unit}
                                </div>
                            ) : (
                                <div className="text-gray-500 font-bold italic">
                                    (‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß)
                                </div>
                            )}
                        </div>
                    )}

                    {item.note && <div className="text-xs text-gray-600 border-t border-dotted border-gray-300 pt-1 mt-1 leading-snug">{item.note}</div>}
                </td>
            </tr>
        );
    })}
</tbody>

</table>
{/* --- SIGNATURES SECTION (REARRANGED - RAW JSX) --- */}
            <div className="mt-8 signature-section break-inside-avoid">
                {selectedRequest.type === 'Withdraw' ? (
                    /* üü¢ ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏ö‡∏¥‡∏Å (Withdraw) */
                    <div className="grid grid-cols-3 gap-4 text-center">
                        {/* 1. ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ */}
                        <div className="border border-black p-2 h-44 flex flex-col justify-between bg-white">
                            <div className="text-sm font-bold border-b border-gray-200 pb-1 mb-1">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ (Requester)</div>
                            {/* ‚≠ê ‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß 70px ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏•‡∏≠‡∏¢‡∏ï‡∏±‡∏ß */}
                            <div className="h-[70px] shrink-0 relative flex items-center justify-center">
                                {sigReq ? <img src={sigReq} className="absolute inset-0 w-full h-full object-contain"/> : <span className="text-gray-300 text-xs">(‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠)</span>}
                            </div>
                            <div className="border-t border-dotted border-black mt-1 pt-1 text-xs">
                                <div className="font-bold">{nameReq}</div>
                                {userReq?.empId && <div className="font-mono text-[10px] text-gray-600">{userReq.empId}</div>}
                                <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {dateReq}</div>
                            </div>
                        </div>
                        {/* 2. ‡∏™‡πÇ‡∏ï‡∏£‡πå */}
                        <div className="border border-black p-2 h-44 flex flex-col justify-between bg-white">
                            <div className="text-sm font-bold border-b border-gray-200 pb-1 mb-1">{storeLabel}</div>
                            <div className="h-[70px] shrink-0 relative flex items-center justify-center">
                                {sigStore ? <img src={sigStore} className="absolute inset-0 w-full h-full object-contain"/> : <span className="text-gray-300 text-xs">..........................</span>}
                            </div>
                            <div className="border-t border-dotted border-black mt-1 pt-1 text-xs">
                                <div className="font-bold">{nameStore}</div>
                                <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {dateStore}</div>
                            </div>
                        </div>
                        {/* 3. ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ */}
                        <div className="border border-black p-2 h-44 flex flex-col justify-between bg-white">
                            <div className="text-sm font-bold border-b border-gray-200 pb-1 mb-1">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                            <div className="h-[70px] shrink-0 relative flex items-center justify-center">
                                {sigL1 ? <img src={sigL1} className="absolute inset-0 w-full h-full object-contain"/> : <span className="text-gray-300 text-xs">..........................</span>}
                            </div>
                            <div className="border-t border-dotted border-black mt-1 pt-1 text-xs">
                                <div className="font-bold">{nameL1}</div>
                                <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {dateL1}</div>
                            </div>
                        </div>
                    </div>
                ) : (
                    /* üîµ ‡∏Å‡∏£‡∏ì‡∏µ‡∏ã‡∏∑‡πâ‡∏≠ (Local/HO) -> 2 ‡πÅ‡∏ñ‡∏ß */
                    <div className="flex flex-col gap-4">
                        {/* ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1 */}
                        <div className="grid grid-cols-3 gap-4 text-center">
                            {/* 1. ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ */}
                            <div className="border border-black p-2 h-44 flex flex-col justify-between bg-white">
                                <div className="text-sm font-bold border-b border-gray-200 pb-1 mb-1">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ (Requester)</div>
                                <div className="h-[70px] shrink-0 relative flex items-center justify-center">
                                    {sigReq ? <img src={sigReq} className="absolute inset-0 w-full h-full object-contain"/> : <span className="text-gray-300 text-xs">(‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠)</span>}
                                </div>
                                <div className="border-t border-dotted border-black mt-1 pt-1 text-xs">
                                    <div className="font-bold">{nameReq}</div>
                                    {userReq?.empId && <div className="font-mono text-[10px] text-gray-600">{userReq.empId}</div>}
                                    <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {dateReq}</div>
                                </div>
                            </div>
                            {/* 2. ‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠ (NEW) */}
                            <div className="border border-black p-2 h-44 flex flex-col justify-between bg-white">
                                <div className="text-sm font-bold border-b border-gray-200 pb-1 mb-1">‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠ (Purchasing)</div>
                                <div className="h-[70px] shrink-0 relative flex items-center justify-center">
                                    {sigPurchasing ? <img src={sigPurchasing} className="absolute inset-0 w-full h-full object-contain"/> : <span className="text-gray-300 text-xs">..........................</span>}
                                </div>
                                <div className="border-t border-dotted border-black mt-1 pt-1 text-xs">
                                    <div className="font-bold">{namePurchasing}</div>
                                    <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {datePurchasing}</div>
                                </div>
                            </div>
                            {/* 3. ‡∏™‡πÇ‡∏ï‡∏£‡πå */}
                            <div className="border border-black p-2 h-44 flex flex-col justify-between bg-white">
                                <div className="text-sm font-bold border-b border-gray-200 pb-1 mb-1">{storeLabel}</div>
                                <div className="h-[70px] shrink-0 relative flex items-center justify-center">
                                    {sigStore ? <img src={sigStore} className="absolute inset-0 w-full h-full object-contain"/> : <span className="text-gray-300 text-xs">..........................</span>}
                                </div>
                                <div className="border-t border-dotted border-black mt-1 pt-1 text-xs">
                                    <div className="font-bold">{nameStore}</div>
                                    <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {dateStore}</div>
                                </div>
                            </div>
                        </div>

                        {/* ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2 */}
                        <div className="grid grid-cols-2 gap-4 text-center px-10">
                            {/* 4. ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ L1 */}
                            <div className="border border-black p-2 h-44 flex flex-col justify-between bg-white">
                                <div className="text-sm font-bold border-b border-gray-200 pb-1 mb-1">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Level 1)</div>
                                <div className="h-[70px] shrink-0 relative flex items-center justify-center">
                                    {sigL1 ? <img src={sigL1} className="absolute inset-0 w-full h-full object-contain"/> : <span className="text-gray-300 text-xs">..........................</span>}
                                </div>
                                <div className="border-t border-dotted border-black mt-1 pt-1 text-xs">
                                    <div className="font-bold">{nameL1}</div>
                                    <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {dateL1}</div>
                                </div>
                            </div>
                            {/* 5. ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ L2 */}
                            <div className="border border-black p-2 h-44 flex flex-col justify-between bg-white">
                                <div className="text-sm font-bold border-b border-gray-200 pb-1 mb-1">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Level 2)</div>
                                <div className="h-[70px] shrink-0 relative flex items-center justify-center">
                                    {sigL2 ? <img src={sigL2} className="absolute inset-0 w-full h-full object-contain"/> : <span className="text-gray-300 text-xs">..........................</span>}
                                </div>
                                <div className="border-t border-dotted border-black mt-1 pt-1 text-xs">
                                    <div className="font-bold">{nameL2}</div>
                                    <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {dateL2}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </>
        );
    })()}
</>

                            )}
                            </>
                        );
                    })()}
                </div>
            </div>
        </div>
      )}

{/* ‚≠ê FULLSCREEN IMAGE VIEWER (With Download) ‚≠ê */}
      {viewingAttachments && (
         <div className="fixed inset-0 bg-black/95 z-[400] flex flex-col justify-center p-4 backdrop-blur-sm animate-in fade-in">
            
            {/* Header Clean Style */}
            <div className="flex justify-between items-center text-white mb-4 px-2 max-w-4xl mx-auto w-full">
               <h2 className="text-lg font-bold flex items-center gap-2">
                   <ImageIcon className="w-5 h-5"/> ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏ô‡∏ö ({viewingAttachments.attachments.length})
               </h2>
               
               <button 
                   onClick={() => setViewingAttachments(null)} 
                   className="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors text-gray-300 hover:text-white"
                   title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á"
               >
                   <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
               </button>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto space-y-6 px-2 pb-10 w-full max-w-4xl mx-auto">
               {viewingAttachments.attachments.map((att, idx) => (
                  <div key={idx} className="bg-zinc-900 rounded-xl overflow-hidden border border-zinc-800 flex flex-col items-center shadow-2xl">
                     
                     {/* Image Display */}
                     {(att.type?.startsWith('image/') || att.name?.match(/\.(jpg|jpeg|png|gif)$/i)) ? (
                        <div className="w-full relative min-h-[300px] bg-black flex items-center justify-center">
                            <img 
                                src={getDriveImageUrl(att.url || att.base64 || att.data)} 
                                alt={att.name} 
                                className="w-auto max-w-full max-h-[85vh] object-contain" 
                                onError={(e) => {
                                    e.target.style.display = 'none'; 
                                    e.target.nextSibling.style.display = 'flex'; 
                                }} 
                            />
                            {/* Error Placeholder */}
                            <div className="hidden flex-col items-center justify-center text-zinc-500 py-10">
                                <AlertCircle className="w-10 h-10 mb-2"/>
                                <span className="text-sm">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ</span>
                            </div>
                        </div>
                     ) : (
                        <div className="p-10 flex flex-col items-center justify-center text-zinc-400 gap-3 w-full bg-zinc-800/50">
                           <FileText className="w-12 h-12 text-blue-400"/>
                           <span className="text-sm font-bold">{att.name}</span>
                        </div>
                     )}

                     {/* Footer: Name & Download Button */}
                     <div className="w-full bg-zinc-950 p-3 border-t border-zinc-800 flex justify-between items-center gap-4">
                         <p className="text-xs text-zinc-400 font-mono truncate flex-1 text-left">
                             {idx + 1}. {att.name}
                         </p>
                         
                         {/* ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î */}
                         <a 
                             href={getDownloadUrl(att.url || att.base64 || att.data)} 
                             target="_blank" 
                             download={att.name} // attribute ‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå Base64
                             className="flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 hover:text-white px-3 py-1.5 rounded-lg transition-colors text-xs font-bold"
                             title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ"
                         >
                             <Download className="w-4 h-4"/> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                         </a>
                     </div>
                  </div>
               ))}
            </div>
         </div>
      )}

{showImportAssetModal && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-in fade-in">
        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden">
            
            {/* ‚≠ê‚≠ê‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‚≠ê‚≠ê‚≠ê */}
            <datalist id="import-user-list">
                {allUsers.map((u, i) => (
                    <option key={i} value={`${u.firstName} ${u.lastName}`}>{u.empId}</option>
                ))}
            </datalist>

            {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° Datalist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Assets */}
<datalist id="import-asset-list">
    {[...new Set(assets.map(a => a.name))].map((name, i) => (
        <option key={i} value={name}/>
    ))}
</datalist>

<datalist id="supplier-list-options">
                {[...new Set(invLogs.map(l => l.supplier).filter(s => s))].map((s, i) => (
                    <option key={i} value={s} />
                ))}
            </datalist>
                  
                  {/* Header */}
                  <div className="px-6 py-4 border-b flex justify-between items-center bg-white">
                      <h3 className="font-bold text-lg text-green-700 flex items-center gap-2">
                          <FileText className="w-5 h-5"/> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Import CSV)
                      </h3>
                      <button onClick={() => setShowImportAssetModal(false)} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100">
                          <X className="w-6 h-6"/>
                      </button>
                  </div>

                  {/* Body */}
                  <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                      
                     <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 text-sm text-blue-800">
    <h4 className="font-bold mb-2 flex items-center gap-2"><Info className="w-4 h-4"/> ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV</h4>
  <p className="mb-2">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ (13 ‡∏ä‡πà‡∏≠‡∏á):</p>
        <div className="bg-white border border-blue-100 p-3 rounded font-mono text-xs overflow-x-auto whitespace-nowrap mb-2 text-slate-600">
            ‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô, ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡∏ô‡∏±‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó, ‡∏£‡∏≤‡∏Ñ‡∏≤, ‡∏´‡∏ô‡πà‡∏ß‡∏¢, ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤, ‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞, ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á, ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏, ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£, ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
        </div>
    <div className="grid grid-cols-2 md:grid-cols-3 gap-x-8 gap-y-1 text-xs text-blue-700 list-disc pl-4">
        <li><b>‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô:</b> ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ = Auto Gen (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥)</li>
        <li><b>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</b> ‡∏´‡πâ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á</li>
        <li><b>‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡∏ô‡∏±‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå:</b> ‡∏´‡πâ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á</li>
        <li><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</b> <code>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</code> ‡∏´‡∏£‡∏∑‡∏≠ <code>‡πÄ‡∏ä‡πà‡∏≤</code></li>
        <li><b>‡∏£‡∏≤‡∏Ñ‡∏≤:</b> ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏≤‡∏Ñ‡∏≤</li>
        <li><b>‡∏´‡∏ô‡πà‡∏ß‡∏¢:</b> ‡∏ö‡∏≤‡∏ó, ‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô, ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡∏ö‡∏≤‡∏ó/‡∏õ‡∏µ</li>
        <li><b>‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</b> 31/01/2567 ‡∏´‡∏£‡∏∑‡∏≠ 2024-01-31</li>
        <li><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> <code>‡∏ß‡πà‡∏≤‡∏á</code>, <code>‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</code>, <code>‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢</code>, <code>‡∏ä‡∏≥‡∏£‡∏∏‡∏î</code></li>
        <li><b>‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á:</b> ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏∑‡∏≠ '‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°'</li>
        <li><b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</li>
        <li><b>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:</b> ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</li>
    </div>
</div>

                      <div className="mb-6">
                          <div className="flex items-center gap-3">
                              <label className="cursor-pointer bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow-md transition-all flex items-center gap-2 font-bold">
                                  <Upload className="w-4 h-4"/> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV...
                                  <input type="file" accept=".csv" className="hidden" onChange={handleFileImport} />
                              </label>
                              <span className="text-sm text-gray-600 font-medium">{importFileName || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå'}</span>
                          </div>
                      </div>

                     {/* ‚≠ê Preview Table (Editable + Expandable) */}
    {/* [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏•‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç importData.length > 0 ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏•‡∏≠‡∏î */}
    <div className="mt-4">
        <div 
            className={`transition-all duration-200 ${
                isImportAssetTableExpanded 
            ? "fixed inset-0 z-[200] bg-white flex flex-col" // ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠
                : "bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm relative" // ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
            }`}
        >
            {/* Table Header */}
            <div className="px-4 py-3 bg-gray-100 border-b border-gray-200 text-xs font-bold text-gray-600 flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2">
                    <span>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ({importData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ</span>
                    {/* ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏¢‡∏≤‡∏¢/‡∏¢‡πà‡∏≠ */}
                    <button 
                        onClick={() => setIsImportAssetTableExpanded(!isImportAssetTableExpanded)}
                        className="flex items-center gap-1 bg-white border border-gray-300 px-2 py-0.5 rounded hover:bg-blue-50 text-blue-600 transition-colors shadow-sm"
                        title={isImportAssetTableExpanded ? "‡∏¢‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö (Minimize)" : "‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ (Maximize)"}
                    >
                        {isImportAssetTableExpanded ? (
                            <>
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" y1="10" x2="21" y2="3"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
                                <span>‡∏¢‡πà‡∏≠‡∏•‡∏á</span>
                            </>
                        ) : (
                            <>
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
                                <span>‡∏Ç‡∏¢‡∏≤‡∏¢</span>
                            </>
                        )}
                    </button>
                </div>
                
                <span className="text-orange-600 flex items-center gap-1"><AlertTriangle className="w-3 h-3"/> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>
            </div>

            {/* Table Content */}
            <div className={`overflow-x-auto ${isImportAssetTableExpanded ? 'flex-1 p-4 bg-slate-50' : 'max-h-[450px]'}`}>
                <table className={`w-full text-xs text-left whitespace-nowrap ${isImportAssetTableExpanded ? 'shadow-md rounded-lg overflow-hidden' : ''}`}>
                    <thead className="bg-gray-50 text-gray-700 sticky top-0 shadow-sm z-10 font-bold uppercase">
                        <tr>
                            <th className="px-3 py-2 w-8 text-center bg-gray-50">#</th>
                            <th className="px-3 py-2 min-w-[100px] bg-gray-50">‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</th>
                            <th className="px-3 py-2 min-w-[180px] bg-gray-50">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
                            <th className="px-3 py-2 min-w-[200px] bg-gray-50">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th className="px-3 py-2 min-w-[100px] bg-gray-50">S/N</th>
                            <th className="px-3 py-2 min-w-[120px] bg-gray-50">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th className="px-3 py-2 text-right min-w-[120px] bg-gray-50">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                            <th className="px-3 py-2 min-w-[100px] bg-gray-50">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th className="px-3 py-2 min-w-[140px] bg-gray-50">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                            <th className="px-3 py-2 min-w-[140px] bg-gray-50">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
                            <th className="px-3 py-2 min-w-[140px] bg-gray-50">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th className="px-3 py-2 min-w-[180px] bg-gray-50">‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á</th>
                            <th className="px-3 py-2 min-w-[200px] bg-gray-50">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                            <th className="px-3 py-2 min-w-[120px] bg-gray-50">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th className="px-3 py-2 w-10 text-center bg-gray-50">‡∏•‡∏ö</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100 bg-white">
                        {/* [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */}
                        {importData.length === 0 && (
                            <tr>
                                <td colSpan="14" className="text-center py-10 text-gray-400 bg-slate-50">
                                    <div className="flex flex-col items-center gap-2">
                                        <div className="p-3 bg-white rounded-full shadow-sm"><Plus className="w-6 h-6 text-blue-300"/></div>
                                        <span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</span>
                                    </div>
                                </td>
                            </tr>
                        )}

                        {importData.map((row, idx) => (
                            <tr key={idx} className="hover:bg-blue-50 transition-colors group">
                                <td className="px-2 py-2 text-gray-400 text-center">{idx + 1}</td>
                                
                                {/* ID */}
                                <td className="px-2 py-1">
                                    <input 
                                        type="text" className={`w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none font-mono text-blue-600 ${row.id && assets.some(a => a.id === row.id) ? 'text-red-600 font-bold' : ''}`}
                                        value={row.id} 
                                        placeholder="Auto"
                                        onChange={e => {
                                            const newData = [...importData]; newData[idx].id = e.target.value; setImportData(newData);
                                        }}
                                    />
                                    {row.id && assets.some(a => a.id === row.id) && <span className="text-[9px] text-red-500 block">‡∏ã‡πâ‡∏≥!</span>}
                                </td>

                                {/* Project */}
                                <td className="px-2 py-1">
                                    <select 
                                        className={`w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none ${!projects.some(p => p.name === row.project) ? 'text-red-600 font-bold' : 'text-indigo-600'}`}
                                        value={row.project}
                                        onChange={e => { const newData = [...importData]; newData[idx].project = e.target.value; setImportData(newData); }}
                                    >
                                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>
                                        {projects.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                                        </select>
                                </td>

                                {/* Name */}
<td className="px-2 py-1">
    <input 
        type="text" 
        list="import-asset-list" // ‚≠ê ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö Datalist
        className={`w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none ${!row.name ? 'bg-red-50' : ''}`} 
        value={row.name} 
        onChange={e => { const newData = [...importData]; newData[idx].name = e.target.value; setImportData(newData); }}
    />
</td>
                                {/* Serial */}
                                <td className="px-2 py-1"><input type="text" className={`w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none ${!row.serial ? 'bg-red-50' : ''}`} value={row.serial} onChange={e => { const newData = [...importData]; newData[idx].serial = e.target.value; setImportData(newData); }}/></td>
                                
                                {/* Type */}
                                <td className="px-2 py-1">
                                    <select className="w-full bg-transparent outline-none font-bold text-gray-700" 
                                            value={row.ownerType} 
                                            onChange={e => { 
                                                const newData = [...importData];
                                                newData[idx].ownerType = e.target.value; 
                                                setImportData(newData); 
                                            }}>
                                        <option value="Company">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (Company)</option>
                                        <option value="Rent">‡πÄ‡∏ä‡πà‡∏≤ (Rent)</option>
                                    </select>
                                </td>

                                {/* Price */}
                                <td className="px-2 py-1"><input type="number" className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none text-right font-mono" value={row.price} onChange={e => { const newData = [...importData]; newData[idx].price = parseFloat(e.target.value) || 0; setImportData(newData); }}/></td>
                                
                                {/* Unit */}
                                <td className="px-2 py-1">
                                    {row.ownerType === 'Company' ? (
                                        <input type="text" className="w-full bg-gray-50 text-gray-500 text-center cursor-not-allowed border-none text-xs" value="‡∏ö‡∏≤‡∏ó" disabled />
                                    ) : (
                                        <select className="w-full bg-transparent outline-none" 
                                            value={row.rentalUnit} 
                                            onChange={e => { 
                                                const newData = [...importData]; 
                                                newData[idx].rentalUnit = e.target.value; 
                                                setImportData(newData); 
                                            }}>
                                            <option value="Month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                            <option value="Day">‡∏ß‡∏±‡∏ô</option>
                                            <option value="Year">‡∏õ‡∏µ</option>
                                        </select>
                                    )}
                                </td>

                                {/* Start */}
                                <td className="px-2 py-1"><input type="text" placeholder="YYYY-MM-DD" className={`w-full border-b border-transparent outline-none ${row.ownerType === 'Company' ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-transparent text-gray-600 focus:border-blue-500'}`} value={row.rentalStart || ''} onChange={e => { const newData = [...importData]; newData[idx].rentalStart = e.target.value; setImportData(newData); }} disabled={row.ownerType === 'Company'}/></td>
                                
                                {/* End */}
                                <td className="px-2 py-1"><input type="text" placeholder="YYYY-MM-DD" className={`w-full border-b border-transparent outline-none ${row.ownerType === 'Company' ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-transparent text-gray-600 focus:border-blue-500'}`} value={row.rentalEnd || ''} onChange={e => { const newData = [...importData]; newData[idx].rentalEnd = e.target.value; setImportData(newData); }} disabled={row.ownerType === 'Company'}/></td>

                                {/* Status Dropdown */}
                                <td className="px-2 py-1">
                                    <select className={`w-full bg-transparent outline-none font-bold ${row.status === 'Available' ? 'text-green-700' : 'text-blue-700'}`} 
                                            value={row.status} 
                                            onChange={e => { 
                                                const newData = [...importData];
                                                newData[idx].status = e.target.value;
                                                setImportData(newData); 
                                            }}>
                                        <option value="Available">‡∏ß‡πà‡∏≤‡∏á (Available)</option>
                                        <option value="Borrowed">‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏° (Borrowed)</option>
                                        <option value="Lost">‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢ (Lost)</option>
                                        <option value="Damaged">‡∏ä‡∏≥‡∏£‡∏∏‡∏î (Damaged)</option>
                                    </select>
                                </td>

                                {/* Holder */}
                                <td className="px-2 py-1">
                                    <input 
                                        type="text" 
                                        list="import-user-list"
                                        disabled={row.status !== 'Borrowed'} 
                                        className={`w-full border-b outline-none transition-colors ${row.status === 'Borrowed' ?
                                            (!row.holder || row.holder === '-' ? 'bg-red-50 border-red-300 text-red-600 focus:border-blue-500' : 'bg-transparent border-transparent focus:border-blue-500') : 'bg-gray-100 text-gray-400 border-transparent cursor-not-allowed'}`} 
                                        value={row.status === 'Borrowed' ? row.holder : ''} 
                                        placeholder={row.status === 'Borrowed' ? "‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å..." : "-"} 
                                        onChange={e => { 
                                            const newData = [...importData]; 
                                            newData[idx].holder = e.target.value;
                                            setImportData(newData); 
                                        }}
                                    />
                                </td>

                                {/* Note */}
                                <td className="px-2 py-1">
    <input 
        type="text" 
        className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none text-gray-500" 
        value={row.note} 
        onChange={e => { 
            const n = [...importData]; 
            n[idx].note = e.target.value; 
            setImportData(n); // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å newData ‡πÄ‡∏õ‡πá‡∏ô n
        }}
    />
</td>

                                <td className="px-2 py-1">
    <input 
        type="text" 
        list="supplier-list-options"
        className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none text-gray-600" 
        value={row.supplier} 
        onChange={e => { 
            const n = [...importData]; 
            n[idx].supplier = e.target.value; 
            setImportData(n); // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å newData ‡πÄ‡∏õ‡πá‡∏ô n
        }}
    />
</td>
                                
                                {/* Delete */}
                                <td className="px-2 py-1 text-center">
                                    <button 
                                        type="button"
                                        onClick={() => { 
                                            const newData = importData.filter((_, i) => i !== idx); 
                                            setImportData(newData); 
                                        }} 
                                        className="text-gray-400 hover:text-red-600 p-1.5 rounded-lg hover:bg-red-50 transition-colors"
                                        title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M3 6h18"/>
                                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                            <line x1="10" x2="10" y1="11" y2="17"/>
                                            <line x1="14" x2="14" y1="11" y2="17"/>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏•‡∏≠‡∏î) */}
            <button
                onClick={() => {
                    const newRow = {
                        id: '',         // Auto
                        project: '',      // ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
                        name: '',
                        serial: '',
                        ownerType: 'Company', // Default
                        price: 0,
                        rentalUnit: 'baht',   // Default for Company
                        rentalStart: '',
                        rentalEnd: '',
                        status: 'Available',  // Default
                        holder: '',
                        note: ''
                    };
                    setImportData(prev => [...prev, newRow]);
                }}
                className="w-full py-3 bg-gray-50 hover:bg-blue-50 text-blue-600 font-bold text-xs border-t border-gray-200 flex items-center justify-center gap-2 transition-colors"
            >
                <Plus className="w-4 h-4"/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà (Add Row)
            </button>

        </div>
    </div>
                         
                  </div>

                  {/* Footer */}
                  <div className="p-5 border-t border-gray-100 bg-white flex gap-3 justify-end">
                      <button onClick={() => setShowImportAssetModal(false)} className="px-6 py-2.5 border border-gray-300 rounded-xl text-gray-600 font-bold hover:bg-gray-50 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                      <button 
                          onClick={confirmImportAssets} 
                          disabled={importData.length === 0}
                          className="px-6 py-2.5 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                      >
                          <Save className="w-5 h-5"/> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                      </button>
                  </div>
              </div>
          </div>
      )}

{/* --- ASSET GROUP MODAL (UPDATED: Clean Table & Fixed Close Button) --- */}
      {showAssetGroupModal && selectedAssetGroup && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[120] p-4 backdrop-blur-sm animate-in fade-in">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden animate-in zoom-in-95">
                  
                  {/* Header */}
                  <div className="px-6 py-4 border-b bg-white flex justify-between items-center sticky top-0 z-10">
                      <div>
                          <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2">
                              <Box className="w-6 h-6 text-purple-600"/> {selectedAssetGroup.name}
                          </h3>
                          <div className="flex gap-3 text-xs mt-1">
                              <span className="text-gray-500">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b className="text-gray-800">{selectedAssetGroup.totalQty}</b></span>
                              <span className="text-blue-600 bg-blue-50 px-2 py-0.5 rounded">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: <b>{selectedAssetGroup.companyQty}</b></span>
                              <span className="text-orange-600 bg-orange-50 px-2 py-0.5 rounded">‡πÄ‡∏ä‡πà‡∏≤: <b>{selectedAssetGroup.rentQty}</b></span>
                          </div>
                      </div>
                      
                      {/* ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á (‡πÉ‡∏ä‡πâ SVG ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î) */}
                      <button 
                          onClick={() => setShowAssetGroupModal(false)} 
                          className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
                          title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á"
                      >
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                              <line x1="18" y1="6" x2="6" y2="18"></line>
                              <line x1="6" y1="6" x2="18" y2="18"></line>
                          </svg>
                      </button>
                  </div>

                  {/* List of Items */}
                  <div className="flex-1 overflow-y-auto p-0">
                      <table className="w-full text-sm text-left">
                          <thead className="bg-gray-50 text-gray-600 sticky top-0 shadow-sm border-b border-gray-200">
                              <tr>
                                  <th className="px-6 py-3 font-semibold">ID</th>
                                  
                                  {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á Project */}
                                  <th className="px-6 py-3 font-semibold text-left">Project</th>

                                  <th className="px-6 py-3 font-semibold">Serial</th>
                                  <th className="px-6 py-3 font-semibold">Type</th>
                                  <th className="px-6 py-3 font-semibold text-center">Status</th>
                                  <th className="px-6 py-3 font-semibold">Holder</th>
                              </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-100">
                              {selectedAssetGroup.items.map((item, idx) => (
                                  <tr key={idx} className="hover:bg-blue-50 transition-colors cursor-pointer group" 
                                      onClick={() => {
                                          openViewItem(item);
                                      }}
                                  >
                                      <td className="px-6 py-4 font-mono text-blue-600 font-bold group-hover:underline">{item.id}</td>
                                      
                                      {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Project */}
                                      <td className="px-6 py-4">
                                          <span className="bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-100 text-xs font-bold">
                                              {item.project || '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á'}
                                          </span>
                                      </td>

                                      <td className="px-6 py-4 text-gray-600">{item.serial || '-'}</td>
                                      <td className="px-6 py-4">
                                          <span className={`px-2 py-1 rounded text-xs font-bold ${item.ownerType === 'Rent' ? 'bg-orange-100 text-orange-700' : 'bg-indigo-100 text-indigo-700'}`}>
                                              {item.ownerType}
                                          </span>
                                      </td>
                                      <td className="px-6 py-4 text-center">
    <span className={`px-2 py-1 rounded text-xs font-bold ${
        item.status === 'Available' ? 'bg-green-100 text-green-700' :
        item.status === 'Borrowed' ? 'bg-orange-100 text-orange-700' : 'bg-gray-100'
    }`}>
        {/* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ */}
        {ASSET_STATUS_LABELS[item.status] || item.status}
    </span>
</td>
                                      <td className="px-6 py-4 text-gray-700">{item.holder}</td>
                                  </tr>
                              ))}
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      )}

{/* --- IMPORT INVENTORY MODAL (UPDATED NO ID) --- */}
      {showImportInvModal && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-in fade-in">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden">

              {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° Datalist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Inventory */}
<datalist id="import-inventory-list">
    {[...new Set(inventory.map(i => i.name))].map((name, i) => (
        <option key={i} value={name}/>
    ))}
</datalist>

<datalist id="supplier-list-options">
                  {[...new Set(invLogs.map(l => l.supplier).filter(s => s))].map((s, i) => (
                      <option key={i} value={s} />
                  ))}
              </datalist>
                  
                  {/* Header */}
                  <div className="px-6 py-4 border-b flex justify-between items-center bg-white">
                      <h3 className="font-bold text-lg text-teal-700 flex items-center gap-2">
                          <FileText className="w-5 h-5"/> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Import Inventory CSV)
                      </h3>
                      <button onClick={() => setShowImportInvModal(false)} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100">
                          <X className="w-6 h-6"/>
                      </button>
                  </div>

                {/* Body */}
<div className="flex-1 overflow-y-auto p-6 bg-slate-50">
    
    <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 text-sm text-blue-800">
        <h4 className="font-bold mb-2 flex items-center gap-2"><Info className="w-4 h-4"/> ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)</h4>
<p className="mb-2">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ (10 ‡∏ä‡πà‡∏≠‡∏á):</p>
        <div className="bg-white border border-blue-100 p-3 rounded font-mono text-xs overflow-x-auto whitespace-nowrap mb-2 text-slate-600">
            ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏, ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô, ‡∏´‡∏ô‡πà‡∏ß‡∏¢, ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥, ‡∏£‡∏≤‡∏Ñ‡∏≤, ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏, ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£, ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
        </div>
        <div className="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-1 text-xs text-blue-700 list-disc pl-4">
            <li><b>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏:</b> ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ = ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (INV-xxx)</li>
            <li><b>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</b> ‡∏´‡πâ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß = ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î)</li>
            <li><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</b> ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö, ‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏´‡∏£‡∏∑‡∏≠ System, NonSystem)</li>
            <li><b>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</b> ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</li>
            <li><b>‡∏´‡∏ô‡πà‡∏ß‡∏¢:</b> ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏ä‡∏¥‡πâ‡∏ô)</li>
            <li><b>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥:</b> ‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Min Stock)</li>
            <li><b>‡∏£‡∏≤‡∏Ñ‡∏≤:</b> ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</li>
            <li><b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</li>
            <li><b>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:</b> ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)</li>
        </div>
    </div>

    <div className="mb-6">
        <div className="flex items-center gap-3">
            <label className="cursor-pointer bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg shadow-md transition-all flex items-center gap-2 font-bold">
                <Upload className="w-4 h-4"/> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV...
                <input type="file" accept=".csv" className="hidden" onChange={handleInvFileImport} />
            </label>
            <span className="text-sm text-gray-600 font-medium">{importInvFileName || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå'}</span>
        </div>
    </div>

    {/* Table Preview */}
  {/* Table Preview */}
    {/* [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏•‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç importInvData.length > 0 ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏•‡∏≠‡∏î */}
    <div className="mt-4">
        <div className={`transition-all duration-200 ${isImportInvTableExpanded ? "fixed inset-0 z-[200] bg-white flex flex-col" : "bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm relative"}`}>
            
            {/* Header Table */}
            <div className="px-4 py-3 bg-gray-100 border-b border-gray-200 text-xs font-bold text-gray-600 flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2">
                     <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ({importInvData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                    <button onClick={() => setIsImportInvTableExpanded(!isImportInvTableExpanded)} className="flex items-center gap-1 bg-white border border-gray-300 px-2 py-0.5 rounded hover:bg-blue-50 text-blue-600 transition-colors shadow-sm">
                        {isImportInvTableExpanded ? <span>‡∏¢‡πà‡∏≠‡∏•‡∏á</span> : <span>‡∏Ç‡∏¢‡∏≤‡∏¢</span>}
                    </button>
                </div>
                <span className="text-orange-600 flex items-center gap-1"><AlertTriangle className="w-3 h-3"/> ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏: ‡∏ß‡πà‡∏≤‡∏á = Auto Gen</span>
            </div>

            {/* Table Content */}
            <div className={`overflow-x-auto ${isImportInvTableExpanded ? 'flex-1 p-4 bg-slate-50' : 'max-h-[450px]'}`}>
                <table className={`w-full text-xs text-left whitespace-nowrap ${isImportInvTableExpanded ? 'shadow-md rounded-lg overflow-hidden' : ''}`}>
                    <thead className="bg-gray-50 text-gray-700 sticky top-0 shadow-sm z-10 font-bold uppercase">
                        <tr>
                            <th className="px-3 py-2 w-8 text-center bg-gray-50">#</th>
                            <th className="px-3 py-2 min-w-[100px] bg-gray-50">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏</th>
                            <th className="px-3 py-2 min-w-[150px] bg-gray-50">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th className="px-3 py-2 min-w-[120px] bg-gray-50">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
                            <th className="px-3 py-2 w-28 bg-gray-50">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th className="px-3 py-2 w-20 text-center bg-gray-50">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th className="px-3 py-2 w-20 bg-gray-50">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th className="px-3 py-2 w-20 text-center bg-gray-50">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th>
                            <th className="px-3 py-2 w-24 text-right bg-gray-50">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                            <th className="px-3 py-2 min-w-[150px] bg-gray-50">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                            <th className="px-3 py-2 min-w-[120px] bg-gray-50">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th className="px-3 py-2 w-10 text-center bg-gray-50">‡∏•‡∏ö</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100 bg-white">
                        {/* [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */}
                        {importInvData.length === 0 && (
                            <tr>
                                <td colSpan="11" className="text-center py-10 text-gray-400 bg-slate-50">
                                    <div className="flex flex-col items-center gap-2">
                                        <div className="p-3 bg-white rounded-full shadow-sm"><Plus className="w-6 h-6 text-blue-300"/></div>
                                        <span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</span>
                                    </div>
                                </td>
                            </tr>
                        )}

                        {importInvData.map((row, idx) => {
                            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                            const existing = inventory.find(i => i.name === row.name && i.project === row.project);
                            const isDuplicate = !!existing;
                            const isIdMismatch = isDuplicate && row.id && row.id !== existing.id;

                            return (
                                <tr key={idx} className={`hover:bg-blue-50 transition-colors group ${isDuplicate ? 'bg-yellow-50' : ''}`}>
                                    <td className="px-2 py-2 text-gray-400 text-center">{idx + 1}</td>
                                    
                                    {/* ID (‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏) */}
                                    <td className="px-2 py-1 relative">
                                        <input 
                                            type="text" 
                                            className={`w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none font-mono text-blue-600 ${isIdMismatch ? 'text-red-600 font-bold' : ''}`}
                                            value={getDisplayId(row.id)} 
                                            placeholder={existing ? getDisplayId(existing.id) : "Auto"}
                                            onChange={e => { const n = [...importInvData]; n[idx].id = e.target.value; setImportInvData(n); }}
                                        />
                                        
                                        {/* ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏° */}
                                        {isDuplicate && row.id !== getDisplayId(existing.id) && (
                                            <button 
                                                onClick={() => { const n = [...importInvData]; n[idx].id = getDisplayId(existing.id); setImportInvData(n); }}
                                                className="absolute right-0 top-1 text-[9px] bg-green-100 text-green-700 px-1 rounded border border-green-200 hover:bg-green-200"
                                                title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"
                                            >
                                                ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏°
                                            </button>
                                        )}
                                    </td>

                                    {/* Name */}
<td className="px-2 py-1">
    <input 
        type="text" 
        list="import-inventory-list" // ‚≠ê ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö Datalist
        className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none font-bold text-gray-800" 
        value={row.name} 
        onChange={e => { const n = [...importInvData]; n[idx].name = e.target.value; setImportInvData(n); }}
    />
</td>

                                    {/* Project */}
                                    <td className="px-2 py-1">
                                        <select className={`w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none ${!projects.some(p => p.name === row.project) ? 'text-red-600 font-bold' : 'text-blue-600'}`} value={row.project} onChange={e => { const n = [...importInvData]; n[idx].project = e.target.value; setImportInvData(n); }}>
                                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>
                                            {projects.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                                        </select>
                                    </td>

                                    {/* Type */}
                                    <td className="px-2 py-1">
                                        <select className={`w-full bg-transparent outline-none font-bold ${row.stockType === 'NonSystem' ? 'text-orange-600' : 'text-blue-600'}`} value={row.stockType} onChange={e => { const n = [...importInvData]; n[idx].stockType = e.target.value; setImportInvData(n); }}>
                                            <option value="System">‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</option>
                                            <option value="NonSystem">‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</option>
                                        </select>
                                    </td>

                                    {/* Qty */}
                                    <td className="px-2 py-1"><input type="number" className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none text-center font-bold text-blue-600" value={row.qty} onChange={e => { const n = [...importInvData]; n[idx].qty = parseInt(e.target.value)||0; setImportInvData(n); }}/></td>
                                    
                                    {/* Unit */}
                                    <td className="px-2 py-1">
                                        <input type="text" list="unit-list" className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none" value={row.unit} onChange={e => { const n = [...importInvData]; n[idx].unit = e.target.value; setImportInvData(n); }}/>
                                        <datalist id="unit-list">{ITEM_UNITS.map(u => <option key={u} value={u}/>)}</datalist>
                                    </td>

                                    {/* Min */}
                                    <td className="px-2 py-1"><input type="number" className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none text-center" value={row.minStock} onChange={e => { const n = [...importInvData]; n[idx].minStock = parseInt(e.target.value)||0; setImportInvData(n); }}/></td>
                                    
                                    {/* Price */}
                                    <td className="px-2 py-1"><input type="number" className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none text-right font-mono" value={row.price} onChange={e => { const n = [...importInvData]; n[idx].price = parseFloat(e.target.value)||0; setImportInvData(n); }}/></td>
                                    
                                    {/* Note */}
                                    <td className="px-2 py-1"><input type="text" className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none text-gray-500" value={row.note} onChange={e => { const n = [...importInvData]; n[idx].note = e.target.value; setImportInvData(n); }}/></td>

                                    <td className="px-2 py-1">
                                        <input 
                                            type="text" 
                                            list="supplier-list-options" 
                                            className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none text-gray-600" 
                                            value={row.supplier} 
                                            onChange={e => { const n = [...importInvData]; n[idx].supplier = e.target.value; setImportInvData(n); }}
                                        />
                                    </td>

                                    {/* Delete */}
                                    <td className="px-2 py-1 text-center">
                                        <button onClick={() => { const n = importInvData.filter((_, i) => i !== idx); setImportInvData(n); }} className="text-gray-400 hover:text-red-600 p-1.5 rounded-lg hover:bg-red-50 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                        </button>
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>

            {/* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏•‡∏≠‡∏î) */}
            <button
                onClick={() => {
                    const newRow = {
                        id: '', // Auto
                        project: '', 
                        name: '',
                        stockType: 'System', 
                        qty: 0,
                        unit: '‡∏ä‡∏¥‡πâ‡∏ô',
                        minStock: 0,
                        price: 0,
                        note: ''
                    };
                    setImportInvData(prev => [...prev, newRow]);
                }}
                className="w-full py-3 bg-gray-50 hover:bg-blue-50 text-blue-600 font-bold text-xs border-t border-gray-200 flex items-center justify-center gap-2 transition-colors"
            >
                <Plus className="w-4 h-4"/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà (Add Row)
            </button>
        </div>
    </div>
</div>

                  {/* Footer */}
                  <div className="p-5 border-t border-gray-100 bg-white flex gap-3 justify-end">
                      <button onClick={() => setShowImportInvModal(false)} className="px-6 py-2.5 border border-gray-300 rounded-xl text-gray-600 font-bold hover:bg-gray-50 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                      <button 
                          onClick={confirmImportInventory} 
                          disabled={importInvData.length === 0}
                          className="px-6 py-2.5 bg-teal-600 text-white rounded-xl font-bold hover:bg-teal-700 shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                      >
                          <Save className="w-5 h-5"/> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                      </button>
                  </div>
              </div>
          </div>
      )}

      {/* --- PERMISSION MODAL --- */}
      {showPermissionModal && selectedUserForEdit && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[200] p-4 backdrop-blur-sm animate-in fade-in">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden">
                  
                  {/* ... Header ... */}
                  <div className="px-6 py-4 border-b bg-white flex justify-between items-center">
                      <div>
                          <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2">
                              <ShieldCheck className="w-6 h-6 text-blue-600"/> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: {selectedUserForEdit.firstName} {selectedUserForEdit.lastName}
                          </h3>
                          <p className="text-sm text-gray-500 mt-1">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</p>
                      </div>
                      <button onClick={() => setShowPermissionModal(false)}><X className="w-6 h-6 text-gray-400 hover:text-gray-600"/></button>
                  </div>

                  <div className="flex-1 flex overflow-hidden">
                      {/* Left: Project List */}
                      <div className="w-1/4 bg-gray-50 border-r overflow-y-auto">
                          {projects.map(p => (
                              <button 
                                  key={p.id}
                                  onClick={() => setPermissionTab(p.name)}
                                  className={`w-full text-left px-4 py-3 text-sm font-bold border-b transition-colors flex justify-between items-center ${permissionTab === p.name ? 'bg-white text-blue-600 border-l-4 border-l-blue-600 shadow-sm' : 'text-gray-600 hover:bg-gray-100'}`}
                              >
                                  {p.name}
                                  <span className="bg-gray-200 text-gray-600 text-[10px] px-2 py-0.5 rounded-full">
                                      {(selectedUserForEdit.permissions?.[p.name] || []).length}
                                  </span>
                              </button>
                          ))}
                      </div>

                      {/* Right: Checkboxes List */}
                      <div className="flex-1 overflow-y-auto p-6 bg-white">
                          <div className="flex justify-between items-center mb-4">
                              <h4 className="font-bold text-lg text-gray-800">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: <span className="text-blue-600">{permissionTab}</span></h4>
                              {/* ‡∏õ‡∏∏‡πà‡∏° Select All / Clear (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ Admin=2) */}
                              {hasPermission(2, permissionTab) && (
                                  <div className="space-x-2">
                                      <button onClick={() => {
    // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏ï‡πà‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô 1 (Read Only) ‡πÅ‡∏•‡∏∞ 2 (Admin)
    const allIds = Object.keys(PERMISSIONS).map(Number).filter(id => id !== 1 && id !== 2);
    
    const newPerms = { ...selectedUserForEdit.permissions, [permissionTab]: allIds };
    setSelectedUserForEdit({ ...selectedUserForEdit, permissions: newPerms });
}} className="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                      <button onClick={() => {
                                          const newPerms = { ...selectedUserForEdit.permissions, [permissionTab]: [] };
                                          setSelectedUserForEdit({ ...selectedUserForEdit, permissions: newPerms });
                                      }} className="text-xs bg-gray-100 text-gray-600 px-3 py-1.5 rounded hover:bg-gray-200">‡∏•‡πâ‡∏≤‡∏á</button>
                                  </div>
                              )}
                          </div>
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
{Object.entries(PERMISSIONS).map(([id, label]) => {
    const permId = parseInt(id);
    const currentProjectPerms = selectedUserForEdit.permissions?.[permissionTab] || [];
    const isChecked = currentProjectPerms.includes(permId);

    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Edit Logic)
    let canEdit = false;
    if (user.isSuperAdmin) canEdit = true;
    else if (hasPermission(2, permissionTab)) canEdit = true;
    else if (hasPermission(3, permissionTab)) {
        if ([4, 5, 6, 7].includes(permId)) canEdit = true;
    }

    // 2. Logic ‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏° (Lock Logic)
    const hasReadOnly = currentProjectPerms.includes(1);
    const hasAdmin = currentProjectPerms.includes(2);
    
    let isLocked = false;
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå "‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß" ‡∏´‡∏£‡∏∑‡∏≠ "Admin" ‡∏≠‡∏¢‡∏π‡πà -> ‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    if ((hasReadOnly && permId !== 1) || (hasAdmin && permId !== 2)) {
        isLocked = true;
    }

    const isInteractive = canEdit && !isLocked;

    return (
        <label key={id} className={`flex items-start gap-3 p-3 rounded-lg border transition-all ${isInteractive ? 'cursor-pointer hover:border-gray-300' : 'cursor-not-allowed opacity-40 bg-gray-100'} ${isChecked ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-100'}`}>
            <div className="pt-0.5">
                <input 
                    type="checkbox" 
                    className="w-4 h-4 accent-blue-600"
                    checked={isChecked}
                    disabled={!isInteractive} 
                    onChange={(e) => {
                        let newList;
                        
                        if (e.target.checked) {
                            // ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                            if (permId === 1) {
                                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß" -> ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏≠‡∏Å‡∏´‡∏°‡∏î ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà [1]
                                newList = [1];
                            } else if (permId === 2) {
                                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Admin" -> ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏≠‡∏Å‡∏´‡∏°‡∏î ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà [2]
                                newList = [2];
                            } else {
                                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô -> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏≠‡∏≤ 1, 2 ‡∏≠‡∏≠‡∏Å‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
                                newList = [...currentProjectPerms.filter(x => x !== 1 && x !== 2), permId];
                            }
                        } else {
                            // ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏≠‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏≠‡∏≠‡∏Å
                            newList = currentProjectPerms.filter(x => x !== permId);
                        }

                        setSelectedUserForEdit({
                            ...selectedUserForEdit,
                            permissions: { ...selectedUserForEdit.permissions, [permissionTab]: newList }
                        });
                    }}
                />
            </div>
            <div>
                <span className={`text-sm ${isChecked ? 'font-bold text-gray-800' : 'text-gray-600'}`}>{label}</span>
            </div>
        </label>
    );
})}
                          </div>
                      </div>
                  </div>

                  {/* Footer */}
                  <div className="p-5 border-t bg-white flex justify-end gap-3">
                      <button onClick={() => setShowPermissionModal(false)} className="px-6 py-2 border rounded-lg text-gray-600 hover:bg-gray-50">‡∏õ‡∏¥‡∏î</button>
                      
          {/* ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Admin ‡∏´‡∏£‡∏∑‡∏≠ Sub-Admin) */}
{(hasPermission(2, permissionTab) || hasPermission(3, permissionTab)) && (
<button 
    onClick={async () => {
        // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Sheet
        google.script.run.saveUserData(selectedUserForEdit);
        
        // 2. ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á Log ‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Loop ‡∏ó‡∏∏‡∏Å Project ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)
        let logLines = [];
        if (selectedUserForEdit.permissions) {
            Object.entries(selectedUserForEdit.permissions).forEach(([projName, rights]) => {
                // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
                if (projName && projName !== 'undefined' && rights && rights.length > 0) {
                    logLines.push(`Project: ${projName} -> Rights: [${rights.join(', ')}]`);
                }
            });
        }
        
        // ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà (\n)
        const logDetail = logLines.length > 0 ? logLines.join('\n') : 'Removed all permissions';

        await addInvLog(
            'Edit Permissions', 
            `${selectedUserForEdit.empId} ${selectedUserForEdit.firstName}`, 
            logDetail, // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
            JSON.stringify(selectedUserForEdit.permissions || {}),
            [], 
            selectedUserForEdit.id
        );

        // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        setAllUsers(prev => prev.map(u => u.id === selectedUserForEdit.id ? selectedUserForEdit : u));
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        setShowPermissionModal(false);
    }} 
    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md font-bold"
>
    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
</button>
)}
                  </div>
              </div>
          </div>
      )}


{viewingUser && (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-in fade-in duration-200">
        <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden relative">
            
            {/* 1. Header & Close Button */}
            <div className="p-4 border-b flex justify-between items-center bg-gray-50 shrink-0">
                <div className="flex items-center gap-4">
                    <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-700 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg">
                        {viewingUser.firstName?.charAt(0)}
                    </div>
                    <div>
                        <h3 className="font-bold text-xl text-gray-800">{viewingUser.firstName} {viewingUser.lastName}</h3>
                        <p className="text-sm text-gray-500 font-medium">{viewingUser.empId} | {viewingUser.email}</p>
                    </div>
                </div>
                <button onClick={() => setViewingUser(null)} className="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>

            {/* 2. Tabs Navigation */}
            <div className="flex border-b bg-white px-6 pt-2 shrink-0 overflow-x-auto">
                {[
                    { id: 'info', icon: User, label: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ & ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå' },
                    { id: 'history', icon: Clock, label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' },
                    { id: 'purchase', icon: ShoppingCart, label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠' },
                    { id: 'withdraw', icon: Package, label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å' },
                    { id: 'borrow', icon: Briefcase, label: '‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà' }
                ].map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => { setUserDetailTab(tab.id); setDetailSearch(''); }}
                        className={`px-5 py-3 text-sm font-bold border-b-[3px] transition-colors flex items-center gap-2 whitespace-nowrap ${userDetailTab === tab.id ? 'border-blue-600 text-blue-700 bg-blue-50/50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}`}
                    >
                        <tab.icon size={16}/> {tab.label}
                    </button>
                ))}
            </div>

            {/* 3. Search Bar Area */}
            {(userDetailTab === 'history' || userDetailTab === 'purchase' || userDetailTab === 'withdraw' || userDetailTab === 'borrow') && (
                <div className="px-6 py-3 bg-white border-b flex justify-between items-center shrink-0">
                    <div className="flex items-center gap-2 text-gray-700 font-bold text-sm">
                        <Filter size={16} className="text-blue-600"/> 
                        ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </div>
                    <div className="relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"/>
                        <input 
                            type="text" 
                            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." 
                            className="pl-9 pr-3 py-1.5 border rounded-lg text-sm w-64 focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 focus:bg-white transition-colors"
                            value={detailSearch} onChange={e => setDetailSearch(e.target.value)}
                        />
                    </div>
                </div>
            )}

            {/* 4. Content Area */}
            <div id="user-modal-scroll" className="p-0 overflow-y-auto flex-1 bg-gray-50/50 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent relative scroll-smooth">
                
             {/* Tab 1: Info (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏µ‡πÄ‡∏°‡∏•) */}
           {/* Tab 1: Info (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) */}
                {userDetailTab === 'info' && (
                     <div className="p-6">
                         <div className="bg-white p-6 rounded-xl shadow-sm border space-y-6">
                  
                             {/* Basic Info Header */}
                             <div className="flex justify-between items-center border-b pb-2 mb-4">
                                 <h4 className="font-bold text-gray-800 flex gap-2"><User size={18}/> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h4>
                                {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 1: ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å - ‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ SuperAdmin, Admin(2), Sub-Admin(3) ‡πÄ‡∏´‡πá‡∏ô */}
                                {(user.id === viewingUser.id || user.isSuperAdmin || hasPermission(2) || hasPermission(3)) && (
                                    <button 
                                        onClick={async () => {
                                            // ... (Logic ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏î‡∏¥‡∏° ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
                                            // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡πÄ‡∏î‡∏¥‡∏°
                                            const originalUser = allUsers.find(u => u.id === viewingUser.id);
                                            if (!originalUser) return;

                                            // Validation
                                            if (!viewingUser.empId || !viewingUser.firstName || !viewingUser.lastName) {
                                                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏£‡∏´‡∏±‡∏™, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•)', 'error');
                                                return;
                                            }

                                            setIsLoading(true);
                                            try {
                                                const changeDetails = [];
                                                let newSignatureUrl = viewingUser.signature;
                                                let sigChanged = false;

                                                // --- A. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô ---
                                                if (sigMode === 'Draw' && hasDrawn) {
                                                    const canvas = sigCanvasRef.current;
                                                    const dataUrl = canvas.toDataURL('image/png');
                                                    const res = await new Promise((resolve, reject) => {
                                                        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)
                                                            .uploadUserSignature(dataUrl, `SIG_${viewingUser.empId}_${Date.now()}.png`);
                                                    });
                                                    if (res.url) {
                                                        newSignatureUrl = res.url;
                                                        changeDetails.push("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà)");
                                                        sigChanged = true;
                                                    }
                                                } else if (sigMode === 'Upload' && signatureFile) {
                                                    const base64 = await fileToBase64(signatureFile);
                                                    const res = await new Promise((resolve, reject) => {
                                                        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)
                                                            .uploadUserSignature(base64, `SIG_${viewingUser.empId}_${Date.now()}_${signatureFile.name}`);
                                                    });
                                                    if (res.url) {
                                                        newSignatureUrl = res.url;
                                                        changeDetails.push("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå)");
                                                        sigChanged = true;
                                                    }
                                                }

                                                // --- B. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
                                                if (originalUser.empId !== viewingUser.empId) changeDetails.push(`‡∏£‡∏´‡∏±‡∏™: ${originalUser.empId} -> ${viewingUser.empId}`);
                                                if (originalUser.firstName !== viewingUser.firstName) changeDetails.push(`‡∏ä‡∏∑‡πà‡∏≠: ${originalUser.firstName} -> ${viewingUser.firstName}`);
                                                if (originalUser.lastName !== viewingUser.lastName) changeDetails.push(`‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•: ${originalUser.lastName} -> ${viewingUser.lastName}`);
                                                
                                                if (changeDetails.length === 0 && !sigChanged) {
                                                    setIsLoading(false);
                                                    showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á');
                                                    return;
                                                }

                                                // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                                const userToSave = { ...viewingUser, signature: newSignatureUrl };
                                                
                                                // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
                                                const saveRes = await new Promise(resolve => {
                                                    google.script.run.withSuccessHandler(resolve).saveUserData(userToSave);
                                                });
                                                
                                                if (!saveRes.success) {
                                                    setIsLoading(false);
                                                    showToast(saveRes.message, 'error');
                                                    return;
                                                }

                                                // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log
                                                const logImages = sigChanged ? [{name: 'New Signature', type: 'image/png', url: newSignatureUrl}] : [];
                                                await addInvLog('Edit Profile', `${viewingUser.empId} ${viewingUser.firstName}`, `Updated Profile`, `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:\n- ${changeDetails.join('\n- ')}`, logImages, null, null);

                                                // 3. Global Update (‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
                                                const isIdentityChanged = (originalUser.empId !== viewingUser.empId) || (originalUser.firstName !== viewingUser.firstName) || (originalUser.lastName !== viewingUser.lastName);

                                                if (isIdentityChanged) {
                                                     const oldData = { empId: originalUser.empId, firstName: originalUser.firstName, lastName: originalUser.lastName };
                                                     const newData = { empId: viewingUser.empId, firstName: viewingUser.firstName, lastName: viewingUser.lastName };
                                                     const updateRes = await new Promise(r => google.script.run.withSuccessHandler(r).updateUserGlobalData(oldData, newData));
                                                     showToast(updateRes.message);
                                                } else {
                                                     showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                                                }
                                                
                                                // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                                                setAllUsers(prev => prev.map(u => u.id === viewingUser.id ? userToSave : u));
                                                setViewingUser(userToSave);
                                                if (user.id === viewingUser.id) setUser(userToSave);
                                                
                                                if(sigCanvasRef.current) clearSignature();
                                                setSignatureFile(null);
                                                setHasDrawn(false);

                                            } catch (err) {
                                                console.error(err);
                                                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
                                            } finally {
                                                setIsLoading(false);
                                            }
                                        }}
                                        className="bg-blue-600 text-white px-4 py-1.5 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md flex items-center gap-2 transition-all"
                                    >
                                        <Save size={14}/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                    </button>
                                )}
                             </div>

      {/* Form Inputs */}
                             <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin/Sub-Admin) */}
                                {(() => {
                                    const canEditBasicInfo = user.isSuperAdmin || hasPermission(2) || hasPermission(3);
                                    
                                    return (
                                        <>
                                            {/* 1. ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Emp ID) */}
                                            <div>
                                                <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Emp ID)</label>
                                                {canEditBasicInfo ? (
                                                    <input 
                                                        type="text" 
                                                        className="w-full p-2.5 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                                        value={viewingUser.empId}
                                                        onChange={e => setViewingUser({...viewingUser, empId: e.target.value})}
                                                    />
                                                ) : (
                                                    <div className="w-full p-2.5 bg-gray-50 rounded-lg text-sm font-bold text-gray-800 border border-transparent">
                                                        {viewingUser.empId}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* 2. ‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Email) */}
                                            <div>
                                                <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Email)</label>
                                                {/* ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏õ‡∏Å‡∏ï‡∏¥‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡∏Å‡πá‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */}
                                                {canEditBasicInfo ? (
                                                    <input 
                                                        type="email" 
                                                        className="w-full p-2.5 border rounded-lg bg-gray-100 text-gray-500 focus:outline-none"
                                                        value={viewingUser.email}
                                                        disabled // ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô Admin (‡∏ï‡∏≤‡∏° Code ‡πÄ‡∏î‡∏¥‡∏°) ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤ disabled ‡∏≠‡∏≠‡∏Å
                                                    />
                                                ) : (
                                                    <div className="w-full p-2.5 bg-gray-50 rounded-lg text-sm font-bold text-gray-800 border border-transparent">
                                                        {viewingUser.email}
                                                    </div>
                                                )}
                                            </div>

                                            {/* 3. ‡∏ä‡∏∑‡πà‡∏≠ (First Name) */}
                                            <div>
                                                <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠ (First Name)</label>
                                                {canEditBasicInfo ? (
                                                    <input 
                                                        type="text" 
                                                        className="w-full p-2.5 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                                        value={viewingUser.firstName}
                                                        onChange={e => setViewingUser({...viewingUser, firstName: e.target.value})}
                                                    />
                                                ) : (
                                                    <div className="w-full p-2.5 bg-gray-50 rounded-lg text-sm font-bold text-gray-800 border border-transparent">
                                                        {viewingUser.firstName}
                                                    </div>
                                                )}
                                            </div>
                                          
                                            {/* 4. ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (Last Name) */}
                                            <div>
                                                <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (Last Name)</label>
                                                {canEditBasicInfo ? (
                                                    <input 
                                                        type="text" 
                                                        className="w-full p-2.5 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                                        value={viewingUser.lastName}
                                                        onChange={e => setViewingUser({...viewingUser, lastName: e.target.value})}
                                                    />
                                                ) : (
                                                    <div className="w-full p-2.5 bg-gray-50 rounded-lg text-sm font-bold text-gray-800 border border-transparent">
                                                        {viewingUser.lastName}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* 5. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status) */}
                                            <div>
                                                <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status)</label>
                                                <div className={`p-2.5 rounded-lg font-bold flex justify-between items-center ${viewingUser.status==='Activated'?'text-green-600 bg-green-50 border border-green-100':'text-red-600 bg-red-50 border border-red-100'}`}>
                                                    {viewingUser.status}
                                                    
                                                    {/* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin/Sub-Admin */}
                                                    {(user?.isSuperAdmin || hasPermission(2) || hasPermission(3)) && (
                                                        <button 
                                                            onClick={async () => {
                                                                const isActive = viewingUser.status === 'Activated'; 
                                                                const newStatus = isActive ? 'Deactivated' : 'Activated';
                                                                if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${newStatus}?`)) {
                                                                    const updated = {...viewingUser, status: newStatus};
                                                                    google.script.run.saveUserData(updated);
                                                                    setAllUsers(prev => prev.map(u => u.id === updated.id ? updated : u));
                                                                    setViewingUser(updated);
                                                                    showToast(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${newStatus} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
                                                                }
                                                            }}
                                                            className="text-xs underline cursor-pointer hover:text-gray-800"
                                                        >
                                                            ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        </>
                                    );
                                })()}
                            </div>

{/* --- ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (Signature) --- */}
<div className="col-span-1 md:col-span-2 border-t pt-4 mt-2">
    <label className="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
        <PenTool size={16}/> ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏• (Digital Signature)
    </label>
    
    <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
        
        {/* ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô */}
        {!viewingUser.signature && (
            <div className="text-center py-6 flex flex-col items-center justify-center text-gray-400 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50/50 mb-4">
                <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-2 shadow-sm">
                    <XCircle size={24} className="text-gray-400" />
                </div>
                <p className="text-sm font-bold text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (No Signature)</p>
                <p className="text-xs text-gray-400 mt-1">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
            </div>
        )}

        {/* ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå */}
        {viewingUser.signature && (
            <div className="mb-4 flex flex-col items-center animate-in fade-in">
                {/* ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô - ‡πÉ‡∏´‡πâ User, Admin(2), Sub-Admin(3) ‡πÄ‡∏´‡πá‡∏ô */}
                {(user.id === viewingUser.id || user.isSuperAdmin || hasPermission(2) || hasPermission(3)) ? (
                    <div className="text-center">
                        <div className="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-2 rounded-lg flex items-center gap-2 mb-3 shadow-sm mx-auto w-fit">
                            <CheckCircle size={16} className="text-blue-600"/> 
                            <span className="text-xs font-bold">‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
                        </div>
                        
                        <button 
                            type="button"
                            onClick={() => handleViewFile(viewingUser.signature, 'Signature')}
                            className="flex items-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-100 hover:text-blue-600 transition-colors shadow-sm text-xs font-bold mx-auto"
                        >
                            <Eye size={14}/> ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                        </button>
                    </div>
                ) : (
                    /* ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏î‡∏π (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Admin/SubAdmin) ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
                    <>
                        <div className="bg-green-50 border border-green-200 text-green-700 px-6 py-3 rounded-xl flex items-center gap-3 shadow-sm">
                            <div className="bg-white p-1.5 rounded-full border border-green-100">
                                <ShieldCheck size={20} className="text-green-600"/>
                            </div>
                            <div>
                                <p className="text-sm font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                                <p className="text-[10px] opacity-80">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</p>
                            </div>
                        </div>
                    </>
                )}
            </div>
        )}

        {/* ‚≠ê ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡∏ß‡∏≤‡∏î/‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î) - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠ Admin */}
        {(user.id === viewingUser.id || user.isSuperAdmin || hasPermission(2) || hasPermission(3)) && (
            <>
                <div className="flex bg-white rounded-lg border border-gray-200 p-1 mb-3 w-fit mx-auto mt-4">
                    <button onClick={() => setSigMode('Draw')} className={`px-4 py-1.5 text-xs font-bold rounded transition-colors ${sigMode === 'Draw' ? 'bg-blue-50 text-blue-600' : 'text-gray-500'}`}>‡∏ß‡∏≤‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
                    <button onClick={() => setSigMode('Upload')} className={`px-4 py-1.5 text-xs font-bold rounded transition-colors ${sigMode === 'Upload' ? 'bg-blue-50 text-blue-600' : 'text-gray-500'}`}>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</button>
                </div>

                <div className="flex flex-col items-center">
                    {sigMode === 'Draw' ? (
                        <div className="relative">
                            <canvas 
                                ref={sigCanvasRef}
                                width={300} height={150}
                                className="bg-white border border-dashed border-gray-400 rounded cursor-crosshair touch-none"
                                onMouseDown={startDrawing}
                                onMouseMove={draw}
                                onMouseUp={stopDrawing}
                                onMouseLeave={stopDrawing}
                                onTouchStart={startDrawing}
                                onTouchMove={draw}
                                onTouchEnd={stopDrawing}
                            />
                            <button onClick={clearSignature} type="button" className="absolute top-1 right-1 text-xs text-red-500 bg-white border border-red-200 px-2 py-0.5 rounded hover:bg-red-50">‡∏•‡πâ‡∏≤‡∏á</button>
                            <p className="text-[10px] text-gray-400 mt-1 text-center">* ‡∏ß‡∏≤‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡πâ‡∏ß‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™)</p>
                        </div>
                    ) : (
                        <div className="w-full max-w-xs text-center">
                            <input 
                                type="file" 
                                accept="image/*"
                                onChange={(e) => {
                                    if(e.target.files[0]) {
                                        const file = e.target.files[0];
                                        const reader = new FileReader();
                                        reader.onload = (ev) => setTempSignatureUrl(ev.target.result); 
                                        reader.readAsDataURL(file);
                                        setSignatureFile(file);
                                    }
                                }}
                                className="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                            />
                            {tempSignatureUrl && <img src={tempSignatureUrl} className="h-20 mt-2 mx-auto border bg-white rounded"/>}
                        </div>
                    )}
                </div>
            </>
        )}
    </div>
</div>

                             {/* Permissions Section */}
                            <div className="mt-6 pt-6 border-t">
                                <div className="flex justify-between items-center mb-4">
                                    <h4 className="font-bold text-gray-800 flex gap-2"><ShieldCheck size={18}/> ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h4>
                                    {(user?.isSuperAdmin || hasPermission(2) || hasPermission(3)) && (
                                        <button 
    onClick={() => { 
        setSelectedUserForEdit(viewingUser); 
        // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal
        if (projects && projects.length > 0) {
            setPermissionTab(projects[0].name);
        }
        setShowPermissionModal(true); 
    }} 
    className="text-xs bg-gray-100 text-gray-600 px-3 py-1.5 rounded hover:bg-gray-200 border"
>
    ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
</button>
                                    )}
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-40 overflow-y-auto pr-2 custom-scrollbar">
                                     {viewingUser.permissions && Object.entries(viewingUser.permissions)
                                        .filter(([p]) => p && p !== 'undefined' && p !== 'null' && p.trim() !== '')
                                        .map(([project, perms]) => (
                                            <div key={project} className="border p-3 rounded bg-gray-50">
                                                <div className="font-bold text-blue-700 mb-2 flex items-center gap-2"><Building size={14}/> {project}</div>
                                                <div className="flex flex-wrap gap-1">{perms.map(id => <span key={id} className="text-[10px] bg-white border px-1.5 py-0.5 rounded text-gray-600">{PERMISSIONS[id]}</span>)}</div>
                                            </div>
                                     ))}
                                     {(!viewingUser.permissions || Object.keys(viewingUser.permissions).length === 0) && (
                                         <div className="col-span-2 text-center text-gray-400 text-sm py-4 border border-dashed rounded">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏î‡πÜ</div>
                                     )}
                                </div>
                            </div>
                        </div>
                     </div>
                )}

                {/* ‚≠ê Tab 2: History (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà User ‡∏ó‡∏≥‡πÄ‡∏≠‡∏á & ‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á By ‡∏≠‡∏≠‡∏Å) */}
{userDetailTab === 'history' && (() => {
                    // 1. System Logs: ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ log.by ‡πÄ‡∏õ‡πá‡∏ô User ‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                    const systemLogs = invLogs.filter(log => 
                        log.by && (log.by.includes(viewingUser.empId) || log.by.includes(viewingUser.firstName))
                    ).map(log => ({ ...log, sourceType: 'System' }));

// 2. Request Timeline: (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà) ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏∏‡∏Å‡πÉ‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏ß‡πà‡∏≤ User ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏ß‡πâ‡∏ö‡πâ‡∏≤‡∏á
                    const requestTimelineLogs = requests.flatMap(req => {
                        // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡∏π‡πÉ‡∏ô history ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÉ‡∏ö (‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô)
                        return (req.history || [])
                            .filter(h => h.user && ( // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å h.by ‡πÄ‡∏õ‡πá‡∏ô h.user
                                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (User) ‡∏Ñ‡∏∑‡∏≠ User ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                                h.user.includes(viewingUser.empId) || 
                                h.user.includes(viewingUser.firstName)
                            )) 
                            .map(h => ({
                                date: h.timestamp || h.date,
                                action: h.action,
                                by: h.user, // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡πÅ‡∏°‡∏û‡∏Ñ‡πà‡∏≤ h.user ‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ by (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ)
                                // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ + ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
                                item: req.docNumber ? `${req.docNumber} (${req.items[0]?.name})` : `${req.id} (${req.items[0]?.name})`,
                                note: h.note,
                                change: `Status: ${req.status}`,
                                relatedRequestId: req.id,
                                sourceType: 'Request'
                            }));
                    });

                    // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• + ‡∏Å‡∏£‡∏≠‡∏á Search + ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                    const allUserLogs = [...systemLogs, ...requestTimelineLogs]
                        .filter(log => 
                            log.action?.toLowerCase().includes(detailSearch.toLowerCase()) ||
                            log.item?.toLowerCase().includes(detailSearch.toLowerCase()) ||
                            log.note?.toLowerCase().includes(detailSearch.toLowerCase())
                        )
                        .sort((a, b) => {
                            const parseDate = (dStr) => {
                                if(!dStr) return 0;
                                try {
                                    if(dStr.includes('/')) {
                                        const [d, t] = dStr.split(' ');
                                        const [day, month, year] = d.split('/').map(Number);
                                        return new Date(year > 2400 ? year - 543 : year, month - 1, day, ...(t ? t.split(':').map(Number) : [0,0,0])).getTime();
                                    }
                                    return new Date(dStr).getTime();
                                } catch(e) { return 0; }
                            };
                            return parseDate(b.date) - parseDate(a.date);
                        });

                    return (
                        <div className="w-full">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead className="bg-gray-100 text-gray-600 font-bold uppercase text-xs sticky top-0 z-20 shadow-sm">
                                    <tr>
                                        <th className="p-4 w-36 whitespace-nowrap bg-gray-100">Date Time</th>
                                        <th className="p-4 w-36 whitespace-nowrap bg-gray-100">Action</th>
                                        <th className="p-4 min-w-[200px] bg-gray-100">Item / Ref</th>
                                        {/* ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡∏ï‡∏±‡∏î (By) ‡∏≠‡∏≠‡∏Å */}
                                        <th className="p-4 min-w-[300px] bg-gray-100">Details / Note</th> 
                                    </tr>
                                </thead>
                                <tbody className="divide-y bg-white">
                                    {allUserLogs.length > 0 ? allUserLogs.map((log, idx) => (
                                        <tr key={idx} className={`hover:bg-blue-50/30 transition-colors ${log.sourceType === 'Request' ? 'bg-blue-50/10' : ''}`}>
                                            <td className="p-4 font-mono text-xs text-gray-500 align-top whitespace-nowrap">{log.date || '-'}</td>
                                            <td className="p-4 align-top">
                                                <span className={`inline-block px-2 py-1 rounded text-[10px] font-bold border ${
                                                    log.action?.includes('Delete') ? 'bg-red-50 text-red-600 border-red-100' :
                                                    log.action?.includes('Edit') || log.action?.includes('Change') ? 'bg-orange-50 text-orange-600 border-orange-100' :
                                                    ['Create Request', 'Submit', 'Receive Items', 'Add'].some(k => log.action?.includes(k)) ? 'bg-green-50 text-green-600 border-green-100' :
                                                    'bg-gray-50 text-gray-600 border-gray-200'
                                                }`}>
                                                    {log.action === 'Pending PM' ? 'Pending Level 2' : log.action}
                                                </span>
                                                <div className="text-[9px] text-gray-300 mt-1 uppercase tracking-wider">{log.sourceType}</div>
                                            </td>
                                            <td className="p-4 font-medium text-gray-700 align-top">
                                                <div className="break-words font-mono text-xs">{log.item}</div>
                                                {log.relatedRequestId && (
    <button onClick={(e) => {
           e.stopPropagation();
           const targetReq = requests.find(r => r.id === log.relatedRequestId);
           // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
           if(targetReq) { setSelectedRequest(targetReq); setShowDetailModal(true); }
       }}
       className="text-[10px] text-blue-600 font-mono mt-1 hover:underline flex items-center gap-1 bg-white px-1.5 py-0.5 rounded border border-blue-200 shadow-sm w-fit"
    >
       {log.relatedRequestId} <ExternalLink size={10}/>
    </button>
)}
                                            </td>
                                            <td className="p-4 text-gray-500 text-xs align-top">
                                                {/* ‚≠ê ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á Avatar ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏≥ (By) ‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */}
                                                
                                                {/* ‡πÅ‡∏™‡∏î‡∏á Note ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î Project) */}
                                                <div className="space-y-1">
                                                    {log.note ? log.note.split('\n').map((line, i) => (
                                                        <div key={i} className="leading-relaxed break-words">
                                                            {line.startsWith('Project:') ? (
                                                                <span>
                                                                    <span className="font-bold text-blue-600">{line.split('->')[0]}</span>
                                                                    <span className="text-gray-600"> -> {line.split('->')[1]}</span>
                                                                </span>
                                                            ) : line}
                                                        </div>
                                                    )) : '-'}
                                                </div>

                                                {log.change && <div className="text-[10px] text-gray-400 mt-2 italic bg-gray-50 p-1 rounded border border-gray-100 inline-block">{log.change}</div>}
                                            </td>
                                        </tr>
                                    )) : <tr><td colSpan="4" className="p-10 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</td></tr>}
                                </tbody>
                            </table>
                            
                          
                            
                        </div>
                    );
                })()}

               {/* ‚≠ê Tab 3: Purchase (UPDATED: Precise Calculation Logic) */}
                {userDetailTab === 'purchase' && (() => {
                    // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á User ‡∏ô‡∏µ‡πâ + ‡πÄ‡∏õ‡πá‡∏ô Local/HO + ‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                    const purchaseRequests = requests.filter(r => 
                        (r.requester === viewingUser.empId || r.requester.includes(viewingUser.firstName)) && 
                        ['Local', 'HO'].includes(r.type) &&
                        (r.status === 'Completed' || r.status === 'Received') && 
                        (r.docNumber?.toLowerCase().includes(detailSearch.toLowerCase()) || r.items.some(i => i.name.toLowerCase().includes(detailSearch.toLowerCase())))
                    );

                    // 2. ‡πÅ‡∏ï‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ & ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    let grandTotal = 0;
                    const tableRows = [];

                    purchaseRequests.forEach(req => {
                        // ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                        const lastLog = req.history?.slice().reverse().find(h => 
                            h.action === 'Completed' || h.action.includes('Receive')
                        );
                        const displayDate = lastLog ? (lastLog.timestamp || lastLog.date) : req.created;
                        const isRent = req.type === 'HO' && req.purchaseType === 'Rent';

          req.items.forEach(item => {
    // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Logic ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Updated) ---
    
    // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏≤‡∏Ñ‡∏≤
    const relatedAssets = assets.filter(a => 
        a.currentRequestId === req.id && 
        a.name === item.name &&
        (a.price === item.unitPrice || a.rentalPrice === item.unitPrice)
    );
    
    const receivedLogs = item.receivedLog || [];
    
    let itemTotal = 0;
    let receivedCount = 0;
    let pricesList = []; 

    // Priority A: Assets (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏∏‡∏î)
    if (relatedAssets.length > 0) {
         itemTotal += relatedAssets.reduce((s, asset) => {
             const p = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
             const d = isRent ? (asset.duration || item.duration || 1) : 1;
             pricesList.push(p);
             return s + (p * d);
         }, 0);
         receivedCount = relatedAssets.length;
    } 
    // Priority B: Logs (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏™‡∏î‡∏∏)
    else if (receivedLogs.length > 0) {
         itemTotal += receivedLogs.reduce((s, log) => {
             const p = log.price;
             const d = isRent ? (log.duration || 1) : 1;
             pricesList.push(p);
             return s + (log.qty * p * d);
          }, 0);
         receivedCount = item.receivedTotal || 0;
    }

    // Priority C: Estimate (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô)
    if (!['Completed', 'Received'].includes(req.status)) {
        const remaining = Math.max(0, item.qty - receivedCount);
        if (remaining > 0) {
            const p = item.unitPrice || 0;
            const d = isRent ? (item.duration || 1) : 1;
            itemTotal += (remaining * p * d);
            pricesList.push(p);
        }
    }



                            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡∏•‡∏∞‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                            const uniquePrices = [...new Set(pricesList)];
                            const displayPrice = uniquePrices.length === 1 ? uniquePrices[0] : 'Mixed'; 

                            grandTotal += itemTotal;

                            tableRows.push({
                                rawDate: displayDate,
                                docNumber: req.docNumber || req.id,
                                reqId: req.id,
                                name: item.name,
                                price: displayPrice, // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏≠‡∏ô Render
                                qty: item.qty,
                                unit: item.unit,
                                total: itemTotal
                            });
                        });
                    });

                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    tableRows.sort((a, b) => {
                        const parse = (d) => { try { 
                            if(d.includes('/')) {
                                const parts = d.split(' ');
                                const dp = parts[0].split('/');
                                let y = parseInt(dp[2]);
                                if(y > 2400) y -= 543;
                                return new Date(y, parseInt(dp[1])-1, parseInt(dp[0])).getTime();
                            }
                            return new Date(d).getTime(); 
                        } catch(e) { return 0; } };
                        return parse(b.rawDate) - parse(a.rawDate);
                    });

                    return (
                        <div className="p-6 space-y-4">
                            {/* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */}
                            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 flex justify-between items-center shadow-sm">
                                <div className="flex items-center gap-2 text-blue-800 font-bold">
                                    <div className="bg-white p-2 rounded-lg text-blue-600"><ShoppingCart className="w-5 h-5"/></div>
                                    ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (Grand Total)
                                </div>
                                <div className="text-2xl font-bold text-blue-700">
                                    {grandTotal.toLocaleString()} <span className="text-sm font-normal text-gray-500">‡∏ö‡∏≤‡∏ó</span>
                                </div>
                            </div>

                            {/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */}
                            <div className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                                <table className="w-full text-sm text-left border-collapse">
                                    <thead className="bg-gray-100 text-gray-600 font-bold uppercase text-xs sticky top-0 z-20 shadow-sm">
                                        <tr>
                                            <th className="p-4 w-32 bg-gray-100">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</th>
                                            <th className="p-4 w-32 bg-gray-100">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                                            <th className="p-4 min-w-[200px] bg-gray-100">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                            <th className="p-4 text-right bg-gray-100">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                            <th className="p-4 text-center bg-gray-100">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                            <th className="p-4 text-right w-32 bg-gray-100">‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y bg-white">
                                        {tableRows.length > 0 ? tableRows.map((row, idx) => (
                                            <tr key={idx} className="hover:bg-blue-50/30 transition-colors">
                                                <td className="p-4 text-gray-500 whitespace-nowrap align-top text-xs font-mono">{row.rawDate}</td>
                                                <td className="p-4 align-top">
                                                    <button 
                                                        onClick={() => {
                                                            const targetReq = requests.find(r => r.id === row.reqId);
                                                            if(targetReq) { setSelectedRequest(targetReq); setShowDetailModal(true); }
                                                        }}
                                                        className="font-bold text-blue-600 hover:underline bg-blue-50 px-2 py-0.5 rounded border border-blue-100 text-xs font-mono"
                                                    >
                                                        {row.docNumber}
                                                    </button>
                                                </td>
                                                <td className="p-4 text-gray-800 font-medium">{row.name}</td>
                                                <td className="p-4 text-right text-gray-600 font-mono">
                                                    {row.price === 'Mixed' ? 
                                                        <span className="text-xs italic text-orange-600">(‡∏Ñ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤)</span> : 
                                                        row.price.toLocaleString()
                                                    }
                                                </td>
                                                <td className="p-4 text-center">
                                                    <span className="bg-green-50 text-green-700 border border-green-200 px-2 py-0.5 rounded font-bold text-xs">
                                                        {row.qty.toLocaleString()} {row.unit}
                                                    </span>
                                                </td>
                                                <td className="p-4 text-right font-bold text-blue-700 font-mono bg-gray-50/50">{row.total.toLocaleString()}</td>
                                            </tr>
                                        )) : (
                                            <tr><td colSpan="6" className="p-12 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    );
                })()}

                {/* ---------------- Tab 4: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---------------- */}
                {userDetailTab === 'withdraw' && (() => {
                     const rawData = requests.filter(r => 
                        r.type === 'Withdraw' && (r.status === 'Approved' || r.status === 'Completed') &&
                        (r.requester === viewingUser.empId || r.requester.includes(viewingUser.firstName))
                    );
                    const aggregatedItems = {};
                    rawData.forEach(req => {
                        req.items.forEach(item => {
                            const key = item.name;
                            if(!aggregatedItems[key]) aggregatedItems[key] = { name: key, qty: 0, unit: item.unit };
                            aggregatedItems[key].qty += parseFloat(item.qty);
                        });
                    });
                    const itemList = Object.values(aggregatedItems).filter(i => i.name.toLowerCase().includes(detailSearch.toLowerCase()));

                    return (
                        <div className="space-y-4">
                            <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." className="p-2 border rounded text-sm w-full mb-2" value={detailSearch} onChange={e => setDetailSearch(e.target.value)}/>
                            <div className="bg-white rounded-lg border overflow-hidden shadow-sm">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-gray-100 text-gray-600 font-bold uppercase text-xs">
                                        <tr><th className="p-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th className="p-3 text-center">‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å</th><th className="p-3 text-center">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th></tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {itemList.length > 0 ? itemList.map((item, idx) => (
                                            <tr key={idx} className="hover:bg-gray-50">
                                                <td className="p-3 font-medium">{item.name}</td>
                                                <td className="p-3 text-center font-bold text-blue-600">{item.qty}</td>
                                                <td className="p-3 text-center text-gray-500">{item.unit}</td>
                                            </tr>
                                        )) : <tr><td colSpan="3" className="p-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    );
                })()}

                {/* ---------------- Tab 5: ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏° (UPDATED: Clickable Asset ID) ---------------- */}
                {userDetailTab === 'borrow' && (() => {
                    // Logic ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                    const activeBorrows = assets.filter(a => 
                        a.status === 'Borrowed' && 
                        a.holder && 
                        (
                            a.holder.includes(viewingUser.firstName) || 
                            a.holder.includes(viewingUser.empId) ||
                            (viewingUser.username && a.holder.includes(viewingUser.username))
                        ) &&
                        (a.name.toLowerCase().includes(detailSearch.toLowerCase()) || a.id.toLowerCase().includes(detailSearch.toLowerCase()))
                    );

                    return (
                        <div className="space-y-4 p-6">
                            <div className="flex justify-between items-center mb-4">
                                <div className="relative">
                                    <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                                    <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." className="pl-9 pr-4 py-2 border rounded-lg text-sm w-64 outline-none focus:ring-2 focus:ring-blue-500" value={detailSearch} onChange={e => setDetailSearch(e.target.value)}/>
                                </div>
                                <span className="text-xs font-bold text-orange-700 bg-orange-100 px-3 py-1.5 rounded-full border border-orange-200">
                                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°: {activeBorrows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                </span>
                            </div>

                            <div className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-gray-100 text-gray-600 font-bold uppercase text-xs">
                                        <tr>
                                            <th className="p-4 w-32">‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</th>
                                            <th className="p-4">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                            <th className="p-4 w-40">Serial No.</th>
                                            <th className="p-4 w-40 text-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {activeBorrows.length > 0 ? activeBorrows.map((asset, idx) => (
                                            <tr key={asset.id} className="hover:bg-orange-50/50 transition-colors">
                                                <td className="p-4">
                                                    {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏Å openViewItem */}
                                                    <button 
                                                        onClick={() => openViewItem(asset)}
                                                        className="font-mono text-blue-600 font-bold bg-blue-50 px-2 py-0.5 rounded border border-blue-100 text-xs hover:bg-blue-100 hover:underline cursor-pointer transition-colors"
                                                        title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥"
                                                    >
                                                        {asset.id}
                                                    </button>
                                                </td>
                                                <td className="p-4 font-bold text-gray-800">{asset.name}</td>
                                                <td className="p-4 font-mono text-gray-500 text-xs">{asset.serial || '-'}</td>
                                                <td className="p-4 text-center text-gray-500 text-xs">
                                                    {asset.lastUpdated ? asset.lastUpdated.split(' ')[0] : '-'}
                                                </td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan="4" className="p-12 text-center text-gray-400 flex flex-col items-center justify-center">
                                                    <Briefcase className="w-10 h-10 mb-2 opacity-20"/>
                                                    ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    );
                })()}
            </div>
            <ModalScrollButtons targetId="user-modal-scroll" />
            {/* ‚≠ê ‡∏õ‡∏∏‡πà‡∏° Load More ‡πÅ‡∏ö‡∏ö‡∏•‡∏≠‡∏¢ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ó‡πá‡∏ö History) */}
            {userDetailTab === 'history' && (
                <button 
                    onClick={() => {
                        if(!confirm('‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?')) return;
                        setIsLoading(true);
                        google.script.run.withSuccessHandler((logs) => {
                            if (logs) setInvLogs(logs);
                            setIsLoading(false);
                            showToast('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                        }).getRecentLogs(2000);
                    }}
                    className="absolute bottom-6 left-6 z-[60] bg-white text-blue-600 border border-blue-200 hover:bg-blue-600 hover:text-white px-4 py-3 rounded-full shadow-xl transition-all transform hover:scale-105 flex items-center gap-2 font-bold text-xs group no-print"
                    title="‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°"
                >
                    <RefreshCw size={16} className="group-hover:rotate-180 transition-transform duration-500"/> 
                    <span>‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏° (Load More)</span>
                </button>
            )}
        </div>
    </div>
)}

{/* --- CHECKLIST / AUDIT MODAL (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ä‡πà‡∏≤ + ‡∏à‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á) --- */}
{showChecklistModal && (
    <>
        {/* 1. CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå */}
        <style>{`
            @media print {
                @page { size: A4; margin: 10mm; }
                body * { visibility: hidden; }
                
                html, body { 
                    height: auto !important; 
                    overflow: visible !important; 
                    background: white !important; 
                    margin: 0 !important;
                    padding: 0 !important;
                }
                
                #print-area, #print-area * { visibility: visible; }
                
                #print-area {
                    position: absolute;
                    left: 0;
                    top: 0;
                    width: 100%;
                    margin: 0;
                    padding: 0;
                    background: white;
                }
                
                table { width: 100%; border-collapse: collapse; }
                thead { display: table-header-group; }
                tr { break-inside: avoid; page-break-inside: avoid; }
                
                td, th { border: 1px solid black !important; padding: 4px; font-size: 10pt; }
                .no-print { display: none !important; }
            }
        `}</style>

        {/* 2. Modal UI */}
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[200] p-4 backdrop-blur-sm animate-in fade-in no-print">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col overflow-hidden">
                
                {/* Header */}
                <div className="px-6 py-4 border-b bg-white flex justify-between items-center shrink-0">
                    <div>
                        <h3 className="font-bold text-xl text-indigo-800 flex items-center gap-2">
                            <ClipboardList className="w-6 h-6"/> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö ({checklistMode === 'Inventory' ? '‡∏ß‡∏±‡∏™‡∏î‡∏∏' : '‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô'})
                        </h3>
                        <p className="text-sm text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö</p>
                    </div>
                    {/* ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö SVG */}
                    <button onClick={() => setShowChecklistModal(false)} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <div className="flex-1 flex overflow-hidden">
                    {/* LEFT: Filters */}
                    <div className="w-1/3 bg-gray-50 border-r p-6 overflow-y-auto space-y-6">
                        {/* Projects Filter */}
                        <div className="bg-white p-4 rounded-xl border shadow-sm">
                            <label className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Building size={16}/> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                            <div className="space-y-1 max-h-40 overflow-y-auto custom-scrollbar">
                                {projects.map(p => (
                                    <label key={p.id} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1.5 rounded">
                                        <input type="checkbox" className="rounded text-indigo-600 focus:ring-indigo-500" 
                                            checked={checklistFilters.projects.includes(p.name)}
                                            onChange={() => toggleChecklistFilter('projects', p.name)}
                                        />
                                        <span className="text-sm">{p.name}</span>
                                    </label>
                                ))}
                            </div>
                        </div>

                        {/* Type & Status Filters */}
                        <div className="bg-white p-4 rounded-xl border shadow-sm space-y-4">
                            <div>
                                <label className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Tag size={16}/> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                                <div className="space-y-1">
                                    {checklistMode === 'Inventory' ? (
                                        ['System', 'NonSystem'].map(t => (
                                            <label key={t} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1.5 rounded">
                                                <input type="checkbox" className="rounded text-indigo-600" checked={checklistFilters.types.includes(t)} onChange={() => toggleChecklistFilter('types', t)}/>
                                                <span className="text-sm">{t === 'System' ? '‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö'}</span>
                                            </label>
                                        ))
                                    ) : (
                                        ['Company', 'Rent'].map(t => (
                                            <label key={t} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1.5 rounded">
                                                <input type="checkbox" className="rounded text-indigo-600" checked={checklistFilters.types.includes(t)} onChange={() => toggleChecklistFilter('types', t)}/>
                                                <span className="text-sm">{t === 'Company' ? '‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó' : '‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡πà‡∏≤'}</span>
                                            </label>
                                        ))
                                    )}
                                </div>
                            </div>

                            {checklistMode === 'Asset' && (
                                <div>
                                    <label className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Info size={16}/> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                    <div className="space-y-1">
                                        {['Available', 'Borrowed', 'Lost', 'Damaged'].map(s => (
                                            <label key={s} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1.5 rounded">
                                                <input type="checkbox" className="rounded text-indigo-600" checked={checklistFilters.statuses.includes(s)} onChange={() => toggleChecklistFilter('statuses', s)}/>
                                                <span className="text-sm">{s}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* RIGHT: Action & Upload */}
                    <div className="w-2/3 flex flex-col bg-white">
                        <div className="p-8 flex flex-col items-center justify-center flex-1 text-center">
                            <div className="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mb-4">
                                <Printer className="w-10 h-10 text-indigo-600"/>
                            </div>
                            <h4 className="text-2xl font-bold text-gray-800 mb-2">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö</h4>
                            <p className="text-gray-500 mb-6 max-w-sm">
                                ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <strong className="text-indigo-600">{getChecklistFilteredItems().length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <br/>
                                ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
                            </p>
                            
                            <button 
                                onClick={handlePrintChecklist} 
                                disabled={getChecklistFilteredItems().length === 0}
                                className="h-12 px-8 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg flex items-center gap-2 transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <Printer className="w-5 h-5"/> ‡∏û‡∏¥‡∏°‡∏û‡πå / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF (Auto Name)
                            </button>
                        </div>

                        {/* Upload Section */}
                        <div className="p-6 bg-slate-50 border-t">
                            <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2"><UploadCloud size={18}/> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏•‡∏±‡∏ö (Upload Signed Checklist)</h4>
                            <div className="flex gap-4">
                                <input 
                                    type="file" 
                                    accept=".pdf,.jpg,.png"
                                    className="flex-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-bold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 bg-white border border-gray-300 rounded-xl cursor-pointer"
                                    onChange={(e) => setChecklistUploadFile(e.target.files[0])}
                                />
                                <button 
                                    onClick={handleUploadChecklist}
                                    disabled={!checklistUploadFile}
                                    className="bg-green-600 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-md flex items-center gap-2"
                                >
                                    <Save className="w-4 h-4"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {/* 3. ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå */}
        <div id="print-area" className="hidden print:block bg-white text-black p-8">
            <div className="text-center mb-6">
                <h1 className="text-2xl font-bold mb-1">‡πÉ‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö{checklistMode === 'Inventory' ? '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á (Inventory Audit)' : '‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Asset Audit)'}</h1>
                <p className="text-sm text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: {new Date().toLocaleString('th-TH')}</p>
            </div>

            <div className="mb-4 text-sm border-b pb-2">
                <p><strong>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:</strong> {checklistFilters.projects.length > 0 ? checklistFilters.projects.join(', ') : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Projects)'}</p>
                <p><strong>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç:</strong> {checklistMode === 'Inventory' ? 
                    `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${checklistFilters.types.length > 0 ? checklistFilters.types.join(', ') : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}` : 
                    `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${checklistFilters.types.length > 0 ? checklistFilters.types.join(', ') : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${checklistFilters.statuses.length > 0 ? checklistFilters.statuses.join(', ') : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}`
                }</p>
            </div>

{checklistMode === 'Asset' && (
        <div className="flex justify-between items-end mb-3 px-1 font-bold text-sm text-black">
            <div className="flex items-center gap-2">
                <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</span>
                {/* ‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡∏°‡∏≤‡πÑ‡∏î‡πâ */}
                <span className="text-xl font-mono">{getChecklistFilteredItems().length}</span>
                <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
            <div className="flex items-end gap-2">
                <span>‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ:</span>
                {/* ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô */}
                <div className="border-b-2 border-dotted border-black w-32 h-6"></div>
                <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
        </div>
    )}


            <table className="w-full border-collapse border border-black text-xs">
                <thead>
                   {checklistMode === 'Inventory' ? (
    <tr className="bg-gray-100 font-bold">
        {/* ‡∏ä‡πà‡∏≠‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‡πÄ‡∏•‡πá‡∏Å‡∏™‡∏∏‡∏î */}
        <th className="border border-black p-2 w-8 text-center">#</th>
        
        {/* ‚≠ê ‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á (w) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */}
        <th className="border border-black p-2 text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏ (Item Details)</th>
        
        {/* ‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */}
        <th className="border border-black p-2 w-20 text-center">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th> {/* ‡πÄ‡∏î‡∏¥‡∏° w-24 */}
        <th className="border border-black p-2 w-20 text-right">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>   {/* ‡πÄ‡∏î‡∏¥‡∏° w-24 */}
        
        <th className="border border-black p-2 w-24 text-center">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
        <th className="border border-black p-2 w-24 text-center">‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</th>
        
        {/* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏•‡∏á (‡∏à‡∏≤‡∏Å w-40 ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ w-28) */}
        <th className="border border-black p-2 w-28 text-center">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th> 
    </tr>
) : (
    <tr className="bg-gray-100 font-bold">
        <th className="border border-black p-2 w-10 text-center"><CheckSquare size={14}/></th>
        
        {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏£‡∏ß‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡∏£‡∏´‡∏±‡∏™+‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£+S/N+‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ä‡πà‡∏≤ ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */}
        <th className="border border-black p-2 text-left">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Asset Details)</th>
        
        {/* ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */}
        <th className="border border-black p-2 w-24 text-center">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
        <th className="border border-black p-2 w-24 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th className="border border-black p-2 w-32">‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á</th>
        <th className="border border-black p-2 w-24 text-center">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
    </tr>
)}
                </thead>
                <tbody>
                    {getChecklistFilteredItems().map((item, idx) => (
                        <tr key={idx}>
                            {checklistMode === 'Inventory' ? (
    <>
        <td className="border border-black p-2 text-center align-top">{idx + 1}</td>
        
        {/* ‚≠ê 3. ‡∏£‡∏ß‡∏°‡∏ä‡πà‡∏≠‡∏á: ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤) ‡πÅ‡∏•‡∏∞ ‡∏£‡∏´‡∏±‡∏™ (‡∏ï‡∏±‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πâ‡∏≤) */}
        <td className="border border-black p-2 align-top">
            <div className="font-bold text-sm mb-1">{item.name}</div>
            <div className="text-xs text-gray-500 font-mono">
                {/* ‡πÉ‡∏ä‡πâ getDisplayId ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏¥‡πâ‡∏á ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà INV-xxx */}
                ID: {getDisplayId(item.id)}
            </div>
        </td>

        <td className="border border-black p-2 text-center align-top">
            {projects.find(p => p.name === item.project)?.id || '-'}
        </td>
        
        <td className="border border-black p-2 text-right align-top">
            {item.qty} {item.unit}
        </td>
        
        {/* ‚≠ê 4. ‡∏™‡∏•‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Body) ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Header */}
        {/* ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) */}
        <td className="border border-black p-2 text-center align-top text-xs">
            {item.lastUpdated?.split(' ')[0]}
        </td>

        {/* ‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡∏´‡∏•‡∏±‡∏á) */}
        <td className="border border-black p-2"></td>
        
        <td className="border border-black p-2"></td>
    </>
) : (
    <>
        {/* ‡∏ä‡πà‡∏≠‡∏á Checkbox */}
        <td className="border border-black p-2 text-center align-top pt-3">
            <div className="w-4 h-4 border border-black mx-auto"></div>
        </td>

        {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 4 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô <td> ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */}
        <td className="border border-black p-2 align-top">
            {/* 1. ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤) */}
            <div className="font-bold text-sm mb-1">{item.name}</div>
            
            {/* 2. ‡∏£‡∏´‡∏±‡∏™ ‡πÅ‡∏•‡∏∞ Serial (‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏î‡∏•‡∏á‡∏°‡∏≤‡∏ñ‡πâ‡∏≤‡∏¢‡∏≤‡∏ß) */}
            <div className="flex flex-wrap gap-x-3 gap-y-1 text-xs text-gray-700 mb-1">
                <span className="font-mono bg-gray-50 px-1 rounded border border-gray-200 whitespace-nowrap">
                    ID: {item.id}
                </span>
                <span className="whitespace-nowrap">
                    S/N: {item.serial || '-'}
                </span>
            </div>

            {/* 3. ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤) */}
            {item.ownerType === 'Rent' && (
                <div className="text-[10px] text-gray-500 italic border-t border-dotted border-gray-300 pt-1 mt-1">
                    <span className="font-bold">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ä‡πà‡∏≤:</span>{' '}
                    {item.duration ? 
                        `${item.duration} ${item.rentalUnit || ''}` : 
                        (item.rentalStart && item.rentalEnd ? `${item.rentalStart} - ${item.rentalEnd}` : '-')
                    }
                </div>
            )}
        </td>

        {/* ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÅ‡∏¢‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */}
        <td className="border border-black p-2 text-center align-top pt-3">
            {projects.find(p => p.name === item.project)?.id || '-'}
        </td>

        <td className="border border-black p-2 text-center align-top pt-3">{item.status}</td>
        <td className="border border-black p-2 align-top pt-3">{item.holder || '-'}</td>
        <td className="border border-black p-2 text-center align-top pt-3">{item.lastUpdated?.split(' ')[0]}</td>
    </>
)}
                        </tr>
                    ))}
                </tbody>
            </table>

            <div className="mt-8 flex justify-between px-10 break-inside-avoid">
                <div className="text-center">
                    <div className="border-b border-dotted border-black w-48 h-8"></div>
                    <p className="mt-1">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Checker)</p>
                    <p className="mt-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ...../...../..........</p>
                </div>
                <div className="text-center">
                    <div className="border-b border-dotted border-black w-48 h-8"></div>
                    <p className="mt-1">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö (Approved By)</p>
                    <p className="mt-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ...../...../..........</p>
                </div>
            </div>
        </div>
    </>
)}

{/* --- EXPORT BUDGET MODAL --- */}
{showExportModal && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[300] p-4 backdrop-blur-sm animate-in fade-in">
        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in-95">
            
            {/* Header */}
            <div className="px-6 py-4 border-b bg-white flex justify-between items-center">
                <h3 className="font-bold text-lg text-green-700 flex items-center gap-2">
                    <FileText className="w-5 h-5"/> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏ö (Export)
                </h3>
                {/* ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î SVG */}
                <button 
                    onClick={() => setShowExportModal(false)} 
                    className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            {/* Body */}
            <div className="p-6 bg-slate-50">
                <p className="text-sm text-gray-600 mb-4">
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <b>Completed</b> (‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á/‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Budget ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏à‡∏£‡∏¥‡∏á
                </p>

                <label className="block text-sm font-bold text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export</label>
                <select 
                    className="w-full p-3 border border-gray-300 rounded-xl text-sm bg-white outline-none focus:ring-2 focus:ring-green-500 cursor-pointer"
                    value={exportTargetProject}
                    onChange={(e) => setExportTargetProject(e.target.value)}
                >
                    <option value="All">‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (All Projects)</option>
                    {projects.map(p => (
                        <option key={p.id} value={p.name}>{p.name}</option>
                    ))}
                </select>
            </div>

            {/* Footer */}
            <div className="p-5 border-t bg-white flex gap-3">
                <button 
                    onClick={() => setShowExportModal(false)} 
                    className="flex-1 py-2.5 border border-gray-300 rounded-xl text-gray-600 font-bold hover:bg-gray-50"
                >
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button 
                    onClick={handleExportBudgetCSV} 
                    className="flex-1 py-2.5 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-md flex items-center justify-center gap-2"
                >
                    <Download className="w-4 h-4"/> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Export
                </button>
            </div>
        </div>
    </div>
)}


{showAuditModal && (
    <div className="fixed inset-0 bg-gray-900/80 flex items-center justify-center z-[200] p-4 backdrop-blur-sm animate-in fade-in">
        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden">
            
            {/* Header */}
            <div className="px-6 py-4 border-b bg-orange-50 flex justify-between items-center">
                <div>
                    <h3 className="font-bold text-lg text-orange-800 flex items-center gap-2">
                        <ClipboardList className="w-5 h-5"/> ‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Stock Audit Mode)
                    </h3>
                    <p className="text-xs text-orange-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                </div>
                <button onClick={() => setShowAuditModal(false)} className="text-gray-400 hover:text-gray-600"><X className="w-6 h-6"/></button>
            </div>

            {/* Table */}
            <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                <table className="w-full text-sm text-left bg-white rounded-xl overflow-hidden shadow-sm">
                    <thead className="bg-gray-100 text-gray-700 font-bold uppercase text-xs sticky top-0 z-10">
                        <tr>
                            <th className="p-3">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th className="p-3 text-center w-24">‡∏¢‡∏≠‡∏î‡∏£‡∏∞‡∏ö‡∏ö</th>
                            <th className="p-3 text-center w-32 bg-orange-100 text-orange-800">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ</th>
                            <th className="p-3 text-center w-24">‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á</th>
                            <th className="p-3 w-1/3">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏ï‡πà‡∏≤‡∏á)</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {auditItems.map((item, idx) => {
                            const diff = item.countedQty - item.qty;
                            const hasDiff = diff !== 0;
                            return (
                                <tr key={item.id} className={hasDiff ? "bg-red-50" : "hover:bg-gray-50"}>
                                    <td className="p-3">
                                        <div className="font-bold">{item.name}</div>
                                        <div className="text-xs text-gray-500">{getDisplayId(item.id)} | {item.project}</div>
                                    </td>
                                    <td className="p-3 text-center font-mono">{item.qty}</td>
                                    <td className="p-3 text-center bg-orange-50/50">
                                        <input 
                                            type="number" 
                                            className="w-full p-2 border border-orange-300 rounded text-center font-bold text-orange-700 focus:ring-2 focus:ring-orange-500 outline-none"
                                            value={item.countedQty}
                                            onChange={(e) => {
                                                const val = parseInt(e.target.value) || 0;
                                                const newItems = [...auditItems];
                                                newItems[idx].countedQty = val;
                                                setAuditItems(newItems);
                                            }}
                                        />
                                    </td>
                                    <td className="p-3 text-center font-bold">
                                        <span className={diff === 0 ? 'text-gray-300' : diff < 0 ? 'text-red-600' : 'text-green-600'}>
                                            {diff > 0 ? `+${diff}` : diff}
                                        </span>
                                    </td>
                                    <td className="p-3">
                                        {hasDiff && (
                                            <input 
                                                type="text" 
                                                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡∏á‡∏´‡∏≤‡∏¢, ‡∏ô‡∏±‡∏ö‡∏ú‡∏¥‡∏î)" 
                                                className="w-full p-2 border border-red-300 rounded text-xs bg-white focus:ring-1 focus:ring-red-500 outline-none"
                                                value={item.reason}
                                                onChange={(e) => {
                                                    const newItems = [...auditItems];
                                                    newItems[idx].reason = e.target.value;
                                                    setAuditItems(newItems);
                                                }}
                                            />
                                        )}
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>

            {/* Footer */}
            <div className="p-5 border-t bg-white flex justify-between items-center">
                <div className="text-sm">
                    ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á: <b className="text-red-600">{auditItems.filter(i => i.countedQty !== i.qty).length}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </div>
                <div className="flex gap-3">
                    <button onClick={() => setShowAuditModal(false)} className="px-6 py-2 border rounded-lg text-gray-600 hover:bg-gray-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button 
                        onClick={async () => {
                            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏Å‡πâ
                            const adjustments = auditItems
                                .filter(i => i.countedQty !== i.qty)
                                .map(i => ({
                                    id: i.id,
                                    name: i.name,
                                    oldQty: i.qty,
                                    newQty: i.countedQty,
                                    reason: i.reason || '‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö',
                                    project: i.project,
                                    // ‡∏™‡πà‡∏á Object ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                    fullObject: { ...i, qty: i.countedQty, lastUpdated: new Date().toLocaleString('th-TH') }
                                }));

                            if (adjustments.length === 0) {
                                showToast('‡∏¢‡∏≠‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á', 'success');
                                setShowAuditModal(false);
                                return;
                            }

                            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å ${adjustments.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) return;

                            setIsLoading(true);
                            try {
                                const userBy = `${user.empId} ${user.firstName}`;
                                await new Promise((resolve, reject) => {
                                    google.script.run
                                        .withSuccessHandler(resolve)
                                        .withFailureHandler(reject)
                                        .processStockAudit(adjustments, userBy);
                                });
                                
                                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                                setInventory(prev => prev.map(inv => {
                                    const adj = adjustments.find(a => a.id === inv.id);
                                    return adj ? adj.fullObject : inv;
                                }));

                                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                                setShowAuditModal(false);
                            } catch (err) {
                                console.error(err);
                                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
                            } finally {
                                setIsLoading(false);
                            }
                        }}
                        className="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 shadow-md font-bold"
                    >
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î (Confirm Adjust)
                    </button>
                </div>
            </div>
        </div>
    </div>
)}


{/* --- ACTOR LIST MODAL --- */}
{showActorModal && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[300] p-4 backdrop-blur-sm animate-in fade-in">
        <div className="bg-white rounded-xl shadow-xl w-full max-w-sm overflow-hidden">
            <div className="px-5 py-3 border-b bg-blue-50 flex justify-between items-center">
                <div>
                    <h3 className="font-bold text-blue-800 text-sm">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</h3>
                    <p className="text-xs text-blue-600 font-bold mt-0.5">{actorList.title}</p>
                </div>
                <button onClick={() => setShowActorModal(false)} className="text-gray-400 hover:text-gray-600"><X size={18}/></button>
            </div>
            
            <div className="p-0 max-h-[300px] overflow-y-auto">
                {actorList.users.length > 0 ? (
                    <div className="divide-y divide-gray-100">
                        {actorList.users.map((u, i) => (
                            <div key={i} className="px-5 py-3 flex items-center gap-3 hover:bg-gray-50">
                                <div className="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-bold text-xs">
                                    {u.firstName.charAt(0)}
                                </div>
                                <div>
                                    <p className="text-sm font-bold text-gray-800">{u.firstName} {u.lastName}</p>
                                    <p className="text-xs text-gray-500">{u.empId} {u.role === 'Admin' && ' (Admin)'}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="p-8 text-center text-gray-400 text-sm">
                        <User size={24} className="mx-auto mb-2 opacity-30"/>
                        <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>
                    </div>
                )}
            </div>
            <div className="p-3 bg-gray-50 text-center border-t">
                <button onClick={() => setShowActorModal(false)} className="text-xs font-bold text-gray-500 hover:text-gray-800">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
        </div>
    </div>
)}

{/* --- SUPER ADMIN ROLLBACK MODAL --- */}
{showSuperRollbackModal && (
    <div className="fixed inset-0 bg-gray-900/80 flex items-center justify-center z-[300] p-4 backdrop-blur-sm animate-in fade-in">
        <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 border-t-4 border-red-600">
            <h3 className="font-bold text-lg text-red-700 mb-4 flex items-center gap-2">
                <AlertTriangle className="w-6 h-6"/> Super Admin Rollback
            </h3>
            
            <div className="bg-red-50 p-3 rounded-lg border border-red-100 text-xs text-red-800 mb-4">
                <p className="font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£:</p>
                <ul className="list-disc pl-4 mt-1 space-y-1">
                    <li>‡∏¢‡πâ‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</li>
                    <li><b>‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>‡∏•‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</b> ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤/‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</li>
                    <li>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö (Revert Logs)</li>
                    <li>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏ô PDF ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                </ul>
            </div>

            <div className="space-y-4">
                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Target Status)</label>
                    <select 
                        className="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white"
                        value={rollbackTarget}
                        onChange={(e) => setRollbackTarget(e.target.value)}
                    >
                        {/* ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏¥‡∏î Flow */}
                        {(() => {
                            if (selectedRequest.type === 'Withdraw' || selectedRequest.type === 'Borrow') {
                                return (
                                    <>
                                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
                                        <option value="Draft">‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á (Draft) - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà</option>
                                        <option value="Pending Head">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Level 1/2) - ‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤/PM ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                                        <option value="Ready to Disburse">‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á (Ready) - ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏™‡πÇ‡∏ï‡∏£‡πå‡∏à‡πà‡∏≤‡∏¢</option>
                                        <option value="Completed">‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß/‡∏à‡∏ö‡∏á‡∏≤‡∏ô (Completed)</option>
                                        {selectedRequest.type === 'Borrow' && <option value="Returned">‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (Returned)</option>}
                                    </>
                                );
                            } else if (selectedRequest.type === 'Local') {
                                return (
                                    <>
                                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
                                        <option value="Draft">‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á (Draft)</option>
                                        <option value="Pending Head">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 1</option>
                                        <option value="Pending PM">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 2</option>
                                        <option value="Pending Check">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Purchasing Check)</option>
                                        <option value="Approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠)</option>
                                        <option value="Ordered">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á)</option>
                                        <option value="Completed">‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (Completed)</option>
                                    </>
                                );
                            } else { // HO
                                return (
                                    <>
                                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
                                        <option value="Draft">‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á (Draft)</option>
                                        <option value="Pending Check">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Check)</option>
                                        <option value="Pending Head">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 1</option>
                                        <option value="Pending PM">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 2</option>
                                        <option value="Approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (Approved)</option>
                                        <option value="PR Issued">‡∏≠‡∏≠‡∏Å PR ‡πÅ‡∏•‡πâ‡∏ß</option>
                                        <option value="PO Issued">‡∏≠‡∏≠‡∏Å PO ‡πÅ‡∏•‡πâ‡∏ß</option>
                                        {selectedRequest.purchaseType === 'Rent' && <option value="Contract Pending">‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤</option>}
                                        {selectedRequest.purchaseType === 'Rent' && <option value="Contract Signed">‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>}
                                        <option value="Shipping">‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</option>
                                        <option value="Completed">‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (Completed)</option>
                                    </>
                                );
                            }
                        })()}
                    </select>
                </div>
                
                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£ Rollback</label>
                    <textarea 
                        className="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-red-500 outline-none"
                        rows="3"
                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏..."
                        value={rollbackReason}
                        onChange={(e) => setRollbackReason(e.target.value)}
                    ></textarea>
                </div>
            </div>

            <div className="flex gap-3 mt-6">
                <button onClick={() => setShowSuperRollbackModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600 font-bold hover:bg-gray-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onClick={handleSuperRollbackConfirm} className="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 shadow-md">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Rollback</button>
            </div>
        </div>
    </div>
)}



        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</htm
