<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
    .loading { animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .step-dot { transition: all 0.3s ease; }
    .step-line { transition: all 0.5s ease; }
  </style>
</head>
<body class="text-gray-800 h-screen flex overflow-hidden">

  <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col shadow-lg z-20">
    <div class="p-6 border-b border-gray-100">
      <h1 class="text-2xl font-bold text-blue-700 flex items-center gap-2">Purchase<span class="text-gray-800">Hub</span></h1>
    </div>
    <nav class="flex-1 p-4 space-y-2">
      <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn flex items-center gap-3 w-full px-4 py-3 rounded-lg bg-blue-50 text-blue-700 font-medium shadow-sm">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
      <button onclick="switchTab('orders')" id="nav-orders" class="nav-btn flex items-center gap-3 w-full px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50">üõí ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
      <button onclick="switchTab('inventory')" id="nav-inventory" class="nav-btn flex items-center gap-3 w-full px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50">üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏ (Inventory)</button>
      <button onclick="switchTab('assets')" id="nav-assets" class="nav-btn flex items-center gap-3 w-full px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50">üè∑Ô∏è ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</button>
    </nav>
    <div class="p-4 m-4 bg-gray-50 rounded-xl border">
      <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Role (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</p>
      <select id="roleSelector" onchange="loadData()" class="w-full p-2 text-sm border rounded bg-white">
        <option value="User">User (‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠)</option>
        <option value="Head">Head (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å)</option>
        <option value="PM">PM (‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)</option>
        <option value="Purchasing">Purchasing (‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠)</option>
      </select>
    </div>
  </aside>

  <main class="flex-1 flex flex-col relative overflow-hidden">
    <header class="h-16 bg-white border-b flex items-center justify-between px-6 shadow-sm z-10">
      <h2 class="text-lg font-bold text-gray-800" id="pageTitle">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</h2>
      <button onclick="openCreateModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠</button>
    </header>
    <div class="flex-1 overflow-auto p-6 bg-slate-50 relative">
      <div id="loading" class="flex justify-center items-center h-full"><div class="w-10 h-10 border-4 border-blue-200 border-t-blue-600 rounded-full loading"></div></div>
      <div id="dataContainer" class="hidden max-w-7xl mx-auto space-y-6"></div>
    </div>
  </main>

  <div id="createModal" class="fixed inset-0 bg-gray-900/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl overflow-hidden max-h-[95vh] flex flex-col">
      <div class="px-6 py-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
        <h3 class="font-bold text-lg text-gray-800" id="modalTitle">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
      </div>
      <form id="requestForm" onsubmit="submitRequest(event)" class="flex-1 overflow-y-auto p-6 space-y-6">
        <input type="hidden" name="editId" id="editId">
        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-xs font-bold text-gray-500 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
            <select name="type" id="formType" onchange="toggleFileUpload()" class="w-full p-2 border rounded bg-white text-sm" required>
              <option value="Local">Local Purchase</option>
              <option value="HO">Head Office</option>
              <option value="Withdraw">Withdraw</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</label>
            <select name="urgency" id="formUrgency" class="w-full p-2 border rounded bg-white text-sm">
              <option value="Normal">‡∏õ‡∏Å‡∏ï‡∏¥ (Normal)</option>
              <option value="Urgent">‡∏î‡πà‡∏ß‡∏ô (Urgent)</option>
              <option value="Very Urgent">‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å (Very Urgent)</option>
            </select>
          </div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô</label><input type="text" name="job" id="formJob" class="w-full p-2 border rounded text-sm" required></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</label><input type="date" name="dateRequired" id="formDate" class="w-full p-2 border rounded text-sm" required></div>
        </div>
        <div id="hoUploadSection" class="hidden bg-amber-50 p-4 rounded-xl border border-amber-200">
          <label class="block text-sm font-bold text-amber-800 mb-2">üìé ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (HO Only)</label>
          <input type="file" id="fileInput" class="block w-full text-sm text-gray-500"/>
          <p class="text-xs text-amber-600 mt-1" id="fileHint"></p>
        </div>
        <div class="border rounded-xl overflow-hidden shadow-sm">
          <div class="bg-gray-100 px-4 py-2 border-b flex justify-between items-center">
            <h4 class="font-bold text-gray-700 text-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏ (Items)</h4>
            <span class="text-xs text-gray-500">‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</span>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left min-w-[1000px]">
              <thead class="bg-gray-50 text-gray-600 font-medium border-b">
                <tr>
                  <th class="p-3 w-10 text-center">#</th><th class="p-3 w-56">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏</th><th class="p-3 w-40">‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</th><th class="p-3 w-20 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th class="p-3 w-24 text-center">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th><th class="p-3 w-24 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="p-3 w-24">Subjob</th><th class="p-3">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th class="p-3 w-10"></th>
                </tr>
              </thead>
              <tbody id="itemsTableBody" class="divide-y bg-white"></tbody>
            </table>
          </div>
          <button type="button" onclick="addItemRow()" class="w-full py-3 bg-gray-50 text-blue-600 font-bold hover:bg-blue-50 text-sm border-t transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>
      </form>
      <div class="px-6 py-4 border-t bg-gray-50 flex justify-between shrink-0">
         <div id="draftBtnContainer"></div>
         <div class="flex gap-2">
            <button onclick="closeModal()" class="px-6 py-2 rounded-lg text-gray-600 hover:bg-gray-200 font-medium">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="submitForm('Pending Head')" id="submitBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold shadow hover:bg-blue-700">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
         </div>
      </div>
    </div>
  </div>

  <div id="receiveModal" class="fixed inset-0 bg-gray-900/60 hidden items-center justify-center z-[70] p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[95vh] flex flex-col overflow-hidden">
      <div class="px-6 py-4 border-b bg-teal-50 flex justify-between items-center shrink-0">
        <h3 class="font-bold text-xl text-teal-800 flex items-center gap-2">üì• ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á <span id="recvDocId" class="text-sm bg-white px-2 rounded border"></span></h3>
        <button onclick="document.getElementById('receiveModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">‚úï</button>
      </div>
      <div class="flex-1 overflow-y-auto p-6 space-y-8" id="receiveContainer">
        </div>
      <div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-2 shrink-0">
         <button onclick="document.getElementById('receiveModal').classList.add('hidden')" class="px-6 py-2 rounded-lg border bg-white text-gray-600 font-medium">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
         <button onclick="submitReceive()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-bold shadow hover:bg-teal-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</button>
      </div>
    </div>
  </div>

  <div id="historyModal" class="fixed inset-0 bg-gray-900/60 hidden items-center justify-center z-[60] p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden">
      <div class="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
        <div>
           <div class="flex items-center gap-2">
              <h3 class="font-bold text-xl text-gray-800">üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠ <span id="histDocId" class="text-blue-600"></span></h3>
              <span id="histUrgency"></span>
              <span id="histDocBadge" class="hidden text-xs bg-gray-800 text-white px-2 py-0.5 rounded font-mono"></span>
           </div>
           <p class="text-xs text-gray-500 mt-1" id="histJobInfo">Job: ...</p>
        </div>
        <button onclick="document.getElementById('historyModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-1 rounded">‚úï</button>
      </div>
      <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
        <div id="histProgressBar" class="mb-8"></div>
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 mb-6 overflow-hidden">
          <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="bg-gray-100 text-gray-600"><tr><th class="p-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="p-2 w-24">‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</th><th class="p-2 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="p-2 text-center">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th><th class="p-2 text-center">Subjob</th><th class="p-2 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th class="p-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead>
              <tbody id="histItemsBody" class="divide-y"></tbody>
            </table>
          </div>
          <div id="histTotal" class="text-right font-bold text-blue-600 mt-3 border-t pt-2"></div>
        </div>
        <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">üïí ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h4>
        <div class="space-y-4 pl-2" id="histTimeline"></div>
      </div>
    </div>
  </div>

  <script>
    let allRequests = [];
    let stockData = { inventory: [], assets: [] };
    let currentTab = 'dashboard';
    let dashboardFilter = 'All';
    let orderItems = [];
    let receiveItems = [];
    const ALLOWED_UNITS = ['‡∏ä‡∏¥‡πâ‡∏ô', '‡∏≠‡∏±‡∏ô', '‡πÄ‡∏™‡πâ‡∏ô', '‡∏ä‡∏∏‡∏î', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', '‡∏°‡πâ‡∏ß‡∏ô', '‡πÄ‡∏°‡∏ï‡∏£', '‡∏•‡∏¥‡∏ï‡∏£'];
    
    const STATUS_STEPS = {
       'Local': ['Pending Head', 'Pending PM', 'Approved', 'Ordered', 'Completed'],
       'HO': ['Pending Check', 'PR Issued', 'PO Issued', 'Shipping', 'Completed'],
       'Withdraw': ['Pending Head', 'Approved', 'Ready to Disburse', 'Completed']
    };
    const STATUS_LABELS = {
       'Draft': 'Draft', 'Pending Head': '‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤', 'Pending PM': '‡∏£‡∏≠ PM', 'Approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß',
       'Ordered': '‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'Pending Check': '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', 'PR Issued': '‡∏≠‡∏≠‡∏Å PR', 'PO Issued': '‡∏≠‡∏≠‡∏Å PO',
       'Shipping': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á', 'Ready to Disburse': '‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á', 'Completed': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'Rejected': '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
    };

    window.onload = loadData;

    function loadData() {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('dataContainer').classList.add('hidden');
      google.script.run.withSuccessHandler(reqs => {
          allRequests = reqs;
          google.script.run.withSuccessHandler(stock => {
             stockData = stock;
             render();
             document.getElementById('loading').classList.add('hidden');
             document.getElementById('dataContainer').classList.remove('hidden');
          }).getStockData();
      }).getRequests();
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.nav-btn').forEach(btn => btn.className = 'nav-btn flex items-center gap-3 w-full px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50');
      document.getElementById(`nav-${tab}`).className = 'nav-btn flex items-center gap-3 w-full px-4 py-3 rounded-lg bg-blue-50 text-blue-700 font-medium shadow-sm';
      render();
    }

    function render() {
      const container = document.getElementById('dataContainer');
      const role = document.getElementById('roleSelector').value;
      if (currentTab === 'dashboard') renderDashboard(container, allRequests);
      else if (currentTab === 'orders') renderOrders(container, allRequests, role);
      else if (currentTab === 'inventory') renderInventory(container, stockData.inventory);
      else if (currentTab === 'assets') renderAssets(container, stockData.assets);
    }

    // --- DASHBOARD ---
    function renderDashboard(container, data) {
      const stats = { all: data.length, pending: data.filter(r => r.status.includes('Pending')).length, processing: data.filter(r => ['Ordered', 'PO Issued', 'Shipping', 'Approved', 'PR Issued'].includes(r.status)).length, completed: data.filter(r => r.status === 'Completed').length };
      const createCard = (key, title, count, colorClass, bgClass, icon) => `<div onclick="setDashboardFilter('${key}')" class="cursor-pointer p-5 rounded-2xl border border-gray-100 transition-all duration-200 bg-white ${dashboardFilter === key ? `ring-2 ring-offset-1 ring-${colorClass.split('-')[1]}-400 shadow-md transform scale-105` : 'hover:border-gray-300 hover:shadow-sm'}"><div class="flex justify-between items-center mb-2"><p class="text-sm text-gray-500 font-medium">${title}</p><div class="p-2 rounded-lg ${bgClass} ${colorClass}">${icon}</div></div><h3 class="text-3xl font-bold ${colorClass}">${count}</h3></div>`;
      let displayData = data;
      if (dashboardFilter !== 'All') {
        if (dashboardFilter === 'Pending') displayData = data.filter(r => r.status.includes('Pending'));
        else if (dashboardFilter === 'Processing') displayData = data.filter(r => ['Ordered', 'PO Issued', 'Shipping', 'Approved', 'PR Issued'].includes(r.status));
        else if (dashboardFilter === 'Completed') displayData = data.filter(r => r.status === 'Completed');
      }
      container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">${createCard('All', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', stats.all, 'text-blue-600', 'bg-blue-50', 'üìÑ')}${createCard('Pending', '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', stats.pending, 'text-amber-500', 'bg-amber-50', '‚è≥')}${createCard('Processing', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', stats.processing, 'text-indigo-600', 'bg-indigo-50', 'üöö')}${createCard('Completed', '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', stats.completed, 'text-green-600', 'bg-green-50', '‚úÖ')}</div><div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"><div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center"><h3 class="font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${dashboardFilter === 'All' ? '‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' : dashboardFilter} <span class="text-sm font-normal text-gray-400">(${displayData.length})</span></h3></div><div class="divide-y divide-gray-100">${displayData.length === 0 ? '<div class="p-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>' : displayData.slice(0, 10).map(req => renderRequestRowLite(req)).join('')}</div></div>`;
    }
    function setDashboardFilter(filterType) { dashboardFilter = (dashboardFilter === filterType) ? 'All' : filterType; render(); }
    function renderRequestRowLite(req) { return `<div class="p-4 hover:bg-slate-50 transition-colors flex justify-between items-center group cursor-pointer" onclick="openHistoryModal('${req.id}')"><div class="flex items-center gap-3"><span class="text-[10px] px-2 py-0.5 rounded border font-bold ${req.type === 'Local' ? 'bg-orange-50 text-orange-700' : 'bg-purple-50 text-purple-700'}">${req.type}</span><div class="flex flex-col"><span class="text-sm font-bold text-gray-800">${req.items[0]?.name} ${req.items.length > 1 ? `+${req.items.length-1}` : ''}</span><span class="text-xs text-gray-400">${req.id} ‚Ä¢ ${req.requester}</span></div></div><div class="flex items-center gap-3">${req.docNumber ? `<span class="text-[10px] bg-gray-800 text-white px-1.5 py-0.5 rounded font-mono hidden sm:inline-block">${req.docNumber}</span>` : ''}<span class="px-2 py-1 rounded-full text-xs font-bold ${getStatusColor(req.status)}">${STATUS_LABELS[req.status] || req.status}</span><button class="text-gray-400 hover:text-blue-600"><span class="text-lg">‚Ä∫</span></button></div></div>`; }

    // --- ORDERS LIST ---
    function renderOrders(container, data, role) {
      let filtered = data;
      if (role === 'User') filtered = data;
      else if (role === 'Head') filtered = data.filter(r => r.status === 'Pending Head');
      else if (role === 'PM') filtered = data.filter(r => r.status === 'Pending PM');
      else if (role === 'Purchasing') filtered = data.filter(r => (r.type === 'Local' && ['Approved', 'Ordered'].includes(r.status)) || (r.type === 'HO' && ['Pending Check', 'PR Issued', 'PO Issued', 'Shipping'].includes(r.status)));
      if (filtered.length === 0) { container.innerHTML = `<div class="text-center p-10 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì (${role})</div>`; return; }
      container.innerHTML = `<div class="space-y-4">${filtered.map(req => renderRequestCard(req, role)).join('')}</div>`;
    }

    function renderRequestCard(req, role) {
      const totalAmount = req.items.reduce((sum, item) => sum + (item.qty * (item.price || 0)), 0); let actions = '';
      if (role === 'User' && req.status === 'Pending Head') actions = `<button onclick="handleRecall('${req.id}')" class="bg-white border border-red-200 text-red-600 px-4 py-2 rounded-lg text-sm hover:bg-red-50 flex items-center gap-1">‚Ü© ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô</button>`;
      else if (role === 'User' && req.status === 'Draft') actions = `<button onclick="openEditModal('${req.id}')" class="bg-white border border-indigo-200 text-indigo-600 px-4 py-2 rounded-lg text-sm hover:bg-indigo-50 flex items-center gap-1">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>`;
      else if (role === 'Head' && req.status === 'Pending Head') actions = `<button onclick="updateStatus('${req.id}', 'Pending PM')" class="bg-orange-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-orange-600">‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ PM</button>`;
      else if (role === 'PM' && req.status === 'Pending PM') actions = `<button onclick="updateStatus('${req.id}', 'Approved')" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>`;
      else if (role === 'Purchasing') {
         if (req.type === 'Local' && req.status === 'Approved') actions = `<button onclick="updateStatus('${req.id}', 'Ordered')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß</button>`;
         else if (req.type === 'HO') {
             if (req.status === 'Pending Check') actions = `<button onclick="handleHOInput('${req.id}', 'PR Issued', '‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç PR')" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700">‡∏≠‡∏≠‡∏Å PR</button>`;
             else if (req.status === 'PR Issued') actions = `<button onclick="handleHOInput('${req.id}', 'PO Issued', '‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç PO')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700">‡∏≠‡∏≠‡∏Å PO</button>`;
             else if (req.status === 'PO Issued') actions = `<button onclick="updateStatus('${req.id}', 'Shipping')" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-teal-700">‡∏Ç‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤</button>`;
         }
         // Receive Button
         if ((req.type === 'Local' && req.status === 'Ordered') || (req.type === 'HO' && req.status === 'Shipping')) {
             actions = `<button onclick="openReceiveModal('${req.id}')" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm shadow hover:bg-teal-700 flex items-center gap-1">üì• ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</button>`;
         }
      }
      const attachmentBadge = req.attachment ? `<a href="${req.attachment}" target="_blank" class="flex items-center gap-1 text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded border border-amber-200 hover:underline">üìé ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</a>` : '';
      const historyBtn = `<button onclick="openHistoryModal('${req.id}')" class="text-gray-500 hover:text-gray-700 text-sm font-medium flex items-center gap-1"><span class="text-lg">üïí</span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>`;
      return `<div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm flex flex-col gap-4"><div class="flex justify-between items-start"><div class="flex gap-4"><div class="p-3 bg-slate-100 rounded-xl text-center min-w-[60px]"><div class="text-xs font-bold text-gray-500">${req.type}</div><div class="font-bold text-blue-600">${req.id.split('-')[1]}</div></div><div><h4 class="font-bold text-gray-800 flex items-center gap-2 cursor-pointer hover:text-blue-600" onclick="openHistoryModal('${req.id}')">${req.items[0]?.name} ${req.items.length > 1 ? `+${req.items.length-1}` : ''} ${attachmentBadge}</h4><p class="text-xs text-gray-500 mt-1">Job: ${req.job} | By: ${req.requester}</p><div class="mt-2 text-sm text-gray-600">${req.items.slice(0,2).map(i => `<div class="flex justify-between w-full max-w-md border-b border-dashed border-gray-100 py-1"><span>- ${i.name}</span> <span class="text-gray-400">x${i.qty}</span></div>`).join('')}</div>${totalAmount > 0 ? `<div class="text-sm font-bold text-blue-600 mt-1">‡∏£‡∏ß‡∏°: ${totalAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>` : ''}</div></div><div class="flex flex-col items-end gap-2"><span class="px-3 py-1 rounded-full text-xs font-bold ${getStatusColor(req.status)}">${STATUS_LABELS[req.status] || req.status}</span>${req.docNumber ? `<span class="text-xs bg-gray-800 text-white px-2 py-1 rounded font-mono">DOC: ${req.docNumber}</span>` : ''}</div></div>${renderProgressBar(req.type, req.status)}<div class="pt-3 border-t flex justify-between items-center">${historyBtn}<div class="flex gap-2">${actions}</div></div></div>`;
    }

    // --- INVENTORY RENDER ---
    function renderInventory(container, data) {
       let html = `<div class="bg-white rounded-xl border shadow-sm overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-gray-600"><tr><th class="p-3">‡∏£‡∏´‡∏±‡∏™</th><th class="p-3">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="p-3 text-center">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th class="p-3 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th><th class="p-3">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th><th class="p-3">‡∏£‡∏π‡∏õ</th></tr></thead><tbody class="divide-y">`;
       if(data.length === 0) html += `<tr><td colspan="6" class="p-4 text-center text-gray-400">‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</td></tr>`;
       data.forEach(item => {
          let imgs = item.image ? item.image.split(',') : [];
          let imgHtml = imgs.length > 0 ? `<a href="${imgs[0]}" target="_blank" class="text-blue-500 hover:underline">‡∏î‡∏π‡∏£‡∏π‡∏õ (${imgs.length})</a>` : '-';
          html += `<tr><td class="p-3 font-mono text-gray-500">${item.id}</td><td class="p-3 font-bold text-gray-800">${item.name}</td><td class="p-3 text-center"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold">${item.qty} ${item.unit}</span></td><td class="p-3 text-right">${(item.price||0).toLocaleString()}</td><td class="p-3 text-xs text-gray-500">${item.lastUpdated}</td><td class="p-3">${imgHtml}</td></tr>`;
       });
       html += `</tbody></table></div>`;
       container.innerHTML = html;
    }

    // --- ASSETS RENDER ---
    function renderAssets(container, data) {
       let html = `<div class="bg-white rounded-xl border shadow-sm overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-gray-600"><tr><th class="p-3">Asset ID</th><th class="p-3">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</th><th class="p-3">Serial No.</th><th class="p-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="p-3">‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á</th><th class="p-3">‡∏£‡∏π‡∏õ</th></tr></thead><tbody class="divide-y">`;
       if(data.length === 0) html += `<tr><td colspan="6" class="p-4 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</td></tr>`;
       data.forEach(item => {
          const statusColor = item.status === 'Available' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700';
          let imgs = item.image ? item.image.split(',') : [];
          let imgHtml = imgs.length > 0 ? `<a href="${imgs[0]}" target="_blank" class="text-blue-500 hover:underline">‡∏î‡∏π‡∏£‡∏π‡∏õ (${imgs.length})</a>` : '-';
          html += `<tr><td class="p-3 font-mono text-indigo-600 font-bold">${item.id}</td><td class="p-3">${item.name}</td><td class="p-3 font-mono text-xs">${item.serial}</td><td class="p-3 text-center"><span class="px-2 py-1 rounded text-xs ${statusColor}">${item.status}</span></td><td class="p-3">${item.holder}</td><td class="p-3">${imgHtml}</td></tr>`;
       });
       html += `</tbody></table></div>`;
       container.innerHTML = html;
    }

    // --- RECEIVE GOODS LOGIC ---
    function openReceiveModal(reqId) {
       const req = allRequests.find(r => r.id === reqId); if(!req) return;
       document.getElementById('recvDocId').innerText = req.id;
       receiveItems = req.items.map(i => {
           const defaultQty = parseInt(i.qty);
           return {
               name: i.name,
               reqQty: defaultQty,
               qty: defaultQty,
               unit: i.unit,
               price: i.price,
               realPrice: i.price,
               targetType: req.type === 'HO' ? 'Asset' : 'Inventory',
               assetsList: Array.from({length: defaultQty}, (_,k) => ({
                   id: '', 
                   name: i.name, 
                   serial: '', 
                   realPrice: i.price, 
                   images: [] 
               })), 
               images: []
           };
       });
       renderReceiveItems();
       document.getElementById('receiveModal').classList.remove('hidden');
    }

    function renderReceiveItems() {
       document.getElementById('receiveContainer').innerHTML = receiveItems.map((item, idx) => `
         <div class="border rounded-2xl p-5 bg-gray-50 shadow-sm border-gray-200">
            <div class="flex flex-col md:flex-row justify-between items-start mb-4 gap-4">
               <div class="flex-1">
                  <h4 class="font-bold text-lg text-gray-800">${item.name}</h4>
                  <div class="flex items-center gap-4 text-sm mt-1 text-gray-600"><span>‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠: <b>${item.reqQty}</b> ${item.unit}</span><span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≠: <b>${(item.price||0).toLocaleString()}</b></span></div>
               </div>
               <div class="flex gap-2 bg-white p-1 rounded-lg border">
                  <button onclick="setTargetType(${idx}, 'Inventory')" class="px-4 py-1.5 rounded-md text-sm transition-all ${item.targetType==='Inventory' ? 'bg-blue-100 text-blue-700 font-bold shadow-sm' : 'text-gray-500 hover:bg-gray-100'}">‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏</button>
                  <button onclick="setTargetType(${idx}, 'Asset')" class="px-4 py-1.5 rounded-md text-sm transition-all ${item.targetType==='Asset' ? 'bg-indigo-100 text-indigo-700 font-bold shadow-sm' : 'text-gray-500 hover:bg-gray-100'}">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</button>
               </div>
            </div>
            ${item.targetType === 'Inventory' ? renderInventoryInput(idx, item) : renderAssetCards(idx, item)}
         </div>`).join('');
    }

    function renderInventoryInput(idx, item) {
       return `
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 bg-white p-3 rounded-xl border border-gray-200">
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏£‡∏¥‡∏á (‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢)</label><input type="number" class="w-full border p-2 rounded-lg text-sm font-bold text-green-700 bg-green-50" value="${item.realPrice}" onchange="updateRecvItem(${idx}, 'realPrice', this.value)"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ)</label><input type="file" multiple accept="image/*" onchange="handleRecvImages(${idx}, this)" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><div class="flex gap-2 mt-2 overflow-x-auto">${item.images.map(img => `<span class="text-[10px] bg-gray-100 px-2 py-1 rounded border truncate max-w-[100px]">${img.name}</span>`).join('')}</div></div>
         </div>
         <div class="p-4 bg-blue-50 text-blue-800 text-sm rounded-xl border border-blue-200 flex items-center justify-between">
            <div class="flex items-center gap-2"><span class="text-xl">üì¶</span><div><p class="font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p><p class="text-xs opacity-75">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏ß‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p></div></div>
            <div class="text-right"><label class="text-xs font-bold block mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</label><input type="number" class="w-24 p-2 rounded border text-center font-bold" value="${item.qty}" onchange="updateRecvItem(${idx}, 'qty', this.value)"></div>
         </div>`;
    }

    function renderAssetCards(idx, item) {
       return `
         <div class="space-y-3 mt-4">
            <div class="flex justify-between items-center px-1">
               <p class="text-sm font-bold text-indigo-700 flex items-center gap-2"><span class="bg-indigo-100 p-1 rounded">üè∑Ô∏è</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (${item.assetsList.length} ‡∏ä‡∏¥‡πâ‡∏ô)</p>
               <button onclick="addAssetCard(${idx})" class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded-lg hover:bg-indigo-700 shadow flex items-center gap-1">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
               ${item.assetsList.map((ast, aIdx) => `
                  <div class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition-shadow relative group">
                     <button onclick="removeAssetCard(${idx}, ${aIdx})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 font-bold p-1">√ó</button>
                     <div class="space-y-3">
                        <div><label class="text-[10px] text-gray-400 font-bold uppercase block">Asset Name (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</label><input type="text" class="w-full border-b border-gray-300 py-1 text-sm font-bold text-gray-800 focus:border-indigo-500 outline-none bg-transparent" value="${ast.name}" onchange="updateAssetCard(${idx}, ${aIdx}, 'name', this.value)"></div>
                        <div class="grid grid-cols-2 gap-2">
                           <div><label class="text-[10px] text-gray-400 font-bold uppercase block">Asset ID</label><input type="text" placeholder="AST-XXX" class="w-full bg-gray-50 border rounded p-1.5 text-xs font-mono" value="${ast.id}" onchange="updateAssetCard(${idx}, ${aIdx}, 'id', this.value)"></div>
                           <div><label class="text-[10px] text-gray-400 font-bold uppercase block">Serial No.</label><input type="text" placeholder="S/N" class="w-full bg-gray-50 border rounded p-1.5 text-xs font-mono" value="${ast.serial}" onchange="updateAssetCard(${idx}, ${aIdx}, 'serial', this.value)"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 pt-2 border-t border-dashed">
                           <div><label class="text-[10px] text-green-600 font-bold uppercase block">Real Price</label><input type="number" class="w-full border rounded p-1.5 text-xs font-bold text-green-700 bg-green-50" value="${ast.realPrice}" onchange="updateAssetCard(${idx}, ${aIdx}, 'realPrice', this.value)"></div>
                           <div><label class="text-[10px] text-blue-600 font-bold uppercase block">Images</label><input type="file" multiple accept="image/*" class="w-full text-[10px]" onchange="handleAssetCardImages(${idx}, ${aIdx}, this)"><div class="flex gap-1 mt-1 overflow-x-auto">${(ast.images||[]).map(img=>`<div class="w-4 h-4 bg-gray-200 rounded border"></div>`).join('')} <span class="text-[9px] text-gray-400">${(ast.images||[]).length} ‡∏£‡∏π‡∏õ</span></div></div>
                        </div>
                     </div>
                  </div>
               `).join('')}
            </div>
         </div>`;
    }

    function setTargetType(idx, type) { receiveItems[idx].targetType = type; renderReceiveItems(); }
    function updateRecvItem(idx, field, val) { receiveItems[idx][field] = val; }
    function updateAssetCard(itemIdx, assetIdx, field, val) { receiveItems[itemIdx].assetsList[assetIdx][field] = val; }
    function addAssetCard(itemIdx) { receiveItems[itemIdx].assetsList.push({ id: '', name: receiveItems[itemIdx].name, serial: '', realPrice: receiveItems[itemIdx].price, images: [] }); renderReceiveItems(); }
    function removeAssetCard(itemIdx, assetIdx) { if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) { receiveItems[itemIdx].assetsList.splice(assetIdx, 1); renderReceiveItems(); } }

    function handleRecvImages(idx, input) {
       if(input.files && input.files.length > 0) {
          const files = Array.from(input.files);
          receiveItems[idx].images = [];
          let processed = 0;
          files.forEach(file => {
             const reader = new FileReader();
             reader.onload = e => { receiveItems[idx].images.push({ data: e.target.result, name: file.name }); processed++; if(processed === files.length) renderReceiveItems(); };
             reader.readAsDataURL(file);
          });
       }
    }

    function handleAssetCardImages(itemIdx, assetIdx, input) {
       if(input.files && input.files.length > 0) {
          const files = Array.from(input.files);
          receiveItems[itemIdx].assetsList[assetIdx].images = [];
          let processed = 0;
          files.forEach(file => {
             const reader = new FileReader();
             reader.onload = e => { receiveItems[itemIdx].assetsList[assetIdx].images.push({ data: e.target.result, name: file.name }); processed++; if(processed === files.length) renderReceiveItems(); };
             reader.readAsDataURL(file);
          });
       }
    }

    function submitReceive() {
       const docId = document.getElementById('recvDocId').innerText;
       const user = document.getElementById('roleSelector').value;
       for(let item of receiveItems) { if(item.targetType === 'Asset') { for(let ast of item.assetsList) { if(!ast.id) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Asset ID ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î'); return; } } } }
       const btn = document.querySelector('button[onclick="submitReceive()"]'); btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled = true;
       google.script.run.withSuccessHandler(res => { if(res.success) { document.getElementById('receiveModal').classList.add('hidden'); loadData(); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); } else { alert('Error: ' + res.message); } btn.innerText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á'; btn.disabled = false; }).receiveGoods({ reqId: docId, user: user, itemsJson: JSON.stringify(receiveItems) });
    }

    // --- OTHER FUNCS ---
    function openCreateModal() { resetModal(); document.getElementById('modalTitle').innerText = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠'; document.getElementById('draftBtnContainer').innerHTML = `<button type="button" onclick="submitForm('Draft')" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πà‡∏≤‡∏á</button>`; document.getElementById('createModal').classList.remove('hidden'); }
    function openEditModal(reqId) { const req = allRequests.find(r => r.id === reqId); if(!req) return; resetModal(); document.getElementById('modalTitle').innerText = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠: ${req.id}`; document.getElementById('editId').value = req.id; document.getElementById('formType').value = req.type; document.getElementById('formJob').value = req.job; document.getElementById('formDate').value = req.dateRequired; document.getElementById('formUrgency').value = req.urgency || 'Normal'; orderItems = JSON.parse(JSON.stringify(req.items)); renderItemsTable(); toggleFileUpload(); if(req.attachment) document.getElementById('fileHint').innerText = `‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß: ${req.attachment}`; document.getElementById('draftBtnContainer').innerHTML = `<button type="button" onclick="submitForm('Draft')" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πà‡∏≤‡∏á</button>`; document.getElementById('createModal').classList.remove('hidden'); }
    function resetModal() { document.getElementById('requestForm').reset(); document.getElementById('editId').value = ''; document.getElementById('fileHint').innerText = ''; orderItems = [{ name: '', qty: 1, unit: '‡∏ä‡∏¥‡πâ‡∏ô', price: 0, subjob: '', note: '', imageUrl: null }]; renderItemsTable(); toggleFileUpload(); }
    function closeModal() { document.getElementById('createModal').classList.add('hidden'); }
    function toggleFileUpload() { const type = document.getElementById('formType').value; document.getElementById('hoUploadSection').className = type === 'HO' ? 'block bg-amber-50 p-4 rounded-xl border border-amber-200' : 'hidden'; }
    function addItemRow() { orderItems.push({ name: '', qty: 1, unit: '‡∏ä‡∏¥‡πâ‡∏ô', price: 0, subjob: '', note: '', imageUrl: null }); renderItemsTable(); }
    function updateItem(index, field, value) { orderItems[index][field] = value; }
    function handleItemImage(index, input) { if(input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { orderItems[index].imageData = e.target.result; orderItems[index].imageName = input.files[0].name; }; reader.readAsDataURL(input.files[0]); } }
    function renderItemsTable() { document.getElementById('itemsTableBody').innerHTML = orderItems.map((item, idx) => `<tr><td class="p-2 text-center text-gray-400 text-xs">${idx + 1}</td><td class="p-2"><input type="text" class="w-full border rounded p-1.5 text-sm" value="${item.name}" onchange="updateItem(${idx}, 'name', this.value)" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏..." required></td><td class="p-2"><input type="file" accept="image/*" class="w-full text-xs text-gray-500" onchange="handleItemImage(${idx}, this)">${item.imageUrl ? `<a href="${item.imageUrl}" target="_blank" class="text-[10px] text-blue-500 hover:underline block mt-1">‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°</a>` : ''}</td><td class="p-2"><input type="number" step="1" onkeypress="return event.charCode >= 48 && event.charCode <= 57" class="w-full border rounded p-1.5 text-sm text-center" value="${item.qty}" onchange="updateItem(${idx}, 'qty', this.value)" min="1"></td><td class="p-2"><select class="w-full border rounded p-1.5 text-sm text-center bg-white" onchange="updateItem(${idx}, 'unit', this.value)">${ALLOWED_UNITS.map(u => `<option value="${u}" ${item.unit === u ? 'selected' : ''}>${u}</option>`).join('')}</select></td><td class="p-2"><input type="number" class="w-full border rounded p-1.5 text-sm text-right" value="${item.price}" onchange="updateItem(${idx}, 'price', this.value)" placeholder="0.00"></td><td class="p-2"><input type="text" class="w-full border rounded p-1.5 text-sm" value="${item.subjob}" onchange="updateItem(${idx}, 'subjob', this.value)" placeholder="Subjob"></td><td class="p-2"><input type="text" class="w-full border rounded p-1.5 text-sm" value="${item.note}" onchange="updateItem(${idx}, 'note', this.value)" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"></td><td class="p-2 text-center"><button type="button" onclick="orderItems.splice(${idx}, 1); renderItemsTable();" class="text-red-400 hover:text-red-600 font-bold p-1">√ó</button></td></tr>`).join(''); }
    let targetStatus = 'Pending Head'; 
    function submitForm(status) { targetStatus = status; document.getElementById('requestForm').dispatchEvent(new Event('submit')); }
    function submitRequest(e) { e.preventDefault(); const form = document.getElementById('requestForm'); const formData = new FormData(form); const editId = document.getElementById('editId').value; const reqData = { id: editId, requester: 'Somsak', type: formData.get('type'), job: formData.get('job'), dateRequired: formData.get('dateRequired'), urgency: formData.get('urgency'), status: formData.get('type') === 'HO' && targetStatus !== 'Draft' ? 'Pending Check' : targetStatus, items: orderItems, fileData: null, fileName: null }; const btn = document.getElementById('submitBtn'); btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled = true; const fileInput = document.getElementById('fileInput'); const finalize = () => { google.script.run.withSuccessHandler(res => { if(res.success) { closeModal(); loadData(); } btn.innerText = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠'; btn.disabled = false; })[editId ? 'editRequest' : 'createRequest'](reqData); }; if (reqData.type === 'HO' && fileInput.files.length > 0) { const reader = new FileReader(); reader.onload = function(e) { reqData.fileData = e.target.result; reqData.fileName = fileInput.files[0].name; finalize(); }; reader.readAsDataURL(fileInput.files[0]); } else { finalize(); } }
    function handleRecall(id) { if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç?')) return; google.script.run.withSuccessHandler(res => { if(res.success) loadData(); }).updateRequestStatus(id, 'Draft', 'Somsak', 'User Recalled'); }
    function updateStatus(id, newStatus) { if(!confirm(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${newStatus}?`)) return; google.script.run.withSuccessHandler(res => { if(res.success) loadData(); }).updateRequestStatus(id, newStatus, document.getElementById('roleSelector').value); }
    function handleHOInput(id, status, promptText) { const v = prompt(promptText); if (v === null) return; if (!v.trim()) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; } const user = document.getElementById('roleSelector').value; const note = `${status.split(' ')[0]} Number: ${v}`; google.script.run.withSuccessHandler(res => { if (res.success) loadData(); }).updateRequestStatus(id, status, user, note, status === 'PO Issued' ? v : null); }
    function getStatusColor(status) { if(status === 'Draft') return 'bg-gray-200 text-gray-600 border border-gray-300'; if(status.includes('Pending')) return 'bg-amber-100 text-amber-800'; if(['Approved', 'Ordered', 'PR Issued', 'PO Issued'].includes(status)) return 'bg-green-100 text-green-800'; return 'bg-gray-100 text-gray-600'; }
    function getLogColor(action) { if(action.includes('‡∏™‡∏£‡πâ‡∏≤‡∏á') || action.includes('Draft')) return 'bg-gray-400'; if(action.includes('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç') || action.includes('Recalled')) return 'bg-yellow-400'; if(action.includes('Approved') || action.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')) return 'bg-green-500'; if(action.includes('Ordered') || action.includes('‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠') || action.includes('PO')) return 'bg-blue-500'; if(action.includes('PR')) return 'bg-purple-500'; if(action.includes('Rejected')) return 'bg-red-500'; return 'bg-indigo-400'; }
    function renderProgressBar(type, status) { if(status === 'Draft') return ''; if(status === 'Rejected') return '<div class="w-full bg-red-100 text-red-700 text-center text-xs py-1 rounded font-bold">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Rejected)</div>'; let steps = STATUS_STEPS[type] || STATUS_STEPS['Local']; let currentIndex = steps.indexOf(status); if(currentIndex === -1 && status === 'Approved' && type === 'Withdraw') currentIndex = 1; let html = '<div class="w-full mt-3 mb-4"><div class="flex justify-between mb-2">'; steps.forEach((step, idx) => { let active = idx <= currentIndex; let label = STATUS_LABELS[step] || step; html += `<div class="flex flex-col items-center w-full relative"><div class="w-2.5 h-2.5 rounded-full mb-1 z-10 ${active ? 'bg-blue-600 scale-110' : 'bg-gray-200'} step-dot"></div><span class="text-[9px] ${active ? 'text-blue-600 font-bold' : 'text-gray-300'} text-center hidden sm:block">${label}</span></div>`; }); html += '</div><div class="h-1 bg-gray-100 rounded-full overflow-hidden flex relative top-[-1.6rem] z-0 mx-4">'; steps.forEach((step, idx) => { if(idx === steps.length - 1) return; let active = idx < currentIndex; html += `<div class="h-full flex-1 border-r border-white ${active ? 'bg-blue-500' : (idx === currentIndex ? 'bg-blue-200' : 'bg-transparent')} step-line"></div>`; }); html += '</div></div>'; return html; }
    function openHistoryModal(reqId) { const req = allRequests.find(r => r.id === reqId); if(!req) return; document.getElementById('histDocId').innerText = req.id; document.getElementById('histJobInfo').innerText = `Job: ${req.job} | By: ${req.requester} | Date: ${req.created}`; document.getElementById('histUrgency').innerText = req.urgency || 'Normal'; document.getElementById('histUrgency').className = `px-2 py-0.5 rounded text-xs font-bold border ${req.urgency === 'Very Urgent' ? 'bg-red-100 text-red-700' : 'bg-gray-100'}`; const docEl = document.getElementById('histDocBadge'); if (req.docNumber) { docEl.innerText = req.docNumber; docEl.classList.remove('hidden'); } else { docEl.classList.add('hidden'); } document.getElementById('histProgressBar').innerHTML = renderProgressBar(req.type, req.status); let total = 0; document.getElementById('histItemsBody').innerHTML = req.items.map(item => { const sum = item.qty * (item.price || 0); total += sum; return `<tr><td class="p-2 align-top"><span class="font-bold text-gray-800 block">${item.name}</span></td><td class="p-2 text-center align-top">${item.imageUrl ? `<a href="${item.imageUrl}" target="_blank"><img src="${item.imageUrl}" class="w-10 h-10 object-cover rounded border hover:scale-150 transition-transform"></a>` : '-'}</td><td class="p-2 text-center align-top">${item.qty}</td><td class="p-2 text-center text-xs align-top">${item.unit}</td><td class="p-2 text-center text-xs align-top">${item.subjob || '-'}</td><td class="p-2 text-right align-top">${(item.price||0).toLocaleString()}</td><td class="p-2 text-xs italic align-top">${item.note || '-'}</td></tr>`; }).join(''); document.getElementById('histTotal').innerText = total > 0 ? `Total: ${total.toLocaleString()} THB` : ''; const historyLog = req.history || []; document.getElementById('histTimeline').innerHTML = historyLog.map((log, index) => `<div class="relative flex gap-4">${index !== historyLog.length - 1 ? '<div class="absolute left-[11px] top-6 bottom-[-16px] w-0.5 bg-gray-200"></div>' : ''}<div class="w-6 h-6 rounded-full flex items-center justify-center shrink-0 ${getLogColor(log.action)} z-10"><div class="w-2.5 h-2.5 bg-white rounded-full"></div></div><div class="pb-6"><p class="text-xs text-gray-400 mb-0.5">${log.date}</p><p class="font-bold text-gray-800 text-sm">${STATUS_LABELS[log.action] || log.action}</p><p class="text-xs text-gray-500">‡πÇ‡∏î‡∏¢: ${log.user} ${log.note ? `(${log.note})` : ''}</p></div></div>`).join(''); document.getElementById('historyModal').classList.remove('hidden'); }
  </script>
</body>
</html>
