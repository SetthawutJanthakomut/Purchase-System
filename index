<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>PurchaseHub System</title>
  
  <script src="https://cdn.tailwindcss.com"></script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    .animate-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }




  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // =================================================================
    // --- ICON SYSTEM (EXPLICIT SAFE MODE) ---
    // สร้าง Component รอไว้เลย ไม่ต้องรอ Library โหลดเสร็จ ป้องกัน Error 100%
    // =================================================================
    
// รายชื่อไอคอนทั้งหมดที่ใช้ในแอปนี้
    const USED_ICONS = [
      'LayoutDashboard', 'Plus', 'Package', 'CheckCircle', 'Clock', 
      'FileText', 'Search', 'User', 'LogOut', 'ChevronRight', 
      'ShoppingCart', 'Truck', 'AlertCircle', 'Paperclip',
      'HardHat', 'Briefcase', 'Building', 'ShieldCheck', 'BadgeCheck',
      'UploadCloud', 'FileCheck', 'Sparkles', 'X', 'MessageSquare', 'History', 
      'Store', 'Mail', 'Trash2', 'FileInput',
      'Save', 'Edit', 'RotateCcw', 'Send', 'AlertTriangle', 'Bell', 'Pencil', 'Box', 'Filter', 'RefreshCw', 'ArrowRight', 'List', 'ClipboardList', 'ArrowLeftRight', 
      'Monitor', 'Smartphone', 'Tag', 'Wrench', 'ArrowUpDown', 'Download', 
      'Image', // Alias: ImageIcon
      'Eye', 'XCircle', 'Camera', 
      'Info', 
      'Printer', 'CornerUpLeft', 'CheckSquare', 'XSquare', 'ExternalLink', 'PlayCircle', 'ArrowUpRight', 'PenTool', 'FileSignature', 'Calendar', 'CalendarClock', 'CreditCard', 'Flame', 'MousePointerClick',
      'Upload',
      'Settings',
      'Lock',
      'Menu', // ⭐ เพิ่มไอคอน Menu ตรงนี้
      'Eye', 'EyeOff',
      'BellOff', 'Megaphone'// ⭐⭐⭐ เพิ่มบรรทัดนี้ครับ (อย่าลืม comma ข้างหลัง Settings ด้วย)
    ];
    const lucideReact = {};
    // --- PERMISSION CONSTANTS ---
    const PERMISSIONS = {
        1:  'ดูอย่างเดียว (Read Only)',
        2:  'Admin (ได้สิทธิ์ทุกสิทธิ์ในโครงการ)',
        3:  'Sub-Admin (สร้างคำขอซื้อ/เบิก/ยืม ได้ทั้งหมด)',
        4:  'สร้างคำขอ: ซื้อ Local',
        5:  'สร้างคำขอ: ซื้อ HO',
        6:  'สร้างคำขอ: เบิกวัสดุ',
        7:  'สร้างคำขอ: ยืมทรัพย์สิน',
        8:  'อนุมัติ: (Level 1)',
        9:  'อนุมัติ: (Level 2)',
        10: 'ตรวจสอบเอกสาร (Verify)',
        11: 'ออกใบขอซื้อ (Issue PR)',
        12: 'ออกใบสั่งซื้อ (Issue PO)',
        13: 'อัปเดตการจัดส่ง (Shipping)',
        14: 'จัดการสัญญาเช่า (Contract)',
        15: 'รับของเข้าคลัง (Receive Goods)',
        16: 'เพิ่มสินค้า (Add Inv)',
        17: 'แก้ไขสินค้า (Edit Inv)',
        18: 'ลบสินค้า (Delete Inv)',
        19: 'เพิ่มทรัพย์สิน (Add Asset)',
        20: 'แก้ไขทรัพย์สิน (Edit Asset)',
        21: 'ลบทรัพย์สิน (Delete Asset)',
        22: 'Import CSV (สินค้า)',
        23: 'Import CSV (ทรัพย์สิน)',
        24: 'จ่ายของ/ยืม (Disburse)',
        25: 'รับคืนทรัพย์สิน (Return Asset)',
        26: 'จัดการโครงการ (Project Settings)',
        27: 'กู้คืนข้อมูล (Restore)',
        28: 'จัดการประกาศ (Manage Announcement)',
        // ⭐ เพิ่มสิทธิ์ใหม่
        29: 'แก้ไขต้นทุน/รหัส (Cost Control)' 
    };

    // Helper: แปลง PascalCase -> kebab-case
    const pascalToKebab = (str) => str.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g, '$1-$2').toLowerCase().replace(/^-/, '');

    // สร้าง Component ปลอมรอไว้สำหรับทุกไอคอน
    USED_ICONS.forEach(name => {
        lucideReact[name] = (props) => {
            // 1. เช็คว่า Library มาหรือยัง
            if (!window.lucide || !window.lucide.icons) {
                return React.createElement('div', { 
                    style: { width: props.size || 24, height: props.size || 24, background: '#eee', borderRadius: 4, display: 'inline-block' },
                    className: props.className
                });
            }

            const cleanName = pascalToKebab(name);
            const iconData = window.lucide.icons[cleanName];

            // 2. ถ้าหาไอคอนไม่เจอ (อาจจะชื่อผิด) ให้แสดง Fallback
            if (!iconData) {
                return null;
            }

            // 3. วาดไอคอนจริง
            const tag = iconData[0];
            const attrs = iconData[1];
            const children = iconData[2];

            return React.createElement(tag, {
                ...attrs,
                width: props.size || 24,
                height: props.size || 24,
                stroke: props.color || "currentColor",
                strokeWidth: props.strokeWidth || (attrs ? attrs["stroke-width"] : 2),
                className: `lucide lucide-${cleanName} ${props.className || ""}`,
                ...props
            }, children.map((child, idx) => 
                React.createElement(child[0], { ...child[1], key: idx })
            ));
        };
    });

    // =================================================================
    // --- APP LOGIC ---
    // =================================================================

    // ดึงตัวแปร Icon (มั่นใจได้ว่ามีครบทุกตัวแน่นอน)
const {
      LayoutDashboard, Plus, Package, CheckCircle, Clock, 
      FileText, Search, User, LogOut, ChevronRight, 
      ShoppingCart, Truck, AlertCircle, Paperclip,
      HardHat, Briefcase, Building, ShieldCheck, BadgeCheck,
      UploadCloud, FileCheck, Sparkles, X, MessageSquare, History, Store, Mail, Trash2, FileInput,
      Save, Edit, RotateCcw, Send, AlertTriangle, Bell, Pencil, Box, Filter, RefreshCw, ArrowRight, List, ClipboardList, ArrowLeftRight, Monitor, Smartphone, Tag, Wrench, ArrowUpDown, Download, 
      Image: ImageIcon, 
      Eye, XCircle, Camera, 
      Paperclip: AttachmentIcon, 
      Info, 
      Briefcase: BriefcaseIcon, 
      Printer, CornerUpLeft, CheckSquare, XSquare, ExternalLink, PlayCircle, ArrowUpRight, PenTool, FileSignature, Calendar, CalendarClock, CreditCard, Flame, MousePointerClick,
      Upload,
      Settings,Lock,EyeOff, 
      BellOff, Megaphone,
      Menu // ⭐ เพิ่มตรงนี้ครับ
    } = lucideReact;

    // Manual Aliasing for missing/renamed icons
    // (กรณีที่ชื่อใน Array ข้างบนไม่ตรงกับตัวแปรที่ใช้)
    if (!BriefcaseIcon) lucideReact.BriefcaseIcon = lucideReact.Briefcase;
    if (!AttachmentIcon) lucideReact.AttachmentIcon = lucideReact.Paperclip;

    const createIcon = (name) => (props) => {
        const Icon = lucideReact[name];
        return Icon ? React.createElement(Icon, props) : null;
    };

    // --- Configuration & Constants ---
const ROLES = {
      ADMIN: 'Admin (ผู้ดูแลระบบ)',
      USER: 'User (ผู้ขอซื้อ)',
      DEPT_HEAD: 'ผู้อนุมัติ Level 1 (Head)', // เปลี่ยนชื่อ
      PM: 'ผู้อนุมัติ Level 2 (PM)',         // เปลี่ยนชื่อ
      PURCHASING: 'ฝ่ายจัดซื้อ (HO & Local Buyer)',
      STORE: 'Store Keeper (ผู้ดูแลคลัง)'
    };

    const RENTAL_UNITS = {
        'Day': 'บาท/วัน',
        'Month': 'บาท/เดือน',
        'Year': 'บาท/ปี'
    };

    const ITEM_UNITS = [
        'EA', // (Each) หน่วยนับมาตรฐาน
        'ชิ้น', 'อัน', 'ชุด', 
        'เส้น', 'เมตร', 'ม้วน', 
        'kg', 'ลิตร', 'แกลลอน', 'ถุง', 'ปี๊บ', 'กระป๋อง', 'ขวด', 'หลอด', // ของเหลว/วัสดุ
        'ใบ', 'ตัว', 'คู่', 'ข้าง', // เสื้อผ้า/อุปกรณ์เซฟตี้
        'เครื่อง', 'คัน', // เครื่องจักร/ยานพาหนะ
        'เล่ม', 'แผ่น', 'ด้าม', 'ตลับ' // เครื่องเขียน/สำนักงาน
        // ❌ ตัดออก: กล่อง, แพ็ค, ลัง, โหล, รีม (เพื่อให้แตกเป็นหน่วยย่อยเสมอ)
    ];

    const ASSET_STATUS_LABELS = {
    'Available': 'ว่าง',
    'Borrowed': 'ถูกยืม',
    'Lost': 'สูญหาย',
    'Damaged': 'ชำรุด'
};


    const PRIORITIES = {
        'Normal': { label: 'ปกติ', color: 'bg-blue-100 text-blue-700 border-blue-200' },
        'Urgent': { label: 'ด่วน', color: 'bg-orange-100 text-orange-700 border-orange-200' },
        'Critical': { label: 'ด่วนมาก', color: 'bg-red-100 text-red-700 border-red-200' }
    };

const STATUS_LABELS = {
      'Draft': 'แบบร่าง (Draft)',
      'Pending Check': 'รอฝ่ายจัดซื้อตรวจสอบ (Check)',
      'Revise Needed': 'รอแก้ไขข้อมูล (Revise)',
      'Pending Head': 'รออนุมัติ Level 1',      // ⭐ เปลี่ยนชื่อ
      'Pending PM': 'รออนุมัติ Level 2',        // ⭐ เปลี่ยนชื่อ
      'Approved': 'อนุมัติแล้ว (รอดำเนินการ)',
      'Ordered': 'สั่งซื้อแล้ว (รอรับของ)',
      'PR Issued': 'ออกใบขอซื้อ (PR) แล้ว',
      'PO Issued': 'ออกใบสั่งซื้อ (PO) แล้ว',
      'Contract Pending': 'รอทำสัญญาเช่า',
      'Contract Signed': 'ทำสัญญาเช่าแล้ว',
      'Shipping': 'กำลังจัดส่ง/ส่งมอบ',
      'Partially Received': 'รับของบางส่วน (Partial)',
      'Ready to Disburse': 'รอจ่ายของ (เบิก/ยืม)',
      'Completed': 'ได้รับของแล้ว/จบงาน',
      'Returned': 'คืนของแล้ว (Returned)',
      'Rejected': 'ไม่อนุมัติ (Rejected)'
    };

    const STATUS_STEPS_LOCAL = ['Pending Head', 'Pending PM', 'Approved', 'Ordered', 'Completed'];
    const STATUS_STEPS_HO_SHORT = ['Pending Check', 'Approved', 'PR Issued', 'PO Issued', 'Shipping', 'Completed'];
    const STATUS_STEPS_HO_FULL = ['Pending Check', 'Pending Head', 'Pending PM', 'Approved', 'PR Issued', 'PO Issued', 'Shipping', 'Completed'];
    const STATUS_STEPS_HO_RENT_SHORT = ['Pending Check', 'Approved', 'Contract Pending', 'Contract Signed', 'Shipping', 'Completed'];
    const STATUS_STEPS_HO_RENT_FULL = ['Pending Check', 'Pending Head', 'Pending PM', 'Approved', 'Contract Pending', 'Contract Signed', 'Shipping', 'Completed'];
    const STATUS_STEPS_HO_RENT_SKIP = ['Pending Check', 'Approved', 'Shipping', 'Completed']; 
    const STATUS_STEPS_HO_RENT_SKIP_FULL = ['Pending Check', 'Pending Head', 'Pending PM', 'Approved', 'Shipping', 'Completed'];
    const STATUS_STEPS_WITHDRAW = ['Pending Head', 'Approved', 'Ready to Disburse', 'Completed'];
    const STATUS_STEPS_BORROW = ['Pending Head', 'Approved', 'Ready to Disburse', 'Completed', 'Returned'];

    // --- Helper Functions ---
    const createLog = (action, user, note = '', images = []) => ({ 
      date: new Date().toLocaleString('th-TH'), 
      action, 
      user, 
      note,
      images: images || [] 
    });



const StatusBadge = ({ status, type, onClick }) => { // ⭐ รับ onClick มาด้วย
      let color = 'bg-gray-100 text-gray-800';
      let label = STATUS_LABELS[status] || status;

      if (status === 'Pending Head' && (type === 'Withdraw' || type === 'Borrow')) {
          label = 'รออนุมัติ Level 1 / Level 2';
      }

      if (status === 'Draft') color = 'bg-gray-200 text-gray-600 border border-gray-300';
      else if (status === 'Revise Needed') color = 'bg-red-50 text-red-600 border border-red-200 animate-pulse';
      else if (status.includes('Pending') || status === 'PR Issued') color = 'bg-amber-100 text-amber-800 border border-amber-200';
      else if (status === 'Contract Pending') color = 'bg-amber-100 text-amber-800 border border-amber-200';
      else if (status === 'Approved') color = 'bg-cyan-100 text-cyan-800 border border-cyan-200';
      else if (status === 'Ready to Disburse') color = 'bg-purple-100 text-purple-800 border border-purple-200';
      else if (['Ordered', 'PO Issued', 'Shipping', 'Contract Signed', 'Partially Received'].includes(status)) color = 'bg-blue-100 text-blue-800 border border-blue-200';
      else if (status === 'Completed') color = 'bg-green-100 text-green-800 border border-green-200';
      else if (status === 'Returned') color = 'bg-teal-100 text-teal-800 border border-teal-200';
      else if (status === 'Rejected') color = 'bg-red-100 text-red-800 border border-red-200';
      
      // ⭐ เพิ่ม cursor-pointer และ onClick
      return (
        <span 
            onClick={onClick}
            className={`px-2 py-1 rounded-full text-xs font-bold border flex items-center gap-1 w-fit transition-transform active:scale-95 ${color} ${onClick ? 'cursor-pointer hover:shadow-sm hover:brightness-95' : ''}`}
            title={onClick ? "คลิกเพื่อดูผู้รับผิดชอบ" : ""}
        >
            {label} 
            {/* เพิ่มไอคอนเล็กๆ แสดงว่ากดดูได้ */}
            {onClick && <Info size={10} className="opacity-50"/>}
        </span>
      );
};

    const DocIdBadge = ({ type, id }) => {
        if (!id) return null;
        let color = 'bg-gray-100 text-gray-600 border-gray-200';
        let icon = createIcon('FileText')({className: "w-3 h-3"});
        if (id.startsWith('HRO')) {
            color = 'bg-teal-50 text-teal-700 border-teal-200';
            icon = createIcon('PenTool')({className: "w-3 h-3"});
        }
        else if (type === 'Local') { color = 'bg-orange-50 text-orange-700 border-orange-200'; icon = createIcon('HardHat')({className: "w-3 h-3"}); }
        else if (type === 'HO') { color = 'bg-indigo-50 text-indigo-700 border-indigo-200'; icon = createIcon('Building')({className: "w-3 h-3"}); }
        else if (type === 'Withdraw') { color = 'bg-pink-50 text-pink-700 border-pink-200'; icon = createIcon('Package')({className: "w-3 h-3"}); }
        else if (type === 'Borrow') { color = 'bg-blue-50 text-blue-700 border-blue-200'; icon = createIcon('Monitor')({className: "w-3 h-3"}); }

        return (
            <span className={`text-xs px-2 py-0.5 rounded border flex items-center gap-1 font-bold ${color}`}>
                {icon} {id}
            </span>
        );
    };

    const ProgressBar = ({ request }) => {
      let steps = STATUS_STEPS_LOCAL;
      if (request.type === 'HO') {
          if (request.purchaseType === 'Rent') {
              if (request.needContract === false) {
                  steps = request.isFullApprovalFlow ? STATUS_STEPS_HO_RENT_SKIP_FULL : STATUS_STEPS_HO_RENT_SKIP;
              } else {
                  steps = request.isFullApprovalFlow ? STATUS_STEPS_HO_RENT_FULL : STATUS_STEPS_HO_RENT_SHORT;
              }
          } else {
              steps = request.isFullApprovalFlow ? STATUS_STEPS_HO_FULL : STATUS_STEPS_HO_SHORT;
          }
      }
      if (request.type === 'Withdraw') steps = STATUS_STEPS_WITHDRAW;
      if (request.type === 'Borrow') steps = STATUS_STEPS_BORROW;
      
      let statusToFind = request.status;
      if (statusToFind === 'Partially Received') {
          if (request.type === 'Local') statusToFind = 'Ordered';
          else if (request.type === 'HO') statusToFind = 'Shipping';
      }

      const currentIndex = steps.indexOf(statusToFind);
      const AlertCircleIcon = createIcon('AlertCircle');
      
      return (
        <div className="w-full mt-3 mb-4">
           {request.status === 'Revise Needed' && (
               <div className="mb-2 text-xs text-red-500 font-bold flex items-center gap-1 animate-bounce">
                   <AlertCircleIcon className="w-3 h-3"/> ต้องแก้ไขข้อมูล (ดูรายละเอียดในประวัติ)
               </div>
           )}
          <div className="flex justify-between mb-2">
              {steps.map((step, idx) => (
                 <div key={step} className={`text-[10px] flex flex-col items-center ${idx <= currentIndex ? 'text-blue-600 font-bold' : 'text-gray-300'}`}>
                      <div className={`w-2 h-2 rounded-full mb-1 ${idx <= currentIndex ? 'bg-blue-600' : 'bg-gray-200'}`}></div>
                      <span className="hidden sm:inline">{STATUS_LABELS[step]?.split(' ')[0] || step}</span>
                  </div>
              ))}
          </div>
          <div className="h-1.5 bg-gray-100 rounded-full overflow-hidden flex">
              {steps.map((step, idx) => (
                  <div key={step} className={`h-full border-r border-white last:border-0 transition-all duration-500 ${idx <= currentIndex ? 'bg-blue-500' : 'bg-transparent'}`} style={{ width: `${100 / steps.length}%` }} />
              ))}
          </div>
        </div>
      );
    };

    // --- MAIN APP COMPONENT ---
    const App = () => {
      const [user, setUser] = useState(null);
      const [isSidebarOpen, setIsSidebarOpen] = useState(true);

      const [allUsers, setAllUsers] = useState([]); // เก็บรายชื่อ User ทั้งหมด
      const [showPermissionModal, setShowPermissionModal] = useState(false); // เปิด Modal จัดการสิทธิ์
      const [selectedUserForEdit, setSelectedUserForEdit] = useState(null); // User ที่กำลังถูกแก้ไขสิทธิ์
      const [permissionTab, setPermissionTab] = useState(''); // เก็บชื่อ Project ใน Modal จัดการสิทธิ์
      const [currentUserRole, setCurrentUserRole] = useState(ROLES.USER);
      const [activeTab, setActiveTab] = useState('dashboard');
      
      // Use Empty Array initially, will fetch from Sheet
      const [requests, setRequests] = useState([]);
      const [inventory, setInventory] = useState([]);
      const [assets, setAssets] = useState([]);
      const [invLogs, setInvLogs] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [uploadFiles, setUploadFiles] = useState({ email: null, quotation: null });
      // --- STATE: Image Preview Modal ---
      const [fullscreenImage, setFullscreenImage] = useState(null); // เก็บ URL หรือ Base64 ของรูปที่จะดู
      const [viewingAttachments, setViewingAttachments] = useState(null); // เก็บ Object { attachments: [] }
      const [showImportAssetModal, setShowImportAssetModal] = useState(false);
      const [importData, setImportData] = useState([]);
      const [importFileName, setImportFileName] = useState('');
      const [isImportAssetTableExpanded, setIsImportAssetTableExpanded] = useState(false);
      const [isImportInvTableExpanded, setIsImportInvTableExpanded] = useState(false); // ⭐ เพิ่มตัวนี้
// --- STATE: Projects Management ---
      const [projects, setProjects] = useState([]); // เริ่มต้นเป็น Array ว่าง (รอโหลด)
      const [disburseItems, setDisburseItems] = useState([]);

      const [isError, setIsError] = useState(false); // ⭐ เก็บสถานะ Error
const [errorMessage, setErrorMessage] = useState(''); // ⭐ เก็บข้อความ Error

const [showAuditModal, setShowAuditModal] = useState(false);
const [auditItems, setAuditItems] = useState([]); // เก็บรายการที่กำลังนับ
  


// --- STATE: Go to Top Button ---
const [showGoTop, setShowGoTop] = useState(false);

// --- STATE: Go to Bottom Button ---
const [showGoBottom, setShowGoBottom] = useState(true);

// ฟังก์ชันสำหรับเลื่อนลงล่างสุด
const scrollToBottom = () => {
    const contentArea = document.querySelector('.flex-1.overflow-auto');
    if (contentArea) {
        contentArea.scrollTo({ 
            top: contentArea.scrollHeight, 
            behavior: 'smooth' 
        });
    }
};

// ตรวจสอบการ scroll เพื่อซ่อนปุ่มเมื่อถึงล่างสุด (เพิ่มใน useEffect เดิม)
useEffect(() => {
    const handleScroll = () => {
        const contentArea = document.querySelector('.flex-1.overflow-auto');
        if (contentArea) {
            // แสดงปุ่ม Top เมื่อเลื่อนลงมามากกว่า 300px
            setShowGoTop(contentArea.scrollTop > 300);
            
            // ซ่อนปุ่ม Bottom เมื่อเลื่อนถึงเกือบด้านล่างสุด (ห่างจากพื้น 50px)
            const isAtBottom = contentArea.scrollHeight - contentArea.scrollTop <= contentArea.clientHeight + 50;
            setShowGoBottom(!isAtBottom);
        }
    };

    const contentArea = document.querySelector('.flex-1.overflow-auto');
    if (contentArea) {
        
        contentArea.addEventListener('scroll', handleScroll);
        return () => contentArea.removeEventListener('scroll', handleScroll);
    }
}, [activeTab]); // ตรวจสอบทุกครั้งที่เปลี่ยนหน้า

const scrollToTop = () => {
    const contentArea = document.querySelector('.flex-1.overflow-auto');
    if (contentArea) {
        contentArea.scrollTo({ top: 0, behavior: 'smooth' });
    }
};

// --- [NEW] Component ปุ่มเลื่อนใน Modal ---
    const ModalScrollButtons = ({ targetId }) => (
        <div className="absolute bottom-6 right-6 flex flex-col gap-2 z-[60] no-print">
            <button 
                onClick={() => document.getElementById(targetId)?.scrollTo({ top: 0, behavior: 'smooth' })}
                className="bg-white/80 backdrop-blur text-gray-500 hover:text-blue-600 p-2.5 rounded-full shadow-lg border border-gray-200 hover:bg-blue-50 transition-all transform hover:scale-110"
                title="เลื่อนขึ้นบนสุด"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>
            </button>
            <button 
                onClick={() => {
                    const el = document.getElementById(targetId);
                    el?.scrollTo({ top: el.scrollHeight, behavior: 'smooth' });
                }}
                className="bg-white/80 backdrop-blur text-gray-500 hover:text-blue-600 p-2.5 rounded-full shadow-lg border border-gray-200 hover:bg-blue-50 transition-all transform hover:scale-110"
                title="เลื่อนลงล่างสุด"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>
            </button>
        </div>
    );

      
      const [showProjectModal, setShowProjectModal] = useState(false); // Modal แก้ไข/เพิ่ม
      const [showProjectDetailModal, setShowProjectDetailModal] = useState(false); // ⭐ Modal รายละเอียด
      
      const [editingProject, setEditingProject] = useState(null); 
      const [viewingProject, setViewingProject] = useState(null); // ⭐ เก็บ Project ที่กำลังดูรายละเอียด
      const [projectFormTab, setProjectFormTab] = useState('General');
      const [inventoryProjectFilter, setInventoryProjectFilter] = useState('All');
      const [assetProjectFilter, setAssetProjectFilter] = useState('All');
      const [projectDetailTab, setProjectDetailTab] = useState('SubJob'); // 'SubJob' หรือ 'matCode'
      const [globalProjectFilter, setGlobalProjectFilter] = useState('All');
      // --- STATE: User Detail Modal ---
const [viewingUser, setViewingUser] = useState(null); // เก็บ User ที่กำลังดู
const [userDetailTab, setUserDetailTab] = useState('info'); // info, purchase, withdraw, borrow
const [detailSearch, setDetailSearch] = useState(''); // ช่องค้นหาในหน้า Detail
const [userSearch, setUserSearch] = useState(''); // ⭐ เพิ่ม State สำหรับค้นหา User
const [expandedBudgetGroups, setExpandedBudgetGroups] = useState({});

const [announcements, setAnnouncements] = useState([]); 
    const [publicAnnounces, setPublicAnnounces] = useState([]); // สำหรับแสดงผลหน้าแรก
    const [showPublicAnnounce, setShowPublicAnnounce] = useState(false);
    const [announcement, setAnnouncement] = useState(null);
    const [announceForm, setAnnounceForm] = useState({ id: '', title: '', detail: '', active: true }); 
    const [isAnnounceLoading, setIsAnnounceLoading] = useState(false);

// --- STATE: Export Budget CSV ---
const [showExportModal, setShowExportModal] = useState(false);
const [exportTargetProject, setExportTargetProject] = useState('All');

    // --- STATE: Checklist & Audit ---
const [showChecklistModal, setShowChecklistModal] = useState(false);
const [checklistMode, setChecklistMode] = useState('Inventory'); // 'Inventory' or 'Asset'
const [checklistFilters, setChecklistFilters] = useState({
    projects: [],
    types: [], // Inv: System/NonSystem | Asset: Company/Rent
    statuses: [], // Asset only
    selectedItems: [] // Store IDs
});
const [checklistUploadFile, setChecklistUploadFile] = useState(null);

// Helper: Toggle Checkbox in Filters
const toggleChecklistFilter = (field, value) => {
    setChecklistFilters(prev => {
        const current = prev[field];
        const newSet = current.includes(value) 
            ? current.filter(x => x !== value)
            : [...current, value];
        
        // ถ้าเปลี่ยน Filter หลัก ให้เคลียร์ Items ที่เลือกไว้ เพื่อป้องกันข้อมูลผิดชุด
        if (field !== 'selectedItems') {
             return { ...prev, [field]: newSet, selectedItems: [] };
        }
        return { ...prev, [field]: newSet };
    });
};

// Helper: Select All Items based on current filters
const handleSelectAllChecklistItems = (filteredItems) => {
    const allIds = filteredItems.map(i => i.id);
    setChecklistFilters(prev => ({ 
        ...prev, 
        selectedItems: prev.selectedItems.length === allIds.length ? [] : allIds 
    }));
};

// --- Helper: ตัดรหัสเพื่อแสดงผล (ซ่อนส่วนท้าย) ---
    const COMPOSITE_SEP = '|';
    const getDisplayId = (id) => {
        if (!id) return '';
        const str = id.toString();
        return str.includes(COMPOSITE_SEP) ? str.split(COMPOSITE_SEP)[0] : str;
    };



// --- LOGIC: EXPORT BUDGET CSV (UPDATED: Add Lot Details Column) ---
const handleExportBudgetCSV = () => {
    // 1. กรอง Request ที่สถานะ Completed (ใช้งบไปแล้ว) และตามโครงการที่เลือก
    const completedReqs = requests.filter(r => {
        const isBudgetUsed = r.status === 'Completed' && ['Local', 'HO'].includes(r.type);
        const isProjectMatch = exportTargetProject === 'All' || r.job === exportTargetProject;
        return isBudgetUsed && isProjectMatch;
    });

    if (completedReqs.length === 0) {
        showToast('ไม่พบข้อมูลการใช้งบประมาณตามเงื่อนไข', 'error');
        return;
    }

    // 2. สร้าง Header CSV (เพิ่ม BOM \uFEFF เพื่อรองรับภาษาไทย)
    let csvContent = "\uFEFF"; 
    // ⭐ เพิ่มคอลัมน์สุดท้าย: หมายเหตุ (Lot Detail)
    // แก้ไขบรรทัดที่ 116 เพิ่ม "ผู้ขอ," เข้าไป
csvContent += "รหัสโครงการ,Doc No.,ผู้ขอ,รายการสินค้า,SubJob,Mat. Code,ราคา/หน่วย (เฉลี่ย/ล่าสุด),จำนวน,หน่วย/ระยะเวลา,รวมเงิน (Actual Cost),หมายเหตุ (Lot Detail)\n";

    // 3. วนลูปดึงข้อมูล
    completedReqs.forEach(req => {
        const projObj = projects.find(p => p.name === req.job);
        const projectId = projObj ? projObj.id : req.job;
        const docNo = req.docNumber || req.id;

        req.items.forEach(item => {
            const isRent = req.type === 'HO' && req.purchaseType === 'Rent';
            
            // --- LOGIC คำนวณราคาจริง (Actual Cost Logic) ---
            // --- LOGIC คำนวณราคาจริง (Actual Cost Logic) ---
// ⭐ แก้ไข: เพิ่มเงื่อนไขเช็คราคา (Price) เพื่อให้แยกรายการได้ถูกต้องตาม Logic ใหม่
const relatedAssets = assets.filter(a => 
    a.currentRequestId === req.id && 
    a.name === item.name &&
    (a.price === item.unitPrice || a.rentalPrice === item.unitPrice)
);
            const receivedLogs = item.receivedLog || [];
            
            let itemTotalVal = 0;
            let receivedCount = 0;
            let displayPrice = 0; 
            let lotDetailList = []; // ⭐ ตัวแปรเก็บข้อความรายละเอียด Lot

            // A. กรณีเป็น Asset
            if (relatedAssets.length > 0) {
                itemTotalVal += relatedAssets.reduce((sum, asset) => {
                    const p = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                    const d = isRent ? (asset.duration || item.duration || 1) : 1;
                    return sum + (p * d);
                }, 0);
                receivedCount = relatedAssets.length;
                displayPrice = relatedAssets[0].price; 
                
                // เก็บรายละเอียด Asset แต่ละตัว
                relatedAssets.forEach((a, i) => {
                    const p = isRent ? a.rentalPrice : a.price;
                    lotDetailList.push(`Asset#${i+1}: ${p.toLocaleString()}`);
                });
            } 
            // B. กรณีเป็น Material (ดูจาก Log การรับของ)
            else if (receivedLogs.length > 0) {
                itemTotalVal += receivedLogs.reduce((sum, log) => {
                    const p = log.price;
                    const d = isRent ? (log.duration || 1) : 1;
                    
                    // ⭐ เก็บรายละเอียดแต่ละ Lot: "Lot 1: 20 @ 160"
                    lotDetailList.push(`Lot ${lotDetailList.length + 1}: ${log.qty} @ ${p.toLocaleString()}`);
                    
                    return sum + (log.qty * p * d);
                }, 0);
                receivedCount = item.receivedTotal || 0;
                displayPrice = receivedLogs[receivedLogs.length - 1].price;
           }

            // C. ส่วนที่เหลือ (Estimate)
            // ⭐ [แก้ไขใหม่] ตัดส่วนนี้ทิ้ง หรือ ไม่นำมาบวกยอดเงิน (itemTotalVal) เพื่อให้ได้ Actual Cost จริงๆ
            const remainingQty = Math.max(0, item.qty - receivedCount);
            if (remainingQty > 0) {
                const p = item.unitPrice || 0;
                
                // เก็บราคาไว้แสดงผลเฉยๆ (ถ้ายังไม่เคยมีการรับของเลย)
                if(displayPrice === 0) displayPrice = p;
                
                // ❌ ลบการบวกเงินตรงนี้ทิ้ง: itemTotalVal += (remainingQty * p * d);
                
                // (Optional) เพิ่มในหมายเหตุว่ามีการยกเลิก/รับไม่ครบ
                lotDetailList.push(`Not Received/Cancel: ${remainingQty}`);
            }

            // จัดการข้อความ CSV
            const cleanName = (item.name || '').replace(/,/g, ' ');
            const cleanSub = (item.subJob || '').replace(/,/g, ' ');
            const cleanMat = (item.matCode || '').replace(/,/g, ' ');
            
            // รวมข้อความ Lot ทั้งหมด คั่นด้วย " | "
            const lotDetailStr = lotDetailList.join(" | ");

            let durationLabel = item.unit;
            if (isRent) {
                const duration = item.duration || 1;
                const rentUnit = item.rentalUnit || 'Month';
                durationLabel = `${rentUnit} (${duration})`;
            }

            // แก้ไขส่วนการสร้าง row ประมาณบรรทัดที่ 138
const row = [
    `"${projectId}"`,   
    `"${docNo}"`,
    `"${req.requester}"`, // ⭐ เพิ่มข้อมูลชื่อผู้ขอซื้อตรงนี้
    `"${cleanName}"`,   
    `"${cleanSub}"`,    
    `"${cleanMat}"`,
    displayPrice.toFixed(2), 
    item.qty,           
    `"${durationLabel}"`, 
    itemTotalVal.toFixed(2),
    `"${lotDetailStr}"`
];

            csvContent += row.join(",") + "\n";
        });
    });

    // 4. สร้างไฟล์และดาวน์โหลด
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    
    const dateStr = new Date().toISOString().split('T')[0];
    const projName = exportTargetProject === 'All' ? 'All_Projects' : exportTargetProject;
    link.setAttribute("download", `Budget_Used_${projName}_${dateStr}.csv`);
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setShowExportModal(false);
    showToast('Export ข้อมูล (พร้อมรายละเอียด Lot) เรียบร้อย');
};


// Logic: Filter Items for Checklist Modal
const getChecklistFilteredItems = () => {
    if (checklistMode === 'Inventory') {
        return inventory.filter(i => {
            // Filter Project
            if (checklistFilters.projects.length > 0 && !checklistFilters.projects.includes(i.project || 'ส่วนกลาง')) return false;
            // Filter Type
            const type = i.stockType || 'System';
            if (checklistFilters.types.length > 0 && !checklistFilters.types.includes(type)) return false;
            return true;
        });
    } else {
        return assets.filter(a => {
            // Filter Project
            if (checklistFilters.projects.length > 0 && !checklistFilters.projects.includes(a.project || 'ส่วนกลาง')) return false;
            // Filter Type (Owner)
            if (checklistFilters.types.length > 0 && !checklistFilters.types.includes(a.ownerType)) return false;
            // Filter Status
            if (checklistFilters.statuses.length > 0 && !checklistFilters.statuses.includes(a.status)) return false;
            return true;
        });
    }
};

// Logic: Upload Signed Checklist
const handleUploadChecklist = async () => {
    if (!checklistUploadFile) {
        showToast('กรุณาเลือกไฟล์ก่อนอัปโหลด', 'error');
        return;
    }
    
    setIsLoading(true);
    try {
        const base64 = await fileToBase64(checklistUploadFile);
        const result = await new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .uploadFileToDrive(base64, checklistUploadFile.name);
        });

        if (result.error) throw new Error(result.error);

        // บันทึก Log
        const logAction = checklistMode === 'Inventory' ? 'Audit Inventory' : 'Audit Assets';
        const note = `อัปโหลดไฟล์ Checklist (${checklistMode}) \nไฟล์: ${result.name}`;
        const logImages = []; // หรือใส่เป็น Link ไฟล์ก็ได้ถ้าต้องการ
        
        // ใช้ addInvLog เพื่อบันทึกลงประวัติรวม
        await addInvLog(
            logAction, 
            'Checklist Document', 
            'Upload', 
            note, 
            [{ name: result.name, url: result.url, type: 'application/pdf' }]
        );

        showToast('อัปโหลดและบันทึกประวัติเรียบร้อย');
        setChecklistUploadFile(null);
        setShowChecklistModal(false);
    } catch (err) {
        console.error(err);
        showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
    } finally {
        setIsLoading(false);
    }
};


const handlePrintChecklist = () => {
    // เก็บชื่อ Title เดิมไว้
    const originalTitle = document.title;
    
    // ตั้งชื่อใหม่: ประเภท_โครงการ_วันเวลา
    const dateStr = new Date().toLocaleString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit', hour:'2-digit', minute:'2-digit' }).replace(/[\/:]/g, '-').replace(', ', '_');
    const typeName = checklistMode === 'Inventory' ? 'Inventory_Audit' : 'Asset_Audit';
    const projectStr = checklistFilters.projects.length > 0 ? checklistFilters.projects.join('_') : 'All_Projects';
    
    // เปลี่ยน Title (Browser จะใช้ชื่อนี้เป็นชื่อไฟล์ PDF)
    document.title = `${typeName}_${projectStr}_${dateStr}`;
    
    // สั่งพิมพ์
    window.print();
    
    // คืนค่า Title เดิมหลังจากพิมพ์เสร็จ (หน่วงเวลาเล็กน้อยเพื่อให้ Browser จับชื่อทัน)
    setTimeout(() => {
        document.title = originalTitle;
    }, 1000);
};

// Logic: Open Modal
const openChecklistModal = (mode) => {
    setChecklistMode(mode);
    setChecklistFilters({
        projects: [],
        types: [],
        statuses: [],
        selectedItems: []
    });
    setChecklistUploadFile(null);
    setShowChecklistModal(true);
};

// --- UI Component: Searchable Dropdown (พิมพ์ค้นหาได้) ---
    const SearchableDropdown = ({ label, options, value, onChange, disabled, placeholder }) => {
        const [isOpen, setIsOpen] = useState(false);
        const [search, setSearch] = useState("");
        const wrapperRef = useRef(null);

        // Sync ข้อความในช่องค้นหาให้ตรงกับค่าที่เลือก (value)
        useEffect(() => {
            const selected = options?.find(o => o.code === value);
            if (selected) {
                setSearch(`${selected.code} : ${selected.description}`);
            } else if (!value) {
                setSearch("");
            }
        }, [value, options]);

        // คลิกพื้นที่อื่นเพื่อปิด Dropdown
        useEffect(() => {
            const handleClickOutside = (event) => {
                if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                    setIsOpen(false);
                    // ถ้าค่าที่พิมพ์ไม่ตรงกับรายการใดเลย ให้ Reset กลับไปเป็นค่าว่างหรือค่าเดิมที่ถูกเลือก
                    const selected = options?.find(o => o.code === value);
                    if (selected) setSearch(`${selected.code} : ${selected.description}`);
                    else if (!value) setSearch("");
                }
            };
            document.addEventListener("mousedown", handleClickOutside);
            return () => document.removeEventListener("mousedown", handleClickOutside);
        }, [wrapperRef, value, options]);

        const filteredOptions = (options || []).filter(opt => 
            opt.code.toLowerCase().includes(search.toLowerCase()) || 
            opt.description.toLowerCase().includes(search.toLowerCase())
        );

        return (
            <div className="relative" ref={wrapperRef}>
                <label className="text-xs font-bold text-gray-500 mb-1 block">{label}</label>
                <div className="relative">
                    <input
                        type="text"
                        className={`w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none ${disabled ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white'}`}
                        placeholder={placeholder}
                        value={search}
                        onChange={(e) => {
                            setSearch(e.target.value);
                            setIsOpen(true);
                            if (e.target.value === "") onChange(""); // เคลียร์ค่าเมื่อลบข้อความหมด
                        }}
                        onFocus={() => !disabled && setIsOpen(true)}
                        disabled={disabled}
                    />
                    {/* Icon ลูกศรลง */}
                    <div className="absolute right-3 top-3 pointer-events-none text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                    </div>
                </div>

                {isOpen && !disabled && (
                    <div className="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 overflow-y-auto animate-in fade-in zoom-in-95">
                        {filteredOptions.length > 0 ? (
                            filteredOptions.map((opt) => (
                                <div
                                    key={opt.code}
                                    className="px-3 py-2 text-sm hover:bg-indigo-50 cursor-pointer text-gray-700 border-b border-gray-50 last:border-0"
                                    onClick={() => {
                                        onChange(opt.code);
                                        setIsOpen(false);
                                    }}
                                >
                                    <span className="font-bold text-indigo-600">{opt.code}</span> : {opt.description}
                                </div>
                            ))
                        ) : (
                            <div className="px-3 py-3 text-sm text-gray-400 text-center">ไม่พบข้อมูล</div>
                        )}
                    </div>
                )}
            </div>
        );
    };

   // --- STATE: Signature (ชุดสมบูรณ์) ---
    const [sigMode, setSigMode] = useState('Draw'); // 'Draw' หรือ 'Upload'
    const sigCanvasRef = useRef(null);
    const [isDrawing, setIsDrawing] = useState(false);
    const [hasDrawn, setHasDrawn] = useState(false); // เช็คว่ามีการวาดหรือไม่
    const [signatureFile, setSignatureFile] = useState(null); // สำหรับโหมด Upload
    const [tempSignatureUrl, setTempSignatureUrl] = useState(null); // สำหรับ Preview

    // 1. เริ่มวาด
    const startDrawing = (e) => {
        const canvas = sigCanvasRef.current;
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        
        const rect = canvas.getBoundingClientRect();
        // รองรับทั้งเมาส์และนิ้วสัมผัส
        const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
        const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
        
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(x, y);
        setIsDrawing(true);
    };

    // 2. กำลังวาด (ขยับเมาส์/นิ้ว)
    const draw = (e) => {
        if (!isDrawing) return;
        e.preventDefault(); // ป้องกันจอลื่นไหลตอนวาดบนมือถือ
        
        const canvas = sigCanvasRef.current;
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        
        const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
        const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);

        const x = clientX - rect.left;
        const y = clientY - rect.top;
        
        ctx.lineTo(x, y);
        ctx.stroke();
        
        if (!hasDrawn) setHasDrawn(true); // บันทึกว่ามีการวาดเกิดขึ้นแล้ว
    };

    // 3. หยุดวาด (ยกเมาส์/นิ้วออก)
    const stopDrawing = () => {
        setIsDrawing(false);
        const canvas = sigCanvasRef.current;
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.closePath();
        }
    };

    // 4. ล้างลายเซ็น
    const clearSignature = () => {
        const canvas = sigCanvasRef.current;
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        setTempSignatureUrl(null);
        setHasDrawn(false); // รีเซ็ตสถานะ
    };




const hasPermission = (permId, project = globalProjectFilter) => {
          // 1. ถ้าเป็น Super Admin ให้ผ่านตลอด
          if (user?.isSuperAdmin) return true;
          
          // 2. ถ้าไม่ได้เลือก Project (All) หรือเป็นการกระทำระดับ Global
          if (!project || project === 'All') {
              // เช็คว่ามีสิทธิ์นี้ใน "โปรเจกต์ใดโปรเจกต์หนึ่ง" หรือไม่ (User.permissions เก็บเป็น { "ProjectA": [1,2], "ProjectB": [] })
              if (!user?.permissions) return false;
              return Object.values(user.permissions).some(perms => 
                  perms.includes(2) || perms.includes(permId) // สิทธิ์ 2 คือ Admin ของโปรเจกต์นั้น
              );
          }

          // 3. เช็คสิทธิ์ใน Project ที่ระบุ
          const userPerms = user?.permissions?.[project] || [];
          
          // - เป็น Admin ของโปรเจกต์นี้ (2)
          if (userPerms.includes(2)) return true;

          // - เป็น Sub-Admin (3) -> ได้สิทธิ์สร้างคำขอพื้นฐาน (4,5,6,7)
          if (userPerms.includes(3) && [4, 5, 6, 7].includes(permId)) return true;

          // - มีสิทธิ์ระบุเฉพาะเจาะจง
          return userPerms.includes(permId);
      };


// --- AUTH SCREEN (Full Features: Login, Register, Forgot Password, Forgot Username) ---
    const AuthScreen = ({ onLoginSuccess, requests = [] }) => {
        // view state: 'login' | 'register' | 'forgot' | 'forgotUser'
        const [view, setView] = useState('login'); 
        const [loading, setLoading] = useState(false);
        

        
        // State สำหรับ OTP (Register/Forgot Password)
        const [otpSent, setOtpSent] = useState(false);
        const [refCode, setRefCode] = useState('');
        const [countdown, setCountdown] = useState(0);
        
        // State สำหรับ UI
        
        const [showPassword, setShowPassword] = useState(false);
        const [showRegisterPassword, setShowRegisterPassword] = useState(false);
        const [showRegisterConfirm, setShowRegisterConfirm] = useState(false);

        const [formData, setFormData] = useState({
            username: '', password: '', confirmPassword: '', email: '', empId: '', firstName: '', lastName: '', otp: '', newPassword: ''
        });

     

        // --- Countdown Timer ---
        useEffect(() => {
            let timer;
            if (countdown > 0) timer = setTimeout(() => setCountdown(countdown - 1), 1000);
            return () => clearTimeout(timer);
        }, [countdown]);

        // Stats Logic
        const stats = useMemo(() => {
            const active = requests.filter(r => r.status !== 'Draft');
            return {
                pending: active.filter(r => r.status.includes('Pending') || r.status === 'PR Issued' || r.status === 'Approved' || r.status === 'Revise Needed' || r.status === 'Contract Pending').length,
                processing: active.filter(r => ['Ordered', 'PO Issued', 'Shipping', 'Contract Signed', 'Partially Received'].includes(r.status)).length,
                ready: active.filter(r => r.status === 'Ready to Disburse').length,
                completed: active.filter(r => r.status === 'Completed' || r.status === 'Returned').length
            };
        }, [requests]);

        const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
        const validatePassword = (pwd) => pwd.length >= 6 && /[a-zA-Z]/.test(pwd) && /[0-9]/.test(pwd);

        // --- Actions ---

        const handleLogin = (e) => {
            e.preventDefault();
            setLoading(true);
            google.script.run.withSuccessHandler((res) => {
                setLoading(false);
                if (res.success) {
                    
                    onLoginSuccess(res.user);
                } else { alert(res.message); }
            }).loginUser(formData.username, formData.password);
        };

const handleRegisterRequestOTP = () => {
            if(!formData.username || !formData.password || !formData.email || !formData.empId) { // ⭐ เช็ค empId ว่ากรอกหรือยัง
                alert('กรุณากรอกข้อมูลให้ครบ (รวมถึงรหัสพนักงาน)'); 
                return; 
            }
            if (!validatePassword(formData.password)) { alert('รหัสผ่านต้องมี 6 ตัวขึ้นไป (ตัวอักษร+ตัวเลข)'); return; }
            if (formData.password !== formData.confirmPassword) { alert('รหัสผ่านไม่ตรงกัน'); return; }

            setLoading(true);
            google.script.run.withSuccessHandler((res) => {
                setLoading(false);
                if (res.success) {
                    alert(`${res.message}\nRef: ${res.refCode}`);
                    setOtpSent(true); setRefCode(res.refCode); setCountdown(15);
                } else { alert(res.message); }
 
            }).sendRegistrationOTP(formData.email, formData.username, formData.empId); // ⭐ เพิ่ม formData.empId ต่อท้าย
        };

        const handleRegisterConfirm = (e) => {
            e.preventDefault();
            setLoading(true);
            google.script.run.withSuccessHandler((res) => {
                setLoading(false);
                if (res.success) {
                    alert('ลงทะเบียนสำเร็จ!');
                    setView('login'); setOtpSent(false); setFormData({...formData, password:'', confirmPassword:'', otp:''});
                } else { alert(res.message); }
            }).registerUser(formData, formData.otp);
        };

        const handleForgotRequestOTP = () => {
            if(!formData.email) { alert('กรุณาระบุอีเมล'); return; }
            setLoading(true);
            google.script.run.withSuccessHandler((res) => {
                setLoading(false);
                if (res.success) {
                    alert(`${res.message}\nRef: ${res.refCode}`);
                    setOtpSent(true); setRefCode(res.refCode); setCountdown(15);
                } else { alert(res.message); }
            }).sendForgotPasswordOTP(formData.email);
        };

        const handleResetPassword = (e) => {
            e.preventDefault();
            if(!formData.otp || !formData.newPassword) { alert('กรุณากรอกข้อมูลให้ครบ'); return; }
            if (!validatePassword(formData.newPassword)) { alert('รหัสผ่านใหม่ต้องมี 6 ตัวขึ้นไป (ตัวอักษร+ตัวเลข)'); return; }
            if (formData.newPassword !== formData.confirmPassword) { alert('รหัสผ่านยืนยันไม่ตรงกัน'); return; }

            setLoading(true);
            google.script.run.withSuccessHandler((res) => {
                setLoading(false);
                if (res.success) {
                    alert(res.message);
                    setView('login'); setOtpSent(false); setFormData({...formData, email:'', otp:'', newPassword:'', confirmPassword:''});
                } else { alert(res.message); }
            }).resetPassword(formData.email, formData.otp, formData.newPassword);
        };

        // ⭐ ฟังก์ชันกู้คืนชื่อผู้ใช้งาน
        const handleRecoverUsername = (e) => {
            e.preventDefault();
            if(!formData.email) { alert('กรุณาระบุอีเมล'); return; }
            setLoading(true);
            google.script.run.withSuccessHandler((res) => {
                setLoading(false);
                alert(res.message);
                if (res.success) {
                    setView('login');
                    setFormData({...formData, email:''});
                }
            }).sendUsernameToEmail(formData.email);
        };

        return (
            <div className="min-h-screen flex bg-white font-sans overflow-hidden">
                {/* LEFT SIDE (Dashboard) */}
                <div className="hidden lg:flex w-7/12 bg-slate-50 relative flex-col justify-between p-10 overflow-hidden">
                    <div className="absolute top-0 right-0 w-96 h-96 bg-blue-100 rounded-full blur-3xl opacity-50 -mr-20 -mt-20"></div>
                    <div className="absolute bottom-0 left-0 w-full h-64 bg-gradient-to-t from-white to-transparent z-10"></div>
                    <div className="absolute bottom-0 left-0 w-full h-1/2 bg-[url('https://img.freepik.com/free-vector/city-skyline-concept-illustration_114360-8923.jpg?w=1380')] bg-contain bg-bottom bg-no-repeat opacity-20 pointer-events-none mix-blend-multiply"></div>

                    <div className="relative z-20">
                        <h1 className="text-4xl font-extrabold text-slate-800 mb-2">ภาพรวม</h1>
                        <p className="text-slate-500 text-lg">"ระบบบริหารจัดการงานจัดซื้อและคลังสินค้า ครบวงจร ใช้งานง่าย โปร่งใส ตรวจสอบได้"</p>
                    </div>

                    <div className="grid grid-cols-2 xl:grid-cols-4 gap-4 relative z-20 mt-8">
                        <div className="bg-amber-50 border border-amber-100 p-4 rounded-2xl shadow-sm hover:shadow-md transition-all group">
                            <div className="flex justify-between items-start mb-2"><div className="p-2 bg-white rounded-lg shadow-sm text-amber-600 group-hover:scale-110 transition-transform"><Clock size={24} strokeWidth={2}/></div></div>
                            <div className="text-3xl font-extrabold text-slate-800 mb-1">{stats.pending}</div>
                            <p className="text-[10px] font-bold text-amber-700 bg-amber-100 px-2 py-1 rounded w-fit">รออนุมัติ/ตรวจสอบ</p>
                        </div>
                        <div className="bg-blue-50 border border-blue-100 p-4 rounded-2xl shadow-sm hover:shadow-md transition-all group">
                            <div className="flex justify-between items-start mb-2"><div className="p-2 bg-white rounded-lg shadow-sm text-blue-600 group-hover:scale-110 transition-transform"><Truck size={24} strokeWidth={2}/></div></div>
                            <div className="text-3xl font-extrabold text-slate-800 mb-1">{stats.processing}</div>
                            <p className="text-[10px] font-bold text-blue-700 bg-blue-100 px-2 py-1 rounded w-fit">กำลังดำเนินการ</p>
                        </div>
                        <div className="bg-purple-50 border border-purple-100 p-4 rounded-2xl shadow-sm hover:shadow-md transition-all group">
                            <div className="flex justify-between items-start mb-2"><div className="p-2 bg-white rounded-lg shadow-sm text-purple-600 group-hover:scale-110 transition-transform"><Package size={24} strokeWidth={2}/></div></div>
                            <div className="text-3xl font-extrabold text-slate-800 mb-1">{stats.ready}</div>
                            <p className="text-[10px] font-bold text-purple-700 bg-purple-100 px-2 py-1 rounded w-fit">รอจ่ายของ/เบิก</p>
                        </div>
                        <div className="bg-green-50 border border-green-100 p-4 rounded-2xl shadow-sm hover:shadow-md transition-all group">
                            <div className="flex justify-between items-start mb-2"><div className="p-2 bg-white rounded-lg shadow-sm text-green-600 group-hover:scale-110 transition-transform"><CheckCircle size={24} strokeWidth={2}/></div></div>
                            <div className="text-3xl font-extrabold text-slate-800 mb-1">{stats.completed}</div>
                            <p className="text-[10px] font-bold text-green-700 bg-green-100 px-2 py-1 rounded w-fit">เสร็จสิ้น/รับของแล้ว</p>
                        </div>
                    </div>

                    <div className="relative z-20 mt-6 bg-white/90 backdrop-blur-sm p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4 max-w-2xl">
                        <div className="p-3 bg-indigo-100 text-indigo-700 rounded-xl"><Sparkles size={24}/></div>
                        <div>
                            <h3 className="font-bold text-slate-800 text-base">ยินดีต้อนรับสู่ PurchaseHub!</h3>
                            <p className="text-xs text-slate-500 mt-0.5">พบกับโมเดลใหม่ในการจัดการ การเบิก/ยืม และแผนติดตามงานแบบ Real-time</p>
                            <div className="flex gap-2 mt-2">
                                <span className="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded border">**** Papers</span>
                                <span className="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded border">System Online</span>
                            </div>
                        </div>
                    </div>
                    <div className="flex-1"></div>
                </div>

                {/* RIGHT SIDE (Forms) */}
                <div className="w-full lg:w-5/12 flex flex-col justify-center items-center p-8 bg-white relative shadow-2xl z-30 overflow-y-auto">
                    <div className="w-full max-w-md my-auto">
                        <div className="mb-8 flex flex-col items-center text-center">
                            <img src="https://www.appsheet.com/template/gettablefileurl?appName=ImageURL-701958446&tableName=URL&fileName=URL_Images%2F01-17-2026%2010-30-07.Photo.033012.png" 
                                alt="Logo" className="h-32 lg:h-48 w-auto object-contain mb-4 drop-shadow-sm hover:scale-105 transition-transform duration-500" 
                                onError={(e)=>{e.target.onerror=null;e.target.style.display='none'}}/>
                            <h2 className="text-2xl font-bold text-slate-800">PurchaseHub System</h2>
                            <p className="text-slate-500 text-sm mt-1">
                                {view === 'login' && 'เข้าสู่ระบบเพื่อจัดการข้อมูล'}
                                {view === 'register' && 'ลงทะเบียนผู้ใช้งานใหม่'}
                                {view === 'forgot' && 'กู้คืนรหัสผ่าน (Reset Password)'}
                                {view === 'forgotUser' && 'กู้คืนชื่อผู้ใช้งาน (Forgot Username)'}
                            </p>
                        </div>

                        {/* --- LOGIN FORM --- */}
                        {view === 'login' && (
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div><label className="text-xs font-bold text-slate-500 flex items-center gap-1"><User size={12}/> ชื่อผู้ใช้งาน</label><input name="username" required className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={formData.username} onChange={handleChange} /></div>
                                
                                <div>
    <label className="text-xs font-bold text-slate-500 flex items-center gap-1">
        <Lock size={12}/> รหัสผ่าน
    </label>
    <div className="relative">
        <input 
    name="password" 
    type={showPassword ? "text" : "password"} 
    required 
    className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all pr-10" 
    value={formData.password} 
    onChange={handleChange} 
/>

{/* ⭐ ปุ่มกดสลับสถานะ (ใช้ SVG โดยตรง) */}
<button 
    type="button" 
    onClick={() => setShowPassword(!showPassword)} 
    className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors" 
    tabIndex="-1"
    title={showPassword ? "ซ่อนรหัสผ่าน" : "แสดงรหัสผ่าน"}
>
    {showPassword ? (
        // 👁️‍🗨️ ไอคอนตาปิด (Eye Off - SVG)
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/>
            <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/>
            <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/>
            <line x1="2" x2="22" y1="2" y2="22"/>
        </svg>
    ) : (
        // 👁️ ไอคอนตาเปิด (Eye - SVG)
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
            <circle cx="12" cy="12" r="3"/>
        </svg>
    )}
</button>
    </div>
</div>

                                <div className="flex justify-between items-center">
                                    
                                    
                                    {/* ⭐ เพิ่มลิงก์ลืมชื่อผู้ใช้งาน ตรงนี้ */}
                                    <div className="flex gap-3 text-xs font-bold">
                                        <button type="button" onClick={() => { setView('forgotUser'); setFormData({...formData, email:''}); }} className="text-indigo-600 hover:underline">ลืมชื่อผู้ใช้?</button>
                                        <span className="text-slate-300">|</span>
                                        <button type="button" onClick={() => { setView('forgot'); setOtpSent(false); setFormData({...formData, email:''}); }} className="text-blue-600 hover:underline">ลืมรหัสผ่าน?</button>
                                    </div>
                                </div>
                                <button type="submit" disabled={loading} className="w-full py-3.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-lg shadow-blue-200 transition-all transform active:scale-95 mt-4">{loading ? 'กำลังโหลด...' : 'เข้าสู่ระบบ'}</button>
                            </form>
                        )}

               {view === 'register' && (
    <form onSubmit={handleRegisterConfirm} className="space-y-4">
        <div className="grid grid-cols-2 gap-3">
            <div>
                {/* ⭐ แนะนำภาษาไทย */}
                <label className="text-xs font-bold text-slate-500">ชื่อ (ภาษาไทย)</label>
                <input name="firstName" required disabled={otpSent} className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} placeholder="สมชาย" />
            </div>
            <div>
                <label className="text-xs font-bold text-slate-500">นามสกุล (ภาษาไทย)</label>
                <input name="lastName" required disabled={otpSent} className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} placeholder="ใจดี" />
            </div>
        </div>
        
        <div><label className="text-xs font-bold text-slate-500">รหัสพนักงาน</label><input name="empId" required disabled={otpSent} className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>
        
        <div><label className="text-xs font-bold text-slate-500">อีเมล (รับ OTP)</label><input name="email" type="email" required disabled={otpSent} className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>
        
        <div>
            {/* ⭐ แนะนำภาษาอังกฤษ */}
            <label className="text-xs font-bold text-slate-500">ชื่อผู้ใช้งาน (English)</label>
            <input name="username" required disabled={otpSent} className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} placeholder="somchai.j" />
        </div>

        {/* ⭐ ช่องรหัสผ่าน (มีปุ่มเปิด/ปิด) */}
        <div>
            <label className="text-xs font-bold text-slate-500">รหัสผ่าน (6+ ตัวอักษร/ตัวเลข)</label>
            <div className="relative">
                <input 
                    name="password" 
                    type={showRegisterPassword ? "text" : "password"} 
                    required 
                    disabled={otpSent} 
                    className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none pr-10" 
                    onChange={handleChange} 
                />
                <button 
                    type="button" 
                    onClick={() => setShowRegisterPassword(!showRegisterPassword)} 
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                    tabIndex="-1"
                >
                    {showRegisterPassword ? (
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                    ) : (
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                    )}
                </button>
            </div>
        </div>

        {/* ⭐ ช่องยืนยันรหัสผ่าน (มีปุ่มเปิด/ปิด) */}
        {!otpSent && (
            <div>
                <label className="text-xs font-bold text-slate-500">ยืนยันรหัสผ่าน</label>
                <div className="relative">
                    <input 
                        name="confirmPassword" 
                        type={showRegisterConfirm ? "text" : "password"} 
                        required 
                        className={`w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none pr-10 ${formData.confirmPassword && formData.password !== formData.confirmPassword ? 'border-red-500 focus:ring-red-200' : ''}`} 
                        onChange={handleChange} 
                    />
                    <button 
                        type="button" 
                        onClick={() => setShowRegisterConfirm(!showRegisterConfirm)} 
                        className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                        tabIndex="-1"
                    >
                        {showRegisterConfirm ? (
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                        ) : (
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                        )}
                    </button>
                </div>
                {/* แจ้งเตือนถ้ารหัสไม่ตรง */}
                {formData.confirmPassword && formData.password !== formData.confirmPassword && (
                    <p className="text-[10px] text-red-500 mt-1">* รหัสผ่านไม่ตรงกัน</p>
                )}
            </div>
        )}
        
        {otpSent && (
            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 text-center animate-in fade-in">
                <p className="text-xs text-blue-600 mb-2">Ref: <b>{refCode}</b> | กรอก OTP 4 หลักที่ส่งไปอีเมล</p>
                <input name="otp" type="text" maxLength="4" required className="w-32 mx-auto p-3 text-center text-xl font-bold bg-white border rounded-lg outline-none focus:ring-4 focus:ring-blue-200" placeholder="0000" onChange={handleChange} />
                <div className="mt-2"><button type="button" onClick={handleRegisterRequestOTP} disabled={countdown > 0} className={`text-xs underline ${countdown>0?'text-gray-400':'text-blue-600'}`}>{countdown>0 ? `ขอใหม่ใน ${countdown} วิ` : 'ขอรหัสใหม่'}</button></div>
            </div>
        )}

        {!otpSent ? (
            <button type="button" onClick={handleRegisterRequestOTP} disabled={loading} className="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-lg mt-4">{loading?'Checking...':'ขอรหัส OTP'}</button>
        ) : (
            <div className="flex gap-2 mt-4">
                <button type="button" onClick={() => setOtpSent(false)} className="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg font-bold">แก้ไข</button>
                <button type="submit" disabled={loading} className="flex-[2] py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-lg">{loading?'Verifying...':'ยืนยันลงทะเบียน'}</button>
            </div>
        )}
    </form>
)}

                        {/* --- FORGOT PASSWORD FORM --- */}
                        {view === 'forgot' && (
                            <form onSubmit={handleResetPassword} className="space-y-4 animate-in fade-in">
                                <div><label className="text-xs font-bold text-slate-500">อีเมลที่ลงทะเบียนไว้</label><input name="email" type="email" required disabled={otpSent} className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>
                                
                                {otpSent && (
                                    <>
                                        <div className="bg-orange-50 p-4 rounded-xl border border-orange-100 text-center">
                                            <p className="text-xs text-orange-800 mb-2">Ref: <b>{refCode}</b> | กรอก OTP เพื่อตั้งรหัสใหม่</p>
                                            <input name="otp" type="text" maxLength="4" required className="w-32 mx-auto p-3 text-center text-xl font-bold bg-white border rounded-lg outline-none focus:ring-4 focus:ring-orange-200" placeholder="0000" onChange={handleChange} />
                                            <div className="mt-2"><button type="button" onClick={handleForgotRequestOTP} disabled={countdown > 0} className={`text-xs underline ${countdown>0?'text-gray-400':'text-orange-600'}`}>{countdown>0 ? `ขอใหม่ใน ${countdown} วิ` : 'ขอรหัสใหม่'}</button></div>
                                        </div>
                                        <div><label className="text-xs font-bold text-slate-500">รหัสผ่านใหม่</label><input name="newPassword" type="password" required className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>
                                        <div><label className="text-xs font-bold text-slate-500">ยืนยันรหัสผ่านใหม่</label><input name="confirmPassword" type="password" required className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} /></div>
                                    </>
                                )}

                                {!otpSent ? (
                                    <button type="button" onClick={handleForgotRequestOTP} disabled={loading} className="w-full py-3.5 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-bold shadow-lg mt-4">{loading?'Sending...':'ส่งรหัส OTP'}</button>
                                ) : (
                                    <div className="flex gap-2 mt-4">
                                        <button type="button" onClick={() => setOtpSent(false)} className="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg font-bold">ยกเลิก</button>
                                        <button type="submit" disabled={loading} className="flex-[2] py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-lg">{loading?'Resetting...':'เปลี่ยนรหัสผ่าน'}</button>
                                    </div>
                                )}
                            </form>
                        )}

                        {/* --- ⭐ FORGOT USERNAME FORM --- */}
                        {view === 'forgotUser' && (
                            <form onSubmit={handleRecoverUsername} className="space-y-4 animate-in fade-in">
                                <div className="text-center mb-6">
                                    <div className="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-3"><User size={24}/></div>
                                    <p className="text-sm text-gray-600">กรุณากรอกอีเมลที่ใช้ลงทะเบียน<br/>ระบบจะส่งชื่อผู้ใช้งาน (Username) ไปให้ทางอีเมล</p>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500">อีเมล</label>
                                    <input name="email" type="email" required className="w-full p-3 bg-slate-50 border rounded-lg text-sm outline-none" onChange={handleChange} value={formData.email} placeholder="name@example.com"/>
                                </div>
                                <button type="submit" disabled={loading} className="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-lg mt-2">{loading?'Sending...':'ส่งชื่อผู้ใช้งาน'}</button>
                                <button type="button" onClick={() => setView('login')} className="w-full py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg font-bold text-sm">กลับหน้าเข้าสู่ระบบ</button>
                            </form>
                        )}

                        <div className="mt-8 text-center pb-8">
                            {view !== 'login' && view !== 'forgotUser' && <p className="text-xs text-slate-500 mb-2">มีบัญชีอยู่แล้ว? <button onClick={() => { setView('login'); setOtpSent(false); }} className="text-blue-600 font-bold hover:underline">เข้าสู่ระบบ</button></p>}
                            {view === 'login' && <p className="text-xs text-slate-500">ยังไม่มีบัญชี? <button onClick={() => { setView('register'); setOtpSent(false); }} className="text-blue-600 font-bold hover:underline">สมัครสมาชิก</button></p>}
                            <div className="mt-6 flex justify-center items-center gap-2 text-[10px] text-slate-400"><ShieldCheck size={12}/> PurchaseHub System v1.0</div>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    // --- Helper: Print Check Logic ---
      const handleOpenPrintPreview = (req) => {
          // 1. จำลอง Logic การหา User เหมือนในหน้า Preview
          const historyDesc = [...(req.history || [])].reverse();
          const isActionMatch = (logAction, statusKey) => {
              if (!logAction) return false;
              const label = STATUS_LABELS[statusKey] || '';
              return logAction === statusKey || logAction === label || logAction.includes(label);
          };

          // หา Log ของแต่ละระดับ
          const reqLog = historyDesc.find(h => h.action === 'Draft' || h.action === 'Create' || h.action.includes('สร้าง')) || historyDesc[historyDesc.length - 1];
          
          let l1Log = historyDesc.find(h => 
              isActionMatch(h.action, 'Pending PM') || 
              ((req.type === 'Withdraw' || req.type === 'Borrow') && isActionMatch(h.action, 'Ready to Disburse'))
          );

// ⭐ เพิ่มเงื่อนไขกรอง Log ของฝ่ายจัดซื้อออก (ทั้งเปลี่ยนเป็น HO และตรวจสอบผ่าน)
const l2Log = historyDesc.find(h => 
    isActionMatch(h.action, 'Approved') && 
    h !== l1Log &&
    (!h.note || !h.note.includes('เปลี่ยนเป็น HO')) && // กรอง Log ตอนเปลี่ยนเป็น HO
    (!h.note || !h.note.includes('ตรวจสอบผ่าน'))      // ⭐ กรอง Log ตอนตรวจสอบผ่าน (Verification Pass)
);

          // ฟังก์ชันดึง User Object
          const getUser = (log) => {
              if(!log || !log.user) return null;
              let txt = log.user.replace(' (Email)', '').trim();
              const firstPart = txt.split(' ')[0];
              return allUsers.find(u => 
                  (u.empId && u.empId === firstPart) || 
                  (u.username === txt) ||
                  (u.email && txt.includes(u.email)) ||
                  (`${u.firstName} ${u.lastName}` === txt)
              );
          };

          const userReq = getUser(reqLog);
          const userL1 = getUser(l1Log);
          const userL2 = getUser(l2Log);

          // 2. ตรวจสอบว่าใครขาดลายเซ็น
          const missingSigs = [];

          // ผู้ขอ (จำเป็นเสมอ)
          if (!userReq || !userReq.signature) missingSigs.push("ผู้ขอ (Requester)");

          // Level 1 (จำเป็นสำหรับสถานะที่อนุมัติแล้ว)
          if (!userL1 || !userL1.signature) missingSigs.push("ผู้อนุมัติ Level 1");

          // Level 2 (จำเป็นเฉพาะงานซื้อ Local หรือ HO Full Flow)
          const needsL2 = (req.type === 'Local' || (req.type === 'HO' && req.isFullApprovalFlow));
          if (needsL2 && req.type !== 'Withdraw' && req.type !== 'Borrow') {
               if (!userL2 || !userL2.signature) missingSigs.push("ผู้อนุมัติ Level 2");
          }

          // 3. แจ้งเตือนหรือเปิดหน้าพิมพ์
          if (missingSigs.length > 0) {
              showToast(`ไม่สามารถพิมพ์ได้: ขาดลายเซ็นของ ${missingSigs.join(', ')}`, 'error');
          } else {
              openPOPreview(req);
          }
      };


const handleSaveProject = async () => {
    // 1. Validation
    if (!editingProject.id) { showToast('กรุณาระบุรหัสโครงการ', 'error'); return; }
    if (!editingProject.name) { showToast('กรุณาระบุชื่อโครงการ', 'error'); return; }
    
    if (editingProject.isNew && projects.some(p => p.id === editingProject.id)) {
        showToast('รหัสโครงการนี้มีอยู่แล้ว', 'error');
        return;
    }

    // ⭐ สั่งให้แสดง Loading (วงกลมหมุน)
    setIsLoading(true);

    try {
        // เตรียมข้อมูลเก่า (Old Data) เพื่อเอาไปค้นหาและแก้ไข
        let oldName = '';
        let oldId = '';
        if (!editingProject.isNew) {
            const originalProj = projects.find(p => p.id === editingProject.originalId);
            if (originalProj) {
                oldName = originalProj.name;
                oldId = originalProj.id;
            }
        }

        const projectToSave = { ...editingProject, isNew: undefined, originalId: undefined };
        
        // --- 1. อัปเดตข้อมูลบนหน้าจอทันที (Optimistic UI) ---
        if (editingProject.isNew) {
            setProjects(prev => [...prev, projectToSave]);
            // เพิ่มสิทธิ์ให้คนสร้าง
            if (user) {
                const currentPerms = { ...(user.permissions || {}) };
                currentPerms[projectToSave.name] = [26];
                const updatedUser = { ...user, permissions: currentPerms };
                setUser(updatedUser);
                google.script.run.saveUserData(updatedUser);
            }
        } else {
            setProjects(prev => prev.map(p => p.id === (editingProject.originalId || editingProject.id) ? projectToSave : p));
        }

        // --- 2. ส่งไปบันทึกที่ Backend ---
        if (editingProject.isNew) {
            // กรณีสร้างใหม่: ใช้ฟังก์ชันเดิม
            await new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).syncProject(projectToSave);
            });
            await addInvLog('Add Project', projectToSave.name, 'New', `เพิ่มโครงการใหม่: ${projectToSave.name}`, []);
        } else {
            // ⭐ กรณีแก้ไข: ใช้ฟังก์ชันใหม่ที่กวาดล้างทั้งระบบ
            await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .updateProjectGlobalData(projectToSave, oldId, oldName);
            });

            // บันทึก Log
            let changes = [];
            if(oldId !== projectToSave.id) changes.push(`ID: ${oldId} -> ${projectToSave.id}`);
            if(oldName !== projectToSave.name) changes.push(`Name: ${oldName} -> ${projectToSave.name}`);
            await addInvLog('Edit Project', projectToSave.name, 'Edit', `แก้ไขข้อมูลโครงการ:\n${changes.join('\n')}`, []);
        }
        
        showToast('บันทึกข้อมูลเรียบร้อย');
        setShowProjectModal(false);
        setEditingProject(null);
        
        // ถ้าเปิดหน้ารายละเอียดอยู่ ให้อัปเดตด้วย
        if (viewingProject && viewingProject.id === (editingProject.originalId || editingProject.id)) {
            setViewingProject(projectToSave);
        } else {
            setShowProjectDetailModal(false);
        }

    } catch (error) {
        console.error(error);
        showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
    } finally {
        // ⭐ หยุดหมุนเมื่อเสร็จ
        setIsLoading(false);
    }
};


// --- [index.html] แก้ไขฟังก์ชัน handleDeleteProject (Secure Version) ---

const handleDeleteProject = async (id) => {
    // 1. ถามยืนยันก่อนลบ
    if (!confirm('ยืนยันการลบโครงการ? ข้อมูล SubJob และ Mat. Code จะหายไปทั้งหมด')) return;
    
    // ดึงข้อมูลโครงการที่จะลบ (เพื่อเอาชื่อโครงการไปเช็คสิทธิ์)
    const targetProject = projects.find(p => p.id === id);
    const projectName = targetProject ? targetProject.name : id;

    // สั่งให้หน้าจอหมุนรอ (Loading)
    setIsLoading(true);

    try {
        // 2. เรียก Backend แบบปลอดภัย (Secure Call)
        await new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                // ⭐ ส่ง user.id และ projectName ไปให้ Backend ตรวจสอบสิทธิ์
                .deleteItemSecure(user.id, 'Projects', id, projectName); 
        });

        // 3. ถ้าผ่าน (ไม่มี Error) ค่อยอัปเดตหน้าจอ
        setProjects(prev => prev.filter(p => p.id !== id));
        
        // 4. บันทึก Log การลบ (Frontend Log - เพื่อการแสดงผล)
        // หมายเหตุ: Backend อาจจะบันทึก Log เองต่างหากแล้ว แต่ตัวนี้เอาไว้โชว์ในหน้าประวัติทันที
        await addInvLog('Delete Project', projectName, 'Delete', `ลบโครงการ ${projectName} (ID: ${id})`, []);
        
        setShowProjectDetailModal(false); 
        showToast('ลบโครงการเรียบร้อย');

    } catch (err) {
        console.error(err);
        // ถ้า Backend ไม่อนุญาต (Throw Error) จะเด้งมาตรงนี้
        showToast("ลบไม่สำเร็จ: " + err.message, 'error');
        // (Optional: โหลดข้อมูล Projects กลับมาใหม่ เพื่อให้หน้าจอตรงกับความจริง)
        handleRefresh(); 
    } finally {
        setIsLoading(false);
    }
};

      const handleImportProjectData = (e, type) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (event) => {
              const text = event.target.result;
              const rows = text.split('\n').map(row => row.split(','));
              
              // CSV Format Expectation: Code, Description
              // Skip Header row if exists (Check if row 0 is header)
              
              
              const startIndex = rows[0][0].toLowerCase().includes('group') || rows[0][1].toLowerCase().includes('code') ? 1 : 0;

              // ⭐ แก้ไข Logic การ Map ข้อมูล (Group อยู่ Col 0, Code อยู่ Col 1)
              const newData = rows.slice(startIndex).filter(row => row.length >= 2 && row[1]?.trim()).map(row => ({
                  group: row[0]?.trim() || '',        // Col 0: Group
                  code: row[1]?.trim(),               // Col 1: Code
                  description: row[2]?.trim() || '',  // Col 2: Description
                  budget: parseFloat(row[3]?.trim()) || 0 // Col 3: Budget
              }));
              
              setEditingProject(prev => ({
                  ...prev,
                  [type]: [...(prev[type] || []), ...newData]
              }));
              showToast(`นำเข้า ${type === 'subJobs' ? 'SubJob' : 'Mat. Code'} สำเร็จ ${newData.length} รายการ`);
          };
          reader.readAsText(file);
          e.target.value = ''; // Reset input
      };



      // --- STATE: Asset Summary Drill-down ---
      const [showAssetGroupModal, setShowAssetGroupModal] = useState(false);
      const [selectedAssetGroup, setSelectedAssetGroup] = useState(null);
      // --- STATE: Selection & Restore ---
      const [selectedAssets, setSelectedAssets] = useState([]);
      
     // --- STATE: Inventory Selection ---
      const [selectedInventory, setSelectedInventory] = useState([]);

      // --- LOGIC: INVENTORY SELECTION & BULK DELETE ---
      
      const toggleSelectInventory = (id) => {
          setSelectedInventory(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
      };

      const toggleSelectAllInventory = () => {
          if (selectedInventory.length === filteredInventory.length) setSelectedInventory([]);
          else setSelectedInventory(filteredInventory.map(i => i.id));
      };

      // ปรับปรุงฟังก์ชันลบ ให้รองรับการลบหลายรายการ
      const handleDeleteInventory = async (ids = []) => {
          const targetIds = ids.length > 0 ? ids : selectedInventory;
          if (targetIds.length === 0) return;

          if (!confirm(`ยืนยันการลบสินค้า ${targetIds.length} รายการ? \n(ข้อมูลจะถูกบันทึกในประวัติ และสามารถกู้คืนได้)`)) return;

          setIsLoading(true);
          try {
for (const id of targetIds) {
    const item = inventory.find(i => i.id === id);
    if (item) {
        // ⭐ เปลี่ยนการเรียก Backend ตรงนี้
        await new Promise((resolve, reject) => {
             // ส่ง user.id และ item.project ไปตรวจสอบ
             google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject) // เพิ่ม reject เพื่อจับ Error สิทธิ์
                .deleteItemSecure(user.id, 'Inventory', id, item.project || 'ส่วนกลาง'); 
        });
        
        const backupData = JSON.stringify(item);
        
        // ⭐ ระบุชื่อโครงการในช่อง Change
        const projectLabel = item.project || 'ส่วนกลาง';
        await addInvLog('Delete Inventory', item.name, `Delete (${projectLabel})`, backupData, [], null, id);
    }
}

              setInventory(prev => prev.filter(i => !targetIds.includes(i.id)));
              setSelectedInventory([]); // เคลียร์การเลือก
              setShowItemDetailModal(false);
              showToast(`ลบสินค้า ${targetIds.length} รายการ เรียบร้อย`);
          } catch (err) {
              console.error(err);
              showToast('ลบสินค้าบางรายการไม่สำเร็จ', 'error');
          } finally {
              setIsLoading(false);
          }
      };
      const [invTabMode, setInvTabMode] = useState('System'); // 'System', 'NonSystem', 'Summary'

// --- STATE: Inventory Import ---
      const [showImportInvModal, setShowImportInvModal] = useState(false);
      const [importInvData, setImportInvData] = useState([]);
      const [importInvFileName, setImportInvFileName] = useState('');

      

// --- LOGIC: IMPORT INVENTORY CSV (UPDATED: Thai Support & ID Column) ---
const handleInvFileImport = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    setImportInvFileName(file.name);
    const reader = new FileReader();
    
    reader.onload = (event) => {
        const text = event.target.result;
        const rows = text.split('\n').map(row => row.split(','));
        
        // Helper: แปลงประเภท (รองรับภาษาไทย)
        const getStockType = (val) => {
            if (!val) return 'System';
            const v = val.trim().toLowerCase();
            if (v.includes('นอก') || v.includes('non')) return 'NonSystem';
            return 'System'; // Default: ในระบบ
        };

        // CSV Columns (9 columns): 
        // 0: ID, 1: Name, 2: Type, 3: Qty, 4: Unit, 5: Min, 6: Price, 7: Note, 8: Project
        const data = rows.slice(1).filter(row => row.length > 1 && row[1]?.trim() !== '').map((row, index) => {
            return {
                tempId: index,
                id: row[0]?.trim() || '',           // ⭐ Col 0: รหัสวัสดุ (Material Code)
                name: row[1]?.trim() || '',         // Col 1: ชื่อสินค้า
                stockType: getStockType(row[2]),    // Col 2: ประเภท
                qty: parseInt(row[3]?.trim()) || 0, // Col 3: จำนวน
                unit: row[4]?.trim() || 'ชิ้น',      // Col 4: หน่วย
                minStock: parseInt(row[5]?.trim()) || 0, // Col 5: Min Stock
                price: parseFloat(row[6]?.trim()) || 0,  // Col 6: ราคา
                note: row[7]?.trim() || '',          // Col 7: หมายเหตุ
                project: row[8]?.trim() || ''        // Col 8: โครงการ
            };
        });
        setImportInvData(data);
    };
    
    reader.readAsText(file);
};

// --- LOGIC: CONFIRM IMPORT INVENTORY (BATCH + CHUNKING VERSION) ---
const confirmImportInventory = async () => {
    if (importInvData.length === 0) return;

    // 1. Validation Loop (ตรวจสอบข้อมูลเหมือนเดิม)
    for (let i = 0; i < importInvData.length; i++) {
        const item = importInvData[i];
        if (!item.name) { showToast(`รายการที่ ${i+1}: ขาดชื่อสินค้า`, 'error'); return; }
        if (!item.project) { showToast(`รายการที่ ${i+1}: ขาดชื่อโครงการ`, 'error'); return; }
        const projectExists = projects.some(p => p.name === item.project);
        if (!projectExists) { showToast(`รายการที่ ${i+1}: ไม่พบโครงการ "${item.project}" ในระบบ`, 'error'); return; }
    }

    setIsLoading(true); // เริ่มหมุน Loading
    const date = new Date().toLocaleString('th-TH');
    
    // เตรียมข้อมูลสำหรับคำนวณและบันทึก
    let currentInvList = [...inventory];
    let runNoCount = inventory.length;
    
    // ⭐ ตะกร้าเก็บข้อมูลที่จะส่งไปบันทึก (เตรียมไว้ให้ครบก่อนค่อยซอยส่ง)
    let batchItems = [];
    let batchLogs = [];

    // 2. Loop Processing (คำนวณ Logic การ Merge/New Item)
    for (const item of importInvData) {
        const currentType = item.stockType || 'System';

        // เช็คว่ามีของเดิมหรือไม่
        const existingIndex = currentInvList.findIndex(inv => 
            inv.name === item.name && 
            inv.project === item.project &&
            (inv.stockType === currentType || (!inv.stockType && currentType === 'System'))
        );

        if (existingIndex !== -1) {
            // ✅ MERGE (อัปเดตของเดิม)
            const existingItem = currentInvList[existingIndex];
            const updatedItem = {
                ...existingItem,
                id: existingItem.id, 
                qty: existingItem.qty + item.qty,
                price: item.price > 0 ? item.price : existingItem.price,
                note: item.note ? (existingItem.note ? `${existingItem.note} | ${item.note}` : item.note) : existingItem.note,
                lastUpdated: date
            };
            
            // อัปเดตใน List หน้าบ้าน (เพื่อรอแสดงผลเมื่อจบงาน)
            currentInvList[existingIndex] = updatedItem;
            
            // ใส่ตะกร้าสินค้าที่จะบันทึก
            const { images, ...itemForServer } = updatedItem;
            batchItems.push(itemForServer);
            
            // สร้าง Log ใส่ตะกร้า
            batchLogs.push({
                date: date,
                action: 'Import Merge',
                item: updatedItem.name,
                change: `+${item.qty}`,
                note: `โครงการ: ${item.project} (${currentType}) | CSV Import`,
                images: [],
                requestId: null,
                assetId: updatedItem.id,
                by: `${user.empId} ${user.firstName}`
            });
            
        } else {
            // ✅ NEW (สร้างใหม่)
            let baseId = item.id;
            if (!baseId) {
                runNoCount++;
                baseId = `INV-${String(runNoCount).padStart(3, '0')}`;
                while (currentInvList.some(inv => getDisplayId(inv.id) === baseId)) {
                    runNoCount++;
                    baseId = `INV-${String(runNoCount).padStart(3, '0')}`;
                }
            }

            let finalId = `${baseId}|${item.project}|${currentType}`;
            let counter = 1;
            while (currentInvList.some(i => i.id === finalId)) {
                finalId = `${baseId}|${item.project}|${currentType}|${counter}`;
                counter++;
            }

            const newItem = {
                id: finalId,
                name: item.name,
                stockType: currentType,
                qty: item.qty,
                unit: item.unit || 'ชิ้น',
                minStock: item.minStock || 0,
                price: item.price || 0,
                lastUpdated: date,
                image: null,
                images: [],
                note: item.note,
                project: item.project
            };
            
            currentInvList.push(newItem);
            
            const { images, ...itemForServer } = newItem;
            batchItems.push(itemForServer);

            const typeLabel = currentType === 'NonSystem' ? '[นอกระบบ]' : '[ในระบบ]';
            batchLogs.push({
                date: date, 
                action: 'Import New',
                item: newItem.name,
                change: `Start: ${newItem.qty}`,
                note: `โครงการ: ${item.project} ${typeLabel} | CSV New Item`,
                images: [],
                requestId: null,
                assetId: finalId,
                by: `${user.empId} ${user.firstName}`
            });
        }
    }

    // ⭐⭐ 3. เริ่มส่งข้อมูลแบบแบ่งส่วน (Chunking Logic) ⭐⭐
    const CHUNK_SIZE = 100; // กำหนดขนาดก้อนข้อมูล (แนะนำ 50-100 รายการ)
    const totalChunks = Math.ceil(batchItems.length / CHUNK_SIZE);

    try {
        for (let i = 0; i < batchItems.length; i += CHUNK_SIZE) {
            // ตัดแบ่งข้อมูล Items และ Logs ให้ตรงกัน
            const chunkItems = batchItems.slice(i, i + CHUNK_SIZE);
            const chunkLogs = batchLogs.slice(i, i + CHUNK_SIZE);
            
            const currentChunk = Math.floor(i / CHUNK_SIZE) + 1;
            
            // แสดง Toast บอกความคืบหน้า
            showToast(`กำลังบันทึกชุดที่ ${currentChunk}/${totalChunks} (${chunkItems.length} รายการ)...`, 'info');

            // ส่งก้อนนี้ไปบันทึก (รอจนเสร็จค่อยส่งก้อนต่อไป)
            await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler((err) => reject(new Error(`Batch ${currentChunk} failed: ${err.message}`)))
                    .batchImportInventory(chunkItems, chunkLogs); // ใช้ฟังก์ชันเดิมได้เลย
            });
        }

        // 4. เมื่อวนลูปครบทุกก้อนแล้วค่อยอัปเดตหน้าจอทีเดียว
        setInventory(currentInvList); 
        
        setIsLoading(false);
        setShowImportInvModal(false);
        setImportInvData([]);
        setImportInvFileName('');
        showToast(`นำเข้าข้อมูล ${batchItems.length} รายการ เสร็จสิ้น!`);
        
    } catch (error) {
        setIsLoading(false);
        console.error(error);
        showToast("Error saving batch: " + error.message, 'error');
    }
};


      // --- LOGIC: DELETE & RESTORE ---
      
      // 1. ฟังก์ชันลบ (รองรับทั้งแบบเดี่ยวและหลายรายการ)
      const handleDeleteAssets = async (ids = []) => {
          const targetIds = ids.length > 0 ? ids : selectedAssets;
          if (targetIds.length === 0) return;
          
          if (!confirm(`ยืนยันการลบ ${targetIds.length} รายการ? \n(ข้อมูลจะถูกบันทึกในประวัติ และสามารถกู้คืนได้โดย Admin)`)) return;

          setIsLoading(true);
          try {
              // วนลูลลบทีละรายการ
for (const id of targetIds) {
    const asset = assets.find(a => a.id === id);
    if (asset) {
        // ⭐ เปลี่ยนการเรียก Backend ตรงนี้
        await new Promise((resolve, reject) => {
             google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .deleteItemSecure(user.id, 'Assets', id, asset.project || 'ส่วนกลาง');
        });
        
        const backupData = JSON.stringify(asset);
        
        // ⭐ ระบุชื่อโครงการในช่อง Change
        const projectLabel = asset.project || 'ส่วนกลาง';
        await addInvLog('Delete Asset', asset.name, `Delete (${projectLabel})`, backupData, [], null, id);
    }
}

              // 3. อัปเดต State (ลบออกจากหน้าจอ)
              setAssets(prev => prev.filter(a => !targetIds.includes(a.id)));
              setSelectedAssets([]); // เคลียร์การเลือก
              setShowItemDetailModal(false); // ปิด Modal ถ้าเปิดอยู่
              
              showToast(`ลบเสร็จสิ้น ${targetIds.length} รายการ`);

          } catch (err) {
              console.error(err);
              showToast('เกิดข้อผิดพลาดในการลบ', 'error');
          } finally {
              setIsLoading(false);
          }
      };

// 2. ฟังก์ชันกู้คืน (Restore) - เฉพาะผู้มีสิทธิ์
const handleRestoreAsset = async (log) => {
    try {
        // 1. แปลงข้อมูลจาก Note (JSON) ออกมาก่อน เพื่อดูว่าเป็นของโครงการไหน
        const assetData = JSON.parse(log.note);
        if (!assetData || !assetData.id) throw new Error("ข้อมูล Backup ไม่ถูกต้อง");

        // ⭐ 2. ตรวจสอบสิทธิ์: ต้องมีสิทธิ์กู้คืน (27) ในโครงการนั้นๆ
        const targetProject = assetData.project || 'ส่วนกลาง'; // ถ้าไม่มี Project ให้ถือเป็นส่วนกลาง
        if (!hasPermission(27, targetProject)) {
            showToast(`คุณไม่มีสิทธิ์กู้คืนข้อมูลของโครงการ "${targetProject}"`, 'error');
            return;
        }

        setIsLoading(true);
        // 3. เช็คว่า ID นี้มีอยู่แล้วหรือไม่ (กันซ้ำ)
        if (assets.some(a => a.id === assetData.id)) {
                showToast(`รายการ ${assetData.id} มีอยู่ในระบบแล้ว (ไม่ต้องกู้คืน)`, 'error');
                setIsLoading(false);
                return;
        }

        // 4. บันทึกลง Sheet
        const { images, ...assetForServer } = assetData;
        await new Promise((resolve) => {
                google.script.run.withSuccessHandler(resolve).syncAsset(assetForServer);
        });

        // 5. อัปเดต State และบันทึก Log
        setAssets(prev => [...prev, assetData]);
        
        // บันทึก Log การกู้คืน (ระบุโครงการด้วย)
        await addInvLog('Restore Asset', assetData.name, 'Restore', `กู้คืนเข้าโครงการ ${targetProject} (จากประวัติวันที่ ${log.date})`, [], null, assetData.id);
        
        showToast(`กู้คืนทรัพย์สิน ${assetData.id} เรียบร้อย`);
    } catch (err) {
        console.error(err);
        showToast('กู้คืนล้มเหลว: ข้อมูลสำรองเสียหายหรืออ่านไม่ได้', 'error');
    } finally {
        setIsLoading(false);
    }
};

      // --- LOGIC: INVENTORY MANAGEMENT (DELETE, RESTORE, UPDATE) ---


// 3. กู้คืนสินค้า (Restore Inventory) - รองรับสิทธิ์
const handleRestoreInventory = async (log) => {
    try {
        // 1. แปลงข้อมูล
        const itemData = JSON.parse(log.note);
        if (!itemData || !itemData.id) throw new Error("ข้อมูล Backup ไม่ถูกต้อง");

        // ⭐ 2. ตรวจสอบสิทธิ์: ต้องมีสิทธิ์กู้คืน (27) ในโครงการนั้นๆ
        const targetProject = itemData.project || 'ส่วนกลาง';
        if (!hasPermission(27, targetProject)) {
            showToast(`คุณไม่มีสิทธิ์กู้คืนข้อมูลของโครงการ "${targetProject}"`, 'error');
            return;
        }

        setIsLoading(true);
        // 3. เช็ค ID ซ้ำ
        if (inventory.some(i => i.id === itemData.id)) {
                showToast(`รหัส ${itemData.id} มีอยู่แล้ว`, 'error');
                setIsLoading(false);
                return;
        }

        // 4. บันทึกลง Sheet
        const { images, ...itemForServer } = itemData;
        await new Promise((resolve) => {
                google.script.run.withSuccessHandler(resolve).syncInventory(itemForServer);
        });

        // 5. อัปเดต State และบันทึก Log
        setInventory(prev => [...prev, itemData]);
        
        await addInvLog('Restore Inventory', itemData.name, 'Restore', `กู้คืนเข้าโครงการ ${targetProject} (จากประวัติ ${log.date})`, [], null, itemData.id);

        showToast(`กู้คืนสินค้า ${itemData.id} เรียบร้อย`);
    } catch (err) {
        console.error(err);
        showToast('กู้คืนล้มเหลว', 'error');
    } finally {
        setIsLoading(false);
    }
};

// --- HELPER: ลบรูปภาพในหน้าแก้ไขสินค้า (Inventory Edit) ---

// 1. ลบรูปใหม่ที่เพิ่งเลือก (New Preview)
const handleRemoveEditStockNewImage = (index) => {
    setEditingStockItem(prev => ({
        ...prev,
        newImages: prev.newImages.filter((_, i) => i !== index)
    }));
};

// 2. ลบรูปเดิมที่มีอยู่แล้ว (Current Image)
const handleRemoveCurrentInvImage = () => {
    if(confirm('ต้องการลบรูปภาพปัจจุบันออกใช่หรือไม่?')) {
        setEditingStockItem(prev => ({ ...prev, image: null }));
    }
};

// --- LOGIC: UPDATE INVENTORY (UPDATED: Full History Log) ---
const handleUpdateInventory = async () => {
    if (!editingStockItem) return;

    // 1. Validation: เช็คชื่อซ้ำ
    const duplicateName = inventory.find(i => 
        i.name === editingStockItem.name && 
        i.project === editingStockItem.project && 
        (i.stockType === editingStockItem.stockType) &&
        i.id !== editingStockItem.originalId
    );

    if (duplicateName) {
        showToast(`แก้ไขไม่ได้: ชื่อ "${editingStockItem.name}" มีอยู่แล้วในประเภทเดียวกัน`, 'error');
        return;
    }

    setIsLoading(true);
    try {
        const date = new Date().toLocaleString('th-TH');
        const currentType = editingStockItem.stockType || 'System';
        
        // 2. สร้าง ID เต็ม
        let inputId = editingStockItem.id;
        if (inputId.includes('|')) inputId = inputId.split('|')[0]; 
        
        let finalId = `${inputId}|${editingStockItem.project}|${currentType}`;
        
        // 3. เช็ค ID ซ้ำ
        if (finalId !== editingStockItem.originalId) { 
             let counter = 1;
             while (inventory.some(i => i.id === finalId && i.id !== editingStockItem.originalId)) {
                 finalId = `${inputId}|${editingStockItem.project}|${currentType}|${counter}`;
                 counter++;
             }
        } else {
             finalId = editingStockItem.originalId;
        }

        // 4. Upload Images
        let newUploadedFiles = [];
        if (editingStockItem.newImages && editingStockItem.newImages.length > 0) {
             const uploadPromises = editingStockItem.newImages.map(imgObj => {
                return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(imgObj.file);
                        reader.onload = () => google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).uploadAssetImage(reader.result, imgObj.file.name);
                });
            });
            newUploadedFiles = await Promise.all(uploadPromises);
        }
        const mainImage = newUploadedFiles.length > 0 ? newUploadedFiles[0].name : editingStockItem.image;
        
        // 5. เตรียมข้อมูลใหม่
        const updatedItem = {
            ...editingStockItem,
            id: finalId, // ใช้ ID ใหม่
            lastUpdated: date,
            image: mainImage,
            images: [], 
            newImages: []
        };

        // ⭐ 6. Compare Changes (บันทึกประวัติการเปลี่ยนแปลงทั้งหมด) ⭐
        // ดึงข้อมูลเดิมมาเปรียบเทียบ
        const originalItem = inventory.find(i => i.id === editingStockItem.originalId);
        let changes = [];

        if (originalItem) {
            // แปลง Type เป็นภาษาไทยเพื่อความสวยงาม
            const oldType = originalItem.stockType === 'NonSystem' ? 'นอกระบบ' : 'ในระบบ';
            const newType = currentType === 'NonSystem' ? 'นอกระบบ' : 'ในระบบ';

            if (getDisplayId(originalItem.id) !== getDisplayId(finalId)) changes.push(`รหัส: ${getDisplayId(originalItem.id)} -> ${getDisplayId(finalId)}`);
            if (originalItem.stockType !== currentType) changes.push(`ประเภท: ${oldType} -> ${newType}`);
            if (originalItem.name !== updatedItem.name) changes.push(`ชื่อ: ${originalItem.name} -> ${updatedItem.name}`);
            if (originalItem.qty !== updatedItem.qty) changes.push(`คงเหลือ: ${originalItem.qty} -> ${updatedItem.qty}`);
            if (originalItem.unit !== updatedItem.unit) changes.push(`หน่วยนับ: ${originalItem.unit} -> ${updatedItem.unit}`);
            if (originalItem.minStock !== updatedItem.minStock) changes.push(`Min Stock: ${originalItem.minStock} -> ${updatedItem.minStock}`);
            if (originalItem.price !== updatedItem.price) changes.push(`ราคา: ${originalItem.price} -> ${updatedItem.price}`);
            if (originalItem.note !== updatedItem.note) changes.push(`หมายเหตุ: ${originalItem.note||'-'} -> ${updatedItem.note||'-'}`);
            
            if (newUploadedFiles.length > 0) changes.push("เปลี่ยนรูปใหม่ (แทนที่รูปเดิม)");
        }

        const changeLog = changes.length > 0 ? changes.join('\n- ') : 'แก้ไขข้อมูล (ไม่มีการเปลี่ยนแปลงค่า)';

        // 7. จัดการกรณีเปลี่ยนรหัส (Change ID Logic)
        if (editingStockItem.originalId !== finalId) {
             await new Promise(r => google.script.run.withSuccessHandler(r).deleteDataFromSheet('Inventory', editingStockItem.originalId)); 
             
             try {
                  await new Promise(r => google.script.run.withSuccessHandler(r).updateLogItemId(editingStockItem.originalId, finalId));
             } catch (e) {
                 console.log("Backend updateLogItemId not found, skipping backend log update.");
             }

             setInvLogs(prevLogs => prevLogs.map(log => {
                 if (log.assetId === editingStockItem.originalId) {
                     return { ...log, assetId: finalId }; 
                 }
                 return log;
             }));
        }

        // 8. Update Inventory State
        setInventory(prev => {
            const filtered = prev.filter(i => i.id !== editingStockItem.originalId);
            return [...filtered, updatedItem];
        });

        // 9. Save Inventory
        const { images, newImages, originalId, originalName, originalProject, ...itemForServer } = updatedItem;
        await saveInventoryToSheet(itemForServer);

        // 10. Add Log (Change History)
        const logAttachments = newUploadedFiles.map(f => ({ name: f.name, type: 'image/jpeg', url: f.url }));
        
        // ใช้ \n เพื่อขึ้นบรรทัดใหม่ในช่อง Note
        addInvLog('Update Stock', updatedItem.name, 'Edit', `แก้ไขข้อมูล:\n- ${changeLog}`, logAttachments, null, finalId);
        
        setIsLoading(false);
        setShowEditInvModal(false);
        setEditingStockItem(null);
        showToast('แก้ไขข้อมูลและอัปเดตประวัติเรียบร้อย');

    } catch (error) {
        setIsLoading(false);
        console.error(error);
        showToast("Error: " + error.message, 'error');
    }
};


      // 3. จัดการ Checkbox
      const toggleSelectAsset = (id) => {
          setSelectedAssets(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
      };

      const toggleSelectAllAssets = () => {
          if (selectedAssets.length === filteredAssets.length) setSelectedAssets([]);
          else setSelectedAssets(filteredAssets.map(a => a.id));
      };

      const toggleExpandItem = (idx) => {
    const newSet = new Set(expandedItems);
    if (newSet.has(idx)) newSet.delete(idx);
    else newSet.add(idx);
    setExpandedItems(newSet);
};
      

      // --- FUNCTION: Open Image Fullscreen ---
      const handleOpenImage = (imageUrl) => {
          if (imageUrl) {
              setFullscreenImage(imageUrl);
          }
      };

      
  // ⭐ แก้ไข: เปลี่ยนให้เป็น Promise เพื่อให้ใส่ await ได้ (แก้ปัญหา Too many scripts)
      const saveRequestToSheet = (req) => {
         return new Promise((resolve, reject) => google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).syncRequest(req));
      };
      const saveInventoryToSheet = (item) => {
         return new Promise((resolve, reject) => google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).syncInventory(item));
      };
      const saveAssetToSheet = (asset) => {
         return new Promise((resolve, reject) => google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).syncAsset(asset));
      };


const saveLogToSheet = (log) => {
   // ⭐ เปลี่ยนเป็น Promise เพื่อให้รอการบันทึกเสร็จ
   return new Promise((resolve, reject) => {
       google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).syncLog(log);
   });
};

const handleCreateOrder = async (e, isDraft = false) => {
        e.preventDefault();
        
        // Validation พื้นฐาน (ส่วนหัว)
        if (!newOrderMeta.job || !newOrderMeta.dateRequired) {
            showToast("กรุณากรอกชื่อโครงการและวันที่ต้องการ", 'error');
            return;
        }
        if (orderItems.length === 0) { 
            showToast("กรุณาเพิ่มรายการ", 'error');
            return; 
        }
        

        // ⭐ เริ่มการตรวจสอบ Validation รายละเอียด (ทำงานเฉพาะเมื่อกด "ส่งคำขอ" ไม่ใช่ "บันทึกร่าง")
        if (!isDraft) { 
            const targetProject = newOrderMeta.job;
            
            for (const item of orderItems) {
                
                // ------------------------------------------------------------------
// ✅ 1. ตรวจสอบ SubJob และ Mat. Code (แยกตามประเภท)
// ------------------------------------------------------------------

// กรณี 1: สั่งซื้อ (Local, HO) -> ต้องเลือกทั้ง 2 อย่าง
if (['Local', 'HO'].includes(newOrderMeta.type)) {
    if (!item.subJob || !item.matCode) { // ใช้ || (หรือ) คือขาดอย่างใดอย่างหนึ่งไม่ได้
        showToast(`รายการ "${item.name}" ต้องระบุทั้ง SubJob และ Mat. Code`, 'error');
        return; 
    }
}
// กรณี 2: เบิก (Withdraw) -> ต้องเลือกอย่างใดอย่างหนึ่ง (เหมือนเดิม)
else if (newOrderMeta.type === 'Withdraw') {
    if (!item.subJob && !item.matCode) { // ใช้ && (และ) คือว่างทั้งคู่ไม่ได้
        showToast(`รายการ "${item.name}" ต้องระบุ SubJob หรือ Mat. Code อย่างใดอย่างหนึ่ง`, 'error');
        return; 
    }
}

                // ------------------------------------------------------------------
                // ✅ 2. ตรวจสอบราคาต่อหน่วย (สำหรับ Local, HO) ต้องไม่เท่ากับ 0
                // ------------------------------------------------------------------
                if (['Local', 'HO'].includes(newOrderMeta.type)) {
                    // แปลงเป็นตัวเลขก่อนเช็ค เพื่อความชัวร์
                    const price = parseFloat(item.unitPrice);
                    if (!price || price <= 0) {
                        showToast(`รายการ "${item.name}" ต้องระบุราคาต่อหน่วย (ต้องมากกว่า 0)`, 'error');
                        return; // หยุดการทำงานทันที
                    }
                }

                // ------------------------------------------------------------------
                // (Logic เดิม) เช็คสต็อกสำหรับเบิก/ยืม
                // ------------------------------------------------------------------
                // 1. กรณีเบิก (Withdraw): เช็คของในคลังโครงการนั้น
                if (newOrderMeta.type === 'Withdraw') {
                    const stockItem = inventory.find(i => i.name === item.name && i.project === targetProject);
                    if (!stockItem) {
                        showToast(`ผิดพลาด: สินค้า "${item.name}" ไม่มีในโครงการ ${targetProject}`, 'error');
                        return; 
                    }
                    if (item.qty > stockItem.qty) {
                        showToast(`ผิดพลาด: สินค้า "${item.name}" มีไม่พอ (ขอ: ${item.qty}, มี: ${stockItem.qty})`, 'error');
                        return; 
                    }
                } 
                // 2. กรณียืม (Borrow): เช็คสถานะ Asset ID
                else if (newOrderMeta.type === 'Borrow') {
                    if (item.assetId) {
                        const assetItem = assets.find(a => a.id === item.assetId);
                        if (!assetItem) {
                            showToast(`ผิดพลาด: ไม่พบทรัพย์สินรหัส ${item.assetId}`, 'error');
                            return;
                        }
                        // เช็คว่าอยู่โครงการที่เลือกไหม (ถ้าต้องการบังคับข้ามโครงการต้องแก้ตรงนี้)
                        // ...
                        if (assetItem.status !== 'Available') {
                            showToast(`ผิดพลาด: ทรัพย์สิน "${item.name}" ไม่ว่าง (สถานะ: ${assetItem.status})`, 'error');
                            return;
                        }
                    }
                }
            }
        }

        setIsLoading(true);
        
        let attachmentData = newOrderMeta.attachment;
        let quotationData = newOrderMeta.quotation;
        
        try {
            // 1. อัปโหลดไฟล์แนบหลัก (Email / Quotation)
            if (uploadFiles.email) {
                const base64 = await fileToBase64(uploadFiles.email);
                const result = await new Promise((resolve, reject) => {
                    google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).uploadFileToDrive(base64, uploadFiles.email.name);
                });
                if (result.error) throw new Error(result.error);
                attachmentData = result;
            }
            
            if (uploadFiles.quotation) {
                const base64 = await fileToBase64(uploadFiles.quotation);
                const result = await new Promise((resolve, reject) => {
                    google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).uploadFileToDrive(base64, uploadFiles.quotation.name);
                });
                if (result.error) throw new Error(result.error);
                quotationData = result;
            }

            // 2. ⭐ อัปโหลดรูปภาพของสินค้าแต่ละรายการ (Item Images)
            const processedItems = await Promise.all(orderItems.map(async (item) => {
                let processedImages = [];
                
                // ถ้ามีรูปภาพในรายการนี้
                if (item.images && item.images.length > 0) {
                    // วนลูปอัปโหลดทีละรูป (หรือใช้ Promise.all ซ้อนก็ได้)
                    const itemImagePromises = item.images.map(imgObj => {
                        // ถ้าเป็นรูปที่เพิ่งเพิ่ม (มี file object หรือ base64) ให้เช็คและอัปโหลด
                        // (ใน Create Mode มักจะเป็นรูปใหม่ทั้งหมด)
                        if (imgObj.base64) {
                             return new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .uploadAssetImage(imgObj.base64, imgObj.name); // ใช้ Function เดียวกับ Asset ได้เลย
                            });
                        }
                        return Promise.resolve(imgObj); // กรณีเป็นรูปเก่า (ถ้ามี logic แก้ไข)
                    });

                    const uploadedResults = await Promise.all(itemImagePromises);
                    // แปลงผลลัพธ์ให้เหลือแค่ { name, url, type }
                    processedImages = uploadedResults.map(u => ({ name: u.name, type: 'image/jpeg', url: u.url }));
                }

                // คืนค่า Item พร้อมรูปภาพที่อัปโหลดแล้ว (URL)
                return { ...item, images: processedImages };
            }));

const generateNextReqId = () => {
            // กรองเฉพาะ ID ที่ขึ้นต้นด้วย REQ-
            const existingIds = requests
                .map(r => r.id)
                .filter(id => id && typeof id === 'string' && id.startsWith('REQ-'));

            if (existingIds.length === 0) return 'REQ-001';

            // หาเลขที่มากที่สุดในปัจจุบัน
            const maxNum = existingIds.reduce((max, id) => {
                // ลบคำว่า REQ- ออก แล้วแปลงเป็นตัวเลข
                const numPart = parseInt(id.replace(/^REQ-/, ''), 10);
                return !isNaN(numPart) && numPart > max ? numPart : max;
            }, 0);

            const nextNum = maxNum + 1;
            
            // ⭐ ใช้ padStart(3, '0') เพื่อให้ได้อย่างน้อย 3 หลัก (001, 010, 100)
            // ถ้าเกิน 3 หลัก (เช่น 1000) มันจะแสดงครบทุกหลักตามปกติ (REQ-1000)
            return `REQ-${String(nextNum).padStart(3, '0')}`;
        };
            // 3. สร้าง Order Object
            let nextStatus = 'Draft';
            let isFullFlow = false;
            const existingReq = editingId ? requests.find(r => r.id === editingId) : null;
            if (existingReq) isFullFlow = existingReq.isFullApprovalFlow || false;
            
            if (!isDraft) {
    // กรณี 1: เป็น HO และ "เคยผ่านการอนุมัติมาแล้ว" (คือเคส Local -> HO ที่ถูกส่งคืนแก้ไข)
    if (newOrderMeta.type === 'HO' && existingReq?.isPreviouslyApproved) {
        nextStatus = 'Pending Check'; // ✅ ส่งกลับไปให้ฝ่ายจัดซื้อตรวจสอบไฟล์ (ข้าม L1/L2)
    } 
    // กรณี 2: HO ปกติ (สร้างใหม่ หรือ Full Flow ปกติ)
    else if (newOrderMeta.type === 'HO') {
        nextStatus = isFullFlow ? 'Pending Head' : 'Pending Check';
    } 
    // กรณี 3: Local หรืออื่นๆ
    else {
        nextStatus = 'Pending Head';
    }
}
            
           // ... (ส่วนบนของฟังก์ชันเหมือนเดิม)

          const order = {
                id: editingId || generateNextReqId(),
                requester: `${user.firstName} ${user.lastName}`,
                status: nextStatus, // สถานะจะถูกคำนวณใหม่
                created: new Date().toISOString().split('T')[0],
                items: processedItems, 
                ...newOrderMeta,
                attachment: attachmentData,
                quotation: quotationData,
                docNumber: existingReq?.docNumber || null,
                isFullApprovalFlow: isFullFlow,
                isPreviouslyApproved: existingReq?.isPreviouslyApproved || false,
                history: [
                    ...(existingReq?.history || []),
                    createLog(
                        isDraft ? 'บันทึกแบบร่าง' : (editingId ? 'แก้ไขข้อมูล (Edit Data)' : 'สร้างคำขอ'),
                        `${user.empId} ${user.firstName} ${user.lastName}`,
                        isFullFlow ? 'Submit (Full Flow)' : 'Submit'
                    )
                ],
                comments: existingReq?.comments || []
            };

            // 1. อัปเดตรายการใน State หลัก (Requests)
            setRequests(prev => editingId ? prev.map(r => r.id === editingId ? order : r) : [order, ...prev]);
            
            // 2. อัปเดตหน้าต่างรายละเอียด/ประวัติ (Detail Modal) ถ้าเปิดอยู่
            if (selectedRequest && selectedRequest.id === order.id) {
                setSelectedRequest(order);
            }

            // ⭐ 3. [เพิ่มใหม่] อัปเดตหน้าตรวจสอบเอกสาร (Verification Modal) ถ้าเปิดอยู่
            if (showVerificationModal && verificationData.requestId === order.id) {
                const hasQuotation = !!order.quotation; // เช็คว่ามีไฟล์ใบเสนอราคาไหม
                const hasEmail = !!order.attachment;    // เช็คว่ามีไฟล์เมลอนุมัติไหม

                setVerificationData(prev => ({
                    ...prev,
                    // อัปเดตสถานะไฟล์ในหน้าตรวจสอบทันที
                    filesExist: {
                        quotation: hasQuotation,
                        email: hasEmail
                    },
                    // (Optional) สั่งให้ติ๊กถูกอัตโนมัติถ้าไฟล์มาแล้ว
                    checks: {
                        ...prev.checks,
                        quotation: hasQuotation ? true : prev.checks.quotation,
                        email: hasEmail ? true : prev.checks.email
                    }
                }));
            }

            saveRequestToSheet(order);
            setIsLoading(false);
            showToast(isDraft ? 'บันทึกแบบร่างแล้ว' : (editingId ? 'บันทึกการแก้ไขเรียบร้อย' : 'ส่งคำขอเรียบร้อย'));
            setUploadFiles({ email: null, quotation: null });
            
            // ปิดเฉพาะหน้าต่าง Create/Edit (หน้า Verification จะยังเปิดอยู่และข้อมูลอัปเดตแล้ว)
            handleCloseCreateModal();

        } catch (err) {
            console.error("Create Order Error:", err);
            showToast("เกิดข้อผิดพลาด: " + err.message, 'error');
            setIsLoading(false);
        }
      };

const handleRefresh = () => {
    setIsLoading(true);
    setIsError(false); // Reset Error
    
    google.script.run
        .withSuccessHandler((data) => {
            if(data.requests) setRequests(data.requests);
            if(data.inventory) setInventory(data.inventory);
            if(data.assets) setAssets(data.assets);
            if(data.projects) setProjects(data.projects);
            if(data.users) setAllUsers(data.users);
            
            // (Optional: โหลด Logs ใหม่ด้วยก็ได้ถ้าต้องการ)
            
            setIsLoading(false);
            showToast('รีเฟรชข้อมูลล่าสุดเรียบร้อย');
        })
        .withFailureHandler((error) => { // ⭐ เพิ่ม Failure Handler
            setIsLoading(false);
            showToast('รีเฟรชล้มเหลว: ' + error.message, 'error');
            // ไม่ต้อง setIsError(true) ก็ได้ถ้าอยากให้ user ทำงานต่อในหน้าเดิม
        })
        .loadInitialData();
};

// --- LOGIC: New User Count (นับผู้ใช้ใหม่) ---
const newUsersCount = useMemo(() => {
    if (!allUsers) return 0;
    return allUsers.filter(u => u.status === 'New').length;
}, [allUsers]);

const myPendingCount = useMemo(() => {
          if (!user || !requests) return 0;
          const myName = `${user.firstName} ${user.lastName}`;

          return requests.filter(req => {
              if (globalProjectFilter !== 'All' && req.job !== globalProjectFilter) return false;
              if (['Completed', 'Rejected', 'Returned'].includes(req.status)) return false;

              const isMine = req.requester === myName || req.requester === 'Current User';
              
              let canAct = false;
              // ⭐ [แก้ไข] Logic เช็คสิทธิ์ Pending Head
              if (req.status === 'Pending Head') {
                  // ถ้าเป็น เบิก/ยืม -> ได้ทั้ง Level 1 (8) และ Level 2 (9)
                  if ((req.type === 'Withdraw' || req.type === 'Borrow') && (hasPermission(8) || hasPermission(9))) {
                      canAct = true;
                  }
                  // ถ้าเป็น ซื้อ -> เฉพาะ Level 1 (8) เหมือนเดิม
                  else if (['Local', 'HO'].includes(req.type) && hasPermission(8)) {
                      canAct = true;
                  }
              }

              if (hasPermission(9) && req.status === 'Pending PM') canAct = true;
              if (hasPermission(10) && req.status === 'Pending Check') canAct = true;
              if (hasPermission(11) && req.status === 'Approved' && req.purchaseType === 'Buy') canAct = true;
              if (hasPermission(12) && req.type === 'HO' && req.status === 'PR Issued') canAct = true;
              if (hasPermission(12) && req.type === 'Local' && req.status === 'Approved') canAct = true;
              if (hasPermission(13) && req.type === 'HO' && (req.status === 'PO Issued' || req.status === 'Contract Signed')) canAct = true;
              if (hasPermission(14) && req.type === 'HO' && req.status === 'Contract Pending') canAct = true;
              if (hasPermission(15) && req.type === 'Local' && (req.status === 'Ordered' || req.status === 'Partially Received')) canAct = true;
              if (hasPermission(15) && req.type === 'HO' && (req.status === 'Shipping' || req.status === 'Partially Received')) canAct = true;
              if (hasPermission(24) && (req.type === 'Withdraw' || req.type === 'Borrow') && req.status === 'Ready to Disburse') canAct = true;

              // Admin เห็นทั้งหมดที่ค้าง
              if (user.isSuperAdmin) return true;

              return isMine || canAct;
          }).length;
      }, [requests, user, globalProjectFilter]);


useEffect(() => {
        google.script.run.withSuccessHandler((data) => {
            if (data && data.length > 0) {
                setPublicAnnounces(data);
                setShowPublicAnnounce(true); // เปิด Popup ทันทีถ้ามีประกาศ Active
            }
        }).getPublicAnnouncements();
    }, []);
      
      useEffect(() => {
        setIsLoading(true);
        google.script.run.withSuccessHandler((data) => {
           if(data.requests) setRequests(data.requests);
           if(data.inventory) setInventory(data.inventory);
           if(data.assets) setAssets(data.assets);
           if(data.logs) setInvLogs(data.logs);
           if(data.projects) setProjects(data.projects);
           if(data.users) setAllUsers(data.users);
           
           if (data.announcement && data.announcement.active) {
               setAnnouncement(data.announcement);
               setAnnounceForm({ title: data.announcement.title, detail: data.announcement.detail });
           } else {
               setAnnouncement(null);
               setAnnounceForm({ title: '', detail: '' });
           }

           setIsLoading(false);
        }).loadInitialData();
      }, []);

useEffect(() => {
  setIsLoading(true);
  setIsError(false); // Reset Error ก่อนโหลด

  google.script.run
    .withSuccessHandler((data) => {
        // ... (โค้ดเดิมที่ setRequests, setInventory ฯลฯ) ...
        if(data.requests) setRequests(data.requests);
        if(data.inventory) setInventory(data.inventory);
        if(data.assets) setAssets(data.assets);
        if(data.projects) setProjects(data.projects);
        if(data.users) setAllUsers(data.users);
        
        if (data.announcement && data.announcement.active) {
            setAnnouncement(data.announcement);
            setAnnounceForm({ title: data.announcement.title, detail: data.announcement.detail });
        } else {
            setAnnouncement(null);
            setAnnounceForm({ title: '', detail: '' });
        }

        setIsLoading(false);
        
        // โหลด Logs ตามหลัง (เหมือนเดิม)
        google.script.run.withSuccessHandler((logs) => {
            if(logs && logs.length > 0) setInvLogs(logs);
        }).getRecentLogs(100);
    })
    .withFailureHandler((error) => { // ⭐ เพิ่มส่วนนี้: เมื่อโหลดพัง
        console.error(error);
        setIsLoading(false);
        setIsError(true);
        setErrorMessage(error.message || "ไม่สามารถเชื่อมต่อกับ Server ได้");
    })
    .loadInitialData();
}, []);


      // State from original file
      const [assetTabMode, setAssetTabMode] = useState('Company');
      const [dashboardView, setDashboardView] = useState('Purchase');
      const [dashboardSearch, setDashboardSearch] = useState('');
      const [dashboardStatusFilter, setDashboardStatusFilter] = useState('All');
      const [searchQuery, setSearchQuery] = useState('');
      const [invSearch, setInvSearch] = useState('');
      const [assetSearch, setAssetSearch] = useState('');
      const [historySearch, setHistorySearch] = useState('');
      const [historyFilterItem, setHistoryFilterItem] = useState(null);
      const [invSort, setInvSort] = useState({ key: 'id', direction: 'asc' });
      const [assetSort, setAssetSort] = useState({ key: 'id', direction: 'asc' });
      const [statusFilter, setStatusFilter] = useState('All');
      const [typeFilter, setTypeFilter] = useState('All');
      
      // Modals
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [showDetailModal, setShowDetailModal] = useState(false);
      const [showPRModal, setShowPRModal] = useState(false);
      const [showPOModal, setShowPOModal] = useState(false);
      const [notification, setNotification] = useState(null);
      const [showReceiveGoodsModal, setShowReceiveGoodsModal] = useState(false);
      const [showDisburseModal, setShowDisburseModal] = useState(false);
      const [showRejectModal, setShowRejectModal] = useState(false);
      const [showItemDetailModal, setShowItemDetailModal] = useState(false);
      const [showPOPreviewModal, setShowPOPreviewModal] = useState(false);
      const [showSelectionModal, setShowSelectionModal] = useState(false);
      const [expandedItems, setExpandedItems] = useState(new Set());
      const [isForceClose, setIsForceClose] = useState(false);
const [isCostEditMode, setIsCostEditMode] = useState(false);
      const [tempCostRequest, setTempCostRequest] = useState(null);

      // --- STATE: Who can act modal ---
const [showActorModal, setShowActorModal] = useState(false);
const [actorList, setActorList] = useState({ title: '', status: '', users: [] });

// --- Helper: ค้นหาคนที่มีสิทธิ์ในสถานะปัจจุบัน ---
const handleShowActors = (req) => {
    let permId = null;
    let title = 'ผู้มีสิทธิ์ดำเนินการ';

    // กำหนดสิทธิ์ที่ต้องใช้ตามสถานะ
    switch (req.status) {
        case 'Pending Head': permId = 8; title = 'รออนุมัติ Level 1'; break;
        case 'Pending PM': permId = 9; title = 'รออนุมัติ Level 2'; break;
        case 'Pending Check': permId = 10; title = 'รอตรวจสอบเอกสาร'; break;
        case 'Approved': 
            if (req.type === 'Local') { permId = 12; title = 'รอสั่งซื้อ (Local)'; }
            else if (req.type === 'HO' && req.purchaseType === 'Buy') { permId = 11; title = 'รอออก PR'; }
            else { permId = 14; title = 'รอทำสัญญา/ดำเนินการ'; } // HO Rent
            break;
        case 'PR Issued': permId = 12; title = 'รอออก PO'; break;
        case 'PO Issued': permId = 13; title = 'รออัปเดตการส่งของ'; break;
        case 'Ordered': permId = 15; title = 'รอรับของ (Local)'; break;
        case 'Shipping': permId = 15; title = 'รอรับของ (HO)'; break;
        case 'Ready to Disburse': permId = 24; title = 'รอจ่ายของ (Store)'; break;
        case 'Contract Pending': permId = 14; title = 'รอทำสัญญา'; break;
        case 'Contract Signed': permId = 13; title = 'รอส่งมอบ'; break;
        default: 
            showToast('สถานะนี้ไม่มีผู้ดำเนินการต่อ (จบกระบวนการ/รอผู้ขอแก้ไข)', 'info');
            return;
    }

    // กรองรายชื่อ User ที่มีสิทธิ์นี้ในโครงการนี้
    const validUsers = allUsers.filter(u => {
        if (u.status !== 'Activated') return false;
        if (u.isSuperAdmin) return true;
        
        const perms = u.permissions?.[req.job] || [];
        return perms.includes(2) || perms.includes(permId); // Admin(2) หรือมีสิทธิ์เฉพาะ
    });

    setActorList({
        title: title,
        status: req.status,
        users: validUsers
    });
    setShowActorModal(true);
};

// --- Helper: ดึงข้อมูลผู้มีสิทธิ์ (Updated: รองรับหลายสิทธิ์) ---
    const getActorData = (req, allUsers) => {
        let permIds = []; // ⭐ เปลี่ยนเป็น Array เพื่อเก็บได้หลายสิทธิ์
        let title = '';

        switch (req.status) {
            case 'Pending Head': 
                title = 'รออนุมัติ Level 1'; 
                // ⭐ แก้ไข: กรณีเบิก/ยืม ให้ทั้ง L1(8) และ L2(9) มีสิทธิ์อนุมัติ
                if (req.type === 'Withdraw' || req.type === 'Borrow') {
                    permIds = [8, 9]; 
                } else {
                    permIds = [8];
                }
                break;
            case 'Pending PM': 
                title = 'รออนุมัติ Level 2'; 
                permIds = [9]; 
                break;
            case 'Pending Check': 
                title = 'รอตรวจสอบเอกสาร'; 
                permIds = [10]; 
                break;
            case 'Approved': 
                if (req.type === 'Local') { permIds = [12]; title = 'รอสั่งซื้อ (Local)'; }
                else if (req.type === 'HO' && req.purchaseType === 'Buy') { permIds = [11]; title = 'รอออก PR'; }
                else { permIds = [14, 13]; title = 'รอทำสัญญา/ดำเนินการ'; } // รวมสิทธิ์สัญญา(14) และส่งของ(13) เผื่อกรณีข้ามขั้นตอน
                break;
            case 'PR Issued': permIds = [12]; title = 'รอออก PO'; break;
            case 'PO Issued': permIds = [13]; title = 'รออัปเดตการส่งของ'; break;
            case 'Ordered': permIds = [15]; title = 'รอรับของ (Local)'; break;
            case 'Shipping': permIds = [15]; title = 'รอรับของ (HO)'; break;
            case 'Ready to Disburse': permIds = [24]; title = 'รอจ่ายของ (Store)'; break;
            case 'Contract Pending': permIds = [14]; title = 'รอทำสัญญา'; break;
            case 'Contract Signed': permIds = [13]; title = 'รอส่งมอบ'; break;
            default: return null;
        }

        // กรอง User ทั้งหมดที่มีสิทธิ์
        const validUsers = allUsers.filter(u => {
            if (u.status !== 'Activated') return false;
            if (u.isSuperAdmin) return true; // ⭐ Super Admin เห็นเสมอ

            const perms = u.permissions?.[req.job] || [];
            
            // ⭐ ตรวจสอบ: เป็น Admin ของโปรเจกต์ (2) หรือ มีสิทธิ์ใดสิทธิ์หนึ่งใน permIds
            const isProjectAdmin = perms.includes(2);
            const hasSpecificRight = permIds.some(id => perms.includes(id));

            return isProjectAdmin || hasSpecificRight;
        });

        return { title, users: validUsers };
    };

    // --- Component: Tooltip แสดงผู้มีสิทธิ์ ---
    const StatusWithTooltip = ({ request, allUsers, children }) => {
        const [isVisible, setIsVisible] = useState(false);
        const [isLocked, setIsLocked] = useState(false); // สถานะคลิกเพื่อค้างไว้
        const [actorData, setActorData] = useState(null);

        useEffect(() => {
            if (isVisible || isLocked) {
                setActorData(getActorData(request, allUsers));
            }
        }, [isVisible, isLocked, request, allUsers]);

        return (
            <div 
                className="relative inline-block"
                onMouseEnter={() => setIsVisible(true)}
                onMouseLeave={() => !isLocked && setIsVisible(false)}
            >
                {/* ตัว Badge เดิม */}
                <div 
                    onClick={(e) => {
                        e.stopPropagation(); // กันไม่ให้เปิดหน้ารายละเอียด
                        setIsLocked(!isLocked); // สลับสถานะล็อค
                    }}
                    className="cursor-pointer"
                >
                    {children}
                </div>

                {/* ส่วน Tooltip Popup */}
                {(isVisible || isLocked) && actorData && actorData.users.length > 0 && (
                    <div className="absolute right-0 top-full mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-200 z-50 animate-in fade-in slide-in-from-top-2 overflow-hidden">
                        {/* หัวข้อ */}
                        <div className="bg-slate-50 px-3 py-2 border-b border-gray-100 flex justify-between items-center">
                            <div>
                                <p className="text-[10px] font-bold text-gray-500">ขั้นตอนปัจจุบัน</p>
                                <p className="text-xs font-bold text-blue-700">{actorData.title}</p>
                            </div>
                            {isLocked && <span className="text-[9px] bg-red-100 text-red-600 px-1.5 rounded border border-red-200">Pin</span>}
                        </div>
                        
                        {/* รายชื่อ */}
                        <div className="max-h-48 overflow-y-auto p-1 custom-scrollbar">
                            {actorData.users.map((u, i) => (
                                <div key={i} className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded transition-colors">
                                    <div className="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-[10px] font-bold text-gray-600">
                                        {u.firstName?.charAt(0)}
                                    </div>
                                    <div className="overflow-hidden">
                                        <p className="text-xs font-bold text-gray-800 truncate">{u.firstName} {u.lastName}</p>
                                        <p className="text-[9px] text-gray-400">{u.empId} {u.role === 'Admin' ? '(Admin)' : ''}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        );
    };

      const [expandedChart, setExpandedChart] = useState(null);
      const [drillDownState, setDrillDownState] = useState({ SubJob: null, matCode: null });
      
      // Verification Modal State
      const [showVerificationModal, setShowVerificationModal] = useState(false);
const [verificationData, setVerificationData] = useState({
    requestId: null,
    checks: { quotation: true, email: true, details: true },
    filesExist: { quotation: false, email: false },
    needApproval: false,
    needContract: true,
    note: '',
    isChangeMode: false // ⭐ เพิ่มตัวนี้
});
      const [viewingItem, setViewingItem] = useState(null);
      const [previewImage, setPreviewImage] = useState(null); 

      // Inventory/Asset Management Modals
      const [showAddInvModal, setShowAddInvModal] = useState(false);
      const [showEditInvModal, setShowEditInvModal] = useState(false);
      const [showAssetModal, setShowAssetModal] = useState(false);
      const [showEditAssetModal, setShowEditAssetModal] = useState(false);
      const [showReturnAssetModal, setShowReturnAssetModal] = useState(false);
      const [editingStockItem, setEditingStockItem] = useState(null);
      const [editingAssetItem, setEditingAssetItem] = useState(null);
      const [returnAssetData, setReturnAssetData] = useState({ id: '', condition: 'Good', note: '', images: [] });
      const [disburseData, setDisburseData] = useState({ requestId: null, note: '', images: [] });
      const [rejectData, setRejectData] = useState({ requestId: null, reason: '' });
      const [newStockItem, setNewStockItem] = useState({ name: '', qty: 0, unit: 'ชิ้น', minStock: 0, price: 0, images: [] });
      // --- STATE: Asset Management (Updated) ---
      const [newAssetItem, setNewAssetItem] = useState({ 
          id: '', 
          isAutoId: false, 
          name: '', 
          serial: '', 
          status: 'Available', 
          condition: 'Good', 
          ownerType: '', // ⭐ แก้เป็นค่าว่าง เพื่อบังคับเลือก
          price: 0, 
          rentalPrice: 0, 
          rentalUnit: 'Month', 
          images: [] 
      });
      
      // Form Data
      const [selectedRequest, setSelectedRequest] = useState(null);
      const [receiveItems, setReceiveItems] = useState([]);
      const [editingId, setEditingId] = useState(null);
      const [newOrderMeta, setNewOrderMeta] = useState({ type: 'Local', purchaseType: 'Buy', job: '', dateRequired: '', priority: 'Normal', attachment: null, quotation: null });
      // แก้ไขบรรทัดนี้
const [tempItem, setTempItem] = useState({ name: '', qty: 1, unitPrice: 0, unit: 'ชิ้น', subJob: '', matCode: '', note: '', images: [], assetId: '', serial: '', duration: 1 });
      const [orderItems, setOrderItems] = useState([]);
      
      const [showSuggestions, setShowSuggestions] = useState(false);
      const [suggestions, setSuggestions] = useState([]);
      const [stockSuggestion, setStockSuggestion] = useState(null);
      const [foundSuggestions, setFoundSuggestions] = useState([]);
      const [selectionSearch, setSelectionSearch] = useState('');

      const [prData, setPrData] = useState({ requestId: null, file: null, prNumber: '' });
      const [poData, setPoData] = useState({ requestId: null, file: null, poNumber: '' });
      const [showContractModal, setShowContractModal] = useState(false);
const [contractData, setContractData] = useState({ requestId: null, file: null });

const [historySort, setHistorySort] = useState({ key: 'date', direction: 'desc' });
      const [historyActionFilter, setHistoryActionFilter] = useState('All');

      // --- HELPER: Parse Thai Date String to Date Object ---
      const parseThaiDate = (dateStr) => {
          if (!dateStr) return null;
          // สมมติ format "10/1/2567 14:30:00" หรือ "10/1/2567"
          try {
              const parts = dateStr.split(' ')[0].split('/');
              if (parts.length === 3) {
                  const day = parseInt(parts[0]);
                  const month = parseInt(parts[1]) - 1;
                  const year = parseInt(parts[2]) - 543; // แปลง พ.ศ. -> ค.ศ.
                  return new Date(year, month, day);
              }
          } catch (e) { return null; }
          return null;
      };


const handleSaveAnnouncement = () => {
          if(!announceForm.title || !announceForm.detail) { showToast('กรุณาระบุหัวข้อและรายละเอียด', 'error'); return; }
          setIsLoading(true);
          
          const payload = {
              id: 'ANNOUNCEMENT',
              active: true,
              title: announceForm.title,
              detail: announceForm.detail,
              date: new Date().toLocaleString('th-TH'),
              updatedBy: user ? `${user.firstName} ${user.lastName}` : 'System'
          };

          google.script.run.withSuccessHandler((res) => {
              setIsLoading(false);
              setAnnouncement(payload);
              showToast(res.message);
          }).saveSystemAnnouncement(payload);
      };

      // ⭐ ฟังก์ชันยกเลิกประกาศ (Admin)
      const handleClearAnnouncement = () => {
          if(!confirm('ต้องการยกเลิกประกาศใช่หรือไม่?')) return;
          setIsLoading(true);
          google.script.run.withSuccessHandler((res) => {
              setIsLoading(false);
              setAnnouncement(null);
              setAnnounceForm({ title: '', detail: '' });
              showToast(res.message);
          }).clearSystemAnnouncement();
      };

// --- LOGIC: COST EDITING (UPDATED FOR ASSETS) ---
      const handleStartCostEdit = () => {
          const clone = JSON.parse(JSON.stringify(selectedRequest));
          // ⭐ Snapshot Assets related to this request (ดึงทรัพย์สินที่เกี่ยวข้องมาเก็บไว้แก้ไข)
          const relatedAssets = assets.filter(a => a.currentRequestId === selectedRequest.id);
          clone.tempAssets = JSON.parse(JSON.stringify(relatedAssets));
          
          setTempCostRequest(clone);
          setIsCostEditMode(true);
      };

      const handleCancelCostEdit = () => {
          setTempCostRequest(null);
          setIsCostEditMode(false);
      };

      const handleSaveCostEdit = async () => {
          if (!tempCostRequest) return;
          setIsLoading(true);
          try {
              const changes = [];
              const oldReq = selectedRequest;
              const newReq = tempCostRequest;
              const userSignature = `${user.empId} ${user.firstName} ${user.lastName}`;

              // 1. ตรวจสอบการเปลี่ยนแปลงของ Request (SubJob, MatCode, Inventory Logs)
              newReq.items.forEach((newItem, idx) => {
                  const oldItem = oldReq.items[idx];
                  if (newItem.subJob !== oldItem.subJob) changes.push(`${newItem.name}: SubJob (${oldItem.subJob || '-'} -> ${newItem.subJob})`);
                  if (newItem.matCode !== oldItem.matCode) changes.push(`${newItem.name}: Mat. (${oldItem.matCode || '-'} -> ${newItem.matCode})`);

                  // Check Inventory Logs
                  if (newItem.receivedLog && newItem.receivedLog.length > 0) {
                      newItem.receivedLog.forEach((newLog, logIdx) => {
                          const oldLog = oldItem.receivedLog?.[logIdx];
                          if (oldLog && newLog.price !== oldLog.price) {
                              changes.push(`${newItem.name} (Lot ${logIdx + 1}): Price (${oldLog.price.toLocaleString()} -> ${newLog.price.toLocaleString()})`);
                          }
                      });
                  }
              });

              // 2. ⭐ ตรวจสอบการเปลี่ยนแปลงของ Assets (เพิ่มใหม่)
              if (newReq.tempAssets && newReq.tempAssets.length > 0) {
                  for (const newAsset of newReq.tempAssets) {
                      const oldAsset = assets.find(a => a.id === newAsset.id);
                      if (!oldAsset) continue;

                      let assetChanged = false;
                      let assetChanges = [];

                      // Check Price (Buy/Rent)
                      if (newAsset.price !== oldAsset.price) { assetChanges.push(`Price: ${oldAsset.price} -> ${newAsset.price}`); assetChanged = true; }
                      if (newAsset.rentalPrice !== oldAsset.rentalPrice) { assetChanges.push(`Rent Price: ${oldAsset.rentalPrice} -> ${newAsset.rentalPrice}`); assetChanged = true; }
                      // Check Duration & Unit
                      if (newAsset.duration !== oldAsset.duration) { assetChanges.push(`Duration: ${oldAsset.duration} -> ${newAsset.duration}`); assetChanged = true; }
                      if (newAsset.rentalUnit !== oldAsset.rentalUnit) { assetChanges.push(`Unit: ${oldAsset.rentalUnit} -> ${newAsset.rentalUnit}`); assetChanged = true; }

                      if (assetChanged) {
                          // Sync Asset to Server
                          await saveAssetToSheet(newAsset); 
                          // Update Global State
                          setAssets(prev => prev.map(a => a.id === newAsset.id ? newAsset : a));
                          
                          changes.push(`${newAsset.id}: ${assetChanges.join(', ')}`);
                          // Log for Asset
                          await addInvLog('Edit Asset Cost', newAsset.name, 'Edit', `แก้ไข Cost/Term: ${assetChanges.join(', ')}`, [], selectedRequest.id, newAsset.id);
                      }
                  }
              }

              if (changes.length === 0) {
                  showToast('ไม่มีข้อมูลเปลี่ยนแปลง', 'info');
                  setIsCostEditMode(false);
                  setIsLoading(false);
                  return;
              }

              // 3. บันทึกข้อมูล Request และประวัติ
              const logNote = `แก้ไขข้อมูล Cost/Code/Assets:\n- ${changes.join('\n- ')}`;
              const { tempAssets, ...reqToSave } = newReq; // เอา tempAssets ออกก่อนบันทึก Request
              
              const updatedReq = {
                  ...reqToSave,
                  history: [...newReq.history, createLog('Edit Cost', userSignature, logNote)]
              };
              
              saveRequestToSheet(updatedReq); // Sync Request
              setRequests(prev => prev.map(r => r.id === updatedReq.id ? updatedReq : r));
              setSelectedRequest(updatedReq);
              
              setIsCostEditMode(false);
              setTempCostRequest(null);
              showToast('บันทึกการแก้ไขเรียบร้อย');

          } catch (err) {
              console.error(err);
              showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
          } finally {
              setIsLoading(false);
          }
      };

// --- LOGIC: IMPORT ASSETS (CSV) - SMART PARSER ---
const handleFileImport = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    setImportFileName(file.name);
    const reader = new FileReader();
    
    reader.onload = (event) => {
        const text = event.target.result;
        const rows = text.split('\n').map(row => row.split(','));
        
        // --- Helper Functions ---
        // 1. แปลงประเภท (Type)
        const mapType = (val) => {
            if (!val) return 'Company';
            const v = val.trim();
            if (v === 'เช่า' || v.toLowerCase() === 'rent') return 'Rent';
            return 'Company'; // Default 'บริษัท'
        };

        // 2. แปลงสถานะ (Status)
        const mapStatus = (val) => {
            if (!val) return 'Available';
            const v = val.trim();
            if (v === 'ถูกยืม' || v.toLowerCase() === 'borrowed') return 'Borrowed';
            if (v === 'สูญหาย' || v.toLowerCase() === 'lost') return 'Lost';
            if (v === 'ชำรุด' || v.toLowerCase() === 'damaged') return 'Damaged';
            return 'Available'; // Default 'ว่าง'
        };

        // 3. แปลงหน่วยนับ (Unit)
        const mapUnit = (u, type) => {
            if (!u) return type === 'Rent' ? 'Month' : 'baht';
            const val = u.trim();
            if (val.includes('วัน') || val.toLowerCase().includes('day')) return 'Day';
            if (val.includes('ปี') || val.toLowerCase().includes('year')) return 'Year';
            if (val.includes('เดือน') || val.toLowerCase().includes('month')) return 'Month';
            return 'baht';
        };

        // ⭐ 4. แปลงวันที่ (Format Date) - เพิ่มส่วนนี้กลับเข้ามา
        const formatDate = (d) => {
            if (!d) return null;
            const val = d.trim();
            if (val === '') return null;
            if (val.match(/^\d{4}-\d{2}-\d{2}$/)) return val; // ถ้าเป็น YYYY-MM-DD อยู่แล้ว
            if (val.includes('/')) { 
                const parts = val.split('/');
                if (parts.length === 3) {
                    let [day, month, year] = parts;
                    let y = parseInt(year);
                    if (y > 2400) y -= 543; // แปลง พ.ศ. เป็น ค.ศ.
                    return `${y}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
                }
            }
            return val;
        };

        // --- Process Data ---
        const data = rows.slice(1).filter(row => row.length > 1 && row[1]?.trim() !== '').map((row, index) => {
            const type = mapType(row[3]);
            const status = mapStatus(row[8]);
            
            return {
                tempId: index,
                id: row[0]?.trim() || '',           
                name: row[1]?.trim() || '',         
                serial: row[2]?.trim() || '',       
                ownerType: type,
                price: parseFloat(row[4]?.trim()) || 0, 
                rentalUnit: mapUnit(row[5], type),   
                rentalStart: formatDate(row[6]),  // เรียกใช้ formatDate ตรงนี้
                rentalEnd: formatDate(row[7]),    // และตรงนี้
                status: status, 
                holder: row[9]?.trim() || '-',      
                note: row[10]?.trim() || '',
                project: row[11]?.trim() || '' 
            };
        });
        
        setImportData(data);
    };
    reader.readAsText(file);
};

// --- LOGIC: CONFIRM IMPORT ASSETS (BATCH + CHUNKING VERSION) ---
const confirmImportAssets = async () => {
    if (importData.length === 0) return;

    // 1. Validation Loop (ตรวจสอบข้อมูลเหมือนเดิม)
    for (let i = 0; i < importData.length; i++) {
        const item = importData[i];
        const line = i + 1;

        if (!item.name) { showToast(`รายการที่ ${line}: ขาดชื่อรายการ`, 'error'); return; }
        if (!item.serial) { showToast(`รายการที่ ${line}: ขาด Serial No.`, 'error'); return; }
        // ... (Validation อื่นๆ คงเดิม) ...
        
        // เช็ค ID ซ้ำในระบบ
        if (item.id && assets.some(a => a.id === item.id)) {
            showToast(`รายการที่ ${line}: รหัสทรัพย์สิน "${item.id}" มีอยู่ในระบบแล้ว`, 'error'); return;
        }
    }

    // เริ่มขั้นตอนการเตรียมข้อมูล
    setIsLoading(true); // หมุน Loading
    const date = new Date().toLocaleString('th-TH');
    
    // เตรียมตัวแปรสำหรับ Batch
    const newAssets = [];
    const batchLogs = [];
    let currentRunNo = assets.length; 
    
    // 2. Process Data (เตรียมข้อมูลใส่ Array ใหญ่ไว้ก่อน)
    for (const item of importData) {
        let finalId = item.id;
        
        // Auto Gen ID Logic
        if (!finalId) {
            currentRunNo++;
            const prefix = item.ownerType === 'Rent' ? 'AST-R' : 'AST-C';
            const runNo = String(currentRunNo).padStart(3, '0');
            finalId = `${prefix}-${new Date().getFullYear().toString().slice(-2)}${(new Date().getMonth()+1).toString().padStart(2,'0')}-${runNo}`;
            
            while (assets.some(a => a.id === finalId) || newAssets.some(a => a.id === finalId)) {
                currentRunNo++;
                const nextRunNo = String(currentRunNo).padStart(3, '0');
                finalId = `${prefix}-${new Date().getFullYear().toString().slice(-2)}${(new Date().getMonth()+1).toString().padStart(2,'0')}-${nextRunNo}`;
            }
        }

        const newAsset = {
            id: finalId,
            name: item.name,
            serial: item.serial,
            ownerType: item.ownerType,
            status: item.status,
            price: item.ownerType === 'Company' ? item.price : 0,
            rentalPrice: item.ownerType === 'Rent' ? item.price : 0,
            rentalUnit: item.rentalUnit, 
            rentalStart: item.rentalStart || null,
            rentalEnd: item.rentalEnd || null,
            condition: 'Good',
            holder: item.holder,
            currentRequestId: null,
            lastUpdated: date,
            image: null,
            note: item.note,
            project: item.project 
        };

        newAssets.push(newAsset);
        
        const logNote = item.note ? `(Note: ${item.note})` : '';
        batchLogs.push({
            date: date,
            action: 'Import Assets',
            item: newAsset.name,
            change: 'New',
            note: `นำเข้าข้อมูล CSV เข้าโครงการ ${item.project} ${logNote}`,
            images: [],
            requestId: null,
            assetId: newAsset.id,
            by: `${user.empId} ${user.firstName}`
        });
    }

    // ⭐⭐ 3. เริ่มส่งข้อมูลแบบแบ่งส่วน (Chunking Logic) ⭐⭐
    const CHUNK_SIZE = 100; // กำหนดขนาดก้อนข้อมูล เช่น ส่งทีละ 100 รายการ
    const totalChunks = Math.ceil(newAssets.length / CHUNK_SIZE);

    try {
        for (let i = 0; i < newAssets.length; i += CHUNK_SIZE) {
            // ตัดแบ่งข้อมูล
            const chunkAssets = newAssets.slice(i, i + CHUNK_SIZE);
            const chunkLogs = batchLogs.slice(i, i + CHUNK_SIZE);
            
            // คำนวณเลขชุดปัจจุบันเพื่อแสดงผล
            const currentChunk = Math.floor(i / CHUNK_SIZE) + 1;
            
            // (Optional) แสดง Toast บอกความคืบหน้า เพื่อให้ User รู้ว่าไม่ได้ค้าง
            showToast(`กำลังบันทึกชุดที่ ${currentChunk}/${totalChunks} (${chunkAssets.length} รายการ)...`, 'info');

            // ส่งก้อนนี้ไปบันทึก
            await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler((err) => reject(new Error(`Batch ${currentChunk} failed: ${err.message}`)))
                    .batchImportAssets(chunkAssets, chunkLogs); // เรียกฟังก์ชัน backend ตัวใหม่
            });
        }

        // 4. เมื่อวนลูปครบทุกก้อนแล้วค่อยอัปเดตหน้าจอทีเดียว
        setAssets(prev => [...prev, ...newAssets]);
        
        setIsLoading(false);
        setShowImportAssetModal(false);
        setImportData([]);
        setImportFileName('');
        showToast(`นำเข้าสำเร็จทั้งหมด ${newAssets.length} รายการ`);

    } catch (error) {
        setIsLoading(false);
        console.error(error);
        showToast("เกิดข้อผิดพลาดในการบันทึก: " + error.message, 'error');
        // หมายเหตุ: กรณี Error กลางคัน รายการก่อนหน้านี้อาจถูกบันทึกไปแล้ว (Partial Success)
    }
};

// คำนวณจำนวนงานที่ค้าง (สำหรับ Sidebar)
      const pendingOrdersCount = useMemo(() => {
         if (!filteredRequests) return 0;
         return filteredRequests.filter(r => !['Completed', 'Rejected', 'Returned', 'Draft'].includes(r.status)).length;
      }, [filteredRequests]);



const filteredLogs = useMemo(() => {
        let data = invLogs;

        // 0. ถ้าเป็นการดูประวัติรวม (ไม่ได้เจาะจง Item) ให้ตัดเรื่อง User/Permission ออก
        if (!viewingItem) {
            const excludeActions = ['Edit Permissions', 'Edit Profile', 'Edit User Status', 'Register', 'Change Password'];
            data = data.filter(l => !excludeActions.includes(l.action));
        }

       if (globalProjectFilter !== 'All') { 
            data = data.filter(l => 
                (l.note && l.note.includes(globalProjectFilter)) || 
                (l.project && l.project === globalProjectFilter)
            );
        }

        // 2. กรองตาม Item (Viewing Detail)
        if (viewingItem) {
             if (viewingItem.isSummary) {
                 data = data.filter(l => {
                     const nameMatch = l.item === viewingItem.name;
                     const idMatch = viewingItem.combinedIds && viewingItem.combinedIds.includes(l.assetId);
                     const summaryIdMatch = l.assetId === viewingItem.id;
                     return nameMatch || idMatch || summaryIdMatch;
                 });
             } else {
                 const isAssetView = viewingItem.serial !== undefined;
                 data = data.filter(l => {
                     if (l.assetId === viewingItem.id) return true;
                     if (!l.assetId && l.item === viewingItem.name) {
                         if (viewingItem.project) {
                             const logProj = l.project;
                             const logNote = l.note || '';
                             const isProjectMatch = (logProj && logProj === viewingItem.project) || 
                                                    (!logProj && logNote.includes(viewingItem.project));
                             if (!isProjectMatch) return false;
                         }
                         const assetOnlyActions = ['Import Assets', 'Add Asset', 'Register Asset', 'Return Asset', 'Restore Asset', 'Delete Asset', 'Snooze Alert', 'Disable Alert', 'Enable Alert', 'Update Image', 'Edit Asset'];
                         const isLogForAsset = assetOnlyActions.includes(l.action) || (l.action === 'Borrow' && isAssetView) || (l.action === 'Return' && isAssetView);
                         return isAssetView ? isLogForAsset : !isLogForAsset;
                     }
                     return false;
                 });
             }
        }

       // ⭐ จุดที่มักเกิด Error: แก้ไขให้ parameter ชื่อ 'log' ตรงกับการใช้งานข้างใน
       if (historySearch) {
        const lower = historySearch.toLowerCase();
        data = data.filter(log => 
            (log.action && log.action.toLowerCase().includes(lower)) ||
            (log.item && log.item.toLowerCase().includes(lower)) ||
            (log.by && log.by.toLowerCase().includes(lower)) ||
            (log.note && log.note.toLowerCase().includes(lower)) ||
            (log.relatedRequestId && log.relatedRequestId.toLowerCase().includes(lower))
        );
    }

        // 4. Filter Action
        if (historyActionFilter !== 'All') {
            data = data.filter(l => l.action === historyActionFilter);
        }
        
        // 5. Sort Logic
        const parseLogDate = (dStr) => {
            if (!dStr) return 0;
            try {
                const [datePart, timePart] = dStr.split(' ');
                if (!datePart) return 0;
                const [day, month, year] = datePart.split('/').map(Number);
                const [hour, min, sec] = timePart ? timePart.split(':').map(Number) : [0, 0, 0];
                const adYear = year > 2400 ? year - 543 : year;
                return new Date(adYear, month - 1, day, hour, min, sec).getTime();
            } catch (e) { return 0; }
        };

        return [...data].sort((a, b) => {
            if (historySort.key === 'date') {
                const timeA = parseLogDate(a.date);
                const timeB = parseLogDate(b.date);
                return historySort.direction === 'asc' ? timeA - timeB : timeB - timeA;
            } else {
                const valA = (a[historySort.key] || '').toString().toLowerCase();
                const valB = (b[historySort.key] || '').toString().toLowerCase();
                if (valA < valB) return historySort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return historySort.direction === 'asc' ? 1 : -1;
                return 0;
            }
        });

    }, [invLogs, viewingItem, historySearch, historyActionFilter, historySort, globalProjectFilter]);


      // --- Helper Validation Logic ---

      // --- Helpers ---
      const showToast = (message, type = 'success') => {
        setNotification({ message, type });
        setTimeout(() => setNotification(null), 3000);
      };
        const fileToBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = (error) => reject(error);
    });
  };

 // --- LOGIC: HISTORY & LOGS (UPDATED WITH REFERENCE) ---

// ⭐ เพิ่ม async
const addInvLog = async (action, item, change, note = '', images = [], relatedRequestId = null, assetId = null) => {
  const log = {
    date: new Date().toLocaleString('th-TH'),
    action,
    item,
    change,
    by: user ? `${user.empId} ${user.firstName} ${user.lastName}` : currentUserRole, 
    note,
    images,
    relatedRequestId,
    assetId
  };
  setInvLogs(prev => [log, ...prev]);
  
  // ⭐ สั่งบันทึกและ return promise กลับไป (เพื่อให้ฟังก์ชันอื่นรอได้)
  try {
      await saveLogToSheet(log);
  } catch (err) {
      console.error("Save Log Error:", err);
  }
};


      // 2. ฟังก์ชันเปิดดูรายละเอียดเอกสารจากหน้าประวัติ
      const handleOpenRequestDetail = (reqId) => {
          const req = requests.find(r => r.id === reqId);
          if (req) {
              setSelectedRequest(req);
              setShowDetailModal(true);
          } else {
              showToast(`ไม่พบข้อมูลเอกสาร ${reqId}`, 'error');
          }
      };

      const handleSort = (key, currentSort, setSort) => {
        setSort({
            key,
            direction: currentSort.key === key && currentSort.direction === 'asc' ? 'desc' : 'asc'
        });
      };
      const handleHistorySort = (key) => handleSort(key, historySort, setHistorySort);
      const getSortedData = (data, sortConfig) => {
          const sorted = [...data];
          sorted.sort((a, b) => {
              if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'asc' ? -1 : 1;
              if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'asc' ? 1 : -1;
              return 0;
          });
          return sorted;
      };

      // --- Logic Hooks ---
;// --- LOGIC: Filter & Sort Requests (UPDATED) ---
      const filteredRequests = useMemo(() => {
        if (!user) return [];
        let data = requests;
        const myName = `${user.firstName} ${user.lastName}`; // ชื่อผู้ใช้ปัจจุบัน

        // 1. กรอง Global Project
        if (globalProjectFilter !== 'All') {
            data = data.filter(r => r.job === globalProjectFilter);
        }

        // 2. กรองตาม Search Query
        if (searchQuery) {
            const lowerQ = searchQuery.toLowerCase();
            data = data.filter(r => r.id.toLowerCase().includes(lowerQ) || r.items.some(i => i.name.toLowerCase().includes(lowerQ)) || (r.docNumber && r.docNumber.toLowerCase().includes(lowerQ)));
        }

        // 3. กรองตาม Status Filter (Dropdown ในหน้า Orders)
        if (statusFilter !== 'All') {
           data = data.filter(r => r.status === statusFilter);
        }

        // ⭐ 4. กรองรายการ "ของฉัน" หรือ "ที่ฉันมีสิทธิ์"
        data = data.filter(req => {
            const isMine = req.requester === myName || req.requester === 'Current User';
            
            let canAct = false;
            
            // ⭐ [แก้ไข] Logic เดียวกับ myPendingCount
            if (req.status === 'Pending Head') {
                 if ((req.type === 'Withdraw' || req.type === 'Borrow') && (hasPermission(8) || hasPermission(9))) canAct = true;
                 else if (['Local', 'HO'].includes(req.type) && hasPermission(8)) canAct = true;
            }

            if (hasPermission(9) && req.status === 'Pending PM') canAct = true;
            if (hasPermission(10) && req.status === 'Pending Check') canAct = true;
            if (hasPermission(11) && req.status === 'Approved' && req.purchaseType === 'Buy') canAct = true; // PR
            if (hasPermission(12) && req.type === 'HO' && req.status === 'PR Issued') canAct = true; // PO
            if (hasPermission(12) && req.type === 'Local' && req.status === 'Approved') canAct = true; // Local Buy
            if (hasPermission(13) && req.type === 'HO' && (req.status === 'PO Issued' || req.status === 'Contract Signed')) canAct = true; // Shipping
            if (hasPermission(14) && req.type === 'HO' && req.status === 'Contract Pending') canAct = true; // Contract
            if (hasPermission(15) && req.type === 'Local' && (req.status === 'Ordered' || req.status === 'Partially Received')) canAct = true; // Receive Local
            if (hasPermission(15) && req.type === 'HO' && (req.status === 'Shipping' || req.status === 'Partially Received')) canAct = true; // Receive HO
            if (hasPermission(24) && (req.type === 'Withdraw' || req.type === 'Borrow') && req.status === 'Ready to Disburse') canAct = true; // Disburse
            
            // User เห็นของตัวเอง + Admin เห็นทั้งหมด + คนอื่นเห็นงานที่ต้องทำ
            if (user.isSuperAdmin) return true;
            return isMine || canAct;
        });

        // ⭐ 5. คำนวณวันคงเหลือ และ เรียงลำดับ
        // Helper: คำนวณจำนวนวันจากวันนี้ถึง Date Required
        const getDaysDiff = (dateStr) => {
            if (!dateStr) return 999;
            const target = new Date(dateStr);
            const today = new Date();
            today.setHours(0,0,0,0);
            const diffTime = target - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        };

        // เรียงลำดับ
        return data.sort((a, b) => {
            // 5.1 สถานะเสร็จแล้ว เอาไว้ล่างสุด
            const isCompletedA = ['Completed', 'Rejected', 'Returned'].includes(a.status);
            const isCompletedB = ['Completed', 'Rejected', 'Returned'].includes(b.status);
            if (isCompletedA !== isCompletedB) return isCompletedA ? 1 : -1;

            // 5.2 เรียงตามวันที่ต้องการ (Date Required) จากน้อยไปมาก (ด่วนกว่าขึ้นก่อน)
            const daysA = getDaysDiff(a.dateRequired);
            const daysB = getDaysDiff(b.dateRequired);
            return daysA - daysB;
        });

      }, [requests, searchQuery, statusFilter, currentUserRole, globalProjectFilter, user]); // เพิ่ม user dependency

// --- LOGIC: Filter & Process Inventory (Updated with Combined IDs) ---
      const filteredInventory = useMemo(() => {
          let data = [...inventory];

          // กรอง Project (Global)
          if (globalProjectFilter !== 'All') {
              data = data.filter(i => i.project === globalProjectFilter);
          }

          if (invSearch) {
                const lower = invSearch.toLowerCase();
                data = data.filter(i => 
                    i.name.toLowerCase().includes(lower) || 
                    i.id.toLowerCase().includes(lower) ||
                    (i.project && i.project.toLowerCase().includes(lower))
                );
            }

          if (inventoryProjectFilter !== 'All') {
              data = data.filter(i => i.project === inventoryProjectFilter);
          }

          // 2. Tab Logic
          if (invTabMode === 'Summary') {
              // ⭐ [แก้ไข] Logic การรวม: เก็บรายละเอียด ในระบบ/นอกระบบ และ โครงการ
              const grouped = data.reduce((acc, item) => {
                  let existingItem = acc.find(x => x.name === item.name);
                  
                  if (!existingItem) {
                      existingItem = { 
                          ...item, 
                          id: `SUM-${item.name}`, 
                          isSummary: true,
                          combinedIds: [item.id],
                          // เริ่มต้นตัวนับใหม่
                          qty: 0, 
                          systemQty: 0,
                          nonSystemQty: 0,
                          projectBreakdown: {}
                      };
                      acc.push(existingItem);
                  } else {
                      existingItem.combinedIds.push(item.id);
                  }

                  // บวกยอดรวม
                  existingItem.qty += item.qty;
                  
                  // แยกประเภท
                  if (item.stockType === 'NonSystem') existingItem.nonSystemQty += item.qty;
                  else existingItem.systemQty += item.qty;

                  // แยกโครงการ
                  const projName = item.project || 'ส่วนกลาง';
                  existingItem.projectBreakdown[projName] = (existingItem.projectBreakdown[projName] || 0) + item.qty;

                  return acc;
              }, []);
              return getSortedData(grouped, invSort);
          } else {
              // โหมดแยกประเภท: System / NonSystem
              data = data.filter(i => (i.stockType || 'System') === invTabMode);
              return getSortedData(data, invSort);
          }

      }, [inventory, invSearch, invSort, invTabMode, globalProjectFilter, inventoryProjectFilter]);


// --- LOGIC: Filter & Sort Assets (UPDATED: Show Both Alerts) ---
      const filteredAssets = useMemo(() => {
          let data = assets;
          
          if (globalProjectFilter !== 'All') { data = data.filter(a => a.project === globalProjectFilter); }
          
          if (assetSearch) {
            const lower = assetSearch.toLowerCase();
            data = data.filter(a => a.name.toLowerCase().includes(lower) || a.id.toLowerCase().includes(lower) || (a.holder && a.holder.toLowerCase().includes(lower)) || (a.project && a.project.toLowerCase().includes(lower)));
          }

          if (assetProjectFilter !== 'All') { data = data.filter(a => a.project === assetProjectFilter); }

          if (assetTabMode === 'Summary') {
              // ... (Summary Logic เดิม ไม่ต้องแก้) ...
              const grouped = data.reduce((acc, item) => {
                  const existing = acc.find(g => g.name === item.name);
                  if (existing) {
                      existing.totalQty++;
                      if (item.ownerType === 'Company') existing.companyQty++;
                      if (item.ownerType === 'Rent') existing.rentQty++;
                      existing.items.push(item);
                  } else {
                      acc.push({ id: `GRP-${item.name}`, name: item.name, totalQty: 1, companyQty: item.ownerType === 'Company' ? 1 : 0, rentQty: item.ownerType === 'Rent' ? 1 : 0, items: [item], isSummary: true });
                  }
                  return acc;
              }, []);
              return grouped.sort((a, b) => a.name.localeCompare(b.name));
          } else {
            // Normal Logic
            data = data.filter(a => a.ownerType === assetTabMode);
            
            const today = new Date();
            today.setHours(0,0,0,0);

            const processedData = data.map(asset => {
                let alertType = null; 
                let priority = 0;
                let daysLeft = null;
                
                // ⭐ เพิ่มตัวแปรเช็ค Overdue แยกต่างหาก
                let isOverdue = false;
                let overdueDays = 0;
                
                // 1. เช็ควันหมดสัญญา
                if (asset.ownerType === 'Rent' && asset.rentalEnd) {
                    const endDate = new Date(asset.rentalEnd);
                    const diffTime = endDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    daysLeft = diffDays;

                    if (diffDays < 0) { 
                        alertType = 'expired'; 
                        priority = 3; 
                    } else if (diffDays <= 30) { 
                        alertType = 'expiring'; 
                        priority = 2; 
                    }
                }

                // 2. เช็คยืมเกินกำหนด (Borrowed Overdue)
                if (asset.status === 'Borrowed' && asset.lastUpdated) {
                     const borrowDate = parseThaiDate(asset.lastUpdated);
                     if (borrowDate) {
                         const diffTime = Math.abs(today - borrowDate);
                         const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                         
                         const isSnoozed = asset.snoozeUntil && new Date(asset.snoozeUntil) > today;

                         if (diffDays > 7 && !isSnoozed) { 
                             // ⭐ ตั้งค่า Flag เป็นจริง
                             isOverdue = true;
                             overdueDays = diffDays;
                             priority = Math.max(priority, 1); 
                             
                             // ถ้ายังไม่มี alertType (ไม่ติดสัญญา) ให้ตั้งเป็น overdue
                             // แต่ถ้ามี (เช่น expired/expiring) ก็ปล่อยไว้ เพื่อให้แสดงผลคู่กันได้
                             if (!alertType) alertType = 'overdue';
                         }
                     }
                }
            
                return { ...asset, alertType, priority, daysLeft, isOverdue, overdueDays };
            });

            // Sort: เรียงตาม Priority (มากไปน้อย)
            return processedData.sort((a, b) => {
                if (b.priority !== a.priority) return b.priority - a.priority;
                if (a.daysLeft !== null && b.daysLeft !== null && a.daysLeft !== b.daysLeft) return a.daysLeft - b.daysLeft;
                if (a[assetSort.key] < b[assetSort.key]) return assetSort.direction === 'asc' ? -1 : 1;
                if (a[assetSort.key] > b[assetSort.key]) return assetSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
          }
      }, [assets, assetSearch, assetSort, assetTabMode, globalProjectFilter, assetProjectFilter]);

      // --- Functions & Handlers (Logic from original file) ---
      
// Smart Suggestion (Multi-Project Search) - Updated: Grouping Logic
useEffect(() => {
    let timeoutId;
    setFoundSuggestions([]);
    
  if (tempItem.name && tempItem.name.length > 2 && ['Local', 'HO'].includes(newOrderMeta.type)) {
        timeoutId = setTimeout(() => {
            const lowerName = tempItem.name.toLowerCase();
            let matches = [];

            // 🟢 1. ค้นหาในคลัง (Inventory) -> แนะนำให้เบิก (รวมยอด ในระบบ+นอกระบบ)
            const groupedInv = {};
            
            inventory.forEach(inv => {
                // กรองชื่อและจำนวนที่มี
                if (inv.name.toLowerCase().includes(lowerName) && inv.qty > 0) {
                    // สร้าง Key สำหรับรวมกลุ่ม: "ชื่อสินค้า|ชื่อโครงการ"
                    const key = `${inv.name}|${inv.project || 'ส่วนกลาง'}`;

                    if (!groupedInv[key]) {
                        groupedInv[key] = {
                            ...inv, // ยึดข้อมูลพื้นฐานจากรายการแรกที่เจอ
                            qty: 0, // รีเซ็ตยอดรวมเพื่อคำนวณใหม่
                            sysQty: 0, // ยอดในระบบ
                            nonQty: 0, // ยอดนอกระบบ
                            type: 'Material', 
                            matchType: 'Withdraw',
                            sourceLabel: 'คลังวัสดุ'
                        };
                    }

                    // บวกยอดรวม
                    groupedInv[key].qty += inv.qty;
                    
                    // แยกยอดตามประเภท
                    if (inv.stockType === 'NonSystem') {
                        groupedInv[key].nonQty += inv.qty;
                    } else {
                        groupedInv[key].sysQty += inv.qty;
                    }
                }
            });

            // แปลง Object กลับเป็น Array เพื่อนำไปแสดงผล
            Object.values(groupedInv).forEach(item => {
                matches.push(item);
            });

            // 🔵 2. ค้นหาในทะเบียน (Assets) -> แนะนำให้ยืม (เหมือนเดิม)
            assets.forEach(ast => {
                if (ast.name.toLowerCase().includes(lowerName) && ast.status === 'Available') {
                    matches.push({ 
                        ...ast, 
                        type: 'Asset', 
                        matchType: 'Borrow',
                        sourceLabel: 'ทะเบียนทรัพย์สิน'
                    });
                }
            });

            setFoundSuggestions(matches);
        }, 500);
    }
    return () => clearTimeout(timeoutId);
}, [tempItem.name, inventory, assets, newOrderMeta.type]);

// ฟังก์ชันเลือก Suggestion (Auto Switch Project)
const selectSuggestion = (item) => {
    if (confirm(`ต้องการเปลี่ยนไป "${item.matchType === 'Withdraw' ? 'เบิก' : 'ยืม'}" รายการนี้จากโครงการ "${item.project}" หรือไม่?`)) {
        
        // 1. เปลี่ยน Meta Data (Type & Project)
        setNewOrderMeta(prev => ({
            ...prev,
            type: item.matchType, // เปลี่ยนเป็น Withdraw หรือ Borrow
            job: item.project || 'ส่วนกลาง' // ⭐ เปลี่ยนโครงการตามของที่เจอ
        }));

        // 2. ใส่ข้อมูลลงในฟอร์ม
        setTempItem(prev => ({ 
            ...prev, 
            name: item.name, 
            unit: item.unit || 'ชิ้น',
            qty: 1, // Default 1
            unitPrice: 0, // เบิก/ยืม ไม่มีราคา
            assetId: item.id, // เก็บ ID
            serial: item.serial || '',
            image: item.image
        }));

        // 3. เคลียร์ Suggestion
        setFoundSuggestions([]);
    }
};

// --- LOGIC: ADD ITEM TO ORDER (UPDATED VALIDATION) ---
const handleAddItem = () => {
    if (!tempItem.name) { showToast('กรุณาระบุชื่อรายการ', 'error'); return; }
    
    const currentType = newOrderMeta.type;

    // 🟢 1. ตรวจสอบสำหรับ "เบิกวัสดุ" (Withdraw) -> เช็คแบบรวมยอด
    if (currentType === 'Withdraw') {
        // หาของทั้งหมดที่มีชื่อนี้ในโครงการนี้
        const stockItems = inventory.filter(i => i.name === tempItem.name && i.project === newOrderMeta.job);
        
        if (stockItems.length === 0) {
            showToast(`ไม่พบสินค้า "${tempItem.name}" ในคลังของโครงการ ${newOrderMeta.job}`, 'error');
            return;
        }

        // คำนวณสต็อกรวมที่มีจริง (Total Physical Stock)
        const totalStock = stockItems.reduce((sum, i) => sum + i.qty, 0);

        // คำนวณยอดที่ถูกจองในใบอื่น (Active Requests)
        const activeRequests = requests.filter(r => 
            r.id !== editingId &&
            !['Draft', 'Completed', 'Rejected', 'Returned'].includes(r.status) &&
            r.job === newOrderMeta.job && 
            r.type === 'Withdraw'
        );
        const reservedQty = activeRequests.reduce((sum, req) => {
            const sameItem = req.items.find(i => i.name === tempItem.name);
            return sum + (sameItem ? (sameItem.qty || 0) : 0);
        }, 0);

        // คำนวณยอดคงเหลือที่เบิกได้
        const realAvailable = totalStock - reservedQty;

        if (tempItem.qty > realAvailable) {
            showToast(`จำนวนในคลังไม่พอ (มีรวม: ${totalStock}, จองแล้ว: ${reservedQty}, คงเหลือเบิกได้: ${realAvailable})`, 'error');
            return;
        }
    }

    // 🔵 2. ตรวจสอบสำหรับ "ยืมทรัพย์สิน" (Borrow) - Logic เดิม
    if (currentType === 'Borrow') {
        if (!tempItem.assetId) {
            showToast(`กรุณาเลือกทรัพย์สินจากรายการ`, 'error');
            return;
        }
        if (orderItems.some(item => item.assetId === tempItem.assetId)) {
            showToast(`รายการซ้ำ: "${tempItem.name}" ถูกเลือกไปแล้ว`, 'error');
            return;
        }
        // ... (Logic เช็ค Asset Pending เหมือนเดิม) ...
        // ...
    }

    // ผ่านทุกเงื่อนไข -> เพิ่มรายการ
    setOrderItems([...orderItems, { ...tempItem }]);
    setTempItem({ name: '', qty: 1, unitPrice: 0, unit: 'ชิ้น', subJob: '', matCode: '', note: '', images: [], assetId: '', serial: '' });
    setStockSuggestion(null); 
};


const handleEditItem = (index) => {
          const itemToEdit = orderItems[index];
          setTempItem(itemToEdit); // โหลดข้อมูลกลับเข้าฟอร์ม
          
          // ลบออกจากรายการเดิม (เพื่อให้กดเพิ่มใหม่ได้)
          const newItems = [...orderItems];
          newItems.splice(index, 1);
          setOrderItems(newItems);
      };

// --- HELPER: ดึงรูปภาพล่าสุดจากประวัติ (Smart Image Fetcher) ---
const getItemLatestImage = (item) => {
    // ค้นหาใน invLogs (ซึ่งเรียงจาก ใหม่ -> เก่า อยู่แล้ว)
    const log = invLogs.find(l => {
        // ต้องมีรูปเท่านั้น
        if (!l.images || l.images.length === 0) return false;
        
        // ถ้าเป็น Asset ให้เช็ค ID (แม่นยำกว่า)
        if (item.id && item.id.startsWith('AST')) {
            return l.assetId === item.id;
        }
        // ถ้าเป็น Inventory หรือ Asset ที่ไม่มี ID ให้เช็คจากชื่อ
        return l.item === item.name;
    });

    // ถ้าเจอ Log ที่มีรูป ให้คืนค่ารูปแรก
    if (log) return log.images[0];
    return null;
};

// --- HELPER: ดึงรูปภาพ 'ทั้งหมด' จากประวัติล่าสุด (สำหรับดู Fullscreen) ---
const getItemLatestImages = (item) => {
    // ใช้ Logic เดียวกันแต่ return images ทั้ง array
    const log = invLogs.find(l => {
        if (!l.images || l.images.length === 0) return false;
        if (item.id && item.id.startsWith('AST')) {
             return l.assetId === item.id;
        }
        return l.item === item.name;
    });
    return log ? log.images : [];
};



// --- LOGIC: Filter Selection Items (Updated Search Logic) ---
const getSelectionItems = () => {
    const type = newOrderMeta.type;
    const targetProject = newOrderMeta.job;
    
    if (!targetProject) return [];

    let items = [];

    // 🟢 กรณี 1: เบิกวัสดุ (Withdraw) -> รวมยอด System + NonSystem
    if (type === 'Withdraw') {
        const activeRequests = requests.filter(r => 
            r.id !== editingId &&
            !['Draft', 'Completed', 'Rejected', 'Returned'].includes(r.status) &&
            r.job === targetProject &&
            r.type === 'Withdraw'
        );

        const reservesByName = {};
        activeRequests.forEach(req => {
            req.items.forEach(item => {
                reservesByName[item.name] = (reservesByName[item.name] || 0) + (item.qty || 0);
            });
        });

        const groupedMap = {};
        inventory
            .filter(i => i.project === targetProject)
            .forEach(inv => {
                if (!groupedMap[inv.name]) {
                    groupedMap[inv.name] = {
                        ...inv, 
                        qty: 0, 
                        sysStock: 0,
                        nonStock: 0,
                        totalRaw: 0,
                        isGrouped: true 
                    };
                }
                
                groupedMap[inv.name].totalRaw += inv.qty;
                if (inv.stockType === 'NonSystem') {
                    groupedMap[inv.name].nonStock += inv.qty;
                } else {
                    groupedMap[inv.name].sysStock += inv.qty;
                }
            });

        items = Object.values(groupedMap).map(item => {
            const reserved = reservesByName[item.name] || 0;
            const realAvailable = Math.max(0, item.totalRaw - reserved);
            return {
                ...item,
                qty: realAvailable, 
                reserved: reserved
            };
        }).filter(i => i.qty > 0);
    } 
    // 🔵 กรณี 2: ยืม (Borrow) หรือ ซื้อ (Local/HO)
    else {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const projectInventory = inventory.filter(i => i.project === targetProject && i.qty > 0);
        
        const projectAssets = assets.filter(a => {
            if (a.project !== targetProject) return false;
            if (a.status !== 'Available') return false;
            if (a.ownerType === 'Rent' && a.rentalEnd) {
                const endDate = new Date(a.rentalEnd);
                if (!isNaN(endDate.getTime())) {
                    endDate.setHours(0, 0, 0, 0);
                    if (endDate < today) return false;
                }
            }
            return true;
        });

        if (type === 'Local') items = projectInventory;
        else if (type === 'HO') items = [...projectInventory, ...projectAssets];
        else if (type === 'Borrow') items = projectAssets;
    }

    // ⭐ Logic Search: ค้นหาจากชื่อ หรือ รหัส (รองรับทั้ง Grouped และ Individual)
    if (selectionSearch) {
        const lower = selectionSearch.toLowerCase();
        items = items.filter(i => 
            i.name.toLowerCase().includes(lower) || 
            (i.id && i.id.toLowerCase().includes(lower)) || 
            (i.serial && i.serial.toLowerCase().includes(lower))
        );
    }
    
    return items;
};

// --- LOGIC: Handle Selection (Updated) ---
      const handleSelectFromModal = (item) => {
          const isBorrow = newOrderMeta.type === 'Borrow';
          const isWithdraw = newOrderMeta.type === 'Withdraw';
          
          // ⭐ Logic ชื่อ: ยืม/เบิก/ซื้อ ดึงแค่ "ชื่อรายการ" (ไม่ต้องมี ID ต่อท้าย)
          const name = item.name; 

          setTempItem({
              ...tempItem,
              name: name,
              unitPrice: (isWithdraw || isBorrow) ? 0 : item.price,
              unit: (item.unit || 'ชิ้น'),
              // ⭐ เก็บข้อมูล Asset ไว้เช็ค Validation และแสดงในตาราง
              assetId: item.id,
              serial: item.serial,
              image: item.image 
          });
          setShowSelectionModal(false);
          setSelectionSearch('');
      };
      
      const handleOpenSelectionModal = () => {
          setSelectionSearch('');
          setShowSelectionModal(true);
      };

      const handleEditDraft = (req) => {
          setEditingId(req.id);
          setNewOrderMeta({
              type: req.type,
              purchaseType: req.purchaseType || 'Buy',
              job: req.job || '',
              dateRequired: req.dateRequired || '',
              priority: req.priority || 'Normal',
              attachment: req.attachment || null,
              quotation: req.quotation || null
          });
          setOrderItems(req.items || []);
          setShowCreateModal(true);
      };
      
      const handleRevise = (req) => {
          handleEditDraft(req);
          showToast('กรุณาแก้ไขข้อมูลตามที่ผู้ตรวจสอบแจ้ง', 'info');
      };

      const handleCloseCreateModal = () => {
          setShowCreateModal(false);
          setEditingId(null);
          setOrderItems([]);
          setNewOrderMeta({ type: 'Local', purchaseType: 'Buy', job: '', dateRequired: '', priority: 'Normal', attachment: null, quotation: null });
          setTempItem({ name: '', qty: 1, unitPrice: 0, unit: 'ชิ้น', subJob: '', matCode: '', note: '', images: [] });
      };

// [แก้ไข] เพิ่มฟังก์ชันคำนวณวันที่ล่วงหน้า
      const getFutureDate = (days) => {
          const date = new Date();
          date.setDate(date.getDate() + days);
          return date.toISOString().split('T')[0];
      };

      // [แก้ไข] ปรับปรุง handleOpenCreateModal
      const handleOpenCreateModal = () => {
          setEditingId(null);
          setOrderItems([]);
          setNewOrderMeta({ 
              type: 'Local', 
              purchaseType: 'Buy', 
              job: globalProjectFilter !== 'All' ? globalProjectFilter : '', 
              dateRequired: getFutureDate(7), // ⭐ กำหนดค่าเริ่มต้นเป็น อีก 15 วัน
              priority: 'Urgent', // (8-30 วัน = Urgent)
              attachment: null, 
              quotation: null 
          });
          setTempItem({ name: '', qty: 1, unitPrice: 0, unit: 'ชิ้น', subJob: '', matCode: '', note: '', images: [] });
          setShowCreateModal(true);
      };


      // [เพิ่มใหม่] ฟังก์ชันเปลี่ยนวันที่พร้อมคำนวณ Priority อัตโนมัติ
      const handleDateChange = (e) => {
          const selectedDate = e.target.value;
          if (!selectedDate) {
              setNewOrderMeta(prev => ({ ...prev, dateRequired: selectedDate }));
              return;
          }

          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const target = new Date(selectedDate);
          const diffTime = target - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          let newPriority = 'Normal';
          if (diffDays <= 7) newPriority = 'Critical';      // 0 - 7 วัน -> ด่วนมาก
          else if (diffDays <= 30) newPriority = 'Urgent';  // 8 - 30 วัน -> ด่วน
          else newPriority = 'Normal';                      // 31 วันขึ้นไป -> ปกติ

          setNewOrderMeta(prev => ({ ...prev, dateRequired: selectedDate, priority: newPriority }));
      };

      const initiateRecall = (id) => {
          const updatedReqs = requests.map(r => {
              if (r.id === id) {
                    // ⭐ แก้ตรงนี้
                    const updated = { ...r, status: 'Draft', history: [...r.history, createLog('Revert to Draft', `${user.empId} ${user.firstName} ${user.lastName}`, 'User recalled request')] };
                    saveRequestToSheet(updated);
                    return updated;
              }
              return r;
          });
          setRequests(updatedReqs);
          showToast('เรียกคืนเอกสารกลับมาเป็นแบบร่างแล้ว');
      };

      const handleRemoveItem = (index) => {
          const newItems = [...orderItems];
          newItems.splice(index, 1);
          setOrderItems(newItems);
      };


      const handleUpdateStock = () => {
          if (!editingStockItem) return;
          const updatedItem = { ...editingStockItem, lastUpdated: new Date().toLocaleString('th-TH') };
          
          setInventory(prev => prev.map(item => item.id === editingStockItem.id ? updatedItem : item));
          saveInventoryToSheet(updatedItem); // Sync

          const oldItem = inventory.find(i => i.id === editingStockItem.id);
          const change = editingStockItem.qty - (oldItem ? oldItem.qty : 0);
          const changeStr = change > 0 ? `+${change}` : `${change}`;
          
          addInvLog('Update Stock', editingStockItem.name, changeStr, 'แก้ไขข้อมูลสต็อก', []);
          setShowEditInvModal(false);
          setEditingStockItem(null);
          showToast('อัปเดตข้อมูลเรียบร้อย');
      };


// --- LOGIC: ASSET IMAGE HANDLING (Base64 Preview like Daily Report) ---
      
      // 1. เลือกรูปภาพ (แปลงเป็น Base64 และต่อท้าย Array เดิม)
      const handleAssetImageSelect = (e, isEdit = false) => {
          if (e.target.files && e.target.files.length > 0) {
              const files = Array.from(e.target.files);
              
              // อ่านไฟล์ทั้งหมดพร้อมกัน
              const promises = files.map(file => {
                  return new Promise((resolve, reject) => {
                      const reader = new FileReader();
                      reader.onload = (x) => resolve({ 
                          base64: x.target.result, 
                          file: file, // เก็บ File Object ไว้เผื่อใช้ (แต่หลักๆ ใช้ Base64 โชว์)
                          name: file.name
                      });
                      reader.onerror = reject;
                      reader.readAsDataURL(file);
                  });
              });

              Promise.all(promises).then(newImages => {
                  if (isEdit) {
                      // กรณีแก้ไข: เพิ่มเข้าไปใน newImages
                      setEditingAssetItem(prev => ({
                          ...prev,
                          newImages: [...(prev.newImages || []), ...newImages]
                      }));
                  } else {
                      // กรณีเพิ่มใหม่: เพิ่มเข้าไปใน images
                      setNewAssetItem(prev => ({ 
                          ...prev, 
                          images: [...prev.images, ...newImages] 
                      }));
                  }
              });
          }
      };

      // --- LOGIC: RETURN ASSET IMAGE HANDLING ---
      const handleReturnImageSelect = (e) => {
          if (e.target.files && e.target.files.length > 0) {
              const files = Array.from(e.target.files);
              const newImages = files.map(file => ({ file, url: URL.createObjectURL(file) }));
              setReturnAssetData(prev => ({ 
                  ...prev, 
                  images: [...(prev.images || []), ...files], // เก็บ File Object สำหรับ Upload
                  previews: [...(prev.previews || []), ...newImages] // เก็บ URL สำหรับ Preview
              }));
          }
      };

      const handleRemoveReturnImage = (index) => {
          setReturnAssetData(prev => ({
              ...prev,
              images: prev.images.filter((_, i) => i !== index),
              previews: prev.previews.filter((_, i) => i !== index)
          }));
      };

      // 2. ลบรูปภาพ
      const handleRemoveAssetImage = (index, isEdit = false) => {
          if (isEdit) {
              setEditingAssetItem(prev => ({
                  ...prev,
                  newImages: prev.newImages.filter((_, i) => i !== index)
              }));
          } else {
              setNewAssetItem(prev => ({
                  ...prev,
                  images: prev.images.filter((_, i) => i !== index)
              }));
          }
      };

// --- LOGIC: STOCK IMAGE HANDLING ---
      const handleStockImageSelect = (e) => {
          if (e.target.files && e.target.files.length > 0) {
              const files = Array.from(e.target.files);
              const promises = files.map(file => {
                  return new Promise((resolve) => {
                      const reader = new FileReader();
                      reader.onload = (x) => resolve({
                          base64: x.target.result,
                          file: file,
                          name: file.name
                      });
                      reader.readAsDataURL(file);
                  });
              });
              Promise.all(promises).then(newImages => {
                  setNewStockItem(prev => ({
                      ...prev,
                      images: [...(prev.images || []), ...newImages]
                  }));
              });
          }
      };

      const handleRemoveStockImage = (index) => {
          setNewStockItem(prev => ({
              ...prev,
              images: prev.images.filter((_, i) => i !== index)
          }));
      };

// --- LOGIC: ADD NEW PRODUCT (Robust Auto Gen & Composite ID) ---
const handleAddNewProduct = async () => {
    // 1. Validation
    if (!newStockItem.name) { showToast('กรุณาระบุชื่อสินค้า', 'error'); return; }
    if (!newStockItem.project) { showToast('กรุณาระบุโครงการ', 'error'); return; }
    if (newStockItem.qty < 0) { showToast('จำนวนเริ่มต้นต้องไม่ต่ำกว่า 0', 'error'); return; }
    
    const currentType = newStockItem.stockType || 'System';

    // 2. เช็คว่ามีของเดิมหรือไม่ (ชื่อ+โครงการ+ประเภท ตรงกันเป๊ะ)
    const existingInv = inventory.find(i => 
        i.name === newStockItem.name && 
        i.project === newStockItem.project && 
        (i.stockType === currentType || (!i.stockType && currentType === 'System'))
    );
    
    // 3. เตรียม Base ID (รหัสสั้น)
    let baseId = newStockItem.id;
    if (newStockItem.isAutoId) {
        // ⭐ Auto Gen Logic: วนลูปหาเลขที่ว่างจริงๆ
        let runNoCount = inventory.length + 1;
        baseId = `INV-${String(runNoCount).padStart(3, '0')}`;
        // เช็คซ้ำกับ "รหัสหน้าบ้าน" ของทุกรายการในระบบ
        while (inventory.some(inv => getDisplayId(inv.id) === baseId)) {
            runNoCount++;
            baseId = `INV-${String(runNoCount).padStart(3, '0')}`;
        }
    } else {
        // ถ้า Manual ID มา ต้องเช็คว่าว่างไหม (ถ้าว่างก็ใช้ได้)
        if (!baseId) { showToast('กรุณาระบุรหัสสินค้า', 'error'); return; }
    }

    // ⭐ 4. สร้าง Real ID (รหัส|โครงการ|ประเภท)
    // ถ้าเจอของเดิม -> ใช้ ID เดิม
    // ถ้าของใหม่ -> ใช้ BaseId ที่ Gen มา + Suffix
    let finalId = existingInv ? existingInv.id : `${baseId}|${newStockItem.project}|${currentType}`;

    setIsLoading(true);
    try {
        // ... (ส่วน Upload Image เหมือนเดิม ไม่ต้องแก้) ...
        let uploadedFiles = [];
        if (newStockItem.images && newStockItem.images.length > 0) {
            const uploadPromises = newStockItem.images.map(imgObj => {
                return new Promise((resolve, reject) => {
                    google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).uploadAssetImage(imgObj.base64, imgObj.name);
                });
            });
            uploadedFiles = await Promise.all(uploadPromises);
        }
        const mainImageName = uploadedFiles.length > 0 ? uploadedFiles[0].name : (existingInv ? existingInv.image : null);
        const date = new Date().toLocaleString('th-TH');
        // ... (จบส่วน Image) ...

        if (existingInv) {
            // ✅ MERGE (ของเดิม)
            const updatedItem = {
                ...existingInv,
                qty: existingInv.qty + newStockItem.qty, // บวกยอด
                price: newStockItem.price > 0 ? newStockItem.price : existingInv.price,
                note: newStockItem.note ? (existingInv.note ? `${existingInv.note} | ${newStockItem.note}` : newStockItem.note) : existingInv.note,
                lastUpdated: date,
                image: mainImageName
            };
            setInventory(prev => prev.map(i => i.id === existingInv.id ? updatedItem : i));
            
            // ใช้ await เพื่อความชัวร์
            await saveInventoryToSheet(updatedItem);
            
            const logAttachments = uploadedFiles.map(f => ({ name: f.name, type: 'image/jpeg', url: f.url }));
            await addInvLog('Add Stock (Merge)', updatedItem.name, `+${newStockItem.qty}`, `โครงการ: ${updatedItem.project} (${currentType})`, logAttachments, null, finalId);
            showToast(`เพิ่มยอดสินค้าเดิมเรียบร้อย (${updatedItem.qty})`);
            
        } else {
            // ✅ NEW (ของใหม่)
            const newItem = {
                id: finalId, // ID มี Suffix
                ...newStockItem,
                stockType: currentType,
                lastUpdated: date,
                image: mainImageName,
                images: [],
                id: finalId // ยืนยัน ID อีกที
            };
            const { images, isAutoId, ...itemForServer } = newItem;
            
            setInventory(prev => [...prev, newItem]);
            await saveInventoryToSheet(itemForServer);
            
            const logAttachments = uploadedFiles.map(f => ({ name: f.name, type: 'image/jpeg', url: f.url }));
            const typeLabel = currentType === 'NonSystem' ? '[นอกระบบ]' : '[ในระบบ]';
            await addInvLog('Add New Item', newItem.name, `Start: ${newItem.qty}`, `โครงการ: ${newItem.project} | ${typeLabel}`, logAttachments, null, finalId);
            showToast('บันทึกสินค้าใหม่เรียบร้อย');
        }

        setIsLoading(false);
        setShowAddInvModal(false);
        // Reset Form
        setNewStockItem({ name: '', qty: 0, unit: 'ชิ้น', minStock: 0, price: 0, images: [], note: '', stockType: 'System', project: globalProjectFilter !== 'All' ? globalProjectFilter : '', id: '', isAutoId: true });

    } catch (error) {
        setIsLoading(false);
        console.error(error);
        showToast("Error: " + error.message, 'error');
    }
};

// --- LOGIC: ADD ASSET (UPDATED: Check Holder) ---
const handleAddAsset = async () => {
          // Validation
          if (!newAssetItem.ownerType) { showToast('กรุณาเลือกประเภททรัพย์สิน', 'error');
          return; }
          if (!newAssetItem.isAutoId && !newAssetItem.id) { showToast('กรุณาระบุรหัสทรัพย์สิน', 'error'); return;
          }
          if (!newAssetItem.name) { showToast('กรุณาระบุชื่อรายการ', 'error'); return;
          }
          if (!newAssetItem.isAutoId && assets.some(a => a.id === newAssetItem.id)) { showToast('รหัสทรัพย์สินซ้ำ', 'error');
          return; }
          
          // ⭐ [แก้ไขใหม่] ตรวจสอบชื่อคนยืม ถ้าสถานะเป็น Borrowed
          if (newAssetItem.status === 'Borrowed') {
              if (!newAssetItem.holder || newAssetItem.holder.trim() === '') {
                  showToast('กรุณาระบุชื่อผู้ยืม', 'error');
                  return;
              }
              // ตรวจสอบว่าชื่อที่เลือกมา มีอยู่ในระบบจริงหรือไม่
              const isValidUser = allUsers.some(u => `${u.firstName} ${u.lastName}` === newAssetItem.holder);
              if (!isValidUser) {
                  showToast('ชื่อผู้ยืมไม่ถูกต้อง (กรุณาเลือกจากรายชื่อที่มีในระบบ)', 'error');
                  return;
              }
          }

          setIsLoading(true);

          try {
              const date = new Date().toLocaleString('th-TH');
              
              // Auto Gen ID
              let finalId = newAssetItem.id;
              if (newAssetItem.isAutoId) {
                  const prefix = newAssetItem.ownerType === 'Rent' ? 'AST-R' : 'AST-C';
                  const runNo = String(assets.length + 1).padStart(3, '0');
                  finalId = `${prefix}-${new Date().getFullYear().toString().slice(-2)}${(new Date().getMonth()+1).toString().padStart(2,'0')}-${runNo}`;
              }

              // Upload Images
              let uploadedFiles = [];
              if (newAssetItem.images && newAssetItem.images.length > 0) {
                  const uploadPromises = newAssetItem.images.map(imgObj => {
                      return new Promise((resolve, reject) => {
                          google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .uploadAssetImage(imgObj.base64, imgObj.name);
                      });
                  });
                  uploadedFiles = await Promise.all(uploadPromises);
              }

              const mainImageName = uploadedFiles.length > 0 ? uploadedFiles[0].name : null;

              // ⭐ กำหนดค่า Holder: ถ้า Borrowed ใช้ค่าที่กรอก, ถ้าไม่ใช้ ให้เป็น '-'
              const finalHolder = newAssetItem.status === 'Borrowed' ? newAssetItem.holder : '-';

              const newAsset = { 
                  currentRequestId: null, 
                  lastUpdated: date,
                  ...newAssetItem, 
                  holder: finalHolder, // Override ค่า holder ให้ถูกต้อง
                  id: finalId,     
                  image: mainImageName,
                  images: [] 
              };
              
              const { images, ...assetForServer } = newAsset;
              saveAssetToSheet(assetForServer); 
              setAssets(prev => [...prev, newAsset]);
              
              // Log
              const logAttachments = uploadedFiles.map(f => ({ name: f.name, type: 'image/jpeg', url: f.url }));
              
              // สร้างข้อความ Log
              let logAction = `รับเข้าโครงการ ${newAssetItem.project || 'ไม่ระบุ'} - เพิ่มทรัพย์สินใหม่ ${finalId} (${newAssetItem.status})`;
              if (newAssetItem.status === 'Borrowed') logAction += ` ผู้ยืม: ${finalHolder}`;

              addInvLog('Add Asset', newAssetItem.name, 'New', logAction, logAttachments);
              
              setIsLoading(false);
              setShowAssetModal(false);
              // Reset State
              setNewAssetItem({ id: '', isAutoId: false, name: '', serial: '', status: 'Available', condition: 'Good', ownerType: '', price: 0, rentalPrice: 0, rentalUnit: 'Month', images: [], note: '', holder: '' });
              showToast(`เพิ่มทรัพย์สินเรียบร้อย`);

          } catch (error) {
              setIsLoading(false);
              showToast("Error: " + error.message, 'error');
          }
      };

 // แก้ไข initiateReturnAsset
      const initiateReturnAsset = (asset) => {
          setReturnAssetData({ 
              id: asset.id, 
              name: asset.name, // เก็บชื่อไว้ใช้แสดง
              serial: asset.serial, // เก็บ serial ไว้ใช้แสดง
              condition: 'Good', 
              note: '', 
              images: [], 
              previews: [] // เพิ่มตัวนี้
          });
          setShowReturnAssetModal(true);
      };

// [แก้ไข] ฟังก์ชันยืนยันรับคืน (Update: บันทึก User จริงลงประวัติ)
const confirmReturnAsset = async () => {
    const asset = assets.find(a => a.id === returnAssetData.id);
    if (!asset) return;
    
    // Validation
    if (returnAssetData.condition === 'Lost' || returnAssetData.condition === 'Damaged') {
        if (!returnAssetData.note || returnAssetData.note.trim() === '') {
            showToast('กรุณาระบุหมายเหตุ (สำหรับสถานะ สูญหาย/ชำรุด)', 'error');
            return;
        }
    }
    
    if (returnAssetData.condition === 'Damaged') {
        if (!returnAssetData.images || returnAssetData.images.length === 0) {
            showToast('กรุณาถ่ายรูปสภาพทรัพย์สิน (สำหรับสถานะ ชำรุด)', 'error');
            return;
        }
    }
    
    setIsLoading(true);
    try {
        // 1. Upload Images
        let uploadedFiles = [];
        if (returnAssetData.images && returnAssetData.images.length > 0) {
            const uploadPromises = returnAssetData.images.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .uploadAssetImage(reader.result, file.name);
                    };
                });
            });
            uploadedFiles = await Promise.all(uploadPromises);
        }
        
        const logAttachments = uploadedFiles.map(f => ({ name: f.name, type: 'image/jpeg', url: f.url }));
        
        // 2. New Status
        let newStatus = 'Available';
        if (returnAssetData.condition === 'Damaged') newStatus = 'Damaged';
        if (returnAssetData.condition === 'Lost') newStatus = 'Lost';

        // 3. Update Asset
        const updatedAsset = { 
            ...asset, 
            status: newStatus,
            holder: '-', 
            currentRequestId: null, 
            lastUpdated: new Date().toLocaleString('th-TH'),
            image: uploadedFiles.length > 0 ? uploadedFiles[0].name : asset.image,
            note: returnAssetData.note || asset.note 
        };
        setAssets(prev => prev.map(a => a.id === asset.id ? updatedAsset : a));
        
        const { images, ...assetForServer } = updatedAsset;
        saveAssetToSheet(assetForServer);

        // 4. Log & Request Update
        let statusText = 'ปกติ/ดี (พร้อมใช้งาน)';
        if (returnAssetData.condition === 'Damaged') statusText = 'ชำรุด';
        if (returnAssetData.condition === 'Lost') statusText = 'สูญหาย';

        // ⭐ [แก้ไข] ระบุตัวตนคนทำรายการรับคืน (User ปัจจุบัน)
        const returnerSignature = `${user.empId} ${user.firstName} ${user.lastName}`;

        // บันทึก Log ของ Asset
        await addInvLog('Return Asset', asset.name, 'Return', `รับคืน: ${statusText} โดย ${returnerSignature} ${returnAssetData.note ? `(${returnAssetData.note})` : ''}`, logAttachments, asset.currentRequestId);
        
        // บันทึก Log ของ Request (เพื่อให้ไปโชว์ใน PDF ช่อง Returned By)
        if (asset.currentRequestId) {
            setRequests(prev => prev.map(r => {
                if (r.id === asset.currentRequestId) {
                    const updatedReq = { 
                        ...r, 
                        status: 'Returned', 
                        // ใช้ returnerSignature แทน currentUserRole
                        history: [...r.history, createLog('Returned', returnerSignature, `คืนของ: ${statusText}`, logAttachments)]
                    };
                    saveRequestToSheet(updatedReq); 
                    return updatedReq;
                }
                return r;
            }));
        }
        
        setIsLoading(false);
        setShowReturnAssetModal(false);
        showToast('รับคืนและอัปเดตสถานะเรียบร้อย');

    } catch (error) {
        setIsLoading(false);
        console.error(error);
        showToast("Error: " + error.message, 'error');
    }
};

// --- LOGIC: UPDATE ASSET (UPDATED: Full History Log) ---
const handleUpdateAsset = async (e) => {
    e.preventDefault();
    
    // 1. Validation
    if (editingAssetItem.status === 'Lost' || editingAssetItem.status === 'Damaged') {
        if (!editingAssetItem.note || editingAssetItem.note.trim() === '') {
            showToast('กรุณาระบุหมายเหตุ (สำหรับสถานะ สูญหาย/ชำรุด)', 'error');
            return;
        }
    }
    
    if (editingAssetItem.status === 'Damaged') {
        if (!editingAssetItem.newImages || editingAssetItem.newImages.length === 0) {
            showToast('กรุณาอัปโหลดรูปภาพความเสียหาย (สำหรับสถานะ ชำรุด)', 'error');
            return;
        }
    }

    setIsLoading(true);

    try {
        const date = new Date().toLocaleString('th-TH');
        // ดึงข้อมูลเก่ามาเปรียบเทียบ
        const originalAsset = assets.find(a => a.id === editingAssetItem.originalId);

        // 2. Upload New Images
        let newUploadedFiles = [];
        if (editingAssetItem.newImages && editingAssetItem.newImages.length > 0) {
            const uploadPromises = editingAssetItem.newImages.map(imgObj => {
                return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(imgObj.file);
                        reader.onload = () => {
                            google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .uploadAssetImage(reader.result, imgObj.file.name);
                        };
                });
            });
            newUploadedFiles = await Promise.all(uploadPromises);
        }

        const mainImage = newUploadedFiles.length > 0 ? newUploadedFiles[0].name : editingAssetItem.image;
        
        // 3. Prepare Updated Data
        const updatedAsset = { 
            ...editingAssetItem, 
            lastUpdated: date,
            image: mainImage,
            images: [], 
            newImages: [] 
        };
        
        // 4. ⭐ Compare Changes (บันทึกประวัติการเปลี่ยนแปลงทั้งหมด) ⭐
        let changes = [];
        if (originalAsset) {
            // เช็ค ID
            if (originalAsset.id !== updatedAsset.id) changes.push(`รหัส: ${originalAsset.id} -> ${updatedAsset.id}`);
            
            // เช็คชื่อ/Serial
            if (originalAsset.name !== updatedAsset.name) changes.push(`ชื่อ: ${originalAsset.name} -> ${updatedAsset.name}`);
            if (originalAsset.serial !== updatedAsset.serial) changes.push(`Serial: ${originalAsset.serial || '-'} -> ${updatedAsset.serial || '-'}`);
            
            // เช็คประเภท (Owner Type)
            if (originalAsset.ownerType !== updatedAsset.ownerType) changes.push(`ประเภท: ${originalAsset.ownerType === 'Company' ? 'ซื้อขาด' : 'เช่า'} -> ${updatedAsset.ownerType === 'Company' ? 'ซื้อขาด' : 'เช่า'}`);

            // เช็คราคา/หน่วย (ตามประเภท)
            if (updatedAsset.ownerType === 'Rent') {
                if (originalAsset.rentalPrice !== updatedAsset.rentalPrice) changes.push(`ค่าเช่า: ${originalAsset.rentalPrice} -> ${updatedAsset.rentalPrice}`);
                if (originalAsset.rentalUnit !== updatedAsset.rentalUnit) changes.push(`หน่วยเช่า: ${originalAsset.rentalUnit} -> ${updatedAsset.rentalUnit}`);
                if (originalAsset.rentalStart !== updatedAsset.rentalStart) changes.push(`เริ่มสัญญา: ${originalAsset.rentalStart||'-'} -> ${updatedAsset.rentalStart||'-'}`);
                if (originalAsset.rentalEnd !== updatedAsset.rentalEnd) changes.push(`สิ้นสุดสัญญา: ${originalAsset.rentalEnd||'-'} -> ${updatedAsset.rentalEnd||'-'}`);
            } else {
                if (originalAsset.price !== updatedAsset.price) changes.push(`ราคาซื้อ: ${originalAsset.price} -> ${updatedAsset.price}`);
            }

            // เช็คสถานะ/ผู้ถือ/หมายเหตุ
            if (originalAsset.status !== updatedAsset.status) changes.push(`สถานะ: ${originalAsset.status} -> ${updatedAsset.status}`);
            if (originalAsset.holder !== updatedAsset.holder) changes.push(`ผู้ถือ: ${originalAsset.holder||'-'} -> ${updatedAsset.holder||'-'}`);
            if (originalAsset.note !== updatedAsset.note) changes.push(`หมายเหตุ: ${originalAsset.note||'-'} -> ${updatedAsset.note||'-'}`);
            
            // เช็ครูปภาพ
            if (newUploadedFiles.length > 0) changes.push(`เปลี่ยนรูปใหม่ (แทนที่รูปเดิม)`);
        }
        
        // ถ้าไม่มีการแก้ไขเลย ให้ใส่ Default
        const changeLog = changes.length > 0 ? changes.join('\n- ') : 'แก้ไขข้อมูล (ไม่มีการเปลี่ยนแปลงค่า)';

        // ⭐ จัดการกรณีเปลี่ยน ID (Change ID Logic)
        if (originalAsset && originalAsset.id !== updatedAsset.id) {
             // 4.1 ลบตัวเก่าออกจาก Sheet
             await new Promise(r => google.script.run.withSuccessHandler(r).deleteDataFromSheet('Assets', originalAsset.id)); 
             
             // 4.2 สั่ง Backend อัปเดต ID ใน Logs
             try {
                  await new Promise(r => google.script.run.withSuccessHandler(r).updateLogItemId(originalAsset.id, updatedAsset.id));
             } catch (e) {
                 console.log("Backend updateLogItemId error:", e);
             }

             // 4.3 อัปเดต State Logs หน้าบ้านทันที
             setInvLogs(prevLogs => prevLogs.map(log => {
                 if (log.assetId === originalAsset.id) {
                     return { ...log, assetId: updatedAsset.id };
                 }
                 return log;
             }));
        }

        // 5. Update Asset State & Save
        setAssets(prev => {
            const filtered = prev.filter(a => a.id !== editingAssetItem.originalId);
            return [...filtered, updatedAsset];
        });
        
        const { images, newImages, originalId, ...assetForServer } = updatedAsset;
        saveAssetToSheet(assetForServer); // บันทึกตัวใหม่

        // 6. Log Action (บันทึกข้อความ ChangeLog ลงไป)
        const logAttachments = newUploadedFiles.map(f => ({ name: f.name, type: 'image/jpeg', url: f.url }));
        
        // ใช้ \n เพื่อขึ้นบรรทัดใหม่ในช่อง Note
        addInvLog('Edit Asset', updatedAsset.name, 'Edit', `แก้ไขข้อมูล:\n- ${changeLog}`, logAttachments, null, updatedAsset.id);
        
        setIsLoading(false);
        setShowEditAssetModal(false);
        setEditingAssetItem(null); 
        showToast('แก้ไขข้อมูลและอัปเดตประวัติเรียบร้อย');

    } catch (error) {
        setIsLoading(false);
        console.error(error);
        showToast("Error: " + error.message, 'error');
    }
};
      
// --- HELPER: คำนวณงบประมาณ (รองรับทั้งแบบกลุ่ม และ ราย Code) ---
const getBudgetStats = (req, identifier, type, isGroup = false) => {
    if (!req || !req.job || !identifier) return { budget: 0, used: 0, pending: 0, current: 0 };
    const projectData = projects.find(p => p.name === req.job);
    if (!projectData) return { budget: 0, used: 0, pending: 0, current: 0 };

    const defs = type === 'SubJob' ? (projectData.subJobs || []) : (projectData.matCodes || []);
    
    // 1. ระบุ Target Codes ที่จะนำมาคำนวณ
    let targetCodes = [];
    let totalBudget = 0;

    if (isGroup) {
        // 🟢 โหมดกลุ่ม: identifier คือชื่อกลุ่ม -> หา Codes ทั้งหมดในกลุ่มนั้น
        targetCodes = defs
            .filter(d => (d.group || 'Others (อื่นๆ)') === identifier)
            .map(d => d.code);
        
        // รวมงบของทั้งกลุ่ม
        totalBudget = defs
            .filter(d => targetCodes.includes(d.code))
            .reduce((sum, d) => sum + (Number(d.budget) || 0), 0);
    } else {
        // 🔵 โหมดรายตัว: identifier คือรหัส Code -> ใช้ Code นั้นตัวเดียว
        targetCodes = [identifier];
        const targetDef = defs.find(d => d.code === identifier);
        totalBudget = targetDef ? (Number(targetDef.budget) || 0) : 0;
    }

    if (targetCodes.length === 0) return { budget: 0, used: 0, pending: 0, current: 0 };

    // 2. ฟังก์ชันคำนวณยอดเงิน (ใช้ Logic: Assets > Logs > Estimate)
    const calculateValue = (r) => {
        // กรองเฉพาะ Item ที่ตรงกับ Target Codes
        const relevantItems = r.items.filter(i => targetCodes.includes(type === 'SubJob' ? i.subJob : i.matCode));
        const isRent = r.type === 'HO' && r.purchaseType === 'Rent';
        
        return relevantItems.reduce((sum, item) => {
            const relatedAssets = assets.filter(a => 
                a.currentRequestId === r.id && 
                a.name === item.name &&
                (a.price === item.unitPrice || a.rentalPrice === item.unitPrice)
            );
            const receivedLogs = item.receivedLog || [];
            
            let itemVal = 0;
            let cnt = 0;

            if (relatedAssets.length > 0) {
                itemVal += relatedAssets.reduce((s, asset) => {
                    const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                    const duration = isRent ? (asset.duration || item.duration || 1) : 1;
                    return s + (price * duration);
                }, 0);
                cnt = relatedAssets.length;
            } else if (receivedLogs.length > 0) {
                itemVal += receivedLogs.reduce((s, log) => {
                    const duration = isRent ? (log.duration || 1) : 1;
                    return s + (log.qty * log.price * duration);
                }, 0);
                cnt = item.receivedTotal || 0;
            }

            if (r.status !== 'Completed') {
                const rem = Math.max(0, item.qty - cnt);
                const dur = isRent ? (item.duration || 1) : 1;
                itemVal += (rem * (item.unitPrice || 0) * dur);
            }
            return sum + itemVal;
        }, 0);
    };

    // 3. วนลูปคำนวณยอดสะสมจากทุก Request
    let used = 0;
    let pending = 0;
    let current = 0;

    requests.forEach(r => {
        if (r.job !== req.job || !['Local', 'HO'].includes(r.type)) return;
        
        const val = calculateValue(r);

        if (r.id === req.id) {
            current += val;
        } else if (r.status === 'Completed') {
            used += val;
        } else if (!['Draft', 'Rejected', 'Returned'].includes(r.status)) {
            pending += val;
        }
    });

    return { budget: totalBudget, used, pending, current };
};

  // 1. ฟังก์ชันเปิดไฟล์ (รองรับทั้ง URL และ Base64)
// --- HELPER: FILE VIEWING (UPDATED) ---
  const handleViewFile = (fileData, fileName) => {
    if (!fileData) {
      showToast('ไม่พบข้อมูลไฟล์', 'error');
      return;
    }
    
    // 🟢 กรณี 1: ข้อมูลเป็น Object (มาจาก Google Drive Upload)
    if (typeof fileData === 'object' && fileData.url) {
      window.open(fileData.url, '_blank');
      return;
    }

    // 🟢 กรณี 2: ข้อมูลเป็น String
    if (typeof fileData === 'string') {
        // 2.1 เป็น URL (http/https)
        if (fileData.startsWith('http')) {
            window.open(fileData, '_blank');
        } 
        // 2.2 เป็น Base64 (ไฟล์รูป/PDF ที่ฝังมา)
        else if (fileData.startsWith('data:') || fileData.includes('base64')) {
            const newWindow = window.open();
            if (newWindow) {
                newWindow.document.write(`
                    <html>
                    <head><title>${fileName || 'Document'}</title></head>
                    <body style="margin:0; background: #f0f0f0; display: flex; justify-content: center; height: 100vh;">
                        <iframe src="${fileData}" style="width:100%; height:100%; border:none;"></iframe>
                    </body>
                    </html>
                `);
            }
        } 
        // 2.3 เป็นชื่อไฟล์จำลอง (Mock Data)
        else {
            showToast(`[Mock] จำลองการเปิดไฟล์: ${fileData}`, 'info');
        }
    }
  };

  // 2. ฟังก์ชันตรวจสอบผล (Logic: True = ผ่าน, False = ไม่ผ่าน)
  const isVerificationPass = () => {
      const { checks } = verificationData;
      // ต้องเป็น True ครบทุกข้อถึงจะผ่าน
      return checks.quotation && checks.email && checks.details;
  };

// --- LOGIC: UPDATE ASSET IMAGE (NEW) ---
      const handleUpdateImage = async (e) => {
          if (!e.target.files || e.target.files.length === 0) return;
          if (!viewingItem) return;

          const file = e.target.files[0];
          setIsLoading(true); // หมุนๆ รอ

          try {
              const base64 = await fileToBase64(file);
              // เรียก Server function ตัวใหม่ที่สร้างไว้
              const result = await new Promise((resolve, reject) => {
                  google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .uploadAssetImage(base64, file.name); 
              });

              if (result.error) throw new Error(result.error);

              // 1. อัปเดตข้อมูลใน State (Assets หรือ Inventory)
              const date = new Date().toLocaleString('th-TH');
              const updatedItem = { 
                  ...viewingItem, 
                  image: result.name, // อัปเดตชื่อไฟล์รูปปัจจุบัน
                  lastUpdated: date 
              };

              // อัปเดตใน List หลัก
              if (viewingItem.serial !== undefined) {
                  // เป็น Asset
                  setAssets(prev => prev.map(a => a.id === viewingItem.id ? updatedItem : a));
                  saveAssetToSheet(updatedItem);
              } else {
                  // เป็น Inventory
                  setInventory(prev => prev.map(i => i.id === viewingItem.id ? updatedItem : i));
                  saveInventoryToSheet(updatedItem);
              }

              // 2. บันทึก Log ว่ามีการอัปเดตรูป
              addInvLog('Update Image', viewingItem.name, 'Photo', 'อัปเดตรูปภาพล่าสุด', [{name: result.name, type: 'image/jpeg'}]);

              // 3. อัปเดตหน้าจอที่ดูอยู่
              setViewingItem(updatedItem);
              setPreviewImage(null); // Reset preview ให้โชว์รูปใหม่
              
              showToast('อัปเดตรูปภาพเรียบร้อย');

          } catch (err) {
              console.error(err);
              showToast('อัปโหลดรูปภาพล้มเหลว', 'error');
          } finally {
              setIsLoading(false);
          }
      };

// --- LOGIC: VERIFICATION (FIXED & UPDATED) ---
const openVerificationModal = (reqId, isChangeMode = false) => { // ⭐ รับ param เพิ่ม
    const req = requests.find(r => r.id === reqId);
    if(!req) return;

    // ตรวจสอบว่ามีไฟล์แนบหรือไม่ (แปลงเป็น Boolean)
    const hasQuotation = !!req.quotation;
    const hasEmail = !!req.attachment;
    
    setVerificationData({
        requestId: reqId,
        isChangeMode: isChangeMode, // ⭐ บันทึกสถานะว่าเป็นการเปลี่ยน Local -> HO
        filesExist: { 
            quotation: hasQuotation, 
            email: hasEmail 
        },
        checks: { 
            // ถ้าเป็นโหมดเปลี่ยน ให้ Default เป็น False (เพื่อให้ติ๊กเลือกเองว่าเอาอะไรบ้าง)
            // แต่ถ้ามีไฟล์อยู่แล้ว ให้ True
            quotation: hasQuotation ? true : (isChangeMode ? false : false), 
            email: hasEmail ? true : (isChangeMode ? false : false), 
            details: true 
        },

needApproval: req.isPreviouslyApproved ? false : !hasEmail, 
    
    needContract: req.purchaseType === 'Rent', 
    note: ''
    });
    
    // เปิดหน้าต่าง
    setShowVerificationModal(true);
};

// [ค้นหาฟังก์ชัน handleConfirmVerification เดิม แล้วแทนที่ด้วยโค้ดนี้]

// [index.html] ฟังก์ชัน handleConfirmVerification (ประมาณบรรทัด 1340)

const handleConfirmVerification = () => {
    const { requestId, needApproval, needContract, note, checks, filesExist, isChangeMode } = verificationData;
    const req = requests.find(r => r.id === requestId);
    if (!req) return;
    
    const actionBy = user ? `${user.empId} ${user.firstName} ${user.lastName}` : currentUserRole;
    let updatedReq = null;
    let toastMessage = '';
    let toastType = 'success';

// 🔴 1. กรณีตรวจสอบ "ไม่ผ่าน" -> ส่งคืนแก้ไข (Revise Needed)
    if (!isVerificationPass()) {
         let failureReasons = [];
         if (!checks.quotation) failureReasons.push(filesExist.quotation ? "ใบเสนอราคาไม่ถูกต้อง" : "ขาดใบเสนอราคา");
         if (!checks.email) failureReasons.push(filesExist.email ? "เมลอนุมัติไม่ถูกต้อง" : "ขาดเมลอนุมัติ");
         if (!checks.details) failureReasons.push("รายละเอียดสินค้า/ราคาไม่ถูกต้อง");
         const combinedNote = `สิ่งที่ต้องแก้ไข: ${failureReasons.join(', ')} ${note ? `(เพิ่มเติม: ${note})` : ''}`;
         
         if (isChangeMode) {
             // ⭐⭐ กรณีเปลี่ยนเป็น HO: ใช้ handleUpdateStatus เพื่อให้ Backend สร้างเลข HPO ทันที
             // ฟังก์ชันนี้จะส่งข้อมูลไป Backend -> Backend สร้างเลข -> ส่งกลับมาอัปเดตหน้าจออัตโนมัติ
             handleUpdateStatus(
                 req.id, 
                 'Revise Needed', 
                 combinedNote, 
                 [], 
                 { 
                     type: 'HO', 
                     // สั่งเคลียร์เลขเดิม (เพื่อให้ Backend รู้ว่าต้องสร้างเลขใหม่)
                     docNumber: null, 
                     isPreviouslyApproved: true 
                 }
             );
         } else {
             // กรณีปกติ (ไม่ได้เปลี่ยนประเภท): ใช้ Logic เดิมบันทึกทับได้เลย
             updatedReq = { 
                 ...req, 
                 status: 'Revise Needed', 
                 history: [...req.history, createLog('Return for Revision', actionBy, combinedNote)] 
             };
             saveRequestToSheet(updatedReq);
             setRequests(prev => prev.map(r => r.id === updatedReq.id ? updatedReq : r));
             showToast('ส่งคืนเอกสารให้ผู้ขอแก้ไขเรียบร้อย', 'error');
         }
    }
    // 🟢 2. กรณีตรวจสอบ "ผ่าน" (Pass)
    else {
         if (!filesExist.email && !needApproval) {
             showToast("ไม่พบไฟล์เมลอนุมัติ: กรุณาติ๊กเลือก 'ต้องขออนุมัติจาก Level 1/Level 2 เพิ่มเติม (Full Flow)'", 'error');
             return; 
         }

        if (isChangeMode) {
    handleUpdateStatus(
        req.id, 
        'Approved', 
        `เปลี่ยนเป็น HO และตรวจสอบผ่านแล้ว: ${note}`, 
        [], 
        { 
            type: 'HO', 
            purchaseType: 'Buy', 
            needContract: needContract, 
            docNumber: null, // ⭐ ต้องแน่ใจว่าบรรทัดนี้อยู่ตรงนี้
            isPreviouslyApproved: true, 
            isFullApprovalFlow: true 
        }
    );


         }
         else if (needApproval) {
             
             handleUpdateStatus(
                 req.id, 
                 'Pending Head', 
                 `ส่งต่ออนุมัติ: ${note}`, 
                 [], 
                 { isFullApprovalFlow: true, needContract: needContract }
             );
         } 
         else {
             // กรณีปกติ: ผ่านเลย
             handleUpdateStatus(
                 req.id, 
                 'Approved', 
                 `ตรวจสอบผ่าน: ${note}`, 
                 [], 
                 { needContract: needContract }
             );
         }
    }

    if (updatedReq) {
        showToast(toastMessage, toastType);
    }
    setShowVerificationModal(false);
};


      const handleChecklistChange = (field) => {
          setVerificationData(prev => ({...prev, checks: {...prev.checks, [field]: !prev.checks[field]}}));
      };
      





      const handleApprovalUpdate = (id, newStatus) => { handleUpdateStatus(id, newStatus); };


// --- 1. แก้ไขการเตรียมข้อมูล (Initialize Data) ---
const openReceiveModal = (req) => {
    const defaultTarget = req.type === 'HO' ? 'Asset' : 'Inventory';
    
    const items = req.items.map(item => {
        const receivedSoFar = item.receivedTotal || 0;
        const remaining = Math.max(0, item.qty - receivedSoFar);
        
        // เตรียม Array รายการย่อย (Assets)
        const assetsReg = Array.from({ length: remaining }, (_, i) => ({ 
            id: '', 
            isAutoId: false, 
            serial: '', 
            name: item.name, 
            note: '', 
            images: [],
            price: item.unitPrice, 
            unit: item.unit || 'ชิ้น', // ⭐ เพิ่ม: กำหนดหน่วยนับเริ่มต้นให้แต่ละชิ้น
            rentalStart: '', 
            rentalEnd: '', 
            rentalPrice: req.purchaseType === 'Rent' ? item.unitPrice : 0, 
            rentalUnit: 'Month' 
        }));

        const existingInv = inventory.find(inv => inv.name === item.name && inv.project === req.job);
        const defaultInvId = existingInv ? existingInv.id : '';
        const defaultAuto = !existingInv;

        return { 
            ...item,
            originalName: item.name, 
            targetType: defaultTarget, 
            receiveImages: [], 
            assetsToRegister: assetsReg, 
            isRent: req.purchaseType === 'Rent', 
            receivedQty: remaining, 
            actualPrice: item.unitPrice,
            // ⭐ ใช้ unit จาก item เป็นค่าเริ่มต้นสำหรับ Inventory
            unit: item.unit || 'ชิ้น', 
            orderedQty: item.qty,
            receivedSoFar: receivedSoFar,
            inventoryId: defaultInvId,
            isInvAutoId: defaultAuto
        };
    });

    setReceiveItems(items);
    setIsForceClose(false);
    setSelectedRequest(req);
    setShowReceiveGoodsModal(true);
};
// --- LOGIC: CONFIRM RECEIVE (Auto Gen Support) ---
const handleConfirmReceive = async () => {
    if (!selectedRequest) return;

    setIsLoading(true);
    try {
        const date = new Date().toLocaleString('th-TH');
        const project = selectedRequest.job;
        
        // ⭐ เตรียม List ชั่วคราวสำหรับเช็คเลขรัน (เหมือน Import)
        let currentInvList = [...inventory];
        let runNoCount = inventory.length;

        for (const item of receiveItems) {
            if (item.targetType === 'Inventory') {
                
                // ... (ส่วน Upload Image คงเดิม) ...
                let logImages = [];
                if (item.receiveImages && item.receiveImages.length > 0) {
                    const uploadPromises = item.receiveImages.map(imgObj => {
                        return new Promise((resolve, reject) => {
                           google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).uploadAssetImage(imgObj.base64, imgObj.name);
                        });
                    });
                    const uploaded = await Promise.all(uploadPromises);
                    logImages = uploaded.map(u => ({ name: u.name, type: 'image/jpeg', url: u.url }));
                }

                const qtyToReceive = item.receivedQty;
                const targetType = 'System'; // รับของ = System เสมอ

                // 2. เช็คของเดิม
                const existingIndex = currentInvList.findIndex(inv => 
                    inv.name === item.name && 
                    inv.project === project && 
                    (inv.stockType === targetType || (!inv.stockType && targetType === 'System'))
                );

                const existing = existingIndex !== -1 ? currentInvList[existingIndex] : null;
                const mainImageName = logImages.length > 0 ? logImages[0].name : (existing ? existing.image : null);

                if (existing) {
                    // ✅ MERGE
                    const updatedInv = { 
                        ...existing, 
                        id: existing.id, 
                        qty: existing.qty + qtyToReceive, 
                        lastUpdated: date, 
                        image: mainImageName 
                    };
                    
                    // อัปเดต List ชั่วคราว และบันทึก
                    currentInvList[existingIndex] = updatedInv;
                    await saveInventoryToSheet(updatedInv);
                    await addInvLog('Stock In (Merge)', item.name, `+${qtyToReceive}`, `รับเข้าโครงการ ${project} (System)`, logImages, selectedRequest.id, existing.id);

                } else {
                    // ✅ NEW ITEM (ต้อง Gen ID)
                    let baseId = item.inventoryId; // ลองดูว่ามีรหัสกรอกมาไหม
                    
                    if (item.isInvAutoId || !baseId) {
                        runNoCount++;
                        baseId = `INV-${String(runNoCount).padStart(3, '0')}`;
                        // เช็คซ้ำใน List ชั่วคราว
                        while (currentInvList.some(inv => getDisplayId(inv.id) === baseId)) {
                            runNoCount++;
                            baseId = `INV-${String(runNoCount).padStart(3, '0')}`;
                        }
                    }

                    // สร้าง ID เต็ม
                    const finalInvId = `${baseId}|${project}|${targetType}`;

                    const newInv = { 
                        id: finalInvId, 
                        name: item.name, 
                        qty: qtyToReceive, 
                        unit: item.unit || 'หน่วย', 
                        minStock: 0, 
                        price: item.actualPrice, 
                        lastUpdated: date, 
                        image: mainImageName,
                        project: project,
                        stockType: targetType
                    };
                    
                    currentInvList.push(newInv); // เพิ่มเข้า List
                    await saveInventoryToSheet(newInv);
                    await addInvLog('Stock In (New)', item.name, `Start: ${qtyToReceive}`, `โครงการ ${project} (System)`, logImages, selectedRequest.id, finalInvId);
                }
            }
             else {
                // --- กรณี Asset ---
                const assetsToProcess = item.assetsToRegister.slice(0, qtyToReceive);
                for (const assetReg of assetsToProcess) {
                    currentAssetCount++;
                    let assetLogImages = [];
                    // ... (Image Upload Logic เหมือนเดิม) ...
                    if (assetReg.images && assetReg.images.length > 0) {
                        const uploadPromises = assetReg.images.map(imgObj => {
                            return new Promise((resolve, reject) => {
                                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).uploadAssetImage(imgObj.base64, imgObj.name);
                            });
                        });
                        const uploaded = await Promise.all(uploadPromises);
                        assetLogImages = uploaded.map(u => ({ name: u.name, type: 'image/jpeg', url: u.url }));
                    }

                    const assetId = assetReg.isAutoId 
                        ? `AST-${new Date().getFullYear().toString().slice(-2)}${(new Date().getMonth()+1).toString().padStart(2,'0')}-${String(currentAssetCount).padStart(3,'0')}` 
                        : assetReg.id;
                    const mainImageName = assetLogImages.length > 0 ? assetLogImages[0].name : null;
                    
                    const newAsset = { 
    id: assetId,
    name: assetReg.name,
    serial: assetReg.serial,
    status: 'Available',
    condition: 'Good',
    holder: '-',
    currentRequestId: selectedRequest.id,
    price: item.isRent ? 0 : assetReg.price,
    // ⭐ บันทึกหน่วยนับที่แก้ไขแล้ว (ถ้าไม่มีให้ใช้ unit ของ assetReg หรือ default)
    unit: assetReg.unit || 'ชิ้น', 
    image: mainImageName,
    lastUpdated: date,
    ownerType: item.isRent ? 'Rent' : 'Company',
    rentalStart: assetReg.rentalStart || null,
    rentalEnd: assetReg.rentalEnd || null,
    rentalPrice: assetReg.rentalPrice || 0,
    rentalUnit: assetReg.rentalUnit || 'Month',
    duration: item.isRent ? (assetReg.duration || 1) : 1,
    note: assetReg.note,
    project: project
};
                    setAssets(prev => [...prev, newAsset]);
                    saveAssetToSheet(newAsset);
                    addInvLog('Register Asset', newAsset.name, 'New', `ลงทะเบียนเข้าโครงการ ${project}`, assetLogImages, selectedRequest.id, assetId);
                }
            }
        }

// Update Request Status (คงเดิม)
        const updatedItems = selectedRequest.items.map(originalItem => {
            const receivingItem = receiveItems.find(ri => ri.originalName === originalItem.name);
            if (receivingItem && receivingItem.receivedQty > 0) {
                 return { ...originalItem, receivedTotal: (originalItem.receivedTotal || 0) + receivingItem.receivedQty };
            }
            return originalItem;
        });

        const allComplete = updatedItems.every(item => (item.receivedTotal || 0) >= item.qty);
        let newStatus = 'Completed';
        if (!allComplete && !isForceClose) newStatus = 'Partially Received';

        const updatedReq = { 
             ...selectedRequest, 
             items: updatedItems,
             status: newStatus,
             history: [...selectedRequest.history, createLog(STATUS_LABELS[newStatus] || newStatus, `${user.empId} ${user.firstName}`, `รับของเพิ่ม (สถานะ: ${newStatus})`)]
        };
        await saveRequestToSheet(updatedReq);
        setRequests(prev => prev.map(r => r.id === updatedReq.id ? updatedReq : r));
        setInventory(currentInvList); // อัปเดต Inventory State ล่าสุด

        setIsLoading(false);
        setShowReceiveGoodsModal(false);
        showToast('บันทึกการรับของเรียบร้อย');
    } catch (error) {
        setIsLoading(false);
        console.error(error);
        showToast("Error: " + error.message, 'error');
    }
};
      // --- Helper: จัดการรูปภาพในหน้ารับของ (เพิ่ม/ลบ) ---
      
      // 1. ฟังก์ชันเลือกรูป (รองรับทั้ง Inventory และ Asset รายตัว)
      const handleReceiveImageSelect = async (e, itemIdx, assetIdx = null) => {
          if (!e.target.files || e.target.files.length === 0) return;
          
          // แปลงไฟล์เป็น Base64 เพื่อแสดงตัวอย่าง
          const files = Array.from(e.target.files);
          const newImages = await Promise.all(files.map(file => new Promise(resolve => {
              const reader = new FileReader();
              reader.onload = (x) => resolve({ base64: x.target.result, file, name: file.name });
              reader.readAsDataURL(file);
          })));

          setReceiveItems(prev => {
              const newData = [...prev];
              if (assetIdx === null) {
                  // กรณี: Inventory (เพิ่มรูปเข้า Array ของสินค้านั้น)
                  const current = newData[itemIdx].receiveImages || [];
                  newData[itemIdx].receiveImages = [...current, ...newImages];
              } else {
                  // กรณี: Asset รายตัว
                  const current = newData[itemIdx].assetsToRegister[assetIdx].images || [];
                  newData[itemIdx].assetsToRegister[assetIdx].images = [...current, ...newImages];
              }
              return newData;
          });
          
          e.target.value = ''; // Reset input
      };

      // 2. ฟังก์ชันลบรูป
      const handleRemoveReceiveImage = (itemIdx, imgIdx, assetIdx = null) => {
          setReceiveItems(prev => {
              const newData = [...prev];
              if (assetIdx === null) {
                  // ลบรูป Inventory
                  newData[itemIdx].receiveImages = newData[itemIdx].receiveImages.filter((_, i) => i !== imgIdx);
              } else {
                  // ลบรูป Asset
                  newData[itemIdx].assetsToRegister[assetIdx].images = newData[itemIdx].assetsToRegister[assetIdx].images.filter((_, i) => i !== imgIdx);
              }
              return newData;
          });
      };    


// --- Helper: จัดการรูปภาพในหน้า "สร้างคำขอ" (tempItem) ---
      const handleTempItemImageSelect = async (e) => {
          if (!e.target.files || e.target.files.length === 0) return;
          
          const files = Array.from(e.target.files);
          const newImages = await Promise.all(files.map(file => new Promise(resolve => {
              const reader = new FileReader();
              reader.onload = (x) => resolve({ base64: x.target.result, file, name: file.name });
              reader.readAsDataURL(file);
          })));

          setTempItem(prev => ({
              ...prev,
              images: [...(prev.images || []), ...newImages]
          }));
          
          e.target.value = ''; // Reset input
      };

      const handleRemoveTempItemImage = (index) => {
          setTempItem(prev => ({
              ...prev,
              images: prev.images.filter((_, i) => i !== index)
          }));
      };

      // --- LOGIC: OPEN DISBURSE MODAL (UPDATED: SPLIT STOCK) ---
const openDisburseModal = (reqId) => {
    const req = requests.find(r => r.id === reqId);
    if (!req) return;

    // เตรียมรายการสินค้า พร้อมเช็คสต็อกแยกประเภท
    const itemsWithSplit = req.items.map(item => {
        // 1. หาสต็อก "ในระบบ" (System)
        const sysStock = inventory.find(i => 
            i.name === item.name && 
            i.project === req.job && 
            (i.stockType === 'System' || !i.stockType) // Default System
        );
        
        // 2. หาสต็อก "นอกระบบ" (NonSystem)
        const nonStock = inventory.find(i => 
            i.name === item.name && 
            i.project === req.job && 
            i.stockType === 'NonSystem'
        );

        const sysQtyAvailable = sysStock ? sysStock.qty : 0;
        const nonQtyAvailable = nonStock ? nonStock.qty : 0;

        // 3. Logic: Default ให้ตัด "ในระบบ" ก่อน ถ้าไม่พอค่อยไป "นอกระบบ"
        let useSys = 0;
        let useNon = 0;

        if (sysQtyAvailable >= item.qty) {
            useSys = item.qty;
        } else {
            useSys = sysQtyAvailable; // เอาเท่าที่มี
            // ส่วนที่ขาด ให้ไปลองตัดนอกระบบ (แต่ต้องไม่เกินที่มี)
            const needed = item.qty - useSys;
            useNon = Math.min(needed, nonQtyAvailable);
        }

        return {
            ...item,
            // เก็บข้อมูลสต็อกคงเหลือไว้โชว์
            sysStockId: sysStock ? sysStock.id : null,
            nonStockId: nonStock ? nonStock.id : null,
            sysAvailable: sysQtyAvailable,
            nonAvailable: nonQtyAvailable,
            // ค่าที่จะจ่ายจริง (แก้ไขได้)
            useSys: useSys,
            useNon: useNon
        };
    });

    setDisburseItems(itemsWithSplit);
    setDisburseData({ requestId: reqId, note: '', images: [] });
    setShowDisburseModal(true);
};



      
      // --- HELPER: จัดการรูปภาพหน้าจ่ายของ (Disburse) ---
const handleDisburseImageSelect = async (e) => {
    if (!e.target.files || e.target.files.length === 0) return;
    const files = Array.from(e.target.files);
    const newImages = await Promise.all(files.map(file => new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = (x) => resolve({ base64: x.target.result, file, name: file.name });
        reader.readAsDataURL(file);
    })));
    setDisburseData(prev => ({
        ...prev,
        images: [...(prev.images || []), ...newImages]
    }));
    e.target.value = ''; // Reset input
};

const handleRemoveDisburseImage = (index) => {
    setDisburseData(prev => ({
        ...prev,
        images: prev.images.filter((_, i) => i !== index)
    }));
};


// --- LOGIC: CONFIRM DISBURSE (UPDATED: SPLIT DEDUCTION & INDIVIDUAL LOGS) ---
const handleConfirmDisburse = async () => {
    const req = requests.find(r => r.id === disburseData.requestId);
    if (!req) return;

    // --- Validation 1: เช็คยอดรวมเทียบกับ Order (เหมือนเดิม) ---
    if (req.type === 'Withdraw') {
        const mismatchItems = disburseItems.filter(item => (item.useSys + item.useNon) !== item.qty);
        if (mismatchItems.length > 0) {
            const msg = mismatchItems.map(i => `- ${i.name}: สั่ง ${i.qty} แต่จ่ายรวม ${i.useSys + i.useNon}`).join('\n');
            if (!confirm(`⚠️ คำเตือน: จำนวนจ่ายไม่ตรงกับคำขอ\n\n${msg}\n\nยืนยันที่จะบันทึกยอดตามจริงหรือไม่?`)) return;
        }

        // ⭐⭐ [เพิ่มใหม่] Validation 2: เช็คยอดเกินสต็อก (Over Stock) ⭐⭐
        const overStockItems = [];
        disburseItems.forEach(item => {
            if (item.useSys > item.sysAvailable) {
                overStockItems.push(`- ${item.name} (ในระบบ): กรอก ${item.useSys} / มี ${item.sysAvailable}`);
            }
            if (item.useNon > item.nonAvailable) {
                overStockItems.push(`- ${item.name} (นอกระบบ): กรอก ${item.useNon} / มี ${item.nonAvailable}`);
            }
        });

        if (overStockItems.length > 0) {
            alert(`❌ ไม่สามารถบันทึกได้ เนื่องจากยอดเกินคลังสินค้า:\n\n${overStockItems.join('\n')}\n\nกรุณาแก้ไขจำนวนให้ถูกต้อง`);
            return; // หยุดการทำงานทันที
        }
    }

    setIsLoading(true);
    try {
        // Upload Images (เหมือนเดิม)
        let logImages = [];
        if (disburseData.images && disburseData.images.length > 0) {
            const uploadPromises = disburseData.images.map(imgObj => {
                return new Promise((resolve, reject) => {
                    google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).uploadAssetImage(imgObj.base64, imgObj.name);
                });
            });
            const uploaded = await Promise.all(uploadPromises);
            logImages = uploaded.map(u => ({ name: u.name, type: 'image/jpeg', url: u.url }));
        }

// ============================
        // 🟢 กรณี 1: Withdraw (ตัดสต็อกแยกประเภท)
        // ============================
        if (req.type === 'Withdraw') {
            const currentInv = [...inventory];
            let logDetails = [];

            for (const item of disburseItems) {
                let itemLogParts = [];

                // A. ตัดสต็อก ในระบบ
                if (item.useSys > 0 && item.sysStockId) {
                    const targetIdx = currentInv.findIndex(i => i.id === item.sysStockId);
                    if (targetIdx !== -1) {
                        const updated = { 
                            ...currentInv[targetIdx], 
                            qty: Math.max(0, currentInv[targetIdx].qty - item.useSys),
                            lastUpdated: new Date().toLocaleString('th-TH')
                        };
                        currentInv[targetIdx] = updated;
                        // Sync Backend
                        await new Promise(r => google.script.run.withSuccessHandler(r).syncInventory(updated));
                        
                        // ⭐ [เพิ่มใหม่] บันทึก Log เข้าประวัติของสินค้าตัวนี้ (ในระบบ)
                        await addInvLog(
                            'Withdraw', 
                            item.name, 
                            `-${item.useSys}`, 
                            `จ่ายของ (ในระบบ) อ้างอิง: ${req.docNumber || req.id}`, 
                            [], 
                            req.id, 
                            item.sysStockId // 👈 สำคัญ: ส่ง ID สินค้าไปด้วย เพื่อให้มันไปโผล่ในหน้าประวัติรายตัว
                        );

                        itemLogParts.push(`ในระบบ: ${item.useSys}`);
                    }
                }

                // B. ตัดสต็อก นอกระบบ
                if (item.useNon > 0 && item.nonStockId) {
                    const targetIdx = currentInv.findIndex(i => i.id === item.nonStockId);
                    if (targetIdx !== -1) {
                        const updated = { 
                            ...currentInv[targetIdx], 
                            qty: Math.max(0, currentInv[targetIdx].qty - item.useNon),
                            lastUpdated: new Date().toLocaleString('th-TH')
                        };
                        currentInv[targetIdx] = updated;
                        // Sync Backend
                        await new Promise(r => google.script.run.withSuccessHandler(r).syncInventory(updated));

                        // ⭐ [เพิ่มใหม่] บันทึก Log เข้าประวัติของสินค้าตัวนี้ (นอกระบบ)
                        await addInvLog(
                            'Withdraw', 
                            item.name, 
                            `-${item.useNon}`, 
                            `จ่ายของ (นอกระบบ) อ้างอิง: ${req.docNumber || req.id}`, 
                            [], 
                            req.id, 
                            item.nonStockId // 👈 สำคัญ: ส่ง ID สินค้าไปด้วย
                        );

                        itemLogParts.push(`นอกระบบ: ${item.useNon}`);
                    }
                }

                // เก็บข้อความสรุปไว้ใช้ตอนท้าย (เหมือนเดิม)
                if (itemLogParts.length > 0) {
                    const totalPaid = (item.useSys || 0) + (item.useNon || 0);
                    const diffMsg = totalPaid !== item.qty ? ` (ไม่ครบ/เกิน: สั่ง ${item.qty})` : '';
                    logDetails.push(`${item.name} รวม ${totalPaid}${diffMsg} [${itemLogParts.join(', ')}]`);
                }
            }
            
            setInventory(currentInv);

            // 3. บันทึก History รวม (อันนี้คืออันที่ User เห็นในหน้า All Logs)
            const finalNote = `จ่ายของโครงการ ${req.job}:\n` + logDetails.join('\n') + (disburseData.note ? `\nNote: ${disburseData.note}` : '');
            
            // ⭐ Log นี้ไม่ต้องใส่ Asset ID เพื่อให้เป็น Log กลางของ Request นี้
            await addInvLog('Withdraw', 'Multiple Items', 'Out', finalNote, logImages, req.id);
        }
        
        // ============================
        // 🔵 กรณี 2: Borrow (เหมือนเดิม)
        // ============================
        else if (req.type === 'Borrow') {
            const targetAssetsMap = new Map();
            req.items.forEach(item => {
                if (item.assetId) targetAssetsMap.set(item.assetId, item);
            });

            const updatedAssets = assets.map(asset => {
                if (targetAssetsMap.has(asset.id)) {
                    const item = targetAssetsMap.get(asset.id);
                    return { 
                        ...asset, 
                        status: 'Borrowed', 
                        holder: req.requester, 
                        currentRequestId: req.id, 
                        lastUpdated: new Date().toLocaleString('th-TH'),
                        image: logImages.length > 0 ? logImages[0].name : asset.image 
                    };
                }
                return asset;
            });

            for (const asset of updatedAssets) {
                if (targetAssetsMap.has(asset.id)) {
                    await new Promise(r => google.script.run.withSuccessHandler(r).syncAsset(asset));
                    await addInvLog('Borrow', asset.name, 'Out', `ยืมโดย ${req.requester} (Type: ${asset.ownerType})`, logImages, req.id, asset.id);
                }
            }
            setAssets(updatedAssets);
        }

        const updatedItems = req.items.map((item, idx) => {
            const dItem = disburseItems[idx]; // จับคู่ด้วยลำดับ (Index)
            let totalPaid = 0;

            if (req.type === 'Withdraw') {
                // กรณีเบิก: รวมยอด ในระบบ + นอกระบบ
                totalPaid = (dItem.useSys || 0) + (dItem.useNon || 0);
            } else {
                // กรณียืม: จ่ายเต็มตามจำนวน (เพราะเลือกรายชิ้น)
                totalPaid = item.qty;
            }

            return { ...item, receivedTotal: totalPaid }; // บันทึกยอด
        });

        // 4. Update Request Status
        handleUpdateStatus(req.id, 'Completed', `จ่ายของ/ยืมของเรียบร้อย ${disburseData.note}`, logImages, { items: updatedItems });
        
        setShowDisburseModal(false);
        showToast('บันทึกข้อมูลเรียบร้อย');

    } catch (err) {
        console.error(err);
        showToast("เกิดข้อผิดพลาด: " + err.message, 'error');
    } finally {
        setIsLoading(false);
    }
};
      const openRejectModal = (reqId) => { setRejectData({ requestId: reqId, reason: '' }); setShowRejectModal(true); };
      const handleConfirmReject = () => { handleUpdateStatus(rejectData.requestId, 'Rejected', `ไม่อนุมัติ: ${rejectData.reason}`); setShowRejectModal(false); showToast('บันทึกการไม่อนุมัติเรียบร้อย'); };

// --- Helper: Update Status & History (SECURE VERSION) ---
      const handleUpdateStatus = async (id, newStatus, note = '', images = [], extraUpdates = null) => {
        setIsLoading(true); // แสดงสถานะกำลังโหลด
        
        const userSignature = `${user.empId} ${user.firstName} ${user.lastName}`;
        const logObj = createLog(STATUS_LABELS[newStatus] || newStatus, userSignature, note, images);

        try {
            // ⭐ เรียกใช้ฟังก์ชันใหม่ที่ Backend
            const result = await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .updateStatusSecurely(id, newStatus, logObj, extraUpdates);
            });

            if (result.success) {
                // อัปเดตข้อมูลหน้าเว็บด้วยข้อมูลล่าสุดจาก Server (ที่มี Doc No. แล้ว)
                const updatedReq = result.request;
                
                setRequests(prev => prev.map(r => r.id === id ? updatedReq : r));
                if (selectedRequest && selectedRequest.id === id) setSelectedRequest(updatedReq);
                
                // แจ้งเตือนผู้ใช้
                const docMsg = updatedReq.docNumber ? ` (เลขที่: ${updatedReq.docNumber})` : '';
                showToast(`อัปเดตสถานะเรียบร้อย${docMsg}`);
            } else {
                showToast(`เกิดข้อผิดพลาด: ${result.message}`, 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Error: ' + err.message, 'error');
        } finally {
            setIsLoading(false); // ปิดสถานะโหลด
        }
      };

      const openPRModal = (id) => { setPrData({ requestId: id, file: null, prNumber: '' }); setShowPRModal(true); };


const handleSubmitPR = async () => { 
        if (!prData.prNumber && !prData.file) { showToast('กรุณาระบุเลขที่หรือแนบไฟล์', 'error'); return; }
        
        setIsLoading(true); // เริ่มโหลด
        let uploadedFile = null;

        try {
            // 1. อัปโหลดไฟล์ (ถ้ามี)
            if (prData.file) {
                const base64 = await fileToBase64(prData.file);
                const result = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .uploadFileToDrive(base64, prData.file.name);
                });
                
                if (result.error) throw new Error(result.error);
                uploadedFile = result; // ได้ object {name, url, id} กลับมา
            }

            const note = `PR: ${prData.prNumber}`;
            
            // 2. อัปเดตข้อมูล
setRequests(prev => prev.map(r => {
                if (r.id === prData.requestId) {
                    const updatedReq = { 
                        ...r, 
                        status: 'PR Issued', 
                        prFile: uploadedFile || r.prFile,
                        prNumber: prData.prNumber,
                        // ⭐ แก้ตรงนี้
                        history: [...r.history, createLog('PR Issued', `${user.empId} ${user.firstName} ${user.lastName}`, note)] 
                    };
                    saveRequestToSheet(updatedReq);
                    return updatedReq;
                }
                return r;
            }));

            setShowPRModal(false); 
            showToast('บันทึกและอัปโหลด PR เรียบร้อย');

        } catch (err) {
            console.error(err);
            showToast('เกิดข้อผิดพลาดในการอัปโหลด: ' + err.message, 'error');
        } finally {
            setIsLoading(false);
        }
      };

      const openPOModal = (id) => { setPoData({ requestId: id, file: null, poNumber: '' }); setShowPOModal(true); };

// --- LOGIC: ISSUE PO (UPDATED: Upload File) ---
      const handleSubmitPO = async () => { 
        if (!poData.poNumber && !poData.file) { showToast('กรุณาระบุเลขที่หรือแนบไฟล์', 'error'); return; }
        
        setIsLoading(true); // เริ่มโหลด
        let uploadedFile = null;

        try {
            // 1. อัปโหลดไฟล์ (ถ้ามี)
            if (poData.file) {
                const base64 = await fileToBase64(poData.file);
                const result = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .uploadFileToDrive(base64, poData.file.name);
                });

                if (result.error) throw new Error(result.error);
                uploadedFile = result; // ได้ object {name, url, id} กลับมา
            }

            const note = `PO: ${poData.poNumber}`;
            
            // 2. อัปเดตข้อมูล
setRequests(prev => prev.map(r => {
                if (r.id === poData.requestId) {
                    const updatedReq = { 
                        ...r, 
                        status: 'PO Issued', 
                        poFile: uploadedFile || r.poFile,
                        poNumber: poData.poNumber,
                        // ⭐ แก้ตรงนี้
                        history: [...r.history, createLog('PO Issued', `${user.empId} ${user.firstName} ${user.lastName}`, note)] 
                    };
                    saveRequestToSheet(updatedReq); 
                    return updatedReq;
                }
                return r;
}));
            setShowPOModal(false); 
            showToast('บันทึกและอัปโหลด PO เรียบร้อย');

        } catch (err) {
            console.error(err);
            showToast('เกิดข้อผิดพลาดในการอัปโหลด: ' + err.message, 'error');
        } finally {
            setIsLoading(false);
        }
      };

      // --- LOGIC: CONTRACT SIGNED (With File Upload) ---
const openContractModal = (id) => { 
    setContractData({ requestId: id, file: null });
    setShowContractModal(true); 
};

const handleSubmitContract = async () => {
    setIsLoading(true);
    let uploadedFile = null;
    try {
        // 1. อัปโหลดไฟล์ (ถ้ามี)
        if (contractData.file) {
            const base64 = await fileToBase64(contractData.file);
            const result = await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .uploadFileToDrive(base64, contractData.file.name);
            });
            if (result.error) throw new Error(result.error);
            uploadedFile = result;
        }

        const note = uploadedFile ? `แนบไฟล์สัญญา: ${uploadedFile.name}` : 'บันทึกทำสัญญาแล้ว';
        const userSignature = `${user.empId} ${user.firstName} ${user.lastName}`;

        // 2. อัปเดตข้อมูล
        setRequests(prev => prev.map(r => {
            if (r.id === contractData.requestId) {
                const updatedReq = { 
                    ...r, 
                    status: 'Contract Signed', 
                    contractFile: uploadedFile || r.contractFile, // ⭐ เก็บข้อมูลไฟล์สัญญา
                    history: [...r.history, createLog('Contract Signed', userSignature, note)] 
                };
                saveRequestToSheet(updatedReq); 
                return updatedReq;
            }
            return r;
        }));

        setShowContractModal(false); 
        showToast('บันทึกการทำสัญญาเรียบร้อย');
    } catch (err) {
        console.error(err);
        showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
    } finally {
        setIsLoading(false);
    }
};

      const openViewItem = (item) => { setViewingItem(item); setHistoryFilterItem(null); setHistorySearch(''); setShowItemDetailModal(true); };
      const openGeneralHistory = () => { setViewingItem(null); setHistoryFilterItem(null); setHistorySearch(''); setShowItemDetailModal(true); }
      const openImagePreview = (imageName) => { setPreviewImage(imageName); };
      const handleCardClick = (status) => { if (dashboardStatusFilter === status) setDashboardStatusFilter('All'); else setDashboardStatusFilter(status); };
      const handlePrint = () => { window.print(); };
      const openPOPreview = (req) => { setSelectedRequest(req); setShowPOPreviewModal(true); };

      const dashboardStats = useMemo(() => {
        let activeRequests = requests.filter(r => r.status !== 'Draft');
        
        if (globalProjectFilter !== 'All') {
            activeRequests = activeRequests.filter(r => r.job === globalProjectFilter);
        }

        const calcStats = (typeFilterFn) => {
            const reqs = activeRequests.filter(typeFilterFn);
            return {
                total: reqs.length,
                pending: reqs.filter(r => r.status.includes('Pending') || r.status === 'PR Issued' || r.status === 'Approved' || r.status === 'Revise Needed' || r.status === 'Contract Pending').length,
                processing: reqs.filter(r => ['Ordered', 'PO Issued', 'Shipping', 'Ready to Disburse', 'Contract Signed', 'Partially Received'].includes(r.status)).length,
                ready: reqs.filter(r => r.status === 'Ready to Disburse').length,
                completed: reqs.filter(r => r.status === 'Completed' || r.status === 'Returned').length
            };
        };
        return { purchase: calcStats(r => r.type === 'Local' || r.type === 'HO'), withdraw: calcStats(r => r.type === 'Withdraw' || r.type === 'Borrow') };
      }, [requests]);

    const dashboardRequests = useMemo(() => {
        let data = requests.filter(r => r.status !== 'Draft');

        // ⭐ กรอง Project (Global)
        if (globalProjectFilter !== 'All') {
            data = data.filter(r => r.job === globalProjectFilter);
        }

        if (dashboardView === 'Purchase') data = data.filter(r => r.type === 'Local' || r.type === 'HO'); else data = data.filter(r => r.type === 'Withdraw' || r.type === 'Borrow');
        
        // ⭐⭐ จุดที่แก้ไข: เพิ่มเงื่อนไขค้นหา r.docNumber ⭐⭐
      if (dashboardSearch) { 
            const lowerQ = dashboardSearch.toLowerCase(); 
            data = data.filter(r => 
                r.id.toLowerCase().includes(lowerQ) || // ค้นหา ID (REQ-xxx)
                r.items.some(i => i.name.toLowerCase().includes(lowerQ)) || // ค้นหาชื่อสินค้า
                (r.docNumber && r.docNumber.toLowerCase().includes(lowerQ)) || // ค้นหาเลขที่เอกสาร (LPO/HPO)
                r.requester.toLowerCase().includes(lowerQ) || // ค้นหาชื่อผู้ขอ
                (STATUS_LABELS[r.status] || r.status).toLowerCase().includes(lowerQ) // ค้นหาชื่อสถานะ (เช่น 'รออนุมัติ')
            ); 
        }
        if (dashboardStatusFilter !== 'All') {
           if (dashboardStatusFilter === 'Pending') data = data.filter(r => r.status.includes('Pending') || r.status === 'PR Issued' || r.status === 'Approved' || r.status === 'Revise Needed' || r.status === 'Contract Pending');
           else if (dashboardStatusFilter === 'Processing') data = data.filter(r => ['Ordered', 'PO Issued', 'Shipping', 'Ready to Disburse', 'Contract Signed', 'Partially Received'].includes(r.status));
           else if (dashboardStatusFilter === 'Ready') data = data.filter(r => r.status === 'Ready to Disburse');
           else if (dashboardStatusFilter === 'Completed') data = data.filter(r => r.status === 'Completed' || r.status === 'Returned');
        }
        return data;
      }, [requests, dashboardView, dashboardSearch, dashboardStatusFilter]);

// --- LOGIC: BUDGET CHART DATA PREPARATION (FIXED: PROJECT SCOPE) ---
      const budgetChartData = useMemo(() => {
          let targetProjects = projects;
          if (globalProjectFilter !== 'All') {
              targetProjects = projects.filter(p => p.name === globalProjectFilter);
          }

          // ฟังก์ชันคำนวณยอดใช้จริง (Used) แบบละเอียด โดยระบุ Project
          const calculateUsedForProject = (projectName, code, type) => {
              return requests.reduce((sum, req) => {
                  // ⭐ 1. กรองเฉพาะ Request ของโครงการนี้เท่านั้น (แก้ปัญหา Double Count)
                  if (req.job !== projectName) return sum;
                  
                  if (!['Local', 'HO'].includes(req.type)) return sum;
                  
                  // คิดงบเฉพาะที่ "Completed" เท่านั้น
                  if (req.status !== 'Completed') return sum; 

                  const isRent = req.type === 'HO' && req.purchaseType === 'Rent';
                  const items = req.items.filter(i => (type === 'SubJob' ? i.subJob : i.matCode) === code);

                  const reqTotal = items.reduce((iSum, item) => {
                      // Logic คำนวณราคาแบบละเอียด (Assets > Logs > Estimate)
                      const relatedAssets = assets.filter(a => a.currentRequestId === req.id && a.name === item.name);
                      const receivedLogs = item.receivedLog || [];
                      
                      let itemVal = 0;
                      let cnt = 0;

                      // A. Assets
                      if (relatedAssets.length > 0) {
                          itemVal += relatedAssets.reduce((s, asset) => {
                               const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                               const duration = isRent ? (asset.duration || item.duration || 1) : 1;
                               return s + (price * duration);
                          }, 0);
                          cnt = relatedAssets.length;
                      } 
                      // B. Logs
                      else if (receivedLogs.length > 0) {
                          itemVal += receivedLogs.reduce((s, log) => {
                               const duration = isRent ? (log.duration || 1) : 1;
                               return s + (log.qty * log.price * duration);
                          }, 0);
                          cnt = item.receivedTotal || 0;
                      }

                      // C. Estimate
                      // ⭐ [แก้ไขใหม่] ถ้าจบงานแล้ว ไม่ต้องคิดยอด Estimate เพิ่ม (เพราะฟังก์ชันนี้กรองเฉพาะ Completed มาคำนวณ Used อยู่แล้ว)
                      if (req.status !== 'Completed') {
                          const rem = Math.max(0, item.qty - cnt);
                          const dur = isRent ? (item.duration || 1) : 1;
                          itemVal += (rem * (item.unitPrice || 0) * dur);
                      }
                      
                      return iSum + itemVal;
                  }, 0);

                  return sum + reqTotal;
              }, 0);
          };

          // 1. SubJob Data
          const subJobData = [];
          targetProjects.forEach(p => {
              (p.subJobs || []).forEach(sj => {
                  const existing = subJobData.find(x => x.code === sj.code);
                  // ⭐ ส่งชื่อโครงการ (p.name) เข้าไปคำนวณด้วย
                  const used = calculateUsedForProject(p.name, sj.code, 'SubJob'); 
                  
                  if (existing) {
                      existing.budget += (sj.budget || 0);
                      existing.used += used; 
                  } else {
                      // ⭐ เพิ่ม group: sj.group || 'Others'
                      subJobData.push({ code: sj.code, budget: sj.budget || 0, used: used, group: sj.group || 'Others' });
                  }
              });
          });

          // 2. Mat. Code Data
          const matCodeData = [];
          targetProjects.forEach(p => {
              (p.matCodes || []).forEach(ep => {
                  const existing = matCodeData.find(x => x.code === ep.code);
                  // ⭐ ส่งชื่อโครงการ (p.name) เข้าไปคำนวณด้วย
                  const used = calculateUsedForProject(p.name, ep.code, 'matCode');
                  
                  if (existing) {
                      existing.budget += (ep.budget || 0);
                      existing.used += used;
                  } else {
                      // ⭐ เพิ่ม group: ep.group || 'Others'
                      matCodeData.push({ code: ep.code, budget: ep.budget || 0, used: used, group: ep.group || 'Others' });
                  }
              });
          });

        subJobData.sort((a,b) => a.code.localeCompare(b.code));
          matCodeData.sort((a,b) => a.code.localeCompare(b.code));

        // ⭐ 3. Project Summary (สำหรับหน้า All Projects)
          const projectSummary = projects.map(p => {
              let pBudget = 0;
              let pUsed = 0;
              
              // ⭐ [แก้ไข] เพิ่มตัวแปรสำหรับเก็บยอดแยก
              let subBudget = 0;
              let subUsed = 0;
              let matBudget = 0;
              let matUsed = 0;

              // รวมยอด SubJob
              (p.subJobs || []).forEach(sj => {
                  const b = (sj.budget || 0);
                  const u = calculateUsedForProject(p.name, sj.code, 'SubJob');
                  
                  pBudget += b;
                  pUsed += u;
                  
                  // เก็บยอดแยก SubJob
                  subBudget += b;
                  subUsed += u;
              });

              // รวมยอด matCode
              (p.matCodes || []).forEach(ep => {
                  const b = (ep.budget || 0);
                  const u = calculateUsedForProject(p.name, ep.code, 'matCode');
                  
                  pBudget += b;
                  pUsed += u;
                  
                  // เก็บยอดแยก MatCode
                  matBudget += b;
                  matUsed += u;
              });

              return { 
                  id: p.id, 
                  name: p.name, 
                  budget: pBudget, 
                  used: pUsed,
                  // ส่งค่าที่แยกแล้วออกไปใช้งาน
                  subBudget, subUsed,
                  matBudget, matUsed
              };
          }).sort((a, b) => b.budget - a.budget);

          return { subJobData, matCodeData, projectSummary };
      }, [projects, requests, globalProjectFilter, assets]);
// --- HELPER: แปลง Google Drive URL เป็น Image Link ---
      const getDriveImageUrl = (src) => {
          if (!src) return null;
          // ถ้าเป็น Base64 ให้ใช้เลย
          if (src.startsWith('data:') || src.startsWith('blob:')) return src;
          
          // ดึง ID จาก Google Drive URL
          let id = null;
          if (src.includes('/file/d/')) {
              id = src.split('/file/d/')[1].split('/')[0];
          } else if (src.includes('id=')) {
              id = src.split('id=')[1].split('&')[0];
          }

          // ถ้าได้ ID ให้คืนค่าเป็นลิงก์ Thumbnail
          if (id) return `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
          
          return src; // ถ้าไม่ใช่ Google Drive ให้คืนค่าเดิม
      };

      // --- HELPER: แปลง Google Drive URL เป็น Download Link ---
      const getDownloadUrl = (url) => {
          if (!url) return null;
          // ถ้าเป็น Base64 หรือ Blob ให้คืนค่าเดิม (ดาวน์โหลดได้เลย)
          if (url.startsWith('data:') || url.startsWith('blob:')) return url;
          
          // ดึง ID จาก Google Drive URL
          let id = null;
          if (url.includes('/file/d/')) {
              id = url.split('/file/d/')[1].split('/')[0];
          } else if (url.includes('id=')) {
              id = url.split('id=')[1].split('&')[0];
          }

          // ถ้าได้ ID ให้คืนค่าเป็นลิงก์ Download
          if (id) return `https://drive.google.com/uc?export=download&id=${id}`;
          
          return url; // ถ้าไม่ใช่ Google Drive ให้คืนค่าเดิม
      };

      // --- RENDER ---
// ⭐ 2. เพิ่มการตรวจสอบ Login (แก้ตรงนี้เพื่อส่ง requests ไปแสดงผลตัวเลข)

const PublicAnnouncementPopup = () => (
        showPublicAnnounce && publicAnnounces.length > 0 && (
            <div className="fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-300">
                <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden border-t-8 border-indigo-600 animate-in zoom-in-95 flex flex-col max-h-[90vh]">
                    
                    {/* Header */}
                    <div className="p-6 pb-2 text-center shrink-0">
                        <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                            <Megaphone className="w-8 h-8 animate-bounce" />
                        </div>
                        <h2 className="text-2xl font-extrabold text-gray-800">ประกาศข่าวสาร</h2>
                        <p className="text-gray-500 text-xs mt-1">อัปเดตข้อมูลล่าสุดจากระบบ</p>
                    </div>

                    {/* Scrollable Content Area */}
                    <div className="px-6 py-2 overflow-y-auto space-y-4 custom-scrollbar">
                        {publicAnnounces.map((item, idx) => (
                            <div key={idx} className="bg-slate-50 border border-slate-200 rounded-xl p-4 shadow-sm">
                                <h3 className="font-bold text-lg text-indigo-700 mb-2">{item.title}</h3>
                                <div className="text-sm text-gray-600 whitespace-pre-wrap leading-relaxed">
                                    {item.detail}
                                </div>
                                <div className="mt-3 pt-3 border-t border-slate-200 flex justify-between items-center text-[10px] text-gray-400">
                                    <span>ประกาศเมื่อ: {item.timestamp}</span>
                                    <span>โดย: {item.updatedBy}</span>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Footer Close Button */}
                    <div className="p-6 shrink-0">
                        <button 
                            onClick={() => setShowPublicAnnounce(false)}
                            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition-all active:scale-95 flex items-center justify-center gap-2"
                        >
                            รับทราบ / เข้าสู่ระบบ <ArrowRight className="w-5 h-5"/>
                        </button>
                    </div>
                </div>
            </div>
        )
      );

      
      
      if (isLoading) {
         return (
             <div className="flex h-screen items-center justify-center bg-gray-50">
                 <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
             </div>
         );
      }
      
// ⭐ แสดงหน้า Error เมื่อโหลดข้อมูลไม่สำเร็จ
      if (isError) {
         return (
             <div className="flex h-screen flex-col items-center justify-center bg-gray-50 p-6 text-center">
                 <div className="bg-red-100 p-4 rounded-full mb-4">
                     <AlertCircle className="w-10 h-10 text-red-600" />
                 </div>
                 <h2 className="text-xl font-bold text-gray-800 mb-2">เกิดข้อผิดพลาดในการโหลดข้อมูล</h2>
                 <p className="text-gray-500 mb-6 max-w-md text-sm">{errorMessage}</p>
                 
                 <button 
                    onClick={() => window.location.reload()} // หรือเรียก handleRefresh() ถ้า logic รองรับ
                    className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition-transform active:scale-95 flex items-center gap-2"
                 >
                    <RefreshCw className="w-5 h-5"/> ลองใหม่อีกครั้ง (Retry)
                 </button>
             </div>
         );
      }

      
      // ⭐ 2. เพิ่มการตรวจสอบ Login (ปรับแก้ให้แสดง Popup ได้แม้ยังไม่ Login)
      if (!user) {
          return (
            <>
                <PublicAnnouncementPopup />
                <AuthScreen 
                    requests={requests} 
                    onLoginSuccess={(userData) => {
                        setUser(userData);
                        setCurrentUserRole(userData.role || ROLES.USER); 
                        // โหลดประกาศทั้งหมด (Admin view) เมื่อ Login สำเร็จ
                        google.script.run.withSuccessHandler(setAnnouncements).getAllAnnouncements();
                    }} 
                />
            </>
          );
      }



      
      if (!user) {
          return <AuthScreen 
            requests={requests} // ส่งข้อมูลไปคำนวณตัวเลข
            onLoginSuccess={(userData) => {
              setUser(userData);
              setCurrentUserRole(userData.role || ROLES.USER); 
          }} />;
      }
      
     
      return (
        <div className="flex h-screen bg-gray-50 font-sans text-gray-800 overflow-hidden relative print:bg-white print:h-auto print:overflow-visible">
          
          {/* Print Styles */}
          <style>{`
            @media print {
              @page { size: A4; margin: 10mm; }
              body { background: white; -webkit-print-color-adjust: exact; }
              .no-print, aside, header, .modal-backdrop { display: none !important; }
              .print-only { display: block !important; position: static !important; width: 100% !important; height: auto !important; overflow: visible !important; }
              .print-container { width: 100%; padding: 0; margin: 0; border: none; shadow: none; }
            }
            .print-only { display: none; }
          `}</style>
    
          {/* Notification - แก้ไข Z-Index เป็น 9999 และใช้ fixed เพื่อให้อยู่บนสุดเสมอ */}
          {notification && (
           <div className="fixed top-4 right-4 z-[9999] px-4 py-3 rounded-lg shadow-2xl flex items-center gap-3 bg-gray-900 text-white animate-in slide-in-from-top-5 no-print border border-gray-700">
               {notification.type === 'error' ? <AlertCircle className="w-5 h-5 text-red-400"/> : <Bell className="w-5 h-5 text-green-400"/>}
               <p className="text-sm font-medium">{notification.message}</p>
            </div>
          )}

    
          {/* Sidebar */}
          <aside className={`bg-white border-r border-gray-200 flex flex-col shadow-lg z-20 no-print transition-all duration-300 ease-in-out overflow-hidden ${isSidebarOpen ? 'w-64 translate-x-0' : 'w-0 -translate-x-full border-none'}`}>
            <div className="p-6 border-b border-gray-100 min-w-[256px]"> {/* min-w เพื่อป้องกันข้อความแตกตอนหด */}
                <h1 className="text-2xl font-bold text-blue-700 flex items-center gap-2">
                    <Package className="w-8 h-8" /> Purchase<span className="text-gray-800">Hub</span>
                </h1>
            </div>
            <div className="min-w-[256px] flex-1 flex flex-col">
            <div className="px-4 pt-4 pb-2">
                <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block ml-1">เลือกโครงการ (Project)</label>
                <div className="relative">
                    <Building className="absolute left-3 top-2.5 w-4 h-4 text-gray-500 pointer-events-none"/>
                    <select 
    value={globalProjectFilter} 
    onChange={(e) => setGlobalProjectFilter(e.target.value)}
    className="w-full pl-9 pr-8 py-2 border border-gray-300 rounded-lg text-sm appearance-none bg-white focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer font-bold text-gray-700 shadow-sm"
>
    <option value="All">📂 ทุกโครงการ (All)</option>
    {/* แก้ไขส่วนนี้ให้แสดง p.id (รหัส) นำหน้า หรือแสดงแค่รหัสอย่างเดียว */}
    {projects.map(p => (
        <option key={p.id} value={p.name}>
            {p.id} : {p.name}
        </option>
    ))}
</select>
                    <ChevronRight className="absolute right-3 top-3 w-3 h-3 text-gray-400 rotate-90 pointer-events-none"/>
                </div>
            </div>
            <nav className="flex-1 p-4 space-y-1">
           
              <button onClick={() => setActiveTab('dashboard')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'dashboard' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}><LayoutDashboard className="w-5 h-5" /> ภาพรวม (Dashboard)</button>
              <button onClick={() => setActiveTab('orders')} className={`flex items-center justify-between w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'orders' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}>
                  <div className="flex items-center gap-3"><ShoppingCart className="w-5 h-5" /> รายการสั่งซื้อ/เบิก</div>

                  {myPendingCount > 0 && (
                      <span className="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm min-w-[20px] text-center">
                          {myPendingCount}
                      </span>
                  )}
              </button>

              <button onClick={() => setActiveTab('inventory')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'inventory' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}><Box className="w-5 h-5" /> คลังสินค้า (Store)</button>
              <button onClick={() => setActiveTab('assets')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'assets' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}><Monitor className="w-5 h-5" /> ทะเบียนทรัพย์สิน</button>
              {hasPermission(26) && (
              <button onClick={() => setActiveTab('projects')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'projects' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}><Settings className="w-5 h-5" /> ตั้งค่าโครงการ (Projects)</button>
              )}

              {hasPermission(28) && (
              <button onClick={() => setActiveTab('announcement')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'announcement' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}>
                  <Megaphone className="w-5 h-5" /> จัดการประกาศ (Announce)
              </button>
              )}
               
                
<button 
    onClick={() => setActiveTab('users')} 
    className={`flex items-center justify-between w-full px-4 py-3 rounded-lg transition-colors font-medium ${activeTab === 'users' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}
>
    <div className="flex items-center gap-3">
        <User className="w-5 h-5" /> ผู้ใช้งาน (Users)
    </div>
    {/* Badge เตือน User ใหม่ (เฉพาะ Admin/Sub-Admin ถึงจะเห็นยอดเตือน) */}
    {(user?.isSuperAdmin || hasPermission(2) || hasPermission(3)) && newUsersCount > 0 && (
        <span className="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm min-w-[20px] text-center animate-pulse">
            {newUsersCount}
        </span>
    )}
</button>
              
            </nav>
           {/* ⭐ 3. ส่วนแสดงข้อมูล User และปุ่ม Logout (แทนที่ Role Simulation) */}
            <div className="p-4 bg-slate-50 border-t border-gray-200 m-0"> {/* ปรับ style นิดหน่อย */}
                <div className="flex items-center gap-3 mb-3">
                    <div className="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold shadow-sm">
                        {user?.firstName?.charAt(0) || 'U'}
                    </div>
                    <div className="overflow-hidden">
                        <p className="text-sm font-bold text-gray-800 truncate">{user?.firstName} {user?.lastName}</p>
                        <p className="text-xs text-gray-500 font-mono truncate">{user?.empId}</p>
                    </div>
                </div>
                <button 
                    onClick={() => {
                        if(confirm('ต้องการออกจากระบบ?')) {
                            setUser(null);
                            setGlobalProjectFilter('All'); // Reset filter
                        }
                    }} 
                    className="w-full py-2 bg-white border border-gray-300 text-red-600 rounded-lg text-sm font-bold hover:bg-red-50 flex items-center justify-center gap-2 transition-colors"
                >
                    <LogOut className="w-4 h-4"/> ออกจากระบบ
                </button>
            </div>
            </div>
          </aside>
    
          <main className="flex-1 flex flex-col overflow-hidden relative no-print">
            {/* Header */}
            <header className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm z-10">
              <div className="flex items-center gap-4">
                  {/* ⭐ ปุ่มเมนูสามขีด */}
                  <button 
                      onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                      className="p-2 rounded-lg hover:bg-gray-100 text-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-200"
                  >
                      {/* 👇 ลบอันเก่าออก แล้ววาง SVG นี้แทนครับ 👇 */}
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6">
                          <line x1="3" x2="21" y1="6" y2="6" />
                          <line x1="3" x2="21" y1="12" y2="12" />
                          <line x1="3" x2="21" y1="18" y2="18" />
                      </svg>
                  </button>

                  <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                     {/* ข้อความ Title เดิม */}
                     {activeTab === 'dashboard' && 'ภาพรวมระบบ'}
                     {activeTab === 'orders' && `รายการที่ต้องทำ (${currentUserRole === ROLES.USER ? 'งานของฉัน' : 'รอการดำเนินการ'})`}
                     {activeTab === 'inventory' && 'คลังสินค้า (Inventory)'}
                     {activeTab === 'assets' && 'ทะเบียนทรัพย์สิน (Assets)'}
                     {/* ... (Tab อื่นๆ ถ้ามี) ... */}
                  </h2>
              </div>

            <div className="flex items-center gap-4">
            <button 
                     onClick={handleRefresh} 
                     className="bg-white text-gray-600 hover:text-blue-600 hover:bg-blue-50 p-2.5 rounded-lg border border-gray-200 shadow-sm transition-all flex items-center gap-2"
                     title="รีเฟรชข้อมูลล่าสุด"
                 >
                     <RefreshCw className="w-5 h-5"/>
                     <span className="hidden md:inline text-sm font-bold">รีเฟรช</span>
                 </button>
                
                 {(hasPermission(4) || hasPermission(5) || hasPermission(6) || hasPermission(7)) && (
                     <button onClick={handleOpenCreateModal} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-md">
                         <Plus className="w-4 h-4" /> สร้างคำสั่งซื้อ/เบิก/ยืม
                     </button>
                 )}
              </div>
            </header>
    
            {/* Content */}
            <div className="flex-1 overflow-auto p-6 bg-slate-50">


            
            
    {activeTab === 'dashboard' && (
                 <div className="space-y-6 max-w-7xl mx-auto pb-20">
                   
                   {/* Styles */}
                   <style>{`
                      .custom-scrollbar::-webkit-scrollbar { height: 12px; }
                      .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 6px; }
                      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; border: 3px solid #f1f5f9; }
                      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
                      .chart-tooltip { z-index: 9999 !important; pointer-events: none; }
                   `}</style>

                   {/* 1. ⭐ Budget Tracking Charts (ย้ายขึ้นมาเป็นอันดับ 1) */}
{/* ⭐ เพิ่มเงื่อนไขเช็คสิทธิ์ (Admin(2), 8, 9, 26, 29) */}
{dashboardView === 'Purchase' && 
 (hasPermission(2) || hasPermission(8) || hasPermission(9) || hasPermission(26) || hasPermission(29)) && 
 (budgetChartData.subJobData.length > 0 || budgetChartData.matCodeData.length > 0) && (
   <div className="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm animate-in fade-in">
                           
                           {/* Header & Summary */}
                           <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-gray-100 pb-4 gap-4">
                               <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2">
                                   <div className="bg-indigo-100 p-2 rounded-lg text-indigo-600"><CreditCard className="w-5 h-5" /></div>
                                   สรุปติดตามงบประมาณ (Budget Tracking)
                               </h3>
                               
                               <div className="flex gap-2 bg-gray-50 p-1.5 rounded-lg border border-gray-200">
                                   {['SubJob', 'matCode'].map(type => {
                                       const data = type === 'SubJob' ? budgetChartData.subJobData : budgetChartData.matCodeData;
                                       const totalBudget = data.reduce((s, i) => s + i.budget, 0);
                                       const totalUsed = data.reduce((s, i) => s + i.used, 0);
                                       const pct = totalBudget > 0 ? (totalUsed / totalBudget) * 100 : 0;
                                       
                                       if(data.length === 0) return null;

                                       return (
                                           <div key={type} className="px-3 py-1 border-r last:border-0 border-gray-300">
                                               <div className="text-[10px] font-bold text-gray-500 uppercase flex justify-between gap-4">
                                                   <span>{type} TOTAL</span>
                                                   <span className={pct > 100 ? 'text-red-500' : 'text-green-600'}>{pct.toFixed(1)}%</span>
                                               </div>
                                               <div className="font-mono text-sm font-bold text-gray-800">
                                                   {totalUsed.toLocaleString()} <span className="text-gray-400 text-xs font-normal">/ {totalBudget.toLocaleString()}</span>
                                               </div>
                                           </div>
                                       );
                                   })}
                               </div>
                           </div>

                      {globalProjectFilter !== 'All' ? (
                               <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
                                   {[
                                       { type: 'SubJob', title: 'SubJob Breakdown', rawData: budgetChartData.subJobData, color: 'bg-indigo-600' },
                                       { type: 'matCode', title: 'Mat. Code Breakdown', rawData: budgetChartData.matCodeData, color: 'bg-purple-600' }
                                   ].map((chart, cIdx) => {
                                       // --- Logic: Grouping & Drill-down ---
                                       const activeGroup = drillDownState[chart.type];
                                       
                                       // ฟังก์ชันรวมกลุ่มข้อมูล
                                       const getGroupedData = (data) => {
                                            const groups = {};
                                            data.forEach(d => {
                                                const g = d.group;
                                                if(!groups[g]) groups[g] = { code: g, budget: 0, used: 0, isGroup: true }; // ใช้ code เป็นชื่อ group เพื่อให้แสดงผลในกราฟได้เลย
                                                groups[g].budget += d.budget;
                                                groups[g].used += d.used;
                                            });
                                            return Object.values(groups).sort((a,b) => a.code.localeCompare(b.code));
                                       };

                                       // เลือกข้อมูลที่จะแสดง (กลุ่ม หรือ รายละเอียด)
                                       const displayData = activeGroup 
                                            ? chart.rawData.filter(d => (d.group) === activeGroup)
                                            : getGroupedData(chart.rawData);

                                       return (
                                       <div key={cIdx} className="flex flex-col relative group/chart">
                                           <div className="flex justify-between items-end mb-2">
                                                <h4 className="font-bold text-gray-700 text-sm flex items-center gap-2">
                                                   {chart.title} 
                                                   {activeGroup && <span className="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">Group: {activeGroup}</span>}
                                                   
                                                   {/* ปุ่ม Back เมื่อ Drill-down */}
                                                   {activeGroup ? (
                                                       <button 
                                                            onClick={() => setDrillDownState(prev => ({ ...prev, [chart.type]: null }))}
                                                            className="bg-gray-100 text-gray-600 hover:text-red-600 p-1 rounded-lg border border-gray-200 hover:bg-red-50 transition-colors shadow-sm ml-2 flex items-center gap-1 text-[10px] font-bold px-2"
                                                       >
                                                            <RotateCcw size={10}/> กลับ
                                                       </button>
                                                   ) : (
                                                       <button 
                                                            // ⭐ แก้ไข: ส่ง chart object ทั้งก้อน (ที่มี rawData) ไปให้ Expanded Chart
                                                            onClick={() => setExpandedChart(chart)} 
                                                            className="bg-gray-100 text-gray-600 hover:text-blue-600 p-1.5 rounded-lg border border-gray-200 hover:bg-blue-50 transition-colors shadow-sm ml-2"
                                                            title="ขยายเต็มจอ"
                                                       >
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                                                       </button>
                                                   )}
                                               </h4>
                                              <div className="text-[10px] text-gray-400 flex gap-2">
                                                   <span className="flex items-center gap-1"><div className="w-2 h-2 bg-gray-300 rounded-sm"></div> งบประมาณ</span>
                                                   <span className="flex items-center gap-1"><div className={`w-2 h-2 rounded-sm ${chart.color}`}></div> ใช้จริง</span>
                                               </div>
                                            </div>
                                           
                                           <div className="relative border-b border-l border-gray-200 bg-gray-50/30 rounded-bl-lg">
                                               {/* Grid Lines */}
                                               <div className="absolute inset-0 flex flex-col justify-between pointer-events-none opacity-30">
                                                   <div className="border-t border-dashed border-gray-300 w-full h-full"></div>
                                                   <div className="border-t border-dashed border-gray-300 w-full h-full"></div>
                                               </div>

                                               <div className="relative h-64 w-full flex items-end gap-6 overflow-x-auto pb-4 px-4 pt-16 custom-scrollbar">
                                                   {displayData.length === 0 && <div className="absolute inset-0 flex items-center justify-center text-gray-300 text-sm">ไม่มีข้อมูล</div>}
                                                   
                                                   {displayData.map((item, i) => {
                                                       const groupMax = Math.max(...displayData.map(d => Math.max(d.budget, d.used))) || 1;
                                                       const budgetH = (item.budget / groupMax) * 100;
                                                       const usedH = (item.used / groupMax) * 100;
                                                       const percent = item.budget > 0 ? (item.used / item.budget) * 100 : 0;
                                                       const isOver = item.used > item.budget;
                                                       return (
                                                           <div 
    key={i} 
    // ⭐ เพิ่ม hover:z-20 เพื่อให้แท่งที่ชี้ลอยขึ้นมาอยู่ชั้นบนสุด Tooltip จะได้ไม่โดนบัง
    className={`group relative flex flex-col justify-end items-center h-full min-w-[40px] flex-1 hover:z-20 ${!activeGroup && item.isGroup ? 'cursor-pointer hover:bg-gray-100/50 rounded-t transition-colors' : ''}`}
    onClick={() => {
        if (!activeGroup && item.isGroup) {
            setDrillDownState(prev => ({ ...prev, [chart.type]: item.code }));
        }
    }}
>
                                                                 {/* Percent Label */}
                                                               <div 
                                                                   className="absolute text-center transition-all duration-300 z-10 w-20 pointer-events-none"
                                                                   style={{ bottom: `${Math.max(budgetH, usedH) + 5}%` }} 
                                                               >
                                                                   <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded shadow-sm border ${isOver ? 'text-red-600 bg-red-50 border-red-200' : 'text-gray-600 bg-white border-gray-200'}`}>
                                                                        {percent.toFixed(0)}%
                                                                   </span>
                                                               </div>

                                                                 {/* Bar */}
                                                               <div className="relative w-8 h-full flex items-end justify-center pointer-events-none">
                                                                   <div className="absolute bottom-0 w-full bg-gray-300 rounded-t-sm transition-all" style={{ height: `${budgetH}%`, minHeight: '4px' }}></div>
                                                                   <div className={`absolute bottom-0 w-3/5 rounded-t-sm transition-all opacity-90 ${isOver ? 'bg-red-500' : chart.color}`} style={{ height: `${usedH}%`, minHeight: '1px' }}></div>
                                                               </div>

                                                                 {/* Label */}
                                                               <div className="mt-3 text-[10px] font-bold text-gray-500 -rotate-45 origin-top-left translate-y-2 whitespace-nowrap w-0 overflow-visible">
                                                                   {item.code} {/* code ในที่นี้คือชื่อ Group หรือชื่อ SubJob */}
                                                               </div>

{/* Tooltip Small (Overlay on Bar) */}
<div className="chart-tooltip absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 hidden group-hover:block pointer-events-none">
    <div className="bg-gray-900/95 backdrop-blur text-white p-2.5 rounded-lg shadow-xl relative min-w-[140px] whitespace-nowrap border border-gray-700">
        {/* Header Title */}
        <div className="font-bold text-yellow-300 text-xs mb-1.5 border-b border-gray-600 pb-1">
            {item.isGroup ? 'Group: ' : ''}{item.code}
        </div>
        
        {/* Body Content */}
        <div className="space-y-0.5 text-[10px]">
            <div className="flex justify-between gap-3">
                <span className="text-gray-400">งบ:</span> 
                <span className="font-mono font-bold">{item.budget.toLocaleString()}</span>
            </div>
            
            <div className="flex justify-between gap-3">
                <span className="text-gray-400">ใช้:</span> 
                <span className="font-mono font-bold text-blue-300">{item.used.toLocaleString()}</span>
            </div>
            
            <div className="flex justify-between gap-3">
                <span className="text-gray-400">เหลือ:</span> 
                <span className={`font-mono font-bold ${item.budget - item.used < 0 ? 'text-red-400' : 'text-green-400'}`}>
                    {(item.budget - item.used).toLocaleString()}
                </span>
            </div>
        </div>

        {!activeGroup && <div className="text-[8px] text-gray-500 mt-1.5 text-center pt-1 border-t border-gray-700/50">*คลิกดูรายละเอียด</div>}
    </div>
</div>
                                                           </div>
                                                       );
                                                   })}
                                               </div>
                                           </div>
                                      </div>
                                   )})}
                               
                               </div>
      
                  ) : (
                               // ⭐ กราฟรวมทุกโครงการ (Overview Chart)
                               <div className="mt-6">
                                   <div className="flex justify-between items-end mb-2">
                                       <h4 className="font-bold text-gray-700 text-sm flex items-center gap-2">ภาพรวมงบประมาณรายโครงการ (Project Overview)</h4>
                                       <div className="text-[10px] text-gray-400 flex gap-2">
                                           <span className="flex items-center gap-1"><div className="w-2 h-2 bg-gray-300 rounded-sm"></div> งบประมาณ</span>
                                           <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-sm bg-teal-600"></div> ใช้จริง</span>
                                       </div>
                                   </div>

                                   <div className="relative border-b border-l border-gray-200 bg-gray-50/30 rounded-bl-lg">
                                       {/* Grid Lines */}
                                       <div className="absolute inset-0 flex flex-col justify-between pointer-events-none opacity-30">
                                           <div className="border-t border-dashed border-gray-300 w-full h-full"></div>
                                           <div className="border-t border-dashed border-gray-300 w-full h-full"></div>
                                       </div>

                                       <div className="relative h-64 w-full flex items-end gap-6 overflow-x-auto pb-4 px-4 pt-16 custom-scrollbar">
                                           {budgetChartData.projectSummary.length === 0 && <div className="absolute inset-0 flex items-center justify-center text-gray-300 text-sm">ไม่มีข้อมูลโครงการ</div>}
                                           
                                           {budgetChartData.projectSummary.map((proj, i) => {
                                               // หาค่า Max เพื่อคำนวณความสูงกราฟ
                                               const maxVal = Math.max(...budgetChartData.projectSummary.map(d => Math.max(d.budget, d.used))) || 1;
                                               const budgetH = (proj.budget / maxVal) * 100;
                                               const usedH = (proj.used / maxVal) * 100;
                                               const percent = proj.budget > 0 ? (proj.used / proj.budget) * 100 : 0;
                                               const isOver = proj.used > proj.budget;

                                               return (
                                                   <div 
                                                       key={i} 
                                                       className="group relative flex flex-col justify-end items-center h-full min-w-[60px] flex-1 hover:z-20 cursor-pointer hover:bg-gray-100/50 rounded-t transition-colors"
                                                       onClick={() => setGlobalProjectFilter(proj.name)} // ⭐ คลิกแล้วเปลี่ยน Filter ไปที่โครงการนั้น
                                                   >
                                                       {/* Percent Label */}
<div 
    // ⭐ ลบ opacity-0 และ group-hover ออก เพื่อให้โชว์ตลอดเวลา
    className="absolute text-center z-10 w-24 pointer-events-none mb-2"
    // ⭐ ปรับตำแหน่ง bottom ให้ลอยเหนือแท่งกราฟพอดี
    style={{ bottom: `${Math.max(budgetH, usedH)}%` }} 
>
     <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${isOver ? 'text-red-600' : 'text-teal-700'}`}>
         {percent.toFixed(0)}%
     </span>
</div>

                                                       {/* Bar */}
                                                       <div className="relative w-10 h-full flex items-end justify-center pointer-events-none">
                                                           <div className="absolute bottom-0 w-full bg-gray-300 rounded-t-sm transition-all" style={{ height: `${budgetH}%`, minHeight: '4px' }}></div>
                                                           <div className={`absolute bottom-0 w-3/5 rounded-t-sm transition-all opacity-90 ${isOver ? 'bg-red-500' : 'bg-teal-600'}`} style={{ height: `${usedH}%`, minHeight: '1px' }}></div>
                                                       </div>

                                                       {/* Label */}
                                                       <div className="mt-3 text-[10px] font-bold text-gray-500 -rotate-45 origin-top-left translate-y-2 whitespace-nowrap w-0 overflow-visible group-hover:text-teal-700 transition-colors">
                                                           {proj.id} {/* ⭐ เปลี่ยนจาก name เป็น id */}
                                                       </div>

                                                       {/* Tooltip */}
                                                       <div className="chart-tooltip absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 hidden group-hover:block pointer-events-none">
                                                           <div className="bg-gray-900/95 backdrop-blur text-white p-2.5 rounded-lg shadow-xl relative min-w-[150px] whitespace-nowrap border border-gray-700">
                                                               <div className="font-bold text-yellow-300 text-xs mb-1.5 border-b border-gray-600 pb-1">
                                                                   {proj.name}
                                                               </div>
                                                               <div className="space-y-0.5 text-[10px]">
                                                                  <div className="flex justify-between gap-3">
                                                                       <span className="text-gray-400">งบรวม:</span> 
                                                                       <span className="font-mono font-bold">{proj.budget.toLocaleString()}</span>
                                                               </div>
                                                    
                                               <div className="flex justify-between gap-3">
                                                                       <span className="text-gray-400">ใช้รวม:</span> 
                                                                       <span className="font-mono font-bold text-blue-300">{proj.used.toLocaleString()}</span>
                                                               </div>
                                                                   <div className="flex justify-between gap-3 pb-2 border-b border-gray-600 mb-1">
                                                                       <span className="text-gray-400">คงเหลือ:</span> 
                                                                       <span className={`font-mono font-bold ${proj.budget - proj.used < 0 ?
'text-red-400' : 'text-green-400'}`}>
                                                                           {(proj.budget - proj.used).toLocaleString()}
                                                                       </span>
                                                                  </div>

                                                                  {/* ⭐ [เพิ่มใหม่] แสดงยอดแยก SubJob (สีคราม) และ Mat. Code (สีม่วง) */}
                                                                  <div className="flex justify-between gap-3 text-[9px] text-indigo-300">
                                                                      <span>SubJob:</span>
                                                                      <span className="font-mono opacity-90">
                                                                          {proj.subUsed.toLocaleString()} / {proj.subBudget.toLocaleString()}
                                                                      </span>
                                                                  </div>
                                                                  <div className="flex justify-between gap-3 text-[9px] text-purple-300">
                                                                      <span>Mat.Code:</span>
                                                                      <span className="font-mono opacity-90">
                                                                          {proj.matUsed.toLocaleString()} / {proj.matBudget.toLocaleString()}
                                                                      </span>
                                                                  </div>
                                                                   
                                                               </div>
                                                               <div className="text-[8px] text-gray-500 mt-1.5 text-center pt-1 border-t border-gray-700/50">*คลิกเพื่อดูรายละเอียด</div>
                                                           </div>
                                                       </div>
                                                   </div>
                                               );
                                           })}
                                       </div>
                                   </div>
                               </div>
                           )}
                       </div>
                   )}

                   {/* 2. ⭐ Stats Cards (ย้ายมาเป็นอันดับ 2) */}
                   <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                      <div className={`p-5 rounded-2xl border bg-white shadow-sm cursor-pointer transition-all hover:shadow-md ${dashboardStatusFilter === 'Pending' ? 'ring-2 ring-amber-500 bg-amber-50' : ''}`} onClick={() => handleCardClick('Pending')}>
                          <div className="flex justify-between items-start mb-2"><div className="p-2 bg-amber-100 rounded-lg"><Clock className="w-6 h-6 text-amber-600"/></div><span className="text-2xl font-bold text-gray-800">{dashboardView === 'Purchase' ? dashboardStats.purchase.pending : dashboardStats.withdraw.pending}</span></div>
                          <p className="text-sm text-gray-500 font-medium">รออนุมัติ/ตรวจสอบ</p>
                      </div>
                      <div className={`p-5 rounded-2xl border bg-white shadow-sm cursor-pointer transition-all hover:shadow-md ${dashboardStatusFilter === 'Processing' ? 'ring-2 ring-blue-500 bg-blue-50' : ''}`} onClick={() => handleCardClick('Processing')}>
                          <div className="flex justify-between items-start mb-2"><div className="p-2 bg-blue-100 rounded-lg"><Truck className="w-6 h-6 text-blue-600"/></div><span className="text-2xl font-bold text-gray-800">{dashboardView === 'Purchase' ? dashboardStats.purchase.processing : dashboardStats.withdraw.processing}</span></div>
                          <p className="text-sm text-gray-500 font-medium">กำลังดำเนินการ/สั่งซื้อ</p>
                      </div>
                      <div className={`p-5 rounded-2xl border bg-white shadow-sm cursor-pointer transition-all hover:shadow-md ${dashboardStatusFilter === 'Ready' ? 'ring-2 ring-purple-500 bg-purple-50' : ''}`} onClick={() => handleCardClick('Ready')}>
                          <div className="flex justify-between items-start mb-2"><div className="p-2 bg-purple-100 rounded-lg"><Package className="w-6 h-6 text-purple-600"/></div><span className="text-2xl font-bold text-gray-800">{dashboardView === 'Purchase' ? dashboardStats.purchase.ready : dashboardStats.withdraw.ready}</span></div>
                          <p className="text-sm text-gray-500 font-medium">รอจ่ายของ/เบิก</p>
                      </div>
                      <div className={`p-5 rounded-2xl border bg-white shadow-sm cursor-pointer transition-all hover:shadow-md ${dashboardStatusFilter === 'Completed' ? 'ring-2 ring-green-500 bg-green-50' : ''}`} onClick={() => handleCardClick('Completed')}>
                          <div className="flex justify-between items-start mb-2"><div className="p-2 bg-green-100 rounded-lg"><CheckCircle className="w-6 h-6 text-green-600"/></div><span className="text-2xl font-bold text-gray-800">{dashboardView === 'Purchase' ? dashboardStats.purchase.completed : dashboardStats.withdraw.completed}</span></div>
                          <p className="text-sm text-gray-500 font-medium">เสร็จสิ้น/รับของแล้ว</p>
                      </div>
                   </div>

                   {/* 3. ⭐ Filter Toolbar & Table (อันดับ 3) */}
                   <div className="flex flex-col md:flex-row justify-between items-center gap-4 mt-8">

                      <div className="flex bg-gray-200 p-1 rounded-lg">
                        <button onClick={() => setDashboardView('Purchase')} className={`px-4 py-2 rounded-md text-sm font-bold transition-all flex items-center gap-2 ${dashboardView === 'Purchase' ? 'bg-white text-blue-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}><ShoppingCart className="w-4 h-4"/> งานสั่งซื้อ</button>
                        <button onClick={() => setDashboardView('Withdraw')} className={`px-4 py-2 rounded-md text-sm font-bold transition-all flex items-center gap-2 ${dashboardView === 'Withdraw' ? 'bg-white text-pink-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}><ArrowLeftRight className="w-4 h-4"/> งานเบิก/ยืม</button>
                     </div>

                     <div className="flex gap-2 w-full md:w-auto items-center">
        
        {/* ช่องค้นหาเดิม (ปรับ class นิดหน่อย) */}
        <div className="relative flex-1 md:w-80"> 
            <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
            <input type="text" className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="ค้นหารายการ..." value={dashboardSearch} onChange={e => setDashboardSearch(e.target.value)}/>
        </div>

        {/* ⭐ A. ปุ่ม Export CSV (วางตรงนี้) */}
        {(user.isSuperAdmin || hasPermission(2) || hasPermission(29)) && (
            <button 
                onClick={() => setShowExportModal(true)}
                className="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm transition-colors whitespace-nowrap"
            >
                <Download className="w-4 h-4"/> Export
            </button>
        )}
    </div>
</div>

      
                   {/* Table */}
                   {dashboardRequests.length > 0 ? (
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden mb-10">
                          <div className="overflow-x-auto">
                              <table className="w-full text-sm text-left">
                                  <thead className="bg-gray-100 text-gray-600 font-medium border-b">
                                      <tr>
                                          <th className="px-6 py-3">ID</th>
                                          <th className="px-6 py-3">เรื่อง</th>
                                          <th className="px-6 py-3">ผู้ขอ</th>
                                          <th className="px-6 py-3">
                                              <div className="flex items-center gap-1 cursor-pointer">
                                                  อัปเดตล่าสุด <ArrowUpDown className="w-3 h-3 opacity-50"/>
                                              </div>
                                          </th>
                                          <th className="px-6 py-3 text-center">สถานะ</th>
                                      </tr>
                                  </thead>
                                  <tbody className="divide-y">
                                      {dashboardRequests
                                          .map(req => {
                                              let lastUpdateStr = req.created;
                                              let displayTime = req.created;
                                              if (req.history && req.history.length > 0) {
                                                  const lastLog = req.history[req.history.length - 1];
                                                  lastUpdateStr = lastLog.date;
                                                  displayTime = lastLog.date;
                                              }
                                              const parseThaiDateToTs = (dStr) => {
                                                  if(!dStr) return 0;
                                                  try {
                                                      if(dStr.includes('/')) {
                                                          const parts = dStr.split(' ');
                                                          const dateParts = parts[0].split('/');
                                                          const timeParts = parts[1] ? parts[1].split(':') : [0,0,0];
                                                          let year = parseInt(dateParts[2]);
                                                          if(year > 2400) year -= 543;
                                                          return new Date(year, parseInt(dateParts[1])-1, parseInt(dateParts[0]), ...timeParts).getTime();
                                                      }
                                                      return new Date(dStr).getTime();
                                                  } catch(e) { return 0; }
                                              };
                                              return { ...req, _sortTime: parseThaiDateToTs(lastUpdateStr), _displayTime: displayTime };
                                          })
                                          .sort((a, b) => b._sortTime - a._sortTime)
                                          .map(req => {
                                              const getDaysDiff = (d) => {
                                                  if(!d) return 999;
                                                  const diff = new Date(d) - new Date();
                                                  return Math.ceil(diff / (1000 * 60 * 60 * 24));
                                              };
                                              const daysLeft = getDaysDiff(req.dateRequired);
                                              let alertBadge = null;
                                              if (!['Completed', 'Rejected', 'Returned', 'Draft'].includes(req.status)) {
                                                  if (daysLeft < 0) alertBadge = { text: `เลยกำหนด ${Math.abs(daysLeft)} วัน`, color: 'bg-red-600 text-white animate-pulse' };
                                                  else if (daysLeft <= 1) alertBadge = { text: 'ครบกำหนดวันนี้!', color: 'bg-red-500 text-white' };
                                                  else if (daysLeft <= 3) alertBadge = { text: 'ด่วน (3 วัน)', color: 'bg-orange-50 text-orange-600 border-orange-200' };
                                              }
                                              return (
                                                  <tr 
                                                      key={req.id} 
                                                      className="hover:bg-blue-50 cursor-pointer transition-colors group"
                                                      onClick={() => { setSelectedRequest(req); setShowDetailModal(true); }}
                                                  >
                                                      <td className="px-6 py-4 font-bold text-blue-600 group-hover:text-blue-800 underline decoration-dotted decoration-blue-300 underline-offset-4">
                                                          {req.id}
                                                          <div className="flex flex-col gap-1 mt-1">
                                                              {req.docNumber && <span className="text-[10px] text-gray-500 font-normal border px-1 rounded bg-gray-50 w-fit">{req.docNumber}</span>}
                                                              {alertBadge && (
                                                                  <span className={`text-[9px] px-1.5 py-0.5 rounded flex items-center gap-1 font-bold w-fit ${alertBadge.color}`}>
                                                                      <Clock className="w-3 h-3"/> {alertBadge.text}
                                                                  </span>
                                                              )}
                                                          </div>
                                                      </td>
                                                      <td className="px-6 py-4">
                                                          <div className="font-bold text-gray-800">{req.items[0]?.name}</div>
                                                          {req.items.length > 1 && <span className="text-xs text-gray-500 bg-gray-100 px-1.5 rounded">+{req.items.length - 1} รายการ</span>}
                                                      </td>
                                                      <td className="px-6 py-4">{req.requester}</td>
                                                      <td className="px-6 py-4 text-gray-500 text-xs font-mono">
                                                          <div className="font-bold text-gray-700">{req._displayTime.split(' ')[0]}</div>
                                                          <div className="text-[10px] text-gray-400">{req._displayTime.split(' ')[1]}</div>
                                                          {req.dateRequired && <div className="text-[10px] text-orange-400 mt-1">Due: {req.dateRequired}</div>}
                                                      </td>
                                                      <td className="px-6 py-4 text-center"><StatusBadge status={req.status} type={req.type} /></td>
                                                  </tr>
                                              );
                                          })}
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  ) : (
                      <div className="text-center py-10 bg-white rounded-xl border border-dashed border-gray-300 text-gray-400">
                          <Package className="w-12 h-12 mx-auto mb-3 text-gray-300"/>
                          <p>ไม่พบรายการที่ค้นหา</p>
                      </div>
                  )}
                 </div>
              )}

             {/* Expanded Chart Modal */}
              {expandedChart && (() => {
                   // ⭐ คำนวณข้อมูลใหม่ใน Modal (Group -> Detail) เพื่อให้รองรับการกด Drill-down
                   const activeGroup = drillDownState[expandedChart.type];
                   
                   const getGroupedData = (data) => {
                        const groups = {};
                        data.forEach(d => {
                            const g = d.group;
                            if(!groups[g]) groups[g] = { code: g, budget: 0, used: 0, isGroup: true };
                            groups[g].budget += d.budget;
                            groups[g].used += d.used;
                        });
                        return Object.values(groups).sort((a,b) => a.code.localeCompare(b.code));
                   };

                   const displayData = activeGroup 
                        ? expandedChart.rawData.filter(d => (d.group) === activeGroup)
                        : getGroupedData(expandedChart.rawData);

                   // คำนวณยอดรวมสำหรับ Summary Card
                   const totalBudget = displayData.reduce((s, i) => s + i.budget, 0);
                   const totalUsed = displayData.reduce((s, i) => s + i.used, 0);
                   const pct = totalBudget > 0 ? (totalUsed / totalBudget) * 100 : 0;

                   return (
                      <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[200] p-4 backdrop-blur-sm animate-in fade-in">
                          <div className="bg-white rounded-xl shadow-2xl w-full max-w-7xl h-[90vh] flex flex-col overflow-hidden">
                    
                              {/* Header */}
                              <div className="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
                                  <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2">
    <LayoutDashboard className="w-6 h-6 text-blue-600"/> {expandedChart.title} (Full View)
    
    {/* ⭐ เพิ่มชื่อโครงการตรงนี้ */}
    <span className="text-sm bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full border border-indigo-100 shadow-sm">
        {globalProjectFilter === 'All' ? 'ทุกโครงการ (All Projects)' : globalProjectFilter}
    </span>

    {activeGroup && <span className="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-full">Group: {activeGroup}</span>}
</h3>
                                  <div className="flex gap-2">
                                      {/* ปุ่มย้อนกลับ (แสดงเฉพาะเมื่อกดเข้ามาดูในกลุ่ม) */}
                                      {activeGroup && (
                                           <button 
                                                onClick={() => setDrillDownState(prev => ({ ...prev, [expandedChart.type]: null }))}
                                                className="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 font-bold hover:bg-gray-50 flex items-center gap-2 transition-colors"
                                           >
                                                <RotateCcw size={16}/> ย้อนกลับ (Back)
                                           </button>
                                      )}
                                      <button onClick={() => setExpandedChart(null)} className="p-2 bg-white hover:bg-gray-200 rounded-full transition-colors">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-600">
                                              <line x1="18" y1="6" x2="6" y2="18"></line>
                                              <line x1="6" y1="6" x2="18" y2="18"></line>
                                          </svg>
                                      </button>
                                  </div>
                              </div>

                              <div className="flex-1 p-8 bg-white overflow-hidden flex flex-col">
                                  {/* Summary Card */}
                                  <div className="mb-6 flex justify-center">
                                      <div className="bg-blue-50 border border-blue-200 rounded-xl px-6 py-3 flex gap-8 items-center shadow-sm">
                                           <div>
                                              <div className="text-xs font-bold text-gray-500 uppercase">งบประมาณ (Total Budget)</div>
                                              <div className="text-xl font-bold text-gray-800">{totalBudget.toLocaleString()}</div>
                                           </div>
                                           <div className="h-8 w-px bg-blue-200"></div>
                                           <div>
                                              <div className="text-xs font-bold text-gray-500 uppercase">ใช้จริง (Total Used)</div>
                                              <div className="text-xl font-bold text-indigo-700">{totalUsed.toLocaleString()}</div>
                                           </div>
                                           <div className="h-8 w-px bg-blue-200"></div>
                                           <div>
                                              <div className="text-xs font-bold text-gray-500 uppercase">% การใช้</div>
                                              <div className={`text-2xl font-bold ${pct > 100 ? 'text-red-600' : 'text-green-600'}`}>{pct.toFixed(2)}%</div>
                                           </div>
                                      </div>
                                  </div>

                                  {/* กราฟขนาดใหญ่ */}
                                  <div className="relative flex-1 border-b border-l border-gray-300 bg-gray-50/20 w-full flex items-end gap-8 overflow-x-auto pb-4 px-8 pt-16 custom-scrollbar">
                                      {displayData.map((item, i) => {
                                           const groupMax = Math.max(...displayData.map(d => Math.max(d.budget, d.used))) || 1;
                                           const budgetH = (item.budget / groupMax) * 100;
                                           const usedH = (item.used / groupMax) * 100;
                                           const percent = item.budget > 0 ? (item.used / item.budget) * 100 : 0;
                                           const isOver = item.used > item.budget;

                                           return (
                                               <div 
                                                    key={i} 
                                                    className={`group relative flex flex-col justify-end items-center h-full min-w-[60px] flex-1 ${!activeGroup && item.isGroup ? 'cursor-pointer hover:bg-gray-100/50 rounded-t transition-colors' : ''}`}
                                                    onClick={() => {
                                                        if (!activeGroup && item.isGroup) {
                                                            setDrillDownState(prev => ({ ...prev, [expandedChart.type]: item.code }));
                                                        }
                                                    }}
                                               >
                                                   {/* Large Percent Label */}
                                                   <div className="absolute text-center transition-all duration-300 z-10 pointer-events-none" style={{ bottom: `${Math.max(budgetH, usedH) + 2}%` }}>
                                                      <span className={`text-sm font-bold px-2 py-1 rounded shadow border ${isOver ? 'text-red-600 bg-white border-red-200' : 'text-gray-700 bg-white border-gray-200'}`}>
                                                           {percent.toFixed(0)}%
                                                      </span>
                                                   </div>
                                             
                                                   <div className="relative w-16 h-full flex items-end justify-center pointer-events-none">
                                                      <div className="absolute bottom-0 w-full bg-gray-300 rounded-t transition-all" style={{ height: `${budgetH}%` }}></div>
                                                      <div className={`absolute bottom-0 w-3/4 rounded-t transition-all opacity-90 ${isOver ? 'bg-red-500' : expandedChart.color}`} style={{ height: `${usedH}%` }}></div>
                                                   </div>

                                                   <div className="mt-4 text-xs font-bold text-gray-600 -rotate-45 origin-top-left translate-y-2 whitespace-nowrap">
                                                       {item.code}
                                                   </div>
{/* Tooltip Expanded (Overlay on Bar) */}
<div className="chart-tooltip absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 hidden group-hover:block pointer-events-none">
    <div className="bg-gray-900/95 backdrop-blur text-white p-3 rounded-lg shadow-2xl relative min-w-[170px] whitespace-nowrap border border-gray-700">
        {/* Header Title */}
        <div className="font-bold text-yellow-300 text-sm mb-2 border-b border-gray-600 pb-1.5">
            {item.isGroup ? 'Group: ' : ''}{item.code}
        </div>
        
        {/* Body Content */}
        <div className="space-y-1 text-xs">
            <div className="flex justify-between gap-5">
                <span className="text-gray-400">งบประมาณ:</span> 
                <span className="font-mono font-bold">{item.budget.toLocaleString()}</span>
            </div>
            
            <div className="flex justify-between gap-5">
                <span className="text-gray-400">ใช้จริง:</span> 
                <span className="font-mono font-bold text-blue-300">{item.used.toLocaleString()}</span>
            </div>
            
            <div className="flex justify-between gap-5">
                <span className="text-gray-400">คงเหลือ:</span> 
                <span className={`font-mono font-bold ${item.budget - item.used < 0 ? 'text-red-400' : 'text-green-400'}`}>
                    {(item.budget - item.used).toLocaleString()}
                </span>
            </div>
        </div>

        {!activeGroup && <div className="text-[9px] text-gray-500 mt-2 text-center pt-1.5 border-t border-gray-700/50">คลิกแท่งกราฟเพื่อดูรายละเอียด</div>}
    </div>
</div>
                                               </div>
                                           );
                                      })}
                                  </div>
                              </div>
                          </div>
                      </div>
                  );
              })()}

   {/* --- ANNOUNCEMENT MANAGEMENT TAB (UPDATED: MULTI-TOPIC) --- */}
{activeTab === 'announcement' && hasPermission(28) && (
    <div className="space-y-6 max-w-5xl mx-auto">
        <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col h-[85vh]">
            <div className="px-6 py-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">
                   <Megaphone className="w-5 h-5 text-indigo-600"/> จัดการประกาศข่าวสาร (System Announcement)
                </h3>
                <button 
                    onClick={() => setAnnounceForm({ id: '', title: '', detail: '', active: true })}
                    className="bg-indigo-600 text-white text-sm font-bold px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-2"
                >
                    <Plus className="w-4 h-4"/> สร้างประกาศใหม่
                </button>
            </div>
            
            <div className="flex flex-1 overflow-hidden">
                {/* Left: List of Announcements */}
                <div className="w-1/3 border-r border-gray-200 overflow-y-auto bg-gray-50">
                    {announcements.length === 0 && <div className="p-8 text-center text-gray-400 text-sm">ยังไม่มีประกาศ</div>}
                    {announcements.map((item) => (
                        <div 
                            key={item.id}
                            onClick={() => setAnnounceForm(item)}
                            className={`p-4 border-b cursor-pointer transition-colors hover:bg-white ${announceForm.id === item.id ? 'bg-white border-l-4 border-l-indigo-600 shadow-sm' : ''}`}
                        >
                            <div className="flex justify-between items-start mb-1">
                                <h4 className={`font-bold text-sm ${announceForm.id === item.id ? 'text-indigo-700' : 'text-gray-700'}`}>{item.title}</h4>
                                <span className={`text-[10px] px-2 py-0.5 rounded-full border ${item.active ? 'bg-green-50 text-green-600 border-green-200' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>
                                    {item.active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                            <p className="text-xs text-gray-500 line-clamp-2">{item.detail}</p>
                            <div className="mt-2 text-[10px] text-gray-400 flex justify-between">
    <span>{item.timestamp}</span>
</div>
                        </div>
                    ))}
                </div>

                {/* Right: Edit Form */}
                <div className="w-2/3 p-6 overflow-y-auto bg-white">
                    <div className="max-w-xl mx-auto space-y-4">
                        <div className="flex justify-between items-center mb-4">
                            <h4 className="font-bold text-gray-800 text-lg">
                                {announceForm.id ? 'แก้ไขประกาศ' : 'สร้างประกาศใหม่'}
                            </h4>
                            {announceForm.id && (
                                <span className="text-xs font-mono text-gray-400 bg-gray-100 px-2 py-1 rounded">{announceForm.id}</span>
                            )}
                        </div>

                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1.5">หัวข้อ (Title)</label>
                            <input 
                                type="text" 
                                className="w-full p-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="ระบุหัวข้อเรื่อง..."
                                value={announceForm.title}
                                onChange={e => setAnnounceForm({...announceForm, title: e.target.value})}
                            />
                        </div>
                        <div>
                             <label className="block text-sm font-bold text-gray-700 mb-1.5">รายละเอียด (Details)</label>
                            <textarea 
                                rows="8"
                                className="w-full p-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="ระบุรายละเอียดข้อความ..."
                                value={announceForm.detail}
                                onChange={e => setAnnounceForm({...announceForm, detail: e.target.value})}
                             ></textarea>
                        </div>

                        <div className="flex gap-3 pt-4 border-t border-gray-100 mt-6">
                            {announceForm.id && (
                                <>
                                    <button 
                                        onClick={() => {
                                            if(!confirm('ยืนยันลบประกาศนี้?')) return;
                                            setIsAnnounceLoading(true);
                                            google.script.run.withSuccessHandler(() => {
                                                setAnnouncements(prev => prev.filter(a => a.id !== announceForm.id));
                                                setAnnounceForm({ id: '', title: '', detail: '', active: true });
                                                setIsAnnounceLoading(false);
                                                showToast('ลบประกาศเรียบร้อย');
                                            }).deleteAnnouncementItem(announceForm.id);
                                        }}
                                        className="bg-white border border-red-200 text-red-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-50"
                                        disabled={isAnnounceLoading}
                                    >
                                        ลบ
                                    </button>

                                    <button 
                                        onClick={() => {
                                            const newStatus = !announceForm.active;
                                            setIsAnnounceLoading(true);
                                            google.script.run.withSuccessHandler((res) => {
                                                setAnnouncements(prev => prev.map(a => a.id === announceForm.id ? {...a, active: newStatus} : a));
                                                setAnnounceForm({...announceForm, active: newStatus});
                                                setIsAnnounceLoading(false);
                                                showToast(res.message);
                                            }).toggleAnnouncementStatus(announceForm.id, newStatus);
                                        }}
                                        className={`px-4 py-2 rounded-lg text-sm font-bold border transition-colors ${announceForm.active ? 'bg-orange-50 text-orange-600 border-orange-200 hover:bg-orange-100' : 'bg-green-50 text-green-600 border-green-200 hover:bg-green-100'}`}
                                        disabled={isAnnounceLoading}
                                    >
                                        {announceForm.active ? 'หยุดประกาศ (Unpublish)' : 'เริ่มประกาศ (Publish)'}
                                    </button>
                                </>
                            )}
                            
                            <div className="flex-1"></div>

                            <button 
                                onClick={() => {
                                    if(!announceForm.title || !announceForm.detail) { showToast('กรุณากรอกข้อมูลให้ครบ', 'error'); return; }
                                    setIsAnnounceLoading(true);
                                    const payload = { ...announceForm, updatedBy: `${user.firstName} ${user.lastName}` };
                                    google.script.run.withSuccessHandler((res) => {
                                        if (announceForm.id) {
                                            setAnnouncements(prev => prev.map(a => a.id === res.data.id ? res.data : a));
                                        } else {
                                            setAnnouncements(prev => [res.data, ...prev]);
                                            setAnnounceForm(res.data); // Set current to saved one
                                        }
                                        setIsAnnounceLoading(false);
                                        showToast(res.message);
                                    }).saveAnnouncementItem(payload);
                                }}
                                className="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 shadow-md flex items-center gap-2"
                                disabled={isAnnounceLoading}
                            >
                                <Save className="w-4 h-4"/> บันทึกข้อมูล
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
)}
              {activeTab === 'orders' && (
  <div className="space-y-6 max-w-7xl mx-auto">
    <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-wrap gap-4 items-center justify-between">
      <div className="flex items-center gap-4 flex-1 min-w-[200px]">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
          <input type="text" className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none" placeholder="ค้นหา..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}/>
        </div>
        {/* ⭐ เพิ่มตัวกรองสถานะ */}
        <select 
          value={statusFilter} 
          onChange={(e) => setStatusFilter(e.target.value)}
          className="p-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500 bg-white cursor-pointer"
        >
          <option value="All">ทุกสถานะ</option>
          {Object.keys(STATUS_LABELS).map(key => <option key={key} value={key}>{STATUS_LABELS[key]}</option>)}
        </select>
      </div>
    </div>
    
    <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
      <div className="divide-y divide-gray-100">
        {filteredRequests.length === 0 ? (
          <div className="p-12 text-center text-gray-400 bg-white border-t border-gray-100">
            <div className="bg-gray-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
              <FileText className="w-8 h-8 text-gray-300"/>
            </div>
            <p className="text-lg font-bold text-gray-500">ไม่มีรายการ</p>
            <p className="text-sm">คุณไม่มีรายการที่ต้องดำเนินการในขณะนี้</p>
          </div>
        ) : (
         
         
filteredRequests.map(req => {
  // --- คำนวณวันคงเหลือ ---
  const getDaysDiff = (d) => {
    if(!d) return 999;
    const diff = new Date(d) - new Date();
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
  };
  const daysLeft = getDaysDiff(req.dateRequired);
  let alertBadge = null;

  // เงื่อนไขแจ้งเตือน (เพิ่ม: เลยกำหนด)
  if (!['Completed', 'Rejected', 'Returned'].includes(req.status)) {
    if (daysLeft < 0) alertBadge = { text: `เลยกำหนด ${Math.abs(daysLeft)} วัน`, color: 'bg-red-600 text-white animate-pulse border-red-700' };
    else if (daysLeft <= 1) alertBadge = { text: 'ครบกำหนดวันนี้/พรุ่งนี้!', color: 'bg-red-500 text-white' };
    else if (daysLeft <= 3) alertBadge = { text: 'อีก 3 วัน', color: 'bg-red-100 text-red-700' };
    else if (daysLeft <= 7) alertBadge = { text: 'อีก 1 สัปดาห์', color: 'bg-orange-100 text-orange-700' };
    else if (daysLeft <= 14) alertBadge = { text: 'อีก 2 สัปดาห์', color: 'bg-yellow-100 text-yellow-800' };
    else if (daysLeft <= 30) alertBadge = { text: 'อีก 1 เดือน', color: 'bg-blue-50 text-blue-600' };
  }
  
  return (
    <div key={req.id} className="p-5 hover:bg-slate-50 transition-colors group">
      <div className="flex justify-between mb-2">
        <div className="flex items-center gap-3 flex-wrap">
          
          {/* 1. Badge ประเภทคำขอ (แก้ไข: แสดง HO Rent/Buy) */}
          <span className={`text-[10px] px-2 py-0.5 rounded-full border font-bold ${req.type === 'Local' ? 'bg-orange-50 text-orange-700' : req.type === 'Withdraw' ? 'bg-pink-50 text-pink-700' : req.type === 'Borrow' ? 'bg-blue-50 text-blue-700' : 'bg-purple-50 text-purple-700'}`}>
              {req.type === 'HO' ? `HO (${req.purchaseType || 'Buy'})` : req.type}
          </span>
          
          {/* 2. Alert Badge (รวมถึงเลยกำหนด) */}
          {alertBadge && (
            <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center gap-1 ${alertBadge.color}`}>
              <Clock className="w-3 h-3"/> {alertBadge.text}
            </span>
          )}

          <span className="text-xs text-gray-400">{req.id}</span>
          <DocIdBadge type={req.type} id={req.docNumber} />

          {/* 3. เพิ่ม: แสดงวันที่ต้องการ (Date Required) */}
          {req.dateRequired && (
             <span className="text-[10px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded border flex items-center gap-1" title="วันที่ต้องการใช้ของ">
                 <Calendar className="w-3 h-3"/> {req.dateRequired}
             </span>
          )}

          {/* 4. ชื่อสินค้า + จำนวนที่เหลือ */}
          <h4 className="font-bold text-gray-900 text-sm flex items-center">
              {req.items[0]?.name}
              {req.items.length > 1 && (
                  <span className="text-gray-500 font-normal text-xs ml-1 bg-gray-200 px-1.5 rounded-full">
                      +{req.items.length - 1}
                  </span>
              )}
          </h4>
        </div>
       {/* ใช้ Component ใหม่ครอบ StatusBadge */}
<StatusWithTooltip request={req} allUsers={allUsers}>
    <StatusBadge 
        status={req.status} 
        type={req.type} 
        // ไม่ต้องส่ง onClick ไปที่นี่แล้ว เพราะจัดการที่ Wrapper
    />
</StatusWithTooltip>
      </div>
      
      <ProgressBar request={req} />
      
      {/* ส่วนปุ่ม Action คงเดิม */}
      <div className="flex justify-end gap-2 mt-2">

      {(() => {
            // 1. ฟังก์ชันหาสถานะก่อนหน้า
            const getPrevStatus = (r) => {
                // ⭐ เพิ่มเงื่อนไขนี้: ถ้าสถานะเป็น "Ordered" ให้ย้อนกลับไป "Approved"
                if (r.status === 'Ordered') return 'Approved';

                if (r.status === 'PR Issued') return 'Approved';
                if (r.status === 'PO Issued') return 'PR Issued';
                if (r.status === 'Contract Pending') return 'Approved';
                if (r.status === 'Contract Signed') return 'Contract Pending';
                if (r.status === 'Shipping') return r.purchaseType === 'Rent' ? 'Contract Signed' : 'PO Issued';
                return null;
            };
            const prevStatus = getPrevStatus(req);
            
            // 2. ถ้ามีสถานะย้อนกลับได้ ให้เช็คสิทธิ์
            if (prevStatus) {
                // หา Log ล่าสุดที่เป็นสถานะปัจจุบัน เพื่อดูว่าใครเป็นคนกด
                const lastLog = [...req.history].reverse().find(h => 
                    h.action === req.status || h.action === STATUS_LABELS[req.status]
                );
                
                // ตรวจสอบว่าเป็น User ปัจจุบันหรือไม่ (เช็คจาก EmpID หรือ ชื่อ)
                const isActor = lastLog && user && (
                    lastLog.user.includes(user.empId) || 
                    lastLog.user.includes(user.firstName)
                );

                if (isActor) {
                    return (
                        <button 
                            type="button" 
                            onClick={() => {
                                if(confirm(`ยืนยันการย้อนสถานะกลับไปเป็น "${STATUS_LABELS[prevStatus] || prevStatus}"?`)) {
                                    handleUpdateStatus(req.id, prevStatus, `ย้อนกลับสถานะ (Rollback) จาก ${req.status}`);
                                }
                            }}
                            className="flex items-center gap-2 px-4 py-2 bg-orange-50 border border-orange-200 text-orange-700 text-sm font-medium rounded-lg hover:bg-orange-100 shadow-sm transition-colors animate-in fade-in"
                        >
                            <RotateCcw className="w-4 h-4"/> ย้อนกลับ ({prevStatus.split(' ')[0]})
                        </button>
                    );
                }
            }
            return null;
        })()}
        
       {((req.requester === `${user.firstName} ${user.lastName}`) || user.isSuperAdmin || hasPermission(2, req.job)) && req.status === 'Draft' && (
            <button type="button" onClick={() => handleEditDraft(req)} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-sm">
                <Edit className="w-4 h-4"/> แก้ไขแบบร่าง
            </button>
        )}

        {((req.requester === `${user.firstName} ${user.lastName}`) || user.isSuperAdmin || hasPermission(2, req.job)) && req.status === 'Revise Needed' && (
            <button type="button" onClick={() => handleRevise(req)} className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 shadow-sm animate-pulse">
                <Edit className="w-4 h-4"/> แก้ไขข้อมูล/ส่งใหม่
            </button>
        )}


        {(() => {
            // 1. เช็คสิทธิ์: ต้องเป็นเจ้าของรายการเท่านั้น
            const isOwner = req.requester === `${user.firstName} ${user.lastName}`;
            
            // 2. เช็คสถานะตามประเภท:
            // - การสั่งซื้อ (Local/HO): ดึงได้จนถึง Pending PM (Level 2) รวมถึง Pending Check/Head ด้วย
            const canRecallBuy = ['Local', 'HO'].includes(req.type) && ['Pending Check', 'Pending Head', 'Pending PM'].includes(req.status);
            
            // - การเบิก/ยืม (Withdraw/Borrow): ดึงได้เฉพาะ Pending Head (Level 1/2)
            const canRecallUse = ['Withdraw', 'Borrow'].includes(req.type) && ['Pending Head'].includes(req.status);

            if (isOwner && (canRecallBuy || canRecallUse)) {
                return (
                    <button type="button" onClick={() => initiateRecall(req.id)} className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 shadow-sm transition-colors">
                        <RotateCcw className="w-4 h-4"/> เรียกคืน
                    </button>
                );
            }
            return null;
        })()}



{['Approved', 'Ordered', 'PR Issued', 'PO Issued', 'Shipping', 'Contract Signed', 'Partially Received', 'Ready to Disburse', 'Completed', 'Returned'].includes(req.status) && 
 (req.type === 'Local' || 
  req.type === 'Withdraw' || 
  req.type === 'Borrow' || 
  // ⭐ แก้ไขเงื่อนไข HO: ยอมรับทั้ง Full Flow หรือรายการที่เคยอนุมัติแล้ว (เคสเปลี่ยนจาก Local)
  (req.type === 'HO' && (req.isFullApprovalFlow || req.isPreviouslyApproved))
 ) && (
  <button type="button" onClick={() => handleOpenPrintPreview(req)} className="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 border border-blue-200 text-sm font-medium rounded-lg hover:bg-blue-100 shadow-sm">
      <Printer className="w-4 h-4"/> พิมพ์
  </button>
)}
        
        <button type="button" onClick={() => { setSelectedRequest(req); setShowDetailModal(true); }} className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 shadow-sm"><History className="w-4 h-4"/> ประวัติ/รายละเอียด</button>
        
{req.status !== 'Draft' && (
          <>
            {/* ⭐ [แก้ไข] เงื่อนไขการแสดงปุ่มสำหรับ Pending Head */}
            {req.status === 'Pending Head' && (
              // แสดงเมื่อ: (เป็นงานซื้อและมีสิทธิ์ L1) หรือ (เป็นงานเบิกยืมและมีสิทธิ์ L1 หรือ L2)
              ( (['Local', 'HO'].includes(req.type) && hasPermission(8)) || 
                (['Withdraw', 'Borrow'].includes(req.type) && (hasPermission(8) || hasPermission(9))) )
            ) && (
              <>
                <button type="button" onClick={() => openRejectModal(req.id)} className="px-4 py-2 border border-red-300 text-red-600 text-sm font-medium rounded-lg hover:bg-red-50 shadow-sm">ไม่อนุมัติ</button>
                <button type="button" onClick={() => handleUpdateStatus(req.id, (req.type === 'Withdraw' || req.type === 'Borrow') ? 'Ready to Disburse' : 'Pending PM')} className="px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700 shadow-sm">
                    {/* เปลี่ยนข้อความปุ่มให้ชัดเจน */}
                    {(req.type === 'Withdraw' || req.type === 'Borrow') ? 'อนุมัติเบิก/ยืม (Approve)' : 'ส่งต่อ Level 2'}
                </button>
              </>
            )}
            
            {hasPermission(9) && req.status === 'Pending PM' && (
              <>
                <button type="button" onClick={() => openRejectModal(req.id)} className="px-4 py-2 border border-red-300 text-red-600 text-sm font-medium rounded-lg hover:bg-red-50 shadow-sm">ไม่อนุมัติ</button>
                <button type="button" onClick={() => handleApprovalUpdate(req.id, 'Approved')} className="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 shadow-sm">อนุมัติการสั่งซื้อ</button>
              </>
            )}

            {hasPermission(10) && req.type === 'Local' && req.status === 'Approved' && (
    <button 
        type="button" 
        onClick={() => openVerificationModal(req.id, true)} // ส่ง true = Change Mode
        className="px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 shadow-sm flex items-center gap-1"
    >
        <RefreshCw className="w-4 h-4"/> เปลี่ยนเป็น HO
    </button>
)}

            {hasPermission(24) && (req.type === 'Withdraw' || req.type === 'Borrow') && req.status === 'Ready to Disburse' && (
              <button type="button" onClick={() => openDisburseModal(req.id)} className="px-4 py-2 bg-teal-600 text-white text-sm font-medium rounded-lg hover:bg-teal-700 shadow-sm">จ่ายของ & ตัดสต็อก/ยืม</button>
            )}
            {hasPermission(12) && req.type === 'Local' && req.status === 'Approved' && (
              <button type="button" onClick={() => handleUpdateStatus(req.id, 'Ordered')} className="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 shadow-sm">สั่งซื้อ (Local)</button>
            )}
            {hasPermission(15) && req.type === 'Local' && (req.status === 'Ordered' || req.status === 'Partially Received') && (
              <button type="button" onClick={() => openReceiveModal(req)} className="px-4 py-2 bg-teal-600 text-white text-sm font-medium rounded-lg hover:bg-teal-700 shadow-sm">รับของ/ปิดงาน</button>
            )}
          
            {hasPermission(10) && req.status === 'Pending Check' && (
              <button type="button" onClick={() => openVerificationModal(req.id)} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-sm"><CheckSquare className="w-4 h-4"/> ตรวจสอบเอกสาร (Verify)</button>
            )}
            
            {/* --- HO Buy Flow --- */}
            {hasPermission(11) && req.type === 'HO' && req.status === 'Approved' && req.purchaseType === 'Buy' && (
              <button type="button" onClick={() => openPRModal(req.id)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 shadow-sm">ออก PR</button>
            )}

            {hasPermission(12) && req.type === 'HO' && req.purchaseType === 'Buy' && req.status === 'PR Issued' && (
              <button type="button" onClick={() => openPOModal(req.id)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 shadow-sm">ออก PO</button>
            )}

            {hasPermission(13) && req.type === 'HO' && req.purchaseType === 'Buy' && req.status === 'PO Issued' && (
              <button type="button" onClick={() => handleUpdateStatus(req.id, 'Shipping')} className="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-sm">อัปเดตส่งของ</button>
            )}
            
            {/* --- HO Rent Flow --- */}
            {hasPermission(14) && req.type === 'HO' && req.purchaseType === 'Rent' && req.status === 'Contract Pending' && (
              <button type="button" onClick={() => openContractModal(req.id)} className="flex items-center gap-2 px-4 py-2 bg-teal-600 text-white text-sm font-medium rounded-lg hover:bg-teal-700 shadow-sm">
    <FileSignature className="w-4 h-4"/> บันทึกทำสัญญาแล้ว
</button>
            )}
            {hasPermission(13) && req.type === 'HO' && req.purchaseType === 'Rent' && req.status === 'Contract Signed' && (
              <button type="button" onClick={() => handleUpdateStatus(req.id, 'Shipping')} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-sm"><Truck className="w-4 h-4"/> เริ่มจัดส่ง/ส่งมอบ</button>
            )}

            {hasPermission(15) && req.type === 'HO' && (req.status === 'Shipping' || req.status === 'Partially Received') && (
              <button type="button" onClick={() => openReceiveModal(req)} className="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 shadow-sm">ยืนยันได้รับของ</button>
            )}
            
            {(hasPermission(14) || hasPermission(13)) && req.type === 'HO' && req.purchaseType === 'Rent' && req.status === 'Approved' && (
              req.needContract !== false 
              ? (hasPermission(14) && <button type="button" onClick={() => handleUpdateStatus(req.id, 'Contract Pending')} className="flex items-center gap-2 px-4 py-2 bg-teal-600 text-white text-sm font-medium rounded-lg hover:bg-teal-700 shadow-sm">ทำสัญญาต่อ (หลังอนุมัติ)</button>)
              : (hasPermission(13) && <button type="button" onClick={() => handleUpdateStatus(req.id, 'Shipping')} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-sm">จัดส่งต่อ (หลังอนุมัติ)</button>)
            )}
          </>
        )}
      </div>
    </div>
  );
})
        )}
      </div>
    </div>
  </div>
)} 
    
{/* INVENTORY TAB (UPDATED WITH MULTI-DELETE) */}
              {activeTab === 'inventory' && (
                <div className="space-y-6 max-w-7xl mx-auto">
                   <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                      <div className="px-6 py-4 border-b bg-gray-50 flex flex-col md:flex-row justify-between items-center gap-4">

         
                         
                         {/* Left: Title & Delete Button */}
                         <div className="flex items-center gap-4">
                             <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2">
                                 <Box className="w-5 h-5"/> คลังวัสดุสิ้นเปลือง 
                                 {/* ⭐ เพิ่ม: แสดงจำนวนรายการ */}
                                 <span className="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full font-normal">
                                     {filteredInventory.length} รายการ
                                 </span>
                             </h3>
                             
                             {/* ปุ่มลบหลายรายการ */}
                             {selectedInventory.length > 0 && invTabMode !== 'Summary' && hasPermission(18) && (
                                 <button 
                                    onClick={() => handleDeleteInventory()} 
                                    className="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-sm font-bold border border-red-200 hover:bg-red-100 flex items-center gap-2 animate-in fade-in"
                                >
                                     <Trash2 className="w-4 h-4"/> ลบ {selectedInventory.length} รายการ
                                 </button>
                             )}
                         </div>
                         
                         {/* Middle: Tabs Selection */}
                         <div className="flex bg-gray-200 p-1 rounded-lg">
                            <button onClick={() => { setInvTabMode('System'); setSelectedInventory([]); }} className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${invTabMode === 'System' ? 'bg-white text-blue-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>ของในระบบ</button>
                            <button onClick={() => { setInvTabMode('NonSystem'); setSelectedInventory([]); }} className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${invTabMode === 'NonSystem' ? 'bg-white text-orange-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>ของนอกระบบ</button>
                            <button onClick={() => { setInvTabMode('Summary'); setSelectedInventory([]); }} className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${invTabMode === 'Summary' ? 'bg-white text-purple-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>รวม (Summary)</button>
                         </div>

                         {/* Right: Search & Actions */}
                         <div className="flex gap-2 items-center">
                           <div className="relative w-48">
                                <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                                <input type="text" className="w-full pl-10 pr-4 py-1.5 border border-gray-300 rounded-lg text-sm outline-none" placeholder="ค้นหาสินค้า..." value={invSearch} onChange={e => setInvSearch(e.target.value)}/>
                           </div>
                           <button onClick={() => openGeneralHistory()} className="text-gray-600 text-sm font-medium flex items-center gap-1 hover:bg-gray-100 px-3 py-1.5 rounded"><ClipboardList className="w-4 h-4"/> ประวัติ</button>



{/* ปุ่ม Checklist - แสดงเฉพาะ Admin (2) หรือผู้ที่มีสิทธิ์จัดการสินค้า (16, 17, 18) */}
{(hasPermission(2) || hasPermission(16) || hasPermission(17) || hasPermission(18)) && (
    <button 
        onClick={() => openChecklistModal('Inventory')} 
        className="bg-indigo-50 text-indigo-700 text-sm font-medium flex items-center gap-1 px-3 py-1.5 rounded hover:bg-indigo-100 border border-indigo-200 shadow-sm"
        title="พิมพ์ใบเช็คลิสต์สำหรับเดินตรวจนับของ (Print Checklist)" // ⭐ Tooltip
    >
        <ClipboardList className="w-4 h-4"/> พิมพ์
    </button>
)}
                           
{/* ⭐ ปุ่มเพิ่มสินค้า (Inventory) - สิทธิ์ 16 */}
{hasPermission(16) && (
    <button 
        onClick={() => { 
            setShowAddInvModal(true); 
            setNewStockItem({ 
                name: '', qty: 0, unit: 'ชิ้น', minStock: 0, price: 0, images: [], stockType: 'System',
                project: globalProjectFilter !== 'All' ? globalProjectFilter : '',
                id: '', 
                isAutoId: true 
            });
        }}
        className="bg-green-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-1.5 rounded hover:bg-green-700"
        title="เพิ่มรายการสินค้าใหม่เข้าสู่ระบบ (Add New Item)" // ⭐ Tooltip
    >
        <Plus className="w-4 h-4"/> เพิ่ม
    </button>
)}

{hasPermission(17) && ( // ต้องมีสิทธิ์แก้ไขสินค้า
    <button 
        onClick={() => {
            const itemsToAudit = filteredInventory.map(i => ({
                ...i,
                countedQty: i.qty,
                reason: ''
            }));
            setAuditItems(itemsToAudit);
            setShowAuditModal(true);
        }}
        className="bg-orange-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-1.5 rounded hover:bg-orange-700 shadow-sm"
        title="เข้าสู่โหมดตรวจนับสต็อกจริง เพื่อปรับปรุงยอด (Stock Audit)" // ⭐ Tooltip
    >
        <ClipboardList className="w-4 h-4"/> ตรวจนับ
    </button>
)}

{hasPermission(22) && (
    <>
        <button 
            onClick={() => setShowImportInvModal(true)} 
            className="bg-teal-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-1.5 rounded hover:bg-teal-700 transition-colors shadow-sm"
            title="นำเข้าข้อมูลสินค้าจำนวนมากจากไฟล์ CSV (Import)" // ⭐ Tooltip
        >
            <Download className="w-4 h-4 rotate-180"/> Import
        </button>     
    </>
)}


                         </div>
                      </div>

                      {/* TABLE */}
                      <table className="w-full text-sm text-left">
                         <thead className="bg-gray-100 text-gray-600">
                            <tr>
                                {/* ⭐ แก้ไข: เพิ่มเงื่อนไข hasPermission(18) */}
                                {invTabMode !== 'Summary' && hasPermission(18) && (
                                    <th className="px-4 py-3 w-10 text-center">
                                        <input type="checkbox" className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                                            checked={filteredInventory.length > 0 && selectedInventory.length === filteredInventory.length}
                                            onChange={toggleSelectAllInventory}
                                        />
                                    </th>
                                )}
                                
                                <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('id', invSort, setInvSort)}>รหัส <ArrowUpDown className="w-3 h-3 inline"/></th>
                                <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('name', invSort, setInvSort)}>ชื่อสินค้า <ArrowUpDown className="w-3 h-3 inline"/></th>
{globalProjectFilter === 'All' && invTabMode !== 'Summary' && (
    <th className="px-6 py-3 text-center cursor-pointer hover:bg-gray-200" onClick={() => handleSort('project', invSort, setInvSort)}>
    โครงการ <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
</th>
)}

                                <th className="px-6 py-3 text-center cursor-pointer hover:bg-gray-200" onClick={() => handleSort('qty', invSort, setInvSort)}>คงเหลือ <ArrowUpDown className="w-3 h-3 inline"/></th>
                                <th className="px-6 py-3 text-center">สถานะ</th>
                                <th className="px-6 py-3 text-center">อัปเดตล่าสุด</th>
                            </tr>
                         </thead>
                         <tbody className="divide-y">
                             {filteredInventory.map(inv => (
                               <tr key={inv.id} onClick={() => openViewItem(inv)} className="hover:bg-gray-50 cursor-pointer">
                                  
                                  {/* ⭐ แก้ไข: เพิ่มเงื่อนไข hasPermission(18) */}
                                  {invTabMode !== 'Summary' && hasPermission(18) && (
                                      <td className="px-4 py-4 text-center" onClick={(e) => e.stopPropagation()}>
                                           <input type="checkbox" className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                                               checked={selectedInventory.includes(inv.id)}
                                               onChange={() => toggleSelectInventory(inv.id)}
                                          />
                                      </td>
                                  )}

                                  <td className="px-6 py-4 font-medium text-gray-500">
    {/* ⭐ ใช้ getDisplayId เพื่อโชว์แค่รหัสสั้น */}
    {inv.isSummary ? <span className="italic text-gray-400">Sum</span> : getDisplayId(inv.id)}
</td>
                                  <td className="px-6 py-4">
                                       <div className="font-medium text-gray-900">{inv.name}</div>
                                       
                                       {/* ⭐ แก้ไข: ส่วนแสดงรายละเอียดของ Summary */}
                                       {inv.isSummary ? (
                                           <div className="mt-1 space-y-1">
                                               {/* แยกประเภท System / NonSystem */}
                                               <div className="flex gap-2 text-[10px]">
                                                   <span className="bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded border border-blue-100 font-bold">
                                                       ในระบบ: {inv.systemQty}
                                                   </span>
                                                   <span className="bg-orange-50 text-orange-700 px-1.5 py-0.5 rounded border border-orange-100 font-bold">
                                                       นอกระบบ: {inv.nonSystemQty}
                                                   </span>
                                               </div>
                                               
                                               {/* แยกโครงการ (แสดงเฉพาะถ้าเลือกดูทุกโครงการ) */}
                                               {globalProjectFilter === 'All' && inv.projectBreakdown && (
                                                   <div className="flex flex-wrap gap-1 mt-1">
                                                       {Object.entries(inv.projectBreakdown).map(([proj, qty]) => (
                                                           <span key={proj} className="text-[9px] bg-gray-100 text-gray-600 px-1.5 rounded border border-gray-200" title={`โครงการ ${proj}`}>
                                                               {proj}: <b>{qty}</b>
                                                           </span>
                                                       ))}
                                                   </div>
                                               )}
                                           </div>
                                       ) : (
                                           /* ของเดิม (แสดง ID รวม) ถ้าไม่ใช่ Summary อาจจะไม่ต้องแสดงอะไร หรือแสดงตามเดิม */
                                           null
                                       )}
                                  </td>

                                  {globalProjectFilter === 'All' && invTabMode !== 'Summary' && (
    <td className="px-6 py-4 text-center">
        <span className="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs font-bold border border-indigo-100">
            {inv.project || 'ส่วนกลาง'}
        </span>
    </td>
)}
                                  <td className="px-6 py-4 text-center">
                                      <span className={`text-lg font-bold ${inv.isSummary ? 'text-purple-600' : 'text-blue-600'}`}>
                                          {inv.qty}
                                      </span> 
                                      <span className="text-gray-500 text-xs ml-1">{inv.unit}</span>
                                  </td>
                                  <td className="px-6 py-4 text-center">
                                      {inv.qty < inv.minStock ? <span className="text-red-600 text-xs font-bold bg-red-50 px-2 py-1 rounded">ต่ำกว่าเกณฑ์</span> : <span className="text-green-600 text-xs bg-green-50 px-2 py-1 rounded">ปกติ</span>}
                                  </td>
                                  <td className="px-6 py-4 text-center text-xs text-gray-500">{inv.lastUpdated || '-'}</td>
                               </tr>
                            ))}
                            {filteredInventory.length === 0 && (
                                <tr>
                                    <td colSpan={invTabMode !== 'Summary' ? 6 : 5} className="text-center py-8 text-gray-400">
                                        ไม่พบข้อมูลสินค้า
                                    </td>
                                </tr>
                            )}
                         </tbody>
                      </table>
                   </div>
                </div>
              )}
    
{/* ASSETS TAB (UPDATED: Summary No Action Column) */}
      {activeTab === 'assets' && (
        <div className="space-y-6 max-w-7xl mx-auto">
           <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
              <div className="px-6 py-4 border-b bg-gray-50 flex flex-col md:flex-row justify-between items-center gap-4">


                 
                 {/* Left Side */}
                 <div className="flex items-center gap-4">
                     <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2">
                         <Monitor className="w-5 h-5"/> ทะเบียนทรัพย์สิน
                         
                         {/* ⭐ เพิ่มส่วนนี้: แสดงจำนวนรายการ */}
                         <span className="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full font-normal">
                             {filteredAssets.length} รายการ
                         </span>
                     </h3>
                     {/* ปุ่มลบ (ซ่อนถ้าเป็น Summary) */}
                     {selectedAssets.length > 0 && assetTabMode !== 'Summary' && hasPermission(21) && (
                         <button onClick={() => handleDeleteAssets()} className="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-sm font-bold border border-red-200 hover:bg-red-100 flex items-center gap-2 animate-in fade-in">
                             <Trash2 className="w-4 h-4"/> ลบ {selectedAssets.length} รายการ
                         </button>
                     )}
                 </div>
                 
                 {/* Middle: Search */}
                 <div className="flex items-center gap-3 flex-1 justify-end w-full md:w-auto">
                    <div className="relative w-full md:w-64">
                        <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                        <input type="text" className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ค้นหารหัส, ชื่อ..." value={assetSearch} onChange={e => setAssetSearch(e.target.value)}/>
                    </div>
                 </div>

                 {/* Right: Actions & Tabs */}
                 <div className="flex gap-3">
                    <div className="flex bg-gray-100 p-1 rounded-lg">
                        <button onClick={() => setAssetTabMode('Company')} className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${assetTabMode === 'Company' ? 'bg-white text-blue-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>บริษัท</button>
                        <button onClick={() => setAssetTabMode('Rent')} className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${assetTabMode === 'Rent' ? 'bg-white text-teal-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>เช่า</button>
                        <button onClick={() => setAssetTabMode('Summary')} className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${assetTabMode === 'Summary' ? 'bg-white text-purple-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>รวม</button>
                    </div>

                    <button onClick={() => openGeneralHistory()} className="text-gray-600 text-sm font-medium flex items-center gap-1 hover:bg-gray-100 px-3 py-1.5 rounded"><ClipboardList className="w-4 h-4"/> ประวัติ</button>


                {/* ปุ่ม Checklist - แสดงเฉพาะ Admin (2) หรือผู้ที่มีสิทธิ์จัดการทรัพย์สิน (19, 20, 21) */}
{(hasPermission(2) || hasPermission(19) || hasPermission(20) || hasPermission(21)) && (
    <button 
        onClick={() => openChecklistModal('Asset')} 
        className="bg-indigo-50 text-indigo-700 text-sm font-medium flex items-center gap-1 px-3 py-1.5 rounded hover:bg-indigo-100 border border-indigo-200 shadow-sm"
        title="พิมพ์ทะเบียนทรัพย์สินสำหรับตรวจสอบ (Print Asset List)" // ⭐ Tooltip
    >
        <ClipboardList className="w-4 h-4"/> พิมพ์
    </button>
)}
                    

               {/* ⭐ ปุ่มเพิ่มทรัพย์สิน (Asset) - สิทธิ์ 19 */}
{hasPermission(19) && (
    <button 
        onClick={() => { 
            setShowAssetModal(true); 
            setNewAssetItem({ 
                id: '', isAutoId: false, name: '', serial: '', status: 'Available', condition: 'Good', ownerType: '', price: 0, rentalPrice: 0, rentalUnit: 'Month', images: [],
                project: globalProjectFilter !== 'All' ? globalProjectFilter : '' 
            });
        }} 
        className="bg-indigo-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-1.5 rounded hover:bg-indigo-700"
        title="ลงทะเบียนทรัพย์สินใหม่ (Register New Asset)" // ⭐ Tooltip
    >
        <Plus className="w-4 h-4"/> เพิ่ม
    </button>
)}

{/* ⭐ ปุ่ม Import ทรัพย์สิน (Asset) - สิทธิ์ 23 */}
{hasPermission(23) && (
    <button 
        onClick={() => setShowImportAssetModal(true)} 
        className="bg-green-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-1.5 rounded hover:bg-green-700"
        title="นำเข้าข้อมูลทรัพย์สินจากไฟล์ CSV (Import)" // ⭐ Tooltip
    >
        <Download className="w-4 h-4 rotate-180"/> Import
    </button>
)}
                 </div>
              </div>
              
              <div className="overflow-x-auto">
                  <table className="w-full text-sm text-left min-w-[1000px]">
                     <thead className="bg-gray-100 text-gray-600">
                        <tr>
                            {/* Checkbox Header (ซ่อนถ้า Summary) */}
                            {assetTabMode !== 'Summary' && hasPermission(21) && (
                                
                                <th className="px-4 py-3 w-10 text-center">
                                    <input type="checkbox" className="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer" 
                                        checked={filteredAssets.length > 0 && selectedAssets.length === filteredAssets.length}
                                        onChange={toggleSelectAllAssets}
                                    />
                                </th>
                            )}
                            
                            {assetTabMode === 'Summary' ? (
                                /* ⭐ Header สำหรับโหมด Summary (ตัด Action ออก) */
                                <>
                                    <th className="px-6 py-3 text-left">รายการทรัพย์สิน (Name)</th>
                                    <th className="px-6 py-3 text-center">จำนวนรวม</th>
                                    <th className="px-6 py-3 text-center text-blue-700">ของบริษัท</th>
                                    <th className="px-6 py-3 text-center text-orange-700">ของเช่า</th>
                                </>
                            ) : (
                                /* Header ปกติ */
                                <>
                                    <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('id', assetSort, setAssetSort)}>รหัสทรัพย์สิน <ArrowUpDown className="w-3 h-3 inline"/></th>
                                    <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('name', assetSort, setAssetSort)}>รายการ <ArrowUpDown className="w-3 h-3 inline"/></th>
{globalProjectFilter === 'All' && assetTabMode !== 'Summary' && (
    <th className="px-6 py-3 text-center cursor-pointer hover:bg-gray-200" onClick={() => handleSort('project', assetSort, setAssetSort)}>
    โครงการ <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
</th>
)}

                                    <th className="px-6 py-3">Serial No.</th>
                                    <th className="px-6 py-3 text-center">สถานะ</th>
                                    {assetTabMode === 'Rent' && <th className="px-6 py-3">ระยะเวลาเช่า</th>}
                                    {assetTabMode === 'Rent' && <th className="px-6 py-3 text-right">ราคาเช่า</th>}
                                    <th className="px-6 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleSort('holder', assetSort, setAssetSort)}>ผู้ถือครอง <ArrowUpDown className="w-3 h-3 inline"/></th>
                                    <th className="px-6 py-3 text-center">อัปเดตล่าสุด</th>
                                </>
                            )}
                        </tr>
                     </thead>
                     <tbody className="divide-y">
                        {filteredAssets.map(ast => (
                            <tr key={ast.id} 
                                onClick={() => {
                                    if (assetTabMode === 'Summary') {
                                        setSelectedAssetGroup(ast);
                                        setShowAssetGroupModal(true);
                                    } else {
                                        openViewItem(ast);
                                    }
                                }} 
                                className={`cursor-pointer transition-colors ${
                                    !ast.isSummary && ast.priority === 2 ? 'bg-red-50 hover:bg-red-100 border-l-4 border-red-500' : 
                                    !ast.isSummary && ast.priority === 1 ? 'bg-orange-50 hover:bg-orange-100 border-l-4 border-orange-400' : 
                                    'hover:bg-gray-50'
                                }`}
                            >
                               {assetTabMode === 'Summary' ? (
                                   /* ⭐ Body สำหรับโหมด Summary (ตัด Action ออก) */
                                   <>
                                       <td className="px-6 py-4 font-bold text-gray-800">{ast.name}</td>
                                       <td className="px-6 py-4 text-center">
                                           <span className="bg-purple-100 text-purple-800 px-3 py-1 rounded-full font-bold">{ast.totalQty}</span>
                                       </td>
                                       <td className="px-6 py-4 text-center font-bold text-blue-600">{ast.companyQty}</td>
                                       <td className="px-6 py-4 text-center font-bold text-orange-600">{ast.rentQty}</td>
                                   </>
                               ) : (
                                   /* Body ปกติ */
                                   <>
                                       {assetTabMode !== 'Summary' && hasPermission(21) && (
                                       <td className="px-4 py-4 text-center" onClick={(e) => e.stopPropagation()}>
                                           <input type="checkbox" className="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer" 
                                               checked={selectedAssets.includes(ast.id)}
                                               onChange={() => toggleSelectAsset(ast.id)}
                                           />
                                       </td>
                                       )}
<td className="px-6 py-4 font-medium text-gray-500">
    {ast.id}
    
    {/* แจ้งเตือนสัญญา (Contract Alerts) */}
    {ast.alertType === 'expired' && <span className="block text-[9px] text-red-600 font-bold bg-red-50 px-1 rounded w-fit mt-1">หมดสัญญาแล้ว</span>}
    {ast.alertType === 'expiring' && <span className="block text-[9px] text-orange-600 font-bold bg-orange-50 px-1 rounded w-fit mt-1">เหลือ {ast.daysLeft} วัน</span>}
    
    {/* ⭐ แจ้งเตือนยืมเกิน (แสดงเมื่อ isOverdue = true) */}
    {ast.isOverdue && (
        <span className="block text-[9px] text-purple-600 font-bold bg-purple-50 px-1 rounded w-fit mt-1">
            ยืมเกิน {ast.overdueDays} วัน
        </span>
    )}
</td>
                                       <td className="px-6 py-4 font-medium text-gray-900">{ast.name}</td>
{globalProjectFilter === 'All' && assetTabMode !== 'Summary' && (
    <td className="px-6 py-4 text-center">
        <span className="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs font-bold border border-indigo-100">
            {ast.project || 'ส่วนกลาง'}
        </span>
    </td>
)}

                                       <td className="px-6 py-4 text-gray-500">{ast.serial}</td>
                                       <td className="px-6 py-4 text-center">
    <span className={`px-2 py-1 rounded text-xs font-bold ${
        ast.status === 'Available' ? 'bg-green-100 text-green-700' :
        ast.status === 'Borrowed' ? 'bg-orange-100 text-orange-700' :
        ast.status === 'Lost' ? 'bg-gray-800 text-white' :
        ast.status === 'Damaged' ? 'bg-red-100 text-red-700' : 'bg-gray-100'
    }`}>
        {/* แก้ไขบรรทัดนี้จาก {ast.status} เป็นด้านล่าง */}
        {ASSET_STATUS_LABELS[ast.status] || ast.status}
    </span>
</td>
                                       {assetTabMode === 'Rent' && (
                                            <td className="px-6 py-4 text-xs">
                                                <div className="flex flex-col gap-1">
                                                    <span className="flex items-center gap-1 text-green-700"><Calendar className="w-3 h-3"/> {ast.rentalStart || '-'}</span>
                                                    <span className="flex items-center gap-1 text-red-700"><CalendarClock className="w-3 h-3"/> {ast.rentalEnd || '-'}</span>
                                                </div>
                                            </td>
                                       )}
                                       {assetTabMode === 'Rent' && (
                                            <td className="px-6 py-4 text-right font-medium text-gray-900">
                                                {ast.rentalPrice?.toLocaleString()} <span className="text-gray-400 text-xs font-normal">{RENTAL_UNITS[ast.rentalUnit]}</span>
                                            </td>
                                       )}
                                       <td className="px-6 py-4">{ast.holder}</td>
                                       <td className="px-6 py-4 text-center text-xs text-gray-500">{ast.lastUpdated || '-'}</td>
                                   </>
                               )}
                            </tr>
                         ))}
                     </tbody>
                  </table>
              </div>
           </div>
        </div>
      )}

 {/* --- PROJECT SETTINGS TAB --- */}
      {activeTab === 'projects' && (
        <div className="space-y-6 max-w-7xl mx-auto">
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
<div className="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
    <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2"><Settings className="w-5 h-5"/> ตั้งค่าโครงการ (Project Settings)</h3>
    
    {/* ⭐ เช็คสิทธิ์ 26 (ทั่วไป) สำหรับการสร้างโครงการใหม่ */}
    {hasPermission(26) && (
        <button 
            onClick={() => { 
                const newId = `PJ-${Date.now().toString().slice(-4)}`;
                // ⭐ เพิ่ม budget ใน object ตั้งต้น (ถ้าจำเป็น) แต่ array ว่างๆ ไม่ต้องแก้
                setEditingProject({ id: newId, originalId: newId, name: '', subJobs: [], matCodes: [], isNew: true });
                setProjectFormTab('General');
                setShowProjectModal(true); 
            }} 
            className="bg-indigo-600 text-white text-sm font-medium flex items-center gap-1 px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-sm"
        >
            <Plus className="w-4 h-4"/> เพิ่มโครงการ
        </button>
    )}
</div>

                <div className="p-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {projects.map(proj => (
                            <div 
                                key={proj.id} 
                                onClick={() => { setViewingProject(proj); setShowProjectDetailModal(true); }}
                                className="bg-white border border-gray-200 rounded-xl p-5 shadow-sm hover:shadow-md hover:border-indigo-300 transition-all group relative cursor-pointer"
                            >
                                <div className="flex justify-between items-start mb-2">
                                    <div>
                                        <h4 className="font-bold text-gray-800 text-lg group-hover:text-indigo-700 transition-colors">{proj.name}</h4>
                                        <span className="text-xs font-mono text-gray-500 bg-gray-100 px-2 py-0.5 rounded border border-gray-200">{proj.id}</span>
                                    </div>
                                    <div className="bg-gray-50 p-1.5 rounded-lg text-gray-400 group-hover:text-indigo-600 transition-colors">
                                        <ChevronRight className="w-5 h-5"/>
                                    </div>
                                </div>
                                <div className="space-y-2 mt-4 pt-4 border-t border-gray-100">
                                    <div className="flex justify-between text-sm text-gray-600">
                                        <span className="flex items-center gap-1"><List className="w-3 h-3"/> SubJobs</span>
                                        <span className="font-bold bg-indigo-50 text-indigo-700 px-2 rounded-full text-xs">{proj.subJobs?.length || 0}</span>
                                    </div>
                                    <div className="flex justify-between text-sm text-gray-600">
                                        <span className="flex items-center gap-1"><Tag className="w-3 h-3"/> Mat. Codes</span>
                                        <span className="font-bold bg-purple-50 text-purple-700 px-2 rounded-full text-xs">{proj.matCodes?.length || 0}</span>
                                    </div>
                                </div>
                            </div>
                        ))}
                        {projects.length === 0 && (
                            <div className="col-span-full py-16 text-center text-gray-400 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                                <Settings className="w-12 h-12 mx-auto mb-3 opacity-20"/>
                                <p>ยังไม่มีโครงการในระบบ</p>
                                <p className="text-xs mt-1">กดปุ่ม "เพิ่มโครงการ" เพื่อเริ่มต้น</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
      )}

{/* --- USER MANAGEMENT TAB (ปรับปรุง: ค้นหา + แยกผู้ใช้ปัจจุบัน) --- */}
      {activeTab === 'users' && (
          <div className="space-y-6 max-w-7xl mx-auto">
              <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                  
                  {/* Header & Search Bar */}
                  <div className="px-6 py-4 border-b bg-gray-50 flex flex-col md:flex-row justify-between items-center gap-4">
                      <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2">
                          <User className="w-5 h-5"/> จัดการผู้ใช้งาน (User Management)
                      </h3>
                      
                      {/* ⭐ ช่องค้นหา User */}
                      <div className="relative w-full md:w-64">
                          <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                          <input 
                              type="text" 
                              className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500 bg-white" 
                              placeholder="ค้นหาชื่อ, รหัส..." 
                              value={userSearch} 
                              onChange={e => setUserSearch(e.target.value)}
                          />
                      </div>
                  </div>

                  <div className="overflow-x-auto">
                      <table className="w-full text-sm text-left">
                          <thead className="bg-gray-100 text-gray-600 font-bold border-b">
                              <tr>
                                  <th className="px-6 py-3">Username</th>
                                  <th className="px-6 py-3">ชื่อ-นามสกุล</th>
                                  <th className="px-6 py-3">รหัสพนักงาน</th>
                                  <th className="px-6 py-3">สถานะ</th>
                                  <th className="px-6 py-3 text-center">จัดการสิทธิ์</th>
                              </tr>
                          </thead>
                          <tbody className="divide-y">
                              {(() => {
                                  // 1. กรองข้อมูลตามคำค้นหา
                                  let filtered = allUsers;
                                  if (userSearch) {
                                      const lower = userSearch.toLowerCase();
                                      filtered = filtered.filter(u => 
                                          u.username.toLowerCase().includes(lower) ||
                                          u.firstName.toLowerCase().includes(lower) ||
                                          u.lastName.toLowerCase().includes(lower) ||
                                          u.empId.toLowerCase().includes(lower)
                                      );
                                  }

                                  // 2. ⭐ แยกผู้ใช้ปัจจุบัน (Current User) ไว้บนสุด
                                  const myUser = filtered.find(u => u.id === user.id);
                                  const others = filtered.filter(u => u.id !== user.id);
                                  
                                  // รวมกลับโดยให้เราอยู่คนแรก
                                  const displayList = myUser ? [myUser, ...others] : others;

                                  if (displayList.length === 0) {
                                      return <tr><td colSpan="5" className="p-8 text-center text-gray-400">ไม่พบผู้ใช้งานที่ค้นหา</td></tr>;
                                  }

                                  return displayList.map((u) => {
                                      const isMe = u.id === user.id; // เช็คว่าเป็นตัวเราหรือไม่
                                      return (
                                          <tr 
                                              key={u.id} 
                                              className={`border-b cursor-pointer transition-colors ${isMe ? 'bg-blue-50/60 hover:bg-blue-100' : 'hover:bg-blue-50'}`}
                                              onClick={() => {
                                                  setViewingUser(u);
                                                  setUserDetailTab('info');
                                                  setDetailSearch('');
                                              }}
                                          >
                                              <td className="px-6 py-4 font-bold text-gray-800 flex items-center gap-2">
                                                  {u.username}
                                                  {/* ⭐ ติดป้าย Me ถ้าเป็นเรา */}
                                                  {isMe && <span className="text-[10px] bg-blue-600 text-white px-2 py-0.5 rounded-full shadow-sm">Me</span>}
                                              </td>
                                              <td className="px-6 py-4">{u.firstName} {u.lastName}</td>
                                              <td className="px-6 py-4 font-mono text-gray-500">{u.empId}</td>
                                              <td className="px-6 py-4">
                                                  {/* ปุ่มสถานะ: แก้ได้เฉพาะ Admin */}
                                                  {(user.isSuperAdmin || hasPermission(2) || hasPermission(3)) ? (
                                                      <button 
                                                          onClick={(e) => {
                                                              e.stopPropagation();
                                                              const newStatus = u.status === 'Activated' ? 'Deactivated' : 'Activated';
                                                              const updatedUser = { ...u, status: newStatus };
                                                              setAllUsers(prev => prev.map(x => x.id === u.id ? updatedUser : x));
                                                              google.script.run.saveUserData(updatedUser);
                                                          }}
                                                          className={`px-3 py-1 rounded-full text-xs font-bold border transition-colors ${u.status === 'Activated' ? 'bg-green-100 text-green-700 border-green-200 hover:bg-green-200' : u.status === 'New' ? 'bg-blue-100 text-blue-700 border-blue-200 hover:bg-blue-200' : 'bg-red-100 text-red-700 border-red-200 hover:bg-red-200'}`}
                                                      >
                                                          {u.status}
                                                      </button>
                                                  ) : (
                                                      <span className={`px-3 py-1 rounded-full text-xs font-bold border ${u.status === 'Activated' ? 'bg-green-50 text-green-600 border-green-100' : u.status === 'New' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-red-50 text-red-600 border-red-100'}`}>
                                                          {u.status}
                                                      </span>
                                                  )}
                                              </td>
                                              <td className="px-6 py-4 text-center">
                                                  <button 
                                                      onClick={(e) => {
    e.stopPropagation();
    setSelectedUserForEdit(u);
    // ⭐ แก้ไข: บังคับเลือกโครงการแรกสุดเสมอ
    if (projects && projects.length > 0) {
        setPermissionTab(projects[0].name); 
    } else {
        setPermissionTab('');
    }
    setShowPermissionModal(true);
}}
                                                      className="bg-blue-50 text-blue-600 p-2 rounded-lg hover:bg-blue-100 transition-colors border border-blue-200"
                                                      title="ดู/จัดการสิทธิ์"
                                                  >
                                                      <Settings className="w-4 h-4"/>
                                                  </button>
                                              </td>
                                          </tr>
                                      );
                                  });
                              })()}
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      )}

{/* --- PROJECT DETAIL MODAL (UPDATED: Clickable Cards & Fixed Close Button) --- */}
      {showProjectDetailModal && viewingProject && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-in fade-in">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl h-[85vh] flex flex-col overflow-hidden animate-in zoom-in-95">
                  
                  {/* Header & Fixed Close Button */}
                  <div className="px-6 py-4 border-b bg-white flex justify-between items-start sticky top-0 z-10">
                      <div>
                          <h3 className="font-bold text-xl text-gray-800">{viewingProject.name}</h3>
                          <span className="text-sm font-mono text-gray-500 bg-gray-100 px-2 py-0.5 rounded border mt-1 inline-block">{viewingProject.id}</span>
                      </div>
                      <button 
                          onClick={() => setShowProjectDetailModal(false)} 
                          className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
                          title="ปิดหน้าต่าง"
                      >
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                              <line x1="18" y1="6" x2="6" y2="18"></line>
                              <line x1="6" y1="6" x2="18" y2="18"></line>
                          </svg>
                      </button>
                  </div>

                  <div className="flex-1 overflow-y-auto p-6 bg-slate-50 space-y-6">
                      
                      {/* Clickable Stats Cards */}
                      <div className="grid grid-cols-2 gap-4">
                          <div 
                              onClick={() => setProjectDetailTab('SubJob')}
                              className={`p-4 rounded-xl border shadow-sm cursor-pointer transition-all flex flex-col items-center justify-center gap-2 group ${projectDetailTab === 'SubJob' ? 'bg-indigo-50 border-indigo-200 ring-2 ring-indigo-100' : 'bg-white border-gray-200 hover:border-indigo-200'}`}
                          >
                              <div className={`p-3 rounded-full ${projectDetailTab === 'SubJob' ? 'bg-indigo-200 text-indigo-700' : 'bg-gray-100 text-gray-400 group-hover:bg-indigo-50 group-hover:text-indigo-600'}`}>
                                  <List className="w-6 h-6"/>
                              </div>
                              <div className="text-center">
                                  <p className={`text-2xl font-bold ${projectDetailTab === 'SubJob' ? 'text-indigo-700' : 'text-gray-800'}`}>
                                      {viewingProject.subJobs?.length || 0}
                                  </p>
                                  <p className="text-xs font-bold text-gray-500">รายการ SubJobs</p>
                              </div>
                          </div>

                          <div 
                              onClick={() => setProjectDetailTab('matCode')}
                              className={`p-4 rounded-xl border shadow-sm cursor-pointer transition-all flex flex-col items-center justify-center gap-2 group ${projectDetailTab === 'matCode' ? 'bg-purple-50 border-purple-200 ring-2 ring-purple-100' : 'bg-white border-gray-200 hover:border-purple-200'}`}
                          >
                              <div className={`p-3 rounded-full ${projectDetailTab === 'matCode' ? 'bg-purple-200 text-purple-700' : 'bg-gray-100 text-gray-400 group-hover:bg-purple-50 group-hover:text-purple-600'}`}>
                                  <Tag className="w-6 h-6"/>
                              </div>
                              <div className="text-center">
                                  <p className={`text-2xl font-bold ${projectDetailTab === 'matCode' ? 'text-purple-700' : 'text-gray-800'}`}>
                                      {viewingProject.matCodes?.length || 0}
                                  </p>
                                  <p className="text-xs font-bold text-gray-500">รายการ Mat. Codes</p>
                              </div>
                          </div>
                      </div>

                 {/* Full List Table */}
                      <div className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm animate-in fade-in">
                          {/* ... (Header div คงเดิม) ... */}
                          
                          <div className="max-h-[300px] overflow-y-auto">
                              <table className="w-full text-sm text-left">
                                  <thead className="bg-gray-50 text-gray-600 sticky top-0 shadow-sm">
                                      <tr>
                                          {/* ⭐ ย้าย Group มาช่องแรก */}
                                          <th className="px-4 py-2 w-32">Group</th>
                                          <th className="px-4 py-2 w-24">Code</th>
                                          <th className="px-4 py-2">รายละเอียด (Description)</th>
                                          <th className="px-4 py-2 text-right">งบประมาณ (Budget)</th> 
                                      </tr>
                                  </thead>
                                  <tbody className="divide-y">
                                      {(projectDetailTab === 'SubJob' ? (viewingProject.subJobs || []) : (viewingProject.matCodes || [])).map((item, i) => (
                                          <tr key={i} className="hover:bg-gray-50">
                                              {/* ⭐ แสดง Group ช่องแรก */}
                                              <td className="px-4 py-2 text-gray-600 font-bold text-xs">{item.group || '-'}</td>
                                              <td className={`px-4 py-2 font-mono text-xs font-bold ${projectDetailTab === 'SubJob' ? 'text-indigo-600' : 'text-purple-600'}`}>{item.code}</td>
                                              <td className="px-4 py-2 text-gray-700">{item.description}</td>
                                              <td className="px-4 py-2 text-right font-mono text-gray-600">
                                                  {item.budget ? item.budget.toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}
                                              </td>
                                          </tr>
                                      ))}

                                      {(projectDetailTab === 'SubJob' ? (viewingProject.subJobs || []) : (viewingProject.matCodes || [])).length === 0 && (
                                          <tr><td colSpan="2" className="px-4 py-8 text-center text-gray-400">ไม่มีข้อมูล</td></tr>
                                      )}
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>


<div className="p-5 border-t bg-white flex gap-3">
    {/* ⭐ เช็คสิทธิ์ 26 ของโครงการที่กำลังดูอยู่ (viewingProject.name) */}
    {hasPermission(26, viewingProject.name) && (
        <button 
            onClick={() => handleDeleteProject(viewingProject.id)} 
            className="flex-1 py-2.5 border border-red-200 text-red-600 rounded-xl font-bold hover:bg-red-50 flex items-center justify-center gap-2 transition-colors"
        >
            <Trash2 className="w-4 h-4"/> ลบโครงการ
        </button>
    )}
    
    {/* ⭐ เช็คสิทธิ์ 26 ของโครงการที่กำลังดูอยู่ */}
    {hasPermission(26, viewingProject.name) && (
        <button 
            onClick={() => { 
                setEditingProject({...viewingProject, originalId: viewingProject.id, isNew: false});
                setProjectFormTab('General'); 
                setShowProjectModal(true); 
            }} 
            className="flex-1 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md flex items-center justify-center gap-2 transition-colors"
        >
            <Edit className="w-4 h-4"/> แก้ไขข้อมูล
        </button>
    )}
</div>
              </div>
          </div>
      )}

{/* --- PROJECT MODAL (UPDATED: Visible Delete Button) --- */}
      {showProjectModal && editingProject && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[110] p-4 backdrop-blur-sm animate-in fade-in">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col overflow-hidden">
                  
                  {/* Header */}
                  <div className="px-6 py-4 border-b bg-white flex justify-between items-center">
                      <h3 className="font-bold text-xl text-indigo-800">{editingProject.isNew ? 'เพิ่มโครงการใหม่' : 'แก้ไขโครงการ'}</h3>
                      <button onClick={() => setShowProjectModal(false)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-gray-500"/></button>
                  </div>

                  {/* Tabs */}
                  <div className="flex border-b bg-gray-50 px-6 pt-2">
                      {['General', 'SubJob', 'matCode'].map(tab => (
                          <button 
                            key={tab}
                            onClick={() => setProjectFormTab(tab)}
                            className={`px-6 py-3 text-sm font-bold border-b-2 transition-colors ${projectFormTab === tab ? 'border-indigo-600 text-indigo-700 bg-white rounded-t-lg' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                          >
                              {tab === 'General' ? 'ข้อมูลทั่วไป' : tab === 'SubJob' ? 'จัดการ SubJob' : 'จัดการ Mat. Code'}
                          </button>
                      ))}
                  </div>

                  {/* Content */}
                  <div className="flex-1 overflow-y-auto p-8 bg-slate-50">
                      {projectFormTab === 'General' && (
                          <div className="space-y-4 max-w-lg mx-auto bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                              <div>
                                  <label className="block text-sm font-bold text-gray-700 mb-1">รหัสโครงการ (Project ID)</label>
                                  <input 
                                      type="text" 
                                      className="w-full p-2.5 border rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 font-mono" 
                                      value={editingProject.id} 
                                      onChange={e => setEditingProject({...editingProject, id: e.target.value})}
                                      placeholder="เช่น PJ-001"
                                  />
                                  <p className="text-xs text-gray-400 mt-1">แนะนำให้ใช้ภาษาอังกฤษและตัวเลข ห้ามซ้ำกับโครงการอื่น</p>
                              </div>
                              <div>
                                  <label className="block text-sm font-bold text-gray-700 mb-1">ชื่อโครงการ (Project Name)</label>
                                  <input type="text" className="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500" value={editingProject.name} onChange={e => setEditingProject({...editingProject, name: e.target.value})} autoFocus />
                              </div>
                          </div>
                      )}

                      {(projectFormTab === 'SubJob' || projectFormTab === 'matCode') && (
                          <div className="space-y-4">
                              {/* CSV Note */}
                              {/* CSV Note */}
                              <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 flex gap-3 text-sm text-blue-800 items-start">
                                  <Info className="w-5 h-5 shrink-0 mt-0.5"/>
                                  <div>
                                      <p className="font-bold">การนำเข้าไฟล์ CSV</p>
                                      {/* ⭐ แก้ไขข้อความคำแนะนำ */}
                                      <ul className="list-disc pl-4 mt-1 text-xs">
                                          <li>ไฟล์ต้องมีหัวตาราง (Header) ในบรรทัดแรก เช่น <code>Group, Code, Description, Budget</code></li>
                                          <li>คอลัมน์ที่ 1: กลุ่ม (Group) | คอลัมน์ที่ 2: รหัส (Code) | คอลัมน์ที่ 3: รายละเอียด | <b>คอลัมน์ที่ 4: งบประมาณ (ถ้ามี)</b></li>
                                          <li>รองรับภาษาไทย (UTF-8)</li>
                                      </ul>
                                  </div>
                              </div>

                              <div className="flex justify-between items-center mb-4">
    <div className="flex gap-2">
        <h4 className="font-bold text-gray-800">
            {projectFormTab === 'SubJob' ? 'SubJob' : 'Mat. Code'} List
        </h4>
        <span className="bg-gray-200 text-gray-600 px-2 py-0.5 rounded text-xs font-bold flex items-center">
            {/* ⭐ เช็ค matCodes แทน epCodes */}
            {editingProject[projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes']?.length || 0}
        </span>
    </div>
    
    <label className="cursor-pointer bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm transition-colors">
        <Upload className="w-4 h-4"/> Import CSV
        <input 
            type="file" 
            accept=".csv" 
            className="hidden" 
            // ⭐ ส่งค่า 'matCodes' ไปให้ฟังก์ชัน import
            onChange={(e) => handleImportProjectData(e, projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes')} 
        />
    </label>
</div>
                              {/* --- แก้ไขส่วนตารางทั้งหมด (ย้าย Group ไปช่องแรก) --- */}
                              <div className="bg-white border rounded-xl overflow-hidden shadow-sm">
                                  <table className="w-full text-sm text-left">
                                      <thead className="bg-gray-100 text-gray-600">
                                          <tr>
                                              <th className="px-4 py-2 w-10 text-center">#</th>
                                              {/* ⭐ ย้าย Group มาช่องแรก */}
                                              <th className="px-4 py-2 w-32">Group</th>
                                              <th className="px-4 py-2 w-40">Code</th>
                                              <th className="px-4 py-2">รายละเอียด (Description)</th>
                                              <th className="px-4 py-2 w-32 text-right">งบประมาณ</th>
                                              <th className="px-4 py-2 w-20 text-center">Action</th>
                                          </tr>
                                      </thead>
                                      <tbody className="divide-y">
                                          {(editingProject[projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes'] || []).map((item, idx) => (
                                              <tr key={idx} className="hover:bg-gray-50 group">
                                                  {/* 1. ลำดับ */}
                                                  <td className="px-4 py-2 text-center text-gray-400 text-xs">{idx+1}</td>
                                                  
                                                  {/* ⭐ 2. Group (ย้ายมาที่นี่) */}
                                                  <td className="px-4 py-2">
                                                      <input 
                                                          type="text" 
                                                          className="w-full bg-transparent outline-none border-b border-transparent focus:border-gray-300 text-sm font-bold text-gray-700" 
                                                          value={item.group || ''} 
                                                          onChange={(e) => {
                                                              const list = [...(editingProject[projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes'])];
                                                              list[idx].group = e.target.value;
                                                              setEditingProject({...editingProject, [projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes']: list});
                                                          }}
                                                          placeholder="Group"
                                                      />
                                                  </td>

                                                  {/* 3. Code */}
                                                  <td className="px-4 py-2">
                                                      <input 
                                                          type="text" 
                                                          className="w-full bg-transparent outline-none focus:text-indigo-800 border-b border-transparent focus:border-indigo-300 font-mono font-bold text-indigo-600" 
                                                          value={item.code} 
                                                          onChange={(e) => {
                                                              const list = [...(editingProject[projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes'])];
                                                              list[idx].code = e.target.value;
                                                              setEditingProject({...editingProject, [projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes']: list});
                                                          }}
                                                          placeholder="Code"
                                                      />
                                                  </td>

                                                  {/* 4. Description */}
                                                  <td className="px-4 py-2">
                                                      <input 
                                                          type="text" 
                                                          className="w-full bg-transparent outline-none border-b border-transparent focus:border-gray-300" 
                                                          value={item.description} 
                                                          onChange={(e) => {
                                                              const list = [...(editingProject[projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes'])];
                                                              list[idx].description = e.target.value;
                                                              setEditingProject({...editingProject, [projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes']: list});
                                                          }}
                                                          placeholder="Description"
                                                      />
                                                  </td>

                                                  {/* 5. Budget */}
                                                  <td className="px-4 py-2">
                                                      <input 
                                                          type="number" 
                                                          min="0"
                                                          className="w-full bg-transparent outline-none border-b border-transparent focus:border-gray-300 text-right font-mono" 
                                                          value={item.budget || ''} 
                                                          onChange={(e) => {
                                                              const list = [...(editingProject[projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes'])];
                                                              list[idx].budget = parseFloat(e.target.value) || 0;
                                                              setEditingProject({...editingProject, [projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes']: list});
                                                          }}
                                                          placeholder="0.00"
                                                      />
                                                  </td>

            {/* 6. Action Delete */}
            <td className="px-4 py-2 text-center">
               {/* ... (ปุ่มลบเหมือนเดิม) ... */}
                <button 
                    type="button"
                    onClick={() => {
                        const currentList = editingProject[projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes'];
                        const newList = currentList.filter((_, i) => i !== idx);
                        setEditingProject({
                            ...editingProject, 
                            [projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes']: newList
                        });
                    }}
                    className="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors flex items-center justify-center mx-auto"
                    title="ลบรายการนี้"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M3 6h18"/>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                        <line x1="10" x2="10" y1="11" y2="17"/>
                        <line x1="14" x2="14" y1="11" y2="17"/>
                    </svg>
                </button>
            </td>
        </tr>
    ))}
</tbody>

    </table>
    
    <button 
        type="button"
        onClick={() => {
            const key = projectFormTab === 'SubJob' ? 'subJobs' : 'matCodes';
            // ⭐ แก้ไข: เพิ่ม group: '' เข้าไปใน object ใหม่
            setEditingProject({...editingProject, [key]: [...(editingProject[key] || []), { code: '', description: '', group: '', budget: 0 }]});
        }}
        className="w-full py-3 text-sm text-gray-500 hover:bg-gray-50 border-t flex items-center justify-center gap-2 font-bold transition-colors"
    >
        <Plus className="w-4 h-4"/> เพิ่มแถวใหม่
    </button>
</div>
                          </div>
                      )}
                  </div>

                  {/* Footer */}
                  <div className="p-5 border-t bg-white flex justify-end gap-3">
                      <button onClick={() => setShowProjectModal(false)} className="px-6 py-2.5 border border-gray-300 rounded-xl text-gray-600 hover:bg-gray-50 font-bold">ยกเลิก</button>
                      <button onClick={handleSaveProject} className="px-6 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 shadow-md font-bold flex items-center gap-2">
                          <Save className="w-4 h-4"/> บันทึกข้อมูล
                      </button>
                  </div>
              </div>
          </div>
      )}


 
            </div>

{/* ปุ่ม Go to Bottom (Minimal - อยู่ด้านบนของปุ่ม Top) */}
            {showGoBottom && (
                <button
                    onClick={scrollToBottom}
                    className="fixed bottom-20 right-6 z-[100] bg-white text-gray-600 border border-gray-200 hover:bg-gray-100 hover:text-black p-3 rounded-full shadow-lg transition-all transform hover:scale-110 flex items-center justify-center no-print"
                    title="เลื่อนลงด้านล่าง"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                        <path d="m6 9 6 6 6-6"/>
                    </svg>
                </button>
            )}

            {/* ปุ่ม Go to Top (Minimal - อยู่ล่างสุด) */}
            {showGoTop && (
                <button
                    onClick={scrollToTop}
                    className="fixed bottom-6 right-6 z-[100] bg-blue-600 text-white hover:bg-blue-700 p-3 rounded-full shadow-lg transition-all transform hover:scale-110 flex items-center justify-center no-print"
                    title="กลับไปด้านบน"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                        <path d="m18 15-6-6-6 6"/>
                    </svg>
                </button>
            )}

          </main>
    
       {/* เปลี่ยน z-[80] เป็น z-[250] เพื่อให้ซ้อนทับหน้า Verification ได้ */}
{showCreateModal && (
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[250] p-4 backdrop-blur-sm animate-in fade-in">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden max-h-[90vh] flex flex-col">
            
            {/* --- HEADER --- */}
            <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-start bg-white sticky top-0 z-10">
                 <div>
                     <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2">
                        {editingId ? <Edit className="w-6 h-6 text-blue-600"/> : <Plus className="w-6 h-6 text-blue-600"/>} 
                        {editingId ? `แก้ไขแบบร่าง` : 'สร้างคำขอใหม่'}
                     </h3>
                     <p className="text-sm text-gray-500 mt-1">กรอกรายละเอียดเพื่อดำเนินการต่อ</p>
                 </div>
                 
                 <button 
                    type="button"
                    onClick={handleCloseCreateModal} 
                    className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
                 >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M18 6 6 18"/>
                        <path d="m6 6 12 12"/>
                    </svg>
                 </button>
            </div>

            <div className="flex-1 overflow-y-auto p-8 bg-slate-50">
            <form className="space-y-6">
              {/* Type Selection */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-2">
                
                 {hasPermission(4) && (
                 <button type="button" onClick={() => setNewOrderMeta({
                     ...newOrderMeta, 
                     type: 'Local',
                     dateRequired: getFutureDate(7), // ⭐ Local: อีก 15 วัน
                     priority: 'Urgent' // 8-30 วัน = Urgent
                 })} className={`p-3 rounded-xl border-2 text-center transition-all ${newOrderMeta.type === 'Local' ? 'bg-orange-50 border-orange-500 text-orange-800 shadow-sm' : 'border-gray-200 bg-white hover:border-orange-200'}`}><HardHat className="w-5 h-5 mx-auto mb-1"/> ซื้อ (Local)</button>
                  )}

                 {hasPermission(5) && (
                 <button type="button" onClick={() => setNewOrderMeta({
                     ...newOrderMeta, 
                     type: 'HO',
                     dateRequired: getFutureDate(15), // ⭐ HO: อีก 15 วัน
                     priority: 'Urgent'
                 })} className={`p-3 rounded-xl border-2 text-center transition-all ${newOrderMeta.type === 'HO' ? 'bg-purple-50 border-purple-500 text-purple-800 shadow-sm' : 'border-gray-200 bg-white hover:border-purple-200'}`}><Building className="w-5 h-5 mx-auto mb-1"/> ซื้อ (HO)</button>
                 )}

                 {hasPermission(6) && (
                <button type="button" onClick={() => setNewOrderMeta({
                    ...newOrderMeta, 
                    type: 'Withdraw',
                    dateRequired: getFutureDate(0), // ⭐ เบิก: วันนี้ (Today)
                    priority: 'Critical' // 0-7 วัน = Critical
                })} className={`p-3 rounded-xl border-2 text-center transition-all ${newOrderMeta.type === 'Withdraw' ? 'bg-pink-50 border-pink-500 text-pink-800 shadow-sm' : 'border-gray-200 bg-white hover:border-pink-200'}`}><Package className="w-5 h-5 mx-auto mb-1"/> เบิกวัสดุ</button>
                )}

                 {hasPermission(7) && (
                 <button type="button" onClick={() => setNewOrderMeta({
                     ...newOrderMeta, 
                     type: 'Borrow',
                     dateRequired: getFutureDate(0), // ⭐ ยืม: วันนี้ (Today)
                     priority: 'Critical' // 0-7 วัน = Critical
                 })} className={`p-3 rounded-xl border-2 text-center transition-all ${newOrderMeta.type === 'Borrow' ? 'bg-blue-50 border-blue-500 text-blue-800 shadow-sm' : 'border-gray-200 bg-white hover:border-blue-200'}`}><Monitor className="w-5 h-5 mx-auto mb-1"/> ยืมทรัพย์สิน</button>
                 )}
              </div>
              
              {/* HO Purchase Type */}
              {newOrderMeta.type === 'HO' && (
                  <div className="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100 mb-2 flex gap-4 animate-in fade-in">
                      <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="purchaseType" className="accent-indigo-600 w-4 h-4" checked={newOrderMeta.purchaseType === 'Buy'} onChange={() => setNewOrderMeta({...newOrderMeta, purchaseType: 'Buy'})} /><span className="text-sm font-bold text-indigo-900">ซื้อขาด (Buy)</span></label>
                      <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="purchaseType" className="accent-indigo-600 w-4 h-4" checked={newOrderMeta.purchaseType === 'Rent'} onChange={() => setNewOrderMeta({...newOrderMeta, purchaseType: 'Rent'})} /><span className="text-sm font-bold text-indigo-900">เช่า (Rent)</span></label>
                  </div>
              )}
              
              {/* Form Fields */}
              <div className="grid grid-cols-2 gap-4 bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                <div className="col-span-2">
                    <label className="block text-sm font-bold text-gray-700 mb-1.5">ชื่อโครงการ (Project Name)</label>
                                  <select 
    required 
    className="w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white"
    value={newOrderMeta.job} 
    onChange={e => {
        setNewOrderMeta({...newOrderMeta, job: e.target.value});
        setTempItem(prev => ({...prev, subJob: '', matCode: ''}));
    }}
>
    <option value="">-- กรุณาเลือกโครงการ --</option>
    
    {/* ⭐ กรองโครงการตามสิทธิ์ของประเภทคำขอที่เลือกอยู่ */}
{projects.filter(p => {
    // 1. กำหนดสิทธิ์ที่ต้องใช้ ตามประเภทคำขอ
    let requiredPerm = 4; // Default: ซื้อ Local (4)
    if (newOrderMeta.type === 'HO') requiredPerm = 5; // ซื้อ HO (5)
    else if (newOrderMeta.type === 'Withdraw') requiredPerm = 6; // เบิกวัสดุ (6)
    else if (newOrderMeta.type === 'Borrow') requiredPerm = 7; // ยืมทรัพย์สิน (7)

    // 2. เช็คว่ามีสิทธิ์นั้นในโครงการนี้หรือไม่
    return hasPermission(requiredPerm, p.name);
}).map(p => (
    <option key={p.id} value={p.name}>{p.name}</option>
))}
</select>
                
                </div>
                
                {newOrderMeta.type !== 'Borrow' && (
                    <div className="col-span-1">
                        <label className="block text-sm font-bold text-gray-700 mb-1.5">ความสำคัญ (Priority)</label>
                        <div className="flex gap-2">
                            {Object.entries(PRIORITIES).map(([key, conf]) => (
                                <button key={key} type="button" onClick={() => setNewOrderMeta({...newOrderMeta, priority: key})} className={`flex-1 py-2 rounded-lg text-xs font-bold border transition-all ${newOrderMeta.priority === key ? `${conf.color} border-current` : 'bg-gray-50 border-gray-200 text-gray-500 hover:bg-gray-100'}`}>
                                    {conf.label}
                                </button>
                            ))}
                        </div>
                    </div>
                )}
                
                <div className={newOrderMeta.type === 'Borrow' ? "col-span-2" : "col-span-1"}>
                    <label className="block text-sm font-bold text-gray-700 mb-1.5">วันที่ใช้ (Date Required)</label>
                    <input 
                        required 
                        type="date" 
                        className="w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" 
                        value={newOrderMeta.dateRequired} 
                        onChange={handleDateChange} // ⭐ ใช้ฟังก์ชัน Smart Priority ที่สร้างใหม่
                        min={new Date().toISOString().split('T')[0]} // ⭐ ห้ามเลือกย้อนหลัง
                    />
                </div>
              </div>

{/* Suggestion Alert (Multi-Project List) */}
{foundSuggestions.length > 0 && (
    <div className="bg-green-50 border border-green-200 rounded-xl p-3 mb-4 animate-in zoom-in-95 shadow-sm">
        <div className="flex items-center gap-2 mb-2 pb-2 border-b border-green-200">
            <div className="bg-green-100 p-1.5 rounded-full text-green-600"><CheckCircle className="w-4 h-4"/></div>
            <p className="text-sm font-bold text-green-800">พบรายการในระบบ ({foundSuggestions.length})</p>
        </div>
        
        <div className="max-h-40 overflow-y-auto space-y-2 pr-1">
            {foundSuggestions.map((item, idx) => (
                <div key={idx} className="flex justify-between items-center bg-white p-2 rounded-lg border border-green-100 shadow-sm">
                    <div className="flex-1 min-w-0 mr-2">
                        <div className="flex items-center gap-2">
                            <span className="font-bold text-sm text-gray-800 truncate">{item.name}</span>
                            <span className={`text-[10px] px-1.5 rounded border ${item.matchType === 'Withdraw' ? 'bg-pink-50 text-pink-700 border-pink-200' : 'bg-blue-50 text-blue-700 border-blue-200'}`}>
                                {item.matchType === 'Withdraw' ? 'วัสดุ' : 'ทรัพย์สิน'}
                            </span>
                        </div>
                        <div className="text-xs text-gray-500 flex items-center gap-1 mt-0.5">
                            <Building className="w-3 h-3"/> โครงการ: <span className="font-bold text-gray-700">{item.project || 'ส่วนกลาง'}</span>
                        </div>
                        <div className="text-xs text-gray-500 mt-0.5">
                            มีอยู่: <span className="font-bold text-green-600">{item.qty} {item.unit}</span> 
                            
                            {/* ⭐ เพิ่มส่วนแสดงรายละเอียดแยกประเภท (ถ้ามีข้อมูล) */}
                            {(item.sysQty !== undefined || item.nonQty !== undefined) && (
                                <span className="text-[10px] text-gray-400 ml-1">
                                    (ใน: <b>{item.sysQty || 0}</b>, นอก: <b>{item.nonQty || 0}</b>)
                                </span>
                            )}
                            
                            {' '}({item.sourceLabel})
                        </div>
                    </div>
                    
                    <button 
                        type="button" 
                        onClick={() => selectSuggestion(item)} 
                        className="bg-green-600 text-white text-xs px-3 py-1.5 rounded-lg font-bold hover:bg-green-700 shadow-sm whitespace-nowrap transition-colors"
                    >
                        เลือก ({item.matchType === 'Withdraw' ? 'เบิก' : 'ยืม'})
                    </button>
                </div>
            ))}
        </div>
    </div>
)}

              {/* Item Input Section */}
              <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm relative">
                  <h4 className="font-bold text-gray-700 mb-3 flex items-center gap-2 border-b pb-2"><ShoppingCart className="w-5 h-5 text-blue-600"/> รายการสินค้า/ทรัพย์สิน</h4>
                  
                  {/* General Input */}
                  <div className="space-y-3">
                      <div className="grid grid-cols-12 gap-3">
                          <div className="col-span-8">
                              <label className="text-xs font-bold text-gray-500 mb-1 block">ชื่อรายการ {newOrderMeta.type === 'Borrow' && '(เลือกจากทะเบียนทรัพย์สิน)'}</label>
                              <div className="relative">
                                {(() => {
            // เช็คว่าเป็นโหมดที่ "ห้ามพิมพ์" หรือไม่ (เบิก/ยืม)
            const isStrictSelection = ['Withdraw', 'Borrow'].includes(newOrderMeta.type);

            return (
                <input 
                    type="text" 
                    // 1. ถ้าเป็น เบิก/ยืม ให้ล็อก ReadOnly และกดแล้วเปิด Modal
                    readOnly={isStrictSelection}
                    onClick={() => {
                        if (isStrictSelection) setShowSelectionModal(true);
                    }}
                    
                    // 2. ปรับ Style: ถ้าล็อกให้เป็นสีเทาและมี cursor pointer, ถ้าซื้อให้เป็นสีขาวปกติ
                    className={`w-full p-2.5 pl-3 pr-10 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none ${
                        isStrictSelection 
                        ? 'bg-gray-50 cursor-pointer font-bold text-gray-700' // เบิก/ยืม (ห้ามพิมพ์)
                        : 'bg-white' // สั่งซื้อ (พิมพ์ได้ปกติ)
                    }`}
                    
                    // 3. Placeholder ต่างกัน
                    placeholder={isStrictSelection ? "คลิกเพื่อเลือกรายการ..." : "ระบุชื่อสินค้า..."}
                    
                    value={tempItem.name} 
                    
                    // 4. OnChange: ยอมให้พิมพ์เฉพาะตอน "สั่งซื้อ" เท่านั้น
                    onChange={e => {
                        if (!isStrictSelection) {
                            setTempItem({...tempItem, name: e.target.value});
                        }
                    }} 
                />
            );
        })()}
                                <button 
                                    type="button"
                                    onClick={() => setShowSelectionModal(true)} 
                                    className="absolute right-1.5 top-1.5 p-1.5 bg-gray-100 text-gray-600 hover:bg-blue-100 hover:text-blue-600 rounded-md transition-colors"
                                    title="เลือกจากรายการ"
                                >
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/>
                                    </svg>
                                </button>
                              </div>
                          </div>

                          <div className="col-span-2">
                              <label className="text-xs font-bold text-gray-500 mb-1 block">จำนวน</label>
                              <input type="number" min="1" className="w-full p-2.5 border border-gray-300 rounded-lg text-sm text-center" value={tempItem.qty} onChange={e => setTempItem({...tempItem, qty: parseInt(e.target.value) || 0})} disabled={newOrderMeta.type === 'Borrow'} />
                          </div>
                         <div className="col-span-2">
    <label className="text-xs font-bold text-gray-500 mb-1 block">หน่วยนับ</label>
    <select 
        className="w-full p-2.5 border border-gray-300 rounded-lg text-sm bg-white" 
        value={tempItem.unit} 
        onChange={e => setTempItem({...tempItem, unit: e.target.value})} 
        disabled={newOrderMeta.type === 'Borrow'}
    >
        {ITEM_UNITS.map(u => <option key={u} value={u}>{u}</option>)}
    </select>
</div>


                      </div>

            {newOrderMeta.type !== 'Borrow' && (
                        <div className="grid grid-cols-12 gap-3">
                            {/* Logic หาข้อมูลโครงการที่เลือก */}
                            {(() => {
                                const selectedProjectData = projects.find(p => p.name === newOrderMeta.job);
                                return (
                                    <>
                                        {/* ⭐ ใช้ SearchableDropdown แทน Select เดิม */}
                                        <div className="col-span-4">
                                            <SearchableDropdown
                                                label="SubJob"
                                                placeholder="พิมพ์รหัสหรือเลือก..."
                                                options={selectedProjectData?.subJobs || []}
                                                value={tempItem.subJob}
                                                onChange={(val) => setTempItem({...tempItem, subJob: val})}
                                                disabled={!newOrderMeta.job || (newOrderMeta.type === 'Withdraw' && !!tempItem.matCode)}
                                            />
                                        </div>

                                        <div className="col-span-4">
                                            <SearchableDropdown
                                                label="Mat. Code"
                                                placeholder="พิมพ์รหัสหรือเลือก..."
                                                options={selectedProjectData?.matCodes || []}
                                                value={tempItem.matCode}
                                                onChange={(val) => setTempItem({...tempItem, matCode: val})}
                                                disabled={!newOrderMeta.job || (newOrderMeta.type === 'Withdraw' && !!tempItem.subJob)}
                                            />
                                        </div>
                                    </>
                                );
                            })()}
                            
<div className="col-span-4">
    <label className="text-xs font-bold text-gray-500 mb-1 block">
        {newOrderMeta.type === 'HO' && newOrderMeta.purchaseType === 'Rent' 
            ? 'ราคาเช่า (บาท)' 
            : 'ราคาต่อหน่วย (บาท)'}
    </label>
    
    <div className="flex gap-2">
        {/* ช่องกรอกตัวเลขราคา */}
        <input 
            type="number" min="0" 
            disabled={newOrderMeta.type === 'Withdraw'} 
            className="w-full p-2.5 border border-gray-300 rounded-lg text-sm" 
            value={tempItem.unitPrice} 
            onChange={e => setTempItem({...tempItem, unitPrice: parseFloat(e.target.value) || 0})} 
        />
        
        {/* Dropdown หน่วยเวลา (แสดงเฉพาะ HO Rent) */}
        {newOrderMeta.type === 'HO' && newOrderMeta.purchaseType === 'Rent' && (
            <select 
                className="w-24 p-2.5 border border-gray-300 rounded-lg text-sm bg-white text-gray-700 font-medium"
                value={tempItem.rentalUnit || 'Month'}
                onChange={e => setTempItem({...tempItem, rentalUnit: e.target.value})}
            >
                <option value="Day">/ วัน</option>
                <option value="Month">/ เดือน</option>
                <option value="Year">/ ปี</option>
            </select>
        )}
    </div>
</div>

                      {/* --- เพิ่มช่องกรอกระยะเวลาเช่า (เฉพาะ HO Rent) --- */}
{newOrderMeta.type === 'HO' && newOrderMeta.purchaseType === 'Rent' && (
    <div className="col-span-2">
        <label className="text-xs font-bold text-gray-500 mb-1 block">ระยะเวลาเช่า</label>
        <input 
            type="number" min="1" 
            className="w-full p-2.5 border border-gray-300 rounded-lg text-sm text-center font-bold text-indigo-700 bg-indigo-50"
            value={tempItem.duration || 1} 
            onChange={e => setTempItem({...tempItem, duration: parseFloat(e.target.value) || 1})} 
        />
    </div>
)}
                        </div>
                      )}
                      

                      {newOrderMeta.type !== 'Borrow' && (
                        <div>
                            <label className="text-xs font-bold text-gray-500 mb-1 block">หมายเหตุ</label>
                            <input type="text" className="w-full p-2.5 border border-gray-300 rounded-lg text-sm" placeholder="รายละเอียดเพิ่มเติม..." value={tempItem.note} onChange={e => setTempItem({...tempItem, note: e.target.value})} />
                        </div>
                      )}

                      {/* Image Upload: แสดงเฉพาะ Local และ HO (Updated: Multi-Image UI) */}
                      {(newOrderMeta.type === 'Local' || newOrderMeta.type === 'HO') && (
                          <div className="animate-in fade-in mb-4">
                              <label className="text-xs font-bold text-gray-500 mb-1 flex items-center gap-1">
                                  <ImageIcon className="w-3 h-3"/> รูปตัวอย่างสินค้า (เลือกได้หลายรูป)
                              </label>
                              
                              <div className="flex flex-col gap-2">
                                  {/* ปุ่มเลือกรูป */}
                                  <label className="cursor-pointer bg-blue-50 text-blue-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-100 border border-blue-200 flex items-center gap-2 transition-colors w-fit">
                                      <Camera className="w-4 h-4"/> เพิ่มรูปภาพ
                                      <input type="file" multiple className="hidden" onChange={handleTempItemImageSelect}/>
                                  </label>

                                  {/* ตารางแสดงรูป (Preview Grid) */}
                                  {tempItem.images && tempItem.images.length > 0 && (
                                      <div className="grid grid-cols-4 md:grid-cols-6 gap-2 mt-2">
                                          {tempItem.images.map((img, idx) => (
                                              <div key={idx} className="relative group w-full h-20 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                                                  <img src={img.base64 || img.url} alt="preview" className="w-full h-full object-cover" />
                                                  <button 
                                                      type="button"
                                                      onClick={() => handleRemoveTempItemImage(idx)} 
                                                      className="absolute top-0 right-0 bg-red-500 text-white p-0.5 rounded-bl opacity-0 group-hover:opacity-100 transition-all hover:scale-110" 
                                                      title="ลบรูป"
                                                  >
                                                      <X size={12} strokeWidth={3}/>
                                                  </button>
                                              </div>
                                          ))}
                                      </div>
                                  )}
                              </div>
                          </div>
                      )}
                  </div>

                  <button type="button" onClick={handleAddItem} className="w-full bg-gray-900 text-white p-3 rounded-xl text-sm font-bold hover:bg-black mt-4 shadow-md flex items-center justify-center gap-2"><Plus className="w-4 h-4"/> เพิ่มรายการ</button>

                  {/* Items Table */}
                  <div className="bg-gray-50 border border-gray-200 rounded-xl overflow-hidden mt-6">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-100 text-gray-600 text-left text-xs uppercase tracking-wider">
                            <tr>
                                <th className="p-3 font-bold">รายการ</th>
                                {newOrderMeta.type === 'Borrow' ? (
                                    <>
                                        <th className="p-3 font-bold">Asset ID</th>
                                        <th className="p-3 font-bold">Serial No.</th>
                                        <th className="p-3 font-bold text-center">รูป</th>
                                    </>
                                ) : (
                                    <><th className="p-3 font-bold">SubJob/Mat</th><th className="p-3 font-bold">หมายเหตุ</th></>
                                )}
                                {/* ⭐ เพิ่มหัวตารางราคา */}
                                <th className="p-3 text-right font-bold">ราคา</th>
                                <th className="p-3 text-center font-bold">Qty</th>
                                <th className="p-3 text-right font-bold">Unit</th>
                                <th className="p-3"></th>
                            </tr>
                        </thead>
 <tbody className="divide-y divide-gray-200 bg-white">
                            {orderItems.map((itm, idx) => (
                            <tr key={idx}>
                                <td className="p-3 text-gray-800 font-bold">{itm.name}</td>
                                
                                {newOrderMeta.type === 'Borrow' ? (
                                    <>
                                        <td className="p-3 text-xs text-gray-500 font-mono">{itm.assetId || '-'}</td>
                                        <td className="p-3 text-xs text-gray-500 font-mono">{itm.serial || '-'}</td>
                                        <td className="p-3 text-center">
                                             {itm.images && itm.images.length > 0 ? (
                                                 <button type="button" onClick={() => setViewingAttachments({ attachments: itm.images })} className="text-blue-600 hover:text-blue-800"><ImageIcon className="w-4 h-4 mx-auto"/></button>
                                             ) : '-'}
                                        </td>
                                   </>
                                ) : (
                                    <>
                                        <td className="p-3 text-xs text-gray-500">
                                            {itm.subJob && <div>S: {itm.subJob}</div>}
                                            {itm.matCode && <div>M: {itm.matCode}</div>}
                                            {!itm.subJob && !itm.matCode && '-'}
                                        </td>
                                        <td className="p-3 text-xs text-gray-500 break-words whitespace-pre-wrap max-w-[200px]">{itm.note || '-'}</td>
                                   </>
                                )}

                                {/* ⭐ เพิ่มช่องแสดงราคา */}
                                <td className="p-3 text-right text-gray-700">
                                    {itm.unitPrice > 0 ? (
                                        <div className="flex flex-col items-end">
                                            {/* แสดงตัวเลขราคา */}
                                            <span className="font-mono font-bold">{itm.unitPrice.toLocaleString()} บาท</span>
                                            
                                            <span className="text-[10px] text-gray-500">
    {newOrderMeta.type === 'HO' && newOrderMeta.purchaseType === 'Rent'
        ? `/${itm.rentalUnit === 'Day' ? 'วัน' : itm.rentalUnit === 'Year' ? 'ปี' : 'เดือน'}/${itm.unit}`
        : `/${itm.unit}`
    }
</span>
                                        </div>
                                    ) : '-'}
                                </td>

                                <td className="p-3 text-center font-bold">{itm.qty}</td>
                                <td className="p-3 text-right text-xs text-gray-500">{itm.unit}</td>
                                <td className="p-3 text-center flex items-center justify-center gap-1">
                                    {/* ... (ปุ่มแก้ไข/ลบ เหมือนเดิม) ... */}
                                    <button type="button" onClick={() => handleEditItem(idx)} className="text-blue-600 hover:bg-blue-50 p-1.5 rounded-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                                    <button type="button" onClick={() => handleRemoveItem(idx)} className="text-red-500 hover:text-red-700 hover:bg-red-50 p-1.5 rounded-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>
                                </td>
                            </tr>
                        ))}</tbody>
                    </table>
                    {orderItems.length === 0 && <div className="p-8 text-center text-gray-400 text-xs bg-white">ยังไม่มีรายการ</div>}
                  </div>
              </div>
              
              {/* Attachment for HO */}
              {newOrderMeta.type === 'HO' && (
                  <div className="bg-amber-50 p-4 rounded-xl border border-amber-200 mt-2 space-y-3">
                    <div>
                        <label className="block text-sm font-bold text-amber-800 mb-1 flex items-center gap-2"><AttachmentIcon className="w-4 h-4" /> 1. ไฟล์อีเมลอนุมัติ (Approval Email)</label>
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => setUploadFiles({...uploadFiles, email: e.target.files[0]})} className="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-amber-100 file:text-amber-800 hover:file:bg-amber-200 cursor-pointer"/>
                         {editingId && newOrderMeta.attachment && <p className="text-xs text-green-600 mt-1 pl-2">✔ มีไฟล์เดิม: {newOrderMeta.attachment.name}</p>}
                    </div>
                    <div>
                        <label className="block text-sm font-bold text-amber-800 mb-1 flex items-center gap-2"><FileText className="w-4 h-4" /> 2. ใบเสนอราคา (Quotation)</label>
                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => setUploadFiles({...uploadFiles, quotation: e.target.files[0]})} className="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-amber-100 file:text-amber-800 hover:file:bg-amber-200 cursor-pointer"/>
                        {editingId && newOrderMeta.quotation && <p className="text-xs text-green-600 mt-1 pl-2">✔ มีไฟล์เดิม: {newOrderMeta.quotation.name}</p>}
                    </div>
                  </div>
              )}

             {/* Bottom Actions */}
              <div className="flex gap-3 pt-4 border-t border-gray-100">
                  <button type="button" onClick={(e) => handleCreateOrder(e, true)} className="flex-1 bg-white border border-gray-300 text-gray-700 font-bold py-3.5 rounded-xl shadow-sm hover:bg-gray-50 flex items-center justify-center gap-2 transition-colors">
                      <Save className="w-5 h-5"/> บันทึกร่าง
                  </button>
                  
                  {/* ⭐ เปลี่ยนข้อความปุ่มตามบริบท (ส่งคำขอ vs บันทึกแก้ไข) */}
                  <button type="button" onClick={(e) => handleCreateOrder(e, false)} className="flex-1 bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-blue-700 flex items-center justify-center gap-2 transition-transform active:scale-95">
                      <Send className="w-5 h-5"/> {editingId ? 'บันทึกแก้ไข' : 'ส่งคำขอ'}
                  </button>
              </div>
            </form>
          </div>
          </div>
        </div>
      )}


      {showSelectionModal && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[300] p-4 animate-in fade-in"> {/* แก้ตรงนี้ */}
      <div className="bg-white rounded-2xl shadow-xl w-full max-w-2xl h-[80vh] flex flex-col overflow-hidden">
             
             {/* --- HEADER: ปุ่มปิด X แบบ Clean Style (SVG) --- */}
             <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-white">
                 <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">
                    <List className="w-5 h-5 text-blue-600"/> เลือกรายการ (Select Item)
                 </h3>
                 {/* ⭐ ปุ่มปิดกากบาท (X) แบบไม่มีพื้นหลัง */}
                 <button 
                    onClick={() => setShowSelectionModal(false)} 
                    className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
                 >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M18 6 6 18"/>
                        <path d="m6 6 12 12"/>
                    </svg>
                 </button>
             </div>

             <div className="p-4 border-b bg-white">
                 <div className="relative">
                     <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                     <input type="text" className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ค้นหาชื่อ, รหัส..." value={selectionSearch} onChange={e => setSelectionSearch(e.target.value)} autoFocus />
                 </div>
                 {newOrderMeta.type === 'Borrow' && (
                     <div className="mt-2 text-xs text-orange-600 bg-orange-50 p-2 rounded flex items-center gap-1 font-bold">
                         <Info className="w-3 h-3"/> แสดงเฉพาะทรัพย์สินที่ว่าง (Available)
                     </div>
                 )}
                 {newOrderMeta.type === 'HO' && (
                     <div className="mt-2 text-xs text-purple-600 bg-purple-50 p-2 rounded flex items-center gap-1 font-bold">
                         <Info className="w-3 h-3"/> แสดงรายการทั้งจากคลังสินค้าและทะเบียนทรัพย์สิน
                     </div>
                 )}
             </div>

             <div className="flex-1 overflow-y-auto p-4 bg-gray-50">
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                     {getSelectionItems().map((item, idx) => (
                         <div key={idx} onClick={() => handleSelectFromModal(item)} className="bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:border-blue-400 hover:shadow-md cursor-pointer transition-all flex gap-3 items-center group">
                             {/* ⭐ ส่วนแสดงรูปภาพ (Updated) */}
 <div 
    className="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0 border overflow-hidden relative cursor-pointer hover:ring-2 hover:ring-blue-400 transition-all"
    onClick={(e) => {
        // ⭐ แก้ไข: ดึงรูปทั้งหมดมาแสดง
        const images = getItemLatestImages(item);
        if (images.length > 0) {
            e.stopPropagation();
            setViewingAttachments({ attachments: images });
        }
    }}
    title="คลิกเพื่อดูรูปภาพขยายทั้งหมด"
>
    {(() => {
        // Preview ยังคงใช้รูปแรกเหมือนเดิม
        const img = getItemLatestImage(item);
        if (img) {
            return (
                <>
                    <img 
                        src={getDriveImageUrl(img.url || img.base64)} 
                        alt="preview" 
                        className="w-full h-full object-cover hover:scale-110 transition-transform duration-300" 
                        onError={(e) => e.target.style.display = 'none'}
                    />
                    {/* แสดงจำนวนรูปถ้ามีมากกว่า 1 */}
                    {getItemLatestImages(item).length > 1 && (
                        <div className="absolute top-0 left-0 bg-black/60 text-white px-1 text-[9px] rounded-br">
                            +{getItemLatestImages(item).length - 1}
                        </div>
                    )}
                    <div className="absolute bottom-0 right-0 bg-black/50 text-white p-0.5 rounded-tl-md">
                        <ImageIcon className="w-3 h-3"/>
                    </div>
                </>
            );
        } else {
            return <span className="text-[10px] text-gray-400 font-bold">ไม่มีภาพ</span>;
        }
    })()}
</div>

                 <div className="flex-1 min-w-0">
    <h4 className="font-bold text-gray-900 text-sm truncate group-hover:text-blue-600 transition-colors">{item.name}</h4>
    {/* ⭐ ใช้ getDisplayId ตรงนี้ */}
    <p className="text-xs text-gray-500 truncate font-mono">{getDisplayId(item.id) || item.serial || '-'}</p>          
    
    {/* ⭐ ส่วนแสดงผลที่แก้ไข: แยกกรณี Withdraw ให้โชว์ breakdown */}
    {(newOrderMeta.type === 'Withdraw') ? (
        <div className="mt-1">
            <p className="text-xs text-green-600 font-bold">พร้อมเบิก: {item.qty} {item.unit}</p>
            <p className="text-[10px] text-gray-500">
                (ในระบบ: {item.sysStock || 0}, นอกระบบ: {item.nonStock || 0})
            </p>
        </div>
    ) : (newOrderMeta.type !== 'Borrow') && (
        <p className="text-xs text-green-600 mt-1 font-bold">คงเหลือ: {item.qty} {item.unit}</p>
    )}

    {(newOrderMeta.type === 'Borrow') && (
        <p className="text-xs text-indigo-600 mt-1 font-bold">สถานะ: {item.status}</p>
    )}
</div>
                         </div>
                     ))}
                 </div>
                 {getSelectionItems().length === 0 && (
                     <div className="text-center text-gray-400 mt-10">
                         <Search className="w-10 h-10 mx-auto mb-2 opacity-20"/>
                         <p>ไม่พบรายการที่ค้นหา</p>
                     </div>
                 )}
             </div>
          </div>
        </div>
      )}
          
{showDetailModal && selectedRequest && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[200] p-4 backdrop-blur-sm animate-in fade-in no-print">
         <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col overflow-hidden animate-in zoom-in-95">
                 <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-start bg-white sticky top-0 z-10">
                     <div>
                         <div className="flex items-center gap-3">
                             <h3 className="font-bold text-xl text-gray-800">{selectedRequest.id}</h3>
                             <StatusBadge 
    status={selectedRequest.status} 
    type={selectedRequest.type} 
    onClick={() => handleShowActors(selectedRequest)}
/>
                         </div>
                         <p className="text-sm text-gray-500 mt-1">วันที่: {selectedRequest.created} | ผู้ขอ: {selectedRequest.requester}</p>
                     </div>
                     
                    <div className="flex items-center gap-2">

{/* --- [START] ส่วนที่เพิ่มใหม่: ปุ่มจัดการ Cost --- */}
                        {/* 1. ปุ่มแก้ไข (แสดงเมื่อมีสิทธิ์ 29 และไม่อยู่ในโหมดแก้ไข) */}
                        {!isCostEditMode && hasPermission(29) && (
                            <button 
                                onClick={handleStartCostEdit}
                                className="flex items-center gap-1 px-3 py-1.5 bg-yellow-50 text-yellow-700 border border-yellow-200 text-xs font-bold rounded-lg hover:bg-yellow-100 transition-colors shadow-sm"
                            >
                                <Edit className="w-4 h-4"/> แก้ไข Cost
                            </button>
                        )}

                        {/* 2. ปุ่มบันทึก/ยกเลิก (แสดงเมื่ออยู่ในโหมดแก้ไข) */}
                        {isCostEditMode && (
                            <>
                                <button onClick={handleSaveCostEdit} className="flex items-center gap-1 px-3 py-1.5 bg-green-600 text-white text-xs font-bold rounded-lg hover:bg-green-700 shadow-md animate-in fade-in">
                                    <Save className="w-4 h-4"/> บันทึก
                                </button>
                                <button onClick={handleCancelCostEdit} className="px-3 py-1.5 bg-gray-100 text-gray-600 text-xs font-bold rounded-lg hover:bg-gray-200 animate-in fade-in">
                                    ยกเลิก
                                </button>
                            </>
                        )}



{['Approved', 'Ordered', 'PR Issued', 'PO Issued', 'Shipping', 'Contract Signed', 'Partially Received', 'Ready to Disburse', 'Completed', 'Returned'].includes(selectedRequest.status) && 
 (selectedRequest.type === 'Local' ||
  selectedRequest.type === 'Withdraw' || 
  selectedRequest.type === 'Borrow' || 
  // ⭐ แก้ไขเงื่อนไข HO: ยอมรับทั้ง Full Flow หรือรายการที่เคยอนุมัติแล้ว (เคสเปลี่ยนจาก Local)
  (selectedRequest.type === 'HO' && (selectedRequest.isFullApprovalFlow || selectedRequest.isPreviouslyApproved))
 ) && (
    <button 
        onClick={() => handleOpenPrintPreview(selectedRequest)}
        className="flex items-center gap-1 px-3 py-1.5 bg-blue-50 text-blue-600 border border-blue-200 text-xs font-bold rounded-lg hover:bg-blue-100 transition-colors"
        title="พิมพ์เอกสาร"
    >
        <Printer className="w-4 h-4"/> 
        พิมพ์
    </button>
)}

                       <button 
    type="button" 
    onClick={() => {
        // เพิ่ม 2 บรรทัดนี้เพื่อเคลียร์สถานะการแก้ไขเมื่อปิดหน้าต่าง
        setIsCostEditMode(false);
        setTempCostRequest(null);
        setShowDetailModal(false);
    }} 
    className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors" 
    title="ปิดหน้าต่าง"
>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                     </div>
                 </div>
                 {/* ... Body Content เดิม ... */}
                 <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                    {/* (ใช้เนื้อหาเดิมในส่วนนี้ได้เลยครับ ไม่ต้องแก้) */}
                    {/* ... */}
                    {/* ... (Copy โค้ดส่วน Content เดิมมาใส่) ... */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 space-y-6">
                            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                                <h4 className="font-bold text-gray-700 mb-4 flex items-center gap-2 border-b pb-2"><Info className="w-4 h-4"/> ข้อมูลทั่วไป</h4>
                                <div className="grid grid-cols-2 gap-y-4 text-sm">
                                    <div><span className="text-gray-500 block mb-1">ประเภท</span><span className="font-medium bg-gray-100 px-2 py-1 rounded">{selectedRequest.type} {selectedRequest.purchaseType ? `(${selectedRequest.purchaseType})` : ''}</span></div>
                                    <div><span className="text-gray-500 block mb-1">ความสำคัญ</span><span className={`font-bold ${selectedRequest.priority === 'Critical' ? 'text-red-600' : selectedRequest.priority === 'Urgent' ? 'text-orange-600' : 'text-blue-600'}`}>{PRIORITIES[selectedRequest.priority]?.label}</span></div>
                                    <div className="col-span-2"><span className="text-gray-500 block mb-1">โครงการ (Job)</span><span className="font-medium text-gray-900">{selectedRequest.job}</span></div>
                                    <div><span className="text-gray-500 block mb-1">วันที่ต้องการ</span><span className="font-medium">{selectedRequest.dateRequired}</span></div>
                                    <div><span className="text-gray-500 block mb-1">เลขที่เอกสาร</span><span className="font-mono bg-yellow-50 px-2 py-1 rounded border border-yellow-100 text-yellow-800">{selectedRequest.docNumber || '-'}</span></div>
                                </div>
                            </div>
                            {(() => {
                                const existingDocs = [
                                    { label: 'เมลอนุมัติ', file: selectedRequest.attachment, icon: Mail },
                                    { label: 'ใบเสนอราคา', file: selectedRequest.quotation, icon: FileText },
                                    { label: 'ใบขอซื้อ (PR)', file: selectedRequest.prFile, icon: FileText, sub: selectedRequest.prNumber },
                                    { label: 'ใบสั่งซื้อ (PO)', file: selectedRequest.poFile, icon: ShoppingCart, sub: selectedRequest.poNumber },
                                    { label: 'สัญญาเช่า', file: selectedRequest.contractFile, icon: FileSignature }
                                ].filter(doc => doc.file);
                                if (existingDocs.length === 0) return null;
                                return (
                                    <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                                        <h4 className="font-bold text-gray-700 mb-4 flex items-center gap-2 border-b pb-2"><AttachmentIcon className="w-4 h-4"/> เอกสารแนบ (Documents)</h4>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                            {existingDocs.map((doc, idx) => (
                                                <div key={idx} className="p-3 rounded-lg border bg-white border-gray-200 flex items-center gap-3 hover:border-blue-300 transition-colors cursor-pointer group" onClick={() => handleViewFile(doc.file, doc.label)}>
                                                    <div className="w-10 h-10 rounded-lg flex items-center justify-center shrink-0 bg-blue-50 text-blue-600 group-hover:bg-blue-100"><doc.icon className="w-5 h-5"/></div>
                                                    <div className="flex-1 min-w-0">
                                                        <p className="text-xs font-bold text-gray-700 truncate">{doc.label}</p>
                                                        {doc.sub && <p className="text-[10px] text-gray-500 truncate">{doc.sub}</p>}
                                                        <span className="text-[10px] text-blue-600 flex items-center gap-1 mt-0.5 group-hover:underline"><Eye className="w-3 h-3"/> เปิดดู</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })()}

{/* ⭐ INSERT: ส่วนแสดงงบประมาณ (Budget Tracking) - Grouping Mode with Expand Button ⭐ */}
{(() => {
    // 1. ตรวจสอบเงื่อนไขพื้นฐาน
    if (!['Local', 'HO'].includes(selectedRequest.type)) return null;

    // ⭐ ตรวจสอบสิทธิ์การมองเห็น (Admin(2), 8, 9, 26, 29) เฉพาะในโครงการนี้
    const canViewBudget = hasPermission(2, selectedRequest.job) || 
                          hasPermission(8, selectedRequest.job) || 
                          hasPermission(9, selectedRequest.job) || 
                          hasPermission(26, selectedRequest.job) || 
                          hasPermission(29, selectedRequest.job);

    if (!canViewBudget) return null; // ถ้าไม่มีสิทธิ์ ให้ซ่อนส่วนนี้ไปเลย
    
    const items = selectedRequest.items || [];
    const targetProjectName = selectedRequest.job;
    const projectData = projects.find(p => p.name === targetProjectName);
    
    if (!projectData) return null;

    // 2. ฟังก์ชันจัดกลุ่ม Code ที่มีในรายการ (Grouping Logic)
    const groups = {}; 

    const processCodes = (codeList, type) => {
        const uniqueCodes = [...new Set(codeList.filter(c => c))];
        uniqueCodes.forEach(code => {
            // หาข้อมูล Group จาก Project Data
            const defs = type === 'SubJob' ? projectData.subJobs : projectData.matCodes;
            const target = defs?.find(d => d.code === code);
            const groupName = target?.group || 'Others (อื่นๆ)'; // ถ้าไม่ระบุกลุ่ม ให้รวมเป็น Others
            
            const groupKey = `${type}|${groupName}`;
            if (!groups[groupKey]) {
                groups[groupKey] = {
                    type,
                    name: groupName,
                    codes: []
                };
            }
            groups[groupKey].codes.push(code);
        });
    };

    processCodes(items.map(i => i.subJob), 'SubJob');
    processCodes(items.map(i => i.matCode), 'matCode');

    const groupKeys = Object.keys(groups).sort();
    if (groupKeys.length === 0) return null;

    // 3. Helper Function: วาด Progress Bar (ใช้ร่วมกันทั้ง Group และ Code)
    const renderProgressBar = (stats, label, badgeColor, isGroup, groupKey) => {
        if (!stats || stats.budget === 0) return null;

        const totalUsed = stats.used + stats.pending + stats.current;
        const isOver = totalUsed > stats.budget;
        const remaining = stats.budget - totalUsed;

        // คำนวณ % สำหรับกราฟ
        const usedPercent = Math.min((stats.used / stats.budget) * 100, 100);
        const pendingPercent = Math.min((stats.pending / stats.budget) * 100, 100 - usedPercent);
        const currentPercent = Math.min((stats.current / stats.budget) * 100, 100 - usedPercent - pendingPercent);

        // เช็คสถานะเปิด/ปิดกลุ่ม
        const isExpanded = expandedBudgetGroups[groupKey];

        return (
            <div className={`p-3 rounded-xl border transition-all ${isGroup ? 'bg-slate-50 border-slate-200' : 'bg-white border-slate-100 ml-4 mt-2 border-l-4 border-l-slate-300'}`}>
                
                {/* Header Row: Label & Stats */}
                <div className="flex justify-between items-center mb-2">
                    <div className="flex items-center gap-2">
                        {/* ⭐ ปุ่มกดขยาย (SVG) - แสดงเฉพาะ Group */}
                        {isGroup && (
                            <button 
                                onClick={() => setExpandedBudgetGroups(prev => ({...prev, [groupKey]: !prev[groupKey]}))}
                                className="p-1 hover:bg-gray-200 rounded-full transition-colors text-gray-500 flex items-center justify-center bg-white border border-gray-300 shadow-sm"
                                title={isExpanded ? "ย่อเก็บ" : "ขยายดูรายการ"}
                            >
                                {/* SVG Chevron Icon (หมุนเมื่อกด) */}
                                <svg 
                                    xmlns="http://www.w3.org/2000/svg" 
                                    width="14" height="14" 
                                    viewBox="0 0 24 24" 
                                    fill="none" 
                                    stroke="currentColor" 
                                    strokeWidth="2" 
                                    strokeLinecap="round" 
                                    strokeLinejoin="round"
                                    className={`transition-transform duration-200 ${isExpanded ? 'rotate-90' : ''}`}
                                >
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </button>
                        )}
                        
                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${badgeColor} border border-opacity-20`}>
    {/* ⭐ แก้ไข: เปลี่ยน matCode เป็น Mat. Code */}
    {isGroup ? (label.split('|')[0] === 'matCode' ? 'Mat. Code' : label.split('|')[0]) : 'Code'}
</span>
                        
                        <span className="font-bold text-gray-800 text-sm">
                            {isGroup ? label.split('|')[1] : label}
                        </span>
                        
                        <span className="text-xs text-gray-500 hidden sm:inline-block">
                            (งบ: {stats.budget.toLocaleString()})
                        </span>
                    </div>
                    
                    <div className={`text-sm font-bold ${isOver ? 'text-red-600' : 'text-gray-700'}`}>
                        ใช้รวม {totalUsed.toLocaleString()} {isOver && <span className="text-[10px] bg-red-100 px-1.5 py-0.5 rounded ml-1 text-red-600 border border-red-200">เกินงบ!</span>}
                    </div>
                </div>
                
                {/* Progress Bar Visual */}
                <div className="h-3 w-full bg-gray-200 rounded-full overflow-hidden flex relative shadow-inner">
                    <div className="h-full bg-green-500" style={{ width: `${usedPercent}%` }} title={`ใช้แล้ว: ${stats.used.toLocaleString()}`}></div>
                    <div className="h-full bg-yellow-400" style={{ width: `${pendingPercent}%` }} title={`รออนุมัติ: ${stats.pending.toLocaleString()}`}></div>
                    <div className="h-full bg-orange-500" style={{ width: `${currentPercent}%` }} title={`ใบนี้: ${stats.current.toLocaleString()}`}></div>
                    {isOver && <div className="absolute right-0 top-0 h-full w-1 bg-red-600 animate-pulse"></div>}
                </div>
                
                {/* Legend Text */}
                <div className="flex flex-wrap gap-x-3 gap-y-1 text-[10px] text-gray-500 mt-2">
                    <span className="flex items-center gap-1"><div className="w-2 h-2 bg-green-500 rounded-full"></div> ใช้แล้ว ({stats.used.toLocaleString()})</span>
                    <span className="flex items-center gap-1"><div className="w-2 h-2 bg-yellow-400 rounded-full"></div> รออนุมัติ ({stats.pending.toLocaleString()})</span>
                    <span className="flex items-center gap-1"><div className="w-2 h-2 bg-orange-500 rounded-full"></div> ใบนี้ ({stats.current.toLocaleString()})</span>
                    <span className="ml-auto font-bold">คงเหลือ: <span className={remaining < 0 ? 'text-red-500' : 'text-green-600'}>{remaining.toLocaleString()}</span></span>
                </div>
            </div>
        );
    };

    return (
        <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm animate-in fade-in mb-6">
            <h4 className="font-bold text-gray-700 mb-4 flex items-center gap-2 border-b pb-2">
                <div className="bg-orange-100 p-1.5 rounded-lg text-orange-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v20"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                </div> 
                ติดตามงบประมาณ (Budget Tracking)
            </h4>
            
            <div className="space-y-3">
               
{groupKeys.map((key) => {
    const group = groups[key];
    const badgeColor = group.type === 'SubJob' ? 'bg-indigo-100 text-indigo-700 border-indigo-200' : 'bg-purple-100 text-purple-700 border-purple-200';
    
    // 🟢 1. คำนวณยอดกลุ่ม (ส่ง isGroup = true)
    const groupStats = getBudgetStats(selectedRequest, group.name, group.type, true);

    return (
        <div key={key} className="animate-in fade-in">
            {/* แสดง Progress Bar ของกลุ่ม */}
            {renderProgressBar(
                groupStats, 
                `${group.type}|${group.name}`, 
                badgeColor, 
                true, // เป็น Group
                key
            )}

            {/* ส่วนย่อย (เมื่อกดขยาย) */}
            {expandedBudgetGroups[key] && (
                <div className="space-y-1 animate-in slide-in-from-top-2 duration-200 origin-top">
                    {group.codes.map(code => {
                        // 🔵 2. คำนวณยอดราย Code (ส่ง isGroup = false หรือไม่ส่งค่า Default)
                        const codeStats = getBudgetStats(selectedRequest, code, group.type, false);
                        
                        return (
                            <div key={code}>
                                {renderProgressBar(
                                    codeStats, 
                                    code, 
                                    'bg-gray-100 text-gray-600 border-gray-300', 
                                    false, // ไม่ใช่ Group
                                    null
                                )}
                            </div>
                        );
                    })}
                </div>
            )}
        </div>
    );
})}
            </div>
        </div>
    );
})()}

                            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
    <h4 className="font-bold text-gray-700 mb-4 flex items-center gap-2 border-b pb-2">
        <ShoppingCart className="w-4 h-4"/> รายการสินค้า ({selectedRequest.items.length})
    </h4>
    
    <div className="overflow-x-auto border border-gray-200 rounded-lg">
        <table className="w-full text-sm">
            {/* ⭐ 1. แก้ไข Header: เช็คประเภทเพื่อโชว์ Column ให้ถูกต้อง */}
            <thead className="bg-gray-100 text-gray-700 border-b">
                <tr>
                    <th className="p-3 text-left font-bold">รายการ</th>
                    
                    {/* แสดงราคาเฉพาะงานซื้อ (Local/HO) */}
                    {['Local', 'HO'].includes(selectedRequest.type) && (
                        <th className="p-3 text-right font-bold">ราคา/หน่วย</th>
                    )}
                    
                    <th className="p-3 text-center font-bold">จำนวน</th>
                    
                    {/* แสดงรวมเงินเฉพาะงานซื้อ */}
                    {['Local', 'HO'].includes(selectedRequest.type) && (
                        <th className="p-3 text-right font-bold">รวมเงิน</th>
                    )}
                    
                    <th className="p-3 text-left font-bold w-32">หมายเหตุ</th>
                </tr>
            </thead>

    <tbody className="divide-y divide-gray-100">
                {/* ⭐ ใช้ข้อมูลจาก tempCostRequest ถ้ากำลังแก้ไข Cost */}
                {(isCostEditMode ? tempCostRequest.items : selectedRequest.items).map((item, idx) => {
                    const isBuy = ['Local', 'HO'].includes(selectedRequest.type);
                    const isBorrow = selectedRequest.type === 'Borrow';
                    const isRent = selectedRequest.type === 'HO' && selectedRequest.purchaseType === 'Rent';
                    
                    // เตรียมข้อมูล Project เพื่อดึงตัวเลือก SubJob/MatCode
                    const currentJob = isCostEditMode ? tempCostRequest.job : selectedRequest.job;
                    const projectData = projects.find(p => p.name === currentJob);

                   
const sourceAssets = (isCostEditMode && tempCostRequest?.tempAssets) ? tempCostRequest.tempAssets : assets;
    
    // 🟢 แทนที่ด้วยโค้ดชุดนี้:
    const relatedAssets = sourceAssets.filter(a => 
        a.currentRequestId === selectedRequest.id && // 1. เช็คเลขที่ใบคำขอ
        a.name === item.name && // 2. เช็คชื่อสินค้า
        // 3. ⭐ เช็คราคา (เพื่อแยกรายการที่ชื่อซ้ำแต่คนละราคา)
        (a.price === item.unitPrice || a.rentalPrice === item.unitPrice) 
    );

    const receivedLogs = item.receivedLog || [];
                    
                    const hasAssets = relatedAssets.length > 0;
                    const hasLogs = receivedLogs.length > 0;
                    const hasDetails = hasAssets || hasLogs;
                    const isExpanded = expandedItems.has(idx);
                    
                    let lineTotal = 0;
                    let lineReceivedCount = 0;
                    if (isBuy) {
                        if (hasAssets) {
                             lineTotal += relatedAssets.reduce((sum, asset) => {
                                 const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                                 const duration = isRent ? (asset.duration || item.duration || 1) : 1;
                                 return sum + (price * duration);
                              }, 0);
                             lineReceivedCount = relatedAssets.length;
                        } else if (hasLogs) {
                             lineTotal += receivedLogs.reduce((sum, log) => {
                                 const duration = isRent ? (log.duration || 1) : 1;
                                 return sum + (log.qty * log.price * duration);
                              }, 0);
                             lineReceivedCount = item.receivedTotal || 0;
                        }
                        if (!['Completed', 'Partially Received'].includes(selectedRequest.status)) {
    const remainingQty = Math.max(0, item.qty - lineReceivedCount);
    const estimateDuration = isRent ? (item.duration || 1) : 1;
    lineTotal += (remainingQty * item.unitPrice * estimateDuration);
}
                    }

                    return (
                        <React.Fragment key={idx}>
                        <tr className={isExpanded ? "bg-blue-50/30 transition-colors" : "transition-colors hover:bg-slate-50"}>
                            
                           {/* 1. Column รายการ */}
                            <td className="p-3 align-top">
                                <div className="flex items-start gap-2">
                                   {hasDetails && (
                                       <button 
                                            onClick={() => toggleExpandItem(idx)}
                                            className={`mt-0.5 p-0.5 rounded border transition-all ${isExpanded ? 'bg-blue-100 text-blue-700 border-blue-200' : 'bg-white text-gray-400 border-gray-200 hover:text-blue-600 hover:border-blue-300'}`}
                                       >
                                            {isExpanded ? 
                                              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"/></svg> 
                                              : <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                                            }
                                        </button>
                                    )}
                                    
                                    <div className="flex-1">
                                        {/* แสดงรหัสสินค้า (Code Lookup) */}
                                        {(() => {
                                            const stockItem = inventory.find(inv => inv.name === item.name && inv.project === selectedRequest.job);
                                            const assetItem = !stockItem ? assets.find(a => a.name === item.name && a.project === selectedRequest.job) : null;
                                            const codeToShow = stockItem ? getDisplayId(stockItem.id) : (assetItem ? assetItem.id : null);

                                            if (codeToShow) {
                                                return (
                                                    <div className="text-[10px] font-mono font-bold text-slate-500 bg-slate-100 px-1.5 rounded border border-slate-200 w-fit mb-1">
                                                        {codeToShow}
                                                    </div>
                                                );
                                            }
                                            return null;
                                        })()}

                                        <div className="font-bold text-gray-900">{item.name}</div>
                                        
                                        {/* กรณี Borrow: แสดง Serial / Asset ID */}
                                        {isBorrow && (item.assetId || item.serial) && (
                                            <div className="text-xs font-mono text-indigo-600 mt-1 flex flex-wrap gap-2">
                                                {item.assetId && <span className="bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100">ID: {item.assetId}</span>}
                                                {item.serial && <span className="bg-slate-50 text-slate-600 px-1.5 py-0.5 rounded border border-slate-200">S/N: {item.serial}</span>}
                                            </div>
                                        )}

                                        {/* กรณี Buy: แสดง SubJob / MatCode (รองรับโหมดแก้ไข) */}
                                        {isBuy && (
                                            <div className="text-xs text-gray-500 mt-1">
                                                <div className="flex flex-col gap-2">
                                                    {isCostEditMode ? (
                                                        <div className="flex flex-col gap-1">
                                                            <div className="flex items-center gap-1">
                                                                <span className="font-bold w-8 text-gray-400">Sub:</span>
                                                                <select 
                                                                    className="border border-indigo-300 rounded px-1 py-1 text-xs bg-indigo-50 text-indigo-700 w-full max-w-[250px] outline-none" 
                                                                    value={item.subJob || ''} 
                                                                    onChange={(e) => { const newData = {...tempCostRequest}; newData.items[idx].subJob = e.target.value; setTempCostRequest(newData); }}
                                                                >
                                                                    <option value="">-- ไม่ระบุ --</option>
                                                                    {projectData?.subJobs?.map(s => <option key={s.code} value={s.code}>{s.code}: {s.description}</option>)}
                                                                </select>
                                                            </div>
                                                            <div className="flex items-center gap-1">
                                                                <span className="font-bold w-8 text-gray-400">Mat.:</span>
                                                                <select 
                                                                    className="border border-purple-300 rounded px-1 py-1 text-xs bg-purple-50 text-purple-700 w-full max-w-[250px] outline-none" 
                                                                    value={item.matCode || ''} 
                                                                    onChange={(e) => { const newData = {...tempCostRequest}; newData.items[idx].matCode = e.target.value; setTempCostRequest(newData); }}
                                                                >
                                                                    <option value="">-- ไม่ระบุ --</option>
                                                                    {projectData?.matCodes?.map(m => <option key={m.code} value={m.code}>{m.code}: {m.description}</option>)}
                                                                </select>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <>
                                                            {item.subJob && <div className="flex gap-2"><span className="bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded border border-indigo-100">Sub: {item.subJob}</span></div>}
                                                            {item.matCode && <div className="flex gap-2"><span className="bg-purple-50 text-purple-700 px-1.5 py-0.5 rounded border border-purple-100">Mat.: {item.matCode}</span></div>}
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </td>

                            {/* 2. Column ราคา (แสดงเฉพาะงานซื้อ) - แก้ไข: เช็คราคาคละ (Mixed Price) */}
                            {isBuy && (
                                <td className="p-3 text-right text-gray-700 align-top">
                                    {(() => {
                                        // 1. ดึงประวัติราคาที่รับจริงทั้งหมด
                                        const rLogs = item.receivedLog || [];
                                        const actualPrices = rLogs.map(l => l.price).filter(p => p !== undefined && p !== null);
                                        
                                        // 2. เช็คว่ามีกี่ราคาที่ไม่ซ้ำกัน
                                        const uniquePrices = [...new Set(actualPrices)];
                                        const isMixed = uniquePrices.length > 1;
                                        
                                        // 3. หาราคาที่จะแสดง (ถ้ายังไม่รับเลย ให้ใช้ราคาประเมิน unitPrice)
                                        const displayPrice = uniquePrices.length === 1 ? uniquePrices[0] : item.unitPrice;

                                        return (
                                            <div className="flex flex-col items-end">
                                                {isMixed ? (
                                                    // กรณี A: มีหลายราคา (คละกัน) -> แสดงป้ายเตือน
                                                    <>
                                                        <span className="text-xs font-bold text-orange-700 bg-orange-100 px-2 py-1 rounded border border-orange-200 shadow-sm mb-1">
                                                            คละราคา
                                                        </span>
                                                        <span className="text-[9px] text-gray-400">(Mixed Price)</span>
                                                    </>
                                                ) : (
                                                    // กรณี B: ราคาเดียว (หรือยังไม่ได้รับของ) -> แสดงตัวเลขปกติ
                                                    <>
                                                        <span className="font-mono font-bold text-gray-900">
                                                            {displayPrice > 0 ? displayPrice.toLocaleString() : '-'}
                                                        </span>
                                                        {displayPrice > 0 && (
                                                            <span className="text-[10px] text-gray-500">
                                                                {isRent ? `/${item.rentalUnit || 'เดือน'}` : `บาท`}
                                                            </span>
                                                        )}
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })()}
                                </td>
                            )}

                            {/* 3. Column จำนวน */}
                            <td className="p-3 text-center align-top">
                                {isBuy ? (
                                    <div className="font-medium">
    {/* ⭐ แก้ไข: ใช้นับจำนวนจริงจาก relatedAssets (ถ้ามี) หรือใช้ receivedTotal กรณีเป็นวัสดุ */}
    {hasAssets ? 
        <span className="text-green-600 font-bold">{relatedAssets.length}</span> : 
        (item.receivedTotal ? <span className="text-green-600 font-bold">{item.receivedTotal}</span> : 0)
    }
    <span className="text-gray-400 mx-1">/</span> 
    {item.qty} 
    <span className="text-xs text-gray-500 ml-1">{item.unit}</span>
</div>
                                ) : (
                                    <div className="font-bold text-blue-700 text-base">
                                        {item.qty} <span className="text-xs text-gray-500 font-normal">{item.unit}</span>
                                    </div>
                                )}
                                
                                {isRent && isBuy && (
                                    <div className="text-[10px] mt-0.5 text-indigo-600 font-bold">
                                        x {item.duration || 1} {item.rentalUnit === 'Day' ? 'วัน' : item.rentalUnit === 'Year' ? 'ปี' : 'เดือน'}
                                    </div>
                                )}
                            </td>

                            {/* 4. Column รวมเงิน */}
                            {isBuy && (
                                <td className="p-3 text-right font-bold text-gray-900 align-top bg-gray-50/50">
                                    {lineTotal.toLocaleString()}
                                </td>
                            )}

                            {/* 5. Column หมายเหตุ */}
<td className="p-3 text-xs text-gray-500 align-top break-words whitespace-pre-wrap max-w-[200px]">
    {item.note || '-'}
    
    {/* ⭐ เพิ่ม: แจ้งเตือนถ้ารับของไม่ครบในสถานะจบงาน/รับบางส่วน */}
    {['Completed', 'Partially Received'].includes(selectedRequest.status) && (item.receivedTotal || 0) < item.qty && (
        <div className="mt-1 text-[10px] text-orange-700 bg-orange-50 border border-orange-200 px-1.5 py-0.5 rounded w-fit font-bold">
            * รับไม่ครบ (คิดยอดจริง)
        </div>
    )}

    {item.images && item.images.length > 0 && (
                                    <div className="mt-1">
                                        <button onClick={(e) => { e.stopPropagation(); setViewingAttachments({ attachments: item.images }); }} className="text-[10px] text-blue-600 flex items-center gap-1 hover:underline">
                                            <ImageIcon className="w-3 h-3"/> รูปภาพ ({item.images.length})
                                        </button>
                                    </div>
                                )}
                            </td>
                        </tr>
                        
                        {/* Expanded Details Row */}
                        {isExpanded && hasDetails && (
                            <tr className="bg-gray-50/50 animate-in fade-in">
                                <td colSpan={isBuy ? 5 : 3} className="p-4 border-t border-gray-200 shadow-inner">
                                    <div className="bg-white border border-gray-200 rounded-lg overflow-hidden max-w-4xl mx-auto">
                                        <div className="px-4 py-2 bg-gray-100/80 border-b flex justify-between items-center">
                                            <h5 className="font-bold text-gray-700 text-xs flex items-center gap-2">
                                                <List className="w-3 h-3 text-gray-500"/> 
                                                {hasAssets ? 'รายละเอียดทรัพย์สินรายชิ้น (Asset Details)' : 'ประวัติการรับของ (Receive History)'}
                                            </h5>
                                            {/* ⭐ แจ้งเตือนเมื่ออยู่ในโหมดแก้ไขราคา */}
                                            {isCostEditMode && hasLogs && <span className="text-[10px] text-orange-600 font-bold flex items-center gap-1 bg-orange-50 px-2 py-0.5 rounded border border-orange-200"><Edit className="w-3 h-3"/> แก้ไขราคาจริง (Actual Price) ได้ที่นี่</span>}
                                        </div>
                                        
                                        <table className="w-full text-xs text-left">
                                            <thead className="bg-gray-50 text-gray-500 font-semibold">
                                                <tr>
                                                    <th className="px-4 py-2 w-10 text-center">#</th>
                                                    <th className="px-4 py-2 w-28">วันที่รับ</th> 
                                                    {hasAssets ? (
                                                        <>
                                                            <th className="px-4 py-2 w-32">Asset ID</th>
                                                            <th className="px-4 py-2 w-32">Serial No.</th>
                                                        </>
                                                    ) : (
                                                        <th className="px-4 py-2" colSpan="2">รายละเอียดการรับ (Batch Info)</th>
                                                    )}
                                                    {isBuy && (
                                                        <>
                                                            <th className="px-4 py-2 text-right">ราคาจริง (Price)</th>
                                                            {isRent && <th className="px-4 py-2 text-center w-28">ระยะเวลา</th>}
                                                            <th className="px-4 py-2 text-right w-32">รวมเงิน (Total)</th>
                                                        </>
                                                    )}
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                              {(() => {
                                                    if (hasAssets) {
                                                        return relatedAssets.map((asset, aIdx) => {
                                                            const assetPrice = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                                                            const assetDuration = isRent ? (asset.duration || item.duration || 1) : 1;
                                                            const totalRow = assetPrice * assetDuration;
                                                            const unitMap = { 'Day': 'วัน', 'Month': 'เดือน', 'Year': 'ปี' };
                                                            const unitLabel = unitMap[asset.rentalUnit] || 'เดือน';

                                                            return (
                                                                <tr key={`ast-${aIdx}`} className="hover:bg-blue-50/50">
                                                                    <td className="px-4 py-2.5 text-center text-gray-400">{aIdx + 1}</td>
                                                                    <td className="px-4 py-2.5 text-gray-500 font-mono">
                                                                        {asset.lastUpdated ? asset.lastUpdated.split(' ')[0] : '-'}
                                                                    </td>
                                                                    <td className="px-4 py-2.5">
                                                                        <span className="font-mono text-blue-600 font-bold bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100">
                                                                            {asset.id}
                                                                        </span>
                                                                    </td>
                                                                    <td className="px-4 py-2.5 font-mono text-gray-600">
                                                                        {asset.serial || '-'}
                                                                    </td>
                                                                    {isBuy && (
                                                                        <>
                                                                            <td className="px-4 py-2.5 text-right font-mono">
                                                                                {/* ⭐ แก้ไข: ถ้าเป็น Edit Mode ให้แสดง Input ราคา */}
                                                                                {isCostEditMode ? (
                                                                                    <input 
                                                                                        type="number" 
                                                                                        className="border border-blue-300 rounded px-1 py-0.5 text-right w-24 text-sm font-bold text-blue-700 bg-blue-50 focus:ring-2 focus:ring-blue-500 outline-none"
                                                                                        value={isRent ? asset.rentalPrice : asset.price}
                                                                                        onChange={(e) => {
    const val = parseFloat(e.target.value) || 0;
    setTempCostRequest(prev => {
        const newAssets = prev.tempAssets.map(item => 
            item.id === asset.id 
                ? { ...item, [isRent ? 'rentalPrice' : 'price']: val }
                : item
        );
        return { ...prev, tempAssets: newAssets };
    });
}}
                                                                                    />
                                                                                ) : (
                                                                                    assetPrice.toLocaleString()
                                                                                )}
                                                                            </td>
                                                                            
                                                                            {isRent && (
                                                                                <td className="px-4 py-2.5 text-center text-indigo-600 font-bold bg-indigo-50/30">
                                                                                    {/* ⭐ แก้ไข: ถ้าเป็น Edit Mode ให้แสดง Input ระยะเวลาและหน่วย */}
                                                                                    {isCostEditMode ? (
                                                                                        <div className="flex items-center gap-1 justify-center">
                                                                                            <input 
                                                                                                type="number"
                                                                                                min="1"
                                                                                                className="border border-indigo-300 rounded px-1 py-0.5 text-center w-12 text-xs font-bold text-indigo-700 bg-white focus:ring-1 focus:ring-indigo-500"
                                                                                                value={asset.duration || 1}
                                                                                               onChange={(e) => {
    const val = parseFloat(e.target.value) || 1;
    setTempCostRequest(prev => {
        const newAssets = prev.tempAssets.map(item => 
            item.id === asset.id 
                ? { ...item, duration: val }
                : item
        );
        return { ...prev, tempAssets: newAssets };
    });
}}
                                                                                            />
                                                                                            <select
                                                                                                className="border border-indigo-300 rounded px-0 py-0.5 text-xs bg-white text-indigo-700 outline-none"
                                                                                                value={asset.rentalUnit || 'Month'}
                                                                                           onChange={(e) => {
    const val = e.target.value;
    setTempCostRequest(prev => {
        const newAssets = prev.tempAssets.map(item => 
            item.id === asset.id 
                ? { ...item, rentalUnit: val }
                : item
        );
        return { ...prev, tempAssets: newAssets };
    });
}}
                                                                                            >
                                                                                                <option value="Day">วัน</option>
                                                                                                <option value="Month">เดือน</option>
                                                                                                <option value="Year">ปี</option>
                                                                                            </select>
                                                                                        </div>
                                                                                    ) : (
                                                                                        `${assetDuration} ${unitLabel}`
                                                                                    )}
                                                                                </td>
                                                                            )}
                                                                            
                                                                            <td className="px-4 py-2.5 text-right font-bold text-gray-800">
                                                                                {totalRow.toLocaleString()}
                                                                            </td>
                                                                        </>
                                                                    )}
                                                                </tr>
                                                            );
                                                        });
                                                    }
                                                     else if (hasLogs) {
                                                        return receivedLogs.map((log, lIdx) => {
                                                            const logDuration = isRent ? (log.duration || 1) : 1;
                                                            const totalRow = log.qty * log.price * logDuration;

                                                            return (
                                                                <tr key={`log-${lIdx}`} className="hover:bg-gray-50">
                                                                    <td className="px-4 py-2.5 text-center text-gray-400">{lIdx + 1}</td>
                                                                    <td className="px-4 py-2.5 text-gray-500 font-mono">
                                                                        {log.date.split(' ')[0]}
                                                                    </td>
                                                                    <td className="px-4 py-2.5 text-gray-500" colSpan="2">
                                                                        <span className="ml-2 text-gray-400 italic">(Lot/Batch Inventory)</span>
                                                                    </td>
                                                                    {isBuy && (
                                                                        <>
                                                                            <td className="px-4 py-2.5 text-right font-mono text-gray-600">
                                                                                {/* ⭐ แก้ไข: Input ราคาจริง (Lot Price) */}
                                                                                {isCostEditMode ? (
                                                                                    <div className="flex items-center justify-end gap-1">
                                                                                        <input 
                                                                                            type="number" 
                                                                                            className="border border-blue-300 rounded px-1 py-0.5 text-right w-24 text-sm font-bold text-blue-700 bg-blue-50 focus:ring-2 focus:ring-blue-500 outline-none"
                                                                                            value={log.price}
                                                                                            onChange={(e) => {
                                                                                                const newData = {...tempCostRequest};
                                                                                                // แก้ราคาใน Log เฉพาะรายการนี้
                                                                                                newData.items[idx].receivedLog[lIdx].price = parseFloat(e.target.value) || 0;
                                                                                                setTempCostRequest(newData);
                                                                                            }}
                                                                                        />
                                                                                        <span className="text-[10px] text-gray-400">x {log.qty}</span>
                                                                                    </div>
                                                                                ) : (
                                                                                    // แสดงผลปกติ
                                                                                    <>
                                                                                        {log.price.toLocaleString()} <span className="text-[10px] text-gray-400">x {log.qty}</span>
                                                                                    </>
                                                                                )}
                                                                            </td>
                                                                            {isRent && (
                                                                                <td className="px-4 py-2.5 text-center text-indigo-600 font-bold">
                                                                                    {logDuration}
                                                                                </td>
                                                                            )}
                                                                            <td className="px-4 py-2.5 text-right font-bold text-gray-800">
                                                                                {totalRow.toLocaleString()}
                                                                            </td>
                                                                        </>
                                                                    )}
                                                                </tr>
                                                            );
                                                        });
                                                    }
                                                    return <tr><td colSpan="7" className="p-4 text-center text-gray-400 italic">ไม่มีข้อมูลรายละเอียด</td></tr>;
                                                })()}
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        )}
                        </React.Fragment>
                    );
                })}
            </tbody>

{/* ⭐ 4. Footer: แสดง Grand Total */}
{['Local', 'HO'].includes(selectedRequest.type) && (
    <tfoot className="bg-gray-50 border-t-2 border-gray-200">
        <tr>
            <td colSpan="3" className="p-4 text-right text-gray-600 text-sm align-top pt-5">
                รวมจำนวนเงินทั้งสิ้น (Grand Total)
            </td>
            <td className="p-4 text-right">
                <div className="font-bold text-xl text-blue-700">
                    {/* ⭐ แก้ไข Logic คำนวณ Grand Total */}
                    {(isCostEditMode && tempCostRequest ? tempCostRequest.items : selectedRequest.items).reduce((sum, item) => {
                        const isRent = selectedRequest.type === 'HO' && selectedRequest.purchaseType === 'Rent';
                        const sourceAssets = (isCostEditMode && tempCostRequest?.tempAssets) ? tempCostRequest.tempAssets : assets;
                        // ✅ แก้ไข: เพิ่มเงื่อนไขเช็คราคา เพื่อให้ยอดตรงกับตารางด้านบน
const relatedAssets = sourceAssets.filter(a => 
    a.currentRequestId === selectedRequest.id && 
    a.name === item.name &&
    (a.price === item.unitPrice || a.rentalPrice === item.unitPrice)
);
                        const receivedLogs = item.receivedLog || [];
                        
                        let itemTotal = 0;
                        let receivedCount = 0;

                        // A. Assets
                        if (relatedAssets.length > 0) {
                            itemTotal += relatedAssets.reduce((aSum, asset) => {
                                const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                                const duration = isRent ? (asset.duration || item.duration || 1) : 1;
                                return aSum + (price * duration);
                            }, 0);
                            receivedCount = relatedAssets.length;
                        } 
                        // B. Logs
                        else if (receivedLogs.length > 0) {
                            itemTotal += receivedLogs.reduce((lSum, log) => {
                                const duration = isRent ? (log.duration || 1) : 1;
                                return lSum + (log.qty * log.price * duration);
                            }, 0);
                            receivedCount = item.receivedTotal || 0;
                        }
                        
                        // ⭐ C. Estimate: คิดเฉพาะถ้าสถานะ "ไม่ใช่" จบงาน หรือ รับบางส่วน
                        // (Logic เดิมถูกต้องแล้ว แต่ปรับให้ชัดเจนขึ้น)
                        if (!['Completed', 'Partially Received'].includes(selectedRequest.status)) {
                            const remainingQty = Math.max(0, item.qty - receivedCount);
                            const estimateDuration = isRent ? (item.duration || 1) : 1;
                            itemTotal += (remainingQty * item.unitPrice * estimateDuration);
                        }

                        return sum + itemTotal;
                    }, 0).toLocaleString()}
                </div>

                {/* ⭐ เพิ่มหมายเหตุท้ายบิล */}
                {['Completed', 'Partially Received'].includes(selectedRequest.status) && (
                    <div className="text-[10px] text-orange-600 font-bold mt-1 bg-orange-50 px-2 py-1 rounded border border-orange-200 inline-block">
                        * ยอดรวมตามจริง (เฉพาะที่รับของแล้ว)
                    </div>
                )}
            </td>
            <td className="bg-gray-50"></td> 
        </tr>
    </tfoot>
)}
        </table>
    </div>
</div>
                        </div>
                        <div className="space-y-6">
                            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm h-full flex flex-col">
                                <h4 className="font-bold text-gray-700 mb-4 flex items-center gap-2 border-b pb-2"><History className="w-4 h-4"/> ประวัติการดำเนินการ</h4>
                                <div className="relative border-l-2 border-gray-100 ml-2 space-y-6 pb-2 flex-1 overflow-y-auto pr-2">
                                    {selectedRequest.history.slice().reverse().map((log, idx) => (
                                        <div key={idx} className="ml-6 relative">
                                            <div className={`absolute -left-[31px] top-0 w-4 h-4 rounded-full border-2 border-white ${idx===0 ? 'bg-blue-500 ring-2 ring-blue-100' : 'bg-gray-300'}`}></div>
                                            <div className="flex justify-between items-start">
    <span className="text-xs font-bold text-gray-900">
        {/* ⭐ ถ้าเจอคำว่า Pending PM ให้เปลี่ยนเป็น Pending Level 2 ทันที */}
        {log.action === 'Pending PM' ? 'Pending Level 2' : log.action}
    </span>
    {/* ⭐ เพิ่ม Timestamp ตรงนี้ */}
    <span className="text-[10px] text-gray-400 whitespace-nowrap ml-2 font-mono">
        {log.date}
    </span>
</div>
                                            <p className="text-xs text-gray-500 mt-0.5">โดย: {log.user}</p>
                                            {log.note && (<div className={`mt-2 text-xs p-3 rounded-lg border ${log.action === 'Return for Revision' || log.note.includes('ส่งคืนแก้ไข') ? 'bg-red-50 text-red-700 border-red-200 font-medium' : 'bg-gray-50 text-gray-600 border-gray-100'}`}>{log.action === 'Return for Revision' && <AlertCircle className="w-3 h-3 inline mr-1 mb-0.5"/>}{log.note}</div>)}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
             </div>
        </div>
      )}

{showVerificationModal && (
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[80] p-4 backdrop-blur-sm animate-in fade-in">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-in zoom-in-95 duration-200 flex flex-col max-h-[90vh]">
             
             {/* --- HEADER --- */}
             <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-start bg-white sticky top-0 z-10">
                 <div>
                     <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2">
                         <CheckSquare className="w-5 h-5 text-indigo-600"/> ตรวจสอบเอกสาร
                     </h3>
                     <p className="text-sm text-gray-500 mt-1">Verification Process</p>
                 </div>
                 
                 <div className="flex items-center gap-2">
                    

                     <button 
                        type="button"
                        onClick={() => setShowVerificationModal(false)} 
                        className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
                        title="ปิดหน้าต่าง"
                     >
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                 </div>
             </div>
             
             {/* --- BODY --- */}
             <div className="p-6 overflow-y-auto bg-gray-50 flex-1 space-y-4">
                 
                 {/* Checklist Section */}
                 <div className="space-y-3">
                     {/* Quotation Check */}
                     <div className={`p-3 rounded-xl border shadow-sm flex items-center justify-between transition-colors ${verificationData.checks.quotation ? 'bg-white border-gray-200' : 'bg-red-50 border-red-200'}`}>
                         <div className="flex items-center gap-3">
                             <div className={`w-8 h-8 rounded-full flex items-center justify-center ${verificationData.filesExist.quotation ? 'bg-indigo-50 text-indigo-600' : 'bg-gray-100 text-gray-400'}`}>
                                 <FileText className="w-4 h-4"/>
                             </div>
                             <div>
                                 <p className="text-sm font-bold text-gray-700">ใบเสนอราคา (Quotation)</p>
                                 {!verificationData.filesExist.quotation && <span className="text-[10px] text-red-500 font-bold">* ไม่มีไฟล์แนบ</span>}
                                 {verificationData.filesExist.quotation && 
                                     <button 
                                         type="button"
                                         onClick={(e) => {
                                             e.preventDefault();
                                             const req = requests.find(r => r.id === verificationData.requestId);
                                             handleViewFile(req?.quotation, 'Quotation');
                                         }}
                                         className="text-[10px] text-indigo-600 hover:underline flex items-center gap-1"
                                     >
                                         <Eye className="w-3 h-3"/> ดูไฟล์
                                     </button>
                                 }
                             </div>
                         </div>
                         <label className={`cursor-pointer px-3 py-1.5 rounded-lg border text-xs font-bold transition-all flex items-center gap-1.5 ${verificationData.checks.quotation ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-red-300 text-red-600 shadow-sm'}`}>
                             <input 
                                 type="checkbox" className="hidden"
                                 checked={verificationData.checks.quotation} 
                                 onChange={() => handleChecklistChange('quotation')} 
                             />
                             {verificationData.checks.quotation 
                                 ? (verificationData.filesExist.quotation ? <><CheckCircle className="w-3 h-3"/> ถูกต้อง</> : <><CheckSquare className="w-3 h-3"/> ยกเว้นให้ (Waive)</>)
                                 : (verificationData.filesExist.quotation ? 'ไม่ถูกต้อง' : 'จำเป็นต้องมี')
                             }
                         </label>
                     </div>

                     {/* Email Check */}
                     <div className={`p-3 rounded-xl border shadow-sm flex items-center justify-between transition-colors ${verificationData.checks.email ? 'bg-white border-gray-200' : 'bg-red-50 border-red-200'}`}>
                         <div className="flex items-center gap-3">
                             <div className={`w-8 h-8 rounded-full flex items-center justify-center ${verificationData.filesExist.email ? 'bg-indigo-50 text-indigo-600' : 'bg-gray-100 text-gray-400'}`}>
                                 <Mail className="w-4 h-4"/>
                             </div>
                             <div>
                                 <p className="text-sm font-bold text-gray-700">เมลอนุมัติ (Approval Email)</p>
                                 {!verificationData.filesExist.email && <span className="text-[10px] text-red-500 font-bold">* ไม่มีไฟล์แนบ</span>}
                                 {verificationData.filesExist.email && 
                                     <button 
                                         type="button"
                                         onClick={(e) => {
                                             e.preventDefault();
                                             const req = requests.find(r => r.id === verificationData.requestId);
                                             handleViewFile(req?.attachment, 'Approval Email');
                                         }}
                                         className="text-[10px] text-indigo-600 hover:underline flex items-center gap-1"
                                     >
                                         <Eye className="w-3 h-3"/> ดูไฟล์
                                     </button>
                                 }
                             </div>
                         </div>
                         <label className={`cursor-pointer px-3 py-1.5 rounded-lg border text-xs font-bold transition-all flex items-center gap-1.5 ${verificationData.checks.email ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-red-300 text-red-600 shadow-sm'}`}>
                             <input 
                                 type="checkbox" className="hidden"
                                 checked={verificationData.checks.email} 
                                 onChange={() => handleChecklistChange('email')} 
                             />
                             {verificationData.checks.email 
                                 ? (verificationData.filesExist.email ? <><CheckCircle className="w-3 h-3"/> ถูกต้อง</> : <><CheckSquare className="w-3 h-3"/> ยกเว้นให้ (Waive)</>)
                                 : (verificationData.filesExist.email ? 'ไม่ถูกต้อง' : 'จำเป็นต้องมี')
                             }
                         </label>
                     </div>

                     {/* Details Check */}
                     <div className={`p-3 rounded-xl border shadow-sm flex items-center justify-between transition-colors ${verificationData.checks.details ? 'bg-white border-gray-200' : 'bg-red-50 border-red-200'}`}>
                         <div className="flex items-center gap-3">
                             <div className="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
                                 <List className="w-4 h-4"/>
                             </div>
                             <p className="text-sm font-bold text-gray-700">รายละเอียดครบถ้วน (Details)</p>
                         </div>
                         <label className={`cursor-pointer px-3 py-1.5 rounded-lg border text-xs font-bold transition-all flex items-center gap-1.5 ${verificationData.checks.details ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-red-300 text-red-600 shadow-sm'}`}>
                             <input 
                                 type="checkbox" className="hidden"
                                 checked={verificationData.checks.details} 
                                 onChange={() => handleChecklistChange('details')} 
                             />
                             {verificationData.checks.details 
                                 ? <><CheckCircle className="w-3 h-3"/> ถูกต้อง</>
                                 : 'ต้องแก้ไข (Revise)'
                             }
                         </label>
                     </div>
                 </div>

                 {/* Additional Options */}
                 <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm space-y-3">
                     
                     
{!verificationData.isChangeMode && !requests.find(r => r.id === verificationData.requestId)?.isPreviouslyApproved && (
    <label className={`flex items-start gap-3 cursor-pointer group ${!isVerificationPass() ? 'opacity-50 pointer-events-none' : ''}`}>
        <div className="pt-0.5 relative">
            <input 
                type="checkbox" 
                className="peer w-5 h-5 appearance-none border-2 border-gray-300 rounded checked:bg-blue-600 checked:border-blue-600 transition-colors"
                checked={verificationData.needApproval}
                onChange={(e) => setVerificationData({...verificationData, needApproval: e.target.checked})}
            />
            <CheckCircle className="w-3.5 h-3.5 text-white absolute top-[3px] left-[3px] opacity-0 peer-checked:opacity-100 pointer-events-none"/>
        </div>
        <div>
            <p className="text-sm font-bold text-gray-800 group-hover:text-blue-700 transition-colors">
                ต้องขออนุมัติจาก Level 1/Level 2 เพิ่มเติม (Full Flow)
            </p>
            <p className="text-xs text-gray-500">สำหรับเคสต้องการหลักฐานเพิ่มเติม</p>
        </div>
    </label>
)}
                     {/* Contract Option (Only for Rent) */}
                     {requests.find(r => r.id === verificationData.requestId)?.purchaseType === 'Rent' && (
                         <>
                             <hr className="border-gray-100"/>
                             <label className={`flex items-start gap-3 cursor-pointer group ${!isVerificationPass() ? 'opacity-50 pointer-events-none' : ''}`}>
                                 <div className="pt-0.5 relative">
                                     <input 
                                         type="checkbox" 
                                         className="peer w-5 h-5 appearance-none border-2 border-gray-300 rounded checked:bg-blue-600 checked:border-blue-600 transition-colors"
                                         checked={verificationData.needContract}
                                         onChange={(e) => setVerificationData({...verificationData, needContract: e.target.checked})}
                                     />
                                     <CheckCircle className="w-3.5 h-3.5 text-white absolute top-[3px] left-[3px] opacity-0 peer-checked:opacity-100 pointer-events-none"/>
                                 </div>
                                 <div>
                                     <p className="text-sm font-bold text-gray-800 group-hover:text-blue-700 transition-colors">
                                         ต้องทำสัญญาเช่า (Require Contract)
                                     </p>
                                     <p className="text-xs text-gray-500">ถ้าเลือก: จะมีขั้นตอนอัปเดตสัญญา, ถ้าไม่เลือก: ข้ามไปขั้นตอนส่งมอบ</p>
                                 </div>
                             </label>
                         </>
                     )}
                 </div>

                 {/* Note */}
                 <div>
                     <label className="text-xs font-bold text-gray-500 mb-1.5 block">หมายเหตุเพิ่มเติม (Note)</label>
                     <textarea 
                        className="w-full p-3 text-sm border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all shadow-sm bg-white" 
                        rows="3"
                        placeholder="ระบุรายละเอียด..."
                        value={verificationData.note}
                        onChange={e => setVerificationData({...verificationData, note: e.target.value})}
                     ></textarea>
                 </div>
             </div>

             {/* --- FOOTER ACTION --- */}
             <div className="p-5 border-t border-gray-100 bg-white">
                 <button 
                     onClick={handleConfirmVerification} 
                     className={`w-full py-3.5 rounded-xl text-white font-bold shadow-lg flex items-center justify-center gap-2 transition-all transform hover:scale-[1.01] ${
                         !isVerificationPass() 
                         ? 'bg-red-500 hover:bg-red-600 shadow-red-200' // Fail
                         : verificationData.needApproval
                             ? 'bg-orange-500 hover:bg-orange-600 shadow-orange-200' // Pass & Forward
                             : 'bg-green-600 hover:bg-green-700 shadow-green-200' // Pass & Approve
                     }`}
                 >
                     {!isVerificationPass() ? (
                         <><RotateCcw className="w-5 h-5"/> ส่งคืนแก้ไข (Return)</>
                     ) : verificationData.needApproval ? (
                         <><ArrowUpRight className="w-5 h-5"/> ส่งต่ออนุมัติ (Forward)</>
                     ) : (
                         <><CheckCircle className="w-5 h-5"/> ดำเนินการต่อ (Pass)</>
                     )}
                 </button>
             </div>
          </div>
        </div>
      )}

{showReceiveGoodsModal && selectedRequest && (
  <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[80] p-4 backdrop-blur-sm animate-in fade-in">
    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[95vh] flex flex-col overflow-hidden">
      
      {/* Data Lists */}
      <datalist id="inventory-list">{inventory.map((inv, i) => <option key={i} value={inv.name} />)}</datalist>
      <datalist id="asset-list">{[...new Set(assets.map(a => a.name))].map((name, i) => <option key={i} value={name} />)}</datalist>

      {/* HEADER */}
      <div className="px-6 py-4 border-b flex justify-between items-center bg-white">
          <div>
              <h3 className="font-bold text-lg text-teal-700 flex items-center gap-2">
                  <Download className="w-5 h-5"/> บันทึกรับของ (Receive Goods)
              </h3>
              <p className="text-xs text-gray-500">รายการจากเอกสาร {selectedRequest.id}</p>
          </div>
          <button onClick={() => setShowReceiveGoodsModal(false)} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors">
              <X className="w-6 h-6"/>
          </button>
      </div>

      {/* BODY */}
      <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
          <div className="space-y-6">
          
          {receiveItems.map((item, idx) => (
              <div key={idx} className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                  
                  {/* Row 1: Header Item & Qty */}
                  <div className="flex flex-wrap md:flex-nowrap gap-4 mb-4 pb-4 border-b border-dashed border-gray-200">
                      <div className="flex-1 min-w-[250px]">
                          <label className="text-xs text-gray-500 font-bold mb-1 block">ชื่อรายการ (Item Name)</label>
                          {item.targetType === 'Inventory' ? (
                              <div className="relative">
                                  <input 
    type="text" 
    list="inventory-list" 
    className="w-full p-2 border border-gray-300 rounded-lg text-sm font-bold text-gray-800 focus:ring-2 focus:ring-blue-500 outline-none" 
    value={item.name} 
    onChange={(e) => { 
        const val = e.target.value;
        const n = [...receiveItems];
        n[idx].name = val; 

        // ⭐⭐ [เพิ่มใหม่] Logic: เช็คชื่อสินค้าเพื่อดึงรหัสวัสดุอัตโนมัติ ⭐⭐
        if (item.targetType === 'Inventory') {
            // ค้นหาว่ามีชื่อนี้ในโครงการนี้หรือไม่
            const existingInv = inventory.find(inv => inv.name === val && inv.project === selectedRequest.job);
            
            if (existingInv) {
                // ✅ เจอของเดิม: ดึงรหัสมาใส่ + ปลดติ๊ก Auto
                n[idx].inventoryId = existingInv.id;
                n[idx].isInvAutoId = false; 
            } else {
                // ❌ ไม่เจอ (ของใหม่): เคลียร์รหัส + ติ๊ก Auto (หรือจะปล่อยว่างให้กรอกเองก็ได้)
                // n[idx].inventoryId = ''; 
                // n[idx].isInvAutoId = true;
            }
        }

        setReceiveItems(n); 
    }} 
/>
                              </div>
                          ) : (
                              <div className="p-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-gray-600">
                                  {item.name} <span className="text-xs font-normal text-gray-400">(ระบุรายละเอียดรายชิ้นด้านล่าง)</span>
                              </div>
                          )}
                      </div>

                      <div className="flex gap-2">
                          <div className="w-20 text-center bg-gray-50 rounded-lg p-1 border">
                              <label className="text-[9px] text-gray-400 font-bold block">สั่ง (Order)</label>
                              <div className="text-sm font-bold text-gray-600">{item.orderedQty}</div>
                          </div>
                          <div className="w-20 text-center bg-green-50 rounded-lg p-1 border border-green-100">
                               <label className="text-[9px] text-green-600 font-bold block">รับแล้ว</label>
                               <div className="text-sm font-bold text-green-700">{item.receivedSoFar}</div>
                          </div>
                      </div>

                      <div className="w-32">
                          <label className="text-xs text-teal-700 font-bold mb-1 block">รับครั้งนี้ (Qty)</label>
                          <input 
                              type="number" min="0" max={Math.max(0, item.orderedQty - item.receivedSoFar)}
                              className="w-full p-2 border-2 border-teal-500 rounded-lg text-center font-bold text-teal-800 focus:ring-4 focus:ring-teal-100 outline-none text-lg" 
                              value={item.receivedQty} 
                              onChange={(e) => {
                                  const val = Math.min(Math.max(0, parseInt(e.target.value) || 0), item.orderedQty - item.receivedSoFar);
                                  const newItems = [...receiveItems];
                                  newItems[idx].receivedQty = val;
                                  // Re-generate asset rows
                                  if(item.targetType === 'Asset') {
                                      const currentLen = newItems[idx].assetsToRegister.length;
                                      if(val > currentLen) {
                                          const addCount = val - currentLen;
                                          const newRows = Array.from({length: addCount}, () => ({ 
                                              id: '', isAutoId: false, serial: '', name: item.name, note: '', images: [],
                                              rentalStart: '', rentalEnd: '', rentalPrice: item.isRent ? item.actualPrice : 0, rentalUnit: 'Month', price: item.actualPrice
                                          }));
                                          newItems[idx].assetsToRegister = [...newItems[idx].assetsToRegister, ...newRows];
                                      }
                                  }
                                  setReceiveItems(newItems);
                              }}
                          />
                      </div>
                  </div>

         {/* --- Row 2: Inventory Details (Code / Price / Unit) --- */}
<div className="flex flex-col md:flex-row gap-4 mb-4 items-end">
    
    {/* 1. รหัสวัสดุ */}
    {item.targetType === 'Inventory' && (
        <div className="w-full md:w-1/3">
            <div className="flex justify-between items-center mb-1">
                <label className="text-xs text-gray-500 font-bold">รหัสวัสดุ (Material Code)</label>
                <label className="flex items-center gap-1 cursor-pointer">
                    <input 
                        type="checkbox" 
                        className="w-3 h-3 accent-teal-600"
                        checked={item.isInvAutoId}
                        onChange={(e) => {
                            const n = [...receiveItems];
                            n[idx].isInvAutoId = e.target.checked;
                            if(e.target.checked) n[idx].inventoryId = '';
                            setReceiveItems(n);
                        }}
                    />
                    <span className="text-[10px] text-teal-600 font-bold">Auto Gen No.</span>
                </label>
            </div>
            <input 
                type="text" 
                className={`w-full p-2 border border-gray-300 rounded-lg text-sm font-mono ${item.isInvAutoId ? 'bg-gray-100 text-gray-400' : 'bg-white text-gray-800 focus:ring-2 focus:ring-teal-500'}`}
                placeholder={item.isInvAutoId ? "ระบบสร้างอัตโนมัติ (INV-xxx)" : "ระบุรหัสวัสดุ..."}
                value={item.inventoryId}
                disabled={item.isInvAutoId}
                onChange={(e) => {
                    const n = [...receiveItems];
                    n[idx].inventoryId = e.target.value;
                    setReceiveItems(n);
                }}
            />
        </div>
    )}

    {/* 2. ราคาจริง (Actual Price) */}
    {item.targetType === 'Inventory' ? (
        <div className="w-full md:w-1/4">
            <label className="text-xs text-gray-500 font-bold mb-1 block">ราคาจริงต่อหน่วย</label>
            <input type="number" className="w-full p-2 border border-gray-300 rounded-lg text-sm" value={item.actualPrice} onChange={(e) => { const n = [...receiveItems]; n[idx].actualPrice = parseFloat(e.target.value) || 0; setReceiveItems(n); }} />
        </div>
    ) : null}

  {/* 3. หน่วยนับ (Unit) - เปลี่ยนเป็น Dropdown สำหรับ Inventory */}
    {item.targetType === 'Inventory' ? (
        <div className="w-full md:w-1/4">
            <label className="text-xs text-gray-500 font-bold mb-1 block">หน่วยนับ</label>
            <select 
                className="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-teal-500" 
                value={item.unit} 
                onChange={(e) => { 
                    const n = [...receiveItems]; 
                    n[idx].unit = e.target.value; 
                    setReceiveItems(n); 
                }} 
            >
                {ITEM_UNITS.map(u => (
                    <option key={u} value={u}>{u}</option>
                ))}
            </select>
        </div>
    ) : null}
    
    {/* 4. ปุ่มเลือก Target Type */}
    <div className="w-full md:w-1/3">
        <label className="text-xs text-gray-500 font-bold mb-1 block">จัดเก็บเข้า (Target Storage)</label>
        <div className="flex bg-gray-100 p-1 rounded-lg border border-gray-200">
            <button onClick={() => { const n = [...receiveItems]; n[idx].targetType = 'Inventory'; setReceiveItems(n); }} className={`flex-1 py-2 text-sm rounded-md transition-all flex items-center justify-center gap-2 ${item.targetType === 'Inventory' ? 'bg-white shadow-sm text-blue-700 font-bold' : 'text-gray-500 hover:text-gray-700'}`}>
                <Box className="w-4 h-4"/> เข้าคลังสินค้า
            </button>
            <button onClick={() => { const n = [...receiveItems]; n[idx].targetType = 'Asset'; setReceiveItems(n); }} className={`flex-1 py-2 text-sm rounded-md transition-all flex items-center justify-center gap-2 ${item.targetType === 'Asset' ? 'bg-white shadow-sm text-indigo-700 font-bold' : 'text-gray-500 hover:text-gray-700'}`}>
                <Monitor className="w-4 h-4"/> ลงทะเบียนทรัพย์สิน
            </button>
        </div>
    </div>
</div>

                  
                  {/* Row 3: Image (For Inventory) - ⭐ Updated Grid Preview */}
                  {item.targetType === 'Inventory' && (
                      <div className="mb-2">
                           <label className="text-xs text-gray-500 font-bold mb-1 flex items-center gap-1"><ImageIcon className="w-3 h-3"/> รูปภาพสินค้า (สำหรับ Stock) - เลือกได้หลายรูป</label>
                           
                           <div className="flex flex-col gap-2">
                               {/* ปุ่มเลือกรูป */}
                               <label className="cursor-pointer bg-gray-50 text-gray-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-gray-100 border border-gray-300 flex items-center gap-2 transition-colors w-fit">
                                   <Camera className="w-4 h-4"/> เพิ่มรูปภาพ
                                   <input type="file" multiple className="hidden" onChange={(e) => handleReceiveImageSelect(e, idx)}/>
                               </label>
                               
                               {/* ตารางแสดงรูป (Preview Grid) */}
                               {item.receiveImages && item.receiveImages.length > 0 && (
                                   <div className="grid grid-cols-4 md:grid-cols-6 gap-2">
                                       {item.receiveImages.map((img, imgI) => (
                                           <div key={imgI} className="relative group w-full h-20 bg-gray-100 rounded border overflow-hidden">
                                               <img src={img.base64} className="w-full h-full object-cover" />
                                               <button onClick={() => handleRemoveReceiveImage(idx, imgI)} className="absolute top-0 right-0 bg-red-500 text-white p-0.5 rounded-bl opacity-0 group-hover:opacity-100 transition-all hover:scale-110" title="ลบรูป">
                                                   <X size={12} strokeWidth={3}/>
                                               </button>
                                           </div>
                                       ))}
                                   </div>
                               )}
                           </div>
                      </div>
                  )}

                  {/* Row 4: Asset Registration Table (Detailed) */}
                  {item.targetType === 'Asset' && item.receivedQty > 0 && (
                      <div className="mt-6 border rounded-xl overflow-hidden animate-in fade-in slide-in-from-top-2 shadow-sm">
                          <div className="bg-indigo-50 px-4 py-3 border-b border-indigo-100 flex justify-between items-center">
                              <p className="text-sm font-bold text-indigo-800 flex items-center gap-2"><List className="w-4 h-4"/> รายละเอียดทรัพย์สิน ({item.receivedQty} รายการ)</p>
                              {item.isRent && <span className="text-[10px] bg-white text-orange-700 px-2 py-0.5 rounded-full border border-orange-200 shadow-sm">รายการเช่า (Rent)</span>}
                          </div>
                          
                          <div className="bg-slate-50 p-4 space-y-4">
                              {item.assetsToRegister.slice(0, item.receivedQty).map((assetReg, assetIdx) => (
                                  <div key={assetIdx} className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm relative group">
                                      <div className="absolute -left-2 top-4 w-6 h-6 bg-indigo-600 text-white rounded-full flex items-center justify-center text-xs font-bold shadow-sm z-10">{assetIdx + 1}</div>
                                      
                                      <div className="ml-3 grid grid-cols-1 md:grid-cols-12 gap-3">
                                          {/* Col 1: Asset ID (+ Auto Gen Checkbox) */}
                                          <div className="md:col-span-4">
                                              <div className="flex justify-between items-center mb-1">
                                                  <label className="text-[10px] font-bold text-gray-400">รหัสทรัพย์สิน (Asset ID)</label>
                                                  <label className="flex items-center gap-1 cursor-pointer">
                                                      <input type="checkbox" className="w-3 h-3 accent-indigo-600" checked={assetReg.isAutoId} 
                                                          onChange={(e) => {
                                                              const n = [...receiveItems];
                                                              n[idx].assetsToRegister[assetIdx].isAutoId = e.target.checked;
                                                              if(e.target.checked) n[idx].assetsToRegister[assetIdx].id = ''; 
                                                              setReceiveItems(n);
                                                          }} 
                                                      />
                                                      <span className="text-[9px] text-indigo-600 font-bold">ไม่มีเลข/Auto Gen</span>
                                                  </label>
                                              </div>
                                              <input 
                                                  type="text" 
                                                  className={`w-full border border-gray-300 rounded px-2 py-1.5 text-sm font-mono ${assetReg.isAutoId ? 'bg-gray-100 text-gray-400' : 'focus:ring-1 focus:ring-indigo-500'}`}
                                                  placeholder={assetReg.isAutoId ? "ระบบจะสร้างให้อัตโนมัติ" : `AST-...-${assetIdx+1}`}
                                                  value={assetReg.id}
                                                  disabled={assetReg.isAutoId}
                                                  onChange={(e) => {
                                                      const n = [...receiveItems];
                                                      n[idx].assetsToRegister[assetIdx].id = e.target.value;
                                                      setReceiveItems(n);
                                                  }}
                                              />
                                          </div>

                                          {/* Col 2: Name (Editable) */}
                                          <div className="md:col-span-4">
                                              <label className="text-[10px] font-bold text-gray-400 block mb-1">ชื่อเรียก (Name)</label>
                                              <div className="relative">
                                                  <input type="text" list="asset-list" className="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-1 focus:ring-indigo-500" value={assetReg.name} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].name = e.target.value; setReceiveItems(n); }} />
                                              </div>
                                          </div>

                                          {/* Col 3: Serial Number */}
                                          <div className="md:col-span-4">
                                              <label className="text-[10px] font-bold text-gray-400 block mb-1">Serial Number (S/N)</label>
                                              <input type="text" className="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-1 focus:ring-indigo-500" placeholder="ระบุ S/N..." value={assetReg.serial} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].serial = e.target.value; setReceiveItems(n); }} />
                                          </div>
                                          
{item.isRent ? (
                                              <div className="md:col-span-12 grid grid-cols-4 gap-3 bg-orange-50 p-2 rounded border border-orange-100">
                                                  <div>
                                                      <label className="text-[9px] text-orange-800 font-bold">เริ่มสัญญา</label>
                                                      <input type="date" className="w-full bg-white border border-orange-200 rounded px-2 py-1 text-xs" value={assetReg.rentalStart} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].rentalStart = e.target.value; setReceiveItems(n); }} />
                                                  </div>
                                                  <div>
                                                      <label className="text-[9px] text-orange-800 font-bold">สิ้นสุด</label>
                                                      <input type="date" className="w-full bg-white border border-orange-200 rounded px-2 py-1 text-xs" value={assetReg.rentalEnd} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].rentalEnd = e.target.value; setReceiveItems(n); }} />
                                                  </div>
                                                  
                                                  {/* ⭐ ส่วนแสดง ราคา / หน่วย / ระยะเวลา */}
                                                  <div className="col-span-2 flex gap-2">
                                                      <div className="flex-1">
                                                          <label className="text-[9px] text-orange-800 font-bold">ค่าเช่า</label>
                                                          <input type="number" className="w-full bg-white border border-orange-200 rounded px-2 py-1 text-xs" value={assetReg.rentalPrice} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].rentalPrice = parseFloat(e.target.value); setReceiveItems(n); }} />
                                                      </div>
                                                      <div className="flex-1">
                                                          <label className="text-[9px] text-orange-800 font-bold">หน่วย</label>
                                                          <select className="w-full bg-white border border-orange-200 rounded px-2 py-1 text-xs" value={assetReg.rentalUnit} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].rentalUnit = e.target.value; setReceiveItems(n); }}>
                                                             <option value="Day">บาท/วัน</option>
                                                             <option value="Month">บาท/เดือน</option>
                                                             <option value="Year">บาท/ปี</option>
                                                          </select>
                                                      </div>
                                                      
                                                      {/* ⭐ เพิ่มช่องระยะเวลา (Duration) ตรงนี้ */}
                                                      <div className="flex-1">
                                                          <label className="text-[9px] text-orange-800 font-bold">ระยะเวลา</label>
                                                          <input 
                                                              type="number" min="1"
                                                              className="w-full bg-white border border-orange-200 rounded px-2 py-1 text-xs text-center font-bold text-indigo-700" 
                                                              value={assetReg.duration !== undefined ? assetReg.duration : (item.duration || 1)} 
                                                              onChange={(e) => { 
                                                                  const n = [...receiveItems]; 
                                                                  n[idx].assetsToRegister[assetIdx].duration = parseFloat(e.target.value) || 1; 
                                                                  setReceiveItems(n); 
                                                              }} 
                                                          />
                                                      </div>
                                                  </div>
                                              </div>
                                         ) : (
                                              /* For Buy: Show Price & Unit Fields */
                                              <div className="md:col-span-4 grid grid-cols-2 gap-2">
                                                  {/* 1. ช่องราคา (Price) */}
                                                  <div>
                                                      <label className="text-[10px] font-bold text-gray-400 block mb-1">ราคา (Price)</label>
                                                      <input 
                                                          type="number" 
                                                          className="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-1 focus:ring-indigo-500" 
                                                          value={assetReg.price} 
                                                          onChange={(e) => { 
                                                              const n = [...receiveItems]; 
                                                              n[idx].assetsToRegister[assetIdx].price = parseFloat(e.target.value); 
                                                              setReceiveItems(n); 
                                                          }} 
                                                      />
                                                  </div>

                                                  {/* 2. ⭐ ช่องหน่วยนับ (Unit) - เปลี่ยนเป็น Dropdown (Select) ⭐ */}
                                                  <div>
                                                      <label className="text-[10px] font-bold text-gray-400 block mb-1">หน่วย (Unit)</label>
                                                      <select 
                                                          className="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-1 focus:ring-indigo-500 bg-white" 
                                                          value={assetReg.unit} 
                                                          onChange={(e) => { 
                                                              const n = [...receiveItems]; 
                                                              n[idx].assetsToRegister[assetIdx].unit = e.target.value; 
                                                              setReceiveItems(n); 
                                                          }} 
                                                      >
                                                          {/* วนลูปสร้างตัวเลือกจาก ITEM_UNITS */}
                                                          {ITEM_UNITS.map(u => (
                                                              <option key={u} value={u}>{u}</option>
                                                          ))}
                                                      </select>
                                                  </div>
                                              </div>
                                          )}

                                          {/* Note & Image (Updated Multiple) */}
                                          <div className={`${item.isRent ? 'md:col-span-8' : 'md:col-span-4'}`}>
                                              <label className="text-[10px] font-bold text-gray-400 block mb-1">หมายเหตุ (Note)</label>
                                              <input type="text" className="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-1 focus:ring-indigo-500" placeholder="สภาพ, สี, ตำหนิ..." value={assetReg.note} onChange={(e) => { const n = [...receiveItems]; n[idx].assetsToRegister[assetIdx].note = e.target.value; setReceiveItems(n); }} />
                                          </div>
                                          
                                          <div className="md:col-span-4">
                                          <label className="text-[10px] font-bold text-gray-400 block mb-1">รูปภาพ (Images)</label>
                                          
                                          <div className="flex flex-col gap-2">
                                              {/* ปุ่มเลือกรูป */}
                                              <label className="cursor-pointer bg-white border border-gray-300 text-gray-600 px-3 py-1 rounded text-xs hover:bg-gray-50 flex items-center justify-center gap-1 shadow-sm w-full">
                                                  <Camera className="w-3 h-3"/> เพิ่มรูป
                                                  <input type="file" multiple className="hidden" onChange={(e) => handleReceiveImageSelect(e, idx, assetIdx)}/>
                                              </label>

                                              {/* ตารางแสดงรูป (Preview Grid) */}
                                              {assetReg.images && assetReg.images.length > 0 && (
                                                  <div className="grid grid-cols-3 gap-1">
                                                      {assetReg.images.map((img, imgI) => (
                                                          <div key={imgI} className="relative group w-full h-12 bg-gray-100 rounded border overflow-hidden">
                                                              <img src={img.base64} className="w-full h-full object-cover"/>
                                                              <button onClick={() => handleRemoveReceiveImage(idx, imgI, assetIdx)} className="absolute top-0 right-0 bg-red-500 text-white p-0.5 rounded-bl opacity-0 group-hover:opacity-100 transition-all hover:scale-110" title="ลบรูป">
                                                                  <X size={10} strokeWidth={3}/>
                                                              </button>
                                                          </div>
                                                      ))}
                                                  </div>
                                              )}
                                          </div>
                                      </div>
                                      </div>
                                  </div>
                              ))}
                          </div>
                      </div>
                  )}
              </div>
          ))}
          </div>
      </div>

      {/* FOOTER */}
      <div className="p-5 border-t bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-10">
           {receiveItems.some(i => i.receivedQty < (i.qty - i.receivedSoFar)) && (
               <div className="mb-4 bg-orange-50 p-3 rounded-lg border border-orange-200 flex items-start gap-3">
                   <div className="pt-0.5"><input type="checkbox" className="w-4 h-4 text-orange-600 rounded focus:ring-orange-500 cursor-pointer" checked={isForceClose} onChange={(e) => setIsForceClose(e.target.checked)}/></div>
                   <div>
                       <label className="block text-sm font-bold text-orange-800 cursor-pointer" onClick={() => setIsForceClose(!isForceClose)}>ปิดงานเลยหรือไม่ (Force Close)</label>
                       <p className="text-xs text-orange-600 mt-1">กรณีของมาไม่ครบตามสั่ง แต่จะไม่รับส่วนที่เหลือแล้ว</p>
                   </div>
               </div>
           )}
           <div className="flex gap-3">
             <button onClick={() => setShowReceiveGoodsModal(false)} className="flex-1 py-3 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors">ยกเลิก</button>
             <button onClick={handleConfirmReceive} className="flex-1 py-3 bg-teal-600 text-white rounded-xl font-bold hover:bg-teal-700 shadow-md shadow-teal-200 transition-all transform hover:scale-[1.01]">ยืนยันรับของเข้าคลัง</button>
           </div>
       </div>
    </div>
  </div>
)}


{showAddInvModal && (
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm animate-in fade-in">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <datalist id="existing-inventory">
                {[...new Set(inventory.map(i => i.name))].map((name, i) => (
                    <option key={i} value={name}/>
                ))}
            </datalist>
                
                {/* Header */}
                <div className="px-6 py-4 border-b bg-green-50 flex justify-between items-center sticky top-0 z-10">
                    <h3 className="font-bold text-lg text-green-800 flex items-center gap-2"><Plus className="w-5 h-5"/> เพิ่มสินค้าใหม่ (Inventory)</h3>
                    <button onClick={() => setShowAddInvModal(false)} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-green-100 transition-colors">
                        <X className="w-6 h-6"/>
                    </button>
                </div>

                <div className="p-6 overflow-y-auto bg-slate-50 space-y-5">

                {/* Project Selection */}
                    <div>
                        <label className="block text-sm font-bold text-gray-700 mb-1.5">โครงการ (Project)</label>
                        <select 
    className="w-full p-2.5 border rounded-xl text-sm bg-white" 
    value={newStockItem.project || ''} 
    onChange={e => setNewStockItem({...newStockItem, project: e.target.value})}
>
    <option value="">-- ไม่ระบุ --</option>
    {/* ⭐ กรองเฉพาะโครงการที่มีสิทธิ์ "เพิ่มสินค้า (16)" */}
    {projects.filter(p => hasPermission(16, p.name)).map(p => (
        <option key={p.id} value={p.name}>{p.name}</option>
    ))}
</select>
                    </div>
                    
                    {/* ⭐ เพิ่มส่วนเลือกประเภท (Type Selection) */}
                    <div className="bg-white p-1 rounded-xl border border-gray-200 flex shadow-sm">
                        <button 
                            onClick={() => setNewStockItem({...newStockItem, stockType: 'System'})} 
                            className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${(!newStockItem.stockType || newStockItem.stockType === 'System') ? 'bg-blue-50 text-blue-700 shadow-sm border border-blue-100' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'}`}
                        >
                            ของในระบบ
                        </button>
                        <button 
                            onClick={() => setNewStockItem({...newStockItem, stockType: 'NonSystem'})} 
                            className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${newStockItem.stockType === 'NonSystem' ? 'bg-orange-50 text-orange-700 shadow-sm border border-orange-100' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'}`}
                        >
                            ของนอกระบบ
                        </button>
                    </div>




{/* ⭐⭐ [1] เพิ่ม: ช่องกรอกรหัสสินค้า (ID + Auto Gen) ⭐⭐ */}
<div className="flex flex-col gap-1 mb-2">
    <div className="flex justify-between items-center">
        <label className="text-sm font-bold text-gray-700">รหัสวัสดุ (Material Code)</label>
        <label className="flex items-center gap-1.5 cursor-pointer bg-green-50 px-2 py-0.5 rounded border border-green-100">
            <input 
                type="checkbox" 
                className="accent-green-600 w-3.5 h-3.5" 
                checked={newStockItem.isAutoId} 
                onChange={(e) => {
                    // ถ้าติ๊ก Auto ให้เคลียร์ค่า, ถ้าปลด ให้คงค่าเดิมไว้แก้ไข
                    setNewStockItem({...newStockItem, isAutoId: e.target.checked, id: e.target.checked ? '' : newStockItem.id});
                }}
            />
            <span className="text-xs font-bold text-green-700">Auto Gen</span>
        </label>
    </div>
    <input 
        type="text" 
        className={`w-full p-2.5 border rounded-xl text-sm font-mono ${newStockItem.isAutoId ? 'bg-gray-100 text-gray-400' : 'bg-white text-gray-800 focus:ring-2 focus:ring-green-500'}`}
        placeholder={newStockItem.isAutoId ? "ระบบจะสร้างรหัสให้อัตโนมัติ (INV-xxx)" : "ระบุรหัสสินค้า..."} 
        value={newStockItem.id} 
        disabled={newStockItem.isAutoId}
        onChange={e => setNewStockItem({...newStockItem, id: e.target.value})} 
    />
</div>

{/* ⭐⭐ [2] แก้ไข: ช่องชื่อสินค้า (Name) ให้ดึงรหัสเดิมอัตโนมัติ ⭐⭐ */}
<div>
    <label className="block text-sm font-bold text-gray-700 mb-1.5">ชื่อสินค้า</label>
    <input 
        type="text" 
        list="existing-inventory"
        className="w-full p-2.5 border rounded-xl text-sm focus:ring-2 focus:ring-green-500 outline-none" 
        value={newStockItem.name} 
        onChange={e => {
    const val = e.target.value;
    let updates = { name: val };
    
    // Check Existing
    if (newStockItem.project) {
        const existing = inventory.find(i => i.name === val && i.project === newStockItem.project);
        if (existing) {
            // ⭐ แก้ไข: ดึงเฉพาะรหัสสั้นมาใส่ในช่อง
            updates.id = getDisplayId(existing.id); 
            updates.isAutoId = false;
            updates.unit = existing.unit;
            updates.price = existing.price;
        }
    }
    
    setNewStockItem(prev => ({...prev, ...updates}));
}}
        placeholder="ระบุชื่อสินค้า..." 
        autoFocus
    />
</div>


                    {/* Qty & Unit */}
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1.5">จำนวนเริ่มต้น</label>
                            <input type="number" min="0" className="w-full p-2.5 border rounded-xl text-sm" value={newStockItem.qty} onChange={e => setNewStockItem({...newStockItem, qty: parseInt(e.target.value)||0})}/>
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1.5">หน่วยนับ</label>
                            <select className="w-full p-2.5 border rounded-xl text-sm bg-white" value={newStockItem.unit} onChange={e => setNewStockItem({...newStockItem, unit: e.target.value})}>
                                {ITEM_UNITS.map(u => <option key={u} value={u}>{u}</option>)}
                            </select>
                        </div>
                    </div>

                    {/* Min Stock & Price */}
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1.5">Min Stock (จุดสั่งซื้อ)</label>
                            <input type="number" min="0" className="w-full p-2.5 border rounded-xl text-sm" value={newStockItem.minStock} onChange={e => setNewStockItem({...newStockItem, minStock: parseInt(e.target.value)||0})}/>
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1.5">ราคาต่อหน่วย (บาท)</label>
                            <input type="number" min="0" className="w-full p-2.5 border rounded-xl text-sm" value={newStockItem.price} onChange={e => setNewStockItem({...newStockItem, price: parseFloat(e.target.value)||0})}/>
                        </div>
                    </div>

                    {/* Image Upload */}
                    <div>
                        <label className="block text-sm font-bold text-gray-700 mb-1.5">รูปภาพ ({newStockItem.images ? newStockItem.images.length : 0})</label>
                        <label className="cursor-pointer flex items-center justify-center gap-2 w-full p-3 border border-dashed border-green-300 rounded-xl bg-green-50 text-green-700 text-sm font-bold hover:bg-green-100 transition-colors">
                            <Camera className="w-4 h-4"/> เลือกรูปสินค้า
                            <input type="file" multiple className="hidden" onChange={handleStockImageSelect}/>
                        </label>
                    </div>

                    {/* Image Preview Grid */}
                    {newStockItem.images && newStockItem.images.length > 0 && (
                        <div className="grid grid-cols-4 gap-2">
                            {newStockItem.images.map((img, idx) => (
                                <div key={idx} className="relative group w-full h-20 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden">
                                    <img src={img.base64} alt="preview" className="w-full h-full object-cover" />
                                    {/* ปุ่มลบ */}
                                    <button 
                                        onClick={() => handleRemoveStockImage(idx)}
                                        className="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md opacity-0 group-hover:opacity-100 transition-all hover:bg-red-600 hover:scale-110"
                                        title="ลบรูป"
                                    >
                                        <X size={14} strokeWidth={3}/>
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Note */}
                    <div>
                         <label className="block text-sm font-bold text-gray-700 mb-1.5">หมายเหตุ</label>
                         <textarea className="w-full p-2.5 border rounded-xl text-sm" rows="2" placeholder="รายละเอียดเพิ่มเติม..." value={newStockItem.note || ''} onChange={e => setNewStockItem({...newStockItem, note: e.target.value})}></textarea>
                    </div>

                </div>

                {/* Footer Buttons */}
                <div className="p-5 border-t border-gray-100 bg-white flex gap-3">
                    <button 
                        onClick={() => setShowAddInvModal(false)} 
                        className="flex-1 py-3 border border-gray-300 rounded-xl text-gray-600 font-bold hover:bg-gray-50 transition-colors"
                    >
                        ยกเลิก
                    </button>
                    <button 
    onClick={() => {
        // 1. ตรวจสอบข้อมูลพื้นฐาน (ปรับให้ตรงกับฟิลด์ที่มี)
        if (!newStockItem.name || !newStockItem.unit) {
            showToast('กรุณากรอกข้อมูลให้ครบถ้วน (ชื่อ, หน่วยนับ)', 'error');
            return;
        }

        // ⭐ 2. เพิ่มการตรวจสอบ "โครงการ"
        if (!newStockItem.project) {
            showToast('กรุณาเลือกโครงการ (Project)', 'error');
            return;
        }

        // 3. ผ่านแล้วค่อยบันทึก
        handleAddNewProduct();
    }} 
    className="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95"
>
    <Save className="w-5 h-5"/> บันทึกสินค้า
</button>
                </div>
            </div>
        </div>
      )}


{showAssetModal && (
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm animate-in fade-in">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                
                <datalist id="existing-assets">{[...new Set(assets.map(a => a.name))].map((name, i) => <option key={i} value={name}/>)}</datalist>
                {/* ⭐ เพิ่ม Datalist สำหรับรายชื่อผู้ใช้ */}
                <datalist id="user-list-options">
                    {allUsers.map((u, i) => (
                        <option key={i} value={`${u.firstName} ${u.lastName}`}>{u.empId}</option>
                    ))}
                </datalist>

                {/* Header */}
                <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                    <h3 className="font-bold text-lg text-indigo-800 flex items-center gap-2"><Plus className="w-5 h-5"/> เพิ่มทรัพย์สินใหม่</h3>
                    <button type="button" onClick={() => setShowAssetModal(false)} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100" title="ปิดหน้าต่าง">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                
                <div className="p-6 overflow-y-auto bg-slate-50 space-y-5">
{/* Project Selection */}
                    <div>
                        <label className="block text-sm font-bold text-gray-700 mb-1.5">โครงการ (Project)</label>
                        <select 
    className="w-full p-2.5 border rounded-xl text-sm bg-white" 
    value={newAssetItem.project || ''} 
    onChange={e => setNewAssetItem({...newAssetItem, project: e.target.value})}
>
    <option value="">-- ไม่ระบุ --</option>
    {/* ⭐ กรองเฉพาะโครงการที่มีสิทธิ์ "เพิ่มทรัพย์สิน (19)" */}
    {projects.filter(p => hasPermission(19, p.name)).map(p => (
        <option key={p.id} value={p.name}>{p.name}</option>
    ))}
</select>
                    </div>

                    {/* Owner Type */}
                    <div className="bg-white p-1 rounded-lg border border-gray-200 flex shadow-sm">
                        <button onClick={() => setNewAssetItem({...newAssetItem, ownerType: 'Company'})} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${newAssetItem.ownerType === 'Company' ? 'bg-indigo-50 text-indigo-700 shadow-sm' : 'text-gray-500'}`}>ทรัพย์สินบริษัท</button>
                        <button onClick={() => setNewAssetItem({...newAssetItem, ownerType: 'Rent'})} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${newAssetItem.ownerType === 'Rent' ? 'bg-orange-50 text-orange-700 shadow-sm' : 'text-gray-500'}`}>ทรัพย์สินเช่า</button>
                    </div>

                    {/* ID */}
                    <div>
                        <div className="flex justify-between items-center mb-1.5">
                            <label className="text-sm font-bold text-gray-700">รหัสทรัพย์สิน (Asset ID)</label>
                            <label className="flex items-center gap-1.5 cursor-pointer bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100"><input type="checkbox" className="accent-indigo-600 w-3.5 h-3.5" checked={newAssetItem.isAutoId} onChange={(e) => setNewAssetItem({...newAssetItem, isAutoId: e.target.checked, id: e.target.checked ? '' : newAssetItem.id})}/><span className="text-xs font-bold text-indigo-700">Auto Gen</span></label>
                        </div>
                        <input type="text" className="w-full p-2.5 border rounded-xl font-mono text-sm" placeholder={newAssetItem.isAutoId ? "Auto Gen..." : "ระบุรหัส เช่น AST-001"} value={newAssetItem.id} disabled={newAssetItem.isAutoId} onChange={e => setNewAssetItem({...newAssetItem, id: e.target.value})} />
                    </div>

                    {/* Name & Serial */}
                    <div className="space-y-3">
                        <div><label className="block text-sm font-bold text-gray-700 mb-1.5">ชื่อรายการ (Name)</label><input type="text" list="existing-assets" className="w-full p-2.5 border rounded-xl text-sm" placeholder="ระบุชื่อทรัพย์สิน..." value={newAssetItem.name} onChange={e => setNewAssetItem({...newAssetItem, name: e.target.value})}/></div>
                        <div><label className="block text-sm font-bold text-gray-700 mb-1.5">Serial Number (S/N)</label><input type="text" className="w-full p-2.5 border rounded-xl text-sm" value={newAssetItem.serial} onChange={e => setNewAssetItem({...newAssetItem, serial: e.target.value})}/></div>
                    </div>

                    {/* Price & Rent Details */}
                    <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                        {newAssetItem.ownerType === 'Company' ? (
                            <div><label className="block text-sm font-bold text-gray-700 mb-1.5">ราคาซื้อ</label><input type="number" className="w-full p-2.5 border rounded-xl text-sm" value={newAssetItem.price} onChange={e => setNewAssetItem({...newAssetItem, price: parseFloat(e.target.value)||0})}/></div>
                        ) : (
                            <>
                                <div className="grid grid-cols-2 gap-3 mb-3">
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1.5">ราคาเช่า</label><input type="number" className="w-full p-2.5 border rounded-xl text-sm" value={newAssetItem.rentalPrice} onChange={e => setNewAssetItem({...newAssetItem, rentalPrice: parseFloat(e.target.value)||0})}/></div>
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1.5">หน่วย</label><select className="w-full p-2.5 border rounded-xl text-sm bg-gray-50" value={newAssetItem.rentalUnit} onChange={e => setNewAssetItem({...newAssetItem, rentalUnit: e.target.value})}><option value="Day">บาท / วัน</option><option value="Month">บาท / เดือน</option><option value="Year">บาท / ปี</option></select></div>
                                </div>
                                <div className="grid grid-cols-2 gap-3 pt-3 border-t border-dashed">
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1.5">วันเริ่มสัญญา</label><input type="date" className="w-full p-2.5 border rounded-xl text-sm" value={newAssetItem.rentalStart || ''} onChange={e => setNewAssetItem({...newAssetItem, rentalStart: e.target.value})}/></div>
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1.5">วันสิ้นสุด</label><input type="date" className="w-full p-2.5 border rounded-xl text-sm" value={newAssetItem.rentalEnd || ''} onChange={e => setNewAssetItem({...newAssetItem, rentalEnd: e.target.value})}/></div>
                                </div>
                            </>
                        )}
                    </div>

                    {/* Status & Images */}
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1.5">สถานะ (Status)</label>
                            <select className="w-full p-2.5 border border-gray-300 rounded-xl text-sm bg-white" value={newAssetItem.status} onChange={e => setNewAssetItem({...newAssetItem, status: e.target.value})}>
                                <option value="Available">ว่าง (Available)</option>
                                <option value="Lost">สูญหาย (Lost)</option>
                                <option value="Damaged">ชำรุด (Damaged)</option>
                                <option value="Borrowed">ถูกยืม (Borrowed)</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1.5">รูปภาพ ({newAssetItem.images.length})</label>
                            <label className="cursor-pointer flex items-center justify-center gap-2 w-full p-2.5 border border-dashed border-indigo-300 rounded-xl bg-indigo-50 text-indigo-600 text-sm font-bold hover:bg-indigo-100 transition-colors">
                                <Camera className="w-4 h-4"/> เลือกรูป
                                <input type="file" multiple className="hidden" onChange={(e) => handleAssetImageSelect(e, false)}/>
                            </label>
                        </div>
                        
                        
                        {/* ⭐ Show Holder input only when 'Borrowed' */}
                        {newAssetItem.status === 'Borrowed' && (
                            <div className="col-span-2 animate-in fade-in slide-in-from-top-1">
                                <label className="block text-sm font-bold text-gray-700 mb-1.5">ชื่อผู้ยืม (Holder) <span className="text-red-500">*</span></label>
                                <input 
                                    type="text" 
                                    list="user-list-options" 
                                    className="w-full p-2.5 border border-orange-300 bg-orange-50 rounded-xl text-sm focus:ring-2 focus:ring-orange-500 text-orange-900 placeholder-orange-300" 
                                    placeholder="พิมพ์ชื่อเพื่อค้นหา หรือเลือกจากรายการ..." 
                                    value={newAssetItem.holder || ''} 
                                    onChange={e => setNewAssetItem({...newAssetItem, holder: e.target.value})}
                                    autoFocus
                                />
                                <p className="text-[10px] text-orange-600 mt-1">* ต้องเลือกชื่อที่มีในระบบเท่านั้น</p>
                            </div>
                        )}
                    </div>

                    {/* Image Previews */}
                    {newAssetItem.images.length > 0 && (
                        <div className="grid grid-cols-4 gap-2">
                            {newAssetItem.images.map((img, idx) => (
                                <div key={idx} className="relative group w-full h-20 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden">
                                    <img src={img.base64} alt="preview" className="w-full h-full object-cover" />
                                    <button 
                                        onClick={() => handleRemoveAssetImage(idx, false)}
                                        className="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md opacity-0 group-hover:opacity-100 transition-all hover:bg-red-600 hover:scale-110"
                                        title="ลบรูป"
                                    >
                                        <X size={14} strokeWidth={3}/>
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}

                    <div>
                         <label className="block text-sm font-bold text-gray-700 mb-1.5">หมายเหตุ</label>
                         <textarea className="w-full p-2.5 border rounded-xl text-sm" rows="2" value={newAssetItem.note} onChange={e => setNewAssetItem({...newAssetItem, note: e.target.value})}></textarea>
                    </div>
                </div>

                <div className="p-5 border-t border-gray-100 bg-white flex gap-3">
                    <button onClick={() => setShowAssetModal(false)} className="flex-1 py-3 border border-gray-300 rounded-xl text-gray-600 font-bold hover:bg-gray-50 transition-colors">ยกเลิก</button>
                    <button 
    onClick={() => {
        // 1. ตรวจสอบข้อมูลพื้นฐาน
        if (!newAssetItem.name) {
            showToast('กรุณาระบุชื่อทรัพย์สิน', 'error');
            return;
        }

        // ⭐ 2. เพิ่มการตรวจสอบ "โครงการ"
        if (!newAssetItem.project) {
            showToast('กรุณาเลือกโครงการ (Project)', 'error');
            return;
        }

        // 3. ผ่านแล้วค่อยบันทึก
        handleAddAsset();
    }} 
    className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95"
>
    <Save className="w-5 h-5"/> บันทึกข้อมูล
</button>
                </div>
            </div>
        </div>
      )}


{/* --- ITEM DETAIL & HISTORY MODAL (FIXED CLOSE BUTTON & REF LINK) --- */}
      {showItemDetailModal && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[150] p-4 backdrop-blur-sm animate-in fade-in">
             <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden animate-in zoom-in-95 relative">
                
                {/* --- HEADER (FIXED: Added Close Button) --- */}
                <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-20">
                    <div className="flex items-center gap-2">
                        <div className="bg-blue-50 p-2 rounded-lg text-blue-600">
                            <History className="w-5 h-5"/>
                        </div>
                        <h3 className="font-bold text-lg text-gray-800">
                            {viewingItem ? `รายละเอียดและประวัติ: ${viewingItem.name}` : `ประวัติการทำรายการรวม (All Logs)`}
                        </h3>
                    </div>
                    
                    {/* ⭐ ปุ่มปิดหน้าต่าง (Close Button) */}
                    <button 
                        onClick={() => setShowItemDetailModal(false)} 
                        className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
                        title="ปิดหน้าต่าง"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                
                <div id="history-modal-scroll" className="flex-1 overflow-y-auto bg-slate-50 scroll-smooth">
                    
{/* --- 1. ITEM DETAILS SECTION --- */}
                    {viewingItem && (
                        <div className="p-6 pb-0">
                            <div className="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm relative">
                                
                                {/* Action Buttons */}
 {/* Action Buttons (Updated Permissions) */}
<div className="absolute top-6 right-6 flex gap-2">
    
    {/* ⭐ เช็คสถานะการเลื่อน (Snoozed Check) */}
    {(() => {
        const isSnoozed = viewingItem.snoozeUntil && new Date(viewingItem.snoozeUntil) > new Date();
        
        return (
            <>
                {/* 1. กรณีมีการแจ้งเตือน (Overdue) -> แสดงปุ่ม เลื่อน (Snooze) และ ปิดถาวร (Disable) */}
                {viewingItem.isOverdue && viewingItem.alertType !== 'expired' && hasPermission(17) && (
                    <>
                        {/* ปุ่มเลื่อน 7 วัน */}
                        <button 
                            onClick={async () => {
                                setIsLoading(true);
                                try {
                                    const nextWeek = new Date();
                                    nextWeek.setDate(nextWeek.getDate() + 7);
                                    const snoozeDateStr = nextWeek.toISOString().split('T')[0];

                                    const updatedAsset = { ...viewingItem, snoozeUntil: snoozeDateStr };
                                    await new Promise(r => google.script.run.withSuccessHandler(r).syncAsset(updatedAsset));
                                    await addInvLog('Snooze Alert', updatedAsset.name, 'Update', `เลื่อนแจ้งเตือนถึง ${snoozeDateStr}`, [], null, updatedAsset.id);

                                    setAssets(prev => prev.map(a => a.id === updatedAsset.id ? { ...updatedAsset, alertType: null, isOverdue: false } : a));
                                    setViewingItem({ ...updatedAsset, alertType: null, isOverdue: false });
                                    showToast(`เลื่อนการแจ้งเตือน 7 วันเรียบร้อย`);
                                } catch (err) { console.error(err); showToast('Error: ' + err.message, 'error'); } finally { setIsLoading(false); }
                            }}
                            className="bg-orange-50 text-orange-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-orange-100 border border-orange-200 flex items-center gap-1 shadow-sm"
                            title="เลื่อนไปอีก 7 วัน"
                        >
                            <Clock className="w-3 h-3"/> เลื่อน 7 วัน
                        </button>

                        {/* ⭐ ปุ่มปิดแจ้งเตือน (ไม่ต้องแจ้งเตือน) */}
                        <button 
                            onClick={async () => {
                                if(!confirm('ยืนยัน "ปิดการแจ้งเตือน" สำหรับรายการนี้? \n(รายการจะไม่แสดงสถานะเตือนอีก จนกว่าจะมากดเปิดใหม่)')) return;
                                setIsLoading(true);
                                try {
                                    // ตั้งเวลาไปไกลมากๆ (ปี 9999) เท่ากับปิดถาวร
                                    const foreverDateStr = '9999-12-31';
                                    const updatedAsset = { ...viewingItem, snoozeUntil: foreverDateStr };
                                    
                                    await new Promise(r => google.script.run.withSuccessHandler(r).syncAsset(updatedAsset));
                                    await addInvLog('Disable Alert', updatedAsset.name, 'Update', `ปิดการแจ้งเตือนถาวร`, [], null, updatedAsset.id);

                                    setAssets(prev => prev.map(a => a.id === updatedAsset.id ? { ...updatedAsset, alertType: null, isOverdue: false } : a));
                                    setViewingItem({ ...updatedAsset, alertType: null, isOverdue: false });
                                    showToast(`ปิดการแจ้งเตือนเรียบร้อย`);
                                } catch (err) { console.error(err); showToast('Error: ' + err.message, 'error'); } finally { setIsLoading(false); }
                            }}
                            className="bg-gray-100 text-gray-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-gray-200 border border-gray-300 flex items-center gap-1 shadow-sm"
                            title="ไม่ต้องแจ้งเตือนอีก"
                        >
                            <BellOff className="w-3 h-3"/> ปิดแจ้งเตือน
                        </button>
                    </>
                )}


                {/* 2. ⭐ กรณีถูกเลื่อน/ปิดอยู่ (Snoozed) -> แสดงปุ่ม กลับมาแจ้งเตือน (Enable) */}
                {isSnoozed && hasPermission(17) && (
                    <button 
                        onClick={async () => {
                            if(!confirm('ต้องการ "เปิดการแจ้งเตือน" อีกครั้ง?')) return;
                            setIsLoading(true);
                            try {
                                // ลบค่า snoozeUntil ออก
                                const updatedAsset = { ...viewingItem, snoozeUntil: '' }; // ส่งค่าว่างไปลบ
                                
                                await new Promise(r => google.script.run.withSuccessHandler(r).syncAsset(updatedAsset));
                                await addInvLog('Enable Alert', updatedAsset.name, 'Update', `เปิดการแจ้งเตือนอีกครั้ง`, [], null, updatedAsset.id);

                                // คำนวณสถานะใหม่หน้าบ้านทันที (เพื่อให้ Alert เด้งขึ้นมาเลยถ้ามัน Overdue อยู่)
                                const today = new Date(); today.setHours(0,0,0,0);
                                let isNowOverdue = false;
                                if (updatedAsset.status === 'Borrowed' && updatedAsset.lastUpdated) {
                                    // Logic คำนวณวันเหมือนใน filteredAssets (Copy มาเพื่อให้แสดงผลทันที)
                                    // หมายเหตุ: ฟังก์ชัน parseThaiDate ต้องมีอยู่แล้วใน scope
                                    // ถ้าไม่มี ให้ใช้วิธีรีเฟรชหน้า handleRefresh() แทนได้
                                    const borrowDate = parseThaiDate(updatedAsset.lastUpdated);
                                    if (borrowDate) {
                                        const diff = Math.ceil(Math.abs(today - borrowDate) / (86400000));
                                        if (diff > 7) isNowOverdue = true;
                                    }
                                }

                                setAssets(prev => prev.map(a => a.id === updatedAsset.id ? { ...updatedAsset, snoozeUntil: '', isOverdue: isNowOverdue } : a));
                                setViewingItem({ ...updatedAsset, snoozeUntil: '', isOverdue: isNowOverdue });
                                
                                showToast(`เปิดการแจ้งเตือนเรียบร้อย`);
                            } catch (err) { console.error(err); showToast('Error: ' + err.message, 'error'); } finally { setIsLoading(false); }
                        }}
                        className="bg-purple-50 text-purple-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-purple-100 border border-purple-200 flex items-center gap-1 shadow-sm"
                    >
                        <Bell className="w-3 h-3"/> เปิดแจ้งเตือน
                    </button>
                )}
            </>
        );
    })()}
                                    
                                    {/* ปุ่มลบ: เช็คประเภทว่าเป็น Asset(21) หรือ Inventory(18) */}
                                    {((viewingItem.serial !== undefined && hasPermission(21)) || 
                                      (viewingItem.serial === undefined && hasPermission(18))) && (
                                        <button 
                                          onClick={() => {
                                            if (viewingItem.serial !== undefined) handleDeleteAssets([viewingItem.id]);
                                            else handleDeleteInventory([viewingItem.id]);
                                          }}
                                          className="bg-white text-red-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-red-50 border border-red-200 flex items-center gap-1"
                                        >
                                          <Trash2 className="w-3 h-3"/> ลบ (Delete)
                                        </button>
                                    )}

                                    {/* ปุ่มรับคืน: สิทธิ์ 25 */}
                                    {hasPermission(25) && viewingItem.status === 'Borrowed' && (
                                        <button onClick={() => { setShowItemDetailModal(false); initiateReturnAsset(viewingItem); }} className="bg-teal-50 text-teal-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-teal-100 border border-teal-200">รับคืน</button>
                                    )}
                                    
                                     {/* ปุ่มแก้ไข: เช็คประเภทว่าเป็น Asset(20) หรือ Inventory(17) */}
                                    {((viewingItem.serial !== undefined && hasPermission(20)) || 
                                      (viewingItem.serial === undefined && hasPermission(17))) && (
                                        <button onClick={() => { 
                                            setShowItemDetailModal(false);
                                            if (viewingItem.serial !== undefined) {
                                                setEditingAssetItem({...viewingItem, originalId: viewingItem.id, newImages: []});
                                                setShowEditAssetModal(true); 
                                            } else {
    setEditingStockItem({
    ...viewingItem, 
    originalId: viewingItem.id, 
    originalName: viewingItem.name,       // ⭐ เก็บชื่อเดิม
    originalProject: viewingItem.project, // ⭐ เก็บโครงการเดิม
    newImages: []
});
setShowEditInvModal(true);
}
                                        }} className="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-100 border border-blue-200">แก้ไข</button>
                                    )}
                                </div>
                                

                                <h4 className="font-bold text-gray-800 border-b pb-2 mb-4 flex items-center gap-2"><Info className="w-4 h-4 text-blue-600"/> ข้อมูลสินค้า / ทรัพย์สิน</h4>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-y-6 gap-x-8 text-sm">
                                    <div>
    <span className="text-gray-500 block text-xs mb-1">รหัส (ID)</span>
    {/* ⭐ แก้ไข: ใช้ getDisplayId ครอบ */}
    <span className="font-mono font-bold text-gray-700">{getDisplayId(viewingItem.id)}</span>
</div>
<div className="col-span-2 md:col-span-1">
    <span className="text-gray-500 block text-xs mb-1">โครงการ (Project)</span>
    <span className="font-bold text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded">
        {/* ⭐ แก้ไข: ถ้าเป็น Summary และเลือกทุกโครงการ ให้แสดง "ทุกโครงการ" */}
        {viewingItem.isSummary && globalProjectFilter === 'All' 
            ? 'ทุกโครงการ' 
            : (viewingItem.project || 'ไม่ระบุ')}
    </span>
</div>

                                    <div><span className="text-gray-500 block text-xs mb-1">ชื่อรายการ</span><span className="font-bold text-gray-900">{viewingItem.name}</span></div>
                                    
                                    {viewingItem.serial !== undefined ? (
                                        // ... (Asset Fields เหมือนเดิม) ...
                                       <> 
        {/* 1. ประเภททรัพย์สิน (ซื้อ/เช่า) */}
        <div>
            <span className="text-gray-500 block text-xs mb-1">ประเภททรัพย์สิน</span>
            <span className={`px-2 py-0.5 rounded text-xs font-bold border ${viewingItem.ownerType === 'Rent' ? 'bg-orange-50 text-orange-700 border-orange-200' : 'bg-blue-50 text-blue-700 border-blue-200'}`}>
                {viewingItem.ownerType === 'Rent' ? 'รายการเช่า (Rent)' : 'ทรัพย์สินบริษัท (Company)'}
            </span>
        </div>

        <div><span className="text-gray-500 block text-xs mb-1">Serial Number</span><span className="font-mono text-gray-700">{viewingItem.serial || '-'}</span></div>
        
        <div>
            <span className="text-gray-500 block text-xs mb-1">สถานะ</span>
            <span className={`font-bold ${
                viewingItem.status === 'Available' ? 'text-green-600' :
                viewingItem.status === 'Borrowed' ? 'text-orange-600' :
                viewingItem.status === 'Lost' ? 'text-gray-800' : 'text-red-600'
            }`}>
                {ASSET_STATUS_LABELS[viewingItem.status] || viewingItem.status}
            </span>
        </div>

        {/* 2. ระยะเวลาเช่า (แสดงเฉพาะของเช่า) */}
        {viewingItem.ownerType === 'Rent' && (
            <div>
                <span className="text-gray-500 block text-xs mb-1">ระยะเวลาเช่า</span>
                <div className="text-sm font-medium flex flex-col">
                    <span className="text-green-700 text-xs flex items-center gap-1">เริ่ม: {viewingItem.rentalStart || '-'}</span>
                    <span className="text-red-700 text-xs flex items-center gap-1">สิ้นสุด: {viewingItem.rentalEnd || '-'}</span>
                </div>
            </div>
        )}

        {/* 3. ราคา (แยกตามประเภท) */}
        <div>
            <span className="text-gray-500 block text-xs mb-1">{viewingItem.ownerType === 'Rent' ? 'ราคาเช่า' : 'ราคาซื้อ'}</span>
            <span className="font-medium text-gray-900 font-mono">
                {viewingItem.ownerType === 'Rent' 
                    ? `${(viewingItem.rentalPrice || 0).toLocaleString()} ${RENTAL_UNITS[viewingItem.rentalUnit] || ''}`
                    : `${(viewingItem.price || 0).toLocaleString()} บาท`
                }
            </span>
        </div>

        <div className="col-span-2"><span className="text-gray-500 block text-xs mb-1">หมายเหตุ</span><span className="text-gray-600">{viewingItem.note || '-'}</span></div>
    </>
) : (
                                        // ⭐ Inventory Fields (Updated)
                                        <>
                                            <div><span className="text-gray-500 block text-xs mb-1">ประเภทสต็อก</span>
    <span className={`px-2 py-0.5 rounded text-xs font-bold ${
        // ⭐ แก้ไข: ถ้าเป็น Summary (ไม่ว่าจะเลือกโครงการไหน) ให้ใช้สีม่วง
        viewingItem.isSummary 
            ? 'bg-purple-100 text-purple-700' 
            : (viewingItem.stockType === 'NonSystem' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700')
    }`}>
        {/* ⭐ แก้ไข: ถ้าเป็น Summary ให้แสดง "รวม" เสมอ */}
        {viewingItem.isSummary
            ? 'รวม' 
            : (viewingItem.stockType === 'NonSystem' ? 'ของนอกระบบ' : 'ของในระบบ')}
    </span>
</div>
                                            <div><span className="text-gray-500 block text-xs mb-1">คงเหลือ</span><span className="font-bold text-blue-600 text-lg">{viewingItem.qty} {viewingItem.unit}</span></div>
                                            <div><span className="text-gray-500 block text-xs mb-1">Min Stock</span><span className="font-medium text-red-600">{viewingItem.minStock}</span></div>
                                            <div><span className="text-gray-500 block text-xs mb-1">ราคาต่อหน่วย</span><span className="font-medium text-gray-700">{viewingItem.price?.toLocaleString()} บาท</span></div>
                                            <div className="col-span-2"><span className="text-gray-500 block text-xs mb-1">หมายเหตุ</span><span className="text-gray-600">{viewingItem.note || '-'}</span></div>
                                        </>
                                    )}
                                </div>
                                <div className="text-xs text-gray-400 pt-4 border-t mt-4">อัปเดตล่าสุด: {viewingItem.lastUpdated}</div>
                            </div>
                        </div>
                    )}

{/* --- TOOLBAR --- */}
<div className="px-6 py-4 sticky top-0 z-10 bg-slate-50/95 backdrop-blur-sm border-b border-gray-200 mt-2">
    <div className="flex flex-wrap gap-3 items-center justify-between">
        <h4 className="font-bold text-gray-700 flex items-center gap-2"><History className="w-4 h-4"/> ประวัติการดำเนินการ ({filteredLogs.length})</h4>
        
        <div className="flex items-center gap-2 flex-1 justify-end min-w-[250px]">
            {/* ⭐ เพิ่มตัวกรองโครงการ (เฉพาะตอนดู All Logs) */}
            {!viewingItem && (
                <select 
                    className="p-2 border border-gray-300 rounded-lg text-sm bg-white outline-none cursor-pointer focus:ring-2 focus:ring-blue-500 max-w-[150px]"
                    value={globalProjectFilter} // ใช้ตัวกรองเดียวกับหน้าหลัก หรือจะสร้าง state ใหม่เฉพาะ modal ก็ได้ (ในที่นี้ใช้ global เพื่อความต่อเนื่อง)
                    onChange={e => setGlobalProjectFilter(e.target.value)}
                >
                    <option value="All">ทุกโครงการ</option>
                    {projects.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                </select>
            )}

            <div className="relative w-48">
                <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                <input type="text" className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none bg-white focus:ring-2 focus:ring-blue-500" placeholder="ค้นหา..." value={historySearch} onChange={e => setHistorySearch(e.target.value)}/>
            </div>
            
            <select className="p-2 border border-gray-300 rounded-lg text-sm bg-white outline-none cursor-pointer focus:ring-2 focus:ring-blue-500" value={historyActionFilter} onChange={e => setHistoryActionFilter(e.target.value)}>
                <option value="All">ทุกประเภท</option>
                <option value="Stock In">รับของเข้า</option>
                <option value="Withdraw">เบิกออก</option>
                <option value="Borrow">ยืม</option>
                <option value="Return">คืน</option>
                <option value="Add Asset">เพิ่มทรัพย์สิน</option>
                <option value="Delete Asset">รายการที่ลบ</option>
                <option value="Import Assets">Import (CSV)</option>
            </select>
        </div>
    </div>
</div>

                    {/* --- TABLE --- */}
                    <div className="px-6 pb-6">
                        <div className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                            <table className="w-full text-sm text-left">
<thead className="bg-gray-100 text-gray-600 border-b">
    <tr>
        {/* Date */}
        <th className="px-4 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleHistorySort('date')}>
            Date <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
        </th>
        
        {/* Image (ไม่เรียง) */}
        <th className="px-4 py-3 text-center">รูปภาพ</th>
        
        {/* Action */}
        <th className="px-4 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleHistorySort('action')}>
            Action <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
        </th>
        
        {/* Item Info (เฉพาะหน้า All Logs) */}
                                       
                                       {/* Item Info (เฉพาะหน้า All Logs) */}
                                        {!viewingItem && (
                                            <td className="px-6 py-3">
                                                <div className="font-medium text-gray-900">{log.item}</div>
                                                {(() => {
                                                    // พยายามหา ID จาก Asset ปัจจุบัน หรือจาก Log (กรณีลบไปแล้ว)
                                                    let displayId = log.assetId;
                                                    if (!displayId) {
                                                        const matchedAsset = assets.find(a => a.name === log.item);
                                                        if (matchedAsset) displayId = matchedAsset.id;
                                                    }
                                                    
                                                    if (displayId) {
                                                        // ⭐ เรียกใช้ getDisplayId เพื่อตัดส่วนเกินออก
                                                        return <div className="text-xs text-gray-500 mt-0.5 font-mono">ID: {getDisplayId(displayId)}</div>;
                                                    }
                                                    return null;
                                                })()}
                                            </td>
                                        )}
        {/* Change */}
        <th className="px-4 py-3 text-center cursor-pointer hover:bg-gray-200" onClick={() => handleHistorySort('change')}>
            Change <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
        </th>
        
        {/* Ref Doc */}
        <th className="px-4 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleHistorySort('relatedRequestId')}>
            Ref Doc <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
        </th>
        
        {/* ⭐ User (ทำให้เรียงได้ตามที่ขอ) */}
        <th className="px-4 py-3 min-w-[120px] cursor-pointer hover:bg-gray-200" onClick={() => handleHistorySort('by')}>
            User <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
        </th>
        
        {/* Note */}
        <th className="px-4 py-3 cursor-pointer hover:bg-gray-200" onClick={() => handleHistorySort('note')}>
            Note <ArrowUpDown className="w-3 h-3 inline opacity-50"/>
        </th>
    </tr>
</thead>
                                <tbody className="divide-y divide-gray-100">
                                    {filteredLogs.map((log, i) => (
                                    <tr key={i} className={`hover:bg-blue-50 transition-colors ${log.action === 'Delete Asset' ? 'bg-red-50/50' : ''}`}>
                                        <td className="px-4 py-3 text-gray-500 text-xs whitespace-nowrap">{log.date}</td>
                                        
                                        <td className="px-4 py-3 text-center">
                                            {log.images && log.images.length > 0 ? (
                                                <button 
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setViewingAttachments({ attachments: log.images }); 
                                                    }}
                                                    className="p-1.5 border rounded-lg hover:shadow-md transition-all group relative bg-white border-gray-200 text-blue-600 hover:border-blue-400"
                                                >
                                                    <ImageIcon className="w-4 h-4"/>
                                                </button>
                                            ) : <span className="text-gray-300">-</span>}
                                        </td>

                                        <td className="px-4 py-3">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                log.action.includes('In') || log.action.includes('Return') || log.action.includes('Add') || log.action.includes('Register') || log.action === 'Restore Asset' ? 'bg-green-100 text-green-700' :
                                                log.action.includes('Out') || log.action.includes('Withdraw') || log.action === 'Delete Asset' ? 'bg-red-100 text-red-700' :
                                                log.action.includes('Borrow') ? 'bg-blue-100 text-blue-700' :
                                                'bg-gray-100 text-gray-700'
                                            }`}>
                                                {log.action === 'Pending PM' ? 'Pending Level 2' : log.action}
                                            </span>
                                        </td>

                                        {!viewingItem && (
                                            <td className="px-6 py-3">
                                                <div className="font-medium text-gray-900">{log.item}</div>
                                                {(() => {
                                                    // พยายามหา ID จาก Asset ปัจจุบัน หรือจาก Log (กรณีลบไปแล้ว)
                                                    let displayId = log.assetId;
                                                    if (!displayId) {
                                                        const matchedAsset = assets.find(a => a.name === log.item);
                                                        if (matchedAsset) displayId = matchedAsset.id;
                                                    }
                                                    
                                                    if (displayId) {
                                                        return <div className="text-xs text-gray-500 mt-0.5 font-mono">ID: {displayId}</div>;
                                                    }
                                                    return null;
                                                })()}
                                            </td>
                                        )}

                                        <td className={`px-4 py-3 text-center font-mono font-bold ${log.change === 'Delete' ? 'text-red-600' : 'text-blue-600'}`}>{log.change}</td>
                                        
                                        {/* ⭐ REF DOC LINK (FIXED) ⭐ */}
                                        <td className="px-4 py-3">
                                            {log.relatedRequestId ? (
                                                <button 
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        // เรียกฟังก์ชันเปิด Modal (ต้องมั่นใจว่า z-index ของ Modal นั้นสูงพอ)
                                                        handleOpenRequestDetail(log.relatedRequestId);
                                                    }}
                                                    className="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100 hover:bg-blue-100 hover:underline flex items-center gap-1 cursor-pointer transition-colors"
                                                    title="คลิกเพื่อดูรายละเอียดเอกสาร"
                                                >
                                                    <FileText className="w-3 h-3"/> {log.relatedRequestId}
                                                </button>
                                            ) : <span className="text-gray-300">-</span>}
                                        </td>
                                        
                                        <td className="px-4 py-3 text-gray-600 text-xs">{log.by}</td>
                                        
                                    <td className="px-4 py-3 text-xs">
                                            {log.action === 'Delete Asset' || log.action === 'Delete Inventory' ? (
                                                <div className="flex flex-col gap-1">
                                                    <span className="text-gray-500 italic">Backup Data Saved</span>
{hasPermission(27) && ( // ✅ ใช้สิทธิ์ 27
    <button 
        onClick={() => {
            if(log.action === 'Delete Asset') handleRestoreAsset(log);
            else handleRestoreInventory(log);
        }}
                                                            className="text-white bg-green-500 hover:bg-green-600 px-2 py-1 rounded w-fit flex items-center gap-1 font-bold shadow-sm text-[10px]"
                                                        >
                                                            <RotateCcw className="w-3 h-3"/> กู้คืน
                                                        </button>
                                                    )}
                                                </div>
                                            ) : (
    <div className="text-gray-500 whitespace-pre-wrap break-words min-w-[200px]">
        {log.note}
    </div>
)}
                                        </td>
                                    </tr>
                                ))}</tbody>
                            </table>
                            {filteredLogs.length === 0 && <div className="p-12 text-center text-gray-400 flex flex-col items-center"><Search className="w-12 h-12 mb-3 opacity-20"/>ไม่พบรายการประวัติที่ค้นหา</div>}
                            
                         

                        </div>
                    </div>

                </div>
                <ModalScrollButtons targetId="history-modal-scroll" />
                {/* ⭐ ปุ่ม Load More แบบลอย (Floating Button) มุมซ้ายล่าง */}
          
              <button 
                  onClick={() => {
                      if(!confirm('การโหลดประวัติทั้งหมดอาจใช้เวลาสักครู่ ยืนยัน?')) return;
                      setIsLoading(true);
                      google.script.run.withSuccessHandler((logs) => {
                          if (logs) setInvLogs(logs);
                          setIsLoading(false);
                          showToast('โหลดประวัติครบถ้วนแล้ว');
                      }).getRecentLogs(2000);
                  }}
                  className="absolute bottom-6 left-6 z-[60] bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-600 hover:text-white px-4 py-3 rounded-full shadow-xl transition-all transform hover:scale-105 flex items-center gap-2 font-bold text-xs group no-print"
                  title="โหลดข้อมูลเก่าเพิ่ม"
              >
                  <RefreshCw size={16} className="group-hover:rotate-180 transition-transform duration-500"/> 
                  <span>โหลดเพิ่ม (Load More)</span>
              </button>
          
             </div>
          </div>
      )}

      {showRejectModal && (
         <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
             <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                 <h3 className="font-bold text-lg text-red-600 mb-4 flex items-center gap-2"><AlertCircle className="w-5 h-5"/> ไม่อนุมัติรายการ</h3>
                 <textarea className="w-full p-3 border border-gray-300 rounded-lg text-sm mb-4 outline-none focus:ring-2 focus:ring-red-500" rows="3" placeholder="ระบุเหตุผลที่ไม่อนุมัติ..." value={rejectData.reason} onChange={e => setRejectData({...rejectData, reason: e.target.value})} autoFocus></textarea>
                 <div className="flex gap-3">
                     <button onClick={() => setShowRejectModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600">ยกเลิก</button>
                     <button onClick={handleConfirmReject} className="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700">ยืนยัน</button>
                 </div>
             </div>
         </div>
      )}

{showDisburseModal && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm animate-in fade-in">
        <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto flex flex-col">
            <h3 className="font-bold text-lg text-teal-700 mb-4 flex items-center gap-2">
                <Package className="w-5 h-5"/> ยืนยันการจ่ายของ/เบิก
            </h3>

           {/* ⭐ ส่วนแสดงรายการสินค้าที่จะจ่าย (Updated: แยก Withdraw/Borrow) */}
            <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 mb-4 text-sm animate-in zoom-in-95">
                <div className="flex justify-between items-center border-b border-slate-200 pb-2 mb-2">
                    <span className="font-bold text-gray-700">รายการที่ต้องจ่าย ({disburseItems.length})</span>
                    {(() => {
    const req = requests.find(r => r.id === disburseData.requestId);
    return (
        <span className="text-xs text-gray-500 bg-white px-2 py-0.5 rounded border font-bold">
            {disburseData.requestId}
            {req?.docNumber && <span className="text-teal-600"> | {req.docNumber}</span>}
        </span>
    );
})()}
                </div>
                
       <div className="space-y-4 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar">
                    {disburseItems.map((item, idx) => {
                        const req = requests.find(r => r.id === disburseData.requestId);
                        
                        // ⭐ สร้าง Object สำหรับดึงรูป (ถ้ามี Asset ID ให้ใช้เป็น ID หลักเพื่อความแม่นยำ)
                        const itemForImage = { ...item, id: item.assetId || item.id };

                        // ⭐ Component แสดงรูปภาพ (Image Block) - Updated
                        const ImageBlock = (
                            <div 
                                className="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0 border overflow-hidden relative cursor-pointer hover:ring-2 hover:ring-blue-400 transition-all shadow-sm"
                                onClick={(e) => {
                                    // ⭐ แก้ไข: ดึงรูปทั้งหมดมาแสดง
                                    const images = getItemLatestImages(itemForImage);
                                    if (images.length > 0) {
                                        e.stopPropagation();
                                        setViewingAttachments({ attachments: images });
                                    }
                                }}
                                title="คลิกเพื่อดูรูปภาพขยายทั้งหมด"
                            >
                                {(() => {
                                    // Preview ยังคงใช้รูปแรก
                                    const img = getItemLatestImage(itemForImage);
                                    // เช็คจำนวนรูปเพื่อแสดง Badge
                                    const allImages = getItemLatestImages(itemForImage);
                                    
                                    if (img) {
                                        return (
                                            <>
                                                <img 
                                                    src={getDriveImageUrl(img.url || img.base64)} 
                                                    alt="preview" 
                                                    className="w-full h-full object-cover hover:scale-110 transition-transform duration-300" 
                                                    onError={(e) => e.target.style.display = 'none'}
                                                />
                                                {/* แสดงจำนวนรูปถ้ามีมากกว่า 1 */}
                                                {allImages.length > 1 && (
                                                    <div className="absolute top-0 left-0 bg-black/60 text-white px-1 text-[9px] rounded-br">
                                                        +{allImages.length - 1}
                                                    </div>
                                                )}
                                                <div className="absolute bottom-0 right-0 bg-black/50 text-white p-0.5 rounded-tl-md">
                                                    <ImageIcon className="w-3 h-3"/>
                                                </div>
                                            </>
                                        );
                                    } else {
                                        return <span className="text-[10px] text-gray-400 font-bold">ไม่มีภาพ</span>;
                                    }
                                })()}
                            </div>
                        );

                        // 🟢 กรณี 1: การเบิก (Withdraw) -> ใช้ตารางแยก ในระบบ/นอกระบบ
                        if (req.type === 'Withdraw') {
                            const totalInput = (item.useSys || 0) + (item.useNon || 0);
                            const isMatch = totalInput === item.qty;
                            return (
                                <div key={idx} className="bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex gap-3">
                                    {/* ⭐ แสดงรูปด้านซ้าย */}
                                    {ImageBlock}

                                    <div className="flex-1 min-w-0">
                                        <div className="flex justify-between mb-2">
                                            <div className="flex flex-col">
    <span className="font-bold text-gray-800">{item.name}</span>
    
    {/* ⭐ 2. เพิ่ม: แสดงรหัสวัสดุ (Inventory ID) */}
    {(() => {
        // ค้นหารหัสจากคลัง (Inventory) โดยดูจากชื่อและโครงการ
        const stockItem = inventory.find(i => i.name === item.name && i.project === req.job);
        // ใช้ getDisplayId เพื่อตัดส่วนเกินออก (เช่น |Project|System)
        const displayId = stockItem ? getDisplayId(stockItem.id) : null;
        
        return displayId ? (
            <span className="text-[10px] text-gray-500 font-mono bg-gray-100 px-1.5 rounded border w-fit mt-0.5">
                รหัส: {displayId}
            </span>
        ) : null;
    })()}
</div>
                                            <span className="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-600 whitespace-nowrap ml-2">สั่ง: <b>{item.qty}</b> {item.unit}</span>
                                        </div>
                                        <div className="flex gap-3 items-end">
                                            <div className="flex-1">
                                                <label className={`text-[10px] font-bold block mb-1 ${item.useSys > item.sysAvailable ? 'text-red-600' : 'text-blue-600'}`}>
                                                    ในระบบ (มี: {item.sysAvailable})
                                                </label>
                                                <input 
                                                    type="number" 
                                                    min="0" 
                                                    max={item.sysAvailable} 
                                                    className={`w-full p-1.5 border rounded text-center text-sm font-bold outline-none focus:ring-2 ${item.useSys > item.sysAvailable ? 'border-red-500 text-red-600 focus:ring-red-200' : 'border-blue-200 text-gray-800 focus:ring-blue-500'}`}
                                                    value={item.useSys.toString()} 
                                                    onChange={(e) => {
                                                        let val = parseInt(e.target.value);
                                                        if (isNaN(val)) val = 0;
                                                        const newItems = [...disburseItems];
                                                        newItems[idx].useSys = val;
                                                        const remainingNeed = item.qty - val;
                                                        if (remainingNeed >= 0) {
                                                            newItems[idx].useNon = Math.min(remainingNeed, item.nonAvailable);
                                                        }
                                                        setDisburseItems(newItems);
                                                    }}
                                                />
                                            </div>

                                            <div className="flex-1">
                                                <label className={`text-[10px] font-bold block mb-1 ${item.useNon > item.nonAvailable ? 'text-red-600' : 'text-orange-600'}`}>
                                                    นอกระบบ (มี: {item.nonAvailable})
                                                </label>
                                                <input 
                                                    type="number" 
                                                    min="0" 
                                                    max={item.nonAvailable}
                                                    className={`w-full p-1.5 border rounded text-center text-sm font-bold outline-none focus:ring-2 ${item.useNon > item.nonAvailable ? 'border-red-500 text-red-600 focus:ring-red-200' : 'border-orange-200 text-gray-800 focus:ring-orange-500'}`}
                                                    value={item.useNon.toString()}
                                                    onChange={(e) => {
                                                        let val = parseInt(e.target.value);
                                                        if (isNaN(val)) val = 0;
                                                        const newItems = [...disburseItems];
                                                        newItems[idx].useNon = val;
                                                        const remainingNeed = item.qty - val;
                                                        if (remainingNeed >= 0) {
                                                            newItems[idx].useSys = Math.min(remainingNeed, item.sysAvailable);
                                                        }
                                                        setDisburseItems(newItems);
                                                    }}
                                                />
                                            </div>
                                        </div>
                                        <div className={`mt-2 text-xs text-right font-bold ${isMatch ? 'text-green-600' : 'text-red-500'}`}>
                                            รวมจ่าย: {totalInput} / {item.qty} {!isMatch && '(ยอดไม่ตรง!)'}
                                        </div>
                                    </div>
                                </div>
                            );
                        } 
                        
                        // 🔵 กรณี 2: การยืม (Borrow) -> โชว์ข้อมูลทรัพย์สิน (Asset ID / Serial)
                        else {
                            return (
                                <div key={idx} className="bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex items-center gap-3">
                                    {/* ⭐ แสดงรูปด้านซ้าย */}
                                    {ImageBlock}

                                    <div className="flex-1 flex justify-between items-center">
                                        <div>
                                            <div className="font-bold text-gray-800">{item.name}</div>
                                            <div className="flex gap-2 mt-1">
                                                {item.assetId && <span className="text-[10px] bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded border border-indigo-100 font-mono">ID: {item.assetId}</span>}
                                                {item.serial && <span className="text-[10px] bg-slate-50 text-slate-600 px-2 py-0.5 rounded border border-slate-200 font-mono">S/N: {item.serial}</span>}
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <span className="font-bold text-lg text-blue-600">1</span>
                                            <span className="text-xs text-gray-500 ml-1">{item.unit || 'เครื่อง'}</span>
                                        </div>
                                    </div>
                                </div>
                            );
                        }
                    })}
                </div>

            </div>

            <p className="text-sm text-gray-600 mb-3 font-bold">ตรวจสอบความถูกต้องและสภาพของก่อนส่งมอบ</p>
            
            <div className="space-y-4 flex-1">
                {/* Note Input */}
                <textarea 
                    className="w-full p-3 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-teal-500" 
                    rows="2" 
                    placeholder="หมายเหตุการจ่าย (Optional)..." 
                    value={disburseData.note} 
                    onChange={e => setDisburseData({...disburseData, note: e.target.value})}
                ></textarea>

                {/* Image Upload Section */}
                <div>
                    <label className="text-xs font-bold text-gray-500 mb-2 block">หลักฐาน/รูปภาพประกอบ ({disburseData.images?.length || 0})</label>
                    
                    <div className="grid grid-cols-4 gap-2 mb-2">
                        {/* Preview Images */}
                        {disburseData.images && disburseData.images.map((img, idx) => (
                            <div key={idx} className="relative group w-full h-16 bg-gray-100 rounded-lg border overflow-hidden">
                                <img src={img.base64} alt="preview" className="w-full h-full object-cover"/>
                                <button 
                                    onClick={() => handleRemoveDisburseImage(idx)} 
                                    className="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md opacity-0 group-hover:opacity-100 transition-all hover:bg-red-600 hover:scale-110"
                                >
                                    <X size={12} strokeWidth={3}/>
                                </button>
                            </div>
                        ))}
                        
                        {/* Upload Button */}
                        <label className="cursor-pointer flex flex-col items-center justify-center w-full h-16 border-2 border-dashed border-teal-300 bg-teal-50 rounded-lg hover:bg-teal-100 transition-colors text-teal-600">
                            <Camera className="w-5 h-5"/>
                            <input type="file" multiple className="hidden" onChange={handleDisburseImageSelect}/>
                        </label>
                    </div>
                </div>
            </div>

            <div className="flex gap-3 mt-4">
                <button onClick={() => setShowDisburseModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 font-bold">ยกเลิก</button>
                <button onClick={handleConfirmDisburse} className="flex-1 py-2 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700 shadow-md">ยืนยันจ่ายของ</button>
            </div>
        </div>
    </div>
)}


{showEditInvModal && editingStockItem && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[160] p-4 backdrop-blur-sm">
              <div className="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                  
                  <div className="px-6 py-4 border-b bg-white flex justify-between items-center sticky top-0 z-10">
                      <h3 className="font-bold text-lg text-blue-700 flex items-center gap-2"><Edit className="w-5 h-5"/> แก้ไขข้อมูลสินค้า</h3>
                      <button onClick={() => setShowEditInvModal(false)} className="text-gray-400 hover:text-gray-600"><X className="w-5 h-5"/></button>
                  </div>

                  <div className="p-6 overflow-y-auto space-y-4">
                      {/* Type Selection */}
                      <div className="bg-gray-50 p-1 rounded-lg border border-gray-200 flex shadow-sm">
                        <button onClick={() => setEditingStockItem({...editingStockItem, stockType: 'System'})} className={`flex-1 py-1.5 text-sm font-bold rounded-md transition-all ${(!editingStockItem.stockType || editingStockItem.stockType === 'System') ? 'bg-white text-blue-700 shadow-sm' : 'text-gray-500'}`}>ของในระบบ</button>
                        <button onClick={() => setEditingStockItem({...editingStockItem, stockType: 'NonSystem'})} className={`flex-1 py-1.5 text-sm font-bold rounded-md transition-all ${editingStockItem.stockType === 'NonSystem' ? 'bg-white text-orange-700 shadow-sm' : 'text-gray-500'}`}>ของนอกระบบ</button>
                      </div>

                    <div>
    <label className="text-xs font-bold text-gray-500 mb-1 block">รหัสสินค้า (แก้ไขได้)</label>
    <input 
        type="text" 
        className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 font-mono text-blue-600 font-bold" 
        // ⭐ Value: แสดงแค่รหัสสั้น
        value={getDisplayId(editingStockItem.id)} 
        // ⭐ OnChange: เก็บค่าที่พิมพ์ลงไปตรงๆ (Logic บันทึกจะไปเติมส่วนท้ายให้เอง)
        onChange={e => setEditingStockItem({...editingStockItem, id: e.target.value})}
    />
</div>


                      <div><label className="text-xs font-bold text-gray-500 mb-1 block">ชื่อสินค้า</label><input type="text" className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={editingStockItem.name} onChange={e => setEditingStockItem({...editingStockItem, name: e.target.value})}/></div>
                      
                      <div className="grid grid-cols-2 gap-3">
                        <div><label className="text-xs font-bold text-gray-500 mb-1 block">คงเหลือ (Qty)</label><input type="number" className="w-full p-2 border rounded" value={editingStockItem.qty} onChange={e => setEditingStockItem({...editingStockItem, qty: parseInt(e.target.value)||0})}/></div>
                        
                        
                        <div><label className="text-xs font-bold text-gray-500 mb-1 block">หน่วยนับ</label><select className="w-full p-2 border rounded bg-white" value={editingStockItem.unit} onChange={e => setEditingStockItem({...editingStockItem, unit: e.target.value})}>{ITEM_UNITS.map(u => <option key={u} value={u}>{u}</option>)}</select></div>
                      </div>
                      
                      <div className="grid grid-cols-2 gap-3">
                        <div><label className="text-xs font-bold text-gray-500 mb-1 block">Min Stock</label><input type="number" className="w-full p-2 border rounded" value={editingStockItem.minStock} onChange={e => setEditingStockItem({...editingStockItem, minStock: parseInt(e.target.value)||0})}/></div>
                       
                       
                        <div><label className="text-xs font-bold text-gray-500 mb-1 block">ราคาต่อหน่วย</label><input type="number" className="w-full p-2 border rounded" value={editingStockItem.price} onChange={e => setEditingStockItem({...editingStockItem, price: parseFloat(e.target.value)||0})}/></div>
                      </div>

{/* Image Upload for Edit (UPDATED: Remove Current Image) */}
<div className="space-y-3">
    
    {/* ส่วนอัปโหลดรูปใหม่ (เหลือแค่นี้) */}
    <div>
         <label className="text-xs font-bold text-gray-500 mb-1 block">อัปเดตรูปภาพ (แทนที่รูปเดิม)</label>
         <label className="cursor-pointer flex items-center justify-center gap-2 w-full p-2.5 border border-dashed rounded-xl bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors font-bold text-sm">
             <Camera className="w-4 h-4"/> เลือกไฟล์ใหม่
             <input type="file" multiple className="hidden" onChange={(e) => {
                 if(e.target.files) {
                     const files = Array.from(e.target.files);
                     const promises = files.map(file => new Promise(resolve => { const r = new FileReader(); r.onload = (x) => resolve({ base64: x.target.result, file, name: file.name }); r.readAsDataURL(file); }));
                     Promise.all(promises).then(imgs => setEditingStockItem(prev => ({...prev, newImages: [...(prev.newImages || []), ...imgs]})));
                 }
             }}/>
         </label>
         
         {/* Preview New Images */}
         {editingStockItem.newImages && editingStockItem.newImages.length > 0 && (
             <div className="grid grid-cols-4 gap-2 mt-2">
                 {editingStockItem.newImages.map((img, idx) => (
                     <div key={idx} className="relative group w-full h-20 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden">
                         <img src={img.base64} className="w-full h-full object-cover"/>
                         <button 
                            onClick={() => handleRemoveEditStockNewImage(idx)} 
                            className="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md opacity-0 group-hover:opacity-100 transition-all hover:scale-110"
                         >
                            <X size={12}/>
                         </button>
                     </div>
                 ))}
             </div>
         )}
    </div>
</div>

                      <div><label className="text-xs font-bold text-gray-500 mb-1 block">หมายเหตุ</label><textarea className="w-full p-2 border rounded" rows="2" value={editingStockItem.note || ''} onChange={e => setEditingStockItem({...editingStockItem, note: e.target.value})}></textarea></div>
                  </div>

                  <div className="p-5 border-t border-gray-100 bg-white flex gap-3">
                      <button onClick={() => setShowEditInvModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600">ยกเลิก</button>
                      <button onClick={handleUpdateInventory} className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">บันทึก</button>
                  </div>
              </div>
          </div>
      )}

{showEditAssetModal && editingAssetItem && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[160] p-4 backdrop-blur-sm">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                  
                  <div className="px-6 py-4 border-b bg-white flex justify-between items-center sticky top-0 z-10">
                      <h3 className="font-bold text-lg text-blue-700 flex items-center gap-2"><Edit className="w-5 h-5"/> แก้ไขข้อมูลทรัพย์สิน</h3>
                      <button onClick={() => setShowEditAssetModal(false)} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100"><X className="w-5 h-5"/></button>
                  </div>
                  
                  <div className="p-6 overflow-y-auto bg-slate-50 space-y-5">
                       {/* ... (ส่วน ID, Name, Serial, Price คงเดิม) ... */}
                       <div className="space-y-3">
                          <div><label className="text-xs font-bold text-gray-500 mb-1 block">รหัสทรัพย์สิน (แก้ไขได้)</label><input type="text" className="w-full p-2.5 border rounded-xl text-sm font-mono bg-white focus:ring-2 focus:ring-blue-500" value={editingAssetItem.id} onChange={e => setEditingAssetItem({...editingAssetItem, id: e.target.value})}/></div>
                          <div><label className="text-xs font-bold text-gray-500 mb-1 block">ชื่อรายการ</label><input type="text" className="w-full p-2.5 border rounded-xl text-sm" value={editingAssetItem.name} onChange={e => setEditingAssetItem({...editingAssetItem, name: e.target.value})}/></div>
                          <div><label className="text-xs font-bold text-gray-500 mb-1 block">Serial Number</label><input type="text" className="w-full p-2.5 border rounded-xl text-sm" value={editingAssetItem.serial} onChange={e => setEditingAssetItem({...editingAssetItem, serial: e.target.value})}/></div>
                       </div>
                       
                       <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
{editingAssetItem.ownerType === 'Rent' ? (
    <>
        <div className="grid grid-cols-2 gap-3">
            <div>
                <label className="block text-xs font-bold text-gray-500 mb-1">ราคาเช่า</label>
                <input 
                    type="number" 
                    className="w-full p-2 border rounded-lg text-sm" 
                    value={editingAssetItem.rentalPrice} 
                    onChange={e => setEditingAssetItem({...editingAssetItem, rentalPrice: parseFloat(e.target.value)||0})}
                />
            </div>
            <div>
                <label className="block text-xs font-bold text-gray-500 mb-1">หน่วย</label>
                <select 
                    className="w-full p-2 border rounded-lg text-sm" 
                    value={editingAssetItem.rentalUnit} 
                    onChange={e => setEditingAssetItem({...editingAssetItem, rentalUnit: e.target.value})}
                >
                    <option value="Day">บาท / วัน</option>
                    <option value="Month">บาท / เดือน</option>
                    <option value="Year">บาท / ปี</option>
                </select>
            </div>
        </div>

        {/* ⭐ เพิ่มส่วนแก้ไขวันที่ (Start/End Date) */}
        <div className="grid grid-cols-2 gap-3 mt-3 pt-3 border-t border-dashed border-gray-200">
            <div>
            <label className="text-xs font-bold text-blue-700 mb-1 block">วันเริ่มสัญญา</label>
            <input 
                type="date" 
                // ดึงค่าเก่ามาโชว์ (ถ้ามี)
                value={editingAssetItem.rentalStart || ''} 
                onChange={(e) => setEditingAssetItem({...editingAssetItem, rentalStart: e.target.value})}
                className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"
            />
        </div>

        <div>
            <label className="text-xs font-bold text-blue-700 mb-1 block">วันสิ้นสุด</label>
            <input 
                type="date" 
                // ดึงค่าเก่ามาโชว์ (ถ้ามี)
                value={editingAssetItem.rentalEnd || ''} 
                onChange={(e) => setEditingAssetItem({...editingAssetItem, rentalEnd: e.target.value})}
                className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"
            />
        </div>
        </div>
    </>
) : (
    <div>
        <label className="block text-xs font-bold text-gray-500 mb-1">ราคาซื้อ</label>
        <input 
            type="number" 
            className="w-full p-2 border rounded-lg text-sm" 
            value={editingAssetItem.price} 
            onChange={e => setEditingAssetItem({...editingAssetItem, price: parseFloat(e.target.value)||0})}
        />
    </div>
)}
                       </div>

                       <div className="grid grid-cols-2 gap-4">
                           {/* Status */}
                           <div>
                               <label className="text-xs font-bold text-gray-500 mb-1 block">สถานะ (Status)</label>
                               <select 
                                   className={`w-full p-2.5 border rounded-xl text-sm ${editingAssetItem.status === 'Borrowed' ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : 'bg-white'}`}
                                   value={editingAssetItem.status} 
                                   onChange={e => setEditingAssetItem({...editingAssetItem, status: e.target.value})}
                                   disabled={editingAssetItem.status === 'Borrowed'}
                               >
                                   <option value="Available">ว่าง (Available)</option>
                                   <option value="Lost">สูญหาย (Lost)</option>
                                   <option value="Damaged">ชำรุด (Damaged)</option>
                                   {editingAssetItem.status === 'Borrowed' && <option value="Borrowed">ถูกยืม (Borrowed)</option>}
                               </select>
                           </div>
                           
                           {/* Image Upload */}
                           <div>
                               <label className="text-xs font-bold text-gray-500 mb-1 block">
                                   อัปเดตรูปภาพ 
                                   {editingAssetItem.status === 'Damaged' && <span className="text-red-500 ml-1">*จำเป็น</span>}
                               </label>
                               <label className={`cursor-pointer flex items-center justify-center gap-2 w-full p-2.5 border border-dashed rounded-xl text-sm font-bold transition-colors ${editingAssetItem.status === 'Damaged' && (!editingAssetItem.newImages || editingAssetItem.newImages.length === 0) ? 'border-red-400 bg-red-50 text-red-600' : 'border-blue-300 bg-blue-50 text-blue-600 hover:bg-blue-100'}`}>
                                   <Camera className="w-4 h-4"/> เลือกไฟล์
                                   <input type="file" multiple className="hidden" onChange={(e) => handleAssetImageSelect(e, true)}/>
                               </label>
                           </div>
                       </div>
                       
                       {/* ⭐ Note Field */}
                       <div>
                           <label className="text-xs font-bold text-gray-500 mb-1 block">
                               หมายเหตุ (Note)
                               {(editingAssetItem.status === 'Lost' || editingAssetItem.status === 'Damaged') && <span className="text-red-500 ml-1">*จำเป็น</span>}
                           </label>
                           <textarea 
                               className={`w-full p-2.5 border rounded-xl text-sm ${(editingAssetItem.status === 'Lost' || editingAssetItem.status === 'Damaged') && !editingAssetItem.note ? 'border-red-300 bg-red-50 focus:border-red-500' : 'border-gray-300'}`} 
                               rows="2" 
                               value={editingAssetItem.note || ''} 
                               onChange={e => setEditingAssetItem({...editingAssetItem, note: e.target.value})}
                               placeholder="ระบุสาเหตุ..."
                           ></textarea>
                       </div>
                       
                       {/* Preview New Images */}
                       {editingAssetItem.newImages && editingAssetItem.newImages.length > 0 && (
                           <div className="grid grid-cols-4 gap-2">
                               {editingAssetItem.newImages.map((img, idx) => (
                                   <div key={idx} className="relative group w-full h-16 bg-gray-100 rounded border overflow-hidden">
                                       <img src={img.base64} className="w-full h-full object-cover"/>
                                       <button onClick={() => handleRemoveAssetImage(idx, true)} className="absolute top-0 right-0 bg-red-500 text-white p-0.5 rounded-bl opacity-0 group-hover:opacity-100"><X size={10}/></button>
                                   </div>
                               ))}
                           </div>
                       )}
                  </div>

                  <div className="p-5 border-t border-gray-100 bg-white flex gap-3">
                      <button onClick={() => setShowEditAssetModal(false)} className="flex-1 py-3 border border-gray-300 rounded-xl text-gray-600 font-bold hover:bg-gray-50">ยกเลิก</button>
                      <button onClick={handleUpdateAsset} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-md">บันทึกการแก้ไข</button>
                  </div>
              </div>
          </div>
      )}
      {showPRModal && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
             <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                 <h3 className="font-bold text-lg text-blue-800 mb-4">ออกใบขอซื้อ (Issue PR)</h3>
                 <div className="space-y-3">
                     <div><label className="block text-sm font-bold text-gray-700 mb-1">เลขที่ PR (PR Number)</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="PR-XXXX" value={prData.prNumber} onChange={e => setPrData({...prData, prNumber: e.target.value})} autoFocus/></div>
                     <div><label className="block text-sm font-bold text-gray-700 mb-1">แนบไฟล์ PR (PDF/Image)</label><input type="file" className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onChange={e => setPrData({...prData, file: e.target.files[0]})}/></div>
                 </div>
                 <button onClick={handleSubmitPR} className="w-full py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 mt-4 shadow-md">บันทึก PR</button>
                 <button onClick={() => setShowPRModal(false)} className="w-full py-2 text-gray-500 text-sm mt-2 hover:underline">ยกเลิก</button>
             </div>
          </div>
      )}

      {showPOModal && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
             <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                 <h3 className="font-bold text-lg text-indigo-800 mb-4">ออกใบสั่งซื้อ (Issue PO)</h3>
                 <div className="space-y-3">
                     <div><label className="block text-sm font-bold text-gray-700 mb-1">เลขที่ PO (PO Number)</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="PO-XXXX" value={poData.poNumber} onChange={e => setPoData({...poData, poNumber: e.target.value})} autoFocus/></div>
                     <div><label className="block text-sm font-bold text-gray-700 mb-1">แนบไฟล์ PO (PDF/Image)</label><input type="file" className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" onChange={e => setPoData({...poData, file: e.target.files[0]})}/></div>
                 </div>
                 <button onClick={handleSubmitPO} className="w-full py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 mt-4 shadow-md">บันทึก PO</button>
                 <button onClick={() => setShowPOModal(false)} className="w-full py-2 text-gray-500 text-sm mt-2 hover:underline">ยกเลิก</button>
             </div>
          </div>
      )}


      {/* --- CONTRACT MODAL (NEW) --- */}
{showContractModal && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm animate-in fade-in">
        <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
            <h3 className="font-bold text-lg text-teal-800 mb-4 flex items-center gap-2">
                <FileSignature className="w-5 h-5"/> บันทึกการทำสัญญา (Contract)
            </h3>
            
            <div className="space-y-4">
                <div className="bg-teal-50 border border-teal-100 p-3 rounded-lg text-sm text-teal-800">
                    <p>กรุณาแนบไฟล์สัญญาเช่าเพื่อบันทึกสถานะ</p>
                </div>

                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">แนบไฟล์สัญญา (PDF/รูปภาพ) <span className="text-gray-400 font-normal">(ถ้ามี)</span></label>
                    <input 
                        type="file" 
                        accept=".pdf,.jpg,.jpeg,.png"
                        className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100 cursor-pointer" 
                        onChange={e => setContractData({...contractData, file: e.target.files[0]})}
                    />
                </div>
            </div>

            <button onClick={handleSubmitContract} className="w-full py-2 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700 mt-6 shadow-md transition-colors">
                ยืนยัน / บันทึก
            </button>
            <button onClick={() => setShowContractModal(false)} className="w-full py-2 text-gray-500 text-sm mt-2 hover:underline">
                ยกเลิก
            </button>
        </div>
    </div>
)}

{showReturnAssetModal && returnAssetData && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[90] p-4 backdrop-blur-sm">
              <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                  <div className="flex justify-between items-center mb-4">
                      <h3 className="font-bold text-lg text-teal-800 flex items-center gap-2"><RotateCcw className="w-5 h-5"/> รับคืนทรัพย์สิน</h3>
                      <button onClick={() => setShowReturnAssetModal(false)}><X className="w-5 h-5 text-gray-400"/></button>
                  </div>
                  
                  <div className="bg-gray-50 p-3 rounded-lg mb-4 text-sm border border-gray-200">
                      <label className="text-xs font-bold text-gray-500 block mb-1">ข้อมูลทรัพย์สิน</label>
                      <div className="font-bold text-gray-800 text-base">{returnAssetData.name}</div>
                      <div className="text-gray-600 font-mono text-xs mt-0.5">ID: {returnAssetData.id}</div>
                      <div className="text-gray-500 text-xs">S/N: {returnAssetData.serial || '-'}</div>
                  </div>
                  
                  <div className="space-y-4">
                      <div>
                          <label className="block text-sm font-bold text-gray-700 mb-1">สถานะหลังคืน (Status)</label>
                          <select className="w-full p-2 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500" value={returnAssetData.condition} onChange={e => setReturnAssetData({...returnAssetData, condition: e.target.value})}>
                              <option value="Good">ปกติ / ดี (Available)</option>
                              <option value="Damaged">ชำรุด (Damaged)</option>
                              <option value="Lost">สูญหาย (Lost)</option>
                          </select>
                      </div>
                      
                      <div>
                           <label className="block text-sm font-bold text-gray-700 mb-2">
                               รูปสภาพปัจจุบัน ({returnAssetData.images?.length || 0})
                               {returnAssetData.condition === 'Damaged' && <span className="text-red-500 ml-1">*จำเป็น</span>}
                           </label>
                           <div className="grid grid-cols-4 gap-2 mb-2">
                               {returnAssetData.previews && returnAssetData.previews.map((preview, idx) => (
                                   <div key={idx} className="relative group w-full h-16 bg-gray-100 rounded-lg border overflow-hidden">
                                       <img src={preview.url} alt="preview" className="w-full h-full object-cover"/>
                                       <button onClick={() => handleRemoveReturnImage(idx)} className="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md opacity-0 group-hover:opacity-100 transition-all hover:bg-red-600 hover:scale-110"><X size={12} strokeWidth={3}/></button>
                                   </div>
                               ))}
                               <label className={`cursor-pointer flex flex-col items-center justify-center w-full h-16 border-2 border-dashed rounded-lg transition-all ${returnAssetData.condition === 'Damaged' && (!returnAssetData.images || returnAssetData.images.length === 0) ? 'border-red-400 bg-red-50 text-red-600' : 'border-teal-300 bg-teal-50 text-teal-600 hover:bg-teal-100'}`}>
                                   <Camera className="w-4 h-4"/>
                                   <input type="file" multiple className="hidden" onChange={handleReturnImageSelect}/>
                               </label>
                           </div>
                      </div>

                      <div>
                          <label className="block text-sm font-bold text-gray-700 mb-1">
                              หมายเหตุ
                              {(returnAssetData.condition === 'Lost' || returnAssetData.condition === 'Damaged') && <span className="text-red-500 ml-1">*จำเป็น</span>}
                          </label>
                          <textarea 
                              className={`w-full p-2 border rounded-lg text-sm ${(returnAssetData.condition === 'Lost' || returnAssetData.condition === 'Damaged') && !returnAssetData.note ? 'border-red-300 bg-red-50' : 'border-gray-300'}`} 
                              rows="2" 
                              value={returnAssetData.note} 
                              onChange={e => setReturnAssetData({...returnAssetData, note: e.target.value})}
                          ></textarea>
                      </div>
                  </div>
                  <div className="flex gap-3 mt-6">
                      <button onClick={() => setShowReturnAssetModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50">ยกเลิก</button>
                      <button onClick={confirmReturnAsset} className="flex-1 py-2 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700 shadow-md">ยืนยันรับคืน</button>
                  </div>
              </div>
          </div>
      )}

{/* --- PRINT PREVIEW MODAL (แก้ไข: ปลดล็อก Modal ให้พิมพ์หลายหน้าได้) --- */}
{showPOPreviewModal && selectedRequest && (
  // 1. เพิ่ม class 'print:static print:h-auto print:overflow-visible print:block' เพื่อปลดล็อกการยึดหน้าจอ
  <div className="fixed inset-0 bg-white z-[200] overflow-auto print:static print:h-auto print:overflow-visible print:block">
      
      {/* 2. เพิ่ม class 'print:block print:w-full print:max-w-none print:p-0' เพื่อขยายความกว้างเต็มกระดาษ */}
      <div className="w-full max-w-none mx-auto p-4 md:p-8 print-container flex flex-col items-center print:block print:w-full print:h-auto print:p-0">
          
         <style>{`
    @media print {
        /* ⭐ 1. รีเซ็ตขอบกระดาษ Browser เป็น 0 (เพื่อคุมเอง) */
        @page { 
            size: A4; 
            margin: 0; 
        }
        
        /* ซ่อน Element อื่น */
        body * {
            visibility: hidden;
        }

        /* ปรับ html/body ให้รองรับเนื้อหายาวๆ */
        html, body {
            height: auto !important;
            min-height: 100vh !important;
            overflow: visible !important;
            background: white !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* แสดงเฉพาะ Print Area */
        #print-area, #print-area * {
            visibility: visible;
        }

        /* ⭐ 2. จัดหน้ากระดาษใหม่: ความกว้างเต็ม A4 + ขอบ 15mm เท่ากันทุกด้าน */
        #print-area {
            position: absolute !important;
            left: 0 !important;
            top: 0 !important;
            
            /* บังคับความกว้าง A4 */
            width: 210mm !important;
            max-width: 210mm !important;
            
            /* กำหนดขอบกระดาษ (ซ้าย/ขวา/บน/ล่าง) ที่นี่ */
            padding: 15mm !important; 
            
            height: auto !important;
            margin: 0 !important;
            background: white !important;
            overflow: visible !important;
            display: block !important;
            z-index: 9999 !important;
            box-sizing: border-box !important; /* สำคัญ: ให้ padding รวมอยู่ใน width */
        }

        /* ซ่อนปุ่ม */
        .no-print, button { 
            display: none !important;
        }
        
        /* จัดการตาราง */
        table { 
            width: 100% !important;
            border-collapse: collapse !important; 
        }
        thead { 
            display: table-header-group !important; /* หัวตารางซ้ำทุกหน้า */
        }
        tr { 
            page-break-inside: avoid !important; /* แถวไม่ขาดครึ่ง */
            break-inside: avoid !important;
        }
        
        /* เส้นขอบ */
        .preview-table th, .preview-table td, 
        td, th { 
            border: 1px solid black !important;
            padding: 6px 8px !important; 
            font-size: 10pt !important; 
            color: black !important;
        }
        
        .header-box {
            border: 1px solid black !important;
            color: black !important;
        }
    }

    /* CSS หน้าจอปกติ */
    .preview-table th, .preview-table td { 
        border: 1px solid black;
        padding: 6px 8px; 
        font-size: 12px; 
        vertical-align: top;
    }
    .header-box { 
        border: 1px solid black;
        padding: 10px; 
        margin-bottom: 15px; 
    }
`}</style>


          {/* Toolbar */}
          <div className="w-full max-w-[210mm] flex justify-between items-center mb-6 border-b pb-4 no-print bg-gray-50 p-4 rounded-xl">
              <div>
                  <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                      <Printer className="w-6 h-6 text-blue-600"/> ตัวอย่างก่อนพิมพ์
                  </h2>
                  <p className="text-sm text-gray-500">ตรวจสอบความถูกต้องก่อนสั่งพิมพ์</p>
              </div>
              <div className="flex gap-2">
                  <button onClick={handlePrint} className="flex items-center gap-2 px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md font-bold transition-all">
                      <Printer className="w-4 h-4"/> สั่งพิมพ์
                  </button>
                  <button onClick={() => setShowPOPreviewModal(false)} className="px-6 py-2.5 border border-gray-300 rounded-lg hover:bg-white bg-white text-gray-700 font-bold transition-all">
                      ปิด
                  </button>
              </div>
          </div>

          {/* --- DOCUMENT CONTENT --- */}
          <div id="print-area" className="print-content-wrapper bg-white text-black font-sans relative text-sm w-full max-w-[210mm]">{/* จัดกลางด้วย max-w-[210mm] ในหน้าจอปกติ */}
              
              {(() => {
                  const formatDateTh = (d) => {
                      if(!d) return '';
                      let dateObj;
                      if (typeof d === 'string') {
                          const cleanDate = d.split(' ')[0];
                          if (cleanDate.includes('/')) {
                              const parts = cleanDate.split('/');
                              if (parts.length === 3) {
                                  let d = parts[0].padStart(2, '0');
                                  let m = parts[1].padStart(2, '0');
                                  let y = parseInt(parts[2]);
                                  if (y < 2400) y += 543;
                                  return `${d}/${m}/${y}`;
                              }
                          }
                          dateObj = new Date(d);
                      } else { dateObj = d; }
                      
                      if (!dateObj || isNaN(dateObj.getTime())) return d;
                      const day = dateObj.getDate().toString().padStart(2, '0');
                      const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                      const year = dateObj.getFullYear() < 2400 ? dateObj.getFullYear() + 543 : dateObj.getFullYear();
                      return `${day}/${month}/${year}`;
                  };

                  // --- DATA PREPARATION ---
                  const historyDesc = [...(selectedRequest.history || [])].reverse();
                  const isActionMatch = (logAction, statusKey) => {
                      if (!logAction) return false;
                      const label = STATUS_LABELS[statusKey] || '';
                      return logAction === statusKey || logAction === label || logAction.includes(label);
                  };
                  
                  // Helper: แยก EmpID/Name
                  const getUser = (log) => {
                      if(!log || !log.user) return null;
                      // ลบคำว่า (Email) ถ้ามี
                      let txt = log.user.replace(' (Email)', '').trim();
                      // แยกส่วนแรกเป็น ID (สมมติเก็บแบบ "ID Name")
                      const firstPart = txt.split(' ')[0];
                      // ค้นหาใน allUsers
                      return allUsers.find(u => 
                          (u.empId && u.empId === firstPart) || 
                          (u.username === txt) ||
                          (u.email && txt.includes(u.email)) ||
                          (`${u.firstName} ${u.lastName}` === txt)
                      );
                  };

                  const reqLog = historyDesc.find(h => h.action === 'Draft' || h.action === 'Create' || h.action.includes('สร้าง')) || historyDesc[historyDesc.length - 1];
                  let l1Log = historyDesc.find(h => isActionMatch(h.action, 'Pending PM') || ((selectedRequest.type === 'Withdraw' || selectedRequest.type === 'Borrow') && isActionMatch(h.action, 'Ready to Disburse')));
const l2Log = historyDesc.find(h => 
    isActionMatch(h.action, 'Approved') && 
    h !== l1Log &&
    (!h.note || !h.note.includes('เปลี่ยนเป็น HO')) && // กรอง Log ตอนเปลี่ยนเป็น HO
    (!h.note || !h.note.includes('ตรวจสอบผ่าน'))      // ⭐ กรอง Log ตอนตรวจสอบผ่าน (Verification Pass)
);
                  
                  const userReq = getUser(reqLog);
                  const userL1 = getUser(l1Log);
                  const userL2 = getUser(l2Log);
                  
                  // ชื่อและวันที่ (Request / L1 / L2)
                  const nameReq = userReq ? `${userReq.firstName} ${userReq.lastName}` : (reqLog ? reqLog.user.replace(' (Email)', '') : selectedRequest.requester);
                  const nameL1 = userL1 ? `${userL1.firstName} ${userL1.lastName}` : (l1Log ? l1Log.user.replace(' (Email)', '') : '..........................');
                  const nameL2 = userL2 ? `${userL2.firstName} ${userL2.lastName}` : (l2Log ? l2Log.user.replace(' (Email)', '') : '..........................');
                  const dateReq = formatDateTh(reqLog ? reqLog.date : selectedRequest.created);
                  const dateL1 = l1Log ? formatDateTh(l1Log.date) : '....../....../......';
                  const dateL2 = l2Log ? formatDateTh(l2Log.date) : '....../....../......';
                  
                  // ลายเซ็น (Request / L1 / L2)
                  const sigReq = userReq?.signature ? getDriveImageUrl(userReq.signature) : null;
                  const sigL1 = userL1?.signature ? getDriveImageUrl(userL1.signature) : null;
                  const sigL2 = userL2?.signature ? getDriveImageUrl(userL2.signature) : null;

                  // --- หา Issued By (คนจ่ายของ) และ Returned By (คนรับคืน) ---
                  const getLogUser = (statusKey) => {
                      const log = historyDesc.find(h => isActionMatch(h.action, statusKey));
                      return { user: getUser(log), log: log };
                  };

                  // Issued: สถานะ 'Completed' (สำหรับ Borrow/Withdraw)
                  const issuerData = getLogUser('Completed');
                  const userIssuer = issuerData.user;
                  const nameIssuer = userIssuer ? `${userIssuer.firstName} ${userIssuer.lastName}` : (issuerData.log ? issuerData.log.user : '');
                  const sigIssuer = userIssuer?.signature ? getDriveImageUrl(userIssuer.signature) : null;

                  // Returned: สถานะ 'Returned'
                  const returnerData = getLogUser('Returned');
                  const userReturner = returnerData.user;
                  const nameReturner = userReturner ? `${userReturner.firstName} ${userReturner.lastName}` : (returnerData.log ? returnerData.log.user : '');
                  const sigReturner = userReturner?.signature ? getDriveImageUrl(userReturner.signature) : null;
                  const dateReturn = returnerData.log ? formatDateTh(returnerData.log.date) : '....../....../......';

                  return (
                      <>
                      {/* ================================================================================== */}
                      {/* FORM TYPE 1: BORROW TOOL SHEET */}
                      {/* ================================================================================== */}

                      {selectedRequest.type === 'Borrow' ? (
                          <div className="font-sans text-black p-4 w-full">
                              
                              <div className="text-center mb-6">
                                  <h1 className="text-3xl font-bold uppercase tracking-widest mb-1">BORROW TOOL SHEET</h1>
                                  <h2 className="text-xl font-bold">ใบยืมเครื่องมือ</h2>
                              </div>

                              <div className="mb-6 border-b-2 border-black pb-4">
                                  <div className="flex items-end gap-6 mb-2 text-base w-full">
                                      {/* [แก้ไข] ลดความกว้าง Name, เพิ่มพื้นที่ให้ Employee No และ Date */}
                                      <div className="flex-1 flex flex-col">
                                          <div className="flex items-end w-full">
                                              <span className="font-bold whitespace-nowrap mr-2">Name:</span>
                                              <div className="border-b border-dotted border-black flex-1 text-center font-bold text-blue-900 px-2 truncate">
                                                  {nameReq}
                                              </div>
                                          </div>
                                          <div className="text-xs text-center text-gray-500 mt-1">ชื่อผู้ยืม</div>
                                      </div>

                                      <div className="w-[35%] flex flex-col">
                                          <div className="flex items-end w-full">
                                              <span className="font-bold whitespace-nowrap mr-2">Employee No:</span>
                                              <div className="border-b border-dotted border-black flex-1 text-center font-mono">
                                                  {userReq?.empId || '-'}
                                              </div>
                                          </div>
                                          <div className="text-xs text-center text-gray-500 mt-1">เลขประจำตัว</div>
                                      </div>

                                      <div className="w-[25%] flex flex-col">
                                          <div className="flex items-end w-full">
                                              <span className="font-bold whitespace-nowrap mr-2">Date:</span>
                                              <div className="border-b border-dotted border-black flex-1 text-center">
                                                  {dateReq}
                                              </div>
                                          </div>
                                          <div className="text-xs text-center text-gray-500 mt-1">วันที่</div>
                                      </div>
                                  </div>

                                  <div className="flex justify-between items-end mt-4 mb-1 text-base">
                                      <div className="flex items-end w-full">
                                          <span className="font-bold w-16">Project:</span>
                                          <div className="border-b border-dotted border-black flex-1 text-left pl-2 font-bold text-black">
                                              {selectedRequest.job}
                                          </div>
                                      </div>
                                  </div>
                                  <div className="flex justify-between text-xs text-gray-500 font-normal">
                                      <div className="pl-16">โครงการ</div>
                                  </div>
                              </div>

                              {/* Table */}
                              <table className="w-full border-collapse border border-black mb-10">
                                  <thead>
                                      <tr>
                                          <th colSpan="4" className="border border-black p-2 bg-white text-right">
                                              <span className="font-bold text-base">Doc No: {selectedRequest.docNumber || selectedRequest.id}</span>
                                          </th>
                                      </tr>
                                      <tr className="bg-gray-100 text-center text-base">
                                          <th className="border border-black py-3 w-24">
                                              Quantity<br/><span className="text-xs font-normal">จำนวน</span>
                                          </th>
                                          <th className="border border-black py-3">
                                              Description<br/><span className="text-xs font-normal">รายการ</span>
                                          </th>
                                          <th className="border border-black py-3 w-32">
                                              Unit Price<br/><span className="text-xs font-normal">ราคา</span>
                                          </th>
                                          <th className="border border-black py-3 w-32">
                                              Amount<br/><span className="text-xs font-normal">จำนวนเงิน</span>
                                          </th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      {selectedRequest.items.map((item, idx) => (
                                          <tr key={idx} className="text-base">
                                              <td className="border border-black py-4 text-center align-top font-bold">
                                                  {item.qty} {item.unit}
                                              </td>
                                              <td className="border border-black py-4 px-4 align-top">
                                                  <div className="font-bold text-lg">{item.name}</div>
                                                  <div className="text-sm mt-1 text-gray-600">
                                                      {item.serial && <span>S/N: {item.serial} </span>}
                                                      {item.assetId && <span>ID: {item.assetId}</span>}
                                                  </div>
                                                  {item.note && <div className="text-sm text-gray-500 italic mt-1">Note: {item.note}</div>}
                                              </td>
                                              <td className="border border-black py-4 text-right px-2 align-top text-gray-400">-</td>
                                              <td className="border border-black py-4 text-right px-2 align-top text-gray-400">-</td>
                                          </tr>
                                      ))}
                                  </tbody>
                              </table>

                              {/* Signatures */}
                              <div className="grid grid-cols-2 gap-x-16 gap-y-8 mt-6">
                                  {/* Left Column */}
                                  <div className="flex flex-col gap-8">
                                      {/* Approved By */}
                                      <div className="relative">
                                          <div className="flex items-end mb-1">
                                              <span className="font-bold w-24 text-lg">Approved</span>
                                              <div className="border-b border-dotted border-black flex-1 relative h-10 text-center flex items-end justify-center">
                                                  {(sigL1 || sigL2) && <img src={sigL1 || sigL2} className="absolute bottom-0 left-1/2 -translate-x-1/2 max-h-16 object-contain"/>}
                                              </div>
                                          </div>
                                          <div className="text-center font-bold text-sm h-6 mt-1">
                                              {nameL1 && nameL1 !== '..........................' ? `(${nameL1})` : ''}
                                          </div>
                                          <div className="text-xs text-center -mt-1 text-gray-500">ผู้อนุมัติ (Approved By)</div>
                                      </div>

                                      {/* Issued By (แสดงเมื่อจ่ายของแล้ว) */}
                                      <div className="relative">
                                          <div className="flex items-end mb-1">
                                              <span className="font-bold w-24 text-lg">Issued</span>
                                              <div className="border-b border-dotted border-black flex-1 relative h-10 text-center flex items-end justify-center">
                                                  {sigIssuer && <img src={sigIssuer} className="absolute bottom-0 left-1/2 -translate-x-1/2 max-h-16 object-contain"/>}
                                              </div>
                                          </div>
                                          <div className="text-center font-bold text-sm h-6 mt-1">
                                              {nameIssuer ? `(${nameIssuer})` : ''}
                                          </div>
                                          <div className="text-xs text-center -mt-1 text-gray-500">ผู้จ่าย (Issued By)</div>
                                      </div>
                                  </div>

                                  {/* Right Column */}
                                  <div className="flex flex-col gap-8">
                                      {/* Borrowed By */}
                                      <div className="relative">
                                          <div className="flex items-end mb-1">
                                              <span className="font-bold w-24 text-lg">Borrowed</span>
                                              <div className="border-b border-dotted border-black flex-1 relative h-10 text-center flex items-end justify-center">
                                                  {sigReq ? <img src={sigReq} className="absolute bottom-0 left-1/2 -translate-x-1/2 max-h-16 object-contain"/> : ''}
                                              </div>
                                          </div>
                                          <div className="text-center font-bold text-sm h-6 mt-1">
                                              {nameReq ? `(${nameReq})` : ''}
                                          </div>
                                          <div className="text-xs text-center -mt-1 text-gray-500">ผู้ยืม (Borrowed By)</div>
                                      </div>

                                      {/* Returned By (แสดงเมื่อรับคืนแล้ว) */}
                                      <div className="relative">
                                          <div className="flex items-end mb-1">
                                              <span className="font-bold w-24 text-lg">Returned</span>
                                              <div className="border-b border-dotted border-black flex-1 relative h-10 text-center flex items-end justify-center">
                                                  {sigReturner && <img src={sigReturner} className="absolute bottom-0 left-1/2 -translate-x-1/2 max-h-16 object-contain"/>}
                                              </div>
                                          </div>
                                          <div className="text-center mt-1">
                                              <div className="font-bold text-sm h-6">
                                                  {nameReturner ? `(${nameReturner})` : ''}
                                              </div>
                                              <div className="text-xs text-gray-500 mb-2">ผู้รับคืน (Received By)</div>
                                              <div className="text-sm font-bold">
                                                  {nameReturner ? (
                                                      <span>วันที่คืน: {dateReturn}</span>
                                                  ) : (
                                                      <span className="text-transparent">.</span>
                                                  )}
                                              </div>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      ) : (
                                
  /* ================================================================================== */
/* ⭐ FORM TYPE 2 (ELSE): ใบสั่งซื้อ/เบิกทั่วไป (อัปเดต: สโตร์ + Partial + Closed Logic) */
/* ================================================================================== */

<> 
    {/* 1. ส่วนเตรียมข้อมูล "สโตร์" (แยก จ่ายของ vs รับของ) */}
    {(() => {
        // --- ⭐ [แก้ไขใหม่] Logic หาคนเซ็นช่องสโตร์ ---
        let storeLog = null;
        let storeLabel = "สโตร์ผู้รับของ"; // Default

        // กรณี 1: เบิกวัสดุ (Withdraw) -> คนเซ็นคือคนที่กด "จ่ายของ" (Disburse -> Completed)
        if (selectedRequest.type === 'Withdraw') {
            storeLabel = "สโตร์ผู้จ่ายของ";
            storeLog = historyDesc.find(h => 
                h.action === 'Completed' || // สถานะตอนกดจ่ายของจบงาน
                h.action === 'Received' ||  // เผื่อเคสเก่า
                (h.note && h.note.includes('จ่ายของ'))
            );
        } 
        // กรณี 2: สั่งซื้อ (Local/HO) -> คนเซ็นคือคนที่กด "รับของ" (Receive)
        else {
            storeLog = historyDesc.find(h => 
                h.action === 'Partially Received' || 
                h.action === 'Completed' || 
                h.action === 'Received' ||
                (h.note && h.note.includes('รับของ'))
            );
        }
        
        // ดึงข้อมูล User สโตร์
        const userStore = getUser(storeLog);
        const nameStore = userStore ? `${userStore.firstName} ${userStore.lastName}` : (storeLog ? storeLog.user.replace(' (Email)', '') : '..........................');
        const sigStore = userStore?.signature ? getDriveImageUrl(userStore.signature) : null;
        const dateStore = storeLog ? formatDateTh(storeLog.date) : '....../....../......';

        // ตัวแปรเช็คสถานะงาน
        const isJobClosed = ['Completed', 'Returned', 'Rejected'].includes(selectedRequest.status);
        const isPartial = selectedRequest.status === 'Partially Received';

        return (
        <>
            {/* --- Header --- */}
            <div className="w-full text-center mb-4">
                <h1 className="text-2xl font-bold mb-2">ใบขอเบิก-สั่งซื้อวัสดุอุปกรณ์</h1>
            </div>

            <div className="w-full text-left font-normal mb-4">
                <span className="font-bold text-base">โครงการ (Project):</span> 
                <span className="border-b border-dotted border-black px-2 ml-2 min-w-[200px] inline-block font-bold">
                    {selectedRequest.job}
                </span>
            </div>

            {/* กล่อง Checkbox (เลือกประเภท) */}
            <div className="header-box text-left font-normal">
                <div className="grid grid-cols-3 gap-2 mb-3">
                    <div className="flex justify-start">
                        <label className="flex items-center gap-2">
                            <div className={`w-5 h-5 border border-black flex items-center justify-center bg-white`}>
                                {(selectedRequest.type === 'Withdraw') && <span className="text-lg font-bold leading-none mb-1">✓</span>}
                            </div> 
                            <span>เบิกวัสดุ (Withdraw)</span>
                        </label>
                    </div>
                    <div className="flex justify-center">
                        <label className="flex items-center gap-2">
                            <div className={`w-5 h-5 border border-black flex items-center justify-center bg-white`}>
                                {selectedRequest.type === 'Local' && <span className="text-lg font-bold leading-none mb-1">✓</span>}
                            </div> 
                            <span>สั่งซื้อวัสดุ หน่วยงาน (Local)</span>
                        </label>
                    </div>
                    <div className="flex justify-end">
                        <label className="flex items-center gap-2">
                            <div className={`w-5 h-5 border border-black flex items-center justify-center bg-white`}>
                                {selectedRequest.type === 'HO' && <span className="text-lg font-bold leading-none mb-1">✓</span>}
                            </div> 
                            <span>{selectedRequest.type === 'HO' && selectedRequest.purchaseType === 'Rent' ? 'สั่งซื้อวัสดุ HO (เช่า)' : 'สั่งซื้อวัสดุ HO (ซื้อขาด)'}</span>
                        </label>
                    </div>
                </div>
                <div className="border-t border-black pt-3 flex gap-8">
                    <span className="font-bold">ความสำคัญ:</span>
                    {['Normal', 'Urgent', 'Critical'].map(p => (
                        <label key={p} className="flex items-center gap-2">
                            <div className="w-5 h-5 border border-black flex items-center justify-center bg-white">
                                {selectedRequest.priority === p && <span className="text-lg font-bold leading-none mb-1">✓</span>}
                            </div> 
                            <span>{p === 'Normal' ? 'ปกติ' : p === 'Urgent' ? 'ด่วน' : 'ด่วนมาก'}</span>
                        </label>
                    ))}
                </div>
            </div>

            {/* --- ตารางรายการ (แก้ไข Logic แสดงจำนวนและหมายเหตุ) --- */}
            <table className="w-full border-collapse preview-table">
                <thead>
                    <tr>
                        <th colSpan="4" className="border-0 p-0">
                            <div className="flex justify-end items-center pb-2 pt-2 bg-white" style={{borderBottom: '1px solid black'}}>
                                <div className="text-right">
                                    <div className="text-sm">
                                        <span className="font-bold">เลขที่เอกสาร:</span> {selectedRequest.docNumber || selectedRequest.id}
                                    </div>
                                    <div className="text-sm">
                                        <span className="font-bold">วันที่:</span> {formatDateTh(selectedRequest.history?.[0]?.date || selectedRequest.created)}
                                    </div>
                                </div>
                            </div>
                        </th>
                    </tr>
                    <tr className="bg-gray-100 text-center font-bold">
                        <th className="w-12 border border-black">NO.</th>
                        <th className="border border-black">รหัส / รายการวัสดุ (Code / Description)</th>
                        <th className="w-32 border border-black">SUBJOB / Mat. Code</th>
                        <th className="w-48 border border-black">วันที่ต้องการ / หมายเหตุ</th>
                    </tr>
                </thead>
               
           <tbody className="divide-y">
    {selectedRequest.items.map((item, i) => {
        // 1. ถ้าปิดงานแล้ว (Completed) แสดงยอดรับจริง, ถ้ายังไม่ปิด (Partial) แสดงยอดสั่ง
        const displayQty = isJobClosed ? (item.receivedTotal || 0) : item.qty;
        
        // 2. คำนวณยอด
        const received = item.receivedTotal || 0;
        const remaining = Math.max(0, item.qty - received);

        return (
            <tr key={i}>
                <td className="text-center font-bold border border-black p-2">{i + 1}</td>
                <td className="border border-black p-2">
    {/* ⭐ START: เพิ่มส่วนแสดงรหัสสินค้า (Item Code) ⭐ */}
    {(() => {
        // 1. ค้นหาในคลัง (Inventory) โดยดูจาก ชื่อ และ โครงการ
        const stockItem = inventory.find(inv => inv.name === item.name && inv.project === selectedRequest.job);
        
        // 2. ถ้าไม่เจอในคลัง ให้ลองหาในทรัพย์สิน (Assets) - กรณีใบยืม
        const assetItem = !stockItem ? assets.find(a => a.name === item.name && a.project === selectedRequest.job) : null;
        
        // 3. ดึง ID มาแสดง (ใช้ getDisplayId เพื่อตัดส่วนเกินออก)
        const showId = stockItem ? getDisplayId(stockItem.id) : (assetItem ? assetItem.id : null);

        return showId ? (
            <div className="text-[10px] font-mono font-bold text-slate-600 mb-1 bg-slate-100 px-1 rounded w-fit border border-slate-300">
                รหัส: {showId}
            </div>
        ) : null;
    })()}
    {/* ⭐ END: จบส่วนเพิ่มรหัส ⭐ */}

    <div className="font-bold text-black text-sm">{item.name}</div>
    <div className="mt-1 pl-2 text-xs text-gray-700">
        จำนวน: <span className="font-bold text-base">{displayQty}</span> {item.unit}
    </div>
</td>
                <td className="text-center align-middle border border-black p-2">
                    {item.subJob || item.matCode ? (
                        <div className="flex flex-col gap-1 text-xs font-bold">
                            {item.subJob && <span>Sub: {item.subJob}</span>}
                            {/* เปลี่ยน EP: เป็น Mat.: */}
{item.matCode && <span>Mat.: {item.matCode}</span>}
                        </div>
                    ) : '-'}
                </td>
                <td className="text-left align-top border border-black p-2">
                    <div className="font-bold text-center mb-1 bg-gray-50 rounded border border-gray-200 text-xs py-0.5">
                        {formatDateTh(selectedRequest.dateRequired)}
                    </div>
                    {item.note && <div className="text-xs text-gray-600 border-t border-dotted border-gray-300 pt-1 mt-1 leading-snug">{item.note}</div>}
                    
                    {/* ⭐ Logic แสดงหมายเหตุ Partial (รับของบางส่วน) */}
                    {isPartial && !isJobClosed && (
                        received > 0 ? (
                            // กรณีรับแล้วบางส่วน
                            <div className="mt-2 text-[10px] bg-yellow-50 p-1 border border-yellow-200 rounded text-yellow-800 font-bold">
                                * รับแล้ว: {received} / ค้าง: {remaining}
                            </div>
                        ) : (
                            // กรณีรายการนี้ยังไม่ได้รับเลย
                            <div className="mt-2 text-[10px] bg-red-50 p-1 border border-red-200 rounded text-red-700 font-bold">
                                * ยังไม่ได้รับ
                            </div>
                        )
                    )}
                </td>
            </tr>
        );
    })}
</tbody>
            </table>
<div className="mt-8 signature-section break-inside-avoid">
                <div className={`grid ${selectedRequest.type === 'Withdraw' ? 'grid-cols-3' : 'grid-cols-4'} gap-4 text-center`}>
                    
                    {/* 1. ผู้ขอ */}
                    <div className="border border-black p-2 h-36 flex flex-col justify-between relative bg-white">
                        <div className="text-sm font-bold border-b border-gray-200 pb-1 mb-1">ผู้ขอ (Requester)</div>
                        <div className="flex-1 flex items-center justify-center">
                            {sigReq ? <img src={sigReq} className="max-h-16 max-w-full object-contain"/> : <span className="text-gray-300 text-xs">(เซ็นชื่อ)</span>}
                        </div>
                        <div className="border-t border-dotted border-black mt-1 pt-1 text-xs">
                            <div className="font-bold">{nameReq}</div>
                            <div>วันที่: {dateReq}</div>
                        </div>
                    </div>

                    {/* 2. สโตร์ (ผู้จ่ายของ หรือ ผู้รับของ) */}
                    <div className="border border-black p-2 h-36 flex flex-col justify-between bg-white">
                        {/* ⭐ แสดงชื่อหัวข้อตามเงื่อนไข (storeLabel) */}
                        <div className="text-sm font-bold border-b border-gray-200 pb-1 mb-1">{storeLabel}</div>
                        <div className="flex-1 flex items-center justify-center">
                            {/* ⭐ แสดงลายเซ็น (sigStore) */}
                            {sigStore ? 
                                <img src={sigStore} className="max-h-16 max-w-full object-contain"/> : 
                                <span className="text-gray-300 text-xs">..........................</span>
                            }
                        </div>
                        <div className="border-t border-dotted border-black mt-1 pt-1 text-xs">
                            <div className="font-bold">{nameStore}</div>
                            <div>วันที่: {dateStore}</div>
                        </div>
                    </div>

                    {/* 3. ผู้อนุมัติ L1 */}
                    <div className="border border-black p-2 h-36 flex flex-col justify-between bg-white">
                        <div className="text-sm font-bold border-b border-gray-200 pb-1 mb-1">
                            {['Withdraw', 'Borrow'].includes(selectedRequest.type) ? 'ผู้อนุมัติ' : 'ผู้อนุมัติ (Level 1)'}
                        </div>
                        <div className="flex-1 flex items-center justify-center">
                            {sigL1 ? <img src={sigL1} className="max-h-16 max-w-full object-contain"/> : <span className="text-gray-300 text-xs">..........................</span>}
                        </div>
                        <div className="border-t border-dotted border-black mt-1 pt-1 text-xs">
                            <div className="font-bold">{nameL1}</div>
                            <div>วันที่: {dateL1}</div>
                        </div>
                    </div>

                    {/* 4. ผู้อนุมัติ L2 (แสดงเฉพาะงานซื้อ) */}
                    {selectedRequest.type !== 'Withdraw' && (
                        <div className="border border-black p-2 h-36 flex flex-col justify-between bg-white">
                            <div className="text-sm font-bold border-b border-gray-200 pb-1 mb-1">ผู้อนุมัติ (Level 2)</div>
                            <div className="flex-1 flex items-center justify-center">
                                {sigL2 ? <img src={sigL2} className="max-h-16 max-w-full object-contain"/> : <span className="text-gray-300 text-xs">..........................</span>}
                            </div>
                            <div className="border-t border-dotted border-black mt-1 pt-1 text-xs">
                                <div className="font-bold">{nameL2}</div>
                                <div>วันที่: {dateL2}</div>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </>
        );
    })()}
</>

                            )}
                            </>
                        );
                    })()}
                </div>
            </div>
        </div>
      )}

{/* ⭐ FULLSCREEN IMAGE VIEWER (With Download) ⭐ */}
      {viewingAttachments && (
         <div className="fixed inset-0 bg-black/95 z-[200] flex flex-col justify-center p-4 backdrop-blur-sm animate-in fade-in">
            
            {/* Header Clean Style */}
            <div className="flex justify-between items-center text-white mb-4 px-2 max-w-4xl mx-auto w-full">
               <h2 className="text-lg font-bold flex items-center gap-2">
                   <ImageIcon className="w-5 h-5"/> รูปภาพแนบ ({viewingAttachments.attachments.length})
               </h2>
               
               <button 
                   onClick={() => setViewingAttachments(null)} 
                   className="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors text-gray-300 hover:text-white"
                   title="ปิดหน้าต่าง"
               >
                   <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
               </button>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto space-y-6 px-2 pb-10 w-full max-w-4xl mx-auto">
               {viewingAttachments.attachments.map((att, idx) => (
                  <div key={idx} className="bg-zinc-900 rounded-xl overflow-hidden border border-zinc-800 flex flex-col items-center shadow-2xl">
                     
                     {/* Image Display */}
                     {(att.type?.startsWith('image/') || att.name?.match(/\.(jpg|jpeg|png|gif)$/i)) ? (
                        <div className="w-full relative min-h-[300px] bg-black flex items-center justify-center">
                            <img 
                                src={getDriveImageUrl(att.url || att.base64 || att.data)} 
                                alt={att.name} 
                                className="w-auto max-w-full max-h-[85vh] object-contain" 
                                onError={(e) => {
                                    e.target.style.display = 'none'; 
                                    e.target.nextSibling.style.display = 'flex'; 
                                }} 
                            />
                            {/* Error Placeholder */}
                            <div className="hidden flex-col items-center justify-center text-zinc-500 py-10">
                                <AlertCircle className="w-10 h-10 mb-2"/>
                                <span className="text-sm">ไม่สามารถโหลดรูปภาพได้</span>
                            </div>
                        </div>
                     ) : (
                        <div className="p-10 flex flex-col items-center justify-center text-zinc-400 gap-3 w-full bg-zinc-800/50">
                           <FileText className="w-12 h-12 text-blue-400"/>
                           <span className="text-sm font-bold">{att.name}</span>
                        </div>
                     )}

                     {/* Footer: Name & Download Button */}
                     <div className="w-full bg-zinc-950 p-3 border-t border-zinc-800 flex justify-between items-center gap-4">
                         <p className="text-xs text-zinc-400 font-mono truncate flex-1 text-left">
                             {idx + 1}. {att.name}
                         </p>
                         
                         {/* ⭐ ปุ่มดาวน์โหลด */}
                         <a 
                             href={getDownloadUrl(att.url || att.base64 || att.data)} 
                             target="_blank" 
                             download={att.name} // attribute นี้ทำงานได้ดีกับไฟล์ Base64
                             className="flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 hover:text-white px-3 py-1.5 rounded-lg transition-colors text-xs font-bold"
                             title="ดาวน์โหลดไฟล์นี้"
                         >
                             <Download className="w-4 h-4"/> ดาวน์โหลด
                         </a>
                     </div>
                  </div>
               ))}
            </div>
         </div>
      )}

{showImportAssetModal && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-in fade-in">
        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden">
            
            {/* ⭐⭐⭐ เพิ่มส่วนนี้: สร้างรายการตัวเลือกผู้ใช้ ⭐⭐⭐ */}
            <datalist id="import-user-list">
                {allUsers.map((u, i) => (
                    <option key={i} value={`${u.firstName} ${u.lastName}`}>{u.empId}</option>
                ))}
            </datalist>
                  
                  {/* Header */}
                  <div className="px-6 py-4 border-b flex justify-between items-center bg-white">
                      <h3 className="font-bold text-lg text-green-700 flex items-center gap-2">
                          <FileText className="w-5 h-5"/> นำเข้าข้อมูลทรัพย์สิน (Import CSV)
                      </h3>
                      <button onClick={() => setShowImportAssetModal(false)} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100">
                          <X className="w-6 h-6"/>
                      </button>
                  </div>

                  {/* Body */}
                  <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                      
                     <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 text-sm text-blue-800">
    <h4 className="font-bold mb-2 flex items-center gap-2"><Info className="w-4 h-4"/> รูปแบบไฟล์ CSV</h4>
    <p className="mb-2">เรียงคอลัมน์ดังนี้ (12 ช่อง):</p>
    <div className="bg-white border border-blue-100 p-3 rounded font-mono text-xs overflow-x-auto whitespace-nowrap mb-2 text-slate-600">
        รหัสทรัพย์สิน, ชื่อรายการ, ซีเรียลนัมเบอร์, ประเภท, ราคา, หน่วย, วันเริ่มสัญญา, วันสิ้นสุดสัญญา, สถานะ, ผู้ถือครอง, หมายเหตุ, ชื่อโครงการ
    </div>
    <div className="grid grid-cols-2 md:grid-cols-3 gap-x-8 gap-y-1 text-xs text-blue-700 list-disc pl-4">
        <li><b>รหัสทรัพย์สิน:</b> ว่างไว้ = Auto Gen (ห้ามซ้ำ)</li>
        <li><b>ชื่อรายการ:</b> ห้ามว่าง</li>
        <li><b>ซีเรียลนัมเบอร์:</b> ห้ามว่าง</li>
        <li><b>ประเภท:</b> <code>บริษัท</code> หรือ <code>เช่า</code></li>
        <li><b>ราคา:</b> ตัวเลขราคา</li>
        <li><b>หน่วย:</b> บาท, บาท/วัน, บาท/เดือน, บาท/ปี</li>
        <li><b>เริ่ม/สิ้นสุด:</b> 31/01/2567 หรือ 2024-01-31</li>
        <li><b>สถานะ:</b> <code>ว่าง</code>, <code>ถูกยืม</code>, <code>สูญหาย</code>, <code>ชำรุด</code></li>
        <li><b>ผู้ถือครอง:</b> จำเป็นถ้าสถานะคือ 'ถูกยืม'</li>
        <li><b>หมายเหตุ:</b> บันทึกลงประวัติ</li>
        <li><b>ชื่อโครงการ:</b> ต้องตรงกับในระบบ</li>
    </div>
</div>

                      <div className="mb-6">
                          <div className="flex items-center gap-3">
                              <label className="cursor-pointer bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow-md transition-all flex items-center gap-2 font-bold">
                                  <Upload className="w-4 h-4"/> เลือกไฟล์ CSV...
                                  <input type="file" accept=".csv" className="hidden" onChange={handleFileImport} />
                              </label>
                              <span className="text-sm text-gray-600 font-medium">{importFileName || 'ยังไม่ได้เลือกไฟล์'}</span>
                          </div>
                      </div>

                      {/* ⭐ Preview Table (Editable) - ปรับปรุง Layout & Logic Company */}
                     {/* ⭐ Preview Table (Editable + Expandable) */}
                      {importData.length > 0 && (
                          <div 
                              className={`transition-all duration-200 ${
                                  isImportAssetTableExpanded 
                                      ? "fixed inset-0 z-[200] bg-white flex flex-col" // โหมดเต็มจอ
                                      : "bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm relative" // โหมดปกติ
                              }`}
                          >
                              {/* Table Header */}
                              <div className="px-4 py-3 bg-gray-100 border-b border-gray-200 text-xs font-bold text-gray-600 flex justify-between items-center shrink-0">
                                  <div className="flex items-center gap-2">
                                      <span>ตัวอย่างข้อมูล ({importData.length} รายการ) - แก้ไขได้</span>
                                      {/* ปุ่มขยาย/ย่อ */}
                                      <button 
                                          onClick={() => setIsImportAssetTableExpanded(!isImportAssetTableExpanded)}
                                          className="flex items-center gap-1 bg-white border border-gray-300 px-2 py-0.5 rounded hover:bg-blue-50 text-blue-600 transition-colors shadow-sm"
                                          title={isImportAssetTableExpanded ? "ย่อกลับ (Minimize)" : "ขยายเต็มจอ (Maximize)"}
                                      >
                                          {isImportAssetTableExpanded ? (
                                              <>
                                                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" y1="10" x2="21" y2="3"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
                                                  <span>ย่อลง</span>
                                              </>
                                          ) : (
                                              <>
                                                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
                                                  <span>ขยาย</span>
                                              </>
                                          )}
                                      </button>
                                  </div>
                                  
                                  <span className="text-orange-600 flex items-center gap-1"><AlertTriangle className="w-3 h-3"/> ตรวจสอบและแก้ไขก่อนยืนยัน</span>
                              </div>

                              {/* Table Content */}
                              <div className={`overflow-x-auto ${isImportAssetTableExpanded ? 'flex-1 p-4 bg-slate-50' : 'max-h-[450px]'}`}>
                                  <table className={`w-full text-xs text-left whitespace-nowrap ${isImportAssetTableExpanded ? 'shadow-md rounded-lg overflow-hidden' : ''}`}>
                                      <thead className="bg-gray-50 text-gray-700 sticky top-0 shadow-sm z-10 font-bold uppercase">
    <tr>
        <th className="px-3 py-2 w-8 text-center bg-gray-50">#</th>
        <th className="px-3 py-2 min-w-[100px] bg-gray-50">รหัสทรัพย์สิน</th> {/* ID */}
        <th className="px-3 py-2 min-w-[180px] bg-gray-50">โครงการ</th>      {/* Project */}
        <th className="px-3 py-2 min-w-[200px] bg-gray-50">ชื่อรายการ</th>    {/* Name */}
        <th className="px-3 py-2 min-w-[100px] bg-gray-50">S/N</th>
        <th className="px-3 py-2 min-w-[120px] bg-gray-50">ประเภท</th>      {/* Type */}
        <th className="px-3 py-2 text-right min-w-[120px] bg-gray-50">ราคา</th> {/* Price */}
        <th className="px-3 py-2 min-w-[100px] bg-gray-50">หน่วย</th>       {/* Unit */}
        <th className="px-3 py-2 min-w-[140px] bg-gray-50">เริ่มสัญญา</th>    {/* Start */}
        <th className="px-3 py-2 min-w-[140px] bg-gray-50">สิ้นสุด</th>       {/* End */}
        <th className="px-3 py-2 min-w-[140px] bg-gray-50">สถานะ</th>       {/* Status */}
        <th className="px-3 py-2 min-w-[180px] bg-gray-50">ผู้ถือครอง</th>     {/* Holder */}
        <th className="px-3 py-2 min-w-[200px] bg-gray-50">หมายเหตุ</th>     {/* Note */}
        <th className="px-3 py-2 w-10 text-center bg-gray-50">ลบ</th>
    </tr>
</thead>
                                      <tbody className="divide-y divide-gray-100 bg-white">
                                          {importData.map((row, idx) => (
                                              <tr key={idx} className="hover:bg-blue-50 transition-colors group">
                                                  <td className="px-2 py-2 text-gray-400 text-center">{idx + 1}</td>
                                                  
                                                  {/* ID */}
                                                  <td className="px-2 py-1">
                                                      <input 
                                                          type="text" className={`w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none font-mono text-blue-600 ${row.id && assets.some(a => a.id === row.id) ? 'text-red-600 font-bold' : ''}`}
                                                          value={row.id} 
                                                          placeholder="Auto"
                                                          onChange={e => {
                                                              const newData = [...importData]; newData[idx].id = e.target.value; setImportData(newData);
                                                          }}
                                                      />
                                                      {row.id && assets.some(a => a.id === row.id) && <span className="text-[9px] text-red-500 block">ซ้ำ!</span>}
                                                  </td>

                                                  {/* Project */}
                                                  <td className="px-2 py-1">
                                                       <select 
                                                          className={`w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none ${!projects.some(p => p.name === row.project) ? 'text-red-600 font-bold' : 'text-indigo-600'}`}
                                                          value={row.project}
                                                          onChange={e => { const newData = [...importData]; newData[idx].project = e.target.value; setImportData(newData); }}
                                                      >
                                                          <option value="">เลือก...</option>
                                                          {projects.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                                                       </select>
                                                  </td>

                                                  {/* Name */}
                                                  <td className="px-2 py-1"><input type="text" className={`w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none ${!row.name ? 'bg-red-50' : ''}`} value={row.name} onChange={e => { const newData = [...importData]; newData[idx].name = e.target.value; setImportData(newData); }}/></td>
                                                  
                                                  {/* Serial */}
                                                  <td className="px-2 py-1"><input type="text" className={`w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none ${!row.serial ? 'bg-red-50' : ''}`} value={row.serial} onChange={e => { const newData = [...importData]; newData[idx].serial = e.target.value; setImportData(newData); }}/></td>
                                                  
                                                  {/* Type */}
                                                  <td className="px-2 py-1">
    <select className="w-full bg-transparent outline-none font-bold text-gray-700" 
            value={row.ownerType} 
            onChange={e => { 
                const newData = [...importData];
                newData[idx].ownerType = e.target.value; 
                setImportData(newData);
            }}>
        <option value="Company">บริษัท (Company)</option>
        <option value="Rent">เช่า (Rent)</option>
    </select>
</td>

                                                  {/* Price */}
                                                  <td className="px-2 py-1"><input type="number" className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none text-right font-mono" value={row.price} onChange={e => { const newData = [...importData]; newData[idx].price = parseFloat(e.target.value) || 0; setImportData(newData); }}/></td>
                                                  
                                                  {/* Unit */}
<td className="px-2 py-1">
    {row.ownerType === 'Company' ? (
        // กรณีบริษัท: แสดงคำว่า "บาท"
        <input type="text" className="w-full bg-gray-50 text-gray-500 text-center cursor-not-allowed border-none text-xs" value="บาท" disabled />
    ) : (
        // กรณีเช่า: เลือกหน่วยเวลา (แสดงภาษาไทย แต่ value เป็นภาษาอังกฤษ)
        <select className="w-full bg-transparent outline-none" 
                value={row.rentalUnit} 
                onChange={e => { 
                    const newData = [...importData]; 
                    newData[idx].rentalUnit = e.target.value; 
                    setImportData(newData); 
                }}>
            <option value="Month">เดือน</option>
            <option value="Day">วัน</option>
            <option value="Year">ปี</option>
        </select>
    )}
</td>

                                                  {/* Start */}
                                                  <td className="px-2 py-1"><input type="text" placeholder="YYYY-MM-DD" className={`w-full border-b border-transparent outline-none ${row.ownerType === 'Company' ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-transparent text-gray-600 focus:border-blue-500'}`} value={row.rentalStart || ''} onChange={e => { const newData = [...importData]; newData[idx].rentalStart = e.target.value; setImportData(newData); }} disabled={row.ownerType === 'Company'}/></td>
                                                  
                                                  {/* End */}
                                                  <td className="px-2 py-1"><input type="text" placeholder="YYYY-MM-DD" className={`w-full border-b border-transparent outline-none ${row.ownerType === 'Company' ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-transparent text-gray-600 focus:border-blue-500'}`} value={row.rentalEnd || ''} onChange={e => { const newData = [...importData]; newData[idx].rentalEnd = e.target.value; setImportData(newData); }} disabled={row.ownerType === 'Company'}/></td>

                                                 {/* Status Dropdown */}
<td className="px-2 py-1">
    <select className={`w-full bg-transparent outline-none font-bold ${row.status === 'Available' ? 'text-green-700' : 'text-blue-700'}`} 
            value={row.status} 
            onChange={e => { 
                const newData = [...importData];
                newData[idx].status = e.target.value;
                setImportData(newData); 
            }}>
        <option value="Available">ว่าง (Available)</option>
        <option value="Borrowed">ถูกยืม (Borrowed)</option>
        <option value="Lost">สูญหาย (Lost)</option>
        <option value="Damaged">ชำรุด (Damaged)</option>
    </select>
</td>

                                                  {/* Holder */}
                                                  <td className="px-2 py-1">
    <input 
        type="text" 
        list="import-user-list"  // ⭐ แก้ตรงนี้: ให้ตรงกับ ID ของ datalist ด้านบน
        disabled={row.status !== 'Borrowed'} 
        className={`w-full border-b outline-none transition-colors ${row.status === 'Borrowed' ?
            (!row.holder || row.holder === '-' ? 'bg-red-50 border-red-300 text-red-600 focus:border-blue-500' : 'bg-transparent border-transparent focus:border-blue-500') : 'bg-gray-100 text-gray-400 border-transparent cursor-not-allowed'}`} 
        value={row.status === 'Borrowed' ? row.holder : ''} 
        placeholder={row.status === 'Borrowed' ? "ระบุชื่อหรือเลือก..." : "-"} 
        onChange={e => { 
            const newData = [...importData]; 
            newData[idx].holder = e.target.value;
            setImportData(newData); 
        }}
    />
</td>

                                                  {/* Note */}
                                                  <td className="px-2 py-1"><input type="text" className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none text-gray-500" value={row.note} onChange={e => { const newData = [...importData]; newData[idx].note = e.target.value; setImportData(newData); }}/></td>
                                                  
                                                  {/* Delete */}
                                                  <td className="px-2 py-1 text-center">
                                                      <button 
                                                          type="button"
                                                          onClick={() => { 
                                                              const newData = importData.filter((_, i) => i !== idx); 
                                                              setImportData(newData); 
                                                          }} 
                                                          className="text-gray-400 hover:text-red-600 p-1.5 rounded-lg hover:bg-red-50 transition-colors"
                                                          title="ลบรายการนี้"
                                                      >
                                                          {/* ⭐ ใช้ SVG แทน Component Trash2 */}
                                                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                              <path d="M3 6h18"/>
                                                              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                                              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                                              <line x1="10" x2="10" y1="11" y2="17"/>
                                                              <line x1="14" x2="14" y1="11" y2="17"/>
                                                          </svg>
                                                      </button>
                                                  </td>
                                              </tr>
                                          ))}
                                      </tbody>
                                  </table>
                              </div>

                              <button
                                  onClick={() => {
                                      const newRow = {
                                          id: '',           // Auto
                                          project: '',      // ให้เลือกเอง
                                          name: '',
                                          serial: '',
                                          ownerType: 'Company', // Default
                                          price: 0,
                                          rentalUnit: 'baht',   // Default for Company
                                          rentalStart: '',
                                          rentalEnd: '',
                                          status: 'Available',  // Default
                                          holder: '',
                                          note: ''
                                      };
                                      setImportData(prev => [...prev, newRow]);
                                  }}
                                  className="w-full py-3 bg-gray-50 hover:bg-blue-50 text-blue-600 font-bold text-xs border-t border-gray-200 flex items-center justify-center gap-2 transition-colors"
                              >
                                  <Plus className="w-4 h-4"/> เพิ่มแถวใหม่ (Add Row)
                              </button>

                          </div>
                      )}
                         
                  </div>

                  {/* Footer */}
                  <div className="p-5 border-t border-gray-100 bg-white flex gap-3 justify-end">
                      <button onClick={() => setShowImportAssetModal(false)} className="px-6 py-2.5 border border-gray-300 rounded-xl text-gray-600 font-bold hover:bg-gray-50 transition-colors">ยกเลิก</button>
                      <button 
                          onClick={confirmImportAssets} 
                          disabled={importData.length === 0}
                          className="px-6 py-2.5 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                      >
                          <Save className="w-5 h-5"/> ยืนยันนำเข้าข้อมูล
                      </button>
                  </div>
              </div>
          </div>
      )}

{/* --- ASSET GROUP MODAL (UPDATED: Clean Table & Fixed Close Button) --- */}
      {showAssetGroupModal && selectedAssetGroup && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[120] p-4 backdrop-blur-sm animate-in fade-in">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden animate-in zoom-in-95">
                  
                  {/* Header */}
                  <div className="px-6 py-4 border-b bg-white flex justify-between items-center sticky top-0 z-10">
                      <div>
                          <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2">
                              <Box className="w-6 h-6 text-purple-600"/> {selectedAssetGroup.name}
                          </h3>
                          <div className="flex gap-3 text-xs mt-1">
                              <span className="text-gray-500">ทั้งหมด: <b className="text-gray-800">{selectedAssetGroup.totalQty}</b></span>
                              <span className="text-blue-600 bg-blue-50 px-2 py-0.5 rounded">บริษัท: <b>{selectedAssetGroup.companyQty}</b></span>
                              <span className="text-orange-600 bg-orange-50 px-2 py-0.5 rounded">เช่า: <b>{selectedAssetGroup.rentQty}</b></span>
                          </div>
                      </div>
                      
                      {/* ⭐ ปุ่มปิดหน้าต่าง (ใช้ SVG แบบเดียวกับหน้ารายละเอียด) */}
                      <button 
                          onClick={() => setShowAssetGroupModal(false)} 
                          className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
                          title="ปิดหน้าต่าง"
                      >
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                              <line x1="18" y1="6" x2="6" y2="18"></line>
                              <line x1="6" y1="6" x2="18" y2="18"></line>
                          </svg>
                      </button>
                  </div>

                  {/* List of Items */}
                  <div className="flex-1 overflow-y-auto p-0">
                      <table className="w-full text-sm text-left">
                          <thead className="bg-gray-50 text-gray-600 sticky top-0 shadow-sm border-b border-gray-200">
                              <tr>
                                  <th className="px-6 py-3 font-semibold">ID</th>
                                  
                                  {/* ⭐ เพิ่มหัวตาราง Project */}
                                  <th className="px-6 py-3 font-semibold text-left">Project</th>

                                  <th className="px-6 py-3 font-semibold">Serial</th>
                                  <th className="px-6 py-3 font-semibold">Type</th>
                                  <th className="px-6 py-3 font-semibold text-center">Status</th>
                                  <th className="px-6 py-3 font-semibold">Holder</th>
                              </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-100">
                              {selectedAssetGroup.items.map((item, idx) => (
                                  <tr key={idx} className="hover:bg-blue-50 transition-colors cursor-pointer group" 
                                      onClick={() => {
                                          openViewItem(item);
                                      }}
                                  >
                                      <td className="px-6 py-4 font-mono text-blue-600 font-bold group-hover:underline">{item.id}</td>
                                      
                                      {/* ⭐ เพิ่มข้อมูล Project */}
                                      <td className="px-6 py-4">
                                          <span className="bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-100 text-xs font-bold">
                                              {item.project || 'ส่วนกลาง'}
                                          </span>
                                      </td>

                                      <td className="px-6 py-4 text-gray-600">{item.serial || '-'}</td>
                                      <td className="px-6 py-4">
                                          <span className={`px-2 py-1 rounded text-xs font-bold ${item.ownerType === 'Rent' ? 'bg-orange-100 text-orange-700' : 'bg-indigo-100 text-indigo-700'}`}>
                                              {item.ownerType}
                                          </span>
                                      </td>
                                      <td className="px-6 py-4 text-center">
    <span className={`px-2 py-1 rounded text-xs font-bold ${
        item.status === 'Available' ? 'bg-green-100 text-green-700' :
        item.status === 'Borrowed' ? 'bg-orange-100 text-orange-700' : 'bg-gray-100'
    }`}>
        {/* แก้ไขบรรทัดนี้ */}
        {ASSET_STATUS_LABELS[item.status] || item.status}
    </span>
</td>
                                      <td className="px-6 py-4 text-gray-700">{item.holder}</td>
                                  </tr>
                              ))}
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      )}

{/* --- IMPORT INVENTORY MODAL (UPDATED NO ID) --- */}
      {showImportInvModal && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-in fade-in">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden">
                  
                  {/* Header */}
                  <div className="px-6 py-4 border-b flex justify-between items-center bg-white">
                      <h3 className="font-bold text-lg text-teal-700 flex items-center gap-2">
                          <FileText className="w-5 h-5"/> นำเข้าสินค้า (Import Inventory CSV)
                      </h3>
                      <button onClick={() => setShowImportInvModal(false)} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100">
                          <X className="w-6 h-6"/>
                      </button>
                  </div>

                {/* Body */}
<div className="flex-1 overflow-y-auto p-6 bg-slate-50">
    
    <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 text-sm text-blue-800">
        <h4 className="font-bold mb-2 flex items-center gap-2"><Info className="w-4 h-4"/> รูปแบบไฟล์ CSV (ภาษาไทยรองรับ)</h4>
        <p className="mb-2">เรียงคอลัมน์ดังนี้ (9 ช่อง):</p>
        <div className="bg-white border border-blue-100 p-3 rounded font-mono text-xs overflow-x-auto whitespace-nowrap mb-2 text-slate-600">
            รหัสวัสดุ, ชื่อสินค้า, ประเภท, จำนวน, หน่วย, ขั้นต่ำ, ราคา, หมายเหตุ, โครงการ
        </div>
        <div className="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-1 text-xs text-blue-700 list-disc pl-4">
            <li><b>รหัสวัสดุ:</b> ว่างไว้ = ระบบสร้างให้อัตโนมัติ (INV-xxx)</li>
            <li><b>ชื่อสินค้า:</b> ห้ามว่าง (ถ้ามีในระบบแล้ว = เพิ่มยอด)</li>
            <li><b>ประเภท:</b> ในระบบ, นอกระบบ (หรือ System, NonSystem)</li>
            <li><b>จำนวน:</b> ตัวเลขจำนวนที่รับเข้า</li>
            <li><b>หน่วย:</b> หน่วยนับ (ค่าเริ่มต้น: ชิ้น)</li>
            <li><b>ขั้นต่ำ:</b> จุดสั่งซื้อ (Min Stock)</li>
            <li><b>ราคา:</b> ราคาต่อหน่วย</li>
            <li><b>หมายเหตุ:</b> รายละเอียดเพิ่มเติม</li>
            <li><b>โครงการ:</b> ชื่อโครงการ (ต้องตรงกับในระบบ)</li>
        </div>
    </div>

    <div className="mb-6">
        <div className="flex items-center gap-3">
            <label className="cursor-pointer bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg shadow-md transition-all flex items-center gap-2 font-bold">
                <Upload className="w-4 h-4"/> เลือกไฟล์ CSV...
                <input type="file" accept=".csv" className="hidden" onChange={handleInvFileImport} />
            </label>
            <span className="text-sm text-gray-600 font-medium">{importInvFileName || 'ยังไม่ได้เลือกไฟล์'}</span>
        </div>
    </div>

    {/* Table Preview */}
    {importInvData.length > 0 && (
        <div className={`transition-all duration-200 ${isImportInvTableExpanded ? "fixed inset-0 z-[200] bg-white flex flex-col" : "bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm relative"}`}>
            {/* Header Table */}
            <div className="px-4 py-3 bg-gray-100 border-b border-gray-200 text-xs font-bold text-gray-600 flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2">
                    <span>ตัวอย่างข้อมูล ({importInvData.length} รายการ) - แก้ไขได้</span>
                    <button onClick={() => setIsImportInvTableExpanded(!isImportInvTableExpanded)} className="flex items-center gap-1 bg-white border border-gray-300 px-2 py-0.5 rounded hover:bg-blue-50 text-blue-600 transition-colors shadow-sm">
                        {isImportInvTableExpanded ? <span>ย่อลง</span> : <span>ขยาย</span>}
                    </button>
                </div>
                <span className="text-orange-600 flex items-center gap-1"><AlertTriangle className="w-3 h-3"/> รหัสวัสดุ: ว่าง = Auto Gen</span>
            </div>

            {/* Table Content */}
            <div className={`overflow-x-auto ${isImportInvTableExpanded ? 'flex-1 p-4 bg-slate-50' : 'max-h-[450px]'}`}>
                <table className={`w-full text-xs text-left whitespace-nowrap ${isImportInvTableExpanded ? 'shadow-md rounded-lg overflow-hidden' : ''}`}>
                    <thead className="bg-gray-50 text-gray-700 sticky top-0 shadow-sm z-10 font-bold uppercase">
                        <tr>
                            <th className="px-3 py-2 w-8 text-center bg-gray-50">#</th>
                            <th className="px-3 py-2 min-w-[100px] bg-gray-50">รหัสวัสดุ</th>
                            <th className="px-3 py-2 min-w-[150px] bg-gray-50">ชื่อสินค้า</th>
                            <th className="px-3 py-2 min-w-[120px] bg-gray-50">โครงการ</th>
                            <th className="px-3 py-2 w-28 bg-gray-50">ประเภท</th>
                            <th className="px-3 py-2 w-20 text-center bg-gray-50">จำนวน</th>
                            <th className="px-3 py-2 w-20 bg-gray-50">หน่วย</th>
                            <th className="px-3 py-2 w-20 text-center bg-gray-50">ขั้นต่ำ</th>
                            <th className="px-3 py-2 w-24 text-right bg-gray-50">ราคา</th>
                            <th className="px-3 py-2 min-w-[150px] bg-gray-50">หมายเหตุ</th>
                            <th className="px-3 py-2 w-10 text-center bg-gray-50">ลบ</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100 bg-white">
                        {importInvData.map((row, idx) => {
                            // เช็คว่ามีของเดิมหรือไม่
                            const existing = inventory.find(i => i.name === row.name && i.project === row.project);
                            const isDuplicate = !!existing;
                            
                            // เช็คว่ารหัสตรงกันหรือไม่ (ถ้ามีของเดิม และใน CSV ใส่รหัสมา)
                            const isIdMismatch = isDuplicate && row.id && row.id !== existing.id;

                            return (
                                <tr key={idx} className={`hover:bg-blue-50 transition-colors group ${isDuplicate ? 'bg-yellow-50' : ''}`}>
                                    <td className="px-2 py-2 text-gray-400 text-center">{idx + 1}</td>
                                    
                                    {/* ID (รหัสวัสดุ) */}
                                    <td className="px-2 py-1 relative">
                                        <input 
    type="text" 
    // ... class ...
    // ⭐ Value: แสดงแค่รหัสสั้น
    value={getDisplayId(row.id)} 
    placeholder={existing ? getDisplayId(existing.id) : "Auto"}
    onChange={e => { const n = [...importInvData]; n[idx].id = e.target.value; setImportInvData(n); }}
/>
                                        
                                        
                                        
                                        {/* ปุ่มดึงรหัสเดิม (ถ้าไม่ตรง หรือ ว่างอยู่) */}
{isDuplicate && row.id !== getDisplayId(existing.id) && (
    <button 
        onClick={() => { 
        const n = [...importInvData]; 
        // ⭐ ใช้ getDisplayId ดึงแค่รหัสสั้นมาใส่
        n[idx].id = getDisplayId(existing.id); 
        setImportInvData(n); 
    }}
        className="absolute right-0 top-1 text-[9px] bg-green-100 text-green-700 px-1 rounded border border-green-200 hover:bg-green-200"
        title="คลิกเพื่อใช้รหัสเดิมในระบบ"
    >
        ใช้รหัสเดิม
    </button>
)}
                                    </td>

                                    {/* Name */}
                                    <td className="px-2 py-1"><input type="text" className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none font-bold text-gray-800" value={row.name} onChange={e => { const n = [...importInvData]; n[idx].name = e.target.value; setImportInvData(n); }}/></td>

                                    {/* Project */}
                                    <td className="px-2 py-1">
                                        <select className={`w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none ${!projects.some(p => p.name === row.project) ? 'text-red-600 font-bold' : 'text-blue-600'}`} value={row.project} onChange={e => { const n = [...importInvData]; n[idx].project = e.target.value; setImportInvData(n); }}>
                                            <option value="">เลือก...</option>
                                            {projects.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                                        </select>
                                    </td>

                                    {/* Type */}
                                    <td className="px-2 py-1">
                                        <select className={`w-full bg-transparent outline-none font-bold ${row.stockType === 'NonSystem' ? 'text-orange-600' : 'text-blue-600'}`} value={row.stockType} onChange={e => { const n = [...importInvData]; n[idx].stockType = e.target.value; setImportInvData(n); }}>
                                            <option value="System">ในระบบ</option>
                                            <option value="NonSystem">นอกระบบ</option>
                                        </select>
                                    </td>

                                    {/* Qty */}
                                    <td className="px-2 py-1"><input type="number" className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none text-center font-bold text-blue-600" value={row.qty} onChange={e => { const n = [...importInvData]; n[idx].qty = parseInt(e.target.value)||0; setImportInvData(n); }}/></td>
                                    
                                    {/* Unit */}
                                    <td className="px-2 py-1">
                                        <input type="text" list="unit-list" className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none" value={row.unit} onChange={e => { const n = [...importInvData]; n[idx].unit = e.target.value; setImportInvData(n); }}/>
                                        <datalist id="unit-list">{ITEM_UNITS.map(u => <option key={u} value={u}/>)}</datalist>
                                    </td>

                                    {/* Min */}
                                    <td className="px-2 py-1"><input type="number" className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none text-center" value={row.minStock} onChange={e => { const n = [...importInvData]; n[idx].minStock = parseInt(e.target.value)||0; setImportInvData(n); }}/></td>
                                    
                                    {/* Price */}
                                    <td className="px-2 py-1"><input type="number" className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none text-right font-mono" value={row.price} onChange={e => { const n = [...importInvData]; n[idx].price = parseFloat(e.target.value)||0; setImportInvData(n); }}/></td>
                                    
                                    {/* Note */}
                                    <td className="px-2 py-1"><input type="text" className="w-full bg-transparent border-b border-transparent focus:border-blue-500 outline-none text-gray-500" value={row.note} onChange={e => { const n = [...importInvData]; n[idx].note = e.target.value; setImportInvData(n); }}/></td>

                                    {/* Delete */}
                                    <td className="px-2 py-1 text-center">
                                        <button onClick={() => { const n = importInvData.filter((_, i) => i !== idx); setImportInvData(n); }} className="text-gray-400 hover:text-red-600 p-1.5 rounded-lg hover:bg-red-50 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                        </button>
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>

            <button
                onClick={() => {
                    const newRow = {
                        id: '', // Auto
                        project: '', 
                        name: '',
                        stockType: 'System', 
                        qty: 0,
                        unit: 'ชิ้น',
                        minStock: 0,
                        price: 0,
                        note: ''
                    };
                    setImportInvData(prev => [...prev, newRow]);
                }}
                className="w-full py-3 bg-gray-50 hover:bg-blue-50 text-blue-600 font-bold text-xs border-t border-gray-200 flex items-center justify-center gap-2 transition-colors"
            >
                <Plus className="w-4 h-4"/> เพิ่มแถวใหม่
            </button>
        </div>
    )}
</div>

                  {/* Footer */}
                  <div className="p-5 border-t border-gray-100 bg-white flex gap-3 justify-end">
                      <button onClick={() => setShowImportInvModal(false)} className="px-6 py-2.5 border border-gray-300 rounded-xl text-gray-600 font-bold hover:bg-gray-50 transition-colors">ยกเลิก</button>
                      <button 
                          onClick={confirmImportInventory} 
                          disabled={importInvData.length === 0}
                          className="px-6 py-2.5 bg-teal-600 text-white rounded-xl font-bold hover:bg-teal-700 shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                      >
                          <Save className="w-5 h-5"/> ยืนยันนำเข้าข้อมูล
                      </button>
                  </div>
              </div>
          </div>
      )}

      {/* --- PERMISSION MODAL --- */}
      {showPermissionModal && selectedUserForEdit && (
          <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[200] p-4 backdrop-blur-sm animate-in fade-in">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden">
                  
                  {/* ... Header ... */}
                  <div className="px-6 py-4 border-b bg-white flex justify-between items-center">
                      <div>
                          <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2">
                              <ShieldCheck className="w-6 h-6 text-blue-600"/> จัดการสิทธิ์: {selectedUserForEdit.firstName} {selectedUserForEdit.lastName}
                          </h3>
                          <p className="text-sm text-gray-500 mt-1">กำหนดสิทธิ์การใช้งานแยกตามโครงการ</p>
                      </div>
                      <button onClick={() => setShowPermissionModal(false)}><X className="w-6 h-6 text-gray-400 hover:text-gray-600"/></button>
                  </div>

                  <div className="flex-1 flex overflow-hidden">
                      {/* Left: Project List */}
                      <div className="w-1/4 bg-gray-50 border-r overflow-y-auto">
                          {projects.map(p => (
                              <button 
                                  key={p.id}
                                  onClick={() => setPermissionTab(p.name)}
                                  className={`w-full text-left px-4 py-3 text-sm font-bold border-b transition-colors flex justify-between items-center ${permissionTab === p.name ? 'bg-white text-blue-600 border-l-4 border-l-blue-600 shadow-sm' : 'text-gray-600 hover:bg-gray-100'}`}
                              >
                                  {p.name}
                                  <span className="bg-gray-200 text-gray-600 text-[10px] px-2 py-0.5 rounded-full">
                                      {(selectedUserForEdit.permissions?.[p.name] || []).length}
                                  </span>
                              </button>
                          ))}
                      </div>

                      {/* Right: Checkboxes List */}
                      <div className="flex-1 overflow-y-auto p-6 bg-white">
                          <div className="flex justify-between items-center mb-4">
                              <h4 className="font-bold text-lg text-gray-800">สิทธิ์ในโครงการ: <span className="text-blue-600">{permissionTab}</span></h4>
                              {/* ปุ่ม Select All / Clear (แสดงเฉพาะคนที่มีสิทธิ์แก้ Admin=2) */}
                              {hasPermission(2, permissionTab) && (
                                  <div className="space-x-2">
                                      <button onClick={() => {
    // ⭐ แก้ไข: เลือกทั้งหมด แต่ยกเว้น 1 (Read Only) และ 2 (Admin)
    const allIds = Object.keys(PERMISSIONS).map(Number).filter(id => id !== 1 && id !== 2);
    
    const newPerms = { ...selectedUserForEdit.permissions, [permissionTab]: allIds };
    setSelectedUserForEdit({ ...selectedUserForEdit, permissions: newPerms });
}} className="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100">เลือกทั้งหมด</button>
                                      <button onClick={() => {
                                          const newPerms = { ...selectedUserForEdit.permissions, [permissionTab]: [] };
                                          setSelectedUserForEdit({ ...selectedUserForEdit, permissions: newPerms });
                                      }} className="text-xs bg-gray-100 text-gray-600 px-3 py-1.5 rounded hover:bg-gray-200">ล้าง</button>
                                  </div>
                              )}
                          </div>
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
{Object.entries(PERMISSIONS).map(([id, label]) => {
    const permId = parseInt(id);
    const currentProjectPerms = selectedUserForEdit.permissions?.[permissionTab] || [];
    const isChecked = currentProjectPerms.includes(permId);

    // 1. ตรวจสอบสิทธิ์การแก้ไข (Edit Logic)
    let canEdit = false;
    if (user.isSuperAdmin) canEdit = true;
    else if (hasPermission(2, permissionTab)) canEdit = true;
    else if (hasPermission(3, permissionTab)) {
        if ([4, 5, 6, 7].includes(permId)) canEdit = true;
    }

    // 2. Logic ล็อกปุ่ม (Lock Logic)
    const hasReadOnly = currentProjectPerms.includes(1);
    const hasAdmin = currentProjectPerms.includes(2);
    
    let isLocked = false;
    // ถ้ามีสิทธิ์ "ดูอย่างเดียว" หรือ "Admin" อยู่ -> ล็อกข้ออื่นทั้งหมด
    if ((hasReadOnly && permId !== 1) || (hasAdmin && permId !== 2)) {
        isLocked = true;
    }

    const isInteractive = canEdit && !isLocked;

    return (
        <label key={id} className={`flex items-start gap-3 p-3 rounded-lg border transition-all ${isInteractive ? 'cursor-pointer hover:border-gray-300' : 'cursor-not-allowed opacity-40 bg-gray-100'} ${isChecked ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-100'}`}>
            <div className="pt-0.5">
                <input 
                    type="checkbox" 
                    className="w-4 h-4 accent-blue-600"
                    checked={isChecked}
                    disabled={!isInteractive} 
                    onChange={(e) => {
                        let newList;
                        
                        if (e.target.checked) {
                            // ⭐ กรณีติ๊กเลือก
                            if (permId === 1) {
                                // ถ้าเลือก "ดูอย่างเดียว" -> ล้างตัวอื่นออกหมด เหลือแค่ [1]
                                newList = [1];
                            } else if (permId === 2) {
                                // ถ้าเลือก "Admin" -> ล้างตัวอื่นออกหมด เหลือแค่ [2]
                                newList = [2];
                            } else {
                                // ถ้าเลือกตัวอื่น -> เพิ่มเข้าไปปกติ (เอา 1, 2 ออกกันเหนียว)
                                newList = [...currentProjectPerms.filter(x => x !== 1 && x !== 2), permId];
                            }
                        } else {
                            // ⭐ กรณีเอาติ๊กออก
                            newList = currentProjectPerms.filter(x => x !== permId);
                        }

                        setSelectedUserForEdit({
                            ...selectedUserForEdit,
                            permissions: { ...selectedUserForEdit.permissions, [permissionTab]: newList }
                        });
                    }}
                />
            </div>
            <div>
                <span className={`text-sm ${isChecked ? 'font-bold text-gray-800' : 'text-gray-600'}`}>{label}</span>
            </div>
        </label>
    );
})}
                          </div>
                      </div>
                  </div>

                  {/* Footer */}
                  <div className="p-5 border-t bg-white flex justify-end gap-3">
                      <button onClick={() => setShowPermissionModal(false)} className="px-6 py-2 border rounded-lg text-gray-600 hover:bg-gray-50">ปิด</button>
                      
          {/* ปุ่มบันทึก แสดงเฉพาะคนที่มีสิทธิ์แก้ไข (Admin หรือ Sub-Admin) */}
{(hasPermission(2, permissionTab) || hasPermission(3, permissionTab)) && (
<button 
    onClick={async () => {
        // 1. บันทึกข้อมูลลง Sheet
        google.script.run.saveUserData(selectedUserForEdit);
        
        // 2. ⭐ สร้าง Log แบบรวมทุกโครงการ (Loop ทุก Project ที่มีสิทธิ์)
        let logLines = [];
        if (selectedUserForEdit.permissions) {
            Object.entries(selectedUserForEdit.permissions).forEach(([projName, rights]) => {
                // เก็บเฉพาะโครงการที่มีสิทธิ์และชื่อไม่เป็นค่าว่าง
                if (projName && projName !== 'undefined' && rights && rights.length > 0) {
                    logLines.push(`Project: ${projName} -> Rights: [${rights.join(', ')}]`);
                }
            });
        }
        
        // รวมเป็นข้อความเดียว คั่นด้วยขึ้นบรรทัดใหม่ (\n)
        const logDetail = logLines.length > 0 ? logLines.join('\n') : 'Removed all permissions';

        await addInvLog(
            'Edit Permissions', 
            `${selectedUserForEdit.empId} ${selectedUserForEdit.firstName}`, 
            logDetail, // บันทึกแบบหลายบรรทัด
            JSON.stringify(selectedUserForEdit.permissions || {}),
            [], 
            selectedUserForEdit.id
        );

        // 3. อัปเดตหน้าจอ
        setAllUsers(prev => prev.map(u => u.id === selectedUserForEdit.id ? selectedUserForEdit : u));
        showToast('บันทึกสิทธิ์เรียบร้อย');
        setShowPermissionModal(false);
    }} 
    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md font-bold"
>
    บันทึกการเปลี่ยนแปลง
</button>
)}
                  </div>
              </div>
          </div>
      )}


{viewingUser && (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-in fade-in duration-200">
        <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden relative">
            
            {/* 1. Header & Close Button */}
            <div className="p-4 border-b flex justify-between items-center bg-gray-50 shrink-0">
                <div className="flex items-center gap-4">
                    <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-700 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg">
                        {viewingUser.firstName?.charAt(0)}
                    </div>
                    <div>
                        <h3 className="font-bold text-xl text-gray-800">{viewingUser.firstName} {viewingUser.lastName}</h3>
                        <p className="text-sm text-gray-500 font-medium">{viewingUser.empId} | {viewingUser.email}</p>
                    </div>
                </div>
                <button onClick={() => setViewingUser(null)} className="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>

            {/* 2. Tabs Navigation */}
            <div className="flex border-b bg-white px-6 pt-2 shrink-0 overflow-x-auto">
                {[
                    { id: 'info', icon: User, label: 'ข้อมูลผู้ใช้ & สิทธิ์' },
                    { id: 'history', icon: Clock, label: 'ประวัติการทำงาน' },
                    { id: 'purchase', icon: ShoppingCart, label: 'ประวัติการสั่งซื้อ' },
                    { id: 'withdraw', icon: Package, label: 'ประวัติการเบิก' },
                    { id: 'borrow', icon: Briefcase, label: 'ทรัพย์สินที่ยืมอยู่' }
                ].map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => { setUserDetailTab(tab.id); setDetailSearch(''); }}
                        className={`px-5 py-3 text-sm font-bold border-b-[3px] transition-colors flex items-center gap-2 whitespace-nowrap ${userDetailTab === tab.id ? 'border-blue-600 text-blue-700 bg-blue-50/50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}`}
                    >
                        <tab.icon size={16}/> {tab.label}
                    </button>
                ))}
            </div>

            {/* 3. Search Bar Area */}
            {(userDetailTab === 'history' || userDetailTab === 'purchase' || userDetailTab === 'withdraw' || userDetailTab === 'borrow') && (
                <div className="px-6 py-3 bg-white border-b flex justify-between items-center shrink-0">
                    <div className="flex items-center gap-2 text-gray-700 font-bold text-sm">
                        <Filter size={16} className="text-blue-600"/> 
                        ตัวกรองข้อมูล
                    </div>
                    <div className="relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"/>
                        <input 
                            type="text" 
                            placeholder="ค้นหา..." 
                            className="pl-9 pr-3 py-1.5 border rounded-lg text-sm w-64 focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 focus:bg-white transition-colors"
                            value={detailSearch} onChange={e => setDetailSearch(e.target.value)}
                        />
                    </div>
                </div>
            )}

            {/* 4. Content Area */}
            <div id="user-modal-scroll" className="p-0 overflow-y-auto flex-1 bg-gray-50/50 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent relative scroll-smooth">
                
             {/* Tab 1: Info (แก้ไข: ปิดการแก้ไขอีเมล) */}
           {/* Tab 1: Info (แก้ไข: ปรับสิทธิ์ตามต้องการ) */}
                {userDetailTab === 'info' && (
                     <div className="p-6">
                         <div className="bg-white p-6 rounded-xl shadow-sm border space-y-6">
                  
                             {/* Basic Info Header */}
                             <div className="flex justify-between items-center border-b pb-2 mb-4">
                                 <h4 className="font-bold text-gray-800 flex gap-2"><User size={18}/> ข้อมูลพื้นฐาน</h4>
                                {/* ⭐ แก้ไข 1: ปุ่มบันทึก - ให้เฉพาะ SuperAdmin, Admin(2), Sub-Admin(3) เห็น */}
                                {(user.id === viewingUser.id || user.isSuperAdmin || hasPermission(2) || hasPermission(3)) && (
                                    <button 
                                        onClick={async () => {
                                            // ... (Logic การบันทึกเดิม คงไว้เหมือนเดิม) ...
                                            // 1. ดึงข้อมูล User เดิม
                                            const originalUser = allUsers.find(u => u.id === viewingUser.id);
                                            if (!originalUser) return;

                                            // Validation
                                            if (!viewingUser.empId || !viewingUser.firstName || !viewingUser.lastName) {
                                                showToast('กรุณากรอกข้อมูลให้ครบถ้วน (รหัส, ชื่อ, นามสกุล)', 'error');
                                                return;
                                            }

                                            setIsLoading(true);
                                            try {
                                                const changeDetails = [];
                                                let newSignatureUrl = viewingUser.signature;
                                                let sigChanged = false;

                                                // --- A. จัดการลายเซ็น ---
                                                if (sigMode === 'Draw' && hasDrawn) {
                                                    const canvas = sigCanvasRef.current;
                                                    const dataUrl = canvas.toDataURL('image/png');
                                                    const res = await new Promise((resolve, reject) => {
                                                        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)
                                                            .uploadUserSignature(dataUrl, `SIG_${viewingUser.empId}_${Date.now()}.png`);
                                                    });
                                                    if (res.url) {
                                                        newSignatureUrl = res.url;
                                                        changeDetails.push("อัปเดตลายเซ็น (วาดใหม่)");
                                                        sigChanged = true;
                                                    }
                                                } else if (sigMode === 'Upload' && signatureFile) {
                                                    const base64 = await fileToBase64(signatureFile);
                                                    const res = await new Promise((resolve, reject) => {
                                                        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)
                                                            .uploadUserSignature(base64, `SIG_${viewingUser.empId}_${Date.now()}_${signatureFile.name}`);
                                                    });
                                                    if (res.url) {
                                                        newSignatureUrl = res.url;
                                                        changeDetails.push("อัปเดตลายเซ็น (อัปโหลดไฟล์)");
                                                        sigChanged = true;
                                                    }
                                                }

                                                // --- B. ตรวจสอบการเปลี่ยนแปลงข้อมูล ---
                                                if (originalUser.empId !== viewingUser.empId) changeDetails.push(`รหัส: ${originalUser.empId} -> ${viewingUser.empId}`);
                                                if (originalUser.firstName !== viewingUser.firstName) changeDetails.push(`ชื่อ: ${originalUser.firstName} -> ${viewingUser.firstName}`);
                                                if (originalUser.lastName !== viewingUser.lastName) changeDetails.push(`นามสกุล: ${originalUser.lastName} -> ${viewingUser.lastName}`);
                                                
                                                if (changeDetails.length === 0 && !sigChanged) {
                                                    setIsLoading(false);
                                                    showToast('ไม่มีข้อมูลเปลี่ยนแปลง');
                                                    return;
                                                }

                                                // เตรียมข้อมูลบันทึก
                                                const userToSave = { ...viewingUser, signature: newSignatureUrl };
                                                
                                                // 1. บันทึกข้อมูลหลัก
                                                const saveRes = await new Promise(resolve => {
                                                    google.script.run.withSuccessHandler(resolve).saveUserData(userToSave);
                                                });
                                                
                                                if (!saveRes.success) {
                                                    setIsLoading(false);
                                                    showToast(saveRes.message, 'error');
                                                    return;
                                                }

                                                // 2. บันทึก Log
                                                const logImages = sigChanged ? [{name: 'New Signature', type: 'image/png', url: newSignatureUrl}] : [];
                                                await addInvLog('Edit Profile', `${viewingUser.empId} ${viewingUser.firstName}`, `Updated Profile`, `แก้ไขข้อมูล:\n- ${changeDetails.join('\n- ')}`, logImages, null, null);

                                                // 3. Global Update (ถ้าชื่อ/รหัสเปลี่ยน)
                                                const isIdentityChanged = (originalUser.empId !== viewingUser.empId) || (originalUser.firstName !== viewingUser.firstName) || (originalUser.lastName !== viewingUser.lastName);

                                                if (isIdentityChanged) {
                                                     const oldData = { empId: originalUser.empId, firstName: originalUser.firstName, lastName: originalUser.lastName };
                                                     const newData = { empId: viewingUser.empId, firstName: viewingUser.firstName, lastName: viewingUser.lastName };
                                                     const updateRes = await new Promise(r => google.script.run.withSuccessHandler(r).updateUserGlobalData(oldData, newData));
                                                     showToast(updateRes.message);
                                                } else {
                                                     showToast('บันทึกข้อมูลเรียบร้อย');
                                                }
                                                
                                                // 4. อัปเดตหน้าจอ
                                                setAllUsers(prev => prev.map(u => u.id === viewingUser.id ? userToSave : u));
                                                setViewingUser(userToSave);
                                                if (user.id === viewingUser.id) setUser(userToSave);
                                                
                                                if(sigCanvasRef.current) clearSignature();
                                                setSignatureFile(null);
                                                setHasDrawn(false);

                                            } catch (err) {
                                                console.error(err);
                                                showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
                                            } finally {
                                                setIsLoading(false);
                                            }
                                        }}
                                        className="bg-blue-600 text-white px-4 py-1.5 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md flex items-center gap-2 transition-all"
                                    >
                                        <Save size={14}/> บันทึกการแก้ไข
                                    </button>
                                )}
                             </div>

      {/* Form Inputs */}
                             <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* สร้างตัวแปรเช็คสิทธิ์แก้ไขข้อมูลพื้นฐาน (เฉพาะ Admin/Sub-Admin) */}
                                {(() => {
                                    const canEditBasicInfo = user.isSuperAdmin || hasPermission(2) || hasPermission(3);
                                    
                                    return (
                                        <>
                                            {/* 1. รหัสพนักงาน (Emp ID) */}
                                            <div>
                                                <label className="text-xs font-bold text-gray-500 mb-1 block">รหัสพนักงาน (Emp ID)</label>
                                                {canEditBasicInfo ? (
                                                    <input 
                                                        type="text" 
                                                        className="w-full p-2.5 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                                        value={viewingUser.empId}
                                                        onChange={e => setViewingUser({...viewingUser, empId: e.target.value})}
                                                    />
                                                ) : (
                                                    <div className="w-full p-2.5 bg-gray-50 rounded-lg text-sm font-bold text-gray-800 border border-transparent">
                                                        {viewingUser.empId}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* 2. อีเมล (Email) */}
                                            <div>
                                                <label className="text-xs font-bold text-gray-500 mb-1 block">อีเมล (Email)</label>
                                                {/* อีเมลปกติมักจะไม่ให้แก้ หรือแก้ได้เฉพาะ Admin ก็ใช้ Logic เดียวกัน */}
                                                {canEditBasicInfo ? (
                                                    <input 
                                                        type="email" 
                                                        className="w-full p-2.5 border rounded-lg bg-gray-100 text-gray-500 focus:outline-none"
                                                        value={viewingUser.email}
                                                        disabled // อีเมลล็อกถาวรแม้จะเป็น Admin (ตาม Code เดิม) หรือถ้าอยากให้แก้ได้ให้เอา disabled ออก
                                                    />
                                                ) : (
                                                    <div className="w-full p-2.5 bg-gray-50 rounded-lg text-sm font-bold text-gray-800 border border-transparent">
                                                        {viewingUser.email}
                                                    </div>
                                                )}
                                            </div>

                                            {/* 3. ชื่อ (First Name) */}
                                            <div>
                                                <label className="text-xs font-bold text-gray-500 mb-1 block">ชื่อ (First Name)</label>
                                                {canEditBasicInfo ? (
                                                    <input 
                                                        type="text" 
                                                        className="w-full p-2.5 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                                        value={viewingUser.firstName}
                                                        onChange={e => setViewingUser({...viewingUser, firstName: e.target.value})}
                                                    />
                                                ) : (
                                                    <div className="w-full p-2.5 bg-gray-50 rounded-lg text-sm font-bold text-gray-800 border border-transparent">
                                                        {viewingUser.firstName}
                                                    </div>
                                                )}
                                            </div>
                                          
                                            {/* 4. นามสกุล (Last Name) */}
                                            <div>
                                                <label className="text-xs font-bold text-gray-500 mb-1 block">นามสกุล (Last Name)</label>
                                                {canEditBasicInfo ? (
                                                    <input 
                                                        type="text" 
                                                        className="w-full p-2.5 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                                        value={viewingUser.lastName}
                                                        onChange={e => setViewingUser({...viewingUser, lastName: e.target.value})}
                                                    />
                                                ) : (
                                                    <div className="w-full p-2.5 bg-gray-50 rounded-lg text-sm font-bold text-gray-800 border border-transparent">
                                                        {viewingUser.lastName}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* 5. สถานะ (Status) */}
                                            <div>
                                                <label className="text-xs font-bold text-gray-500 mb-1 block">สถานะ (Status)</label>
                                                <div className={`p-2.5 rounded-lg font-bold flex justify-between items-center ${viewingUser.status==='Activated'?'text-green-600 bg-green-50 border border-green-100':'text-red-600 bg-red-50 border border-red-100'}`}>
                                                    {viewingUser.status}
                                                    
                                                    {/* ปุ่มเปลี่ยนสถานะ เฉพาะ Admin/Sub-Admin */}
                                                    {(user?.isSuperAdmin || hasPermission(2) || hasPermission(3)) && (
                                                        <button 
                                                            onClick={async () => {
                                                                const isActive = viewingUser.status === 'Activated'; 
                                                                const newStatus = isActive ? 'Deactivated' : 'Activated';
                                                                if(confirm(`ยืนยันการเปลี่ยนสถานะเป็น ${newStatus}?`)) {
                                                                    const updated = {...viewingUser, status: newStatus};
                                                                    google.script.run.saveUserData(updated);
                                                                    setAllUsers(prev => prev.map(u => u.id === updated.id ? updated : u));
                                                                    setViewingUser(updated);
                                                                    showToast(`เปลี่ยนสถานะเป็น ${newStatus} เรียบร้อย`);
                                                                }
                                                            }}
                                                            className="text-xs underline cursor-pointer hover:text-gray-800"
                                                        >
                                                            เปลี่ยนสถานะ
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        </>
                                    );
                                })()}
                            </div>

{/* --- ส่วนลายเซ็น (Signature) --- */}
<div className="col-span-1 md:col-span-2 border-t pt-4 mt-2">
    <label className="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
        <PenTool size={16}/> ลายเซ็นดิจิทัล (Digital Signature)
    </label>
    
    <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
        
        {/* ⭐ กรณีไม่มีลายเซ็น: แสดงข้อความแจ้งเตือน */}
        {!viewingUser.signature && (
            <div className="text-center py-6 flex flex-col items-center justify-center text-gray-400 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50/50 mb-4">
                <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-2 shadow-sm">
                    <XCircle size={24} className="text-gray-400" />
                </div>
                <p className="text-sm font-bold text-gray-500">ไม่มีลายเซ็น (No Signature)</p>
                <p className="text-xs text-gray-400 mt-1">ผู้ใช้นี้ยังไม่ได้บันทึกลายเซ็นในระบบ</p>
            </div>
        )}

        {/* ⭐ กรณีมีลายเซ็น: แสดงสถานะ/ปุ่มดูไฟล์ */}
        {viewingUser.signature && (
            <div className="mb-4 flex flex-col items-center animate-in fade-in">
                {/* ปุ่มดูไฟล์ลายเซ็น - ให้ User, Admin(2), Sub-Admin(3) เห็น */}
                {(user.id === viewingUser.id || user.isSuperAdmin || hasPermission(2) || hasPermission(3)) ? (
                    <div className="text-center">
                        <div className="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-2 rounded-lg flex items-center gap-2 mb-3 shadow-sm mx-auto w-fit">
                            <CheckCircle size={16} className="text-blue-600"/> 
                            <span className="text-xs font-bold">มีลายเซ็นในระบบแล้ว</span>
                        </div>
                        
                        <button 
                            type="button"
                            onClick={() => handleViewFile(viewingUser.signature, 'Signature')}
                            className="flex items-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-100 hover:text-blue-600 transition-colors shadow-sm text-xs font-bold mx-auto"
                        >
                            <Eye size={14}/> คลิกเพื่อตรวจสอบไฟล์ลายเซ็น
                        </button>
                    </div>
                ) : (
                    /* ถ้าเป็นคนอื่นดู (ที่ไม่ใช่ Admin/SubAdmin) ให้เห็นแค่สถานะ */
                    <>
                        <div className="bg-green-50 border border-green-200 text-green-700 px-6 py-3 rounded-xl flex items-center gap-3 shadow-sm">
                            <div className="bg-white p-1.5 rounded-full border border-green-100">
                                <ShieldCheck size={20} className="text-green-600"/>
                            </div>
                            <div>
                                <p className="text-sm font-bold">บันทึกลายเซ็นแล้ว</p>
                                <p className="text-[10px] opacity-80">พร้อมใช้งานสำหรับเอกสาร</p>
                            </div>
                        </div>
                    </>
                )}
            </div>
        )}

        {/* ⭐ ส่วนจัดการ (วาด/อัปโหลด) - แสดงเฉพาะเจ้าของหรือ Admin */}
        {(user.id === viewingUser.id || user.isSuperAdmin || hasPermission(2) || hasPermission(3)) && (
            <>
                <div className="flex bg-white rounded-lg border border-gray-200 p-1 mb-3 w-fit mx-auto mt-4">
                    <button onClick={() => setSigMode('Draw')} className={`px-4 py-1.5 text-xs font-bold rounded transition-colors ${sigMode === 'Draw' ? 'bg-blue-50 text-blue-600' : 'text-gray-500'}`}>วาดลายเซ็น</button>
                    <button onClick={() => setSigMode('Upload')} className={`px-4 py-1.5 text-xs font-bold rounded transition-colors ${sigMode === 'Upload' ? 'bg-blue-50 text-blue-600' : 'text-gray-500'}`}>อัปโหลดไฟล์</button>
                </div>

                <div className="flex flex-col items-center">
                    {sigMode === 'Draw' ? (
                        <div className="relative">
                            <canvas 
                                ref={sigCanvasRef}
                                width={300} height={150}
                                className="bg-white border border-dashed border-gray-400 rounded cursor-crosshair touch-none"
                                onMouseDown={startDrawing}
                                onMouseMove={draw}
                                onMouseUp={stopDrawing}
                                onMouseLeave={stopDrawing}
                                onTouchStart={startDrawing}
                                onTouchMove={draw}
                                onTouchEnd={stopDrawing}
                            />
                            <button onClick={clearSignature} type="button" className="absolute top-1 right-1 text-xs text-red-500 bg-white border border-red-200 px-2 py-0.5 rounded hover:bg-red-50">ล้าง</button>
                            <p className="text-[10px] text-gray-400 mt-1 text-center">* วาดลายเซ็นในกรอบ (รองรับเมาส์และนิ้วสัมผัส)</p>
                        </div>
                    ) : (
                        <div className="w-full max-w-xs text-center">
                            <input 
                                type="file" 
                                accept="image/*"
                                onChange={(e) => {
                                    if(e.target.files[0]) {
                                        const file = e.target.files[0];
                                        const reader = new FileReader();
                                        reader.onload = (ev) => setTempSignatureUrl(ev.target.result); 
                                        reader.readAsDataURL(file);
                                        setSignatureFile(file);
                                    }
                                }}
                                className="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                            />
                            {tempSignatureUrl && <img src={tempSignatureUrl} className="h-20 mt-2 mx-auto border bg-white rounded"/>}
                        </div>
                    )}
                </div>
            </>
        )}
    </div>
</div>

                             {/* Permissions Section */}
                            <div className="mt-6 pt-6 border-t">
                                <div className="flex justify-between items-center mb-4">
                                    <h4 className="font-bold text-gray-800 flex gap-2"><ShieldCheck size={18}/> สิทธิ์การใช้งานรายโครงการ</h4>
                                    {(user?.isSuperAdmin || hasPermission(2) || hasPermission(3)) && (
                                        <button 
    onClick={() => { 
        setSelectedUserForEdit(viewingUser); 
        // ⭐ เพิ่ม: ให้เลือกโครงการแรกสุดก่อนเปิด Modal
        if (projects && projects.length > 0) {
            setPermissionTab(projects[0].name);
        }
        setShowPermissionModal(true); 
    }} 
    className="text-xs bg-gray-100 text-gray-600 px-3 py-1.5 rounded hover:bg-gray-200 border"
>
    จัดการสิทธิ์ละเอียด
</button>
                                    )}
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-40 overflow-y-auto pr-2 custom-scrollbar">
                                     {viewingUser.permissions && Object.entries(viewingUser.permissions)
                                        .filter(([p]) => p && p !== 'undefined' && p !== 'null' && p.trim() !== '')
                                        .map(([project, perms]) => (
                                            <div key={project} className="border p-3 rounded bg-gray-50">
                                                <div className="font-bold text-blue-700 mb-2 flex items-center gap-2"><Building size={14}/> {project}</div>
                                                <div className="flex flex-wrap gap-1">{perms.map(id => <span key={id} className="text-[10px] bg-white border px-1.5 py-0.5 rounded text-gray-600">{PERMISSIONS[id]}</span>)}</div>
                                            </div>
                                     ))}
                                     {(!viewingUser.permissions || Object.keys(viewingUser.permissions).length === 0) && (
                                         <div className="col-span-2 text-center text-gray-400 text-sm py-4 border border-dashed rounded">ไม่มีสิทธิ์ในโครงการใดๆ</div>
                                     )}
                                </div>
                            </div>
                        </div>
                     </div>
                )}

                {/* ⭐ Tab 2: History (เฉพาะที่ User ทำเอง & ตัดการแสดง By ออก) */}
{userDetailTab === 'history' && (() => {
                    // 1. System Logs: กรองเฉพาะ log.by เป็น User นี้เท่านั้น (เหมือนเดิม)
                    const systemLogs = invLogs.filter(log => 
                        log.by && (log.by.includes(viewingUser.empId) || log.by.includes(viewingUser.firstName))
                    ).map(log => ({ ...log, sourceType: 'System' }));

// 2. Request Timeline: (แก้ไขใหม่) สแกนเอกสารทุกใบ เพื่อหาว่า User คนนี้ไปทำรายการอะไรไว้บ้าง
                    const requestTimelineLogs = requests.flatMap(req => {
                        // เข้าไปดูใน history ของแต่ละใบ (โดยไม่สนว่าใครเป็นเจ้าของใบงาน)
                        return (req.history || [])
                            .filter(h => h.user && ( // ⭐ แก้ไขจุดที่ 1: เปลี่ยนจาก h.by เป็น h.user
                                // เช็คว่าคนทำรายการ (User) คือ User ที่กำลังดูอยู่หรือไม่
                                h.user.includes(viewingUser.empId) || 
                                h.user.includes(viewingUser.firstName)
                            )) 
                            .map(h => ({
                                date: h.timestamp || h.date,
                                action: h.action,
                                by: h.user, // ⭐ แก้ไขจุดที่ 2: แมพค่า h.user ใส่ตัวแปร by (เพื่อให้ตารางแสดงผลได้)
                                // แสดงเลขที่เอกสาร + ชื่อสินค้าตัวแรก
                                item: req.docNumber ? `${req.docNumber} (${req.items[0]?.name})` : `${req.id} (${req.items[0]?.name})`,
                                note: h.note,
                                change: `Status: ${req.status}`,
                                relatedRequestId: req.id,
                                sourceType: 'Request'
                            }));
                    });

                    // รวมข้อมูล + กรอง Search + เรียงลำดับ (เหมือนเดิม)
                    const allUserLogs = [...systemLogs, ...requestTimelineLogs]
                        .filter(log => 
                            log.action?.toLowerCase().includes(detailSearch.toLowerCase()) ||
                            log.item?.toLowerCase().includes(detailSearch.toLowerCase()) ||
                            log.note?.toLowerCase().includes(detailSearch.toLowerCase())
                        )
                        .sort((a, b) => {
                            const parseDate = (dStr) => {
                                if(!dStr) return 0;
                                try {
                                    if(dStr.includes('/')) {
                                        const [d, t] = dStr.split(' ');
                                        const [day, month, year] = d.split('/').map(Number);
                                        return new Date(year > 2400 ? year - 543 : year, month - 1, day, ...(t ? t.split(':').map(Number) : [0,0,0])).getTime();
                                    }
                                    return new Date(dStr).getTime();
                                } catch(e) { return 0; }
                            };
                            return parseDate(b.date) - parseDate(a.date);
                        });

                    return (
                        <div className="w-full">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead className="bg-gray-100 text-gray-600 font-bold uppercase text-xs sticky top-0 z-20 shadow-sm">
                                    <tr>
                                        <th className="p-4 w-36 whitespace-nowrap bg-gray-100">Date Time</th>
                                        <th className="p-4 w-36 whitespace-nowrap bg-gray-100">Action</th>
                                        <th className="p-4 min-w-[200px] bg-gray-100">Item / Ref</th>
                                        {/* ⭐ เปลี่ยนหัวข้อ ตัด (By) ออก */}
                                        <th className="p-4 min-w-[300px] bg-gray-100">Details / Note</th> 
                                    </tr>
                                </thead>
                                <tbody className="divide-y bg-white">
                                    {allUserLogs.length > 0 ? allUserLogs.map((log, idx) => (
                                        <tr key={idx} className={`hover:bg-blue-50/30 transition-colors ${log.sourceType === 'Request' ? 'bg-blue-50/10' : ''}`}>
                                            <td className="p-4 font-mono text-xs text-gray-500 align-top whitespace-nowrap">{log.date || '-'}</td>
                                            <td className="p-4 align-top">
                                                <span className={`inline-block px-2 py-1 rounded text-[10px] font-bold border ${
                                                    log.action?.includes('Delete') ? 'bg-red-50 text-red-600 border-red-100' :
                                                    log.action?.includes('Edit') || log.action?.includes('Change') ? 'bg-orange-50 text-orange-600 border-orange-100' :
                                                    ['Create Request', 'Submit', 'Receive Items', 'Add'].some(k => log.action?.includes(k)) ? 'bg-green-50 text-green-600 border-green-100' :
                                                    'bg-gray-50 text-gray-600 border-gray-200'
                                                }`}>
                                                    {log.action === 'Pending PM' ? 'Pending Level 2' : log.action}
                                                </span>
                                                <div className="text-[9px] text-gray-300 mt-1 uppercase tracking-wider">{log.sourceType}</div>
                                            </td>
                                            <td className="p-4 font-medium text-gray-700 align-top">
                                                <div className="break-words font-mono text-xs">{log.item}</div>
                                                {log.relatedRequestId && (
    <button onClick={(e) => {
           e.stopPropagation();
           const targetReq = requests.find(r => r.id === log.relatedRequestId);
           // แก้ไขตรงนี้ครับ
           if(targetReq) { setSelectedRequest(targetReq); setShowDetailModal(true); }
       }}
       className="text-[10px] text-blue-600 font-mono mt-1 hover:underline flex items-center gap-1 bg-white px-1.5 py-0.5 rounded border border-blue-200 shadow-sm w-fit"
    >
       {log.relatedRequestId} <ExternalLink size={10}/>
    </button>
)}
                                            </td>
                                            <td className="p-4 text-gray-500 text-xs align-top">
                                                {/* ⭐ ลบส่วนแสดง Avatar และชื่อคนทำ (By) ออกทั้งหมด */}
                                                
                                                {/* แสดง Note อย่างเดียว (รองรับหลายบรรทัด Project) */}
                                                <div className="space-y-1">
                                                    {log.note ? log.note.split('\n').map((line, i) => (
                                                        <div key={i} className="leading-relaxed break-words">
                                                            {line.startsWith('Project:') ? (
                                                                <span>
                                                                    <span className="font-bold text-blue-600">{line.split('->')[0]}</span>
                                                                    <span className="text-gray-600"> -> {line.split('->')[1]}</span>
                                                                </span>
                                                            ) : line}
                                                        </div>
                                                    )) : '-'}
                                                </div>

                                                {log.change && <div className="text-[10px] text-gray-400 mt-2 italic bg-gray-50 p-1 rounded border border-gray-100 inline-block">{log.change}</div>}
                                            </td>
                                        </tr>
                                    )) : <tr><td colSpan="4" className="p-10 text-center text-gray-400">ไม่พบประวัติการทำงาน</td></tr>}
                                </tbody>
                            </table>
                            
                          
                            
                        </div>
                    );
                })()}

               {/* ⭐ Tab 3: Purchase (UPDATED: Precise Calculation Logic) */}
                {userDetailTab === 'purchase' && (() => {
                    // 1. กรองข้อมูล: เป็นของ User นี้ + เป็น Local/HO + จบงานแล้ว
                    const purchaseRequests = requests.filter(r => 
                        (r.requester === viewingUser.empId || r.requester.includes(viewingUser.firstName)) && 
                        ['Local', 'HO'].includes(r.type) &&
                        (r.status === 'Completed' || r.status === 'Received') && 
                        (r.docNumber?.toLowerCase().includes(detailSearch.toLowerCase()) || r.items.some(i => i.name.toLowerCase().includes(detailSearch.toLowerCase())))
                    );

                    // 2. แตกรายการสินค้า & คำนวณยอดละเอียด
                    let grandTotal = 0;
                    const tableRows = [];

                    purchaseRequests.forEach(req => {
                        // หาวันที่รับของล่าสุด
                        const lastLog = req.history?.slice().reverse().find(h => 
                            h.action === 'Completed' || h.action.includes('Receive')
                        );
                        const displayDate = lastLog ? (lastLog.timestamp || lastLog.date) : req.created;
                        const isRent = req.type === 'HO' && req.purchaseType === 'Rent';

          req.items.forEach(item => {
    // --- เริ่มต้น Logic การคำนวณ (Updated) ---
    
    // ⭐ แก้ไขตรงนี้: เพิ่ม Logic กรองด้วยราคา
    const relatedAssets = assets.filter(a => 
        a.currentRequestId === req.id && 
        a.name === item.name &&
        (a.price === item.unitPrice || a.rentalPrice === item.unitPrice)
    );
    
    const receivedLogs = item.receivedLog || [];
    
    let itemTotal = 0;
    let receivedCount = 0;
    let pricesList = []; 

    // Priority A: Assets (แม่นยำสุด)
    if (relatedAssets.length > 0) {
         itemTotal += relatedAssets.reduce((s, asset) => {
             const p = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
             const d = isRent ? (asset.duration || item.duration || 1) : 1;
             pricesList.push(p);
             return s + (p * d);
         }, 0);
         receivedCount = relatedAssets.length;
    } 
    // Priority B: Logs (สำหรับวัสดุ)
    else if (receivedLogs.length > 0) {
         itemTotal += receivedLogs.reduce((s, log) => {
             const p = log.price;
             const d = isRent ? (log.duration || 1) : 1;
             pricesList.push(p);
             return s + (log.qty * p * d);
          }, 0);
         receivedCount = item.receivedTotal || 0;
    }

    // Priority C: Estimate (ส่วนที่เหลือ - เฉพาะที่ยังไม่จบงาน)
    if (!['Completed', 'Received'].includes(req.status)) {
        const remaining = Math.max(0, item.qty - receivedCount);
        if (remaining > 0) {
            const p = item.unitPrice || 0;
            const d = isRent ? (item.duration || 1) : 1;
            itemTotal += (remaining * p * d);
            pricesList.push(p);
        }
    }



                            // ตรวจสอบว่าราคาคละกันหรือไม่
                            const uniquePrices = [...new Set(pricesList)];
                            const displayPrice = uniquePrices.length === 1 ? uniquePrices[0] : 'Mixed'; 

                            grandTotal += itemTotal;

                            tableRows.push({
                                rawDate: displayDate,
                                docNumber: req.docNumber || req.id,
                                reqId: req.id,
                                name: item.name,
                                price: displayPrice, // ส่งค่าไปเช็คตอน Render
                                qty: item.qty,
                                unit: item.unit,
                                total: itemTotal
                            });
                        });
                    });

                    // เรียงลำดับตามวันที่
                    tableRows.sort((a, b) => {
                        const parse = (d) => { try { 
                            if(d.includes('/')) {
                                const parts = d.split(' ');
                                const dp = parts[0].split('/');
                                let y = parseInt(dp[2]);
                                if(y > 2400) y -= 543;
                                return new Date(y, parseInt(dp[1])-1, parseInt(dp[0])).getTime();
                            }
                            return new Date(d).getTime(); 
                        } catch(e) { return 0; } };
                        return parse(b.rawDate) - parse(a.rawDate);
                    });

                    return (
                        <div className="p-6 space-y-4">
                            {/* การ์ดแสดงยอดรวมทั้งหมด */}
                            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 flex justify-between items-center shadow-sm">
                                <div className="flex items-center gap-2 text-blue-800 font-bold">
                                    <div className="bg-white p-2 rounded-lg text-blue-600"><ShoppingCart className="w-5 h-5"/></div>
                                    สรุปยอดซื้อที่รับของแล้ว (Grand Total)
                                </div>
                                <div className="text-2xl font-bold text-blue-700">
                                    {grandTotal.toLocaleString()} <span className="text-sm font-normal text-gray-500">บาท</span>
                                </div>
                            </div>

                            {/* ตารางรายการ */}
                            <div className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                                <table className="w-full text-sm text-left border-collapse">
                                    <thead className="bg-gray-100 text-gray-600 font-bold uppercase text-xs sticky top-0 z-20 shadow-sm">
                                        <tr>
                                            <th className="p-4 w-32 bg-gray-100">วันที่รับของ</th>
                                            <th className="p-4 w-32 bg-gray-100">เลขที่เอกสาร</th>
                                            <th className="p-4 min-w-[200px] bg-gray-100">รายการสินค้า</th>
                                            <th className="p-4 text-right bg-gray-100">ราคา/หน่วย</th>
                                            <th className="p-4 text-center bg-gray-100">จำนวน</th>
                                            <th className="p-4 text-right w-32 bg-gray-100">รวม (บาท)</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y bg-white">
                                        {tableRows.length > 0 ? tableRows.map((row, idx) => (
                                            <tr key={idx} className="hover:bg-blue-50/30 transition-colors">
                                                <td className="p-4 text-gray-500 whitespace-nowrap align-top text-xs font-mono">{row.rawDate}</td>
                                                <td className="p-4 align-top">
                                                    <button 
                                                        onClick={() => {
                                                            const targetReq = requests.find(r => r.id === row.reqId);
                                                            if(targetReq) { setSelectedRequest(targetReq); setShowDetailModal(true); }
                                                        }}
                                                        className="font-bold text-blue-600 hover:underline bg-blue-50 px-2 py-0.5 rounded border border-blue-100 text-xs font-mono"
                                                    >
                                                        {row.docNumber}
                                                    </button>
                                                </td>
                                                <td className="p-4 text-gray-800 font-medium">{row.name}</td>
                                                <td className="p-4 text-right text-gray-600 font-mono">
                                                    {row.price === 'Mixed' ? 
                                                        <span className="text-xs italic text-orange-600">(คละราคา)</span> : 
                                                        row.price.toLocaleString()
                                                    }
                                                </td>
                                                <td className="p-4 text-center">
                                                    <span className="bg-green-50 text-green-700 border border-green-200 px-2 py-0.5 rounded font-bold text-xs">
                                                        {row.qty.toLocaleString()} {row.unit}
                                                    </span>
                                                </td>
                                                <td className="p-4 text-right font-bold text-blue-700 font-mono bg-gray-50/50">{row.total.toLocaleString()}</td>
                                            </tr>
                                        )) : (
                                            <tr><td colSpan="6" className="p-12 text-center text-gray-400">ไม่พบรายการที่จบงานแล้ว</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    );
                })()}

                {/* ---------------- Tab 4: ประวัติการเบิก (เหมือนเดิม) ---------------- */}
                {userDetailTab === 'withdraw' && (() => {
                     const rawData = requests.filter(r => 
                        r.type === 'Withdraw' && (r.status === 'Approved' || r.status === 'Completed') &&
                        (r.requester === viewingUser.empId || r.requester.includes(viewingUser.firstName))
                    );
                    const aggregatedItems = {};
                    rawData.forEach(req => {
                        req.items.forEach(item => {
                            const key = item.name;
                            if(!aggregatedItems[key]) aggregatedItems[key] = { name: key, qty: 0, unit: item.unit };
                            aggregatedItems[key].qty += parseFloat(item.qty);
                        });
                    });
                    const itemList = Object.values(aggregatedItems).filter(i => i.name.toLowerCase().includes(detailSearch.toLowerCase()));

                    return (
                        <div className="space-y-4">
                            <input type="text" placeholder="ค้นหา..." className="p-2 border rounded text-sm w-full mb-2" value={detailSearch} onChange={e => setDetailSearch(e.target.value)}/>
                            <div className="bg-white rounded-lg border overflow-hidden shadow-sm">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-gray-100 text-gray-600 font-bold uppercase text-xs">
                                        <tr><th className="p-3">รายการ</th><th className="p-3 text-center">รวมที่เบิก</th><th className="p-3 text-center">หน่วย</th></tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {itemList.length > 0 ? itemList.map((item, idx) => (
                                            <tr key={idx} className="hover:bg-gray-50">
                                                <td className="p-3 font-medium">{item.name}</td>
                                                <td className="p-3 text-center font-bold text-blue-600">{item.qty}</td>
                                                <td className="p-3 text-center text-gray-500">{item.unit}</td>
                                            </tr>
                                        )) : <tr><td colSpan="3" className="p-8 text-center text-gray-400">ไม่พบประวัติการเบิก</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    );
                })()}

                {/* ---------------- Tab 5: ทรัพย์สินที่ยืม (UPDATED: Clickable Asset ID) ---------------- */}
                {userDetailTab === 'borrow' && (() => {
                    // Logic การกรอง (เหมือนเดิม)
                    const activeBorrows = assets.filter(a => 
                        a.status === 'Borrowed' && 
                        a.holder && 
                        (
                            a.holder.includes(viewingUser.firstName) || 
                            a.holder.includes(viewingUser.empId) ||
                            (viewingUser.username && a.holder.includes(viewingUser.username))
                        ) &&
                        (a.name.toLowerCase().includes(detailSearch.toLowerCase()) || a.id.toLowerCase().includes(detailSearch.toLowerCase()))
                    );

                    return (
                        <div className="space-y-4 p-6">
                            <div className="flex justify-between items-center mb-4">
                                <div className="relative">
                                    <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                                    <input type="text" placeholder="ค้นหา..." className="pl-9 pr-4 py-2 border rounded-lg text-sm w-64 outline-none focus:ring-2 focus:ring-blue-500" value={detailSearch} onChange={e => setDetailSearch(e.target.value)}/>
                                </div>
                                <span className="text-xs font-bold text-orange-700 bg-orange-100 px-3 py-1.5 rounded-full border border-orange-200">
                                    กำลังยืม: {activeBorrows.length} รายการ
                                </span>
                            </div>

                            <div className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-gray-100 text-gray-600 font-bold uppercase text-xs">
                                        <tr>
                                            <th className="p-4 w-32">รหัสทรัพย์สิน</th>
                                            <th className="p-4">ชื่อรายการ</th>
                                            <th className="p-4 w-40">Serial No.</th>
                                            <th className="p-4 w-40 text-center">วันที่ยืม/อัปเดต</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {activeBorrows.length > 0 ? activeBorrows.map((asset, idx) => (
                                            <tr key={asset.id} className="hover:bg-orange-50/50 transition-colors">
                                                <td className="p-4">
                                                    {/* ⭐ แก้ไขตรงนี้: เปลี่ยนเป็นปุ่มกดเรียก openViewItem */}
                                                    <button 
                                                        onClick={() => openViewItem(asset)}
                                                        className="font-mono text-blue-600 font-bold bg-blue-50 px-2 py-0.5 rounded border border-blue-100 text-xs hover:bg-blue-100 hover:underline cursor-pointer transition-colors"
                                                        title="คลิกเพื่อดูรายละเอียดและประวัติ"
                                                    >
                                                        {asset.id}
                                                    </button>
                                                </td>
                                                <td className="p-4 font-bold text-gray-800">{asset.name}</td>
                                                <td className="p-4 font-mono text-gray-500 text-xs">{asset.serial || '-'}</td>
                                                <td className="p-4 text-center text-gray-500 text-xs">
                                                    {asset.lastUpdated ? asset.lastUpdated.split(' ')[0] : '-'}
                                                </td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan="4" className="p-12 text-center text-gray-400 flex flex-col items-center justify-center">
                                                    <Briefcase className="w-10 h-10 mb-2 opacity-20"/>
                                                    ไม่พบทรัพย์สินที่ยืมอยู่
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    );
                })()}
            </div>
            <ModalScrollButtons targetId="user-modal-scroll" />
            {/* ⭐ ปุ่ม Load More แบบลอย (เฉพาะแท็บ History) */}
            {userDetailTab === 'history' && (
                <button 
                    onClick={() => {
                        if(!confirm('การโหลดประวัติทั้งหมดอาจใช้เวลาสักครู่ ยืนยัน?')) return;
                        setIsLoading(true);
                        google.script.run.withSuccessHandler((logs) => {
                            if (logs) setInvLogs(logs);
                            setIsLoading(false);
                            showToast('โหลดประวัติทั้งหมดเรียบร้อย');
                        }).getRecentLogs(2000);
                    }}
                    className="absolute bottom-6 left-6 z-[60] bg-white text-blue-600 border border-blue-200 hover:bg-blue-600 hover:text-white px-4 py-3 rounded-full shadow-xl transition-all transform hover:scale-105 flex items-center gap-2 font-bold text-xs group no-print"
                    title="โหลดข้อมูลเก่าเพิ่ม"
                >
                    <RefreshCw size={16} className="group-hover:rotate-180 transition-transform duration-500"/> 
                    <span>โหลดเพิ่ม (Load More)</span>
                </button>
            )}
        </div>
    </div>
)}

{/* --- CHECKLIST / AUDIT MODAL (แก้ไข: ระยะเช่า + จัดขนาดช่องตาราง) --- */}
{showChecklistModal && (
    <>
        {/* 1. CSS สำหรับพิมพ์ */}
        <style>{`
            @media print {
                @page { size: A4; margin: 10mm; }
                body * { visibility: hidden; }
                
                html, body { 
                    height: auto !important; 
                    overflow: visible !important; 
                    background: white !important; 
                    margin: 0 !important;
                    padding: 0 !important;
                }
                
                #print-area, #print-area * { visibility: visible; }
                
                #print-area {
                    position: absolute;
                    left: 0;
                    top: 0;
                    width: 100%;
                    margin: 0;
                    padding: 0;
                    background: white;
                }
                
                table { width: 100%; border-collapse: collapse; }
                thead { display: table-header-group; }
                tr { break-inside: avoid; page-break-inside: avoid; }
                
                td, th { border: 1px solid black !important; padding: 4px; font-size: 10pt; }
                .no-print { display: none !important; }
            }
        `}</style>

        {/* 2. Modal UI */}
        <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[200] p-4 backdrop-blur-sm animate-in fade-in no-print">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col overflow-hidden">
                
                {/* Header */}
                <div className="px-6 py-4 border-b bg-white flex justify-between items-center shrink-0">
                    <div>
                        <h3 className="font-bold text-xl text-indigo-800 flex items-center gap-2">
                            <ClipboardList className="w-6 h-6"/> สร้างใบตรวจนับ ({checklistMode === 'Inventory' ? 'วัสดุ' : 'ทรัพย์สิน'})
                        </h3>
                        <p className="text-sm text-gray-500">เลือกเงื่อนไขเพื่อพิมพ์ใบตรวจนับ</p>
                    </div>
                    {/* ปุ่มปิดแบบ SVG */}
                    <button onClick={() => setShowChecklistModal(false)} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <div className="flex-1 flex overflow-hidden">
                    {/* LEFT: Filters */}
                    <div className="w-1/3 bg-gray-50 border-r p-6 overflow-y-auto space-y-6">
                        {/* Projects Filter */}
                        <div className="bg-white p-4 rounded-xl border shadow-sm">
                            <label className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Building size={16}/> เลือกโครงการ</label>
                            <div className="space-y-1 max-h-40 overflow-y-auto custom-scrollbar">
                                {projects.map(p => (
                                    <label key={p.id} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1.5 rounded">
                                        <input type="checkbox" className="rounded text-indigo-600 focus:ring-indigo-500" 
                                            checked={checklistFilters.projects.includes(p.name)}
                                            onChange={() => toggleChecklistFilter('projects', p.name)}
                                        />
                                        <span className="text-sm">{p.name}</span>
                                    </label>
                                ))}
                            </div>
                        </div>

                        {/* Type & Status Filters */}
                        <div className="bg-white p-4 rounded-xl border shadow-sm space-y-4">
                            <div>
                                <label className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Tag size={16}/> เลือกประเภท</label>
                                <div className="space-y-1">
                                    {checklistMode === 'Inventory' ? (
                                        ['System', 'NonSystem'].map(t => (
                                            <label key={t} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1.5 rounded">
                                                <input type="checkbox" className="rounded text-indigo-600" checked={checklistFilters.types.includes(t)} onChange={() => toggleChecklistFilter('types', t)}/>
                                                <span className="text-sm">{t === 'System' ? 'ในระบบ' : 'นอกระบบ'}</span>
                                            </label>
                                        ))
                                    ) : (
                                        ['Company', 'Rent'].map(t => (
                                            <label key={t} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1.5 rounded">
                                                <input type="checkbox" className="rounded text-indigo-600" checked={checklistFilters.types.includes(t)} onChange={() => toggleChecklistFilter('types', t)}/>
                                                <span className="text-sm">{t === 'Company' ? 'ทรัพย์สินบริษัท' : 'ทรัพย์สินเช่า'}</span>
                                            </label>
                                        ))
                                    )}
                                </div>
                            </div>

                            {checklistMode === 'Asset' && (
                                <div>
                                    <label className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Info size={16}/> เลือกสถานะ</label>
                                    <div className="space-y-1">
                                        {['Available', 'Borrowed', 'Lost', 'Damaged'].map(s => (
                                            <label key={s} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1.5 rounded">
                                                <input type="checkbox" className="rounded text-indigo-600" checked={checklistFilters.statuses.includes(s)} onChange={() => toggleChecklistFilter('statuses', s)}/>
                                                <span className="text-sm">{s}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* RIGHT: Action & Upload */}
                    <div className="w-2/3 flex flex-col bg-white">
                        <div className="p-8 flex flex-col items-center justify-center flex-1 text-center">
                            <div className="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mb-4">
                                <Printer className="w-10 h-10 text-indigo-600"/>
                            </div>
                            <h4 className="text-2xl font-bold text-gray-800 mb-2">พร้อมพิมพ์ใบตรวจนับ</h4>
                            <p className="text-gray-500 mb-6 max-w-sm">
                                ระบบจะดึงรายการจำนวน <strong className="text-indigo-600">{getChecklistFilteredItems().length}</strong> รายการ <br/>
                                ตามเงื่อนไขที่คุณเลือกทางด้านซ้าย
                            </p>
                            
                            <button 
                                onClick={handlePrintChecklist} 
                                disabled={getChecklistFilteredItems().length === 0}
                                className="h-12 px-8 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg flex items-center gap-2 transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <Printer className="w-5 h-5"/> พิมพ์ / บันทึก PDF (Auto Name)
                            </button>
                        </div>

                        {/* Upload Section */}
                        <div className="p-6 bg-slate-50 border-t">
                            <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2"><UploadCloud size={18}/> อัปโหลดเอกสารกลับ (Upload Signed Checklist)</h4>
                            <div className="flex gap-4">
                                <input 
                                    type="file" 
                                    accept=".pdf,.jpg,.png"
                                    className="flex-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-bold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 bg-white border border-gray-300 rounded-xl cursor-pointer"
                                    onChange={(e) => setChecklistUploadFile(e.target.files[0])}
                                />
                                <button 
                                    onClick={handleUploadChecklist}
                                    disabled={!checklistUploadFile}
                                    className="bg-green-600 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-md flex items-center gap-2"
                                >
                                    <Save className="w-4 h-4"/> บันทึกเข้าระบบ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {/* 3. ส่วนเนื้อหาที่จะพิมพ์ */}
        <div id="print-area" className="hidden print:block bg-white text-black p-8">
            <div className="text-center mb-6">
                <h1 className="text-2xl font-bold mb-1">ใบตรวจนับ{checklistMode === 'Inventory' ? 'วัสดุคงคลัง (Inventory Audit)' : 'ทรัพย์สิน (Asset Audit)'}</h1>
                <p className="text-sm text-gray-600">วันที่พิมพ์: {new Date().toLocaleString('th-TH')}</p>
            </div>

            <div className="mb-4 text-sm border-b pb-2">
                <p><strong>โครงการ:</strong> {checklistFilters.projects.length > 0 ? checklistFilters.projects.join(', ') : 'ทั้งหมด (All Projects)'}</p>
                <p><strong>เงื่อนไข:</strong> {checklistMode === 'Inventory' ? 
                    `ประเภท: ${checklistFilters.types.length > 0 ? checklistFilters.types.join(', ') : 'ทั้งหมด'}` : 
                    `ประเภท: ${checklistFilters.types.length > 0 ? checklistFilters.types.join(', ') : 'ทั้งหมด'}, สถานะ: ${checklistFilters.statuses.length > 0 ? checklistFilters.statuses.join(', ') : 'ทั้งหมด'}`
                }</p>
            </div>

{checklistMode === 'Asset' && (
        <div className="flex justify-between items-end mb-3 px-1 font-bold text-sm text-black">
            <div className="flex items-center gap-2">
                <span>จำนวนรายการ:</span>
                {/* ดึงจำนวนรายการที่กรองมาได้ */}
                <span className="text-xl font-mono">{getChecklistFilteredItems().length}</span>
                <span>รายการ</span>
            </div>
            <div className="flex items-end gap-2">
                <span>ที่นับได้:</span>
                {/* เส้นประสำหรับเขียน */}
                <div className="border-b-2 border-dotted border-black w-32 h-6"></div>
                <span>รายการ</span>
            </div>
        </div>
    )}


            <table className="w-full border-collapse border border-black text-xs">
                <thead>
                   {checklistMode === 'Inventory' ? (
    <tr className="bg-gray-100 font-bold">
        {/* ช่องลำดับ: เล็กสุด */}
        <th className="border border-black p-2 w-8 text-center">#</th>
        
        {/* ⭐ ช่องรายการ: ไม่กำหนดความกว้าง (w) เพื่อให้ยืดกินพื้นที่ที่เหลือทั้งหมด */}
        <th className="border border-black p-2 text-left">รายการวัสดุ (Item Details)</th>
        
        {/* ปรับลดขนาดช่องอื่นๆ ให้เล็กลงเพื่อให้ช่องรายการกว้างขึ้น */}
        <th className="border border-black p-2 w-20 text-center">รหัสโครงการ</th> {/* เดิม w-24 */}
        <th className="border border-black p-2 w-20 text-right">คงเหลือ</th>   {/* เดิม w-24 */}
        
        <th className="border border-black p-2 w-24 text-center">อัปเดตล่าสุด</th>
        <th className="border border-black p-2 w-24 text-center">นับจริง</th>
        
        {/* ลดความกว้างช่องหมายเหตุลง (จาก w-40 เหลือ w-28) */}
        <th className="border border-black p-2 w-28 text-center">หมายเหตุ</th> 
    </tr>
) : (
    <tr className="bg-gray-100 font-bold">
        <th className="border border-black p-2 w-10 text-center"><CheckSquare size={14}/></th>
        
        {/* ⭐ แก้ไข: รวมคอลัมน์ รหัส+รายการ+S/N+ระยะเช่า ไว้ในช่องเดียว */}
        <th className="border border-black p-2 text-left">รายละเอียดทรัพย์สิน (Asset Details)</th>
        
        {/* คอลัมน์อื่นๆ คงเดิม แต่ปรับขนาดนิดหน่อย */}
        <th className="border border-black p-2 w-24 text-center">รหัสโครงการ</th>
        <th className="border border-black p-2 w-24 text-center">สถานะ</th>
        <th className="border border-black p-2 w-32">ผู้ถือครอง</th>
        <th className="border border-black p-2 w-24 text-center">อัปเดตล่าสุด</th>
    </tr>
)}
                </thead>
                <tbody>
                    {getChecklistFilteredItems().map((item, idx) => (
                        <tr key={idx}>
                            {checklistMode === 'Inventory' ? (
    <>
        <td className="border border-black p-2 text-center align-top">{idx + 1}</td>
        
        {/* ⭐ 3. รวมช่อง: ชื่อสินค้า (ตัวหนา) และ รหัส (ตัดเหลือรหัสหน้า) */}
        <td className="border border-black p-2 align-top">
            <div className="font-bold text-sm mb-1">{item.name}</div>
            <div className="text-xs text-gray-500 font-mono">
                {/* ใช้ getDisplayId เพื่อตัดส่วนท้ายทิ้ง แสดงแค่ INV-xxx */}
                ID: {getDisplayId(item.id)}
            </div>
        </td>

        <td className="border border-black p-2 text-center align-top">
            {projects.find(p => p.name === item.project)?.id || '-'}
        </td>
        
        <td className="border border-black p-2 text-right align-top">
            {item.qty} {item.unit}
        </td>
        
        {/* ⭐ 4. สลับช่องข้อมูล (Body) ให้ตรงกับ Header */}
        {/* อัปเดตล่าสุด (ย้ายมาตรงนี้) */}
        <td className="border border-black p-2 text-center align-top text-xs">
            {item.lastUpdated?.split(' ')[0]}
        </td>

        {/* นับจริง (ย้ายไปไว้หลัง) */}
        <td className="border border-black p-2"></td>
        
        <td className="border border-black p-2"></td>
    </>
) : (
    <>
        {/* ช่อง Checkbox */}
        <td className="border border-black p-2 text-center align-top pt-3">
            <div className="w-4 h-4 border border-black mx-auto"></div>
        </td>

        {/* ⭐ แก้ไข: รวมข้อมูล 4 อย่างไว้ใน <td> เดียวกัน และจัดบรรทัด */}
        <td className="border border-black p-2 align-top">
            {/* 1. ชื่อรายการ (ตัวหนา) */}
            <div className="font-bold text-sm mb-1">{item.name}</div>
            
            {/* 2. รหัส และ Serial (อยู่บรรทัดเดียวกัน หรือตัดลงมาถ้ายาว) */}
            <div className="flex flex-wrap gap-x-3 gap-y-1 text-xs text-gray-700 mb-1">
                <span className="font-mono bg-gray-50 px-1 rounded border border-gray-200 whitespace-nowrap">
                    ID: {item.id}
                </span>
                <span className="whitespace-nowrap">
                    S/N: {item.serial || '-'}
                </span>
            </div>

            {/* 3. ระยะเวลาเช่า (แสดงเฉพาะถ้าเป็นของเช่า) */}
            {item.ownerType === 'Rent' && (
                <div className="text-[10px] text-gray-500 italic border-t border-dotted border-gray-300 pt-1 mt-1">
                    <span className="font-bold">ระยะเช่า:</span>{' '}
                    {item.duration ? 
                        `${item.duration} ${item.rentalUnit || ''}` : 
                        (item.rentalStart && item.rentalEnd ? `${item.rentalStart} - ${item.rentalEnd}` : '-')
                    }
                </div>
            )}
        </td>

        {/* คอลัมน์อื่นๆ แยกเหมือนเดิม */}
        <td className="border border-black p-2 text-center align-top pt-3">
            {projects.find(p => p.name === item.project)?.id || '-'}
        </td>

        <td className="border border-black p-2 text-center align-top pt-3">{item.status}</td>
        <td className="border border-black p-2 align-top pt-3">{item.holder || '-'}</td>
        <td className="border border-black p-2 text-center align-top pt-3">{item.lastUpdated?.split(' ')[0]}</td>
    </>
)}
                        </tr>
                    ))}
                </tbody>
            </table>

            <div className="mt-8 flex justify-between px-10 break-inside-avoid">
                <div className="text-center">
                    <div className="border-b border-dotted border-black w-48 h-8"></div>
                    <p className="mt-1">ผู้ตรวจสอบ (Checker)</p>
                    <p className="mt-4">วันที่ ...../...../..........</p>
                </div>
                <div className="text-center">
                    <div className="border-b border-dotted border-black w-48 h-8"></div>
                    <p className="mt-1">ผู้อนุมัติ / รับทราบ (Approved By)</p>
                    <p className="mt-4">วันที่ ...../...../..........</p>
                </div>
            </div>
        </div>
    </>
)}

{/* --- EXPORT BUDGET MODAL --- */}
{showExportModal && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[300] p-4 backdrop-blur-sm animate-in fade-in">
        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in-95">
            
            {/* Header */}
            <div className="px-6 py-4 border-b bg-white flex justify-between items-center">
                <h3 className="font-bold text-lg text-green-700 flex items-center gap-2">
                    <FileText className="w-5 h-5"/> ส่งออกข้อมูลการใช้งบ (Export)
                </h3>
                {/* ปุ่มปิด SVG */}
                <button 
                    onClick={() => setShowExportModal(false)} 
                    className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            {/* Body */}
            <div className="p-6 bg-slate-50">
                <p className="text-sm text-gray-600 mb-4">
                    ข้อมูลจะถูกดึงจากรายการที่สถานะ <b>Completed</b> (รับของ/จบงานแล้ว) เท่านั้น เพื่อใช้ตรวจสอบ Budget ที่ใช้ไปจริง
                </p>

                <label className="block text-sm font-bold text-gray-700 mb-2">เลือกโครงการที่ต้องการ Export</label>
                <select 
                    className="w-full p-3 border border-gray-300 rounded-xl text-sm bg-white outline-none focus:ring-2 focus:ring-green-500 cursor-pointer"
                    value={exportTargetProject}
                    onChange={(e) => setExportTargetProject(e.target.value)}
                >
                    <option value="All">ทุกโครงการ (All Projects)</option>
                    {projects.map(p => (
                        <option key={p.id} value={p.name}>{p.name}</option>
                    ))}
                </select>
            </div>

            {/* Footer */}
            <div className="p-5 border-t bg-white flex gap-3">
                <button 
                    onClick={() => setShowExportModal(false)} 
                    className="flex-1 py-2.5 border border-gray-300 rounded-xl text-gray-600 font-bold hover:bg-gray-50"
                >
                    ยกเลิก
                </button>
                <button 
                    onClick={handleExportBudgetCSV} 
                    className="flex-1 py-2.5 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-md flex items-center justify-center gap-2"
                >
                    <Download className="w-4 h-4"/> ยืนยัน Export
                </button>
            </div>
        </div>
    </div>
)}


{showAuditModal && (
    <div className="fixed inset-0 bg-gray-900/80 flex items-center justify-center z-[200] p-4 backdrop-blur-sm animate-in fade-in">
        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden">
            
            {/* Header */}
            <div className="px-6 py-4 border-b bg-orange-50 flex justify-between items-center">
                <div>
                    <h3 className="font-bold text-lg text-orange-800 flex items-center gap-2">
                        <ClipboardList className="w-5 h-5"/> โหมดตรวจนับสินค้า (Stock Audit Mode)
                    </h3>
                    <p className="text-xs text-orange-600">กรุณากรอกยอดที่นับได้จริง ระบบจะคำนวณส่วนต่างให้อัตโนมัติ</p>
                </div>
                <button onClick={() => setShowAuditModal(false)} className="text-gray-400 hover:text-gray-600"><X className="w-6 h-6"/></button>
            </div>

            {/* Table */}
            <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                <table className="w-full text-sm text-left bg-white rounded-xl overflow-hidden shadow-sm">
                    <thead className="bg-gray-100 text-gray-700 font-bold uppercase text-xs sticky top-0 z-10">
                        <tr>
                            <th className="p-3">สินค้า</th>
                            <th className="p-3 text-center w-24">ยอดระบบ</th>
                            <th className="p-3 text-center w-32 bg-orange-100 text-orange-800">ยอดที่นับได้</th>
                            <th className="p-3 text-center w-24">ผลต่าง</th>
                            <th className="p-3 w-1/3">หมายเหตุ (กรณีมียอดต่าง)</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {auditItems.map((item, idx) => {
                            const diff = item.countedQty - item.qty;
                            const hasDiff = diff !== 0;
                            return (
                                <tr key={item.id} className={hasDiff ? "bg-red-50" : "hover:bg-gray-50"}>
                                    <td className="p-3">
                                        <div className="font-bold">{item.name}</div>
                                        <div className="text-xs text-gray-500">{getDisplayId(item.id)} | {item.project}</div>
                                    </td>
                                    <td className="p-3 text-center font-mono">{item.qty}</td>
                                    <td className="p-3 text-center bg-orange-50/50">
                                        <input 
                                            type="number" 
                                            className="w-full p-2 border border-orange-300 rounded text-center font-bold text-orange-700 focus:ring-2 focus:ring-orange-500 outline-none"
                                            value={item.countedQty}
                                            onChange={(e) => {
                                                const val = parseInt(e.target.value) || 0;
                                                const newItems = [...auditItems];
                                                newItems[idx].countedQty = val;
                                                setAuditItems(newItems);
                                            }}
                                        />
                                    </td>
                                    <td className="p-3 text-center font-bold">
                                        <span className={diff === 0 ? 'text-gray-300' : diff < 0 ? 'text-red-600' : 'text-green-600'}>
                                            {diff > 0 ? `+${diff}` : diff}
                                        </span>
                                    </td>
                                    <td className="p-3">
                                        {hasDiff && (
                                            <input 
                                                type="text" 
                                                placeholder="ระบุสาเหตุ (เช่น ของหาย, นับผิด)" 
                                                className="w-full p-2 border border-red-300 rounded text-xs bg-white focus:ring-1 focus:ring-red-500 outline-none"
                                                value={item.reason}
                                                onChange={(e) => {
                                                    const newItems = [...auditItems];
                                                    newItems[idx].reason = e.target.value;
                                                    setAuditItems(newItems);
                                                }}
                                            />
                                        )}
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>

            {/* Footer */}
            <div className="p-5 border-t bg-white flex justify-between items-center">
                <div className="text-sm">
                    รายการที่มีผลต่าง: <b className="text-red-600">{auditItems.filter(i => i.countedQty !== i.qty).length}</b> รายการ
                </div>
                <div className="flex gap-3">
                    <button onClick={() => setShowAuditModal(false)} className="px-6 py-2 border rounded-lg text-gray-600 hover:bg-gray-50">ยกเลิก</button>
                    <button 
                        onClick={async () => {
                            // กรองเฉพาะรายการที่มีผลต่างเพื่อส่งไปแก้
                            const adjustments = auditItems
                                .filter(i => i.countedQty !== i.qty)
                                .map(i => ({
                                    id: i.id,
                                    name: i.name,
                                    oldQty: i.qty,
                                    newQty: i.countedQty,
                                    reason: i.reason || 'ปรับยอดจากการตรวจนับ',
                                    project: i.project,
                                    // ส่ง Object เต็มที่แก้ค่าแล้วกลับไปบันทึก
                                    fullObject: { ...i, qty: i.countedQty, lastUpdated: new Date().toLocaleString('th-TH') }
                                }));

                            if (adjustments.length === 0) {
                                showToast('ยอดตรงกันทุกรายการ ไม่มีการปรับปรุง', 'success');
                                setShowAuditModal(false);
                                return;
                            }

                            if (!confirm(`ยืนยันการปรับยอดสต็อก ${adjustments.length} รายการ?`)) return;

                            setIsLoading(true);
                            try {
                                const userBy = `${user.empId} ${user.firstName}`;
                                await new Promise((resolve, reject) => {
                                    google.script.run
                                        .withSuccessHandler(resolve)
                                        .withFailureHandler(reject)
                                        .processStockAudit(adjustments, userBy);
                                });
                                
                                // อัปเดตหน้าจอทันที
                                setInventory(prev => prev.map(inv => {
                                    const adj = adjustments.find(a => a.id === inv.id);
                                    return adj ? adj.fullObject : inv;
                                }));

                                showToast('บันทึกผลการตรวจนับเรียบร้อย');
                                setShowAuditModal(false);
                            } catch (err) {
                                console.error(err);
                                showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
                            } finally {
                                setIsLoading(false);
                            }
                        }}
                        className="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 shadow-md font-bold"
                    >
                        ยืนยันและปรับยอด (Confirm Adjust)
                    </button>
                </div>
            </div>
        </div>
    </div>
)}


{/* --- ACTOR LIST MODAL --- */}
{showActorModal && (
    <div className="fixed inset-0 bg-gray-900/60 flex items-center justify-center z-[300] p-4 backdrop-blur-sm animate-in fade-in">
        <div className="bg-white rounded-xl shadow-xl w-full max-w-sm overflow-hidden">
            <div className="px-5 py-3 border-b bg-blue-50 flex justify-between items-center">
                <div>
                    <h3 className="font-bold text-blue-800 text-sm">ผู้รับผิดชอบขั้นตอน:</h3>
                    <p className="text-xs text-blue-600 font-bold mt-0.5">{actorList.title}</p>
                </div>
                <button onClick={() => setShowActorModal(false)} className="text-gray-400 hover:text-gray-600"><X size={18}/></button>
            </div>
            
            <div className="p-0 max-h-[300px] overflow-y-auto">
                {actorList.users.length > 0 ? (
                    <div className="divide-y divide-gray-100">
                        {actorList.users.map((u, i) => (
                            <div key={i} className="px-5 py-3 flex items-center gap-3 hover:bg-gray-50">
                                <div className="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-bold text-xs">
                                    {u.firstName.charAt(0)}
                                </div>
                                <div>
                                    <p className="text-sm font-bold text-gray-800">{u.firstName} {u.lastName}</p>
                                    <p className="text-xs text-gray-500">{u.empId} {u.role === 'Admin' && ' (Admin)'}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="p-8 text-center text-gray-400 text-sm">
                        <User size={24} className="mx-auto mb-2 opacity-30"/>
                        <p>ไม่พบผู้มีสิทธิ์ในขั้นตอนนี้</p>
                    </div>
                )}
            </div>
            <div className="p-3 bg-gray-50 text-center border-t">
                <button onClick={() => setShowActorModal(false)} className="text-xs font-bold text-gray-500 hover:text-gray-800">ปิดหน้าต่าง</button>
            </div>
        </div>
    </div>
)}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
