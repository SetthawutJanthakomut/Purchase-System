// --- CONFIGURATION ---
const SUPABASE_URL = 'https://zaugfyldiqcpfhfaxapc.supabase.co'; // ใส่ Project URL ของคุณ
const SUPABASE_KEY = PropertiesService.getScriptProperties().getProperty('SUPABASE_KEY'); // ✅ ดึงจากตู้เซฟ



function doGet(e) {
  // ⭐ ตรวจสอบ Action จากอีเมล
  if (e.parameter && e.parameter.action) {
    
    // กรณี 1: กดอนุมัติ (Approve) -> ทำรายการทันที
    if (e.parameter.action === 'approve') {
      return processEmailAction(e);
    }
    
    // กรณี 2: กดไม่อนุมัติ (Reject) -> เปิดฟอร์มกรอกเหตุผล
    if (e.parameter.action === 'reject') {
      return createRejectForm(e);
    }

    // กรณี 3: ยืนยันการไม่อนุมัติจากฟอร์ม (Confirm Reject) -> บันทึกข้อมูล
    if (e.parameter.action === 'confirm_reject') {
      return processEmailAction(e);
    }
  }

  // กรณีปกติ: เปิดหน้า Web App
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('PurchaseHub System')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function callSupabase(tableName, method, payload = null, params = '') {
  const table = tableName.toLowerCase(); 
  let url = `${SUPABASE_URL}/rest/v1/${table}${params}`;
  
  const options = {
    method: method,
    headers: {
      'apikey': SUPABASE_KEY, // ต้องเป็น anon key ที่คุณเพิ่งเปลี่ยน
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal',
      'User-Agent': 'PurchaseHub-Script/1.0' // หลอกว่าเป็น App ไม่ใช่ Browser
    },
    muteHttpExceptions: true
  };

  if (payload) {
    options.payload = JSON.stringify(payload);
  }

  const response = UrlFetchApp.fetch(url, options);
  // ถ้า Error ให้พ่นออกมาดูเลย
  if (response.getResponseCode() >= 400) {
    Logger.log("❌ Supabase Error: " + response.getContentText());
    return "[]"; // ส่งอาเรย์ว่างกลับไปกันแอปพัง
  }
  
  return response.getContentText();
}

function createRejectForm(e) {
  const reqId = e.parameter.id;
  const role = e.parameter.role;
  const approver = e.parameter.approver;
  const scriptUrl = ScriptApp.getService().getUrl();

  const html = `
    <!DOCTYPE html>
    <html>
      <head>
        <base target="_top">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; display: flex; justify-content: center; padding-top: 50px; }
          .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 90%; max-width: 400px; }
          h2 { color: #d93025; margin-top: 0; }
          textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin: 15px 0; font-family: inherit; }
          button { background-color: #d93025; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; }
          button:hover { background-color: #b02015; }
        </style>
      </head>
      <body>
        <div class="card">
          <h2>❌ ยืนยันการไม่อนุมัติ</h2>
          <p>เอกสาร: <strong>${reqId}</strong></p>
          <p>กรุณาระบุเหตุผล (Note):</p>
          
          <form id="rejectForm">
            <textarea id="reason" rows="4" placeholder="ระบุสาเหตุที่ไม่อนุมัติ..." required></textarea>
            <button type="submit">ยืนยัน (Confirm Reject)</button>
          </form>

          <script>
            document.getElementById('rejectForm').onsubmit = function(e) {
              e.preventDefault();
              var reason = document.getElementById('reason').value;
              var btn = document.querySelector('button');
              btn.disabled = true;
              btn.innerText = 'กำลังบันทึก...';

              // Redirect กลับไปที่ Script พร้อมเหตุผล
              var finalUrl = "${scriptUrl}?action=confirm_reject" + 
                             "&id=${reqId}" + 
                             "&role=${role}" + 
                             "&approver=${approver}" + 
                             "&note=" + encodeURIComponent(reason);
              
              window.top.location.href = finalUrl;
            };
          </script>
        </div>
      </body>
    </html>
  `;
  
  return HtmlService.createHtmlOutput(html);
}

function processEmailAction(e) {
  const action = e.parameter.action; 
  const reqId = e.parameter.id;
  const approver = e.parameter.approver;
  const role = e.parameter.role;
  const customNote = e.parameter.note || ''; 

  console.log(`[ProcessEmail] ===== START =====`);
  console.log(`[ProcessEmail] Action: ${action} | ID: ${reqId} | Approver: ${approver}`);

  // ค้นหา User เพื่อแสดงชื่อใน Log
  const allUsers = getSheetData('Users');
  let userDisplay = approver + " (Email)";
  const foundUser = allUsers.find(u => u.email && approver.includes(u.email));
  if (foundUser) {
      userDisplay = `${foundUser.empId} ${foundUser.firstName} ${foundUser.lastName} (Email)`;
  }

  const requests = getSheetData('Requests');
  const reqIndex = requests.findIndex(r => r.id === reqId);

  if (reqIndex === -1) return HtmlService.createHtmlOutput("<h2>❌ ไม่พบเอกสาร</h2>");

let req = requests[reqIndex];
  
  // ⭐⭐ [แก้ไข] Validation Check: เพิ่ม role 'Approver'
  const isWithdrawOrBorrow = (req.type === 'Withdraw' || req.type === 'Borrow');
  let isValidRole = false;

  if (role === 'Head' && req.status === 'Pending Head') isValidRole = true;
  else if (role === 'PM' && req.status === 'Pending PM') isValidRole = true;
  else if (isWithdrawOrBorrow && role === 'PM' && req.status === 'Pending Head') isValidRole = true;
  // ✅ เพิ่ม: ถ้าเป็น Role 'Approver' (มาจากเมลรวม) ถือว่าผ่านเสมอสำหรับงานเบิก/ยืมที่ยังรออนุมัติ
  else if (role === 'Approver' && isWithdrawOrBorrow && req.status === 'Pending Head') isValidRole = true;

  if (!isValidRole) {
     return HtmlService.createHtmlOutput("<h2>⚠️ รายการนี้ถูกดำเนินการไปแล้ว หรือคุณไม่มีสิทธิ์ในสถานะปัจจุบัน</h2>");
  }

  // ⭐⭐ [แก้ไข] Update Status Logic
  let newStatus = '';
  let logNote = '';
  if (action === 'approve') {
    // กรณี เบิก/ยืม: ไม่ว่าใครกด (Head/PM) ให้ไปสถานะรอจ่ายของทันที
    if (isWithdrawOrBorrow) {
        newStatus = 'Ready to Disburse';
    } 
    // กรณี ซื้อ (Local/HO): เป็นไปตาม Step เดิม
    else {
        if (role === 'Head') {
            newStatus = 'Pending PM';
        } else if (role === 'PM') {
            newStatus = 'Approved';
        }
    }
    logNote = `Approved via Email by ${approver}`;
  } else if (action === 'confirm_reject') { 
    newStatus = 'Rejected';
    logNote = `Rejected via Email by ${approver}: ${customNote}`; 
  }

  if (!req.docNumber && (newStatus === 'Approved' || newStatus === 'Ready to Disburse')) {
      // เรียกใช้ฟังก์ชันที่เพิ่งเพิ่มเข้าไป
      const count = getNextDocIndex(requests, req.type, req.purchaseType);
      req.docNumber = generateDocId(req.type, count, req.purchaseType);
      
      // บันทึก Log เพิ่มเติมว่าระบบสร้างเลขให้แล้ว
      logNote += ` (Generated Doc No: ${req.docNumber})`;
  }

  // Save Data
  req.status = newStatus;
  if (!req.history) req.history = [];
  req.history.push({
    date: new Date().toLocaleString('th-TH'),
    action: newStatus,
    user: userDisplay,
    note: logNote
  });
  
  saveDataToSheet('Requests', req.id, req);

  // --- Trigger Logic ---
  
  // 1. ถ้าต้องส่งต่อ Level 2 (Pending PM) ให้ส่งปุ่มอนุมัติ
  if (newStatus === 'Pending PM') {
    try {
      const pmEmails = findApproverEmails(req.job, 9);
      if (pmEmails) sendApprovalEmail(req, pmEmails, 'PM');
    } catch (e) {
      console.error(`[ProcessEmail] Failed to send PM email: ${e.toString()}`);
    }
  }

  // 2. ⭐⭐ [เพิ่มใหม่] แจ้งเตือนเจ้าของ (Requester) ว่ามีการทำรายการแล้ว ⭐⭐
  try {
      // เรียกฟังก์ชันแจ้งเตือน (ระบบจะกรองเองว่าถ้าเป็น Pending PM จะไม่ส่งซ้ำให้ผู้อนุมัติ แต่จะส่งให้เจ้าของ)
      handleStatusNotification(req);
  } catch (e) {
      console.error(`[ProcessEmail] Failed to notify owner: ${e.toString()}`);
  }

  // Return HTML Result
  const color = newStatus === 'Rejected' ? 'red' : 'green';
  const message = newStatus === 'Rejected' ? 'บันทึกการไม่อนุมัติเรียบร้อย' : 'อนุมัติเรียบร้อย';
  
  // แสดงผลชื่อสถานะแบบใหม่ในหน้าเว็บตอบกลับ
  let displayStatus = newStatus;
  if (newStatus === 'Pending Head') displayStatus = 'Pending Level 1';
  if (newStatus === 'Pending PM') displayStatus = 'Pending Level 2';

  return HtmlService.createHtmlOutput(`
    <div style="font-family: sans-serif; text-align: center; padding: 50px;">
      <h1 style="color: ${color};">${message}</h1>
      <p>เอกสาร: <strong>${reqId}</strong></p>
      <p>สถานะปัจจุบัน: <strong>${displayStatus}</strong></p>
      ${customNote ? `<p>เหตุผล: ${customNote}</p>` : ''}
      <button onclick="window.close()" style="padding: 10px 20px; margin-top:20px; cursor: pointer;">ปิดหน้านี้</button>
    </div>
  `);
}

function findApproverEmails(projectName, permId) {
  console.log(`[FindApprover] ===== START =====`);
  console.log(`[FindApprover] Project: ${projectName}, Permission ID: ${permId}`);
  
  const users = getSheetData('Users');
  console.log(`[FindApprover] Total users in database: ${users.length}`);

  const approvers = users.filter(u => {
    // ⭐ เช็ค Status ต้องเป็น Activated เท่านั้น
    if (u.status !== 'Activated') {
      return false;
    }

    // Super Admin ได้ทุกโครงการ
    if (u.isSuperAdmin) {
      console.log(`[FindApprover] ✅ Found SuperAdmin: ${u.username} (${u.email})`);
      return true;
    }

    // เช็คสิทธิ์ในโครงการ
    if (u.permissions && u.permissions[projectName]) {
      const userPerms = u.permissions[projectName].map(Number); 
      const targetPerm = Number(permId);
      
      // มีสิทธิ์ Admin (2) หรือสิทธิ์เฉพาะที่ต้องการ
      const hasRight = userPerms.includes(2) || userPerms.includes(targetPerm);
      
      if (hasRight) {
        console.log(`[FindApprover] ✅ Found User: ${u.username} (${u.email}) | Permissions: [${userPerms.join(', ')}]`);
      }
      return hasRight;
    }
    
    return false;
  });

  // ⭐ กรองเฉพาะ Email ที่ถูกต้อง
  const emails = approvers
    .map(u => u.email)
    .filter(email => email && email.includes('@') && email.trim() !== '');
  
  const result = emails.join(',');
  console.log(`[FindApprover] ===== RESULT =====`);
  console.log(`[FindApprover] Emails: ${result || '(NONE)'}`);
  console.log(`[FindApprover] ===== END =====`);
  
  return result;
}

// --- HELPER: สร้าง HTML สำหรับ Budget Tracking (UPDATED: Actual Price Logic) ---
function getBudgetInfoForEmail_FullDetail(req) {
  // 1. กรองเฉพาะ HO / Local เท่านั้น
  if (!['Local', 'HO'].includes(req.type)) return '';
  
  // 2. หา SubJob / Mat. Code ที่เกี่ยวข้องในใบนี้
  const uniqueSubJobs = [...new Set(req.items.map(i => i.subJob).filter(val => val))];
  const uniqueMatCodes = [...new Set(req.items.map(i => i.MatCode).filter(val => val))];

  if (uniqueSubJobs.length === 0 && uniqueMatCodes.length === 0) return '';

  // โหลดข้อมูลเพื่อคำนวณ
  const projects = getSheetData('Projects');
  const projectData = projects.find(p => p.name === req.job);
  
  if (!projectData) return '';
  
  const allRequests = getSheetData('Requests');
  const allAssets = getSheetData('Assets'); // ⭐ โหลด Assets มาเพื่อคำนวณราคาจริง
  
  const budgetList = [
      ...uniqueSubJobs.map(c => ({code: c, type: 'SubJob'})),
      ...uniqueMatCodes.map(c => ({code: c, type: 'MatCode'}))
  ];

  let html = `
    <div style="margin-top: 20px; background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; font-family: 'Sarabun', sans-serif;">
      <div style="background-color: #fff8e1; padding: 12px 15px; border-bottom: 1px solid #ffe0b2;">
        <h3 style="margin: 0; font-size: 16px; color: #f57c00;">ติดตามงบประมาณ (Budget Tracking)</h3>
      </div>
      <div style="padding: 15px;">
  `;

  // ฟังก์ชันคำนวณยอดเงิน (Logic เดียวกับหน้าเว็บ)
  const calculateTotal = (r, code, type) => {
      const items = r.items.filter(i => (type === 'SubJob' ? i.subJob : i.MatCode) === code);
      const isRent = r.type === 'HO' && r.purchaseType === 'Rent';

      return items.reduce((sum, item) => {
          // 1. หา Assets ที่เกี่ยวข้อง
          const relatedAssets = allAssets.filter(a => a.currentRequestId === r.id && a.name === item.name);
          // 2. หา Logs
          const receivedLogs = item.receivedLog || [];
          
          let itemVal = 0;
          let cnt = 0;

          // Priority A: Assets
          if (relatedAssets.length > 0) {
              itemVal += relatedAssets.reduce((s, asset) => {
                    const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                    const duration = isRent ? (asset.duration || item.duration || 1) : 1;
                    return s + (price * duration);
              }, 0);
              cnt = relatedAssets.length;
          } 
          // Priority B: Logs
          else if (receivedLogs.length > 0) {
              itemVal += receivedLogs.reduce((s, log) => {
                    const duration = isRent ? (log.duration || 1) : 1;
                    return s + (log.qty * log.price * duration);
              }, 0);
              cnt = item.receivedTotal || 0;
          }

          // Priority C: Estimate Remainder
          // ⭐ [แก้ไขใหม่] ถ้าสถานะเป็น Completed (จบงาน/Force Close) ไม่ต้องเอาเศษที่เหลือมาคิดเงิน
          if (r.status !== 'Completed') { 
              const rem = Math.max(0, item.qty - cnt);
              const dur = isRent ? (item.duration || 1) : 1;
              const estPrice = item.unitPrice || 0;
              itemVal += (rem * estPrice * dur);
          }

          return sum + itemVal;
      }, 0);
  };

  budgetList.forEach(item => {
      // ค้นหางบประมาณตั้งต้น
      const list = item.type === 'SubJob' ? projectData.subJobs : projectData.MatCodes;
      const target = list ? list.find(x => x.code === item.code) : null;
      const budget = target ? (target.budget || 0) : 0;

      if (budget === 0) return; // ข้ามถ้างบเป็น 0

      // --- คำนวณยอด ---
      let used = 0;    // Completed
      let pending = 0; // Waiting
      
      allRequests.forEach(r => {
          // กรองเฉพาะโครงการเดียวกัน (สำคัญ! ป้องกันยอดเบิ้ล)
          if (r.job !== req.job) return; 
          
          if (r.id === req.id) return; // ข้ามใบปัจจุบัน (จะไปคิดในช่อง current)
          if (!['Local', 'HO'].includes(r.type)) return;

          const rTotal = calculateTotal(r, item.code, item.type);

          if (r.status === 'Completed') {
              used += rTotal;
          } else if (!['Draft', 'Rejected', 'Returned'].includes(r.status)) {
              pending += rTotal;
          }
      });

      // ยอดใบปัจจุบัน (Current)
      const current = calculateTotal(req, item.code, item.type);

      const totalUsed = used + pending + current;
      const remaining = budget - totalUsed;
      const isOver = totalUsed > budget;

      // คำนวณ % ความกว้าง
      const usedPct = Math.min((used / budget) * 100, 100);
      const pendingPct = Math.min((pending / budget) * 100, 100 - usedPct);
      const currentPct = Math.min((current / budget) * 100, 100 - usedPct - pendingPct);

      // สร้าง HTML แยกแต่ละส่วน
      html += `
        <div style="margin-bottom: 20px; border-bottom: 1px dashed #eee; padding-bottom: 15px;">
           <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap;">
              <div style="margin-bottom: 4px;">
                 <span style="background-color: ${item.type === 'SubJob' ? '#e8eaf6' : '#f3e5f5'}; color: ${item.type === 'SubJob' ? '#3f51b5' : '#7b1fa2'}; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 11px;">${item.type}</span>
                 <strong style="font-size: 14px; margin-left: 5px;">${item.code}</strong> 
                 <span style="color:#888; font-size: 12px;">(งบ: ${budget.toLocaleString()})</span>
              </div>
              <div style="font-size: 13px; font-weight: bold; ${isOver ? 'color: #d32f2f; background: #ffebee; padding: 2px 5px; border-radius: 4px;' : 'color: #333;'}">
                 ใช้รวม: ${totalUsed.toLocaleString()} ${isOver ? '<span style="color:red; font-size:10px;">(เกินงบ!)</span>' : ''}
              </div>
           </div>

           <div style="height: 10px; width: 100%; background-color: #f1f1f1; border-radius: 5px; overflow: hidden; display: flex; margin-bottom: 8px;">
              <div style="width: ${usedPct}%; background-color: #4caf50;" title="ใช้แล้ว"></div>
              <div style="width: ${pendingPct}%; background-color: #ffc107;" title="รออนุมัติใบอื่น"></div>
              <div style="width: ${currentPct}%; background-color: #ff9800;" title="ใบนี้"></div>
           </div>
           
           <div style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 11px; color: #555;">
              <div style="display: flex; align-items: center;">
                 <div style="width: 8px; height: 8px; background-color: #4caf50; border-radius: 50%; margin-right: 4px;"></div>
                 ใช้แล้ว (${used.toLocaleString()})
              </div>
              <div style="display: flex; align-items: center;">
                 <div style="width: 8px; height: 8px; background-color: #ffc107; border-radius: 50%; margin-right: 4px;"></div>
                 รออนุมัติ (${pending.toLocaleString()})
              </div>
              <div style="display: flex; align-items: center;">
                 <div style="width: 8px; height: 8px; background-color: #ff9800; border-radius: 50%; margin-right: 4px;"></div>
                 ใบนี้ (${current.toLocaleString()})
              </div>
              
              <div style="margin-left: auto; font-weight: bold; font-size: 12px; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                 คงเหลือ: ${remaining.toLocaleString()}
              </div>
           </div>
        </div>
      `;
  });

  html += `</div></div>`;
  return html;
}

function sendApprovalEmail(req, targetEmail, targetRole) {
  console.log(`[SendEmail] ===== START =====`);
  
  if (!targetEmail || targetEmail.trim() === '') {
    console.error(`[SendEmail] ❌ ERROR: Target email is empty!`);
    return;
  }

  // โหลดข้อมูล Inventory และ Assets เพื่อเช็คสต็อก
  const inventory = getSheetData('Inventory');
  const assets = getSheetData('Assets');

  const scriptUrl = ScriptApp.getService().getUrl();
  const approverName = targetEmail; 

  const approveLink = `${scriptUrl}?action=approve&id=${req.id}&role=${targetRole}&approver=${approverName}`;
  const rejectLink = `${scriptUrl}?action=reject&id=${req.id}&role=${targetRole}&approver=${approverName}`;
  
  let grandTotal = 0;
  
  // แปลงหน่วยเวลาเช่าเป็นภาษาไทย
  const getRentalUnitTh = (unit) => {
      if(unit === 'Day') return 'วัน';
      if(unit === 'Month') return 'เดือน';
      if(unit === 'Year') return 'ปี';
      return unit || 'เดือน'; // Default
  };

  const itemsHtml = req.items.map((item, idx) => {
    const isRent = req.type === 'HO' && req.purchaseType === 'Rent';
    const duration = isRent ? (item.duration || 1) : 1;
    const rentalUnitTh = getRentalUnitTh(item.rentalUnit);
    const total = item.qty * (item.unitPrice || 0) * duration;
    grandTotal += total;

    // --- คำนวณสต็อกคงเหลือ (Logic เดียวกับ Web App) ---
    let stockInfo = '';
    const matchingStocks = inventory.filter(inv => inv.name === item.name && inv.project === req.job);
    const totalStockQty = matchingStocks.reduce((sum, inv) => sum + inv.qty, 0);
    const availableAssets = assets.filter(a => a.name === item.name && a.project === req.job && a.status === 'Available').length;

    if (totalStockQty > 0) {
        stockInfo += `<div style="font-size:10px; color:#00796b; background-color:#e0f2f1; padding:2px 4px; border-radius:3px; display:inline-block; margin-top:2px;">มีในคลัง: ${totalStockQty}</div> `;
    }
    if (availableAssets > 0) {
        stockInfo += `<div style="font-size:10px; color:#283593; background-color:#e8eaf6; padding:2px 4px; border-radius:3px; display:inline-block; margin-top:2px;">ว่าง: ${availableAssets}</div>`;
    }
    // ---------------------------------------------
    
    // Mobile-friendly table row with NOTE column
    return `
      <tr style="border-bottom: 1px solid #eee;">
        <td style="padding: 12px 5px; vertical-align: top; width: 30px;">${idx + 1}</td>
        <td style="padding: 12px 5px; vertical-align: top;">
          <div style="font-weight: bold; color: #333; font-size: 14px;">${item.name}</div>
          <div style="font-size: 12px; color: #666; margin-top: 4px;">
            ${item.subJob ? `<span style="background:#e3f2fd; color:#1565c0; padding:2px 4px; border-radius:3px;">Sub: ${item.subJob}</span>` : ''} 
            ${item.MatCode ? `<span style="background:#f3e5f5; color:#7b1fa2; padding:2px 4px; border-radius:3px;">EP: ${item.MatCode}</span>` : ''}
          </div>
          <div style="margin-top: 5px; font-size: 12px; color: #555;">
             ${item.note ? `${item.note}<br/>` : ''}
             ${stockInfo}
          </div>
        </td>
        <td style="padding: 12px 5px; text-align: right; vertical-align: top; white-space: nowrap;">
            <div style="font-weight: bold;">${item.qty} ${item.unit}</div>
            ${isRent ? `<div style="font-size:10px; color:blue;">x ${duration} ${rentalUnitTh}</div>` : ''}
        </td>
        <td style="padding: 12px 5px; text-align: right; vertical-align: top; white-space: nowrap;">
            <div style="font-size: 12px; color:#666;">@${item.unitPrice.toLocaleString()}</div>
            <div style="font-weight: bold; color: #333; font-size: 14px;">${total.toLocaleString()}</div>
        </td>
      </tr>
    `;
  }).join('');

  // ⭐ เรียก Budget HTML (Full Detail)
  const budgetHtml = getBudgetInfoForEmail_FullDetail(req);

  const htmlBody = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
        body { margin: 0; padding: 0; background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background-color: #ffffff; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        .header { background-color: #1976d2; padding: 25px 20px; color: #ffffff; }
        .content { padding: 20px; }
        .btn { 
            display: inline-block; 
            padding: 12px 24px; 
            text-decoration: none; 
            border-radius: 6px; 
            font-weight: bold; 
            font-size: 16px; 
            text-align: center;
            margin: 5px;
        }
        .btn-approve { background-color: #2e7d32; color: white !important; }
        .btn-reject { background-color: #d32f2f; color: white !important; }
        .btn-link { background-color: #fff; color: #1976d2 !important; border: 1px solid #1976d2; font-size: 14px; padding: 10px 20px;}
        
        @media only screen and (max-width: 600px) {
          .btn { display: block; width: 90%; margin: 10px auto; }
          .meta-table td { display: block; width: 100%; padding-bottom: 5px; }
          .header h2 { font-size: 20px; }
        }
      </style>
    </head>
    <body>
      <div style="padding: 10px;">
        <div class="container">
          
          <div class="header">
            <h2 style="margin: 0;">คำขออนุมัติ: ${req.id}</h2>
            <p style="margin: 5px 0 0; opacity: 0.9;">โครงการ: <strong>${req.job}</strong></p>
            <p style="margin: 2px 0 0; opacity: 0.9; font-size: 14px;">ผู้ขอ: ${req.requester}</p>
          </div>
          
          <div class="content">
            <table class="meta-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px; color: #444;">
              <tr>
                <td style="padding: 5px; color: #888;">ประเภท:</td>
                <td style="padding: 5px; font-weight: bold; color: #333;">${req.type} ${req.purchaseType || ''}</td>
              </tr>
              <tr>
                <td style="padding: 5px; color: #888;">วันที่ต้องการ:</td>
                <td style="padding: 5px; font-weight: bold; color: #333;">${req.dateRequired}</td>
              </tr>
              <tr>
                <td style="padding: 5px; color: #888;">ความสำคัญ:</td>
                <td style="padding: 5px; font-weight: bold; color: ${req.priority === 'Critical' ? 'red' : 'blue'};">${req.priority}</td>
              </tr>
            </table>

            <h3 style="border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 0; font-size: 16px; color: #333;">รายการสินค้า</h3>
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
              <thead style="background-color: #f9fafb; color: #666; font-size: 12px;">
                <tr>
                  <th style="padding: 8px 5px; text-align: left;">#</th>
                  <th style="padding: 8px 5px; text-align: left;">รายการ / หมายเหตุ</th>
                  <th style="padding: 8px 5px; text-align: right;">จำนวน</th>
                  <th style="padding: 8px 5px; text-align: right;">รวมเงิน</th>
                </tr>
              </thead>
              <tbody>
                ${itemsHtml}
              </tbody>
              <tfoot style="background-color: #f1f8e9;">
                <tr>
                  <td colspan="3" style="padding: 10px; text-align: right; font-weight: bold; color: #333;">รวมสุทธิ</td>
                  <td style="padding: 10px 5px; text-align: right; font-weight: bold; color: #1976d2; font-size: 16px;">${grandTotal.toLocaleString()}</td>
                </tr>
              </tfoot>
            </table>
            
            ${req.note ? `
              <div style="margin-top: 20px; padding: 12px; background-color: #fff8e1; border-radius: 6px; border-left: 4px solid #ffc107; font-size: 14px;">
                <strong>หมายเหตุเพิ่มเติม:</strong> ${req.note}
              </div>` : ''}

            ${budgetHtml}

            <div style="margin-top: 30px; text-align: center; border-top: 1px solid #eee; padding-top: 20px;">
              <p style="margin-bottom: 15px; font-weight: bold; color: #555;">กรุณาเลือกการดำเนินการ:</p>
              
              <a href="${approveLink}" class="btn btn-approve">✅ อนุมัติ (Approve)</a>
              <a href="${rejectLink}" class="btn btn-reject">❌ ไม่อนุมัติ (Reject)</a>
              
              <div style="margin-top: 20px;">
                 <a href="${scriptUrl}" target="_blank" class="btn btn-link">เปิดดูในแอป (Open App)</a>
              </div>

              <p style="font-size: 12px; color: #999; margin-top: 15px;">เมื่อกดปุ่ม ระบบจะบันทึกสถานะทันที</p>
            </div>

          </div>
        </div>
      </div>
    </body>
    </html>
  `;

  try {
    GmailApp.sendEmail(targetEmail, `[PurchaseHub] ขออนุมัติ: ${req.id} - ${req.job}`, '', {
      htmlBody: htmlBody
    });
    console.log(`[SendEmail] ✅ Email sent successfully to ${targetEmail}`);
  } catch (error) {
    console.error(`[SendEmail] ❌ Failed to send email: ${error.toString()}`);
  }

  console.log(`[SendEmail] ===== END =====`);
}

function syncRequest(request) {
  console.log(`[SyncRequest] ===== START =====`);
  console.log(`[SyncRequest] Request ID: ${request.id}`);
  console.log(`[SyncRequest] Status: ${request.status}`);
  console.log(`[SyncRequest] Job: ${request.job}`);
  
  // 1. บันทึกข้อมูล (เหมือนเดิม)
  const result = saveDataToSheet('Requests', request.id, request);
  
// 2. ระบบส่งเมลอนุมัติ (Approval Buttons)
  try {
      if (request.status === 'Pending Head') {
          // ⭐⭐ [แก้ไข] เช็คประเภทคำขอ ⭐⭐
          if (request.type === 'Withdraw' || request.type === 'Borrow') {
              // กรณีเบิก/ยืม: หาอีเมลทั้ง 2 ระดับ
              const headEmails = findApproverEmails(request.job, 8); // Level 1
              const pmEmails = findApproverEmails(request.job, 9);   // Level 2
              
              // รวมอีเมลเป็น string เดียวกัน (คั่นด้วย comma)
              let recipients = [];
              if (headEmails) recipients.push(headEmails);
              if (pmEmails) recipients.push(pmEmails);
              
              // ถ้ามีคนรับ ให้ส่งครั้งเดียวโดยใช้ Role กลางว่า 'Approver'
              if (recipients.length > 0) {
                  const combinedEmails = recipients.join(',');
                  sendApprovalEmail(request, combinedEmails, 'Approver'); 
              }
          } else {
              // กรณีปกติ (ซื้อ Local/HO): ส่งตามลำดับขั้นเดิม
              const headEmails = findApproverEmails(request.job, 8);
              if (headEmails) sendApprovalEmail(request, headEmails, 'Head');
          }
      }
      else if (request.status === 'Pending PM') {
          const pmEmails = findApproverEmails(request.job, 9);
          if (pmEmails) sendApprovalEmail(request, pmEmails, 'PM');
      } 
  } catch (e) {
      console.error("❌ [SyncRequest] Approval Email FAILED: " + e.toString());
  }

  // 3. ระบบแจ้งเตือนสถานะ (Notification) (เหมือนเดิม)
  try {
      handleStatusNotification(request);
  } catch (e) {
      console.error("❌ [SyncRequest] Notification Email FAILED: " + e.toString());
  }

  console.log(`[SyncRequest] ===== END =====`);
  return result;
}

// --- HELPER FUNCTIONS ---



// แก้ไขฟังก์ชัน getSheetData ใน Code.gs
function getSheetData(sheetName) {
  // 1. อ่านข้อมูลจาก Supabase โดยดึงมาเฉพาะ column 'payload'
  // ใช้ sheetName.toLowerCase() เพื่อแปลง Requests -> requests ให้ตรงกับชื่อตารางใน Supabase
  const jsonResponse = callSupabase(sheetName.toLowerCase(), 'get', null, '?select=payload');
  
  // 2. แปลง Text เป็น Object
  const data = JSON.parse(jsonResponse);
  
  // 3. ⭐ จุดสำคัญ: แกะกล่อง payload ออกมา
  // เปลี่ยนจาก [{payload: {...}}, {payload: {...}}] ให้กลายเป็น [{...}, {...}]
  if (Array.isArray(data)) {
    return data.map(row => row.payload); 
  } else {
    return []; // กรณีไม่มีข้อมูล หรือ Error
  }
}

function saveDataToSheet(sheetName, id, dataObj) {
  // ใช้ UPSERT (ถ้ามี ID นี้แล้วให้ทับ ถ้าไม่มีให้สร้างใหม่)
  const record = {
    id: id.toString(), // บังคับเป็น String
    payload: dataObj   // เก็บข้อมูลก้อนใหญ่ใน jsonb
  };
  
  // การเรียกใช้แบบ POST พร้อม header Prefer: resolution=merge-duplicates คือการทำ Upsert ใน Supabase
  const table = sheetName.toLowerCase();
  const url = `${SUPABASE_URL}/rest/v1/${table}`;
  const options = {
    method: 'post',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'resolution=merge-duplicates' // ⭐ หัวใจสำคัญ: สั่งให้ทับถ้า ID ซ้ำ
    },
    payload: JSON.stringify(record)
  };
  
  UrlFetchApp.fetch(url, options);
  return true;
}

function deleteDataFromSheet(sheetName, id) {
  // สั่งลบแถวที่ id ตรงกัน
  callSupabase(sheetName, 'delete', null, `?id=eq.${id}`);
}

// --- FILE UPLOAD FUNCTIONS ---

function uploadFileToDrive(base64Data, fileName) {
  try {
    const FOLDER_ID = "1M57m68rI8bM-BBqRlh_LzZHuDWPZVdwz"; 
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return {
      name: fileName,
      url: file.getUrl(),
      id: file.getId()
    };
  } catch (e) {
    return { error: e.toString() };
  }
}

function getOrCreateSubFolder(parentFolderId, subFolderName) {
  const parentFolder = DriveApp.getFolderById(parentFolderId);
  const folders = parentFolder.getFoldersByName(subFolderName);
  if (folders.hasNext()) {
    return folders.next();
  } else {
    return parentFolder.createFolder(subFolderName);
  }
}

function uploadAssetImage(base64Data, fileName) {
  try {
    const MAIN_FOLDER_ID = "1M57m68rI8bM-BBqRlh_LzZHuDWPZVdwz"; 
    const SUB_FOLDER_NAME = "Asset_Images"; 
    const targetFolder = getOrCreateSubFolder(MAIN_FOLDER_ID, SUB_FOLDER_NAME);
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    const file = targetFolder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return {
      name: fileName,
      url: file.getUrl(),
      id: file.getId()
    };
  } catch (e) {
    return { error: e.toString() };
  }
}

// --- SPECIFIC SYNC FUNCTIONS ---

function syncProject(project) {
  return saveDataToSheet('Projects', project.id, project);
}

function deleteProjectFromSheet(id) {
  deleteDataFromSheet('Projects', id);
}


function syncInventory(item) {
  return saveDataToSheet('Inventory', item.id, item);
}

function syncAsset(asset) {
  return saveDataToSheet('Assets', asset.id, asset);
}

function syncLog(log) {
  const id = log.date + '_' + Math.floor(Math.random() * 1000); 
  return saveDataToSheet('Logs', id, log);
}

// --- USER MANAGEMENT & MAIN API ---

function loginUser(username, password) {
  if (username === 'admin' && password === '1231') {
    return {
      success: true,
      user: {
        username: 'admin',
        firstName: 'System',
        lastName: 'Administrator',
        empId: 'ADMIN-001',
        role: 'Admin (ผู้ดูแลระบบ)',
        isSuperAdmin: true,
        status: 'Activated'
      }
    };
  }

  const users = getSheetData('Users');
  const user = users.find(u => u.username === username && u.password === password);
  
  if (user) {
    if (user.status !== 'Activated') {
       return { success: false, message: 'บัญชีนี้ถูกระงับการใช้งาน หรือรอการอนุมัติ' };
    }
    return { 
      success: true, 
      user: {
        ...user,
        password: '' 
      }
    };
  } else {
    return { success: false, message: 'ชื่อผู้ใช้งานหรือรหัสผ่านไม่ถูกต้อง' };
  }
}

function registerUser(formData) {
  const users = getSheetData('Users');
  if (users.some(u => u.username === formData.username)) {
    return { success: false, message: 'Username นี้ถูกใช้งานแล้ว' };
  }
  
  const newUser = {
    id: formData.username, 
    ...formData,
    role: 'User', 
    status: 'New', 
    permissions: {}, 
    createdAt: new Date().toLocaleString('th-TH')
  };
  
  saveDataToSheet('Users', newUser.id, newUser);
  return { success: true, message: 'ลงทะเบียนเรียบร้อย รอแอดมินอนุมัติ' };
}

// [ค้นหาฟังก์ชัน saveUserData เดิม แล้วแทนที่ด้วยโค้ดนี้]

function saveUserData(user) {
  const users = getSheetData('Users');
  
  // ⭐ ป้องกันรหัสพนักงาน (Emp ID) ซ้ำ
  // เช็คว่ามีคนอื่นที่ใช้ EmpID นี้ไหม (ที่ไม่ใช่ตัวเอง)
  const duplicate = users.find(u => u.empId === user.empId && u.id !== user.id);
  if (duplicate) {
    return { 
      success: false, 
      message: `ไม่สามารถบันทึกได้: รหัสพนักงาน ${user.empId} ซ้ำกับคุณ ${duplicate.firstName} ${duplicate.lastName}` 
    };
  }

  // ถ้าไม่ซ้ำ ให้บันทึก
  saveDataToSheet('Users', user.id, user);
  return { success: true, message: 'บันทึกข้อมูลเรียบร้อย' };
}

function loadInitialData() {
  const settings = getSheetData('Settings');
  const announcement = settings.find(s => s.id === 'ANNOUNCEMENT') || null;
  
  return {
    requests: getSheetData('Requests'),
    inventory: getSheetData('Inventory'),
    assets: getSheetData('Assets'),
    // logs: getSheetData('Logs'), // ❌ ปิดบรรทัดนี้ เพื่อไม่ให้โหลด Logs ก้อนยักษ์ตอนเปิดแอป
    logs: [], // ✅ ส่ง Array ว่างกลับไปก่อนเพื่อให้หน้าเว็บไม่พัง
    projects: getSheetData('Projects'),
    users: getSheetData('Users'),
    announcement: announcement
  };
}

// ⭐ เพิ่มฟังก์ชันใหม่สำหรับโหลด Logs แยกต่างหาก
// ดึงข้อมูลแค่ 100 รายการล่าสุด (ช่วยลดภาระได้มหาศาล)
function getRecentLogs(limit = 100) {
  // order=id.desc คือเรียงจาก id ล่าสุด (ถ้า id คุณรันตามเวลา)
  // limit=100 คือเอาแค่ 100 รายการ
  const params = `?select=payload&order=id.desc&limit=${limit}`; 
  const jsonResponse = callSupabase('logs', 'get', null, params);
  const data = JSON.parse(jsonResponse);
  
  if (Array.isArray(data)) {
    return data.map(row => row.payload);
  } else {
    return [];
  }
}
// 1. แก้ไขฟังก์ชันส่ง OTP ให้รับ empId มาเช็คด้วย
function sendRegistrationOTP(email, username, empId) { // ⭐ รับพารามิเตอร์ empId เพิ่ม
  const users = getSheetData('Users');

  // ตรวจสอบ Username ซ้ำ
  if (users.some(u => u.username === username)) {
    return { success: false, message: 'ชื่อผู้ใช้งาน (Username) นี้ถูกใช้งานแล้ว กรุณาเปลี่ยนใหม่' };
  }

  // ⭐ ตรวจสอบ EmpID ซ้ำ (เพิ่มส่วนนี้)
  if (users.some(u => u.empId === empId)) {
    return { success: false, message: 'รหัสพนักงานนี้มีอยู่ในระบบแล้ว' };
  }

  // ตรวจสอบ Email ซ้ำ
  if (users.some(u => u.email === email)) {
    return { success: false, message: 'อีเมลนี้ถูกใช้งานแล้วในระบบ' };
  }

  // ... (โค้ดสร้าง OTP ส่วนที่เหลือเหมือนเดิม) ...
  const otp = Math.floor(1000 + Math.random() * 9000).toString();
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let refCode = '';
  for (let i = 0; i < 4; i++) {
    refCode += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  
  CacheService.getScriptCache().put('OTP_' + email, otp, 300);

  try {
    GmailApp.sendEmail(email, `[PurchaseHub] รหัสยืนยัน (Ref: ${refCode})`, 
      `รหัสอ้างอิง (Ref Code): ${refCode}\n\nรหัส OTP ของคุณคือ: ${otp}\n\n(รหัสมีอายุ 5 นาที)`);
    return { success: true, message: 'ส่งรหัส OTP แล้ว', refCode: refCode };
  } catch (e) {
    return { success: false, message: 'ส่งอีเมลไม่สำเร็จ: ' + e.toString() };
  }
}

// 2. แก้ไขฟังก์ชันบันทึกข้อมูล (เช็คซ้ำอีกรอบก่อนบันทึก)
function registerUser(formData, otp) {
  const cachedOtp = CacheService.getScriptCache().get('OTP_' + formData.email);
  if (!cachedOtp || cachedOtp !== otp) {
    return { success: false, message: 'รหัส OTP ไม่ถูกต้อง หรือหมดอายุ (กรุณากดรับรหัสใหม่)' };
  }
  
  CacheService.getScriptCache().remove('OTP_' + formData.email);

  const users = getSheetData('Users');
  
  // เช็ค Username ซ้ำ
  if (users.some(u => u.username === formData.username)) {
    return { success: false, message: 'Username นี้ถูกใช้งานแล้ว' };
  }

  // ⭐ เช็ค EmpID ซ้ำ (เพิ่มส่วนนี้)
  if (users.some(u => u.empId === formData.empId)) {
    return { success: false, message: 'รหัสพนักงานนี้ถูกใช้งานแล้ว' };
  }
  
  const newUser = {
    id: formData.username, 
    ...formData,
    role: 'User', 
    status: 'New', 
    permissions: {}, 
    createdAt: new Date().toLocaleString('th-TH')
  };
  saveDataToSheet('Users', newUser.id, newUser);
  return { success: true, message: 'ลงทะเบียนเรียบร้อย รอแอดมินอนุมัติ' };
}
// --- [Server Side] ฟังก์ชันสำหรับระบบลืมรหัสผ่าน ---

// 1. ส่ง OTP เพื่อขอเปลี่ยนรหัสผ่าน
function sendForgotPasswordOTP(email) {
  const users = getSheetData('Users');
  const user = users.find(u => u.email === email);
  
  if (!user) {
    return { success: false, message: 'ไม่พบอีเมลนี้ในระบบ' };
  }

  // สร้าง OTP และ Ref Code
  const otp = Math.floor(1000 + Math.random() * 9000).toString();
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let refCode = '';
  for (let i = 0; i < 4; i++) { refCode += chars.charAt(Math.floor(Math.random() * chars.length)); }
  
  // เก็บลง Cache (ใช้ key ต่างจากตอนสมัครสมาชิกเพื่อความปลอดภัย)
  CacheService.getScriptCache().put('RESET_OTP_' + email, otp, 300); // 5 นาที

  try {
    GmailApp.sendEmail(email, `[PurchaseHub] รหัสรีเซ็ตรหัสผ่าน (Ref: ${refCode})`, 
      `รหัสอ้างอิง (Ref Code): ${refCode}\n\nรหัส OTP สำหรับตั้งรหัสผ่านใหม่คือ: ${otp}\n\n(รหัสมีอายุ 5 นาที)`);
    return { success: true, message: 'ส่งรหัส OTP ไปยังอีเมลแล้ว', refCode: refCode };
  } catch (e) {
    return { success: false, message: 'ส่งอีเมลไม่สำเร็จ: ' + e.toString() };
  }
}

// 2. ยืนยัน OTP และเปลี่ยนรหัสผ่านทันที
function resetPassword(email, otp, newPassword) {
  // ตรวจสอบ OTP
  const cachedOtp = CacheService.getScriptCache().get('RESET_OTP_' + email);
  if (!cachedOtp || cachedOtp !== otp) {
    return { success: false, message: 'รหัส OTP ไม่ถูกต้อง หรือหมดอายุ' };
  }

  // ค้นหาและอัปเดตข้อมูล User
  const users = getSheetData('Users');
  const user = users.find(u => u.email === email);
  
  if (user) {
    user.password = newPassword; // อัปเดตรหัสผ่านใหม่
    saveDataToSheet('Users', user.id, user); // บันทึกลง Sheet
    
    CacheService.getScriptCache().remove('RESET_OTP_' + email); // ลบ OTP ทิ้ง
    return { success: true, message: 'เปลี่ยนรหัสผ่านสำเร็จ กรุณาเข้าสู่ระบบด้วยรหัสใหม่' };
  }
  
  return { success: false, message: 'เกิดข้อผิดพลาด ไม่พบข้อมูลผู้ใช้' };
}

// --- เพิ่มฟังก์ชันกู้คืนชื่อผู้ใช้งาน ---
function sendUsernameToEmail(email) {
  const users = getSheetData('Users');
  const user = users.find(u => u.email === email);
  
  if (!user) {
    return { success: false, message: 'ไม่พบอีเมลนี้ในระบบ' };
  }

  try {
    GmailApp.sendEmail(email, '[PurchaseHub] กู้คืนชื่อผู้ใช้งาน (Username Recovery)', 
      `เรียนคุณ ${user.firstName},\n\nชื่อผู้ใช้งาน (Username) ของคุณคือ: ${user.username}\n\nหากคุณไม่ได้ทำรายการนี้ โปรดติดต่อผู้ดูแลระบบ`);
    return { success: true, message: 'ระบบได้ส่งชื่อผู้ใช้งาน (Username) ไปที่อีเมลของคุณแล้ว' };
  } catch (e) {
    return { success: false, message: 'ส่งอีเมลไม่สำเร็จ: ' + e.toString() };
  }
}

// --- [เพิ่มฟังก์ชันนี้ที่ท้ายไฟล์ Code.gs] ---



// ฟังก์ชันอัปเดตข้อมูลผู้ใช้ในทุก Sheet (Requests, Assets, Logs)
// --- [Code.gs] ---

// ⭐ ฟังก์ชันอัปเดตข้อมูลย้อนหลังทั่วทั้งระบบ (Global Update) - ฉบับ Supabase
function updateUserGlobalData(oldData, newData) {
  console.log(`[GlobalUpdate] Starting... from ${oldData.empId} to ${newData.empId}`);

  // 1. เตรียมรูปแบบข้อมูลใหม่
  const newFullSig = `${newData.empId} ${newData.firstName} ${newData.lastName}`;
  const newShortName = `${newData.firstName} ${newData.lastName}`;

  // 2. รูปแบบข้อมูลเก่าที่ต้องการค้นหา
  const oldPatterns = [
    `${oldData.empId} ${oldData.firstName} ${oldData.lastName}`,
    `${oldData.empId} ${oldData.firstName} ${oldData.lastName} (Email)`,
    `${oldData.firstName} ${oldData.lastName}`,
    `${oldData.empId} ${oldData.firstName}`,
    oldData.empId
  ];

  const isMatch = (value) => {
    if (!value || typeof value !== 'string') return false;
    const val = value.trim();
    return oldPatterns.some(pattern => {
      if (pattern === oldData.empId) return val.startsWith(pattern);
      return val === pattern || val.replace(/\s+/g, ' ') === pattern;
    });
  };

  let countReq = 0;
  let countLog = 0;
  let countAsset = 0;

  // --- Helper ดึงข้อมูลพร้อม ID (เพราะ Logs ไม่มี ID ใน Payload) ---
  const getTableData = (table) => {
    const res = callSupabase(table, 'get', null, '?select=id,payload');
    const data = JSON.parse(res);
    return Array.isArray(data) ? data : [];
  };

  // --- 1. อัปเดตตาราง Requests ---
  const requestRows = getTableData('Requests');
  requestRows.forEach(row => {
    let req = row.payload;
    let changed = false;

    // แก้ไขชื่อผู้ขอและผู้อนุมัติ
    if (isMatch(req.requester)) { req.requester = newShortName; changed = true; }
    if (isMatch(req.approverL1)) { req.approverL1 = newFullSig; changed = true; }
    if (isMatch(req.approverL2)) { req.approverL2 = newFullSig; changed = true; }

    // แก้ไขใน History
    if (req.history && Array.isArray(req.history)) {
      req.history.forEach(h => {
        if (isMatch(h.user)) { h.user = newFullSig; changed = true; }
      });
    }

    if (changed) {
      saveDataToSheet('Requests', row.id, req);
      countReq++;
    }
  });

  // --- 2. อัปเดตตาราง Logs (ประวัติรวม) ---
  const logRows = getTableData('Logs');
  logRows.forEach(row => {
    let log = row.payload;
    if (isMatch(log.by)) {
      log.by = newFullSig;
      saveDataToSheet('Logs', row.id, log);
      countLog++;
    }
  });

  // --- 3. อัปเดตตาราง Assets (ผู้ถือครอง) ---
  const assetRows = getTableData('Assets');
  assetRows.forEach(row => {
    let asset = row.payload;
    if (isMatch(asset.holder)) {
      asset.holder = newShortName;
      saveDataToSheet('Assets', row.id, asset);
      countAsset++;
    }
  });

  return {
    success: true,
    message: `อัปเดตข้อมูลย้อนหลังสำเร็จ: เอกสาร(${countReq}), ประวัติ(${countLog}), ทรัพย์สิน(${countAsset})`
  };
}

// [เพิ่ม/แก้ไข ฟังก์ชันใน Code.gs]

// 1. ฟังก์ชันดึงประกาศ "ทั้งหมด" (สำหรับหน้าจัดการของ Admin)
function getAllAnnouncements() {
  const settings = getSheetData('Settings');
  // กรองเอาเฉพาะ Row ที่ ID ขึ้นต้นด้วย ANN-
  return settings.filter(s => s.id && s.id.toString().startsWith('ANN-'));
}

// 2. ฟังก์ชันดึงประกาศ "เฉพาะที่ Active" (สำหรับหน้า Login / Public)
function getPublicAnnouncements() {
  const settings = getSheetData('Settings');
  // กรองเฉพาะ Active = true
  return settings.filter(s => s.id && s.id.toString().startsWith('ANN-') && s.active === true);
}

// 3. บันทึกประกาศ (สร้างใหม่ หรือ แก้ไข)
function saveAnnouncementItem(data) {
  // ถ้าไม่มี ID ให้สร้างใหม่
  const id = data.id || `ANN-${new Date().getTime()}`;
  
  const payload = {
    ...data,
    id: id,
    updatedBy: data.updatedBy,
    timestamp: new Date().toLocaleString('th-TH')
  };
  
  saveDataToSheet('Settings', id, payload);
  return { success: true, message: 'บันทึกประกาศเรียบร้อย', data: payload };
}

// 4. ลบประกาศ
function deleteAnnouncementItem(id) {
  deleteDataFromSheet('Settings', id);
  return { success: true, message: 'ลบประกาศแล้ว' };
}

// 5. เปลี่ยนสถานะ (เปิด/ปิด ประกาศ)
function toggleAnnouncementStatus(id, isActive) {
  const settings = getSheetData('Settings');
  const target = settings.find(s => s.id === id);
  if (target) {
    target.active = isActive;
    saveDataToSheet('Settings', id, target);
    return { success: true, message: isActive ? 'เผยแพร่ประกาศแล้ว' : 'หยุดประกาศแล้ว' };
  }
  return { success: false, message: 'ไม่พบข้อมูล' };
}

// --- เพิ่มต่อท้ายไฟล์ code.gs ---

function uploadUserSignature(base64Data, fileName) {
  try {
    const MAIN_FOLDER_ID = "1M57m68rI8bM-BBqRlh_LzZHuDWPZVdwz"; // ใช้ ID โฟลเดอร์หลักเดิม
    const SUB_FOLDER_NAME = "User_Signatures"; // ชื่อโฟลเดอร์เก็บลายเซ็น
    const targetFolder = getOrCreateSubFolder(MAIN_FOLDER_ID, SUB_FOLDER_NAME);
    
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    
    const file = targetFolder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    return {
      name: fileName,
      url: file.getUrl(),
      id: file.getId()
    };
  } catch (e) {
    return { error: e.toString() };
  }
}


// --- NOTIFICATION SYSTEM (NEW) ---

// --- NOTIFICATION SYSTEM (UPDATED FOR ROLLBACK) ---

function handleStatusNotification(req) {
  const status = req.status;
  if (status === 'Draft') return;

  // 1. หาอีเมลผู้ขอ (เจ้าของ Order)
  const requesterEmail = findUserEmail(req.requester);
  
  // 2. หาอีเมลผู้รับผิดชอบขั้นตอนถัดไป
  let nextActorEmails = [];
  if (status !== 'Pending Head' && status !== 'Pending PM') {
      const permId = getPermissionForStatus(req);
      if (permId) {
          const emailsStr = findApproverEmails(req.job, permId);
          if (emailsStr) nextActorEmails = emailsStr.split(',');
      }
  }

  // 3. รวมรายชื่อผู้รับ (ผู้ขอ + ผู้อนุมัติขั้นถัดไป)
  let recipients = [requesterEmail, ...nextActorEmails]
      .filter(email => email && email.includes('@'))
      .map(e => e.trim());
  recipients = [...new Set(recipients)];

  if (recipients.length === 0) return;

  // จัดการชื่อสถานะสำหรับแสดงผล
  let displayStatus = status;
  if (status === 'Pending Head') displayStatus = 'Pending Level 1';
  if (status === 'Pending PM') displayStatus = 'Pending Level 2';

  // ⭐ [เพิ่มใหม่] ตรวจสอบว่าเป็น Rollback หรือไม่ (เช็คจาก Note ในประวัติล่าสุด)
  let subjectPrefix = `[อัปเดตสถานะ: ${displayStatus}]`;
  
  const lastLog = req.history && req.history.length > 0 ? req.history[req.history.length - 1] : null;
  // ถ้า Note มีคำว่า Rollback ให้เปลี่ยนหัวข้อเมล
  if (lastLog && lastLog.note && (lastLog.note.includes('Rollback') || lastLog.note.includes('ย้อนกลับ'))) {
      subjectPrefix = `[แจ้งเตือน: ย้อนสถานะ (Rollback) กลับเป็น ${displayStatus}]`;
  }

  // 4. สร้างเนื้อหาและส่ง
  const subject = `${subjectPrefix} ${req.id} - โครงการ ${req.job}`;
  const body = createNotificationBody(req, displayStatus);

  recipients.forEach(email => {
      try {
          GmailApp.sendEmail(email, subject, '', { htmlBody: body });
          console.log(`[Notification] Sent to ${email}`);
      } catch (e) {
          console.error(`[Notification] Error: ${e.toString()}`);
      }
  });
}
// ฟังก์ชันจับคู่สถานะ -> สิทธิ์ของผู้ที่ต้องทำรายการต่อ
function getPermissionForStatus(req) {
  switch (req.status) {
    case 'Pending Check': return 10; // รอตรวจสอบ -> ฝ่าย Verify (10)
    case 'Revise Needed': return null; // รอแก้ไข -> ผู้ขอ (ไม่ต้องหาสิทธิ์เพิ่ม)
    
    // Approved -> แยกตามประเภท
    case 'Approved': 
        if (req.type === 'Local') return 12; // Local -> รอออก PO/สั่งซื้อ (12)
        if (req.type === 'HO' && req.purchaseType === 'Buy') return 11; // HO Buy -> รอออก PR (11)
        if (req.type === 'HO' && req.purchaseType === 'Rent') return req.needContract !== false ? 14 : 13; // HO Rent -> สัญญา (14) หรือ ส่งของ (13)
        return null;

    case 'PR Issued': return 12; // PR ออกแล้ว -> รอออก PO (12)
    case 'PO Issued': return 13; // PO ออกแล้ว -> รออัปเดตส่งของ (13)
    case 'Ordered': return 15; // สั่งซื้อแล้ว -> รอรับของ (15)
    case 'Contract Pending': return 14; // รอสัญญา -> ฝ่ายสัญญา (14)
    case 'Contract Signed': return 13; // สัญญาแล้ว -> รอส่งของ (13)
    case 'Shipping': return 15; // กำลังส่ง -> รอรับของ (15)
    case 'Partially Received': return 15; // รับบางส่วน -> รอรับเพิ่ม (15)
    case 'Ready to Disburse': return 24; // รอจ่าย -> Store (24)
    
    // จบงาน / คืนของ / ไม่ผ่าน -> แจ้งแค่ผู้ขอและผู้เกี่ยวข้องทราบ (ไม่ต้องมี Action ต่อ)
    case 'Completed': return null; 
    case 'Returned': return null;
    case 'Rejected': return null;
    
    default: return null;
  }
}

// ฟังก์ชันค้นหาอีเมลจากชื่อผู้ใช้งาน (requester string)
function findUserEmail(requesterStr) {
  if (!requesterStr) return null;
  const users = getSheetData('Users');
  
  // requesterStr อาจเป็น "First Last" หรือ "ID First Last"
  // ลองหาแบบ Contains
  const user = users.find(u => {
      const fullName = `${u.firstName} ${u.lastName}`;
      const fullSig = `${u.empId} ${u.firstName} ${u.lastName}`;
      return requesterStr === fullName || requesterStr === fullSig || requesterStr.includes(u.email);
  });

  return user ? user.email : null;
}

function createNotificationBody(req, displayStatus) {
  const color = 
      req.status === 'Rejected' ? '#d32f2f' : 
      req.status === 'Completed' ? '#2e7d32' : 
      req.status.includes('Pending') ? '#f57c00' : '#1976d2';

  // ถ้าไม่ได้ส่ง displayStatus มา ให้คำนวณใหม่
  if (!displayStatus) {
      displayStatus = req.status;
      if (req.status === 'Pending Head') displayStatus = 'Pending Level 1';
      if (req.status === 'Pending PM') displayStatus = 'Pending Level 2';
  }

  return `
    <div style="font-family: 'Sarabun', sans-serif; max-width: 600px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
        <div style="background-color: ${color}; color: white; padding: 15px;">
            <h2 style="margin: 0; font-size: 18px;">รายการมีการอัปเดตสถานะ</h2>
        </div>
        <div style="padding: 20px;">
            <p>เรียน ผู้เกี่ยวข้อง,</p>
            <p>รายการคำขอหมายเลข <strong>${req.id}</strong> มีการเปลี่ยนแปลงสถานะดังนี้:</p>
            
            <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                <tr style="background-color: #f5f5f5;">
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>สถานะปัจจุบัน</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd; color: ${color}; font-weight: bold;">${displayStatus}</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>โครงการ</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${req.job}</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>ผู้ขอ</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${req.requester}</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>รายการสินค้า</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${req.items[0].name} ${req.items.length > 1 ? `(และอีก ${req.items.length - 1} รายการ)` : ''}</td>
                </tr>
            </table>

            ${req.history && req.history.length > 0 ? `
            <p style="color: #666; font-size: 12px;">
                <strong>อัปเดตล่าสุดโดย:</strong> ${req.history[req.history.length - 1].user}<br/>
                <strong>บันทึก:</strong> ${req.history[req.history.length - 1].note || '-'}
            </p>` : ''}
            
            <div style="text-align: center; margin-top: 20px;">
                <a href="${ScriptApp.getService().getUrl()}" style="background-color: #1976d2; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold;">เข้าสู่ระบบเพื่อดูรายละเอียด</a>
            </div>
        </div>
    </div>
  `;
}

// --- เพิ่มฟังก์ชันสำหรับสร้างเลข Doc No. ใน Backend (ท้ายไฟล์ code.gs) ---

function getNextDocIndex(allRequests, type, purchaseType) {
  return allRequests.filter(r => {
    if (!r.docNumber) return false;
    if (r.type !== type) return false;
    if (type === 'HO') return r.purchaseType === purchaseType;
    return true;
  }).length;
}

function generateDocId(type, index, purchaseType) {
  const now = new Date();
  const timeZone = "GMT+7";
  const year = Utilities.formatDate(now, timeZone, "yy");
  const month = Utilities.formatDate(now, timeZone, "MM");
  const runNo = (index + 1).toString().padStart(3, '0');
  
  switch(type) {
      case 'Local': return `LPO-${year}${month}-${runNo}`;
      case 'HO': 
          return purchaseType === 'Rent' 
              ? `HRO-${year}${month}-${runNo}` 
              : `HPO-${year}${month}-${runNo}`;
      case 'Withdraw': return `WID-${year}${month}-${runNo}`;
      case 'Borrow': return `BOR-${year}${month}-${runNo}`;
      default: return `DOC-${year}${month}-${runNo}`;
  }
}


// --- BUDGET SUMMARY EMAIL TRIGGER ---

/**
 * ฟังก์ชันสำหรับสร้าง Trigger ให้ส่งเมลทุกวันจันทร์ เวลา 09:00 น.
 * วิธีใช้: กดเลือกฟังก์ชันนี้แล้วกด Run หนึ่งครั้งเพื่อเริ่มระบบ
 */
function setupBudgetSummaryTrigger() {
  // ลบ Trigger เดิมกันซ้ำ
  const triggers = ScriptApp.getProjectTriggers();
  for (let i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === 'sendWeeklyBudgetSummary') {
      ScriptApp.deleteTrigger(triggers[i]);
    }
  }
  
  // สร้าง Trigger ใหม่: ทุกสัปดาห์ วันจันทร์ เวลา 09:00
  ScriptApp.newTrigger('sendWeeklyBudgetSummary')
      .timeBased()
      .onWeekDay(ScriptApp.WeekDay.MONDAY)
      .atHour(9)
      .create();
      
  console.log("✅ Budget Summary Trigger setup complete.");
}

/**
 * ฟังก์ชันหลักสำหรับส่งเมลสรุปยอด Budget
 */
function sendWeeklyBudgetSummary() {
  console.log("[BudgetSummary] Starting report generation...");
  
  // 1. โหลดข้อมูลทั้งหมด
  const projects = getSheetData('Projects');
  const requests = getSheetData('Requests');
  const assets = getSheetData('Assets');
  const users = getSheetData('Users');
  
  if (!projects || projects.length === 0) {
    console.log("[BudgetSummary] No projects found.");
    return;
  }

  // 2. คำนวณยอดเงินของแต่ละ Project / Code
  const reportData = projects.map(proj => {
    // เตรียมโครงสร้างข้อมูล
    const subJobs = (proj.subJobs || []).map(s => ({ ...s, type: 'SubJob', used: 0, pending: 0 }));
    const MatCodes = (proj.MatCodes || []).map(e => ({ ...e, type: 'MatCode', used: 0, pending: 0 }));
    
    // ฟังก์ชันคำนวณยอดเงิน (Logic เดียวกับ getBudgetInfoForEmail_FullDetail)
    const calculateItemValue = (req, item) => {
        const isRent = req.type === 'HO' && req.purchaseType === 'Rent';
        const relatedAssets = assets.filter(a => a.currentRequestId === req.id && a.name === item.name);
        const receivedLogs = item.receivedLog || [];
        
        let val = 0;
        let cnt = 0;

        // A. Assets (แม่นยำสุด)
        if (relatedAssets.length > 0) {
            val += relatedAssets.reduce((s, asset) => {
                const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                const duration = isRent ? (asset.duration || item.duration || 1) : 1;
                return s + (price * duration);
            }, 0);
            cnt = relatedAssets.length;
        } 
        // B. Logs (รองลงมา)
        else if (receivedLogs.length > 0) {
            val += receivedLogs.reduce((s, log) => {
                const duration = isRent ? (log.duration || 1) : 1;
                return s + (log.qty * log.price * duration);
            }, 0);
            cnt = item.receivedTotal || 0;
        }

        // C. Estimate (ส่วนที่เหลือ)
        const rem = Math.max(0, item.qty - cnt);
        
        // ⭐ เพิ่มเงื่อนไข: ถ้ายังไม่จบงาน ให้คิดยอดที่เหลือ
        // แต่ถ้าสถานะ req เป็น Completed แล้ว ให้ข้ามส่วนนี้ไปเลย
        if (req.status !== 'Completed') {
            const dur = isRent ? (item.duration || 1) : 1;
            const estPrice = item.unitPrice || 0;
            val += (rem * estPrice * dur);
        }
        
        return val;
    };

    // วนลูป Request ทั้งหมดเพื่อเติมตัวเลข
    requests.forEach(req => {
        // กรองเฉพาะ request ของ project นี้ และเป็นประเภทที่มี budget
        if (req.job !== proj.name) return;
        if (!['Local', 'HO'].includes(req.type)) return;
        
        const isCompleted = req.status === 'Completed';
        const isPending = !['Draft', 'Rejected', 'Returned', 'Completed'].includes(req.status);
        
        if (!isCompleted && !isPending) return;

        req.items.forEach(item => {
            const amount = calculateItemValue(req, item);
            
            // เติมยอดลง SubJob
            if (item.subJob) {
                const target = subJobs.find(s => s.code === item.subJob);
                if (target) {
                    if (isCompleted) target.used += amount;
                    else target.pending += amount;
                }
            }
            // เติมยอดลง MatCode
            if (item.MatCode) {
                const target = MatCodes.find(e => e.code === item.MatCode);
                if (target) {
                    if (isCompleted) target.used += amount;
                    else target.pending += amount;
                }
            }
        });
    });

    return {
      name: proj.name,
      subJobs: subJobs.sort((a,b) => a.code.localeCompare(b.code)),
      MatCodes: MatCodes.sort((a,b) => a.code.localeCompare(b.code))
    };
  });

  // 3. สร้าง HTML Template
  let htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { background-color: #1e3a8a; padding: 25px; color: white; text-align: center; }
        .header h1 { margin: 0; font-size: 24px; }
        .header p { margin: 5px 0 0; opacity: 0.8; font-size: 14px; }
        .content { padding: 20px; }
        .project-card { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 25px; overflow: hidden; }
        .project-header { background-color: #f8fafc; padding: 12px 15px; border-bottom: 1px solid #e5e7eb; font-weight: bold; color: #1e293b; font-size: 16px; border-left: 5px solid #2563eb; }
        .table-container { padding: 0 15px 15px 15px; }
        .budget-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        .budget-table th { background-color: #eff6ff; color: #1e40af; text-align: left; padding: 8px; font-weight: bold; border-bottom: 2px solid #bfdbfe; }
        .budget-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: #334155; }
        .budget-table tr:last-child td { border-bottom: none; }
        .bar-bg { width: 80px; height: 6px; background-color: #e2e8f0; border-radius: 3px; overflow: hidden; display: flex; }
        .bar-used { background-color: #10b981; height: 100%; }
        .bar-pending { background-color: #f59e0b; height: 100%; }
        .num { font-family: 'Courier New', monospace; font-weight: bold; }
        .text-red { color: #dc2626; font-weight: bold; }
        .text-green { color: #16a34a; }
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-right: 5px; }
        .badge-sub { background: #e0e7ff; color: #3730a3; }
        .badge-ep { background: #f3e8ff; color: #6b21a8; }
        .footer { background-color: #f1f5f9; padding: 15px; text-align: center; font-size: 12px; color: #64748b; border-top: 1px solid #e2e8f0; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>สรุปยอดงบประมาณประจำสัปดาห์</h1>
          <p>ข้อมูล ณ วันที่ ${new Date().toLocaleString('th-TH')}</p>
        </div>
        <div class="content">
  `;

  reportData.forEach(proj => {
    // ข้ามโครงการที่ไม่มีงบประมาณเลย
    if (proj.subJobs.length === 0 && proj.MatCodes.length === 0) return;

    htmlContent += `
      <div class="project-card">
        <div class="project-header">${proj.name}</div>
        <div class="table-container">
    `;

    // รวม List ทั้งสองแบบเพื่อแสดงผล
    const allItems = [
       ...proj.subJobs.map(i => ({...i, badge: 'SubJob'})),
       ...proj.MatCodes.map(i => ({...i, badge: 'MatCode'}))
    ];

    if (allItems.length > 0) {
      htmlContent += `
        <table class="budget-table">
          <thead>
            <tr>
              <th width="35%">รหัส / รายการ</th>
              <th width="20%" style="text-align:right">งบประมาณ</th>
              <th width="20%" style="text-align:right">ใช้จริง + รออนุมัติ</th>
              <th width="15%" style="text-align:right">คงเหลือ</th>
              <th width="10%" style="text-align:center">%</th>
            </tr>
          </thead>
          <tbody>
      `;

      allItems.forEach(item => {
         const budget = item.budget || 0;
         if (budget === 0) return; // ซ่อนรายการที่งบเป็น 0 เพื่อความสะอาด

         const totalUsed = item.used + item.pending;
         const remaining = budget - totalUsed;
         const pctUsed = Math.min((item.used / budget) * 100, 100);
         const pctPending = Math.min((item.pending / budget) * 100, 100 - pctUsed);
         const totalPct = ((totalUsed / budget) * 100);
         const isOver = totalUsed > budget;

         const badgeClass = item.badge === 'SubJob' ? 'badge-sub' : 'badge-ep';

         htmlContent += `
            <tr>
              <td>
                <span class="badge ${badgeClass}">${item.badge}</span> 
                <strong>${item.code}</strong><br/>
                <span style="color:#94a3b8; font-size:10px;">${item.description || ''}</span>
              </td>
              <td class="num" style="text-align:right; color:#64748b;">${budget.toLocaleString()}</td>
              <td class="num" style="text-align:right;">
                 <div>${totalUsed.toLocaleString()}</div>
                 <div style="font-size:9px; color:#64748b;">(Used: ${item.used.toLocaleString()}, Wait: ${item.pending.toLocaleString()})</div>
              </td>
              <td class="num" style="text-align:right; ${remaining < 0 ? 'color:#dc2626;' : 'color:#16a34a;'}">
                 ${remaining.toLocaleString()}
              </td>
              <td style="text-align:center;">
                 <div class="bar-bg">
                    <div class="bar-used" style="width:${pctUsed}%"></div>
                    <div class="bar-pending" style="width:${pctPending}%"></div>
                 </div>
                 <div style="font-size:10px; margin-top:2px; font-weight:bold; ${isOver ? 'color:red;' : 'color:#64748b;'}">
                    ${totalPct.toFixed(1)}%
                 </div>
              </td>
            </tr>
         `;
      });

      htmlContent += `</tbody></table>`;
    } else {
      htmlContent += `<p style="text-align:center; color:#999; padding:20px;">ไม่มีข้อมูล Code งบประมาณ</p>`;
    }

    htmlContent += `</div></div>`;
  });

  htmlContent += `
        </div>
        <div class="footer">
           ระบบ PurchaseHub System | อีเมลอัตโนมัติ กรุณาอย่าตอบกลับ
        </div>
      </div>
    </body>
    </html>
  `;

  // 4. หาอีเมลผู้รับ (Filter ตาม Role ที่กำหนด)
  // Target Permissions: 2(Admin), 3(Sub-Admin), 8(Head), 9(PM), 10(Verify)
  const targetPerms = [2, 3, 8, 9, 10];
  
  const recipientEmails = users.filter(u => {
      // 1. Super Admin ได้รับเสมอ
      if (u.isSuperAdmin) return true;
      
      // 2. เช็ค Status
      if (u.status !== 'Activated') return false;

      // 3. เช็คสิทธิ์ในทุก Project (Permission 2,3,8,9,10)
      if (u.permissions) {
          return Object.values(u.permissions).some(perms => 
              perms.some(p => targetPerms.includes(Number(p)))
          );
      }
      return false;
  }).map(u => u.email).filter(e => e && e.includes('@')); // เอาเฉพาะ Email ที่ถูกต้อง

  // ลบ Email ซ้ำ
  const uniqueRecipients = [...new Set(recipientEmails)];

  console.log(`[BudgetSummary] Recipients: ${uniqueRecipients.join(', ')}`);

  if (uniqueRecipients.length > 0) {
    try {
        // ส่ง Bcc เพื่อความเป็นส่วนตัวและไม่ให้ List ยาวเกินไป
        GmailApp.sendEmail(
            uniqueRecipients[0], // ส่งหาคนแรก
            `[PurchaseHub] รายงานสรุปงบประมาณ (Weekly Budget Report)`,
            "อุปกรณ์ของคุณไม่รองรับ HTML กรุณาดูผ่านแอปอีเมลที่ทันสมัย", 
            {
                htmlBody: htmlContent,
                bcc: uniqueRecipients.slice(1).join(',') // คนที่เหลือใส่ Bcc
            }
        );
        console.log("✅ Email sent successfully.");
    } catch (e) {
        console.error("❌ Failed to send email: " + e.toString());
    }
  } else {
      console.log("⚠️ No recipients found matching the criteria.");
  }
}
