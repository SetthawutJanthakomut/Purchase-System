// --- CONFIGURATION ---
const SPREADSHEET_ID = SpreadsheetApp.getActiveSpreadsheet().getId();

function doGet(e) {
  // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Action ‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•
  if (e.parameter && e.parameter.action) {
    
    // ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approve) -> ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (e.parameter.action === 'approve') {
      return processEmailAction(e);
    }
    
    // ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏Å‡∏î‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Reject) -> ‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
    if (e.parameter.action === 'reject') {
      return createRejectForm(e);
    }

    // ‡∏Å‡∏£‡∏ì‡∏µ 3: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (Confirm Reject) -> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (e.parameter.action === 'confirm_reject') {
      return processEmailAction(e);
    }
  }

  // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥: ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Web App
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('PurchaseHub System')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function createRejectForm(e) {
  const reqId = e.parameter.id;
  const role = e.parameter.role;
  const approver = e.parameter.approver;
  const scriptUrl = ScriptApp.getService().getUrl();

  const html = `
    <!DOCTYPE html>
    <html>
      <head>
        <base target="_top">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; display: flex; justify-content: center; padding-top: 50px; }
          .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 90%; max-width: 400px; }
          h2 { color: #d93025; margin-top: 0; }
          textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin: 15px 0; font-family: inherit; }
          button { background-color: #d93025; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; }
          button:hover { background-color: #b02015; }
        </style>
      </head>
      <body>
        <div class="card">
          <h2>‚ùå ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
          <p>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: <strong>${reqId}</strong></p>
          <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (Note):</p>
          
          <form id="rejectForm">
            <textarea id="reason" rows="4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥..." required></textarea>
            <button type="submit">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (Confirm Reject)</button>
          </form>

          <script>
            document.getElementById('rejectForm').onsubmit = function(e) {
              e.preventDefault();
              var reason = document.getElementById('reason').value;
              var btn = document.querySelector('button');
              btn.disabled = true;
              btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

              // Redirect ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Script ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
              var finalUrl = "${scriptUrl}?action=confirm_reject" + 
                             "&id=${reqId}" + 
                             "&role=${role}" + 
                             "&approver=${approver}" + 
                             "&note=" + encodeURIComponent(reason);
              
              window.top.location.href = finalUrl;
            };
          </script>
        </div>
      </body>
    </html>
  `;
  
  return HtmlService.createHtmlOutput(html);
}

function processEmailAction(e) {
  const action = e.parameter.action; 
  const reqId = e.parameter.id;
  const approver = e.parameter.approver;
  const role = e.parameter.role;
  const customNote = e.parameter.note || ''; 

  console.log(`[ProcessEmail] ===== START =====`);
  console.log(`[ProcessEmail] Action: ${action}`);
  console.log(`[ProcessEmail] Request ID: ${reqId}`);
  console.log(`[ProcessEmail] Role: ${role}`);
  console.log(`[ProcessEmail] Approver: ${approver}`);

// ‚≠ê [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡∏à‡∏≤‡∏Å Email ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
  const allUsers = getSheetData('Users');
  
  // ‡∏Å‡∏£‡∏ì‡∏µ targetEmail ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma) ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
  // ‡∏õ‡∏Å‡∏ï‡∏¥ approver ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô email ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1
  let userDisplay = approver + " (Email)"; 
  
  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô Users ‡∏ß‡πà‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£
  const foundUser = allUsers.find(u => u.email && approver.includes(u.email));
  
  if (foundUser) {
      userDisplay = `${foundUser.empId} ${foundUser.firstName} ${foundUser.lastName} (Email)`;
  }


  const requests = getSheetData('Requests');
  const reqIndex = requests.findIndex(r => r.id === reqId);

  if (reqIndex === -1) {
    console.error(`[ProcessEmail] ‚ùå Request not found: ${reqId}`);
    return HtmlService.createHtmlOutput("<h2>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h2>");
  }

  let req = requests[reqIndex];
  
  // Validation
  if (role === 'Head' && req.status !== 'Pending Head') {
     console.log(`[ProcessEmail] ‚ö†Ô∏è Status mismatch. Current: ${req.status}, Expected: Pending Head`);
     return HtmlService.createHtmlOutput("<h2>‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</h2>");
  }
  if (role === 'PM' && req.status !== 'Pending PM') {
     console.log(`[ProcessEmail] ‚ö†Ô∏è Status mismatch. Current: ${req.status}, Expected: Pending PM`);
     return HtmlService.createHtmlOutput("<h2>‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</h2>");
  }

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  let newStatus = '';
  let logNote = '';
  
  if (action === 'approve') {
    if (role === 'Head') {
      // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏° ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ PM)
      if (req.type === 'Withdraw' || req.type === 'Borrow') {
        newStatus = 'Ready to Disburse';
        console.log(`[ProcessEmail] ‚úÖ Head approved (${req.type}) -> Status: Ready to Disburse`);
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠ (Local/HO) ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ PM ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
        newStatus = 'Pending PM';
        console.log(`[ProcessEmail] ‚úÖ Head approved -> Status: Pending PM`);
      }
    }


    else if (role === 'PM') {
      newStatus = 'Approved';
      console.log(`[ProcessEmail] ‚úÖ PM approved -> Status: Approved`);
    }
    logNote = `Approved via Email by ${approver}`;
  } 
  else if (action === 'confirm_reject') { 
    newStatus = 'Rejected';
    logNote = `Rejected via Email by ${approver}: ${customNote}`; 
    console.log(`[ProcessEmail] ‚ùå Rejected with note: ${customNote}`);
  }

  // Save
  req.status = newStatus;
  
  if (!req.history) req.history = [];
  req.history.push({
    date: new Date().toLocaleString('th-TH'),
    action: newStatus,
    user: userDisplay,
    note: logNote
  });

  console.log(`[ProcessEmail] üíæ Saving to Sheet...`);
  saveDataToSheet('Requests', req.id, req);

  // ‚≠ê‚≠ê‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏ï‡πà‡∏≠‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Pending PM ‚≠ê‚≠ê‚≠ê
  if (newStatus === 'Pending PM') {
    console.log(`[ProcessEmail] üìß Triggering email to PM...`);
    try {
      const pmEmails = findApproverEmails(req.job, 9); // Permission ID 9 = PM
      
      if (pmEmails) {
        console.log(`[ProcessEmail] ‚úÖ Found PM emails: ${pmEmails}`);
        sendApprovalEmail(req, pmEmails, 'PM');
        console.log(`[ProcessEmail] ‚úÖ Email sent to PM successfully!`);
      } else {
        console.error(`[ProcessEmail] ‚ö†Ô∏è No PM approver found for project: ${req.job}`);
      }
    } catch (emailError) {
      console.error(`[ProcessEmail] ‚ùå Failed to send PM email: ${emailError.toString()}`);
    }
  }

  const color = newStatus === 'Rejected' ? 'red' : 'green';
  const message = newStatus === 'Rejected' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
  
  console.log(`[ProcessEmail] ===== END =====`);
  
let displayStatus = newStatus;
  if (newStatus === 'Pending PM') displayStatus = 'Pending Level 2';

  return HtmlService.createHtmlOutput(`
    <div style="font-family: sans-serif; text-align: center; padding: 50px;">
      <h1 style="color: ${color};">${message}</h1>
      <p>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: <strong>${reqId}</strong></p>
      
      <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${displayStatus}</p>
      
      ${customNote ? `<p>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${customNote}</p>` : ''}
      
      ${newStatus === 'Pending PM' ? '<p style="color: blue;">‚úÖ ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏ï‡πà‡∏≠ Level 2 ‡πÅ‡∏•‡πâ‡∏ß</p>' : ''}
      
      <button onclick="window.close()" style="padding: 10px 20px; margin-top:20px; cursor: pointer;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button>
    </div>
  `);
}

function findApproverEmails(projectName, permId) {
  console.log(`[FindApprover] ===== START =====`);
  console.log(`[FindApprover] Project: ${projectName}, Permission ID: ${permId}`);
  
  const users = getSheetData('Users');
  console.log(`[FindApprover] Total users in database: ${users.length}`);

  const approvers = users.filter(u => {
    // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ Status ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Activated ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    if (u.status !== 'Activated') {
      return false;
    }

    // Super Admin ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
    if (u.isSuperAdmin) {
      console.log(`[FindApprover] ‚úÖ Found SuperAdmin: ${u.username} (${u.email})`);
      return true;
    }

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
    if (u.permissions && u.permissions[projectName]) {
      const userPerms = u.permissions[projectName].map(Number); 
      const targetPerm = Number(permId);
      
      // ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin (2) ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
      const hasRight = userPerms.includes(2) || userPerms.includes(targetPerm);
      
      if (hasRight) {
        console.log(`[FindApprover] ‚úÖ Found User: ${u.username} (${u.email}) | Permissions: [${userPerms.join(', ')}]`);
      }
      return hasRight;
    }
    
    return false;
  });

  // ‚≠ê ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  const emails = approvers
    .map(u => u.email)
    .filter(email => email && email.includes('@') && email.trim() !== '');
  
  const result = emails.join(',');
  console.log(`[FindApprover] ===== RESULT =====`);
  console.log(`[FindApprover] Emails: ${result || '(NONE)'}`);
  console.log(`[FindApprover] ===== END =====`);
  
  return result;
}

// --- HELPER: ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Budget Tracking (UPDATED: Actual Price Logic) ---
function getBudgetInfoForEmail_FullDetail(req) {
  // 1. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ HO / Local ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  if (!['Local', 'HO'].includes(req.type)) return '';
  
  // 2. ‡∏´‡∏≤ SubJob / EP Code ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÉ‡∏ö‡∏ô‡∏µ‡πâ
  const uniqueSubJobs = [...new Set(req.items.map(i => i.subJob).filter(val => val))];
  const uniqueEPCodes = [...new Set(req.items.map(i => i.epCode).filter(val => val))];

  if (uniqueSubJobs.length === 0 && uniqueEPCodes.length === 0) return '';

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
  const projects = getSheetData('Projects');
  const projectData = projects.find(p => p.name === req.job);
  
  if (!projectData) return '';
  
  const allRequests = getSheetData('Requests');
  const allAssets = getSheetData('Assets'); // ‚≠ê ‡πÇ‡∏´‡∏•‡∏î Assets ‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏£‡∏¥‡∏á
  
  const budgetList = [
      ...uniqueSubJobs.map(c => ({code: c, type: 'SubJob'})),
      ...uniqueEPCodes.map(c => ({code: c, type: 'EPCode'}))
  ];

  let html = `
    <div style="margin-top: 20px; background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; font-family: 'Sarabun', sans-serif;">
      <div style="background-color: #fff8e1; padding: 12px 15px; border-bottom: 1px solid #ffe0b2;">
        <h3 style="margin: 0; font-size: 16px; color: #f57c00;">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Budget Tracking)</h3>
      </div>
      <div style="padding: 15px;">
  `;

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)
  const calculateTotal = (r, code, type) => {
      const items = r.items.filter(i => (type === 'SubJob' ? i.subJob : i.epCode) === code);
      const isRent = r.type === 'HO' && r.purchaseType === 'Rent';

      return items.reduce((sum, item) => {
          // 1. ‡∏´‡∏≤ Assets ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
          const relatedAssets = allAssets.filter(a => a.currentRequestId === r.id && a.name === item.name);
          // 2. ‡∏´‡∏≤ Logs
          const receivedLogs = item.receivedLog || [];
          
          let itemVal = 0;
          let cnt = 0;

          // Priority A: Assets
          if (relatedAssets.length > 0) {
              itemVal += relatedAssets.reduce((s, asset) => {
                    const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                    const duration = isRent ? (asset.duration || item.duration || 1) : 1;
                    return s + (price * duration);
              }, 0);
              cnt = relatedAssets.length;
          } 
          // Priority B: Logs
          else if (receivedLogs.length > 0) {
              itemVal += receivedLogs.reduce((s, log) => {
                    const duration = isRent ? (log.duration || 1) : 1;
                    return s + (log.qty * log.price * duration);
              }, 0);
              cnt = item.receivedTotal || 0;
          }

          // Priority C: Estimate Remainder
          const rem = Math.max(0, item.qty - cnt);
          const dur = isRent ? (item.duration || 1) : 1;
          const estPrice = item.unitPrice || 0;
          
          itemVal += (rem * estPrice * dur);

          return sum + itemVal;
      }, 0);
  };

  budgetList.forEach(item => {
      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô
      const list = item.type === 'SubJob' ? projectData.subJobs : projectData.epCodes;
      const target = list ? list.find(x => x.code === item.code) : null;
      const budget = target ? (target.budget || 0) : 0;

      if (budget === 0) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡∏á‡∏ö‡πÄ‡∏õ‡πá‡∏ô 0

      // --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î ---
      let used = 0;    // Completed
      let pending = 0; // Waiting
      
      allRequests.forEach(r => {
          // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏ö‡∏¥‡πâ‡∏•)
          if (r.job !== req.job) return; 
          
          if (r.id === req.id) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡πÉ‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏à‡∏∞‡πÑ‡∏õ‡∏Ñ‡∏¥‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á current)
          if (!['Local', 'HO'].includes(r.type)) return;

          const rTotal = calculateTotal(r, item.code, item.type);

          if (r.status === 'Completed') {
              used += rTotal;
          } else if (!['Draft', 'Rejected', 'Returned'].includes(r.status)) {
              pending += rTotal;
          }
      });

      // ‡∏¢‡∏≠‡∏î‡πÉ‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Current)
      const current = calculateTotal(req, item.code, item.type);

      const totalUsed = used + pending + current;
      const remaining = budget - totalUsed;
      const isOver = totalUsed > budget;

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á
      const usedPct = Math.min((used / budget) * 100, 100);
      const pendingPct = Math.min((pending / budget) * 100, 100 - usedPct);
      const currentPct = Math.min((current / budget) * 100, 100 - usedPct - pendingPct);

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÅ‡∏¢‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô
      html += `
        <div style="margin-bottom: 20px; border-bottom: 1px dashed #eee; padding-bottom: 15px;">
           <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap;">
              <div style="margin-bottom: 4px;">
                 <span style="background-color: ${item.type === 'SubJob' ? '#e8eaf6' : '#f3e5f5'}; color: ${item.type === 'SubJob' ? '#3f51b5' : '#7b1fa2'}; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 11px;">${item.type}</span>
                 <strong style="font-size: 14px; margin-left: 5px;">${item.code}</strong> 
                 <span style="color:#888; font-size: 12px;">(‡∏á‡∏ö: ${budget.toLocaleString()})</span>
              </div>
              <div style="font-size: 13px; font-weight: bold; ${isOver ? 'color: #d32f2f; background: #ffebee; padding: 2px 5px; border-radius: 4px;' : 'color: #333;'}">
                 ‡πÉ‡∏ä‡πâ‡∏£‡∏ß‡∏°: ${totalUsed.toLocaleString()} ${isOver ? '<span style="color:red; font-size:10px;">(‡πÄ‡∏Å‡∏¥‡∏ô‡∏á‡∏ö!)</span>' : ''}
              </div>
           </div>

           <div style="height: 10px; width: 100%; background-color: #f1f1f1; border-radius: 5px; overflow: hidden; display: flex; margin-bottom: 8px;">
              <div style="width: ${usedPct}%; background-color: #4caf50;" title="‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß"></div>
              <div style="width: ${pendingPct}%; background-color: #ffc107;" title="‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡∏≠‡∏∑‡πà‡∏ô"></div>
              <div style="width: ${currentPct}%; background-color: #ff9800;" title="‡πÉ‡∏ö‡∏ô‡∏µ‡πâ"></div>
           </div>
           
           <div style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 11px; color: #555;">
              <div style="display: flex; align-items: center;">
                 <div style="width: 8px; height: 8px; background-color: #4caf50; border-radius: 50%; margin-right: 4px;"></div>
                 ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß (${used.toLocaleString()})
              </div>
              <div style="display: flex; align-items: center;">
                 <div style="width: 8px; height: 8px; background-color: #ffc107; border-radius: 50%; margin-right: 4px;"></div>
                 ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (${pending.toLocaleString()})
              </div>
              <div style="display: flex; align-items: center;">
                 <div style="width: 8px; height: 8px; background-color: #ff9800; border-radius: 50%; margin-right: 4px;"></div>
                 ‡πÉ‡∏ö‡∏ô‡∏µ‡πâ (${current.toLocaleString()})
              </div>
              
              <div style="margin-left: auto; font-weight: bold; font-size: 12px; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                 ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${remaining.toLocaleString()}
              </div>
           </div>
        </div>
      `;
  });

  html += `</div></div>`;
  return html;
}

function sendApprovalEmail(req, targetEmail, targetRole) {
  console.log(`[SendEmail] ===== START =====`);
  
  if (!targetEmail || targetEmail.trim() === '') {
    console.error(`[SendEmail] ‚ùå ERROR: Target email is empty!`);
    return;
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Inventory ‡πÅ‡∏•‡∏∞ Assets ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å
  const inventory = getSheetData('Inventory');
  const assets = getSheetData('Assets');

  const scriptUrl = ScriptApp.getService().getUrl();
  const approverName = targetEmail; 

  const approveLink = `${scriptUrl}?action=approve&id=${req.id}&role=${targetRole}&approver=${approverName}`;
  const rejectLink = `${scriptUrl}?action=reject&id=${req.id}&role=${targetRole}&approver=${approverName}`;
  
  let grandTotal = 0;
  
  // ‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
  const getRentalUnitTh = (unit) => {
      if(unit === 'Day') return '‡∏ß‡∏±‡∏ô';
      if(unit === 'Month') return '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
      if(unit === 'Year') return '‡∏õ‡∏µ';
      return unit || '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'; // Default
  };

  const itemsHtml = req.items.map((item, idx) => {
    const isRent = req.type === 'HO' && req.purchaseType === 'Rent';
    const duration = isRent ? (item.duration || 1) : 1;
    const rentalUnitTh = getRentalUnitTh(item.rentalUnit);
    const total = item.qty * (item.unitPrice || 0) * duration;
    grandTotal += total;

    // --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Web App) ---
    let stockInfo = '';
    const matchingStocks = inventory.filter(inv => inv.name === item.name && inv.project === req.job);
    const totalStockQty = matchingStocks.reduce((sum, inv) => sum + inv.qty, 0);
    const availableAssets = assets.filter(a => a.name === item.name && a.project === req.job && a.status === 'Available').length;

    if (totalStockQty > 0) {
        stockInfo += `<div style="font-size:10px; color:#00796b; background-color:#e0f2f1; padding:2px 4px; border-radius:3px; display:inline-block; margin-top:2px;">‡∏°‡∏µ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á: ${totalStockQty}</div> `;
    }
    if (availableAssets > 0) {
        stockInfo += `<div style="font-size:10px; color:#283593; background-color:#e8eaf6; padding:2px 4px; border-radius:3px; display:inline-block; margin-top:2px;">‡∏ß‡πà‡∏≤‡∏á: ${availableAssets}</div>`;
    }
    // ---------------------------------------------
    
    // Mobile-friendly table row with NOTE column
    return `
      <tr style="border-bottom: 1px solid #eee;">
        <td style="padding: 12px 5px; vertical-align: top; width: 30px;">${idx + 1}</td>
        <td style="padding: 12px 5px; vertical-align: top;">
          <div style="font-weight: bold; color: #333; font-size: 14px;">${item.name}</div>
          <div style="font-size: 12px; color: #666; margin-top: 4px;">
            ${item.subJob ? `<span style="background:#e3f2fd; color:#1565c0; padding:2px 4px; border-radius:3px;">Sub: ${item.subJob}</span>` : ''} 
            ${item.epCode ? `<span style="background:#f3e5f5; color:#7b1fa2; padding:2px 4px; border-radius:3px;">EP: ${item.epCode}</span>` : ''}
          </div>
          <div style="margin-top: 5px; font-size: 12px; color: #555;">
             ${item.note ? `${item.note}<br/>` : ''}
             ${stockInfo}
          </div>
        </td>
        <td style="padding: 12px 5px; text-align: right; vertical-align: top; white-space: nowrap;">
            <div style="font-weight: bold;">${item.qty} ${item.unit}</div>
            ${isRent ? `<div style="font-size:10px; color:blue;">x ${duration} ${rentalUnitTh}</div>` : ''}
        </td>
        <td style="padding: 12px 5px; text-align: right; vertical-align: top; white-space: nowrap;">
            <div style="font-size: 12px; color:#666;">@${item.unitPrice.toLocaleString()}</div>
            <div style="font-weight: bold; color: #333; font-size: 14px;">${total.toLocaleString()}</div>
        </td>
      </tr>
    `;
  }).join('');

  // ‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Budget HTML (Full Detail)
  const budgetHtml = getBudgetInfoForEmail_FullDetail(req);

  const htmlBody = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
        body { margin: 0; padding: 0; background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background-color: #ffffff; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        .header { background-color: #1976d2; padding: 25px 20px; color: #ffffff; }
        .content { padding: 20px; }
        .btn { 
            display: inline-block; 
            padding: 12px 24px; 
            text-decoration: none; 
            border-radius: 6px; 
            font-weight: bold; 
            font-size: 16px; 
            text-align: center;
            margin: 5px;
        }
        .btn-approve { background-color: #2e7d32; color: white !important; }
        .btn-reject { background-color: #d32f2f; color: white !important; }
        .btn-link { background-color: #fff; color: #1976d2 !important; border: 1px solid #1976d2; font-size: 14px; padding: 10px 20px;}
        
        @media only screen and (max-width: 600px) {
          .btn { display: block; width: 90%; margin: 10px auto; }
          .meta-table td { display: block; width: 100%; padding-bottom: 5px; }
          .header h2 { font-size: 20px; }
        }
      </style>
    </head>
    <body>
      <div style="padding: 10px;">
        <div class="container">
          
          <div class="header">
            <h2 style="margin: 0;">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${req.id}</h2>
            <p style="margin: 5px 0 0; opacity: 0.9;">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: <strong>${req.job}</strong></p>
            <p style="margin: 2px 0 0; opacity: 0.9; font-size: 14px;">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: ${req.requester}</p>
          </div>
          
          <div class="content">
            <table class="meta-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px; color: #444;">
              <tr>
                <td style="padding: 5px; color: #888;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</td>
                <td style="padding: 5px; font-weight: bold; color: #333;">${req.type} ${req.purchaseType || ''}</td>
              </tr>
              <tr>
                <td style="padding: 5px; color: #888;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</td>
                <td style="padding: 5px; font-weight: bold; color: #333;">${req.dateRequired}</td>
              </tr>
              <tr>
                <td style="padding: 5px; color: #888;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</td>
                <td style="padding: 5px; font-weight: bold; color: ${req.priority === 'Critical' ? 'red' : 'blue'};">${req.priority}</td>
              </tr>
            </table>

            <h3 style="border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 0; font-size: 16px; color: #333;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
              <thead style="background-color: #f9fafb; color: #666; font-size: 12px;">
                <tr>
                  <th style="padding: 8px 5px; text-align: left;">#</th>
                  <th style="padding: 8px 5px; text-align: left;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                  <th style="padding: 8px 5px; text-align: right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th style="padding: 8px 5px; text-align: right;">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</th>
                </tr>
              </thead>
              <tbody>
                ${itemsHtml}
              </tbody>
              <tfoot style="background-color: #f1f8e9;">
                <tr>
                  <td colspan="3" style="padding: 10px; text-align: right; font-weight: bold; color: #333;">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</td>
                  <td style="padding: 10px 5px; text-align: right; font-weight: bold; color: #1976d2; font-size: 16px;">${grandTotal.toLocaleString()}</td>
                </tr>
              </tfoot>
            </table>
            
            ${req.note ? `
              <div style="margin-top: 20px; padding: 12px; background-color: #fff8e1; border-radius: 6px; border-left: 4px solid #ffc107; font-size: 14px;">
                <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</strong> ${req.note}
              </div>` : ''}

            ${budgetHtml}

            <div style="margin-top: 30px; text-align: center; border-top: 1px solid #eee; padding-top: 20px;">
              <p style="margin-bottom: 15px; font-weight: bold; color: #555;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</p>
              
              <a href="${approveLink}" class="btn btn-approve">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approve)</a>
              <a href="${rejectLink}" class="btn btn-reject">‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Reject)</a>
              
              <div style="margin-top: 20px;">
                 <a href="${scriptUrl}" target="_blank" class="btn btn-link">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ (Open App)</a>
              </div>

              <p style="font-size: 12px; color: #999; margin-top: 15px;">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
            </div>

          </div>
        </div>
      </div>
    </body>
    </html>
  `;

  try {
    GmailApp.sendEmail(targetEmail, `[PurchaseHub] ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${req.id} - ${req.job}`, '', {
      htmlBody: htmlBody
    });
    console.log(`[SendEmail] ‚úÖ Email sent successfully to ${targetEmail}`);
  } catch (error) {
    console.error(`[SendEmail] ‚ùå Failed to send email: ${error.toString()}`);
  }

  console.log(`[SendEmail] ===== END =====`);
}

function syncRequest(request) {
  console.log(`[SyncRequest] ===== START =====`);
  console.log(`[SyncRequest] Request ID: ${request.id}`);
  console.log(`[SyncRequest] Status: ${request.status}`);
  console.log(`[SyncRequest] Job: ${request.job}`);
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  const result = saveDataToSheet('Requests', request.id, request);
  
  try {
      if (request.status === 'Pending Head') {
          console.log("[SyncRequest] ‚úÖ Status = Pending Head -> Finding Head approvers...");
          const headEmails = findApproverEmails(request.job, 8); 
          
          if (headEmails) {
             console.log(`[SyncRequest] üìß Sending email to: ${headEmails}`);
             sendApprovalEmail(request, headEmails, 'Head');
             console.log("[SyncRequest] ‚úÖ Email sent successfully!");
          } else {
             console.log(`[SyncRequest] ‚ö†Ô∏è WARNING: No Head approver found for project: ${request.job}`);
          }
      }
      
      else if (request.status === 'Pending PM') {
          console.log("[SyncRequest] ‚úÖ Status = Pending PM -> Finding PM approvers...");
          const pmEmails = findApproverEmails(request.job, 9);
          
          if (pmEmails) {
             console.log(`[SyncRequest] üìß Sending email to: ${pmEmails}`);
             sendApprovalEmail(request, pmEmails, 'PM');
             console.log("[SyncRequest] ‚úÖ Email sent successfully!");
          } else {
             console.log(`[SyncRequest] ‚ö†Ô∏è WARNING: No PM approver found for project: ${request.job}`);
          }
      } 
      else {
          console.log(`[SyncRequest] ‚ÑπÔ∏è Status '${request.status}' - No email action required.`);
      }

  } catch (e) {
      console.error("‚ùå [SyncRequest] Email sending FAILED: " + e.toString());
  }

  console.log(`[SyncRequest] ===== END =====`);
  return result;
}

// --- HELPER FUNCTIONS ---

function getOrCreateSheet(sheetName) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    if (['Projects', 'Inventory', 'Assets', 'Requests', 'Users'].includes(sheetName)) {
      sheet.appendRow(['ID', 'JSON_Data']); 
    }
  }
  return sheet;
}

function getSheetData(sheetName) {
  const sheet = getOrCreateSheet(sheetName);
  
  // ‚≠ê ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô Sheet ‡∏ß‡πà‡∏≤‡∏á
  if (sheet.getLastRow() === 0) {
    console.log(`[GetSheetData] Sheet '${sheetName}' is empty. Creating header...`);
    sheet.appendRow(['ID', 'JSON_Data']); // ‡∏™‡∏£‡πâ‡∏≤‡∏á Header
    return [];
  }
  
  const data = sheet.getDataRange().getValues();
  
  // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÅ‡∏Ñ‡πà Header ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (data.length <= 1) {
    console.log(`[GetSheetData] Sheet '${sheetName}' has only header row.`);
    return [];
  }
  
  const result = [];
  
  for (let i = 0; i < data.length; i++) {
    // ‚≠ê ‡∏Ç‡πâ‡∏≤‡∏° Row 0 (Header)
    if (i === 0 && data[i][0] === 'ID') {
      continue;
    }
    
    // ‚≠ê ‡∏Ç‡πâ‡∏≤‡∏° Row ‡∏ß‡πà‡∏≤‡∏á
    if (!data[i][1] || data[i][1].toString().trim() === '') {
      continue;
    }
    
    try {
      const parsed = JSON.parse(data[i][1]);
      result.push(parsed);
    } catch (e) {
      console.error(`[GetSheetData] ‚ùå Error parsing row ${i} in ${sheetName}: ${e.toString()}`);
      console.error(`[GetSheetData] Raw data: ${data[i][1]}`);
    }
  }
  
  console.log(`[GetSheetData] Loaded ${result.length} records from ${sheetName}`);
  return result;
}

function saveDataToSheet(sheetName, id, dataObj) {
  const sheet = getOrCreateSheet(sheetName);
  const allData = sheet.getDataRange().getValues();
  let rowIndex = -1;
  for (let i = 0; i < allData.length; i++) {
    if (allData[i][0] == id) {
      rowIndex = i + 1; 
      break;
    }
  }
  const jsonString = JSON.stringify(dataObj);
  if (rowIndex > 0) {
    sheet.getRange(rowIndex, 2).setValue(jsonString);
  } else {
    sheet.appendRow([id, jsonString]);
  }
  return true;
}

function deleteDataFromSheet(sheetName, id) {
  const sheet = getOrCreateSheet(sheetName);
  const data = sheet.getDataRange().getValues();
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] == id) {
      sheet.deleteRow(i + 1);
      break;
    }
  }
}

// --- FILE UPLOAD FUNCTIONS ---

function uploadFileToDrive(base64Data, fileName) {
  try {
    const FOLDER_ID = "1M57m68rI8bM-BBqRlh_LzZHuDWPZVdwz"; 
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return {
      name: fileName,
      url: file.getUrl(),
      id: file.getId()
    };
  } catch (e) {
    return { error: e.toString() };
  }
}

function getOrCreateSubFolder(parentFolderId, subFolderName) {
  const parentFolder = DriveApp.getFolderById(parentFolderId);
  const folders = parentFolder.getFoldersByName(subFolderName);
  if (folders.hasNext()) {
    return folders.next();
  } else {
    return parentFolder.createFolder(subFolderName);
  }
}

function uploadAssetImage(base64Data, fileName) {
  try {
    const MAIN_FOLDER_ID = "1M57m68rI8bM-BBqRlh_LzZHuDWPZVdwz"; 
    const SUB_FOLDER_NAME = "Asset_Images"; 
    const targetFolder = getOrCreateSubFolder(MAIN_FOLDER_ID, SUB_FOLDER_NAME);
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    const file = targetFolder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return {
      name: fileName,
      url: file.getUrl(),
      id: file.getId()
    };
  } catch (e) {
    return { error: e.toString() };
  }
}

// --- SPECIFIC SYNC FUNCTIONS ---

function syncProject(project) {
  return saveDataToSheet('Projects', project.id, project);
}

function deleteProjectFromSheet(id) {
  deleteDataFromSheet('Projects', id);
}


function syncInventory(item) {
  return saveDataToSheet('Inventory', item.id, item);
}

function syncAsset(asset) {
  return saveDataToSheet('Assets', asset.id, asset);
}

function syncLog(log) {
  const id = log.date + '_' + Math.floor(Math.random() * 1000); 
  return saveDataToSheet('Logs', id, log);
}

// --- USER MANAGEMENT & MAIN API ---

function loginUser(username, password) {
  if (username === 'admin' && password === '1231') {
    return {
      success: true,
      user: {
        username: 'admin',
        firstName: 'System',
        lastName: 'Administrator',
        empId: 'ADMIN-001',
        role: 'Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)',
        isSuperAdmin: true,
        status: 'Activated'
      }
    };
  }

  const users = getSheetData('Users');
  const user = users.find(u => u.username === username && u.password === password);
  
  if (user) {
    if (user.status !== 'Activated') {
       return { success: false, message: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
    }
    return { 
      success: true, 
      user: {
        ...user,
        password: '' 
      }
    };
  } else {
    return { success: false, message: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' };
  }
}

function registerUser(formData) {
  const users = getSheetData('Users');
  if (users.some(u => u.username === formData.username)) {
    return { success: false, message: 'Username ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' };
  }
  
  const newUser = {
    id: formData.username, 
    ...formData,
    role: 'User', 
    status: 'New', 
    permissions: {}, 
    createdAt: new Date().toLocaleString('th-TH')
  };
  
  saveDataToSheet('Users', newUser.id, newUser);
  return { success: true, message: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
}

// [‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveUserData ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ]

function saveUserData(user) {
  const users = getSheetData('Users');
  
  // ‚≠ê ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Emp ID) ‡∏ã‡πâ‡∏≥
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ EmpID ‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏° (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
  const duplicate = users.find(u => u.empId === user.empId && u.id !== user.id);
  if (duplicate) {
    return { 
      success: false, 
      message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${user.empId} ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ${duplicate.firstName} ${duplicate.lastName}` 
    };
  }

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
  saveDataToSheet('Users', user.id, user);
  return { success: true, message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' };
}

function loadInitialData() {
  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å Settings
  const settings = getSheetData('Settings');
  const announcement = settings.find(s => s.id === 'ANNOUNCEMENT') || null;

  return {
    requests: getSheetData('Requests'),
    inventory: getSheetData('Inventory'),
    assets: getSheetData('Assets'),
    logs: getSheetData('Logs'),
    projects: getSheetData('Projects'),
    users: getSheetData('Users'),
    announcement: announcement // ‚≠ê ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
  };
}
// 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á OTP ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö empId ‡∏°‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢
function sendRegistrationOTP(email, username, empId) { // ‚≠ê ‡∏£‡∏±‡∏ö‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå empId ‡πÄ‡∏û‡∏¥‡πà‡∏°
  const users = getSheetData('Users');

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Username ‡∏ã‡πâ‡∏≥
  if (users.some(u => u.username === username)) {
    return { success: false, message: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username) ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà' };
  }

  // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö EmpID ‡∏ã‡πâ‡∏≥ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ)
  if (users.some(u => u.empId === empId)) {
    return { success: false, message: '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß' };
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Email ‡∏ã‡πâ‡∏≥
  if (users.some(u => u.email === email)) {
    return { success: false, message: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' };
  }

  // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á OTP ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
  const otp = Math.floor(1000 + Math.random() * 9000).toString();
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let refCode = '';
  for (let i = 0; i < 4; i++) {
    refCode += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  
  CacheService.getScriptCache().put('OTP_' + email, otp, 300);

  try {
    GmailApp.sendEmail(email, `[PurchaseHub] ‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (Ref: ${refCode})`, 
      `‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (Ref Code): ${refCode}\n\n‡∏£‡∏´‡∏±‡∏™ OTP ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: ${otp}\n\n(‡∏£‡∏´‡∏±‡∏™‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏ 5 ‡∏ô‡∏≤‡∏ó‡∏µ)`);
    return { success: true, message: '‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP ‡πÅ‡∏•‡πâ‡∏ß', refCode: refCode };
  } catch (e) {
    return { success: false, message: '‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.toString() };
  }
}

// 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
function registerUser(formData, otp) {
  const cachedOtp = CacheService.getScriptCache().get('OTP_' + formData.email);
  if (!cachedOtp || cachedOtp !== otp) {
    return { success: false, message: '‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà)' };
  }
  
  CacheService.getScriptCache().remove('OTP_' + formData.email);

  const users = getSheetData('Users');
  
  // ‡πÄ‡∏ä‡πá‡∏Ñ Username ‡∏ã‡πâ‡∏≥
  if (users.some(u => u.username === formData.username)) {
    return { success: false, message: 'Username ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' };
  }

  // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ EmpID ‡∏ã‡πâ‡∏≥ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ)
  if (users.some(u => u.empId === formData.empId)) {
    return { success: false, message: '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' };
  }
  
  const newUser = {
    id: formData.username, 
    ...formData,
    role: 'User', 
    status: 'New', 
    permissions: {}, 
    createdAt: new Date().toLocaleString('th-TH')
  };
  saveDataToSheet('Users', newUser.id, newUser);
  return { success: true, message: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
}
// --- [Server Side] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ---

// 1. ‡∏™‡πà‡∏á OTP ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
function sendForgotPasswordOTP(email) {
  const users = getSheetData('Users');
  const user = users.find(u => u.email === email);
  
  if (!user) {
    return { success: false, message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' };
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á OTP ‡πÅ‡∏•‡∏∞ Ref Code
  const otp = Math.floor(1000 + Math.random() * 9000).toString();
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let refCode = '';
  for (let i = 0; i < 4; i++) { refCode += chars.charAt(Math.floor(Math.random() * chars.length)); }
  
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á Cache (‡πÉ‡∏ä‡πâ key ‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≠‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
  CacheService.getScriptCache().put('RESET_OTP_' + email, otp, 300); // 5 ‡∏ô‡∏≤‡∏ó‡∏µ

  try {
    GmailApp.sendEmail(email, `[PurchaseHub] ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Ref: ${refCode})`, 
      `‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (Ref Code): ${refCode}\n\n‡∏£‡∏´‡∏±‡∏™ OTP ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏∑‡∏≠: ${otp}\n\n(‡∏£‡∏´‡∏±‡∏™‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏ 5 ‡∏ô‡∏≤‡∏ó‡∏µ)`);
    return { success: true, message: '‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß', refCode: refCode };
  } catch (e) {
    return { success: false, message: '‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.toString() };
  }
}

// 2. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
function resetPassword(email, otp, newPassword) {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OTP
  const cachedOtp = CacheService.getScriptCache().get('RESET_OTP_' + email);
  if (!cachedOtp || cachedOtp !== otp) {
    return { success: false, message: '‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' };
  }

  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User
  const users = getSheetData('Users');
  const user = users.find(u => u.email === email);
  
  if (user) {
    user.password = newPassword; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
    saveDataToSheet('Users', user.id, user); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheet
    
    CacheService.getScriptCache().remove('RESET_OTP_' + email); // ‡∏•‡∏ö OTP ‡∏ó‡∏¥‡πâ‡∏á
    return { success: true, message: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà' };
  }
  
  return { success: false, message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' };
}

// --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ---
function sendUsernameToEmail(email) {
  const users = getSheetData('Users');
  const user = users.find(u => u.email === email);
  
  if (!user) {
    return { success: false, message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' };
  }

  try {
    GmailApp.sendEmail(email, '[PurchaseHub] ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username Recovery)', 
      `‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì ${user.firstName},\n\n‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username) ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: ${user.username}\n\n‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö`);
    return { success: true, message: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username) ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß' };
  } catch (e) {
    return { success: false, message: '‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.toString() };
  }
}

// --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå Code.gs] ---

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Logs) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏´‡∏±‡∏™
function updateHistoryLogSignature(oldSignature, newSignature) {
  console.log(`[UpdateLog] Changing from "${oldSignature}" to "${newSignature}"`);
  
  const sheet = getOrCreateSheet('Logs');
  const data = sheet.getDataRange().getValues();
  let updateCount = 0;
  
  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2 (index 1) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏° Header
  for (let i = 1; i < data.length; i++) {
    // data[i][1] ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå JSON_Data
    if (!data[i][1]) continue;
    
    try {
      let log = JSON.parse(data[i][1]);
      
      // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (by) ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤
      if (log.by === oldSignature) {
        log.by = newSignature; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô Sheet (‡πÅ‡∏ñ‡∏ß i+1 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ index ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 0 ‡πÅ‡∏ï‡πà Sheet ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 1)
        sheet.getRange(i + 1, 2).setValue(JSON.stringify(log));
        updateCount++;
      }
    } catch (e) {
      console.error(`[UpdateLog] Error parsing row ${i + 1}: ${e.toString()}`);
    }
  }
  
  console.log(`[UpdateLog] Updated ${updateCount} records.`);
  return { success: true, count: updateCount };
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å Sheet (Requests, Assets, Logs)
// --- [Code.gs] ---

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö (Global Update) - ‡∏â‡∏ö‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á
function updateUserGlobalData(oldData, newData) {
  console.log(`[GlobalUpdate] Starting... from ${oldData.empId} to ${newData.empId}`);
  
  // 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà (New Data)
  const newFullSig = `${newData.empId} ${newData.firstName} ${newData.lastName}`;
  const newShortName = `${newData.firstName} ${newData.lastName}`;

  // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Possible Old Patterns)
  // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô
  const oldPatterns = [
    // ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°: "2EN-3000 Level No1"
    `${oldData.empId} ${oldData.firstName} ${oldData.lastName}`,
    // ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ Email ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
    `${oldData.empId} ${oldData.firstName} ${oldData.lastName} (Email)`,
    // ‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô: "Level No1"
    `${oldData.firstName} ${oldData.lastName}`,
    // ‚≠ê ‡πÅ‡∏ö‡∏ö‡∏Å‡∏∂‡πà‡∏á‡πÄ‡∏ï‡πá‡∏° (ID + ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤): "2EN-3000 Level" (‡∏Å‡∏£‡∏ì‡∏µ Approver ‡∏ö‡∏≤‡∏á‡∏ó‡∏µ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö)
    `${oldData.empId} ${oldData.firstName}`,
    // ‚≠ê ‡πÅ‡∏ö‡∏ö ID ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ö‡∏ö StartWith): "2EN-3000"
    oldData.empId 
  ];

  // Helper: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Pattern ‡πÄ‡∏Å‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const isMatch = (value) => {
    if (!value || typeof value !== 'string') return false;
    const val = value.trim();
    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å Pattern
    return oldPatterns.some(pattern => {
      // ‡∏ñ‡πâ‡∏≤ Pattern ‡πÄ‡∏õ‡πá‡∏ô ID ‡∏•‡πâ‡∏ß‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ "‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢" (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)
      if (pattern === oldData.empId) {
        return val.startsWith(pattern); 
      }
      // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡∏ï‡∏±‡∏ß
      return val === pattern || val.replace(/\s+/g, ' ') === pattern; 
    });
  };

  let countReq = 0;
  let countLog = 0;
  let countAsset = 0;

  // --- 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Sheet "Requests" ---
  const reqSheet = getOrCreateSheet('Requests');
  const reqData = reqSheet.getDataRange().getValues();
  
  for (let i = 1; i < reqData.length; i++) {
    if (!reqData[i][1]) continue;
    try {
      let req = JSON.parse(reqData[i][1]);
      let changed = false;

      // 1.1 ‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ (Requester)
      if (isMatch(req.requester)) {
        req.requester = newShortName; // ‡∏õ‡∏Å‡∏ï‡∏¥ requester ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡πâ‡∏ô
        changed = true;
      }

      // 1.2 ‡πÅ‡∏Å‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approver L1, L2) -> ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
      if (isMatch(req.approverL1)) { 
        req.approverL1 = newFullSig; 
        changed = true; 
      }
      if (isMatch(req.approverL2)) { 
        req.approverL2 = newFullSig; 
        changed = true; 
      }

      // 1.3 ‡πÅ‡∏Å‡πâ‡πÉ‡∏ô History Array
      if (req.history && Array.isArray(req.history)) {
        req.history.forEach(h => {
          if (isMatch(h.user)) {
            h.user = newFullSig;
            changed = true;
          }
        });
      }

      if (changed) {
        reqSheet.getRange(i + 1, 2).setValue(JSON.stringify(req));
        countReq++;
      }
    } catch (e) {
      console.error(`Error parsing Request row ${i+1}: ${e.toString()}`);
    }
  }

  // --- 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Sheet "Logs" (‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏ß‡∏°) ---
  const logSheet = getOrCreateSheet('Logs');
  const logData = logSheet.getDataRange().getValues();
  for (let i = 1; i < logData.length; i++) {
    if (!logData[i][1]) continue;
    try {
      let log = JSON.parse(logData[i][1]);
      
      if (isMatch(log.by)) {
        log.by = newFullSig;
        logSheet.getRange(i + 1, 2).setValue(JSON.stringify(log));
        countLog++;
      }
    } catch (e) {}
  }

  // --- 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Sheet "Assets" (‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á) ---
  const assetSheet = getOrCreateSheet('Assets');
  const assetData = assetSheet.getDataRange().getValues();
  for (let i = 1; i < assetData.length; i++) {
    if (!assetData[i][1]) continue;
    try {
      let asset = JSON.parse(assetData[i][1]);
      
      if (isMatch(asset.holder)) {
        asset.holder = newShortName;
        assetSheet.getRange(i + 1, 2).setValue(JSON.stringify(asset));
        countAsset++;
      }
    } catch (e) {}
  }

  return { 
    success: true, 
    message: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£(${countReq}), ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥(${countLog}), ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô(${countAsset})` 
  };
}

// [‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ô Code.gs]

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á Admin)
function getAllAnnouncements() {
  const settings = getSheetData('Settings');
  // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Row ‡∏ó‡∏µ‡πà ID ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ANN-
  return settings.filter(s => s.id && s.id.toString().startsWith('ANN-'));
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà Active" (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login / Public)
function getPublicAnnouncements() {
  const settings = getSheetData('Settings');
  // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Active = true
  return settings.filter(s => s.id && s.id.toString().startsWith('ANN-') && s.active === true);
}

// 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
function saveAnnouncementItem(data) {
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ID ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
  const id = data.id || `ANN-${new Date().getTime()}`;
  
  const payload = {
    ...data,
    id: id,
    updatedBy: data.updatedBy,
    timestamp: new Date().toLocaleString('th-TH')
  };
  
  saveDataToSheet('Settings', id, payload);
  return { success: true, message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', data: payload };
}

// 4. ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
function deleteAnnouncementItem(id) {
  deleteDataFromSheet('Settings', id);
  return { success: true, message: '‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß' };
}

// 5. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®)
function toggleAnnouncementStatus(id, isActive) {
  const settings = getSheetData('Settings');
  const target = settings.find(s => s.id === id);
  if (target) {
    target.active = isActive;
    saveDataToSheet('Settings', id, target);
    return { success: true, message: isActive ? '‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß' : '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß' };
  }
  return { success: false, message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' };
}

// --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå code.gs ---

function uploadUserSignature(base64Data, fileName) {
  try {
    const MAIN_FOLDER_ID = "1M57m68rI8bM-BBqRlh_LzZHuDWPZVdwz"; // ‡πÉ‡∏ä‡πâ ID ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏î‡∏¥‡∏°
    const SUB_FOLDER_NAME = "User_Signatures"; // ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
    const targetFolder = getOrCreateSubFolder(MAIN_FOLDER_ID, SUB_FOLDER_NAME);
    
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    
    const file = targetFolder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    return {
      name: fileName,
      url: file.getUrl(),
      id: file.getId()
    };
  } catch (e) {
    return { error: e.toString() };
  }
}
