// --- CONFIGURATION ---
const SPREADSHEET_ID = SpreadsheetApp.getActiveSpreadsheet().getId();

function doGet(e) {
  // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Action ‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•
  if (e.parameter && e.parameter.action) {
    
    // ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approve) -> ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (e.parameter.action === 'approve') {
      return processEmailAction(e);
    }
    
    // ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏Å‡∏î‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Reject) -> ‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
    if (e.parameter.action === 'reject') {
      return createRejectForm(e);
    }

    // ‡∏Å‡∏£‡∏ì‡∏µ 3: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (Confirm Reject) -> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (e.parameter.action === 'confirm_reject') {
      return processEmailAction(e);
    }
  }

  // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥: ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Web App
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('PurchaseHub System')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function createRejectForm(e) {
  const reqId = e.parameter.id;
  const role = e.parameter.role;
  const approver = e.parameter.approver;
  const scriptUrl = ScriptApp.getService().getUrl();

  const html = `
    <!DOCTYPE html>
    <html>
      <head>
        <base target="_top">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; display: flex; justify-content: center; padding-top: 50px; }
          .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 90%; max-width: 400px; }
          h2 { color: #d93025; margin-top: 0; }
          textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin: 15px 0; font-family: inherit; }
          button { background-color: #d93025; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; }
          button:hover { background-color: #b02015; }
        </style>
      </head>
      <body>
        <div class="card">
          <h2>‚ùå ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
          <p>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: <strong>${reqId}</strong></p>
          <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (Note):</p>
          
          <form id="rejectForm">
            <textarea id="reason" rows="4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥..." required></textarea>
            <button type="submit">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (Confirm Reject)</button>
          </form>

          <script>
            document.getElementById('rejectForm').onsubmit = function(e) {
              e.preventDefault();
              var reason = document.getElementById('reason').value;
              var btn = document.querySelector('button');
              btn.disabled = true;
              btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

              // Redirect ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Script ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
              var finalUrl = "${scriptUrl}?action=confirm_reject" + 
                             "&id=${reqId}" + 
                             "&role=${role}" + 
                             "&approver=${approver}" + 
                             "&note=" + encodeURIComponent(reason);
              
              window.top.location.href = finalUrl;
            };
          </script>
        </div>
      </body>
    </html>
  `;
  
  return HtmlService.createHtmlOutput(html);
}

function processEmailAction(e) {
  const action = e.parameter.action; 
  const reqId = e.parameter.id;
  const approver = e.parameter.approver;
  const role = e.parameter.role;
  const customNote = e.parameter.note || ''; 

  console.log(`[ProcessEmail] ===== START =====`);
  console.log(`[ProcessEmail] Action: ${action}`);
  console.log(`[ProcessEmail] Request ID: ${reqId}`);
  console.log(`[ProcessEmail] Role: ${role}`);
  console.log(`[ProcessEmail] Approver: ${approver}`);

  const requests = getSheetData('Requests');
  const reqIndex = requests.findIndex(r => r.id === reqId);

  if (reqIndex === -1) {
    console.error(`[ProcessEmail] ‚ùå Request not found: ${reqId}`);
    return HtmlService.createHtmlOutput("<h2>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h2>");
  }

  let req = requests[reqIndex];
  
  // Validation
  if (role === 'Head' && req.status !== 'Pending Head') {
     console.log(`[ProcessEmail] ‚ö†Ô∏è Status mismatch. Current: ${req.status}, Expected: Pending Head`);
     return HtmlService.createHtmlOutput("<h2>‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</h2>");
  }
  if (role === 'PM' && req.status !== 'Pending PM') {
     console.log(`[ProcessEmail] ‚ö†Ô∏è Status mismatch. Current: ${req.status}, Expected: Pending PM`);
     return HtmlService.createHtmlOutput("<h2>‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</h2>");
  }

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  let newStatus = '';
  let logNote = '';
  
  if (action === 'approve') {
    if (role === 'Head') {
      newStatus = 'Pending PM';
      console.log(`[ProcessEmail] ‚úÖ Head approved -> Status: Pending PM`);
    }
    else if (role === 'PM') {
      newStatus = 'Approved';
      console.log(`[ProcessEmail] ‚úÖ PM approved -> Status: Approved`);
    }
    logNote = `Approved via Email by ${approver}`;
  } 
  else if (action === 'confirm_reject') { 
    newStatus = 'Rejected';
    logNote = `Rejected via Email by ${approver}: ${customNote}`; 
    console.log(`[ProcessEmail] ‚ùå Rejected with note: ${customNote}`);
  }

  // Save
  req.status = newStatus;
  
  if (!req.history) req.history = [];
  req.history.push({
    date: new Date().toLocaleString('th-TH'),
    action: newStatus,
    user: approver + " (Email)",
    note: logNote
  });

  console.log(`[ProcessEmail] üíæ Saving to Sheet...`);
  saveDataToSheet('Requests', req.id, req);

  // ‚≠ê‚≠ê‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏ï‡πà‡∏≠‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Pending PM ‚≠ê‚≠ê‚≠ê
  if (newStatus === 'Pending PM') {
    console.log(`[ProcessEmail] üìß Triggering email to PM...`);
    try {
      const pmEmails = findApproverEmails(req.job, 9); // Permission ID 9 = PM
      
      if (pmEmails) {
        console.log(`[ProcessEmail] ‚úÖ Found PM emails: ${pmEmails}`);
        sendApprovalEmail(req, pmEmails, 'PM');
        console.log(`[ProcessEmail] ‚úÖ Email sent to PM successfully!`);
      } else {
        console.error(`[ProcessEmail] ‚ö†Ô∏è No PM approver found for project: ${req.job}`);
      }
    } catch (emailError) {
      console.error(`[ProcessEmail] ‚ùå Failed to send PM email: ${emailError.toString()}`);
    }
  }

  const color = newStatus === 'Rejected' ? 'red' : 'green';
  const message = newStatus === 'Rejected' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
  
  console.log(`[ProcessEmail] ===== END =====`);
  
  return HtmlService.createHtmlOutput(`
    <div style="font-family: sans-serif; text-align: center; padding: 50px;">
      <h1 style="color: ${color};">${message}</h1>
      <p>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: <strong>${reqId}</strong></p>
      <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${newStatus}</p>
      ${customNote ? `<p>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${customNote}</p>` : ''}
      ${newStatus === 'Pending PM' ? '<p style="color: blue;">‚úÖ ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏ï‡πà‡∏≠ PM ‡πÅ‡∏•‡πâ‡∏ß</p>' : ''}
      <button onclick="window.close()" style="padding: 10px 20px; margin-top:20px; cursor: pointer;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button>
    </div>
  `);
}

function findApproverEmails(projectName, permId) {
  console.log(`[FindApprover] ===== START =====`);
  console.log(`[FindApprover] Project: ${projectName}, Permission ID: ${permId}`);
  
  const users = getSheetData('Users');
  console.log(`[FindApprover] Total users in database: ${users.length}`);

  const approvers = users.filter(u => {
    // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ Status ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Activated ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    if (u.status !== 'Activated') {
      return false;
    }

    // Super Admin ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
    if (u.isSuperAdmin) {
      console.log(`[FindApprover] ‚úÖ Found SuperAdmin: ${u.username} (${u.email})`);
      return true;
    }

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
    if (u.permissions && u.permissions[projectName]) {
      const userPerms = u.permissions[projectName].map(Number); 
      const targetPerm = Number(permId);
      
      // ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin (2) ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
      const hasRight = userPerms.includes(2) || userPerms.includes(targetPerm);
      
      if (hasRight) {
        console.log(`[FindApprover] ‚úÖ Found User: ${u.username} (${u.email}) | Permissions: [${userPerms.join(', ')}]`);
      }
      return hasRight;
    }
    
    return false;
  });

  // ‚≠ê ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  const emails = approvers
    .map(u => u.email)
    .filter(email => email && email.includes('@') && email.trim() !== '');
  
  const result = emails.join(',');
  console.log(`[FindApprover] ===== RESULT =====`);
  console.log(`[FindApprover] Emails: ${result || '(NONE)'}`);
  console.log(`[FindApprover] ===== END =====`);
  
  return result;
}

function sendApprovalEmail(req, targetEmail, targetRole) {
  console.log(`[SendEmail] ===== START =====`);
  console.log(`[SendEmail] To: ${targetEmail}`);
  console.log(`[SendEmail] Role: ${targetRole}`);
  console.log(`[SendEmail] Request ID: ${req.id}`);

  // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Email ‡∏à‡∏£‡∏¥‡∏á
  if (!targetEmail || targetEmail.trim() === '') {
    console.error(`[SendEmail] ‚ùå ERROR: Target email is empty!`);
    return;
  }


  const scriptUrl = ScriptApp.getService().getUrl();
  const approverName = targetRole; 

  const approveLink = `${scriptUrl}?action=approve&id=${req.id}&role=${targetRole}&approver=${approverName}`;
  const rejectLink = `${scriptUrl}?action=reject&id=${req.id}&role=${targetRole}&approver=${approverName}`;

  let grandTotal = 0;
  const itemsHtml = req.items.map((item, idx) => {
    const isRent = req.type === 'HO' && req.purchaseType === 'Rent';
    const duration = isRent ? (item.duration || 1) : 1;
    const total = item.qty * item.unitPrice * duration;
    grandTotal += total;
    
    return `
      <tr style="border-bottom: 1px solid #eee;">
        <td style="padding: 8px;">${idx + 1}</td>
        <td style="padding: 8px;">
          <strong>${item.name}</strong><br/>
          <span style="font-size: 12px; color: #666;">
            ${item.subJob ? `Sub: ${item.subJob}` : ''} ${item.epCode ? `EP: ${item.epCode}` : ''}
          </span>
        </td>
        <td style="padding: 8px; text-align: right;">${item.unitPrice.toLocaleString()}</td>
        <td style="padding: 8px; text-align: center;">
            ${item.qty} ${item.unit}
            ${isRent ? `<br/><span style="font-size:10px; color:blue;">x ${duration} ${item.rentalUnit}</span>` : ''}
        </td>
        <td style="padding: 8px; text-align: right;">${total.toLocaleString()}</td>
      </tr>
    `;
  }).join('');

  const htmlBody = `
    <div style="font-family: 'Sarabun', sans-serif; max-width: 800px; margin: 0 auto; border: 1px solid #ddd; border-radius: 10px; overflow: hidden;">
      <div style="background-color: #f8f9fa; padding: 20px; border-bottom: 1px solid #ddd;">
        <h2 style="margin: 0; color: #1a73e8;">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${req.id}</h2>
        <p style="margin: 5px 0 0; color: #666;">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: <strong>${req.job}</strong> | ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: ${req.requester}</p>
      </div>
      
      <div style="padding: 20px;">
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
          <tr>
            <td style="padding: 5px; color: #666;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</td>
            <td style="font-weight: bold;">${req.type} ${req.purchaseType || ''}</td>
            <td style="padding: 5px; color: #666;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</td>
            <td style="font-weight: bold;">${req.dateRequired}</td>
          </tr>
          <tr>
            <td style="padding: 5px; color: #666;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</td>
            <td style="font-weight: bold; color: ${req.priority === 'Critical' ? 'red' : 'blue'};">${req.priority}</td>
            <td style="padding: 5px; color: #666;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</td>
            <td>${req.docNumber || '-'}</td>
          </tr>
        </table>

        <h3 style="border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
          <thead style="background-color: #f1f3f4;">
            <tr>
              <th style="padding: 10px; text-align: left;">#</th>
              <th style="padding: 10px; text-align: left;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th style="padding: 10px; text-align: right;">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
              <th style="padding: 10px; text-align: center;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th style="padding: 10px; text-align: right;">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</th>
            </tr>
          </thead>
          <tbody>
            ${itemsHtml}
          </tbody>
          <tfoot style="background-color: #f8f9fa;">
            <tr>
              <td colspan="4" style="padding: 10px; text-align: right; font-weight: bold;">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td>
              <td style="padding: 10px; text-align: right; font-weight: bold; color: #1a73e8; font-size: 16px;">${grandTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
            </tr>
          </tfoot>
        </table>
        
        ${req.note ? `<p style="margin-top: 20px; padding: 10px; background-color: #fff3cd; border-radius: 5px;"><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${req.note}</p>` : ''}

      </div>

      <div style="background-color: #f1f3f4; padding: 20px; text-align: center; border-top: 1px solid #ddd;">
        <p style="margin-bottom: 15px; font-weight: bold;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</p>
        
        <a href="${approveLink}" style="background-color: #1e8e3e; color: white; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 0 10px;">
          ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approve)
        </a>

        <a href="${rejectLink}" style="background-color: #d93025; color: white; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 0 10px;">
          ‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Reject)
        </a>
        
        <p style="font-size: 12px; color: #888; margin-top: 20px;">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
      </div>
    </div>
  `;

  try {
    GmailApp.sendEmail(targetEmail, `[PurchaseHub] ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${req.id} - ${req.job}`, '', {
      htmlBody: htmlBody
    });
    console.log(`[SendEmail] ‚úÖ Email sent successfully to ${targetEmail}`);
  } catch (error) {
    console.error(`[SendEmail] ‚ùå Failed to send email: ${error.toString()}`);
  }

  console.log(`[SendEmail] ===== END =====`);
}


function syncRequest(request) {
  console.log(`[SyncRequest] ===== START =====`);
  console.log(`[SyncRequest] Request ID: ${request.id}`);
  console.log(`[SyncRequest] Status: ${request.status}`);
  console.log(`[SyncRequest] Job: ${request.job}`);
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  const result = saveDataToSheet('Requests', request.id, request);
  
  try {
      if (request.status === 'Pending Head') {
          console.log("[SyncRequest] ‚úÖ Status = Pending Head -> Finding Head approvers...");
          const headEmails = findApproverEmails(request.job, 8); 
          
          if (headEmails) {
             console.log(`[SyncRequest] üìß Sending email to: ${headEmails}`);
             sendApprovalEmail(request, headEmails, 'Head');
             console.log("[SyncRequest] ‚úÖ Email sent successfully!");
          } else {
             console.log(`[SyncRequest] ‚ö†Ô∏è WARNING: No Head approver found for project: ${request.job}`);
          }
      }
      
      else if (request.status === 'Pending PM') {
          console.log("[SyncRequest] ‚úÖ Status = Pending PM -> Finding PM approvers...");
          const pmEmails = findApproverEmails(request.job, 9);
          
          if (pmEmails) {
             console.log(`[SyncRequest] üìß Sending email to: ${pmEmails}`);
             sendApprovalEmail(request, pmEmails, 'PM');
             console.log("[SyncRequest] ‚úÖ Email sent successfully!");
          } else {
             console.log(`[SyncRequest] ‚ö†Ô∏è WARNING: No PM approver found for project: ${request.job}`);
          }
      } 
      else {
          console.log(`[SyncRequest] ‚ÑπÔ∏è Status '${request.status}' - No email action required.`);
      }

  } catch (e) {
      console.error("‚ùå [SyncRequest] Email sending FAILED: " + e.toString());
  }

  console.log(`[SyncRequest] ===== END =====`);
  return result;
}

// --- HELPER FUNCTIONS ---

function getOrCreateSheet(sheetName) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    if (['Projects', 'Inventory', 'Assets', 'Requests', 'Users'].includes(sheetName)) {
      sheet.appendRow(['ID', 'JSON_Data']); 
    }
  }
  return sheet;
}

function getSheetData(sheetName) {
  const sheet = getOrCreateSheet(sheetName);
  
  // ‚≠ê ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô Sheet ‡∏ß‡πà‡∏≤‡∏á
  if (sheet.getLastRow() === 0) {
    console.log(`[GetSheetData] Sheet '${sheetName}' is empty. Creating header...`);
    sheet.appendRow(['ID', 'JSON_Data']); // ‡∏™‡∏£‡πâ‡∏≤‡∏á Header
    return [];
  }
  
  const data = sheet.getDataRange().getValues();
  
  // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÅ‡∏Ñ‡πà Header ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (data.length <= 1) {
    console.log(`[GetSheetData] Sheet '${sheetName}' has only header row.`);
    return [];
  }
  
  const result = [];
  
  for (let i = 0; i < data.length; i++) {
    // ‚≠ê ‡∏Ç‡πâ‡∏≤‡∏° Row 0 (Header)
    if (i === 0 && data[i][0] === 'ID') {
      continue;
    }
    
    // ‚≠ê ‡∏Ç‡πâ‡∏≤‡∏° Row ‡∏ß‡πà‡∏≤‡∏á
    if (!data[i][1] || data[i][1].toString().trim() === '') {
      continue;
    }
    
    try {
      const parsed = JSON.parse(data[i][1]);
      result.push(parsed);
    } catch (e) {
      console.error(`[GetSheetData] ‚ùå Error parsing row ${i} in ${sheetName}: ${e.toString()}`);
      console.error(`[GetSheetData] Raw data: ${data[i][1]}`);
    }
  }
  
  console.log(`[GetSheetData] Loaded ${result.length} records from ${sheetName}`);
  return result;
}

function saveDataToSheet(sheetName, id, dataObj) {
  const sheet = getOrCreateSheet(sheetName);
  const allData = sheet.getDataRange().getValues();
  let rowIndex = -1;
  for (let i = 0; i < allData.length; i++) {
    if (allData[i][0] == id) {
      rowIndex = i + 1; 
      break;
    }
  }
  const jsonString = JSON.stringify(dataObj);
  if (rowIndex > 0) {
    sheet.getRange(rowIndex, 2).setValue(jsonString);
  } else {
    sheet.appendRow([id, jsonString]);
  }
  return true;
}

function deleteDataFromSheet(sheetName, id) {
  const sheet = getOrCreateSheet(sheetName);
  const data = sheet.getDataRange().getValues();
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] == id) {
      sheet.deleteRow(i + 1);
      break;
    }
  }
}

// --- FILE UPLOAD FUNCTIONS ---

function uploadFileToDrive(base64Data, fileName) {
  try {
    const FOLDER_ID = "1M57m68rI8bM-BBqRlh_LzZHuDWPZVdwz"; 
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return {
      name: fileName,
      url: file.getUrl(),
      id: file.getId()
    };
  } catch (e) {
    return { error: e.toString() };
  }
}

function getOrCreateSubFolder(parentFolderId, subFolderName) {
  const parentFolder = DriveApp.getFolderById(parentFolderId);
  const folders = parentFolder.getFoldersByName(subFolderName);
  if (folders.hasNext()) {
    return folders.next();
  } else {
    return parentFolder.createFolder(subFolderName);
  }
}

function uploadAssetImage(base64Data, fileName) {
  try {
    const MAIN_FOLDER_ID = "1M57m68rI8bM-BBqRlh_LzZHuDWPZVdwz"; 
    const SUB_FOLDER_NAME = "Asset_Images"; 
    const targetFolder = getOrCreateSubFolder(MAIN_FOLDER_ID, SUB_FOLDER_NAME);
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    const file = targetFolder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return {
      name: fileName,
      url: file.getUrl(),
      id: file.getId()
    };
  } catch (e) {
    return { error: e.toString() };
  }
}

// --- SPECIFIC SYNC FUNCTIONS ---

function syncProject(project) {
  return saveDataToSheet('Projects', project.id, project);
}

function deleteProjectFromSheet(id) {
  deleteDataFromSheet('Projects', id);
}


function syncInventory(item) {
  return saveDataToSheet('Inventory', item.id, item);
}

function syncAsset(asset) {
  return saveDataToSheet('Assets', asset.id, asset);
}

function syncLog(log) {
  const id = log.date + '_' + Math.floor(Math.random() * 1000); 
  return saveDataToSheet('Logs', id, log);
}

// --- USER MANAGEMENT & MAIN API ---

function loginUser(username, password) {
  if (username === 'admin' && password === '1231') {
    return {
      success: true,
      user: {
        username: 'admin',
        firstName: 'System',
        lastName: 'Administrator',
        empId: 'ADMIN-001',
        role: 'Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)',
        isSuperAdmin: true,
        status: 'Activated'
      }
    };
  }

  const users = getSheetData('Users');
  const user = users.find(u => u.username === username && u.password === password);
  
  if (user) {
    if (user.status !== 'Activated') {
       return { success: false, message: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
    }
    return { 
      success: true, 
      user: {
        ...user,
        password: '' 
      }
    };
  } else {
    return { success: false, message: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' };
  }
}

function registerUser(formData) {
  const users = getSheetData('Users');
  if (users.some(u => u.username === formData.username)) {
    return { success: false, message: 'Username ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' };
  }
  
  const newUser = {
    id: formData.username, 
    ...formData,
    role: 'User', 
    status: 'New', 
    permissions: {}, 
    createdAt: new Date().toLocaleString('th-TH')
  };
  
  saveDataToSheet('Users', newUser.id, newUser);
  return { success: true, message: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
}

function saveUserData(user) {
   return saveDataToSheet('Users', user.id, user);
}

function loadInitialData() {
  return {
    requests: getSheetData('Requests'),
    inventory: getSheetData('Inventory'),
    assets: getSheetData('Assets'),
    logs: getSheetData('Logs'),
    projects: getSheetData('Projects'),
    users: getSheetData('Users') 
  };
}
