

// --- CONFIGURATION ---
// ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Script Properties ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà URL ‡∏ï‡∏£‡∏á‡πÜ
const SUPABASE_URL = PropertiesService.getScriptProperties().getProperty('SUPABASE_URL');
const SUPABASE_KEY = PropertiesService.getScriptProperties().getProperty('SUPABASE_KEY');


function doGet(e) {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Action ‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•
  if (e.parameter && e.parameter.action) {
    const act = e.parameter.action;
    
    // ‡∏Å‡∏£‡∏ì‡∏µ Bulk Reject: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏≤‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡∏£‡∏ß‡∏°)
    if (act === 'bulk_reject') {
        return createBulkRejectForm(e); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Bulk
    }
    
    // ‡∏Å‡∏£‡∏ì‡∏µ Approve All / Confirm Bulk Reject -> Process
    if (act === 'approve' || act === 'reject' || act === 'confirm_reject' || 
        act === 'bulk_approve' || act === 'confirm_bulk_reject') {
      return processEmailAction(e);
    }
  }

  // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥: ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Web App
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('PurchaseHub System')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function callSupabase(tableName, method, payload = null, params = '') {
  const table = tableName.toLowerCase(); 
  let url = `${SUPABASE_URL}/rest/v1/${table}${params}`;
  
  const options = {
    method: method,
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal',
      'User-Agent': 'PurchaseHub-Script/1.0'
    },
    muteHttpExceptions: true // ‚≠ê ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á Error Text ‡∏à‡∏≤‡∏Å Server
  };
  
  if (payload) {
    options.payload = JSON.stringify(payload);
  }

  try {
    const response = UrlFetchApp.fetch(url, options);
    const responseCode = response.getResponseCode();
    
    // ‚≠ê ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ Error (‡πÄ‡∏ä‡πà‡∏ô 400, 404, 500) ‡πÉ‡∏´‡πâ Throw ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
    if (responseCode >= 400) {
      const errorMsg = `Supabase Error (${responseCode}): ${response.getContentText()}`;
      console.error(errorMsg);
      throw new Error(errorMsg); // üëà ‡∏™‡πà‡∏á Error ‡πÑ‡∏õ‡πÉ‡∏´‡πâ Frontend ‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ
    }
    
    return response.getContentText();
    
  } catch (e) {
    // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö Error ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡πá‡∏ï‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (DNS Error, Timeout)
    console.error("‚ùå Connection Failed: " + e.toString());
    throw new Error("Connection Failed: " + e.toString());
  }
}

function createRejectForm(e) {
  const reqId = e.parameter.id;
  const role = e.parameter.role;
  const approver = e.parameter.approver;
  const scriptUrl = ScriptApp.getService().getUrl();

  const html = `
    <!DOCTYPE html>
    <html>
      <head>
        <base target="_top">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; display: flex; justify-content: center; padding-top: 50px; }
          .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 90%; max-width: 400px; }
          h2 { color: #d93025; margin-top: 0; }
          textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin: 15px 0; font-family: inherit; }
          button { background-color: #d93025; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; }
          button:hover { background-color: #b02015; }
        </style>
      </head>
      <body>
        <div class="card">
          <h2>‚ùå ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
          <p>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: <strong>${reqId}</strong></p>
          <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (Note):</p>
          
          <form id="rejectForm">
            <textarea id="reason" rows="4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥..." required></textarea>
            <button type="submit">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (Confirm Reject)</button>
          </form>

          <script>
            document.getElementById('rejectForm').onsubmit = function(e) {
              e.preventDefault();
              var reason = document.getElementById('reason').value;
              var btn = document.querySelector('button');
              btn.disabled = true;
              btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

              // Redirect ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Script ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
              var finalUrl = "${scriptUrl}?action=confirm_reject" + 
                             "&id=${reqId}" + 
                             "&role=${role}" + 
                             "&approver=${approver}" + 
                             "&note=" + encodeURIComponent(reason);
              
              window.top.location.href = finalUrl;
            };
          </script>
        </div>
      </body>
    </html>
  `;
  
  return HtmlService.createHtmlOutput(html);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Local/HO ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Log ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
function processEmailAction(e) {
  const action = e.parameter.action;
  
  // 1. ‡πÅ‡∏õ‡∏•‡∏á IDs ‡πÄ‡∏õ‡πá‡∏ô Array
  let targetIds = [];
  if (e.parameter.ids) {
      targetIds = e.parameter.ids.split(',');
  } else if (e.parameter.id) {
      targetIds = [e.parameter.id];
  }

  const approver = e.parameter.approver; // Email ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏Å‡∏î
  const urlRole = e.parameter.role;
  const customNote = e.parameter.note || ''; 

  console.log(`[ProcessEmail] Action: ${action} | Targets: ${targetIds.length} | Approver: ${approver}`);

  // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  const allUsers = getSheetData('Users');
  const requests = getSheetData('Requests');
  
  // 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
  let userObj = allUsers.find(u => u.email && approver.toLowerCase().includes(u.email.toLowerCase()));
  let userDisplay = approver; 
  
if (userObj) {
      
      userDisplay = `${userObj.empId} ${userObj.firstName} ${userObj.lastName} (${approver})`;
  }

  let successCount = 0;
  let failCount = 0;
  let skippedCount = 0;

  // 4. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  targetIds.forEach(reqId => {
      const reqIndex = requests.findIndex(r => r.id === reqId);
      if (reqIndex === -1) { failCount++; return; }

      let req = requests[reqIndex];
      
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ó‡∏≥‡∏ã‡πâ‡∏≥
      if (req.status !== 'Pending Head' && req.status !== 'Pending PM') {
           skippedCount++;
           return;
      }

      // -- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå --
      const isWithdrawOrBorrow = (req.type === 'Withdraw' || req.type === 'Borrow');
      let isValidRole = false;
      let currentRole = urlRole;

      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° Bulk (Batch) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Role ‡πÄ‡∏≠‡∏á
      if (urlRole === 'Batch' || !urlRole) {
          const userPerms = userObj?.permissions?.[req.job] || [];
          const isL1 = userPerms.includes(8) || userObj?.isSuperAdmin;
          const isL2 = userPerms.includes(9) || userObj?.isSuperAdmin;

          if (req.status === 'Pending Head') {
              if (isWithdrawOrBorrow && (isL1 || isL2)) { isValidRole = true; currentRole = 'Approver'; }
              else if (isL1) { isValidRole = true; currentRole = 'Head'; }
          } 
          else if (req.status === 'Pending PM' && isL2) {
              isValidRole = true;
              currentRole = 'PM';
          }
      } else {
          // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß (Single)
          if (urlRole === 'Head' && req.status === 'Pending Head') isValidRole = true;
          else if (urlRole === 'PM' && req.status === 'Pending PM') isValidRole = true;
          else if (isWithdrawOrBorrow && urlRole === 'PM' && req.status === 'Pending Head') isValidRole = true;
          else if (urlRole === 'Approver' && isWithdrawOrBorrow && req.status === 'Pending Head') isValidRole = true;
      }

      if (!isValidRole) { failCount++; return; }

      // -- 5. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Status ‡πÅ‡∏•‡∏∞ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Log (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) --
      let newStatus = '';
      let logActionText = ''; 
      let logNoteText = '';   
      
      const isApprove = action.includes('approve');
      
      if (isApprove) {
          // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ---
          
         if (isWithdrawOrBorrow) {
              // ‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏° -> ‡∏à‡∏ö‡πÄ‡∏•‡∏¢
              newStatus = 'Ready to Disburse';
              // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Status Label ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ
              logActionText = '‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á (‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏°)';
          }
          else if (currentRole === 'Head') {
              // ‚úÖ Level 1 ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -> ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ L2
              newStatus = 'Pending PM';
              logActionText = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Level 2'; 
          } 
          else if (currentRole === 'PM') {
              // ‚úÖ Level 2 ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
              if (req.type === 'Local') {
                  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Local -> ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠ Check
                  // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ Key 'Pending Check' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Check)"
                  newStatus = 'Pending Check';
                  logActionText = '‡∏£‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Check)'; 
              } else {
                  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô HO -> ‡∏à‡∏ö‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£
                  newStatus = 'Approved';
                  logActionText = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)'; 
              }
          } 
          else {
              // Fallback
              newStatus = 'Ready to Disburse';
              logActionText = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)';
          }
      } else {
          // --- ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ---
          newStatus = 'Rejected';
          logActionText = '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Rejected)';
          logNoteText = customNote ? `‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${customNote}` : '';
      }

      // -- 6. Generate Doc No --
      if (!req.docNumber && (newStatus === 'Pending PM' || newStatus === 'Approved' || newStatus === 'Pending Check' || newStatus === 'Ready to Disburse')) {
          const count = getNextDocIndex(requests, req.type, req.purchaseType);
          req.docNumber = generateDocId(req.type, count, req.purchaseType);
          if (logNoteText) logNoteText += ' ';
          logNoteText += `(New Doc No: ${req.docNumber})`;
      }

      // -- 7. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --
      req.status = newStatus;
      if (!req.history) req.history = [];
      
      req.history.push({
          date: new Date().toLocaleString('th-TH'), 
          action: logActionText,                    
          user: userDisplay,                        
          note: logNoteText                         
      });
      
      saveDataToSheet('Requests', req.id, req);
      
      // -- 8. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô --
      if (newStatus === 'Pending PM') {
          try {
              const pmEmails = findApproverEmails(req.job, 9);
              if (pmEmails) sendApprovalEmail(req, pmEmails, 'PM');
          } catch(e) { console.error("Err sending PM email", e); }
      }
      
      try { handleStatusNotification(req); } catch(e){}

      successCount++;
  });

  // -- 9. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö --
  const isReject = action.includes('reject');
  const color = isReject ? 'red' : 'green';
  const msgTitle = isReject ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
  
  let summaryMsg = `<p>‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <strong>${successCount}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>`;
  if (skippedCount > 0) summaryMsg += `<p style="color:gray; font-size: 12px;">(‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ <strong>${skippedCount}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)</p>`;
  if (failCount > 0) summaryMsg += `<p style="color:orange; font-size: 12px;">(‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ${failCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</p>`;
  
  return HtmlService.createHtmlOutput(`
    <div style="font-family: 'Sarabun', sans-serif; text-align: center; padding: 50px;">
      <h1 style="color: ${color};">${msgTitle} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</h1>
      ${summaryMsg}
      <p style="color:#555;">‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
      <button onclick="window.close()" style="padding: 10px 25px; margin-top:20px; cursor: pointer; border:none; background:#333; color:white; border-radius:5px;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button>
    </div>
  `);
}

function findApproverEmails(projectName, permId) {
  console.log(`[FindApprover] ===== START =====`);
  console.log(`[FindApprover] Project: ${projectName}, Permission ID: ${permId}`);
  
  const users = getSheetData('Users');
  console.log(`[FindApprover] Total users in database: ${users.length}`);

  const approvers = users.filter(u => {
    // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ Status ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Activated ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    if (u.status !== 'Activated') {
      return false;
    }

    // Super Admin ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
    if (u.isSuperAdmin) {
      console.log(`[FindApprover] ‚úÖ Found SuperAdmin: ${u.username} (${u.email})`);
      return true;
    }

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
    if (u.permissions && u.permissions[projectName]) {
      const userPerms = u.permissions[projectName].map(Number); 
      const targetPerm = Number(permId);
      
      // ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin (2) ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
      const hasRight = userPerms.includes(2) || userPerms.includes(targetPerm);
      
      if (hasRight) {
        console.log(`[FindApprover] ‚úÖ Found User: ${u.username} (${u.email}) | Permissions: [${userPerms.join(', ')}]`);
      }
      return hasRight;
    }
    
    return false;
  });

  // ‚≠ê ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  const emails = approvers
    .map(u => u.email)
    .filter(email => email && email.includes('@') && email.trim() !== '');
  
  const result = emails.join(',');
  console.log(`[FindApprover] ===== RESULT =====`);
  console.log(`[FindApprover] Emails: ${result || '(NONE)'}`);
  console.log(`[FindApprover] ===== END =====`);
  
  return result;
}

// --- HELPER: ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Budget Tracking ‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° (Group Only) ‡∏ï‡∏≤‡∏° Logic ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
function getBudgetInfoForEmail_FullDetail(req) {
  // 1. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ HO / Local ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  if (!['Local', 'HO'].includes(req.type)) return '';

  // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  const projects = getSheetData('Projects');
  const projectData = projects.find(p => p.name === req.job);
  if (!projectData) return '';

  const allRequests = getSheetData('Requests');
  const allAssets = getSheetData('Assets');

  // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö index.html)
  const calculateItemTotal = (r, item) => {
    const isRent = r.type === 'HO' && r.purchaseType === 'Rent';
    const relatedAssets = allAssets.filter(a => 
        a.currentRequestId === r.id && 
        a.name === item.name &&
        (a.price === item.unitPrice || a.rentalPrice === item.unitPrice)
    );
    const receivedLogs = item.receivedLog || [];
    
    let itemVal = 0;
    let cnt = 0;

    if (relatedAssets.length > 0) {
        itemVal += relatedAssets.reduce((s, asset) => {
            const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
            const duration = isRent ? (asset.duration || item.duration || 1) : 1;
            return s + (price * duration);
        }, 0);
        cnt = relatedAssets.length;
    } else if (receivedLogs.length > 0) {
        itemVal += receivedLogs.reduce((s, log) => {
            const duration = isRent ? (log.duration || 1) : 1;
            return s + (log.qty * log.price * duration);
        }, 0);
        cnt = item.receivedTotal || 0;
    }

    if (r.status !== 'Completed') {
        const rem = Math.max(0, item.qty - cnt);
        const dur = isRent ? (item.duration || 1) : 1;
        itemVal += (rem * (item.unitPrice || 0) * dur);
    }
    return itemVal;
  };

  // 4. ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Grouping Logic)
  const groups = {};
  req.items.forEach(item => {
    ['SubJob', 'matCode'].forEach(type => {
      const code = type === 'SubJob' ? item.subJob : item.matCode;
      if (!code) return;

      const defs = type === 'SubJob' ? projectData.subJobs : projectData.matCodes;
      const targetDef = defs?.find(d => d.code === code);
      const groupName = targetDef?.group || 'Others (‡∏≠‡∏∑‡πà‡∏ô‡πÜ)';
      const groupKey = `${type}|${groupName}`;

      if (!groups[groupKey]) {
        groups[groupKey] = { type, name: groupName, codes: new Set(), budget: 0, used: 0, pending: 0, current: 0 };
      }
      groups[groupKey].codes.add(code);
    });
  });

  // 5. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
  Object.keys(groups).forEach(key => {
    const group = groups[key];
    const defs = group.type === 'SubJob' ? projectData.subJobs : projectData.matCodes;
    
    // ‡∏£‡∏ß‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
    group.budget = defs.filter(d => d.group === group.name || (!d.group && group.name === 'Others (‡∏≠‡∏∑‡πà‡∏ô‡πÜ)'))
                        .reduce((sum, d) => sum + (d.budget || 0), 0);

    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°
    allRequests.forEach(r => {
      if (r.job !== req.job || !['Local', 'HO'].includes(r.type)) return;
      
      r.items.forEach(item => {
        const itemCode = group.type === 'SubJob' ? item.subJob : item.matCode;
        if (group.codes.has(itemCode)) {
          const val = calculateItemTotal(r, item);
          if (r.id === req.id) group.current += val;
          else if (r.status === 'Completed') group.used += val;
          else if (!['Draft', 'Rejected', 'Returned'].includes(r.status)) group.pending += val;
        }
      });
    });
  });

  // 6. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML (Progress Bar) ‡∏•‡πâ‡∏≠‡∏ï‡∏≤‡∏° Logic
  let html = `
    <div style="margin-top: 20px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; font-family: 'Sarabun', sans-serif;">
      <div style="background-color: #fff8e1; padding: 12px; border-bottom: 1px solid #ffe0b2;">
        <h3 style="margin: 0; font-size: 14px; color: #f57c00;">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏≤‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏° (Group Budget Tracking)</h3>
      </div>
      <div style="padding: 15px; background-color: #ffffff;">
  `;

  Object.keys(groups).sort().forEach(key => {
    const g = groups[key];
    if (g.budget === 0) return;

    const totalUsed = g.used + g.pending + g.current;
    const isOver = totalUsed > g.budget;
    const usedPct = Math.min((g.used / g.budget) * 100, 100);
    const pendingPct = Math.min((g.pending / g.budget) * 100, 100 - usedPct);
    const currentPct = Math.min((g.current / g.budget) * 100, 100 - usedPct - pendingPct);

    html += `
      <div style="margin-bottom: 18px;">
        <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;">
          <div style="font-weight:bold;">
            <span style="background:${g.type === 'SubJob' ? '#e8eaf6' : '#f3e5f5'}; color:${g.type === 'SubJob' ? '#3f51b5' : '#7b1fa2'}; padding:2px 5px; border-radius:4px; font-size:10px; margin-right:5px;">${g.type === 'SubJob' ? 'SubJob' : 'Mat. Code'}</span>
            ${g.name}
          </div>
          <div style="font-weight:bold; color:${isOver ? '#d32f2f' : '#333'}">
            ‡πÉ‡∏ä‡πâ‡∏£‡∏ß‡∏°: ${totalUsed.toLocaleString()} / ${g.budget.toLocaleString()} 
            ${isOver ? '<span style="color:red; font-size:10px;">(‡πÄ‡∏Å‡∏¥‡∏ô‡∏á‡∏ö!)</span>' : ''}
          </div>
        </div>
        <div style="height: 10px; width: 100%; background: #f1f1f1; border-radius: 5px; overflow: hidden; display: flex;">
          <div style="width: ${usedPct}%; background: #4caf50;"></div>
          <div style="width: ${pendingPct}%; background: #ffc107;"></div>
          <div style="width: ${currentPct}%; background: #ff9800;"></div>
        </div>
        <table style="width: 100%; font-size: 10px; color: #666; margin-top: 4px;">
          <tr>
            <td>‚óè ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß (${g.used.toLocaleString()})</td>
            <td>‚óè ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (${g.pending.toLocaleString()})</td>
            <td>‚óè ‡πÉ‡∏ö‡∏ô‡∏µ‡πâ (${g.current.toLocaleString()})</td>
            <td style="text-align: right; font-weight:bold; color:${(g.budget-totalUsed) < 0 ? '#d32f2f' : '#2e7d32'}">
              ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${(g.budget - totalUsed).toLocaleString()}
            </td>
          </tr>
        </table>
      </div>
    `;
  });

  html += `</div></div>`;
  return html;
}


function sendApprovalEmail(req, targetEmail, targetRole) {
  console.log(`[SendEmail] ===== START =====`);
  if (!targetEmail || targetEmail.trim() === '') {
    console.error(`[SendEmail] ‚ùå ERROR: Target email is empty!`);
    return;
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Inventory ‡πÅ‡∏•‡∏∞ Assets ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å
  const inventory = getSheetData('Inventory');
  const assets = getSheetData('Assets');
  const scriptUrl = ScriptApp.getService().getUrl();
  const approverName = targetEmail; 

  const approveLink = `${scriptUrl}?action=approve&id=${req.id}&role=${targetRole}&approver=${approverName}`;
  const rejectLink = `${scriptUrl}?action=reject&id=${req.id}&role=${targetRole}&approver=${approverName}`;
  
  let grandTotal = 0;
  // ‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
  const getRentalUnitTh = (unit) => {
      if(unit === 'Day') return '‡∏ß‡∏±‡∏ô';
      if(unit === 'Month') return '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
      if(unit === 'Year') return '‡∏õ‡∏µ';
      return unit || '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'; // Default
  };

  const itemsHtml = req.items.map((item, idx) => {
    const isRent = req.type === 'HO' && req.purchaseType === 'Rent';
    const duration = isRent ? (item.duration || 1) : 1;
    const rentalUnitTh = getRentalUnitTh(item.rentalUnit);
    const total = item.qty * (item.unitPrice || 0) * duration;
    grandTotal += total;

    // --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Web App) ---
    let stockInfo = '';
    const matchingStocks = inventory.filter(inv => inv.name === item.name && inv.project === req.job);
    const totalStockQty = matchingStocks.reduce((sum, inv) => sum + inv.qty, 0);
    const availableAssets = assets.filter(a => a.name === item.name && a.project === req.job && a.status === 'Available').length;

    if (totalStockQty > 0) {
        stockInfo += `<div style="font-size:10px; color:#00796b; background-color:#e0f2f1; padding:2px 4px; border-radius:3px; display:inline-block; margin-top:2px;">‡∏°‡∏µ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á: ${totalStockQty}</div> `;
    }
    if (availableAssets > 0) {
        stockInfo += `<div style="font-size:10px; color:#283593; background-color:#e8eaf6; padding:2px 4px; border-radius:3px; display:inline-block; margin-top:2px;">‡∏ß‡πà‡∏≤‡∏á: ${availableAssets}</div>`;
    }
    // ---------------------------------------------
    
    // Mobile-friendly table row with NOTE column
    return `
      <tr style="border-bottom: 1px solid #eee;">
        <td style="padding: 12px 5px; vertical-align: top; width: 30px;">${idx + 1}</td>
        <td style="padding: 12px 5px; vertical-align: top;">
          <div style="font-weight: bold; color: #333; font-size: 14px;">${item.name}</div>
          <div style="font-size: 12px; color: #666; margin-top: 4px;">
            ${item.subJob ? `<span style="background:#e3f2fd; color:#1565c0; padding:2px 4px; border-radius:3px;">Sub: ${item.subJob}</span>` : ''} 
            ${item.MatCode ? `<span style="background:#f3e5f5; color:#7b1fa2; padding:2px 4px; border-radius:3px;">EP: ${item.MatCode}</span>` : ''}
          </div>
          <div style="margin-top: 5px; font-size: 12px; color: #555;">
             ${item.note ? `${item.note}<br/>` : ''}
             ${stockInfo}
          </div>
        </td>
        <td style="padding: 12px 5px; text-align: right; vertical-align: top; white-space: nowrap;">
            <div style="font-weight: bold;">${item.qty} ${item.unit}</div>
            ${isRent ? `<div style="font-size:10px; color:blue;">x ${duration} ${rentalUnitTh}</div>` : ''}
        </td>
        <td style="padding: 12px 5px; text-align: right; vertical-align: top; white-space: nowrap;">
            <div style="font-size: 12px; color:#666;">
                @${item.unitPrice.toLocaleString()} ${isRent ? '/' + rentalUnitTh : ''}
            </div>
            <div style="font-weight: bold; color: #333; font-size: 14px;">${total.toLocaleString()}</div>
        </td>
      </tr>
    `;
  }).join('');

  // ‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Budget HTML (Full Detail)
  const budgetHtml = getBudgetInfoForEmail_FullDetail(req);

  const htmlBody = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
        body { margin: 0; padding: 0; background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background-color: #ffffff; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        .header { background-color: #1976d2; padding: 25px 20px; color: #ffffff; }
        .content { padding: 20px; }
        .btn { 
            display: inline-block; 
            padding: 12px 24px; 
            text-decoration: none; 
            border-radius: 6px; 
            font-weight: bold; 
            font-size: 16px; 
            text-align: center;
            margin: 5px;
        }
        .btn-approve { background-color: #2e7d32; color: white !important; }
        .btn-reject { background-color: #d32f2f; color: white !important; }
        .btn-link { background-color: #fff; color: #1976d2 !important; border: 1px solid #1976d2; font-size: 14px; padding: 10px 20px;}
        
        @media only screen and (max-width: 600px) {
          .btn { display: block; width: 90%; margin: 10px auto; }
          .meta-table td { display: block; width: 100%; padding-bottom: 5px; }
          .header h2 { font-size: 20px; }
        }
      </style>
    </head>
    <body>
      <div style="padding: 10px;">
        <div class="container">
          
          <div class="header">
            <h2 style="margin: 0;">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${req.id}</h2>
            <p style="margin: 5px 0 0; opacity: 0.9;">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: <strong>${req.job}</strong></p>
            <p style="margin: 2px 0 0; opacity: 0.9; font-size: 14px;">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: ${req.requester}</p>
          </div>
          
          <div class="content">
            <table class="meta-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px; color: #444;">
              <tr>
                <td style="padding: 5px; color: #888;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</td>
                <td style="padding: 5px; font-weight: bold; color: #333;">
                    ${req.type === 'HO' ? (req.purchaseType === 'Rent' ? 'HO (‡πÄ‡∏ä‡πà‡∏≤)' : 'HO (‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏î)') : req.type}
                </td>
              </tr>
              <tr>
                <td style="padding: 5px; color: #888;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</td>
                <td style="padding: 5px; font-weight: bold; color: #333;">${req.dateRequired}</td>
              </tr>
              <tr>
                <td style="padding: 5px; color: #888;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</td>
                <td style="padding: 5px; font-weight: bold; color: ${req.priority === 'Critical' ? 'red' : 'blue'};">${req.priority}</td>
              </tr>
            </table>

            <h3 style="border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 0; font-size: 16px; color: #333;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
              <thead style="background-color: #f9fafb; color: #666; font-size: 12px;">
                <tr>
                  <th style="padding: 8px 5px; text-align: left;">#</th>
                  <th style="padding: 8px 5px; text-align: left;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                  <th style="padding: 8px 5px; text-align: right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th style="padding: 8px 5px; text-align: right;">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</th>
                </tr>
              </thead>
              <tbody>
                ${itemsHtml}
              </tbody>
              <tfoot style="background-color: #f1f8e9;">
                <tr>
                  <td colspan="3" style="padding: 10px; text-align: right; font-weight: bold; color: #333;">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</td>
                  <td style="padding: 10px 5px; text-align: right; font-weight: bold; color: #1976d2; font-size: 16px;">${grandTotal.toLocaleString()}</td>
                </tr>
              </tfoot>
            </table>
            
            ${req.note ? `
              <div style="margin-top: 20px; padding: 12px; background-color: #fff8e1; border-radius: 6px; border-left: 4px solid #ffc107; font-size: 14px;">
                <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</strong> ${req.note}
              </div>` : ''}

            ${budgetHtml}

            <div style="margin-top: 30px; text-align: center; border-top: 1px solid #eee; padding-top: 20px;">
              <p style="margin-bottom: 15px; font-weight: bold; color: #555;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</p>
              
              <a href="${approveLink}" class="btn btn-approve">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approve)</a>
              <a href="${rejectLink}" class="btn btn-reject">‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Reject)</a>
              
              <div style="margin-top: 20px;">
                <a href="${scriptUrl}" target="_blank" class="btn btn-link">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ (Open App)</a>
              </div>

              <p style="font-size: 12px; color: #999; margin-top: 15px;">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
            </div>

          </div>
        </div>
      </div>
    </body>
    </html>
  `;

  try {
    GmailApp.sendEmail(targetEmail, `[PurchaseHub] ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${req.id} - ${req.job}`, '', {
      htmlBody: htmlBody
    });
    console.log(`[SendEmail] ‚úÖ Email sent successfully to ${targetEmail}`);
  } catch (error) {
    console.error(`[SendEmail] ‚ùå Failed to send email: ${error.toString()}`);
  }

  console.log(`[SendEmail] ===== END =====`);
}

function syncRequest(request) {
  console.log(`[SyncRequest] ===== START =====`);
  console.log(`[SyncRequest] Request ID: ${request.id}`);
  console.log(`[SyncRequest] Status: ${request.status}`);
  console.log(`[SyncRequest] Job: ${request.job}`);
  
  // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  const result = saveDataToSheet('Requests', request.id, request);
  
// 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approval Buttons)
  try {
      if (request.status === 'Pending Head') {
          // ‚≠ê‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏Ç‡∏≠ ‚≠ê‚≠ê
          if (request.type === 'Withdraw' || request.type === 'Borrow') {
              // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏°: ‡∏´‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏±‡πâ‡∏á 2 ‡∏£‡∏∞‡∏î‡∏±‡∏ö
              const headEmails = findApproverEmails(request.job, 8); // Level 1
              const pmEmails = findApproverEmails(request.job, 9);   // Level 2
              
              // ‡∏£‡∏ß‡∏°‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏õ‡πá‡∏ô string ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma)
              let recipients = [];
              if (headEmails) recipients.push(headEmails);
              if (pmEmails) recipients.push(pmEmails);
              
              // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Role ‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡πà‡∏≤ 'Approver'
              if (recipients.length > 0) {
                  const combinedEmails = recipients.join(',');
                  sendApprovalEmail(request, combinedEmails, 'Approver'); 
              }
          } else {
              // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ã‡∏∑‡πâ‡∏≠ Local/HO): ‡∏™‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏¥‡∏°
              const headEmails = findApproverEmails(request.job, 8);
              if (headEmails) sendApprovalEmail(request, headEmails, 'Head');
          }
      }
      else if (request.status === 'Pending PM') {
          const pmEmails = findApproverEmails(request.job, 9);
          if (pmEmails) sendApprovalEmail(request, pmEmails, 'PM');
      } 
  } catch (e) {
      console.error("‚ùå [SyncRequest] Approval Email FAILED: " + e.toString());
  }

  // 3. ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Notification) (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  try {
      handleStatusNotification(request);
  } catch (e) {
      console.error("‚ùå [SyncRequest] Notification Email FAILED: " + e.toString());
  }

  console.log(`[SyncRequest] ===== END =====`);
  return result;
}

// --- HELPER FUNCTIONS ---





// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getSheetData ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Query (Filter)
function getSheetData(sheetName, customQuery = '') {
  // 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Parameter ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏î‡∏∂‡∏á‡πÅ‡∏Ñ‡πà column payload)
  let params = '?select=payload';
  
  // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Query ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏°‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á) ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
  if (customQuery) {
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ customQuery ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ & ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°
    if (!customQuery.startsWith('&')) params += '&';
    params += customQuery;
  }

  // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Supabase ‡∏û‡∏£‡πâ‡∏≠‡∏° Filter ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
  // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô callSupabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö params ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 4 ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
  const jsonResponse = callSupabase(sheetName.toLowerCase(), 'get', null, params);
  
  // 4. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  try {
    const data = JSON.parse(jsonResponse);
    if (Array.isArray(data)) {
      return data.map(row => row.payload);
    } else {
      return []; 
    }
  } catch (e) {
    console.error("Error parsing data from " + sheetName + ": " + e.toString());
    return [];
  }
}

function saveDataToSheet(sheetName, id, dataObj) {
  // ‡πÉ‡∏ä‡πâ UPSERT (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ID ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ö ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)
  const record = {
    id: id.toString(), // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô String
    payload: dataObj   // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πâ‡∏≠‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏ô jsonb
  };
  
  // ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö POST ‡∏û‡∏£‡πâ‡∏≠‡∏° header Prefer: resolution=merge-duplicates ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Upsert ‡πÉ‡∏ô Supabase
  const table = sheetName.toLowerCase();
  const url = `${SUPABASE_URL}/rest/v1/${table}`;
  const options = {
    method: 'post',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'resolution=merge-duplicates' // ‚≠ê ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ö‡∏ñ‡πâ‡∏≤ ID ‡∏ã‡πâ‡∏≥
    },
    payload: JSON.stringify(record)
  };
  
  UrlFetchApp.fetch(url, options);
  return true;
}

function deleteDataFromSheet(sheetName, id) {
  // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡πâ‡∏≠‡∏á Encode ID ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ |
  var encodedId = encodeURIComponent(id);
  
  // ‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà id ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
  callSupabase(sheetName, 'delete', null, `?id=eq.${encodedId}`);
}

// --- FILE UPLOAD FUNCTIONS ---

function uploadFileToDrive(base64Data, fileName) {
  try {
    const FOLDER_ID = "1bLG6dp7SJVEMvDudKKZnoCpriUPrJyOU"; 
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return {
      name: fileName,
      url: file.getUrl(),
      id: file.getId()
    };
  } catch (e) {
    return { error: e.toString() };
  }
}

function getOrCreateSubFolder(parentFolderId, subFolderName) {
  const parentFolder = DriveApp.getFolderById(parentFolderId);
  const folders = parentFolder.getFoldersByName(subFolderName);
  if (folders.hasNext()) {
    return folders.next();
  } else {
    return parentFolder.createFolder(subFolderName);
  }
}

function uploadAssetImage(base64Data, fileName) {
  try {
    const MAIN_FOLDER_ID = "1bLG6dp7SJVEMvDudKKZnoCpriUPrJyOU"; 
    const SUB_FOLDER_NAME = "Asset_Images"; 
    const targetFolder = getOrCreateSubFolder(MAIN_FOLDER_ID, SUB_FOLDER_NAME);
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    const file = targetFolder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return {
      name: fileName,
      url: file.getUrl(),
      id: file.getId()
    };
  } catch (e) {
    return { error: e.toString() };
  }
}

// --- SPECIFIC SYNC FUNCTIONS ---

function syncProject(project) {
  return saveDataToSheet('Projects', project.id, project);
}

function deleteProjectFromSheet(id) {
  deleteDataFromSheet('Projects', id);
}


function syncInventory(item) {
  return saveDataToSheet('Inventory', item.id, item);
}

function syncAsset(asset) {
  return saveDataToSheet('Assets', asset.id, asset);
}

function syncLog(log) {
  const id = log.date + '_' + Math.floor(Math.random() * 1000); 
  return saveDataToSheet('Logs', id, log);
}

// --- USER MANAGEMENT & MAIN API ---

function loginUser(username, password) {
  if (username === 'admin' && password === '1231') {
    return {
      success: true,
      user: {
        username: 'admin',
        firstName: 'System',
        lastName: 'Administrator',
        empId: 'ADMIN-001',
        role: 'Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)',
        isSuperAdmin: true,
        status: 'Activated'
      }
    };
  }

  const users = getSheetData('Users');
  const user = users.find(u => u.username === username && u.password === password);
  
  if (user) {
    if (user.status !== 'Activated') {
       return { success: false, message: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
    }
    return { 
      success: true, 
      user: {
        ...user,
        password: '' 
      }
    };
  } else {
    return { success: false, message: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' };
  }
}

function registerUser(formData) {
  const users = getSheetData('Users');
  if (users.some(u => u.username === formData.username)) {
    return { success: false, message: 'Username ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' };
  }
  
  const newUser = {
    id: formData.username, 
    ...formData,
    role: 'User', 
    status: 'New', 
    permissions: {}, 
    createdAt: new Date().toLocaleString('th-TH')
  };
  
  saveDataToSheet('Users', newUser.id, newUser);
  return { success: true, message: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
}

// [‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveUserData ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ]

function saveUserData(user) {
  const users = getSheetData('Users');
  
  // ‚≠ê ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Emp ID) ‡∏ã‡πâ‡∏≥
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ EmpID ‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏° (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
  const duplicate = users.find(u => u.empId === user.empId && u.id !== user.id);
  if (duplicate) {
    return { 
      success: false, 
      message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${user.empId} ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ${duplicate.firstName} ${duplicate.lastName}` 
    };
  }

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
  saveDataToSheet('Users', user.id, user);
  return { success: true, message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' };
}

function loadInitialData() {
  const settings = getSheetData('Settings');
  const announcement = settings.find(s => s.id === 'ANNOUNCEMENT') || null;
  
  return {
    requests: getSheetData('Requests'),
    inventory: getSheetData('Inventory'),
    assets: getSheetData('Assets'),
    // logs: getSheetData('Logs'), // ‚ùå ‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î Logs ‡∏Å‡πâ‡∏≠‡∏ô‡∏¢‡∏±‡∏Å‡∏©‡πå‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ
    logs: [], // ‚úÖ ‡∏™‡πà‡∏á Array ‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á
    projects: getSheetData('Projects'),
    users: getSheetData('Users'),
    announcement: announcement
  };
}

// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getRecentLogs (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2564) ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ

// ‚≠ê ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡πÄ‡∏û‡∏¥‡πà‡∏° limit ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô 200 ‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° created_at ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡πÑ‡∏î‡πâ
function getRecentLogs(limit = 200) {
  // ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° created_at (‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ Database ‡∏à‡∏£‡∏¥‡∏á) ‡∏à‡∏∞‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Å‡∏ß‡πà‡∏≤ id ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô string
  // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ created_at ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ id.desc ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
  // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: Supabase ‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡∏∞‡∏°‡∏µ created_at ‡πÉ‡∏´‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
  
  // ‡πÉ‡∏ä‡πâ id.desc ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ id ‡∏Ñ‡∏∏‡∏ì gen ‡∏à‡∏≤‡∏Å date string) 
  // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° limit ‡πÉ‡∏´‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á
  const params = `?select=payload&order=id.desc&limit=${limit}`;
  
  const jsonResponse = callSupabase('logs', 'get', null, params);
  
  try {
    const data = JSON.parse(jsonResponse);
    if (Array.isArray(data)) {
      return data.map(row => row.payload);
    } else {
      return [];
    }
  } catch (e) {
    console.error("Error parsing logs: " + e.toString());
    return [];
  }
}
// 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á OTP ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö empId ‡∏°‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢
function sendRegistrationOTP(email, username, empId) { // ‚≠ê ‡∏£‡∏±‡∏ö‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå empId ‡πÄ‡∏û‡∏¥‡πà‡∏°
  const users = getSheetData('Users');

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Username ‡∏ã‡πâ‡∏≥
  if (users.some(u => u.username === username)) {
    return { success: false, message: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username) ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà' };
  }

  // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö EmpID ‡∏ã‡πâ‡∏≥ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ)
  if (users.some(u => u.empId === empId)) {
    return { success: false, message: '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß' };
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Email ‡∏ã‡πâ‡∏≥
  if (users.some(u => u.email === email)) {
    return { success: false, message: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' };
  }

  // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á OTP ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
  const otp = Math.floor(1000 + Math.random() * 9000).toString();
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let refCode = '';
  for (let i = 0; i < 4; i++) {
    refCode += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  
  CacheService.getScriptCache().put('OTP_' + email, otp, 300);

  try {
    GmailApp.sendEmail(email, `[PurchaseHub] ‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (Ref: ${refCode})`, 
      `‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (Ref Code): ${refCode}\n\n‡∏£‡∏´‡∏±‡∏™ OTP ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: ${otp}\n\n(‡∏£‡∏´‡∏±‡∏™‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏ 5 ‡∏ô‡∏≤‡∏ó‡∏µ)`);
    return { success: true, message: '‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP ‡πÅ‡∏•‡πâ‡∏ß', refCode: refCode };
  } catch (e) {
    return { success: false, message: '‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.toString() };
  }
}

// 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
function registerUser(formData, otp) {
  const cachedOtp = CacheService.getScriptCache().get('OTP_' + formData.email);
  if (!cachedOtp || cachedOtp !== otp) {
    return { success: false, message: '‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà)' };
  }
  
  CacheService.getScriptCache().remove('OTP_' + formData.email);

  const users = getSheetData('Users');
  
  // ‡πÄ‡∏ä‡πá‡∏Ñ Username ‡∏ã‡πâ‡∏≥
  if (users.some(u => u.username === formData.username)) {
    return { success: false, message: 'Username ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' };
  }

  // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ EmpID ‡∏ã‡πâ‡∏≥ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ)
  if (users.some(u => u.empId === formData.empId)) {
    return { success: false, message: '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' };
  }
  
  const newUser = {
    id: formData.username, 
    ...formData,
    role: 'User', 
    status: 'New', 
    permissions: {}, 
    createdAt: new Date().toLocaleString('th-TH')
  };
  saveDataToSheet('Users', newUser.id, newUser);
  return { success: true, message: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
}
// --- [Server Side] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ---

// 1. ‡∏™‡πà‡∏á OTP ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
function sendForgotPasswordOTP(email) {
  const users = getSheetData('Users');
  const user = users.find(u => u.email === email);
  
  if (!user) {
    return { success: false, message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' };
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á OTP ‡πÅ‡∏•‡∏∞ Ref Code
  const otp = Math.floor(1000 + Math.random() * 9000).toString();
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let refCode = '';
  for (let i = 0; i < 4; i++) { refCode += chars.charAt(Math.floor(Math.random() * chars.length)); }
  
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á Cache (‡πÉ‡∏ä‡πâ key ‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≠‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
  CacheService.getScriptCache().put('RESET_OTP_' + email, otp, 300); // 5 ‡∏ô‡∏≤‡∏ó‡∏µ

  try {
    GmailApp.sendEmail(email, `[PurchaseHub] ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Ref: ${refCode})`, 
      `‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (Ref Code): ${refCode}\n\n‡∏£‡∏´‡∏±‡∏™ OTP ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏∑‡∏≠: ${otp}\n\n(‡∏£‡∏´‡∏±‡∏™‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏ 5 ‡∏ô‡∏≤‡∏ó‡∏µ)`);
    return { success: true, message: '‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß', refCode: refCode };
  } catch (e) {
    return { success: false, message: '‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.toString() };
  }
}

// 2. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
function resetPassword(email, otp, newPassword) {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OTP
  const cachedOtp = CacheService.getScriptCache().get('RESET_OTP_' + email);
  if (!cachedOtp || cachedOtp !== otp) {
    return { success: false, message: '‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' };
  }

  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User
  const users = getSheetData('Users');
  const user = users.find(u => u.email === email);
  
  if (user) {
    user.password = newPassword; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
    saveDataToSheet('Users', user.id, user); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheet
    
    CacheService.getScriptCache().remove('RESET_OTP_' + email); // ‡∏•‡∏ö OTP ‡∏ó‡∏¥‡πâ‡∏á
    return { success: true, message: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà' };
  }
  
  return { success: false, message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' };
}

// --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ---
function sendUsernameToEmail(email) {
  const users = getSheetData('Users');
  const user = users.find(u => u.email === email);
  
  if (!user) {
    return { success: false, message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' };
  }

  try {
    GmailApp.sendEmail(email, '[PurchaseHub] ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username Recovery)', 
      `‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì ${user.firstName},\n\n‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username) ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: ${user.username}\n\n‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö`);
    return { success: true, message: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username) ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß' };
  } catch (e) {
    return { success: false, message: '‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.toString() };
  }
}

// --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå Code.gs] ---



// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å Sheet (Requests, Assets, Logs)
// --- [Code.gs] ---

// ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö (Global Update) - ‡∏â‡∏ö‡∏±‡∏ö Supabase
function updateUserGlobalData(oldData, newData) {
  console.log(`[GlobalUpdate] Starting... from ${oldData.empId} to ${newData.empId}`);

  // 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
  const newFullSig = `${newData.empId} ${newData.firstName} ${newData.lastName}`;
  const newShortName = `${newData.firstName} ${newData.lastName}`;

  // 2. ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  const oldPatterns = [
    `${oldData.empId} ${oldData.firstName} ${oldData.lastName}`,
    `${oldData.empId} ${oldData.firstName} ${oldData.lastName} (Email)`,
    `${oldData.firstName} ${oldData.lastName}`,
    `${oldData.empId} ${oldData.firstName}`,
    oldData.empId
  ];

  const isMatch = (value) => {
    if (!value || typeof value !== 'string') return false;
    const val = value.trim();
    return oldPatterns.some(pattern => {
      if (pattern === oldData.empId) return val.startsWith(pattern);
      return val === pattern || val.replace(/\s+/g, ' ') === pattern;
    });
  };

  let countReq = 0;
  let countLog = 0;
  let countAsset = 0;

  // --- Helper ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏° ID (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Logs ‡πÑ‡∏°‡πà‡∏°‡∏µ ID ‡πÉ‡∏ô Payload) ---
  const getTableData = (table) => {
    const res = callSupabase(table, 'get', null, '?select=id,payload');
    const data = JSON.parse(res);
    return Array.isArray(data) ? data : [];
  };

  // --- 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á Requests ---
  const requestRows = getTableData('Requests');
  requestRows.forEach(row => {
    let req = row.payload;
    let changed = false;

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
    if (isMatch(req.requester)) { req.requester = newShortName; changed = true; }
    if (isMatch(req.approverL1)) { req.approverL1 = newFullSig; changed = true; }
    if (isMatch(req.approverL2)) { req.approverL2 = newFullSig; changed = true; }

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô History
    if (req.history && Array.isArray(req.history)) {
      req.history.forEach(h => {
        if (isMatch(h.user)) { h.user = newFullSig; changed = true; }
      });
    }

    if (changed) {
      saveDataToSheet('Requests', row.id, req);
      countReq++;
    }
  });

  // --- 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á Logs (‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏ß‡∏°) ---
  const logRows = getTableData('Logs');
  logRows.forEach(row => {
    let log = row.payload;
    if (isMatch(log.by)) {
      log.by = newFullSig;
      saveDataToSheet('Logs', row.id, log);
      countLog++;
    }
  });

  // --- 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á Assets (‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á) ---
  const assetRows = getTableData('Assets');
  assetRows.forEach(row => {
    let asset = row.payload;
    if (isMatch(asset.holder)) {
      asset.holder = newShortName;
      saveDataToSheet('Assets', row.id, asset);
      countAsset++;
    }
  });

  return {
    success: true,
    message: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£(${countReq}), ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥(${countLog}), ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô(${countAsset})`
  };
}

// [‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ô Code.gs]

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á Admin)
function getAllAnnouncements() {
  const settings = getSheetData('Settings');
  // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Row ‡∏ó‡∏µ‡πà ID ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ANN-
  return settings.filter(s => s.id && s.id.toString().startsWith('ANN-'));
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà Active" (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login / Public)
function getPublicAnnouncements() {
  const settings = getSheetData('Settings');
  // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Active = true
  return settings.filter(s => s.id && s.id.toString().startsWith('ANN-') && s.active === true);
}

// 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
function saveAnnouncementItem(data) {
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ID ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
  const id = data.id || `ANN-${new Date().getTime()}`;
  
  const payload = {
    ...data,
    id: id,
    updatedBy: data.updatedBy,
    timestamp: new Date().toLocaleString('th-TH')
  };
  
  saveDataToSheet('Settings', id, payload);
  return { success: true, message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', data: payload };
}

// 4. ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
function deleteAnnouncementItem(id) {
  deleteDataFromSheet('Settings', id);
  return { success: true, message: '‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß' };
}

// 5. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®)
function toggleAnnouncementStatus(id, isActive) {
  const settings = getSheetData('Settings');
  const target = settings.find(s => s.id === id);
  if (target) {
    target.active = isActive;
    saveDataToSheet('Settings', id, target);
    return { success: true, message: isActive ? '‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß' : '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß' };
  }
  return { success: false, message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' };
}

// --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå code.gs ---

function uploadUserSignature(base64Data, fileName) {
  try {
    const MAIN_FOLDER_ID = "1bLG6dp7SJVEMvDudKKZnoCpriUPrJyOU"; // ‡πÉ‡∏ä‡πâ ID ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏î‡∏¥‡∏°
    const SUB_FOLDER_NAME = "User_Signatures"; // ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
    const targetFolder = getOrCreateSubFolder(MAIN_FOLDER_ID, SUB_FOLDER_NAME);
    
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    
    const file = targetFolder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    return {
      name: fileName,
      url: file.getUrl(),
      id: file.getId()
    };
  } catch (e) {
    return { error: e.toString() };
  }
}


// --- NOTIFICATION SYSTEM (NEW) ---

// --- NOTIFICATION SYSTEM (UPDATED FOR ROLLBACK) ---

function handleStatusNotification(req) {
  const status = req.status;
  if (status === 'Draft') return;

  // 1. ‡∏´‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ (‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á Order)
  const requesterEmail = findUserEmail(req.requester);
  
  // 2. ‡∏´‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
  let nextActorEmails = [];
  if (status !== 'Pending Head' && status !== 'Pending PM') {
      const permId = getPermissionForStatus(req);
      if (permId) {
          const emailsStr = findApproverEmails(req.job, permId);
          if (emailsStr) nextActorEmails = emailsStr.split(',');
      }
  }

  // 3. ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ + ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏±‡πâ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)
  let recipients = [requesterEmail, ...nextActorEmails]
      .filter(email => email && email.includes('@'))
      .map(e => e.trim());
  recipients = [...new Set(recipients)];

  if (recipients.length === 0) return;

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
  let displayStatus = status;
  if (status === 'Pending Head') displayStatus = 'Pending Level 1';
  if (status === 'Pending PM') displayStatus = 'Pending Level 2';

  // ‚≠ê [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Rollback ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å Note ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
  let subjectPrefix = `[‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${displayStatus}]`;
  
  const lastLog = req.history && req.history.length > 0 ? req.history[req.history.length - 1] : null;
  // ‡∏ñ‡πâ‡∏≤ Note ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ Rollback ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏°‡∏•
  if (lastLog && lastLog.note && (lastLog.note.includes('Rollback') || lastLog.note.includes('‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö'))) {
      subjectPrefix = `[‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏¢‡πâ‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Rollback) ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ${displayStatus}]`;
  }

  // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á
  const subject = `${subjectPrefix} ${req.id} - ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${req.job}`;
  const body = createNotificationBody(req, displayStatus);

  recipients.forEach(email => {
      try {
          GmailApp.sendEmail(email, subject, '', { htmlBody: body });
          console.log(`[Notification] Sent to ${email}`);
      } catch (e) {
          console.error(`[Notification] Error: ${e.toString()}`);
      }
  });
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -> ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
function getPermissionForStatus(req) {
  switch (req.status) {
    case 'Pending Check': return 10; // ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö -> ‡∏ù‡πà‡∏≤‡∏¢ Verify (10)
    case 'Revise Needed': return null; // ‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -> ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°)
    
    // Approved -> ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    case 'Approved': 
        if (req.type === 'Local') return 12; // Local -> ‡∏£‡∏≠‡∏≠‡∏≠‡∏Å PO/‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (12)
        if (req.type === 'HO' && req.purchaseType === 'Buy') return 11; // HO Buy -> ‡∏£‡∏≠‡∏≠‡∏≠‡∏Å PR (11)
        if (req.type === 'HO' && req.purchaseType === 'Rent') return req.needContract !== false ? 14 : 13; // HO Rent -> ‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (14) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (13)
        return null;

    case 'PR Issued': return 12; // PR ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß -> ‡∏£‡∏≠‡∏≠‡∏≠‡∏Å PO (12)
    case 'PO Issued': return 13; // PO ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß -> ‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (13)
    case 'Ordered': return 15; // ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß -> ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (15)
    case 'Contract Pending': return 14; // ‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤ -> ‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (14)
    case 'Contract Signed': return 13; // ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß -> ‡∏£‡∏≠‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (13)
    case 'Shipping': return 15; // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á -> ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (15)
    case 'Partially Received': return 15; // ‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô -> ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏° (15)
    case 'Ready to Disburse': return 24; // ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢ -> Store (24)
    
    // ‡∏à‡∏ö‡∏á‡∏≤‡∏ô / ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á / ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô -> ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏Ñ‡πà‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ó‡∏£‡∏≤‡∏ö (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Action ‡∏ï‡πà‡∏≠)
    case 'Completed': return null; 
    case 'Returned': return null;
    case 'Rejected': return null;
    
    default: return null;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (requester string)
function findUserEmail(requesterStr) {
  if (!requesterStr) return null;
  const users = getSheetData('Users');
  
  // requesterStr ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô "First Last" ‡∏´‡∏£‡∏∑‡∏≠ "ID First Last"
  // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÅ‡∏ö‡∏ö Contains
  const user = users.find(u => {
      const fullName = `${u.firstName} ${u.lastName}`;
      const fullSig = `${u.empId} ${u.firstName} ${u.lastName}`;
      return requesterStr === fullName || requesterStr === fullSig || requesterStr.includes(u.email);
  });

  return user ? user.email : null;
}

function createNotificationBody(req, displayStatus) {
  const color = 
      req.status === 'Rejected' ? '#d32f2f' : 
      req.status === 'Completed' ? '#2e7d32' : 
      req.status.includes('Pending') ? '#f57c00' : '#1976d2';

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á displayStatus ‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
  if (!displayStatus) {
      displayStatus = req.status;
      if (req.status === 'Pending Head') displayStatus = 'Pending Level 1';
      if (req.status === 'Pending PM') displayStatus = 'Pending Level 2';
  }

  return `
    <div style="font-family: 'Sarabun', sans-serif; max-width: 600px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
        <div style="background-color: ${color}; color: white; padding: 15px;">
            <h2 style="margin: 0; font-size: 18px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h2>
        </div>
        <div style="padding: 20px;">
            <p>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á,</p>
            <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç <strong>${req.id}</strong> ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
            
            <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                <tr style="background-color: #f5f5f5;">
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd; color: ${color}; font-weight: bold;">${displayStatus}</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${req.job}</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${req.requester}</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${req.items[0].name} ${req.items.length > 1 ? `(‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${req.items.length - 1} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)` : ''}</td>
                </tr>
            </table>

            ${req.history && req.history.length > 0 ? `
            <p style="color: #666; font-size: 12px;">
                <strong>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÇ‡∏î‡∏¢:</strong> ${req.history[req.history.length - 1].user}<br/>
                <strong>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</strong> ${req.history[req.history.length - 1].note || '-'}
            </p>` : ''}
            
            <div style="text-align: center; margin-top: 20px;">
                <a href="${ScriptApp.getService().getUrl()}" style="background-color: #1976d2; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>
            </div>
        </div>
    </div>
  `;
}

// --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç Doc No. ‡πÉ‡∏ô Backend (‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå code.gs) ---

function getNextDocIndex(allRequests, type, purchaseType) {
  return allRequests.filter(r => {
    if (!r.docNumber) return false;
    if (r.type !== type) return false;
    if (type === 'HO') return r.purchaseType === purchaseType;
    return true;
  }).length;
}

function generateDocId(type, index, purchaseType) {
  const now = new Date();
  const timeZone = "GMT+7";
  const year = Utilities.formatDate(now, timeZone, "yy");
  const month = Utilities.formatDate(now, timeZone, "MM");
  const runNo = (index + 1).toString().padStart(3, '0');
  
  switch(type) {
      case 'Local': return `LPO-${year}${month}-${runNo}`;
      case 'HO': 
          return purchaseType === 'Rent' 
              ? `HRO-${year}${month}-${runNo}` 
              : `HPO-${year}${month}-${runNo}`;
      case 'Withdraw': return `WID-${year}${month}-${runNo}`;
      case 'Borrow': return `BOR-${year}${month}-${runNo}`;
      default: return `DOC-${year}${month}-${runNo}`;
  }
}


// --- BUDGET SUMMARY EMAIL TRIGGER ---

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Trigger ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡πÄ‡∏ß‡∏•‡∏≤ 09:00 ‡∏ô.
 * ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Run ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö
 */
function setupBudgetSummaryTrigger() {
  // ‡∏•‡∏ö Trigger ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥
  const triggers = ScriptApp.getProjectTriggers();
  for (let i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === 'sendWeeklyBudgetSummary') {
      ScriptApp.deleteTrigger(triggers[i]);
    }
  }
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Trigger ‡πÉ‡∏´‡∏°‡πà: ‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡πÄ‡∏ß‡∏•‡∏≤ 09:00
  ScriptApp.newTrigger('sendWeeklyBudgetSummary')
      .timeBased()
      .onWeekDay(ScriptApp.WeekDay.MONDAY)
      .atHour(9)
      .create();
      
  console.log("‚úÖ Budget Summary Trigger setup complete.");
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î Budget (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)
 */
function sendWeeklyBudgetSummary() {
  console.log("[BudgetSummary] Starting report generation...");
  
  const projects = getSheetData('Projects');
  const requests = getSheetData('Requests');
  const assets = getSheetData('Assets');
  const users = getSheetData('Users');

  if (!projects || projects.length === 0) {
    console.log("[BudgetSummary] No projects found.");
    return;
  }

  projects.forEach(proj => {
    // --- Step A: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô ---
    const subJobs = (proj.subJobs || []).map(s => ({ ...s, type: 'SubJob', used: 0, pending: 0 }));
    const matCodes = (proj.matCodes || []).map(e => ({ ...e, type: 'MatCode', used: 0, pending: 0 }));

    const calculateItemValue = (req, item) => {
        const isRent = req.type === 'HO' && req.purchaseType === 'Rent';
        const relatedAssets = assets.filter(a => a.currentRequestId === req.id && a.name === item.name);
        const receivedLogs = item.receivedLog || [];
        
        let val = 0;
        let cnt = 0;

        if (relatedAssets.length > 0) {
            val += relatedAssets.reduce((s, asset) => {
                const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                const duration = isRent ? (asset.duration || item.duration || 1) : 1;
                return s + (price * duration);
            }, 0);
            cnt = relatedAssets.length;
        } else if (receivedLogs.length > 0) {
            val += receivedLogs.reduce((s, log) => {
                const duration = isRent ? (log.duration || 1) : 1;
                return s + (log.qty * log.price * duration);
            }, 0);
            cnt = item.receivedTotal || 0;
        }

        if (req.status !== 'Completed') {
            const rem = Math.max(0, item.qty - cnt);
            const dur = isRent ? (item.duration || 1) : 1;
            val += (rem * (item.unitPrice || 0) * dur);
        }
        return val;
    };

    requests.forEach(req => {
        if (req.job !== proj.name) return;
        if (!['Local', 'HO'].includes(req.type)) return;
        
        const isCompleted = req.status === 'Completed';
        const isPending = !['Draft', 'Rejected', 'Returned', 'Completed'].includes(req.status);
        
        if (!isCompleted && !isPending) return;

        req.items.forEach(item => {
            const amount = calculateItemValue(req, item);
            if (item.subJob) {
                const target = subJobs.find(s => s.code === item.subJob);
                if (target) {
                    isCompleted ? target.used += amount : target.pending += amount;
                }
            }
            if (item.matCode) {
                const target = matCodes.find(e => e.code === item.matCode);
                if (target) {
                    isCompleted ? target.used += amount : target.pending += amount;
                }
            }
        });
    });

    // --- Step B: ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
    const groups = {};
    const processGroup = (list) => {
        list.forEach(item => {
            const gName = item.group || 'Others (‡∏≠‡∏∑‡πà‡∏ô‡πÜ)';
            const key = `${item.type}|${gName}`; 
            
            if (!groups[key]) {
                groups[key] = { 
                    key: key,
                    type: item.type,
                    name: gName, 
                    budget: 0, 
                    used: 0, 
                    pending: 0, 
                    items: [] 
                };
            }
            groups[key].budget += (item.budget || 0);
            groups[key].used += item.used;
            groups[key].pending += item.pending;
            groups[key].items.push(item);
        });
    };
    
    processGroup(subJobs);
    processGroup(matCodes);

    if (Object.keys(groups).length === 0) return;

    // --- Step C: ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ---
    let htmlContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <style>
          body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; padding: 20px; }
          .container { max-width: 800px; margin: 0 auto; background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
          .header { background-color: #1e3a8a; padding: 25px; color: white; text-align: center; }
          .header h1 { margin: 0; font-size: 22px; }
          .header h2 { margin: 5px 0 0; font-size: 18px; color: #bfdbfe; }
          
          .summary-box { background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
          .summary-header-sub { font-weight: bold; color: #1e40af; border-bottom: 2px solid #bfdbfe; padding-bottom: 8px; margin-bottom: 12px; font-size: 16px; display: flex; align-items: center; gap: 8px; }
          .summary-header-mat { font-weight: bold; color: #9a3412; border-bottom: 2px solid #fed7aa; padding-bottom: 8px; margin-bottom: 12px; font-size: 16px; display: flex; align-items: center; gap: 8px; margin-top: 20px; }
          .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; border-bottom: 1px dashed #f1f5f9; padding-bottom: 6px; }
          
          .group-section { margin-bottom: 25px; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
          .group-header { padding: 10px 15px; font-weight: bold; font-size: 15px; display: flex; justify-content: space-between; }
          
          .bg-sub { background-color: #eff6ff; color: #1e3a8a; border-left: 5px solid #2563eb; }
          .bg-mat { background-color: #fff7ed; color: #9a3412; border-left: 5px solid #f97316; }

          .budget-table { width: 100%; border-collapse: collapse; font-size: 12px; }
          .budget-table th { background-color: #f8fafc; color: #475569; text-align: right; padding: 8px; border-bottom: 1px solid #e2e8f0; }
          .budget-table th:first-child { text-align: left; }
          .budget-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: right; color: #334155; }
          .budget-table td:first-child { text-align: left; }
          
          .num { font-family: 'Courier New', monospace; font-weight: bold; }
          .text-red { color: #dc2626; }
          .text-green { color: #16a34a; }
          .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-right: 5px; }
          .badge-sub { background: #dbeafe; color: #1e40af; }
          .badge-mat { background: #ffedd5; color: #9a3412; }
          .text-sub { color: #1e40af; }
          .text-mat { color: #c2410c; }
          .footer { background-color: #f1f5f9; padding: 15px; text-align: center; font-size: 12px; color: #64748b; border-top: 1px solid #e2e8f0; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h1>
            <h2>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: ${proj.name}</h2>
            <p style="font-size: 12px; margin-top:5px; opacity: 0.8;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleString('th-TH')}</p>
          </div>
          <div style="padding: 20px;">
    `;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ (Summary Box) ---
    htmlContent += `<div class="summary-box">`;
    const sortedKeys = Object.keys(groups).sort();
    
    const renderSummaryRow = (gKey) => {
        const g = groups[gKey];
        // ‚≠ê ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á (Used) ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° Pending
        const totalUsed = g.used; 
        const remaining = g.budget - totalUsed;
        const pct = g.budget > 0 ? (totalUsed / g.budget) * 100 : 0;
        
        return `
            <div class="summary-row">
                <div style="font-weight:bold; color:#333;">${g.name}</div>
                <div style="text-align:right;">
                    <span style="color:#64748b; font-size:12px;">‡∏á‡∏ö: ${g.budget.toLocaleString()}</span> | 
                    <span style="color:#2563eb;">‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á: ${totalUsed.toLocaleString()}</span> | 
                    <span style="font-weight:bold; color:${remaining < 0 ? '#dc2626' : '#16a34a'};">‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${remaining.toLocaleString()}</span>
                    <span style="font-size:10px; background:#f1f5f9; padding:1px 4px; border-radius:3px; margin-left:5px; border:1px solid #e2e8f0;">${pct.toFixed(1)}%</span>
                </div>
            </div>
        `;
    };

    const subJobKeys = sortedKeys.filter(k => groups[k].type === 'SubJob');
    if (subJobKeys.length > 0) {
        htmlContent += `<div class="summary-header-sub">üèóÔ∏è ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á (SubJob)</div>`;
        subJobKeys.forEach(k => htmlContent += renderSummaryRow(k));
    }

    const matCodeKeys = sortedKeys.filter(k => groups[k].type === 'MatCode');
    if (matCodeKeys.length > 0) {
        htmlContent += `<div class="summary-header-mat">üß± ‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏±‡∏™‡∏î‡∏∏ (Mat. Code)</div>`;
        matCodeKeys.forEach(k => htmlContent += renderSummaryRow(k));
    }
    htmlContent += `</div>`;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Detailed Tables) ---
    const renderDetailTable = (gKey) => {
        const g = groups[gKey];
        const headerClass = g.type === 'SubJob' ? 'bg-sub' : 'bg-mat';
        
        let tableHtml = `
            <div class="group-section">
                <div class="group-header ${headerClass}">
                    <span>${g.name}</span>
                    <span style="font-size:12px; font-weight:normal; opacity:0.8;">‡∏á‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°: ${g.budget.toLocaleString()}</span>
                </div>
                <table class="budget-table">
                    <thead>
                        <tr>
                            <th width="40%">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Code)</th>
                            <th width="20%">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</th>
                            <th width="20%">‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á</th> <th width="20%">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        g.items.sort((a,b) => a.code.localeCompare(b.code)).forEach(item => {
            const budget = item.budget || 0;
            // ‚≠ê ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á (item.used)
            const totalUsed = item.used;
            const remaining = budget - totalUsed;
            
            const badgeClass = item.type === 'SubJob' ? 'badge-sub' : 'badge-mat';
            const textClass = item.type === 'SubJob' ? 'text-sub' : 'text-mat';
            const label = item.type === 'SubJob' ? 'Sub' : 'Mat';

            tableHtml += `
                <tr>
                    <td>
                        <span class="badge ${badgeClass}">${label}</span>
                        <strong class="${textClass}">${item.code}</strong><br/>
                        <span style="color:#94a3b8; font-size:10px;">${item.description || ''}</span>
                    </td>
                    <td class="num">${budget.toLocaleString()}</td>
                    <td class="num">${totalUsed.toLocaleString()}</td>
                    <td class="num ${remaining < 0 ? 'text-red' : 'text-green'}">${remaining.toLocaleString()}</td>
                </tr>
            `;
        });
        tableHtml += `</tbody></table></div>`;
        return tableHtml;
    };

    subJobKeys.forEach(k => htmlContent += renderDetailTable(k));
    matCodeKeys.forEach(k => htmlContent += renderDetailTable(k));

    htmlContent += `</div><div class="footer">‡∏£‡∏∞‡∏ö‡∏ö PurchaseHub System | ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div></div></body></html>`;

    // --- Step D: ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏• ---
    const targetPerms = [2, 3, 8, 9, 10];
    const recipientEmails = users.filter(u => {
        if (u.status !== 'Activated') return false;
        if (u.isSuperAdmin) return true;
        if (u.permissions && u.permissions[proj.name]) {
            return u.permissions[proj.name].some(p => targetPerms.includes(Number(p)));
        }
        return false;
    }).map(u => u.email).filter(e => e && e.includes('@'));

    const uniqueRecipients = [...new Set(recipientEmails)];

    if (uniqueRecipients.length > 0) {
        try {
            GmailApp.sendEmail(
                uniqueRecipients[0], 
                `[PurchaseHub] ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå: ${proj.name}`,
                "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö HTML", 
                { htmlBody: htmlContent, bcc: uniqueRecipients.slice(1).join(',') }
            );
            console.log(`[BudgetSummary] Sent for ${proj.name}`);
        } catch (e) { console.error(`Failed to send for ${proj.name}: ${e}`); }
    }
  });
  console.log("[BudgetSummary] Completed.");
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ID ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Logs) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ---
function updateLogItemId(oldId, newId) {
  console.log(`[UpdateLog] Changing ID from ${oldId} to ${newId}`);
  
  // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Logs ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏î‡∏∂‡∏á column id ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö)
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ callSupabase ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î
  const response = callSupabase('Logs', 'get', null, '?select=id,payload');
  
  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡∏Å‡∏£‡∏ì‡∏µ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
  let data;
  try {
    data = JSON.parse(response);
  } catch (e) {
    console.error("Error parsing logs:", e);
    return { success: false, message: 'Failed to parse logs' };
  }
  
  if (!Array.isArray(data)) return { success: false, message: 'No logs found or invalid data' };

  let count = 0;
  
  // 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤ Log ‡∏ó‡∏µ‡πà‡∏°‡∏µ assetId ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö oldId ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô newId
  data.forEach(row => {
    let log = row.payload;
    let changed = false;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Log ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    // (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏µ‡πà assetId ‡∏´‡∏£‡∏∑‡∏≠ itemId ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ)
    if (log.assetId === oldId) {
      log.assetId = newId;
      changed = true;
    }
    
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏á Database ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ saveDataToSheet ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    if (changed) {
      saveDataToSheet('Logs', row.id, log);
      count++;
    }
  });

  console.log(`[UpdateLog] Updated ${count} logs.`);
  return { success: true, count: count };
}


// --- ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° (Bulk Upsert) ---
function batchImportInventory(items, logs) {
  if (items && items.length > 0) {
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö record ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Supabase
    const records = items.map(item => ({
      id: item.id.toString(),
      payload: item
    }));
    
    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πâ‡∏≠‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏õ Upsert ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Bulk)
    const table = 'inventory';
    const url = `${SUPABASE_URL}/rest/v1/${table}`;
    const options = {
      method: 'post',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'resolution=merge-duplicates' // ‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤ ID ‡∏ã‡πâ‡∏≥
      },
      payload: JSON.stringify(records)
    };
    UrlFetchApp.fetch(url, options);
  }
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Logs ‡πÅ‡∏ö‡∏ö Bulk (‡∏ñ‡πâ‡∏≤ Supabase ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á Logs ‡πÅ‡∏ö‡∏ö JSON)
  if (logs && logs.length > 0) {
    const logRecords = logs.map(log => {
      if (!log.date) log.date = new Date().toLocaleString('th-TH');
      const logId = log.date + '_' + Math.floor(Math.random() * 1000);
      return { id: logId, payload: log };
    });
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å fetch ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á logs
  }
  
  return { success: true };
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß (Batch Save) ---
function batchImportInventory(items, logs) {
  // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  if (items && items.length > 0) {
    items.forEach(item => {
      try {
        syncInventory(item); 
      } catch (e) {
        console.error("Error saving item: " + item.id, e);
      }
    });
  }
  
  // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Logs (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°)
  if (logs && logs.length > 0) {
    logs.forEach(log => {
      try {
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
        if (!log.date) log.date = new Date().toLocaleString('th-TH');

        // ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà_‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°
        const logId = log.date + '_' + Math.floor(Math.random() * 1000);

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ ID ‡∏ô‡∏µ‡πâ
        saveDataToSheet('Logs', logId, log); 
      } catch (e) {
         console.error("Error saving log", e);
      }
    });
  }
  
  return { success: true };
}


// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° (Bulk Upsert) ---
function batchImportAssets(assets, logs) {
  // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Assets) ‡πÅ‡∏ö‡∏ö Bulk
  if (assets && assets.length > 0) {
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà Supabase ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ({ id, payload })
    const assetRecords = assets.map(asset => ({
      id: asset.id.toString(),
      payload: asset
    }));

    const url = `${SUPABASE_URL}/rest/v1/assets`;
    const options = {
      method: 'post',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'resolution=merge-duplicates' // ‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤ ID ‡∏ã‡πâ‡∏≥
      },
      payload: JSON.stringify(assetRecords)
    };

    try {
      const response = UrlFetchApp.fetch(url, options);
      if (response.getResponseCode() >= 400) {
        console.error("‚ùå Bulk Asset Error: " + response.getContentText());
        throw new Error("Failed to save assets: " + response.getContentText());
      }
    } catch (e) {
      console.error("‚ùå Bulk Asset Exception: " + e.toString());
      return { success: false, message: e.toString() };
    }
  }

  // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Logs) ‡πÅ‡∏ö‡∏ö Bulk
  if (logs && logs.length > 0) {
    const logRecords = logs.map(log => {
      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
      if (!log.date) log.date = new Date().toLocaleString('th-TH');
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á Log ID
      const logId = log.date + '_' + Math.floor(Math.random() * 10000) + '_' + Math.random().toString(36).substr(2, 5);

      return {
        id: logId,
        payload: log
      };
    });

    const logUrl = `${SUPABASE_URL}/rest/v1/logs`;
    const logOptions = {
      method: 'post',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'resolution=merge-duplicates'
      },
      payload: JSON.stringify(logRecords)
    };

    try {
      UrlFetchApp.fetch(logUrl, logOptions);
    } catch (e) {
      console.error("‚ùå Bulk Log Exception: " + e.toString());
      // Log error ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡πÉ‡∏´‡πâ process ‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏∞‡∏á‡∏±‡∏Å ‡∏à‡∏∂‡∏á‡πÅ‡∏Ñ‡πà console.error ‡πÑ‡∏ß‡πâ
    }
  }
  
  return { success: true };
}



// ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö Cascade (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á)
function updateProjectGlobalData(newProject, oldId, oldName) {
  console.log(`[UpdateProject] Renaming from ${oldName} (${oldId}) to ${newProject.name} (${newProject.id})`);

  // --- Helper: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏¥‡∏à (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error) ---
  const getTableData = (table) => {
    const res = callSupabase(table, 'get', null, '?select=id,payload');
    try {
      const data = JSON.parse(res);
      return Array.isArray(data) ? data : [];
    } catch (e) {
      return [];
    }
  };
  // ----------------------------------------------------

  // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (Upsert)
  saveDataToSheet('Projects', newProject.id, newProject);

  // 2. ‡∏ñ‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (ID) ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô -> ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á
  if (oldId && oldId !== newProject.id) {
    deleteDataFromSheet('Projects', oldId);
  }

  // 3. ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô -> ‡πÑ‡∏•‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ
  if (oldName && oldName !== newProject.name) {
     
     // A. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Requests (‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)
     const requests = getTableData('Requests');
     requests.forEach(row => {
        let req = row.payload;
        if (req.job === oldName) {
           req.job = newProject.name;
           saveDataToSheet('Requests', row.id, req);
        }
     });

     // B. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Inventory (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
     const inventory = getTableData('Inventory');
     inventory.forEach(row => {
        let inv = row.payload;
        if (inv.project === oldName) {
           inv.project = newProject.name;
           saveDataToSheet('Inventory', row.id, inv);
        }
     });

     // C. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Assets (‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô)
     const assets = getTableData('Assets');
     assets.forEach(row => {
        let ast = row.payload;
        if (ast.project === oldName) {
           ast.project = newProject.name;
           saveDataToSheet('Assets', row.id, ast);
        }
     });

     // D. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Users (‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
     const users = getTableData('Users');
     users.forEach(row => {
        let u = row.payload;
        if (u.permissions && u.permissions[oldName]) {
           // ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏õ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
           u.permissions[newProject.name] = u.permissions[oldName];
           // ‡∏•‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤
           delete u.permissions[oldName];
           saveDataToSheet('Users', row.id, u);
        }
     });
  }
  
  return { success: true, message: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡∏°‡∏µ‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö)' };
}


// --- [Code.gs] ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Prevent Duplicate Doc No) ---

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß (Lock)
 * ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ saveRequestToSheet ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
 */

// ... existing code ...
function updateStatusSecurely(id, newStatus, logObj, extraUpdates = {}) {
  // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å (‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏î‡πâ‡∏ô‡∏≤‡∏ô‡∏™‡∏∏‡∏î 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(15000); 
  } catch (e) {
    return { success: false, message: '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (Server Busy)' };
  }

  try {
    // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Database
    var requests = getSheetData('Requests');
    var index = requests.findIndex(function(r) { return r.id === id; });
    if (index === -1) return { success: false, message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' };
    
    var req = requests[index];

    // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)
    req.status = newStatus;

    // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (Flag) ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    var shouldGenNewDoc = false;

    if (extraUpdates) {
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á docNumber: null ‡∏°‡∏≤ 
      if (extraUpdates.hasOwnProperty('docNumber') && extraUpdates.docNumber === null) {
          req.docNumber = null; // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏¥‡∏°
          shouldGenNewDoc = true; // ‚úÖ ‡∏à‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ß‡πâ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
          
          delete extraUpdates.docNumber; // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ loop ‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤ null ‡∏°‡∏≤‡∏ó‡∏±‡∏ö
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏ä‡πà‡∏ô type: 'HO')
      Object.keys(extraUpdates).forEach(function(key) {
        req[key] = extraUpdates[key];
      });
    }

    // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (History)
    if (!req.history) req.history = [];
    if (!logObj.date) logObj.date = new Date().toLocaleString('th-TH');
    req.history.push(logObj);

    // 5. Generate Doc ID Logic
    if (!req.docNumber) {
        var isBuyReady = ['Local', 'HO'].includes(req.type) && 
            ['Approved', 'Revise Needed', 'Ordered', 'PR Issued', 'PO Issued', 'Contract Pending', 'Contract Signed', 'Shipping', 'Completed'].includes(newStatus);
        
        var isUseReady = ['Withdraw', 'Borrow'].includes(req.type) && 
            ['Ready to Disburse', 'Completed', 'Returned'].includes(newStatus);
        
        // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ shouldGenNewDoc ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å extraUpdates ‡∏ã‡πâ‡∏≥
        var isForceGen = shouldGenNewDoc;

        if (isBuyReady || isUseReady || isForceGen) {
            // ‡∏ô‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            var count = getNextDocIndex(requests, req.type, req.purchaseType);
            var newDocId = generateDocId(req.type, count, req.purchaseType);
            
            req.docNumber = newDocId; 
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Log ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡πâ‡∏ß
            if (req.history.length > 0) {
                req.history[req.history.length - 1].note += ' (New Doc No: ' + newDocId + ')';
            }
        }
    }

    // 6. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Supabase
    saveDataToSheet('Requests', req.id, req);

    // 7. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡πÅ‡∏¢‡∏Å Logic ‡∏°‡∏≤‡∏à‡∏≤‡∏Å syncRequest ‡πÄ‡∏î‡∏¥‡∏°)
    /* üî¥ [STOPPED] ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô Update Status ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß 
       (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏°‡∏•‡∏£‡∏ö‡∏Å‡∏ß‡∏ô)
    try {
        triggerEmails(req); // ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        handleStatusNotification(req); // ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    } catch (err) {
        console.error("Email Error: " + err);
    }
    */

    return { success: true, request: req };

  } catch (e) {
    return { success: false, message: 'Error: ' + e.toString() };
  } finally {
    // 8. ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
    lock.releaseLock();
  }
}
// ... existing code ...

// Helper: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å)
function triggerEmails(request) {
  if (request.status === 'Pending Head') {
      if (request.type === 'Withdraw' || request.type === 'Borrow') {
          var headEmails = findApproverEmails(request.job, 8);
          var pmEmails = findApproverEmails(request.job, 9);
          var recipients = [];
          if (headEmails) recipients.push(headEmails);
          if (pmEmails) recipients.push(pmEmails);
          if (recipients.length > 0) {
              sendApprovalEmail(request, recipients.join(','), 'Approver'); 
          }
      } else {
          var headEmails = findApproverEmails(request.job, 8);
          if (headEmails) sendApprovalEmail(request, headEmails, 'Head');
      }
  }
  else if (request.status === 'Pending PM') {
      var pmEmails = findApproverEmails(request.job, 9);
      if (pmEmails) sendApprovalEmail(request, pmEmails, 'PM');
  } 
}


function processStockAudit(adjustments, userBy) {
  // adjustments = Array ‡∏Ç‡∏≠‡∏á { id, name, oldQty, newQty, reason, project }
  
  if (!adjustments || adjustments.length === 0) return { success: true, message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á' };

  // 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Bulk Upsert Inventory
  // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á (Diff)
  const inventoryUpdates = adjustments.map(item => {
    // ‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤ merge ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ field ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡πÅ‡∏ï‡πà Supabase upsert ‡∏õ‡∏Å‡∏ï‡∏¥‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ patch)
    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏ó‡∏±‡∏ö‡πÄ‡∏•‡∏¢ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ ID ‡πÄ‡∏î‡∏¥‡∏°
    return {
      id: item.id,
      // ‡∏£‡∏∞‡∏ß‡∏±‡∏á: ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ item ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏°‡∏µ field ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô
      // ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏î‡∏µ ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á object inventory ‡∏ï‡∏±‡∏ß‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ qty ‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤
      payload: item.fullObject 
    };
  });

  // 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Logs
  const logRecords = adjustments.map(item => {
    const diff = item.newQty - item.oldQty;
    const sign = diff > 0 ? '+' : '';
    
    return {
      id: `LOG-AUDIT-${new Date().getTime()}-${Math.floor(Math.random()*1000)}`,
      payload: {
        date: new Date().toLocaleString('th-TH'),
        action: 'Audit Adjust', // Action ‡∏û‡∏¥‡πÄ‡∏®‡∏©
        item: item.name,
        change: `${sign}${diff}`, // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á ‡πÄ‡∏ä‡πà‡∏ô -5 ‡∏´‡∏£‡∏∑‡∏≠ +2
        note: `‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${item.reason}`,
        by: userBy,
        project: item.project,
        assetId: item.id // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      }
    };
  });

  // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Supabase (‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Batch Import)
  // 3.1 Update Inventory
  const urlInv = `${SUPABASE_URL}/rest/v1/inventory`;
  const optInv = {
    method: 'post',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'resolution=merge-duplicates'
    },
    payload: JSON.stringify(inventoryUpdates)
  };
  
  // 3.2 Insert Logs
  const urlLog = `${SUPABASE_URL}/rest/v1/logs`;
  const optLog = {
    method: 'post',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'resolution=merge-duplicates'
    },
    payload: JSON.stringify(logRecords)
  };

  try {
    UrlFetchApp.fetch(urlInv, optInv);
    UrlFetchApp.fetch(urlLog, optLog);
    return { success: true, count: adjustments.length };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}


// --- [Code.gs] SERVER-SIDE PERMISSION CHECK ---

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö Logic ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)
function validateServerPermission(userId, requiredPermId, targetProject) {
  // A. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Supabase
  const users = getSheetData('Users');
  const user = users.find(u => u.id === userId || u.username === userId);

  if (!user) throw new Error("‚õî Access Denied: User not found.");
  if (user.status !== 'Activated') throw new Error("‚õî Access Denied: Account inactive.");
  
  // B. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Super Admin ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏¢
  if (user.isSuperAdmin) return true;

  // C. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
  // ‡∏ñ‡πâ‡∏≤ targetProject ‡πÄ‡∏õ‡πá‡∏ô null ‡∏´‡∏£‡∏∑‡∏≠ 'All' ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô "‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£" ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô Global Check
  // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ö‡∏∏ Project ‡πÄ‡∏™‡∏°‡∏≠‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡πÑ‡∏î‡πâ
  
  // ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Global Action) -> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Project ‡πÉ‡∏î Project ‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÑ‡∏´‡∏°
  if (!targetProject || targetProject === 'All') {
      const hasPerm = Object.values(user.permissions || {}).some(perms => 
          perms.includes(2) || perms.includes(requiredPermId)
      );
      if (hasPerm) return true;
  } 
  // ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
  else {
      const userPerms = user.permissions?.[targetProject] || [];
      
      // - ‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ô‡∏µ‡πâ (2)
      if (userPerms.includes(2)) return true;

      // - ‡πÄ‡∏õ‡πá‡∏ô Sub-Admin (3) -> ‡πÑ‡∏î‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (4,5,6,7)
      if (userPerms.includes(3) && [4, 5, 6, 7].includes(requiredPermId)) return true;

      // - ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á
      if (userPerms.includes(requiredPermId)) return true;
  }

  // ‡∏ñ‡πâ‡∏≤‡∏´‡∏•‡∏∏‡∏î‡∏ó‡∏∏‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç -> ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
  throw new Error(`‚õî Permission Denied: ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ (${requiredPermId}) ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${targetProject || 'Any'}`);
}

// 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Secure Delete)
// ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô deleteDataFromSheet ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
function deleteItemSecure(userId, tableName, id, project) {
  // ‡πÅ‡∏õ‡∏•‡∏á Table Name ‡πÄ‡∏õ‡πá‡∏ô Permission ID ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ
  let requiredPerm = 0;
  if (tableName === 'Inventory') requiredPerm = 18; // ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  else if (tableName === 'Assets') requiredPerm = 21; // ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô
  else if (tableName === 'Projects') requiredPerm = 26; // ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£

  if (requiredPerm === 0) throw new Error("Unknown table type");

  // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö
  validateServerPermission(userId, requiredPerm, project);

  // ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô -> ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
  deleteDataFromSheet(tableName, id);
  return { success: true };
}


function checkMailQuota() {
  var remaining = MailApp.getRemainingDailyQuota();
  Logger.log("‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å: " + remaining + " ‡∏â‡∏ö‡∏±‡∏ö‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ");
}


function createRequestSecurely(reqData) {
  var lock = LockService.getScriptLock();
  try {
    // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡πá‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏î‡πâ‡∏ô‡∏≤‡∏ô‡∏™‡∏∏‡∏î 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
    lock.waitLock(30000); 
    
    // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Requests ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Database (Refresh ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á)
    var allRequests = getSheetData('Requests');
    
    // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤ ID ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (REQ-xxx) ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    var existingIds = allRequests
        .map(function(r) { return r.id; })
        .filter(function(id) { return id && typeof id === 'string' && id.startsWith('REQ-'); });

    var maxNum = 0;
    if (existingIds.length > 0) {
        maxNum = existingIds.reduce(function(max, id) {
            var numPart = parseInt(id.replace(/^REQ-/, ''), 10);
            return !isNaN(numPart) && numPart > max ? numPart : max;
        }, 0);
    }
    
    var nextId = 'REQ-' + String(maxNum + 1).padStart(3, '0');
    
    // 4. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î ID ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    reqData.id = nextId;
    
    // 5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Database
    saveDataToSheet('Requests', nextId, reqData);
    
    // 6. ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Draft)
    // (‡πÉ‡∏ä‡πâ try-catch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Error ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏°‡∏•‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß)
    if (reqData.status !== 'Draft') {
        try {
            triggerEmails(reqData);        // ‡∏™‡πà‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            handleStatusNotification(reqData); // ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏Ç‡∏≠
        } catch (emailErr) {
            console.error("Email Error: " + emailErr);
        }
    }
    
    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏û‡∏£‡πâ‡∏≠‡∏° ID ‡πÉ‡∏´‡∏°‡πà) ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ Frontend
    return { success: true, request: reqData };
    
  } catch (e) {
    return { success: false, message: 'Create Request Error: ' + e.toString() };
  } finally {
    // 7. ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏°‡∏≠
    lock.releaseLock();
  }
}

function forceAuth() {
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏à‡∏£‡∏¥‡∏á)
  DriveApp.getRootFolder(); 
  MailApp.getRemainingDailyQuota();
  console.log("Authorization Complete!");
}

// --- DAILY SUMMARY TRIGGER ---

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Trigger (‡∏Å‡∏î Run ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
function setupDailySummaryTrigger() {
  // ‡∏•‡∏ö Trigger ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥
  const triggers = ScriptApp.getProjectTriggers();
  for (let i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === 'sendDailyPendingSummary') {
      ScriptApp.deleteTrigger(triggers[i]);
    }
  }
  
  // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡πÄ‡∏ß‡∏•‡∏≤ 08:00 ‡∏ô.
  ScriptApp.newTrigger('sendDailyPendingSummary')
      .timeBased()
      .everyDays(1)
      .atHour(8)
      .create();
  console.log("‚úÖ Daily Summary Trigger setup complete (08:00 AM daily).");
}

function sendDailyPendingSummary() {
  console.log("[DailySummary] Starting...");
  
  const requests = getSheetData('Requests');
  const users = getSheetData('Users');
  
  // 1. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ User ‡∏ó‡∏µ‡πà Active ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Level 1=8, Level 2=9) 
  // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏±‡∏î p.includes(2) ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á Admin ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå
  const approvers = users.filter(u => 
    u.status === 'Activated' && u.email && u.email.includes('@') &&
    (u.isSuperAdmin || (u.permissions && Object.values(u.permissions).some(p => p.includes(8) || p.includes(9))))
  );

  if (approvers.length === 0) return;

  // 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤ User ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
  approvers.forEach(user => {
    let pendingList = [];

    // ‡∏Å‡∏£‡∏≠‡∏á Request ‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô Pending Head ‡∏´‡∏£‡∏∑‡∏≠ Pending PM
    const activeReqs = requests.filter(r => r.status === 'Pending Head' || r.status === 'Pending PM');

    activeReqs.forEach(req => {
      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ß‡πà‡∏≤ User ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°
      let canApprove = false;
      let roleForAction = '';

      // ‡πÄ‡∏ä‡πá‡∏Ñ Project Permission ‡∏Ç‡∏≠‡∏á User ‡∏ô‡∏µ‡πâ
      const userPerms = user.isSuperAdmin ? [2, 8, 9] : (user.permissions?.[req.job] || []);
      
      // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏±‡∏î userPerms.includes(2) ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå L1/L2
      const isL1 = userPerms.includes(8); 
      const isL2 = userPerms.includes(9); 

      // Logic ‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏•‡πâ‡∏≠‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)
      if (req.status === 'Pending Head') {
          // ‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏°: ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á L1 ‡πÅ‡∏•‡∏∞ L2
          if ((req.type === 'Withdraw' || req.type === 'Borrow') && (isL1 || isL2)) {
              canApprove = true;
              roleForAction = 'Approver'; // Role ‡∏Å‡∏•‡∏≤‡∏á
          } 
          // ‡∏ã‡∏∑‡πâ‡∏≠: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ L1
          else if (['Local', 'HO'].includes(req.type) && isL1) {
              canApprove = true;
              roleForAction = 'Head';
          }
      } 
      else if (req.status === 'Pending PM') {
          // Level 2 (PM) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
          if (isL2) {
              canApprove = true;
              roleForAction = 'PM';
          }
      }

      if (canApprove) {
        pendingList.push({ ...req, roleForAction });
      }
    });

    // 3. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•
    if (pendingList.length > 0) {
      try {
        sendSummaryEmailToUser(user, pendingList);
        console.log(`[DailySummary] Sent to ${user.email} (${pendingList.length} items)`);
      } catch (e) {
        console.error(`[DailySummary] Failed to send to ${user.email}: ${e}`);
      }
    }
  });
  console.log("[DailySummary] Finished.");
}


function sendSummaryEmailToUser(user, items) {
  const scriptUrl = ScriptApp.getService().getUrl();
  const approverEmail = user.email;
  
  // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏° ID ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Bulk
  const allIds = items.map(i => i.id).join(',');
  
  const bulkApproveLink = `${scriptUrl}?action=bulk_approve&ids=${allIds}&approver=${approverEmail}&role=Batch`;
  const bulkRejectLink = `${scriptUrl}?action=bulk_reject&ids=${allIds}&approver=${approverEmail}&role=Batch`;

  let tableRows = '';
  
  // ‚≠ê [‡πÄ‡∏û‡∏¥‡πà‡∏° Helper] ‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
  const getRentalUnitTh = (unit) => {
      if(unit === 'Day') return '‡∏ß‡∏±‡∏ô';
      if(unit === 'Month') return '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
      if(unit === 'Year') return '‡∏õ‡∏µ';
      return unit || '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'; // Default
  };
  
  items.forEach((req, idx) => {
    // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß
    const approveLink = `${scriptUrl}?action=approve&id=${req.id}&role=${req.roleForAction}&approver=${approverEmail}`;
    const rejectLink = `${scriptUrl}?action=reject&id=${req.id}&role=${req.roleForAction}&approver=${approverEmail}`;
    
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Inner Table) ---
    let itemsDetailHtml = `
      <table style="width: 100%; border-collapse: collapse; font-size: 12px; background-color: #ffffff; border: 1px solid #eee; margin-top: 5px;">
        <tr style="background-color: #f9f9f9; color: #666; border-bottom: 1px solid #eee;">
          <th style="padding: 4px; text-align: left;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
          <th style="padding: 4px; text-align: center; width: 50px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th style="padding: 4px; text-align: right; width: 70px;">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <th style="padding: 4px; text-align: right; width: 70px;">‡∏£‡∏ß‡∏°</th>
        </tr>
    `;

    let reqGrandTotal = 0;

    req.items.forEach(item => {
        // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ä‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const isRent = req.type === 'HO' && req.purchaseType === 'Rent';
        const duration = isRent ? (item.duration || 1) : 1;
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°
        const lineTotal = (item.qty || 0) * (item.unitPrice || 0) * duration;
        reqGrandTotal += lineTotal;
        
        // ‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
        const rentalUnitTh = getRentalUnitTh(item.rentalUnit);

        itemsDetailHtml += `
          <tr style="border-bottom: 1px dashed #eee;">
            <td style="padding: 4px; color: #333;">
               ${item.name}
               ${item.subJob ? `<br/><span style="font-size:10px; color:#1565c0; background:#e3f2fd; padding:1px 3px; border-radius:2px;">Sub: ${item.subJob}</span>` : ''}
               ${item.matCode ? `<br/><span style="font-size:10px; color:#7b1fa2; background:#f3e5f5; padding:1px 3px; border-radius:2px;">Mat: ${item.matCode}</span>` : ''}
            </td>
            <td style="padding: 4px; text-align: center; white-space: nowrap;">
                ${item.qty} ${item.unit}
                ${/* ‚≠ê ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πà‡∏≤ */ ''}
                ${isRent ? `<div style="font-size:10px; color:blue;">x ${duration} ${rentalUnitTh}</div>` : ''}
            </td>
            <td style="padding: 4px; text-align: right;">
                ${/* ‚≠ê ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏ß‡∏•‡∏≤ */ ''}
                ${(item.unitPrice || 0).toLocaleString()} ${isRent ? '/' + rentalUnitTh : ''}
            </td>
            <td style="padding: 4px; text-align: right; font-weight: bold;">${lineTotal.toLocaleString()}</td>
          </tr>
        `;
    });
    itemsDetailHtml += `</table>`;
    // ----------------------------------------------------

    const statusLabel = req.status === 'Pending Head' ? 'Level 1' : 'Level 2';
    
    // ‚≠ê ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Type) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    let displayType = req.type;
    if (req.type === 'HO') {
        displayType = req.purchaseType === 'Rent' ? 'HO (‡πÄ‡∏ä‡πà‡∏≤)' : 'HO (‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏î)';
    } else if (req.type === 'Local') {
        displayType = 'Local (‡∏ã‡∏∑‡πâ‡∏≠)';
    }

    tableRows += `
      <tr style="border-bottom: 2px solid #e0e0e0; background-color: #fff;">
        <td style="padding: 12px; vertical-align: top; width: 15%;">
            <div style="font-weight:bold; color:#1976d2; font-size:14px;">${req.id}</div>
            
            ${/* ‚≠ê ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ displayType ‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß */ ''}
            <div style="font-size:11px; color:#666; margin-bottom:4px;">${displayType}</div>
            
            <div style="font-size:10px; background:#f5f5f5; padding:2px 6px; border-radius:4px; display:inline-block; border:1px solid #ddd;">${statusLabel}</div>
        </td>
        <td style="padding: 12px; vertical-align: top; width: 20%;">
            <div style="font-weight:bold; font-size:13px;">${req.job}</div>
            <div style="font-size:12px; color:#444; margin-top:4px;">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: ${req.requester}</div>
            <div style="font-size:11px; color:#e65100; margin-top:4px;">Due: ${req.dateRequired}</div>
        </td>
        <td style="padding: 12px; vertical-align: top; width: 50%;">
            ${itemsDetailHtml}
            <div style="text-align: right; font-size: 13px; font-weight: bold; color: #1565c0; margin-top: 5px;">
               ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${reqGrandTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó
            </div>
        </td>
        <td style="padding: 12px; text-align: center; vertical-align: middle; width: 15%;">
            <a href="${approveLink}" style="display:block; text-decoration:none; background:#2e7d32; color:white; padding:6px 10px; border-radius:4px; font-size:12px; font-weight:bold; margin-bottom:6px;">
               ‚úì ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            </a>
            <a href="${rejectLink}" style="display:block; text-decoration:none; background:#c62828; color:white; padding:6px 10px; border-radius:4px; font-size:12px; font-weight:bold;">
               ‚úï ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô
            </a>
        </td>
      </tr>
    `;
  });

  const htmlBody = `
    <!DOCTYPE html>
    <html>
    <body style="font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; padding: 20px;">
      <div style="max-width: 900px; margin: 0 auto; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        
        <div style="background-color: #1976d2; padding: 20px; color: white; text-align: center;">
          <h2 style="margin: 0; font-size: 24px;">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>
          <p style="margin: 5px 0 0; opacity: 0.9;">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì ${user.firstName} ${user.lastName}</p>
        </div>
        
        <div style="padding: 20px;">
          <p>‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ó‡πà‡∏≤‡∏ô ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <strong>${items.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
          
          <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 25px;">
            <thead style="background-color: #eceff1; color: #37474f; font-weight: bold;">
              <tr>
                <th style="padding: 10px; text-align: left;">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                <th style="padding: 10px; text-align: left;">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
                <th style="padding: 10px; text-align: left;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th style="padding: 10px; text-align: center;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
          </table>

          <div style="background-color: #e3f2fd; padding: 20px; border-radius: 8px; text-align: center; border: 1px dashed #90caf9;">
            <p style="margin: 0 0 15px 0; font-weight: bold; color: #0d47a1; font-size: 16px;">‚ö° ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</p>
            
            <a href="${bulkApproveLink}" style="display:inline-block; text-decoration:none; background:#1565c0; color:white; padding:12px 30px; border-radius:6px; font-weight:bold; margin: 0 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
               ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Approve All)
            </a>
            
            <a href="${bulkRejectLink}" style="display:inline-block; text-decoration:none; background:#b71c1c; color:white; padding:12px 30px; border-radius:6px; font-weight:bold; margin: 0 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
               ‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Reject All)
            </a>
          </div>

          <div style="text-align: center; margin-top: 25px; border-top: 1px solid #eee; padding-top: 20px;">
            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥?</p>
            <a href="${scriptUrl}" target="_blank" style="display:inline-block; text-decoration:none; background:#455a64; color:white; padding:10px 25px; border-radius:50px; font-weight:bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Open Web App)
            </a>
          </div>
          
          <div style="margin-top: 30px; text-align: center; font-size: 11px; color: #999;">
             <p>‡∏£‡∏∞‡∏ö‡∏ö PurchaseHub System | ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
          </div>
        </div>
      </div>
    </body>
    </html>
  `;

  GmailApp.sendEmail(approverEmail, `[PurchaseHub] ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`, '', { htmlBody: htmlBody });
}

function createBulkRejectForm(e) {
  const ids = e.parameter.ids;
  const approver = e.parameter.approver;
  const scriptUrl = ScriptApp.getService().getUrl();

  const html = `
    <!DOCTYPE html>
    <html>
      <head>
        <base target="_top">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; display: flex; justify-content: center; padding-top: 50px; }
          .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 90%; max-width: 400px; }
          h2 { color: #d93025; margin-top: 0; }
          textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin: 15px 0; font-family: inherit; }
          button { background-color: #d93025; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; }
          button:hover { background-color: #b02015; }
        </style>
      </head>
      <body>
        <div class="card">
          <h2>‚ùå ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
          <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: <strong>${ids.split(',').length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong></p>
          <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏£‡∏ß‡∏° (Common Reason):</p>
          <form id="rejectForm">
            <textarea id="reason" rows="4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥..." required></textarea>
            <button type="submit">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (Confirm Reject All)</button>
          </form>
          <script>
            document.getElementById('rejectForm').onsubmit = function(e) {
              e.preventDefault();
              var reason = document.getElementById('reason').value;
              var btn = document.querySelector('button');
              btn.disabled = true;
              btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
              var finalUrl = "${scriptUrl}?action=confirm_bulk_reject" + 
                             "&ids=${ids}" + 
                             "&approver=${approver}" + 
                             "&role=Batch" +
                             "&note=" + encodeURIComponent(reason);
              window.top.location.href = finalUrl;
            };
          </script>
        </div>
      </body>
    </html>
  `;
  return HtmlService.createHtmlOutput(html);
}


/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Rollback ‡∏£‡∏∞‡∏î‡∏±‡∏ö Super Admin (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Encode URL Parameter)
 */
function processSuperAdminRollback(requestId, targetStatus, reason, adminInfo) {
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(30000);

    // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    var requests = getSheetData('Requests');
    var inventory = getSheetData('Inventory');
    var assets = getSheetData('Assets');
    
    // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà Error] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ->> ‡πÄ‡∏õ‡πá‡∏ô -%3E%3E ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ UrlFetchApp ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
    // ‡πÄ‡∏î‡∏¥‡∏°: var relatedLogs = getSheetData('Logs', '&payload->>relatedRequestId=eq.' + requestId);
    var relatedLogs = getSheetData('Logs', '&payload-%3E%3ErelatedRequestId=eq.' + requestId);

    var reqIndex = requests.findIndex(function(r) { return r.id === requestId; });
    if (reqIndex === -1) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ID: " + requestId);
    var req = requests[reqIndex];

    var logsToSave = [];
    var inventoryUpdates = new Map(); 
    var assetsToUpdate = new Map();
    var assetsToDelete = new Set(); 

    var dateStr = new Date().toLocaleString('th-TH');

    // -------------------------------------------------------------------------
    // 2. üîÑ PROCESS ROLLBACK BASED ON LOGS
    // -------------------------------------------------------------------------
    
    if (relatedLogs && relatedLogs.length > 0) {
      relatedLogs.forEach(function(log) {
        // ‡∏Ç‡πâ‡∏≤‡∏° Log ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å Revert ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
        if (log.action.includes('(Reverted)')) return;

        // --- A. ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ (Stock In) -> ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡∏Å ---
        if (log.action.includes('Stock In') && log.assetId) {
           var qty = 0;
           if (log.change.includes('+')) qty = parseInt(log.change.replace('+', ''));
           else if (log.change.includes('Start:')) qty = parseInt(log.change.split(':')[1]);
           
           if (qty > 0) {
               var inv = inventory.find(function(i) { return i.id === log.assetId; });
               if (inv) {
                   var currentInv = inventoryUpdates.get(inv.id) || JSON.parse(JSON.stringify(inv));
                   currentInv.qty = Math.max(0, currentInv.qty - qty);
                   currentInv.lastUpdated = dateStr;
                   inventoryUpdates.set(inv.id, currentInv);

                   logsToSave.push({
                       date: dateStr, action: 'Rollback (Deduct)', item: inv.name, change: '-' + qty,
                       note: 'Rollback: ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô (Ref Log: ' + log.date + ')',
                       by: adminInfo, relatedRequestId: requestId, assetId: inv.id
                   });
               }
           }
        }

        // --- B. ‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Register Asset) -> ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á ---
        else if ((log.action.includes('Register Asset') || log.action.includes('Add Asset')) && log.assetId) {
            if (log.relatedRequestId === requestId) {
                assetsToDelete.add(log.assetId);
            }
        }

        // --- C. ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å (Withdraw) -> ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ ---
        else if (log.action.includes('Withdraw') && log.assetId) {
            var qty = 0;
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÄ‡∏ä‡πà‡∏ô "-5"
            if (log.change.includes('-')) qty = Math.abs(parseInt(log.change));
            
            if (qty > 0) {
               var inv = inventory.find(function(i) { return i.id === log.assetId; });
               if (inv) {
                   var currentInv = inventoryUpdates.get(inv.id) || JSON.parse(JSON.stringify(inv));
                   currentInv.qty += qty;
                   currentInv.lastUpdated = dateStr;
                   inventoryUpdates.set(inv.id, currentInv);

                   logsToSave.push({
                       date: dateStr, action: 'Rollback (Return)', item: inv.name, change: '+' + qty,
                       note: 'Rollback: ‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏•‡∏±‡∏á (Ref Log: ' + log.date + ')',
                       by: adminInfo, relatedRequestId: requestId, assetId: inv.id
                   });
               }
            }
        }
      });
    }

    // -------------------------------------------------------------------------
    // 3. üßπ FALLBACK CLEANUP (‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏Å)
    // -------------------------------------------------------------------------
    
    // Fallback: ‡∏•‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö Request ‡∏ô‡∏µ‡πâ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Log ‡∏´‡∏≤‡∏¢)
    if (['Local', 'HO'].includes(req.type)) {
        var linkedAssets = assets.filter(function(a) { return a.currentRequestId === req.id; });
        linkedAssets.forEach(function(asset) {
            if (!assetsToDelete.has(asset.id)) {
                assetsToDelete.add(asset.id);
            }
        });
    }

    // Fallback: ‡∏õ‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° (Borrow)
    if (req.type === 'Borrow') {
        var borrowedAssets = assets.filter(function(a) { return a.currentRequestId === req.id && a.status === 'Borrowed'; });
        borrowedAssets.forEach(function(asset) {
            if (!assetsToUpdate.has(asset.id)) {
                var updatedAsset = JSON.parse(JSON.stringify(asset));
                updatedAsset.status = 'Available';
                updatedAsset.holder = '-';
                updatedAsset.currentRequestId = null;
                updatedAsset.lastUpdated = dateStr;
                assetsToUpdate.set(asset.id, updatedAsset);

                logsToSave.push({
                    date: dateStr, action: 'Rollback (Free)', item: asset.name, change: 'Status: Available',
                    note: 'Rollback: ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°',
                    by: adminInfo, relatedRequestId: requestId, assetId: asset.id
                });
            }
        });
    }

    // -------------------------------------------------------------------------
    // 4. üíæ SAVE CHANGES
    // -------------------------------------------------------------------------

    // 4.1 Update Inventory
    if (inventoryUpdates.size > 0) {
        var invRecords = [];
        inventoryUpdates.forEach(function(value) { invRecords.push({ id: value.id, payload: value }); });
        var urlInv = SUPABASE_URL + '/rest/v1/inventory';
        var optInv = {
            method: 'post', headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
            payload: JSON.stringify(invRecords)
        };
        UrlFetchApp.fetch(urlInv, optInv);
    }

    // 4.2 Update Assets
    if (assetsToUpdate.size > 0) {
        var astRecords = [];
        assetsToUpdate.forEach(function(value) { astRecords.push({ id: value.id, payload: value }); });
        var urlAst = SUPABASE_URL + '/rest/v1/assets';
        var optAst = {
            method: 'post', headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
            payload: JSON.stringify(astRecords)
        };
        UrlFetchApp.fetch(urlAst, optAst);
    }

    // 4.3 Delete Assets (‡∏ß‡∏ô‡∏•‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå)
    if (assetsToDelete.size > 0) {
        assetsToDelete.forEach(function(assetId) {
            deleteDataFromSheet('Assets', assetId);
        });
        logsToSave.push({
            date: dateStr, action: 'Rollback (Delete)', item: 'Multiple Assets', change: '-' + assetsToDelete.size + ' Items',
            note: 'Rollback: ‡∏•‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ',
            by: adminInfo, relatedRequestId: requestId
        });
    }

    // 5. Manage Request History
    var statusFlow = ['Draft', 'Pending Head', 'Pending PM', 'Pending Check', 'Approved', 'PR Issued', 'PO Issued', 'Ordered', 'Contract Pending', 'Contract Signed', 'Shipping', 'Partially Received', 'Ready to Disburse', 'Completed', 'Received', 'Returned'];
    var targetIdx = statusFlow.indexOf(targetStatus);

    if (req.history) {
        req.history.forEach(function(h) {
            var actionKey = h.action.replace(/ \(.+\)/, '');
            var hIdx = statusFlow.indexOf(actionKey);
            var isFutureStatus = (hIdx > targetIdx);
            var isTransaction = ['Received', 'Completed', 'Partially Received', 'Returned', 'Issued', '‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á', '‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á'].some(function(k) { return h.action.includes(k); });

            if ((isFutureStatus || isTransaction) && !h.action.includes('(Reverted)')) {
                h.action = h.action + " (Reverted)"; 
            }
        });
    }

    req.history.push({
        date: dateStr, action: 'Rollback to ' + targetStatus, user: adminInfo + ' (Super Admin)',
        note: 'Rollback System: ‡∏¢‡πâ‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏≠‡∏î (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á Logs). ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ' + reason
    });

    // 6. Reset Request Data
    req.status = targetStatus;
    req.items.forEach(function(item) {
        item.receivedTotal = 0;
        item.receivedLog = [];
    });
    saveDataToSheet('Requests', req.id, req);

    // 7. Save Logs
    if (logsToSave.length > 0) {
        var logRecords = logsToSave.map(function(log) {
             var logId = log.date + '_' + Math.floor(Math.random() * 10000);
             return { id: logId, payload: log };
        });
        var urlLog = SUPABASE_URL + '/rest/v1/logs';
        var optLog = {
            method: 'post', headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
            payload: JSON.stringify(logRecords)
        };
        UrlFetchApp.fetch(urlLog, optLog);
    }

    return { success: true, message: 'Rollback ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∑‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', request: req };

  } catch (e) {
    console.error(e);
    return { success: false, message: 'Rollback Error: ' + e.toString() };
  } finally {
    lock.releaseLock();
  }
}
