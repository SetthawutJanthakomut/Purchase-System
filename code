// --- CONFIGURATION ---
const SUPABASE_URL = 'https://zaugfyldiqcpfhfaxapc.supabase.co'; // ‡πÉ‡∏™‡πà Project URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const SUPABASE_KEY = PropertiesService.getScriptProperties().getProperty('SUPABASE_KEY'); // ‚úÖ ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏π‡πâ‡πÄ‡∏ã‡∏ü



function doGet(e) {
  // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Action ‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•
  if (e.parameter && e.parameter.action) {
    
    // ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approve) -> ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (e.parameter.action === 'approve') {
      return processEmailAction(e);
    }
    
    // ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏Å‡∏î‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Reject) -> ‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
    if (e.parameter.action === 'reject') {
      return createRejectForm(e);
    }

    // ‡∏Å‡∏£‡∏ì‡∏µ 3: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (Confirm Reject) -> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (e.parameter.action === 'confirm_reject') {
      return processEmailAction(e);
    }
  }

  // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥: ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Web App
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('PurchaseHub System')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function callSupabase(tableName, method, payload = null, params = '') {
  const table = tableName.toLowerCase(); 
  let url = `${SUPABASE_URL}/rest/v1/${table}${params}`;
  
  const options = {
    method: method,
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal',
      'User-Agent': 'PurchaseHub-Script/1.0'
    },
    muteHttpExceptions: true // ‚≠ê ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á Error Text ‡∏à‡∏≤‡∏Å Server
  };
  
  if (payload) {
    options.payload = JSON.stringify(payload);
  }

  try {
    const response = UrlFetchApp.fetch(url, options);
    const responseCode = response.getResponseCode();
    
    // ‚≠ê ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ Error (‡πÄ‡∏ä‡πà‡∏ô 400, 404, 500) ‡πÉ‡∏´‡πâ Throw ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
    if (responseCode >= 400) {
      const errorMsg = `Supabase Error (${responseCode}): ${response.getContentText()}`;
      console.error(errorMsg);
      throw new Error(errorMsg); // üëà ‡∏™‡πà‡∏á Error ‡πÑ‡∏õ‡πÉ‡∏´‡πâ Frontend ‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ
    }
    
    return response.getContentText();
    
  } catch (e) {
    // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö Error ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡πá‡∏ï‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (DNS Error, Timeout)
    console.error("‚ùå Connection Failed: " + e.toString());
    throw new Error("Connection Failed: " + e.toString());
  }
}

function createRejectForm(e) {
  const reqId = e.parameter.id;
  const role = e.parameter.role;
  const approver = e.parameter.approver;
  const scriptUrl = ScriptApp.getService().getUrl();

  const html = `
    <!DOCTYPE html>
    <html>
      <head>
        <base target="_top">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; display: flex; justify-content: center; padding-top: 50px; }
          .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 90%; max-width: 400px; }
          h2 { color: #d93025; margin-top: 0; }
          textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin: 15px 0; font-family: inherit; }
          button { background-color: #d93025; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; }
          button:hover { background-color: #b02015; }
        </style>
      </head>
      <body>
        <div class="card">
          <h2>‚ùå ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
          <p>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: <strong>${reqId}</strong></p>
          <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (Note):</p>
          
          <form id="rejectForm">
            <textarea id="reason" rows="4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥..." required></textarea>
            <button type="submit">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (Confirm Reject)</button>
          </form>

          <script>
            document.getElementById('rejectForm').onsubmit = function(e) {
              e.preventDefault();
              var reason = document.getElementById('reason').value;
              var btn = document.querySelector('button');
              btn.disabled = true;
              btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

              // Redirect ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Script ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
              var finalUrl = "${scriptUrl}?action=confirm_reject" + 
                             "&id=${reqId}" + 
                             "&role=${role}" + 
                             "&approver=${approver}" + 
                             "&note=" + encodeURIComponent(reason);
              
              window.top.location.href = finalUrl;
            };
          </script>
        </div>
      </body>
    </html>
  `;
  
  return HtmlService.createHtmlOutput(html);
}

function processEmailAction(e) {
  const action = e.parameter.action; 
  const reqId = e.parameter.id;
  const approver = e.parameter.approver;
  const role = e.parameter.role;
  const customNote = e.parameter.note || ''; 

  console.log(`[ProcessEmail] ===== START =====`);
  console.log(`[ProcessEmail] Action: ${action} | ID: ${reqId} | Approver: ${approver}`);

  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ User ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô Log
  const allUsers = getSheetData('Users');
  let userDisplay = approver + " (Email)";
  const foundUser = allUsers.find(u => u.email && approver.includes(u.email));
  if (foundUser) {
      userDisplay = `${foundUser.empId} ${foundUser.firstName} ${foundUser.lastName} (Email)`;
  }

  const requests = getSheetData('Requests');
  const reqIndex = requests.findIndex(r => r.id === reqId);

  if (reqIndex === -1) return HtmlService.createHtmlOutput("<h2>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h2>");

let req = requests[reqIndex];
  
  // ‚≠ê‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] Validation Check: ‡πÄ‡∏û‡∏¥‡πà‡∏° role 'Approver'
  const isWithdrawOrBorrow = (req.type === 'Withdraw' || req.type === 'Borrow');
  let isValidRole = false;

  if (role === 'Head' && req.status === 'Pending Head') isValidRole = true;
  else if (role === 'PM' && req.status === 'Pending PM') isValidRole = true;
  else if (isWithdrawOrBorrow && role === 'PM' && req.status === 'Pending Head') isValidRole = true;
  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Role 'Approver' (‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏•‡∏£‡∏ß‡∏°) ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏™‡∏°‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏°‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
  else if (role === 'Approver' && isWithdrawOrBorrow && req.status === 'Pending Head') isValidRole = true;

  if (!isValidRole) {
     return HtmlService.createHtmlOutput("<h2>‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>");
  }

  // ‚≠ê‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] Update Status Logic
  let newStatus = '';
  let logNote = '';
  if (action === 'approve') {
    // ‡∏Å‡∏£‡∏ì‡∏µ ‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏°: ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏Å‡∏î (Head/PM) ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (isWithdrawOrBorrow) {
        newStatus = 'Ready to Disburse';
    } 
    // ‡∏Å‡∏£‡∏ì‡∏µ ‡∏ã‡∏∑‡πâ‡∏≠ (Local/HO): ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏° Step ‡πÄ‡∏î‡∏¥‡∏°
    else {
        if (role === 'Head') {
            newStatus = 'Pending PM';
        } else if (role === 'PM') {
            newStatus = 'Approved';
        }
    }
    logNote = `Approved via Email by ${approver}`;
  } else if (action === 'confirm_reject') { 
    newStatus = 'Rejected';
    logNote = `Rejected via Email by ${approver}: ${customNote}`; 
  }

  if (!req.docNumber && (newStatus === 'Approved' || newStatus === 'Ready to Disburse')) {
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
      const count = getNextDocIndex(requests, req.type, req.purchaseType);
      req.docNumber = generateDocId(req.type, count, req.purchaseType);
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß
      logNote += ` (Generated Doc No: ${req.docNumber})`;
  }

  // Save Data
  req.status = newStatus;
  if (!req.history) req.history = [];
  req.history.push({
    date: new Date().toLocaleString('th-TH'),
    action: newStatus,
    user: userDisplay,
    note: logNote
  });
  
  saveDataToSheet('Requests', req.id, req);

  // --- Trigger Logic ---
  
  // 1. ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ Level 2 (Pending PM) ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
  if (newStatus === 'Pending PM') {
    try {
      const pmEmails = findApproverEmails(req.job, 9);
      if (pmEmails) sendApprovalEmail(req, pmEmails, 'PM');
    } catch (e) {
      console.error(`[ProcessEmail] Failed to send PM email: ${e.toString()}`);
    }
  }

  // 2. ‚≠ê‚≠ê [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á (Requester) ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß ‚≠ê‚≠ê
  try {
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Pending PM ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á)
      handleStatusNotification(req);
  } catch (e) {
      console.error(`[ProcessEmail] Failed to notify owner: ${e.toString()}`);
  }

  // Return HTML Result
  const color = newStatus === 'Rejected' ? 'red' : 'green';
  const message = newStatus === 'Rejected' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
  let displayStatus = newStatus;
  if (newStatus === 'Pending Head') displayStatus = 'Pending Level 1';
  if (newStatus === 'Pending PM') displayStatus = 'Pending Level 2';

  return HtmlService.createHtmlOutput(`
    <div style="font-family: sans-serif; text-align: center; padding: 50px;">
      <h1 style="color: ${color};">${message}</h1>
      <p>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: <strong>${reqId}</strong></p>
      <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <strong>${displayStatus}</strong></p>
      ${customNote ? `<p>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${customNote}</p>` : ''}
      <button onclick="window.close()" style="padding: 10px 20px; margin-top:20px; cursor: pointer;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button>
    </div>
  `);
}

function findApproverEmails(projectName, permId) {
  console.log(`[FindApprover] ===== START =====`);
  console.log(`[FindApprover] Project: ${projectName}, Permission ID: ${permId}`);
  
  const users = getSheetData('Users');
  console.log(`[FindApprover] Total users in database: ${users.length}`);

  const approvers = users.filter(u => {
    // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ Status ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Activated ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    if (u.status !== 'Activated') {
      return false;
    }

    // Super Admin ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
    if (u.isSuperAdmin) {
      console.log(`[FindApprover] ‚úÖ Found SuperAdmin: ${u.username} (${u.email})`);
      return true;
    }

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
    if (u.permissions && u.permissions[projectName]) {
      const userPerms = u.permissions[projectName].map(Number); 
      const targetPerm = Number(permId);
      
      // ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin (2) ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
      const hasRight = userPerms.includes(2) || userPerms.includes(targetPerm);
      
      if (hasRight) {
        console.log(`[FindApprover] ‚úÖ Found User: ${u.username} (${u.email}) | Permissions: [${userPerms.join(', ')}]`);
      }
      return hasRight;
    }
    
    return false;
  });

  // ‚≠ê ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  const emails = approvers
    .map(u => u.email)
    .filter(email => email && email.includes('@') && email.trim() !== '');
  
  const result = emails.join(',');
  console.log(`[FindApprover] ===== RESULT =====`);
  console.log(`[FindApprover] Emails: ${result || '(NONE)'}`);
  console.log(`[FindApprover] ===== END =====`);
  
  return result;
}

// --- HELPER: ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Budget Tracking (UPDATED: Actual Price Logic) ---
function getBudgetInfoForEmail_FullDetail(req) {
  // 1. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ HO / Local ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  if (!['Local', 'HO'].includes(req.type)) return '';
  
  // 2. ‡∏´‡∏≤ SubJob / Mat. Code ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÉ‡∏ö‡∏ô‡∏µ‡πâ
  const uniqueSubJobs = [...new Set(req.items.map(i => i.subJob).filter(val => val))];
  const uniqueMatCodes = [...new Set(req.items.map(i => i.MatCode).filter(val => val))];

  if (uniqueSubJobs.length === 0 && uniqueMatCodes.length === 0) return '';

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
  const projects = getSheetData('Projects');
  const projectData = projects.find(p => p.name === req.job);
  
  if (!projectData) return '';
  
  const allRequests = getSheetData('Requests');
  const allAssets = getSheetData('Assets'); // ‚≠ê ‡πÇ‡∏´‡∏•‡∏î Assets ‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏£‡∏¥‡∏á
  
  const budgetList = [
      ...uniqueSubJobs.map(c => ({code: c, type: 'SubJob'})),
      ...uniqueMatCodes.map(c => ({code: c, type: 'MatCode'}))
  ];

  let html = `
    <div style="margin-top: 20px; background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; font-family: 'Sarabun', sans-serif;">
      <div style="background-color: #fff8e1; padding: 12px 15px; border-bottom: 1px solid #ffe0b2;">
        <h3 style="margin: 0; font-size: 16px; color: #f57c00;">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Budget Tracking)</h3>
      </div>
      <div style="padding: 15px;">
  `;

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)
  const calculateTotal = (r, code, type) => {
      const items = r.items.filter(i => (type === 'SubJob' ? i.subJob : i.MatCode) === code);
      const isRent = r.type === 'HO' && r.purchaseType === 'Rent';

      return items.reduce((sum, item) => {
          // 1. ‡∏´‡∏≤ Assets ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
          const relatedAssets = allAssets.filter(a => a.currentRequestId === r.id && a.name === item.name);
          // 2. ‡∏´‡∏≤ Logs
          const receivedLogs = item.receivedLog || [];
          
          let itemVal = 0;
          let cnt = 0;

          // Priority A: Assets
          if (relatedAssets.length > 0) {
              itemVal += relatedAssets.reduce((s, asset) => {
                    const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                    const duration = isRent ? (asset.duration || item.duration || 1) : 1;
                    return s + (price * duration);
              }, 0);
              cnt = relatedAssets.length;
          } 
          // Priority B: Logs
          else if (receivedLogs.length > 0) {
              itemVal += receivedLogs.reduce((s, log) => {
                    const duration = isRent ? (log.duration || 1) : 1;
                    return s + (log.qty * log.price * duration);
              }, 0);
              cnt = item.receivedTotal || 0;
          }

          // Priority C: Estimate Remainder
          // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà] ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô Completed (‡∏à‡∏ö‡∏á‡∏≤‡∏ô/Force Close) ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏®‡∏©‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏°‡∏≤‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô
          if (r.status !== 'Completed') { 
              const rem = Math.max(0, item.qty - cnt);
              const dur = isRent ? (item.duration || 1) : 1;
              const estPrice = item.unitPrice || 0;
              itemVal += (rem * estPrice * dur);
          }

          return sum + itemVal;
      }, 0);
  };

  budgetList.forEach(item => {
      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô
      const list = item.type === 'SubJob' ? projectData.subJobs : projectData.MatCodes;
      const target = list ? list.find(x => x.code === item.code) : null;
      const budget = target ? (target.budget || 0) : 0;

      if (budget === 0) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡∏á‡∏ö‡πÄ‡∏õ‡πá‡∏ô 0

      // --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î ---
      let used = 0;    // Completed
      let pending = 0; // Waiting
      
      allRequests.forEach(r => {
          // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏ö‡∏¥‡πâ‡∏•)
          if (r.job !== req.job) return; 
          
          if (r.id === req.id) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡πÉ‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏à‡∏∞‡πÑ‡∏õ‡∏Ñ‡∏¥‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á current)
          if (!['Local', 'HO'].includes(r.type)) return;

          const rTotal = calculateTotal(r, item.code, item.type);

          if (r.status === 'Completed') {
              used += rTotal;
          } else if (!['Draft', 'Rejected', 'Returned'].includes(r.status)) {
              pending += rTotal;
          }
      });

      // ‡∏¢‡∏≠‡∏î‡πÉ‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Current)
      const current = calculateTotal(req, item.code, item.type);

      const totalUsed = used + pending + current;
      const remaining = budget - totalUsed;
      const isOver = totalUsed > budget;

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á
      const usedPct = Math.min((used / budget) * 100, 100);
      const pendingPct = Math.min((pending / budget) * 100, 100 - usedPct);
      const currentPct = Math.min((current / budget) * 100, 100 - usedPct - pendingPct);

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÅ‡∏¢‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô
      html += `
        <div style="margin-bottom: 20px; border-bottom: 1px dashed #eee; padding-bottom: 15px;">
           <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap;">
              <div style="margin-bottom: 4px;">
                 <span style="background-color: ${item.type === 'SubJob' ? '#e8eaf6' : '#f3e5f5'}; color: ${item.type === 'SubJob' ? '#3f51b5' : '#7b1fa2'}; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 11px;">${item.type}</span>
                 <strong style="font-size: 14px; margin-left: 5px;">${item.code}</strong> 
                 <span style="color:#888; font-size: 12px;">(‡∏á‡∏ö: ${budget.toLocaleString()})</span>
              </div>
              <div style="font-size: 13px; font-weight: bold; ${isOver ? 'color: #d32f2f; background: #ffebee; padding: 2px 5px; border-radius: 4px;' : 'color: #333;'}">
                 ‡πÉ‡∏ä‡πâ‡∏£‡∏ß‡∏°: ${totalUsed.toLocaleString()} ${isOver ? '<span style="color:red; font-size:10px;">(‡πÄ‡∏Å‡∏¥‡∏ô‡∏á‡∏ö!)</span>' : ''}
              </div>
           </div>

           <div style="height: 10px; width: 100%; background-color: #f1f1f1; border-radius: 5px; overflow: hidden; display: flex; margin-bottom: 8px;">
              <div style="width: ${usedPct}%; background-color: #4caf50;" title="‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß"></div>
              <div style="width: ${pendingPct}%; background-color: #ffc107;" title="‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡∏≠‡∏∑‡πà‡∏ô"></div>
              <div style="width: ${currentPct}%; background-color: #ff9800;" title="‡πÉ‡∏ö‡∏ô‡∏µ‡πâ"></div>
           </div>
           
           <div style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 11px; color: #555;">
              <div style="display: flex; align-items: center;">
                 <div style="width: 8px; height: 8px; background-color: #4caf50; border-radius: 50%; margin-right: 4px;"></div>
                 ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß (${used.toLocaleString()})
              </div>
              <div style="display: flex; align-items: center;">
                 <div style="width: 8px; height: 8px; background-color: #ffc107; border-radius: 50%; margin-right: 4px;"></div>
                 ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (${pending.toLocaleString()})
              </div>
              <div style="display: flex; align-items: center;">
                 <div style="width: 8px; height: 8px; background-color: #ff9800; border-radius: 50%; margin-right: 4px;"></div>
                 ‡πÉ‡∏ö‡∏ô‡∏µ‡πâ (${current.toLocaleString()})
              </div>
              
              <div style="margin-left: auto; font-weight: bold; font-size: 12px; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                 ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${remaining.toLocaleString()}
              </div>
           </div>
        </div>
      `;
  });

  html += `</div></div>`;
  return html;
}

function sendApprovalEmail(req, targetEmail, targetRole) {
  console.log(`[SendEmail] ===== START =====`);
  
  if (!targetEmail || targetEmail.trim() === '') {
    console.error(`[SendEmail] ‚ùå ERROR: Target email is empty!`);
    return;
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Inventory ‡πÅ‡∏•‡∏∞ Assets ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å
  const inventory = getSheetData('Inventory');
  const assets = getSheetData('Assets');

  const scriptUrl = ScriptApp.getService().getUrl();
  const approverName = targetEmail; 

  const approveLink = `${scriptUrl}?action=approve&id=${req.id}&role=${targetRole}&approver=${approverName}`;
  const rejectLink = `${scriptUrl}?action=reject&id=${req.id}&role=${targetRole}&approver=${approverName}`;
  
  let grandTotal = 0;
  
  // ‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
  const getRentalUnitTh = (unit) => {
      if(unit === 'Day') return '‡∏ß‡∏±‡∏ô';
      if(unit === 'Month') return '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
      if(unit === 'Year') return '‡∏õ‡∏µ';
      return unit || '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'; // Default
  };

  const itemsHtml = req.items.map((item, idx) => {
    const isRent = req.type === 'HO' && req.purchaseType === 'Rent';
    const duration = isRent ? (item.duration || 1) : 1;
    const rentalUnitTh = getRentalUnitTh(item.rentalUnit);
    const total = item.qty * (item.unitPrice || 0) * duration;
    grandTotal += total;

    // --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Web App) ---
    let stockInfo = '';
    const matchingStocks = inventory.filter(inv => inv.name === item.name && inv.project === req.job);
    const totalStockQty = matchingStocks.reduce((sum, inv) => sum + inv.qty, 0);
    const availableAssets = assets.filter(a => a.name === item.name && a.project === req.job && a.status === 'Available').length;

    if (totalStockQty > 0) {
        stockInfo += `<div style="font-size:10px; color:#00796b; background-color:#e0f2f1; padding:2px 4px; border-radius:3px; display:inline-block; margin-top:2px;">‡∏°‡∏µ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á: ${totalStockQty}</div> `;
    }
    if (availableAssets > 0) {
        stockInfo += `<div style="font-size:10px; color:#283593; background-color:#e8eaf6; padding:2px 4px; border-radius:3px; display:inline-block; margin-top:2px;">‡∏ß‡πà‡∏≤‡∏á: ${availableAssets}</div>`;
    }
    // ---------------------------------------------
    
    // Mobile-friendly table row with NOTE column
    return `
      <tr style="border-bottom: 1px solid #eee;">
        <td style="padding: 12px 5px; vertical-align: top; width: 30px;">${idx + 1}</td>
        <td style="padding: 12px 5px; vertical-align: top;">
          <div style="font-weight: bold; color: #333; font-size: 14px;">${item.name}</div>
          <div style="font-size: 12px; color: #666; margin-top: 4px;">
            ${item.subJob ? `<span style="background:#e3f2fd; color:#1565c0; padding:2px 4px; border-radius:3px;">Sub: ${item.subJob}</span>` : ''} 
            ${item.MatCode ? `<span style="background:#f3e5f5; color:#7b1fa2; padding:2px 4px; border-radius:3px;">EP: ${item.MatCode}</span>` : ''}
          </div>
          <div style="margin-top: 5px; font-size: 12px; color: #555;">
             ${item.note ? `${item.note}<br/>` : ''}
             ${stockInfo}
          </div>
        </td>
        <td style="padding: 12px 5px; text-align: right; vertical-align: top; white-space: nowrap;">
            <div style="font-weight: bold;">${item.qty} ${item.unit}</div>
            ${isRent ? `<div style="font-size:10px; color:blue;">x ${duration} ${rentalUnitTh}</div>` : ''}
        </td>
        <td style="padding: 12px 5px; text-align: right; vertical-align: top; white-space: nowrap;">
            <div style="font-size: 12px; color:#666;">@${item.unitPrice.toLocaleString()}</div>
            <div style="font-weight: bold; color: #333; font-size: 14px;">${total.toLocaleString()}</div>
        </td>
      </tr>
    `;
  }).join('');

  // ‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Budget HTML (Full Detail)
  const budgetHtml = getBudgetInfoForEmail_FullDetail(req);

  const htmlBody = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
        body { margin: 0; padding: 0; background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background-color: #ffffff; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        .header { background-color: #1976d2; padding: 25px 20px; color: #ffffff; }
        .content { padding: 20px; }
        .btn { 
            display: inline-block; 
            padding: 12px 24px; 
            text-decoration: none; 
            border-radius: 6px; 
            font-weight: bold; 
            font-size: 16px; 
            text-align: center;
            margin: 5px;
        }
        .btn-approve { background-color: #2e7d32; color: white !important; }
        .btn-reject { background-color: #d32f2f; color: white !important; }
        .btn-link { background-color: #fff; color: #1976d2 !important; border: 1px solid #1976d2; font-size: 14px; padding: 10px 20px;}
        
        @media only screen and (max-width: 600px) {
          .btn { display: block; width: 90%; margin: 10px auto; }
          .meta-table td { display: block; width: 100%; padding-bottom: 5px; }
          .header h2 { font-size: 20px; }
        }
      </style>
    </head>
    <body>
      <div style="padding: 10px;">
        <div class="container">
          
          <div class="header">
            <h2 style="margin: 0;">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${req.id}</h2>
            <p style="margin: 5px 0 0; opacity: 0.9;">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: <strong>${req.job}</strong></p>
            <p style="margin: 2px 0 0; opacity: 0.9; font-size: 14px;">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: ${req.requester}</p>
          </div>
          
          <div class="content">
            <table class="meta-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px; color: #444;">
              <tr>
                <td style="padding: 5px; color: #888;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</td>
                <td style="padding: 5px; font-weight: bold; color: #333;">${req.type} ${req.purchaseType || ''}</td>
              </tr>
              <tr>
                <td style="padding: 5px; color: #888;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</td>
                <td style="padding: 5px; font-weight: bold; color: #333;">${req.dateRequired}</td>
              </tr>
              <tr>
                <td style="padding: 5px; color: #888;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</td>
                <td style="padding: 5px; font-weight: bold; color: ${req.priority === 'Critical' ? 'red' : 'blue'};">${req.priority}</td>
              </tr>
            </table>

            <h3 style="border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 0; font-size: 16px; color: #333;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
              <thead style="background-color: #f9fafb; color: #666; font-size: 12px;">
                <tr>
                  <th style="padding: 8px 5px; text-align: left;">#</th>
                  <th style="padding: 8px 5px; text-align: left;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                  <th style="padding: 8px 5px; text-align: right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th style="padding: 8px 5px; text-align: right;">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</th>
                </tr>
              </thead>
              <tbody>
                ${itemsHtml}
              </tbody>
              <tfoot style="background-color: #f1f8e9;">
                <tr>
                  <td colspan="3" style="padding: 10px; text-align: right; font-weight: bold; color: #333;">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</td>
                  <td style="padding: 10px 5px; text-align: right; font-weight: bold; color: #1976d2; font-size: 16px;">${grandTotal.toLocaleString()}</td>
                </tr>
              </tfoot>
            </table>
            
            ${req.note ? `
              <div style="margin-top: 20px; padding: 12px; background-color: #fff8e1; border-radius: 6px; border-left: 4px solid #ffc107; font-size: 14px;">
                <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</strong> ${req.note}
              </div>` : ''}

            ${budgetHtml}

            <div style="margin-top: 30px; text-align: center; border-top: 1px solid #eee; padding-top: 20px;">
              <p style="margin-bottom: 15px; font-weight: bold; color: #555;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</p>
              
              <a href="${approveLink}" class="btn btn-approve">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approve)</a>
              <a href="${rejectLink}" class="btn btn-reject">‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Reject)</a>
              
              <div style="margin-top: 20px;">
                 <a href="${scriptUrl}" target="_blank" class="btn btn-link">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ (Open App)</a>
              </div>

              <p style="font-size: 12px; color: #999; margin-top: 15px;">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
            </div>

          </div>
        </div>
      </div>
    </body>
    </html>
  `;

  try {
    GmailApp.sendEmail(targetEmail, `[PurchaseHub] ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${req.id} - ${req.job}`, '', {
      htmlBody: htmlBody
    });
    console.log(`[SendEmail] ‚úÖ Email sent successfully to ${targetEmail}`);
  } catch (error) {
    console.error(`[SendEmail] ‚ùå Failed to send email: ${error.toString()}`);
  }

  console.log(`[SendEmail] ===== END =====`);
}

function syncRequest(request) {
  console.log(`[SyncRequest] ===== START =====`);
  console.log(`[SyncRequest] Request ID: ${request.id}`);
  console.log(`[SyncRequest] Status: ${request.status}`);
  console.log(`[SyncRequest] Job: ${request.job}`);
  
  // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  const result = saveDataToSheet('Requests', request.id, request);
  
// 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approval Buttons)
  try {
      if (request.status === 'Pending Head') {
          // ‚≠ê‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏Ç‡∏≠ ‚≠ê‚≠ê
          if (request.type === 'Withdraw' || request.type === 'Borrow') {
              // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏ö‡∏¥‡∏Å/‡∏¢‡∏∑‡∏°: ‡∏´‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏±‡πâ‡∏á 2 ‡∏£‡∏∞‡∏î‡∏±‡∏ö
              const headEmails = findApproverEmails(request.job, 8); // Level 1
              const pmEmails = findApproverEmails(request.job, 9);   // Level 2
              
              // ‡∏£‡∏ß‡∏°‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏õ‡πá‡∏ô string ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma)
              let recipients = [];
              if (headEmails) recipients.push(headEmails);
              if (pmEmails) recipients.push(pmEmails);
              
              // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Role ‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡πà‡∏≤ 'Approver'
              if (recipients.length > 0) {
                  const combinedEmails = recipients.join(',');
                  sendApprovalEmail(request, combinedEmails, 'Approver'); 
              }
          } else {
              // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ã‡∏∑‡πâ‡∏≠ Local/HO): ‡∏™‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏¥‡∏°
              const headEmails = findApproverEmails(request.job, 8);
              if (headEmails) sendApprovalEmail(request, headEmails, 'Head');
          }
      }
      else if (request.status === 'Pending PM') {
          const pmEmails = findApproverEmails(request.job, 9);
          if (pmEmails) sendApprovalEmail(request, pmEmails, 'PM');
      } 
  } catch (e) {
      console.error("‚ùå [SyncRequest] Approval Email FAILED: " + e.toString());
  }

  // 3. ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Notification) (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  try {
      handleStatusNotification(request);
  } catch (e) {
      console.error("‚ùå [SyncRequest] Notification Email FAILED: " + e.toString());
  }

  console.log(`[SyncRequest] ===== END =====`);
  return result;
}

// --- HELPER FUNCTIONS ---





// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getSheetData ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Query (Filter)
function getSheetData(sheetName, customQuery = '') {
  // 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Parameter ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏î‡∏∂‡∏á‡πÅ‡∏Ñ‡πà column payload)
  let params = '?select=payload';
  
  // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Query ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏°‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á) ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
  if (customQuery) {
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ customQuery ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ & ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°
    if (!customQuery.startsWith('&')) params += '&';
    params += customQuery;
  }

  // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Supabase ‡∏û‡∏£‡πâ‡∏≠‡∏° Filter ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
  // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô callSupabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö params ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 4 ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
  const jsonResponse = callSupabase(sheetName.toLowerCase(), 'get', null, params);
  
  // 4. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  try {
    const data = JSON.parse(jsonResponse);
    if (Array.isArray(data)) {
      return data.map(row => row.payload);
    } else {
      return []; 
    }
  } catch (e) {
    console.error("Error parsing data from " + sheetName + ": " + e.toString());
    return [];
  }
}

function saveDataToSheet(sheetName, id, dataObj) {
  // ‡πÉ‡∏ä‡πâ UPSERT (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ID ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ö ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)
  const record = {
    id: id.toString(), // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô String
    payload: dataObj   // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πâ‡∏≠‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏ô jsonb
  };
  
  // ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö POST ‡∏û‡∏£‡πâ‡∏≠‡∏° header Prefer: resolution=merge-duplicates ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Upsert ‡πÉ‡∏ô Supabase
  const table = sheetName.toLowerCase();
  const url = `${SUPABASE_URL}/rest/v1/${table}`;
  const options = {
    method: 'post',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'resolution=merge-duplicates' // ‚≠ê ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ö‡∏ñ‡πâ‡∏≤ ID ‡∏ã‡πâ‡∏≥
    },
    payload: JSON.stringify(record)
  };
  
  UrlFetchApp.fetch(url, options);
  return true;
}

function deleteDataFromSheet(sheetName, id) {
  // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡πâ‡∏≠‡∏á Encode ID ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ |
  var encodedId = encodeURIComponent(id);
  
  // ‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà id ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
  callSupabase(sheetName, 'delete', null, `?id=eq.${encodedId}`);
}

// --- FILE UPLOAD FUNCTIONS ---

function uploadFileToDrive(base64Data, fileName) {
  try {
    const FOLDER_ID = "1M57m68rI8bM-BBqRlh_LzZHuDWPZVdwz"; 
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return {
      name: fileName,
      url: file.getUrl(),
      id: file.getId()
    };
  } catch (e) {
    return { error: e.toString() };
  }
}

function getOrCreateSubFolder(parentFolderId, subFolderName) {
  const parentFolder = DriveApp.getFolderById(parentFolderId);
  const folders = parentFolder.getFoldersByName(subFolderName);
  if (folders.hasNext()) {
    return folders.next();
  } else {
    return parentFolder.createFolder(subFolderName);
  }
}

function uploadAssetImage(base64Data, fileName) {
  try {
    const MAIN_FOLDER_ID = "1M57m68rI8bM-BBqRlh_LzZHuDWPZVdwz"; 
    const SUB_FOLDER_NAME = "Asset_Images"; 
    const targetFolder = getOrCreateSubFolder(MAIN_FOLDER_ID, SUB_FOLDER_NAME);
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    const file = targetFolder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return {
      name: fileName,
      url: file.getUrl(),
      id: file.getId()
    };
  } catch (e) {
    return { error: e.toString() };
  }
}

// --- SPECIFIC SYNC FUNCTIONS ---

function syncProject(project) {
  return saveDataToSheet('Projects', project.id, project);
}

function deleteProjectFromSheet(id) {
  deleteDataFromSheet('Projects', id);
}


function syncInventory(item) {
  return saveDataToSheet('Inventory', item.id, item);
}

function syncAsset(asset) {
  return saveDataToSheet('Assets', asset.id, asset);
}

function syncLog(log) {
  const id = log.date + '_' + Math.floor(Math.random() * 1000); 
  return saveDataToSheet('Logs', id, log);
}

// --- USER MANAGEMENT & MAIN API ---

function loginUser(username, password) {
  if (username === 'admin' && password === '1231') {
    return {
      success: true,
      user: {
        username: 'admin',
        firstName: 'System',
        lastName: 'Administrator',
        empId: 'ADMIN-001',
        role: 'Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)',
        isSuperAdmin: true,
        status: 'Activated'
      }
    };
  }

  const users = getSheetData('Users');
  const user = users.find(u => u.username === username && u.password === password);
  
  if (user) {
    if (user.status !== 'Activated') {
       return { success: false, message: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
    }
    return { 
      success: true, 
      user: {
        ...user,
        password: '' 
      }
    };
  } else {
    return { success: false, message: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' };
  }
}

function registerUser(formData) {
  const users = getSheetData('Users');
  if (users.some(u => u.username === formData.username)) {
    return { success: false, message: 'Username ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' };
  }
  
  const newUser = {
    id: formData.username, 
    ...formData,
    role: 'User', 
    status: 'New', 
    permissions: {}, 
    createdAt: new Date().toLocaleString('th-TH')
  };
  
  saveDataToSheet('Users', newUser.id, newUser);
  return { success: true, message: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
}

// [‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveUserData ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ]

function saveUserData(user) {
  const users = getSheetData('Users');
  
  // ‚≠ê ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Emp ID) ‡∏ã‡πâ‡∏≥
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ EmpID ‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏° (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
  const duplicate = users.find(u => u.empId === user.empId && u.id !== user.id);
  if (duplicate) {
    return { 
      success: false, 
      message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${user.empId} ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ${duplicate.firstName} ${duplicate.lastName}` 
    };
  }

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
  saveDataToSheet('Users', user.id, user);
  return { success: true, message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' };
}

function loadInitialData() {
  const settings = getSheetData('Settings');
  const announcement = settings.find(s => s.id === 'ANNOUNCEMENT') || null;
  
  return {
    requests: getSheetData('Requests'),
    inventory: getSheetData('Inventory'),
    assets: getSheetData('Assets'),
    // logs: getSheetData('Logs'), // ‚ùå ‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î Logs ‡∏Å‡πâ‡∏≠‡∏ô‡∏¢‡∏±‡∏Å‡∏©‡πå‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ
    logs: [], // ‚úÖ ‡∏™‡πà‡∏á Array ‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á
    projects: getSheetData('Projects'),
    users: getSheetData('Users'),
    announcement: announcement
  };
}

// ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î Logs ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å
// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ñ‡πà 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î‡∏†‡∏≤‡∏£‡∏∞‡πÑ‡∏î‡πâ‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•)
function getRecentLogs(limit = 100) {
  // order=id.desc ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å id ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤ id ‡∏Ñ‡∏∏‡∏ì‡∏£‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤)
  // limit=100 ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  const params = `?select=payload&order=id.desc&limit=${limit}`; 
  const jsonResponse = callSupabase('logs', 'get', null, params);
  const data = JSON.parse(jsonResponse);
  
  if (Array.isArray(data)) {
    return data.map(row => row.payload);
  } else {
    return [];
  }
}
// 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á OTP ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö empId ‡∏°‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢
function sendRegistrationOTP(email, username, empId) { // ‚≠ê ‡∏£‡∏±‡∏ö‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå empId ‡πÄ‡∏û‡∏¥‡πà‡∏°
  const users = getSheetData('Users');

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Username ‡∏ã‡πâ‡∏≥
  if (users.some(u => u.username === username)) {
    return { success: false, message: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username) ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà' };
  }

  // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö EmpID ‡∏ã‡πâ‡∏≥ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ)
  if (users.some(u => u.empId === empId)) {
    return { success: false, message: '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß' };
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Email ‡∏ã‡πâ‡∏≥
  if (users.some(u => u.email === email)) {
    return { success: false, message: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' };
  }

  // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á OTP ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
  const otp = Math.floor(1000 + Math.random() * 9000).toString();
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let refCode = '';
  for (let i = 0; i < 4; i++) {
    refCode += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  
  CacheService.getScriptCache().put('OTP_' + email, otp, 300);

  try {
    GmailApp.sendEmail(email, `[PurchaseHub] ‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (Ref: ${refCode})`, 
      `‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (Ref Code): ${refCode}\n\n‡∏£‡∏´‡∏±‡∏™ OTP ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: ${otp}\n\n(‡∏£‡∏´‡∏±‡∏™‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏ 5 ‡∏ô‡∏≤‡∏ó‡∏µ)`);
    return { success: true, message: '‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP ‡πÅ‡∏•‡πâ‡∏ß', refCode: refCode };
  } catch (e) {
    return { success: false, message: '‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.toString() };
  }
}

// 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
function registerUser(formData, otp) {
  const cachedOtp = CacheService.getScriptCache().get('OTP_' + formData.email);
  if (!cachedOtp || cachedOtp !== otp) {
    return { success: false, message: '‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà)' };
  }
  
  CacheService.getScriptCache().remove('OTP_' + formData.email);

  const users = getSheetData('Users');
  
  // ‡πÄ‡∏ä‡πá‡∏Ñ Username ‡∏ã‡πâ‡∏≥
  if (users.some(u => u.username === formData.username)) {
    return { success: false, message: 'Username ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' };
  }

  // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ EmpID ‡∏ã‡πâ‡∏≥ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ)
  if (users.some(u => u.empId === formData.empId)) {
    return { success: false, message: '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' };
  }
  
  const newUser = {
    id: formData.username, 
    ...formData,
    role: 'User', 
    status: 'New', 
    permissions: {}, 
    createdAt: new Date().toLocaleString('th-TH')
  };
  saveDataToSheet('Users', newUser.id, newUser);
  return { success: true, message: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
}
// --- [Server Side] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ---

// 1. ‡∏™‡πà‡∏á OTP ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
function sendForgotPasswordOTP(email) {
  const users = getSheetData('Users');
  const user = users.find(u => u.email === email);
  
  if (!user) {
    return { success: false, message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' };
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á OTP ‡πÅ‡∏•‡∏∞ Ref Code
  const otp = Math.floor(1000 + Math.random() * 9000).toString();
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let refCode = '';
  for (let i = 0; i < 4; i++) { refCode += chars.charAt(Math.floor(Math.random() * chars.length)); }
  
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á Cache (‡πÉ‡∏ä‡πâ key ‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≠‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
  CacheService.getScriptCache().put('RESET_OTP_' + email, otp, 300); // 5 ‡∏ô‡∏≤‡∏ó‡∏µ

  try {
    GmailApp.sendEmail(email, `[PurchaseHub] ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Ref: ${refCode})`, 
      `‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (Ref Code): ${refCode}\n\n‡∏£‡∏´‡∏±‡∏™ OTP ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏∑‡∏≠: ${otp}\n\n(‡∏£‡∏´‡∏±‡∏™‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏ 5 ‡∏ô‡∏≤‡∏ó‡∏µ)`);
    return { success: true, message: '‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß', refCode: refCode };
  } catch (e) {
    return { success: false, message: '‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.toString() };
  }
}

// 2. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
function resetPassword(email, otp, newPassword) {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OTP
  const cachedOtp = CacheService.getScriptCache().get('RESET_OTP_' + email);
  if (!cachedOtp || cachedOtp !== otp) {
    return { success: false, message: '‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' };
  }

  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User
  const users = getSheetData('Users');
  const user = users.find(u => u.email === email);
  
  if (user) {
    user.password = newPassword; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
    saveDataToSheet('Users', user.id, user); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheet
    
    CacheService.getScriptCache().remove('RESET_OTP_' + email); // ‡∏•‡∏ö OTP ‡∏ó‡∏¥‡πâ‡∏á
    return { success: true, message: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà' };
  }
  
  return { success: false, message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' };
}

// --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ---
function sendUsernameToEmail(email) {
  const users = getSheetData('Users');
  const user = users.find(u => u.email === email);
  
  if (!user) {
    return { success: false, message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' };
  }

  try {
    GmailApp.sendEmail(email, '[PurchaseHub] ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username Recovery)', 
      `‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì ${user.firstName},\n\n‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username) ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: ${user.username}\n\n‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö`);
    return { success: true, message: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username) ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß' };
  } catch (e) {
    return { success: false, message: '‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.toString() };
  }
}

// --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå Code.gs] ---



// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å Sheet (Requests, Assets, Logs)
// --- [Code.gs] ---

// ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö (Global Update) - ‡∏â‡∏ö‡∏±‡∏ö Supabase
function updateUserGlobalData(oldData, newData) {
  console.log(`[GlobalUpdate] Starting... from ${oldData.empId} to ${newData.empId}`);

  // 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
  const newFullSig = `${newData.empId} ${newData.firstName} ${newData.lastName}`;
  const newShortName = `${newData.firstName} ${newData.lastName}`;

  // 2. ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  const oldPatterns = [
    `${oldData.empId} ${oldData.firstName} ${oldData.lastName}`,
    `${oldData.empId} ${oldData.firstName} ${oldData.lastName} (Email)`,
    `${oldData.firstName} ${oldData.lastName}`,
    `${oldData.empId} ${oldData.firstName}`,
    oldData.empId
  ];

  const isMatch = (value) => {
    if (!value || typeof value !== 'string') return false;
    const val = value.trim();
    return oldPatterns.some(pattern => {
      if (pattern === oldData.empId) return val.startsWith(pattern);
      return val === pattern || val.replace(/\s+/g, ' ') === pattern;
    });
  };

  let countReq = 0;
  let countLog = 0;
  let countAsset = 0;

  // --- Helper ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏° ID (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Logs ‡πÑ‡∏°‡πà‡∏°‡∏µ ID ‡πÉ‡∏ô Payload) ---
  const getTableData = (table) => {
    const res = callSupabase(table, 'get', null, '?select=id,payload');
    const data = JSON.parse(res);
    return Array.isArray(data) ? data : [];
  };

  // --- 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á Requests ---
  const requestRows = getTableData('Requests');
  requestRows.forEach(row => {
    let req = row.payload;
    let changed = false;

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
    if (isMatch(req.requester)) { req.requester = newShortName; changed = true; }
    if (isMatch(req.approverL1)) { req.approverL1 = newFullSig; changed = true; }
    if (isMatch(req.approverL2)) { req.approverL2 = newFullSig; changed = true; }

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô History
    if (req.history && Array.isArray(req.history)) {
      req.history.forEach(h => {
        if (isMatch(h.user)) { h.user = newFullSig; changed = true; }
      });
    }

    if (changed) {
      saveDataToSheet('Requests', row.id, req);
      countReq++;
    }
  });

  // --- 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á Logs (‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏ß‡∏°) ---
  const logRows = getTableData('Logs');
  logRows.forEach(row => {
    let log = row.payload;
    if (isMatch(log.by)) {
      log.by = newFullSig;
      saveDataToSheet('Logs', row.id, log);
      countLog++;
    }
  });

  // --- 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á Assets (‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á) ---
  const assetRows = getTableData('Assets');
  assetRows.forEach(row => {
    let asset = row.payload;
    if (isMatch(asset.holder)) {
      asset.holder = newShortName;
      saveDataToSheet('Assets', row.id, asset);
      countAsset++;
    }
  });

  return {
    success: true,
    message: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£(${countReq}), ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥(${countLog}), ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô(${countAsset})`
  };
}

// [‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ô Code.gs]

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á Admin)
function getAllAnnouncements() {
  const settings = getSheetData('Settings');
  // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Row ‡∏ó‡∏µ‡πà ID ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ANN-
  return settings.filter(s => s.id && s.id.toString().startsWith('ANN-'));
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà Active" (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login / Public)
function getPublicAnnouncements() {
  const settings = getSheetData('Settings');
  // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Active = true
  return settings.filter(s => s.id && s.id.toString().startsWith('ANN-') && s.active === true);
}

// 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
function saveAnnouncementItem(data) {
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ID ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
  const id = data.id || `ANN-${new Date().getTime()}`;
  
  const payload = {
    ...data,
    id: id,
    updatedBy: data.updatedBy,
    timestamp: new Date().toLocaleString('th-TH')
  };
  
  saveDataToSheet('Settings', id, payload);
  return { success: true, message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', data: payload };
}

// 4. ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
function deleteAnnouncementItem(id) {
  deleteDataFromSheet('Settings', id);
  return { success: true, message: '‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß' };
}

// 5. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®)
function toggleAnnouncementStatus(id, isActive) {
  const settings = getSheetData('Settings');
  const target = settings.find(s => s.id === id);
  if (target) {
    target.active = isActive;
    saveDataToSheet('Settings', id, target);
    return { success: true, message: isActive ? '‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß' : '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß' };
  }
  return { success: false, message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' };
}

// --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå code.gs ---

function uploadUserSignature(base64Data, fileName) {
  try {
    const MAIN_FOLDER_ID = "1M57m68rI8bM-BBqRlh_LzZHuDWPZVdwz"; // ‡πÉ‡∏ä‡πâ ID ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏î‡∏¥‡∏°
    const SUB_FOLDER_NAME = "User_Signatures"; // ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
    const targetFolder = getOrCreateSubFolder(MAIN_FOLDER_ID, SUB_FOLDER_NAME);
    
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    
    const file = targetFolder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    return {
      name: fileName,
      url: file.getUrl(),
      id: file.getId()
    };
  } catch (e) {
    return { error: e.toString() };
  }
}


// --- NOTIFICATION SYSTEM (NEW) ---

// --- NOTIFICATION SYSTEM (UPDATED FOR ROLLBACK) ---

function handleStatusNotification(req) {
  const status = req.status;
  if (status === 'Draft') return;

  // 1. ‡∏´‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ (‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á Order)
  const requesterEmail = findUserEmail(req.requester);
  
  // 2. ‡∏´‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
  let nextActorEmails = [];
  if (status !== 'Pending Head' && status !== 'Pending PM') {
      const permId = getPermissionForStatus(req);
      if (permId) {
          const emailsStr = findApproverEmails(req.job, permId);
          if (emailsStr) nextActorEmails = emailsStr.split(',');
      }
  }

  // 3. ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ + ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏±‡πâ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)
  let recipients = [requesterEmail, ...nextActorEmails]
      .filter(email => email && email.includes('@'))
      .map(e => e.trim());
  recipients = [...new Set(recipients)];

  if (recipients.length === 0) return;

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
  let displayStatus = status;
  if (status === 'Pending Head') displayStatus = 'Pending Level 1';
  if (status === 'Pending PM') displayStatus = 'Pending Level 2';

  // ‚≠ê [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Rollback ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å Note ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
  let subjectPrefix = `[‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${displayStatus}]`;
  
  const lastLog = req.history && req.history.length > 0 ? req.history[req.history.length - 1] : null;
  // ‡∏ñ‡πâ‡∏≤ Note ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ Rollback ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏°‡∏•
  if (lastLog && lastLog.note && (lastLog.note.includes('Rollback') || lastLog.note.includes('‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö'))) {
      subjectPrefix = `[‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏¢‡πâ‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Rollback) ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ${displayStatus}]`;
  }

  // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á
  const subject = `${subjectPrefix} ${req.id} - ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${req.job}`;
  const body = createNotificationBody(req, displayStatus);

  recipients.forEach(email => {
      try {
          GmailApp.sendEmail(email, subject, '', { htmlBody: body });
          console.log(`[Notification] Sent to ${email}`);
      } catch (e) {
          console.error(`[Notification] Error: ${e.toString()}`);
      }
  });
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -> ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
function getPermissionForStatus(req) {
  switch (req.status) {
    case 'Pending Check': return 10; // ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö -> ‡∏ù‡πà‡∏≤‡∏¢ Verify (10)
    case 'Revise Needed': return null; // ‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -> ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°)
    
    // Approved -> ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    case 'Approved': 
        if (req.type === 'Local') return 12; // Local -> ‡∏£‡∏≠‡∏≠‡∏≠‡∏Å PO/‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (12)
        if (req.type === 'HO' && req.purchaseType === 'Buy') return 11; // HO Buy -> ‡∏£‡∏≠‡∏≠‡∏≠‡∏Å PR (11)
        if (req.type === 'HO' && req.purchaseType === 'Rent') return req.needContract !== false ? 14 : 13; // HO Rent -> ‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (14) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (13)
        return null;

    case 'PR Issued': return 12; // PR ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß -> ‡∏£‡∏≠‡∏≠‡∏≠‡∏Å PO (12)
    case 'PO Issued': return 13; // PO ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß -> ‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (13)
    case 'Ordered': return 15; // ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß -> ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (15)
    case 'Contract Pending': return 14; // ‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤ -> ‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (14)
    case 'Contract Signed': return 13; // ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß -> ‡∏£‡∏≠‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (13)
    case 'Shipping': return 15; // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á -> ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (15)
    case 'Partially Received': return 15; // ‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô -> ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏° (15)
    case 'Ready to Disburse': return 24; // ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢ -> Store (24)
    
    // ‡∏à‡∏ö‡∏á‡∏≤‡∏ô / ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á / ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô -> ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏Ñ‡πà‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ó‡∏£‡∏≤‡∏ö (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Action ‡∏ï‡πà‡∏≠)
    case 'Completed': return null; 
    case 'Returned': return null;
    case 'Rejected': return null;
    
    default: return null;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (requester string)
function findUserEmail(requesterStr) {
  if (!requesterStr) return null;
  const users = getSheetData('Users');
  
  // requesterStr ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô "First Last" ‡∏´‡∏£‡∏∑‡∏≠ "ID First Last"
  // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÅ‡∏ö‡∏ö Contains
  const user = users.find(u => {
      const fullName = `${u.firstName} ${u.lastName}`;
      const fullSig = `${u.empId} ${u.firstName} ${u.lastName}`;
      return requesterStr === fullName || requesterStr === fullSig || requesterStr.includes(u.email);
  });

  return user ? user.email : null;
}

function createNotificationBody(req, displayStatus) {
  const color = 
      req.status === 'Rejected' ? '#d32f2f' : 
      req.status === 'Completed' ? '#2e7d32' : 
      req.status.includes('Pending') ? '#f57c00' : '#1976d2';

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á displayStatus ‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
  if (!displayStatus) {
      displayStatus = req.status;
      if (req.status === 'Pending Head') displayStatus = 'Pending Level 1';
      if (req.status === 'Pending PM') displayStatus = 'Pending Level 2';
  }

  return `
    <div style="font-family: 'Sarabun', sans-serif; max-width: 600px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
        <div style="background-color: ${color}; color: white; padding: 15px;">
            <h2 style="margin: 0; font-size: 18px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h2>
        </div>
        <div style="padding: 20px;">
            <p>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á,</p>
            <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç <strong>${req.id}</strong> ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
            
            <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                <tr style="background-color: #f5f5f5;">
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd; color: ${color}; font-weight: bold;">${displayStatus}</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${req.job}</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${req.requester}</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${req.items[0].name} ${req.items.length > 1 ? `(‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${req.items.length - 1} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)` : ''}</td>
                </tr>
            </table>

            ${req.history && req.history.length > 0 ? `
            <p style="color: #666; font-size: 12px;">
                <strong>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÇ‡∏î‡∏¢:</strong> ${req.history[req.history.length - 1].user}<br/>
                <strong>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</strong> ${req.history[req.history.length - 1].note || '-'}
            </p>` : ''}
            
            <div style="text-align: center; margin-top: 20px;">
                <a href="${ScriptApp.getService().getUrl()}" style="background-color: #1976d2; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>
            </div>
        </div>
    </div>
  `;
}

// --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç Doc No. ‡πÉ‡∏ô Backend (‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå code.gs) ---

function getNextDocIndex(allRequests, type, purchaseType) {
  return allRequests.filter(r => {
    if (!r.docNumber) return false;
    if (r.type !== type) return false;
    if (type === 'HO') return r.purchaseType === purchaseType;
    return true;
  }).length;
}

function generateDocId(type, index, purchaseType) {
  const now = new Date();
  const timeZone = "GMT+7";
  const year = Utilities.formatDate(now, timeZone, "yy");
  const month = Utilities.formatDate(now, timeZone, "MM");
  const runNo = (index + 1).toString().padStart(3, '0');
  
  switch(type) {
      case 'Local': return `LPO-${year}${month}-${runNo}`;
      case 'HO': 
          return purchaseType === 'Rent' 
              ? `HRO-${year}${month}-${runNo}` 
              : `HPO-${year}${month}-${runNo}`;
      case 'Withdraw': return `WID-${year}${month}-${runNo}`;
      case 'Borrow': return `BOR-${year}${month}-${runNo}`;
      default: return `DOC-${year}${month}-${runNo}`;
  }
}


// --- BUDGET SUMMARY EMAIL TRIGGER ---

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Trigger ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡πÄ‡∏ß‡∏•‡∏≤ 09:00 ‡∏ô.
 * ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Run ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö
 */
function setupBudgetSummaryTrigger() {
  // ‡∏•‡∏ö Trigger ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥
  const triggers = ScriptApp.getProjectTriggers();
  for (let i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === 'sendWeeklyBudgetSummary') {
      ScriptApp.deleteTrigger(triggers[i]);
    }
  }
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Trigger ‡πÉ‡∏´‡∏°‡πà: ‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡πÄ‡∏ß‡∏•‡∏≤ 09:00
  ScriptApp.newTrigger('sendWeeklyBudgetSummary')
      .timeBased()
      .onWeekDay(ScriptApp.WeekDay.MONDAY)
      .atHour(9)
      .create();
      
  console.log("‚úÖ Budget Summary Trigger setup complete.");
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î Budget
 */
function sendWeeklyBudgetSummary() {
  console.log("[BudgetSummary] Starting report generation...");
  
  // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const projects = getSheetData('Projects');
  const requests = getSheetData('Requests');
  const assets = getSheetData('Assets');
  const users = getSheetData('Users');
  
  if (!projects || projects.length === 0) {
    console.log("[BudgetSummary] No projects found.");
    return;
  }

  // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Project / Code
  const reportData = projects.map(proj => {
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const subJobs = (proj.subJobs || []).map(s => ({ ...s, type: 'SubJob', used: 0, pending: 0 }));
    const MatCodes = (proj.MatCodes || []).map(e => ({ ...e, type: 'MatCode', used: 0, pending: 0 }));
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö getBudgetInfoForEmail_FullDetail)
    const calculateItemValue = (req, item) => {
        const isRent = req.type === 'HO' && req.purchaseType === 'Rent';
        const relatedAssets = assets.filter(a => a.currentRequestId === req.id && a.name === item.name);
        const receivedLogs = item.receivedLog || [];
        
        let val = 0;
        let cnt = 0;

        // A. Assets (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏∏‡∏î)
        if (relatedAssets.length > 0) {
            val += relatedAssets.reduce((s, asset) => {
                const price = isRent ? (asset.rentalPrice || 0) : (asset.price || 0);
                const duration = isRent ? (asset.duration || item.duration || 1) : 1;
                return s + (price * duration);
            }, 0);
            cnt = relatedAssets.length;
        } 
        // B. Logs (‡∏£‡∏≠‡∏á‡∏•‡∏á‡∏°‡∏≤)
        else if (receivedLogs.length > 0) {
            val += receivedLogs.reduce((s, log) => {
                const duration = isRent ? (log.duration || 1) : 1;
                return s + (log.qty * log.price * duration);
            }, 0);
            cnt = item.receivedTotal || 0;
        }

        // C. Estimate (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
        const rem = Math.max(0, item.qty - cnt);
        
        // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡∏Ñ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ req ‡πÄ‡∏õ‡πá‡∏ô Completed ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
        if (req.status !== 'Completed') {
            const dur = isRent ? (item.duration || 1) : 1;
            const estPrice = item.unitPrice || 0;
            val += (rem * estPrice * dur);
        }
        
        return val;
    };

    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ Request ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    requests.forEach(req => {
        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ request ‡∏Ç‡∏≠‡∏á project ‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏°‡∏µ budget
        if (req.job !== proj.name) return;
        if (!['Local', 'HO'].includes(req.type)) return;
        
        const isCompleted = req.status === 'Completed';
        const isPending = !['Draft', 'Rejected', 'Returned', 'Completed'].includes(req.status);
        
        if (!isCompleted && !isPending) return;

        req.items.forEach(item => {
            const amount = calculateItemValue(req, item);
            
            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏¢‡∏≠‡∏î‡∏•‡∏á SubJob
            if (item.subJob) {
                const target = subJobs.find(s => s.code === item.subJob);
                if (target) {
                    if (isCompleted) target.used += amount;
                    else target.pending += amount;
                }
            }
            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏¢‡∏≠‡∏î‡∏•‡∏á MatCode
            if (item.MatCode) {
                const target = MatCodes.find(e => e.code === item.MatCode);
                if (target) {
                    if (isCompleted) target.used += amount;
                    else target.pending += amount;
                }
            }
        });
    });

    return {
      name: proj.name,
      subJobs: subJobs.sort((a,b) => a.code.localeCompare(b.code)),
      MatCodes: MatCodes.sort((a,b) => a.code.localeCompare(b.code))
    };
  });

  // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML Template
  let htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { background-color: #1e3a8a; padding: 25px; color: white; text-align: center; }
        .header h1 { margin: 0; font-size: 24px; }
        .header p { margin: 5px 0 0; opacity: 0.8; font-size: 14px; }
        .content { padding: 20px; }
        .project-card { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 25px; overflow: hidden; }
        .project-header { background-color: #f8fafc; padding: 12px 15px; border-bottom: 1px solid #e5e7eb; font-weight: bold; color: #1e293b; font-size: 16px; border-left: 5px solid #2563eb; }
        .table-container { padding: 0 15px 15px 15px; }
        .budget-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        .budget-table th { background-color: #eff6ff; color: #1e40af; text-align: left; padding: 8px; font-weight: bold; border-bottom: 2px solid #bfdbfe; }
        .budget-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: #334155; }
        .budget-table tr:last-child td { border-bottom: none; }
        .bar-bg { width: 80px; height: 6px; background-color: #e2e8f0; border-radius: 3px; overflow: hidden; display: flex; }
        .bar-used { background-color: #10b981; height: 100%; }
        .bar-pending { background-color: #f59e0b; height: 100%; }
        .num { font-family: 'Courier New', monospace; font-weight: bold; }
        .text-red { color: #dc2626; font-weight: bold; }
        .text-green { color: #16a34a; }
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-right: 5px; }
        .badge-sub { background: #e0e7ff; color: #3730a3; }
        .badge-ep { background: #f3e8ff; color: #6b21a8; }
        .footer { background-color: #f1f5f9; padding: 15px; text-align: center; font-size: 12px; color: #64748b; border-top: 1px solid #e2e8f0; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h1>
          <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleString('th-TH')}</p>
        </div>
        <div class="content">
  `;

  reportData.forEach(proj => {
    // ‡∏Ç‡πâ‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏•‡∏¢
    if (proj.subJobs.length === 0 && proj.MatCodes.length === 0) return;

    htmlContent += `
      <div class="project-card">
        <div class="project-header">${proj.name}</div>
        <div class="table-container">
    `;

    // ‡∏£‡∏ß‡∏° List ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    const allItems = [
       ...proj.subJobs.map(i => ({...i, badge: 'SubJob'})),
       ...proj.MatCodes.map(i => ({...i, badge: 'MatCode'}))
    ];

    if (allItems.length > 0) {
      htmlContent += `
        <table class="budget-table">
          <thead>
            <tr>
              <th width="35%">‡∏£‡∏´‡∏±‡∏™ / ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th width="20%" style="text-align:right">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</th>
              <th width="20%" style="text-align:right">‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á + ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
              <th width="15%" style="text-align:right">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
              <th width="10%" style="text-align:center">%</th>
            </tr>
          </thead>
          <tbody>
      `;

      allItems.forEach(item => {
         const budget = item.budget || 0;
         if (budget === 0) return; // ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏á‡∏ö‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î

         const totalUsed = item.used + item.pending;
         const remaining = budget - totalUsed;
         const pctUsed = Math.min((item.used / budget) * 100, 100);
         const pctPending = Math.min((item.pending / budget) * 100, 100 - pctUsed);
         const totalPct = ((totalUsed / budget) * 100);
         const isOver = totalUsed > budget;

         const badgeClass = item.badge === 'SubJob' ? 'badge-sub' : 'badge-ep';

         htmlContent += `
            <tr>
              <td>
                <span class="badge ${badgeClass}">${item.badge}</span> 
                <strong>${item.code}</strong><br/>
                <span style="color:#94a3b8; font-size:10px;">${item.description || ''}</span>
              </td>
              <td class="num" style="text-align:right; color:#64748b;">${budget.toLocaleString()}</td>
              <td class="num" style="text-align:right;">
                 <div>${totalUsed.toLocaleString()}</div>
                 <div style="font-size:9px; color:#64748b;">(Used: ${item.used.toLocaleString()}, Wait: ${item.pending.toLocaleString()})</div>
              </td>
              <td class="num" style="text-align:right; ${remaining < 0 ? 'color:#dc2626;' : 'color:#16a34a;'}">
                 ${remaining.toLocaleString()}
              </td>
              <td style="text-align:center;">
                 <div class="bar-bg">
                    <div class="bar-used" style="width:${pctUsed}%"></div>
                    <div class="bar-pending" style="width:${pctPending}%"></div>
                 </div>
                 <div style="font-size:10px; margin-top:2px; font-weight:bold; ${isOver ? 'color:red;' : 'color:#64748b;'}">
                    ${totalPct.toFixed(1)}%
                 </div>
              </td>
            </tr>
         `;
      });

      htmlContent += `</tbody></table>`;
    } else {
      htmlContent += `<p style="text-align:center; color:#999; padding:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Code ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</p>`;
    }

    htmlContent += `</div></div>`;
  });

  htmlContent += `
        </div>
        <div class="footer">
           ‡∏£‡∏∞‡∏ö‡∏ö PurchaseHub System | ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
        </div>
      </div>
    </body>
    </html>
  `;

  // 4. ‡∏´‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (Filter ‡∏ï‡∏≤‡∏° Role ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
  // Target Permissions: 2(Admin), 3(Sub-Admin), 8(Head), 9(PM), 10(Verify)
  const targetPerms = [2, 3, 8, 9, 10];
  
  const recipientEmails = users.filter(u => {
      // 1. Super Admin ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏°‡∏≠
      if (u.isSuperAdmin) return true;
      
      // 2. ‡πÄ‡∏ä‡πá‡∏Ñ Status
      if (u.status !== 'Activated') return false;

      // 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å Project (Permission 2,3,8,9,10)
      if (u.permissions) {
          return Object.values(u.permissions).some(perms => 
              perms.some(p => targetPerms.includes(Number(p)))
          );
      }
      return false;
  }).map(u => u.email).filter(e => e && e.includes('@')); // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

  // ‡∏•‡∏ö Email ‡∏ã‡πâ‡∏≥
  const uniqueRecipients = [...new Set(recipientEmails)];

  console.log(`[BudgetSummary] Recipients: ${uniqueRecipients.join(', ')}`);

  if (uniqueRecipients.length > 0) {
    try {
        // ‡∏™‡πà‡∏á Bcc ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ List ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
        GmailApp.sendEmail(
            uniqueRecipients[0], // ‡∏™‡πà‡∏á‡∏´‡∏≤‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å
            `[PurchaseHub] ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Weekly Budget Report)`,
            "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö HTML ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏î‡∏π‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢", 
            {
                htmlBody: htmlContent,
                bcc: uniqueRecipients.slice(1).join(',') // ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏™‡πà Bcc
            }
        );
        console.log("‚úÖ Email sent successfully.");
    } catch (e) {
        console.error("‚ùå Failed to send email: " + e.toString());
    }
  } else {
      console.log("‚ö†Ô∏è No recipients found matching the criteria.");
  }
}


// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ID ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Logs) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ---
function updateLogItemId(oldId, newId) {
  console.log(`[UpdateLog] Changing ID from ${oldId} to ${newId}`);
  
  // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Logs ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏î‡∏∂‡∏á column id ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö)
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ callSupabase ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î
  const response = callSupabase('Logs', 'get', null, '?select=id,payload');
  
  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡∏Å‡∏£‡∏ì‡∏µ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
  let data;
  try {
    data = JSON.parse(response);
  } catch (e) {
    console.error("Error parsing logs:", e);
    return { success: false, message: 'Failed to parse logs' };
  }
  
  if (!Array.isArray(data)) return { success: false, message: 'No logs found or invalid data' };

  let count = 0;
  
  // 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤ Log ‡∏ó‡∏µ‡πà‡∏°‡∏µ assetId ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö oldId ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô newId
  data.forEach(row => {
    let log = row.payload;
    let changed = false;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Log ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    // (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏µ‡πà assetId ‡∏´‡∏£‡∏∑‡∏≠ itemId ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ)
    if (log.assetId === oldId) {
      log.assetId = newId;
      changed = true;
    }
    
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏á Database ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ saveDataToSheet ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    if (changed) {
      saveDataToSheet('Logs', row.id, log);
      count++;
    }
  });

  console.log(`[UpdateLog] Updated ${count} logs.`);
  return { success: true, count: count };
}


// --- ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° (Bulk Upsert) ---
function batchImportInventory(items, logs) {
  if (items && items.length > 0) {
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö record ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Supabase
    const records = items.map(item => ({
      id: item.id.toString(),
      payload: item
    }));
    
    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πâ‡∏≠‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏õ Upsert ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Bulk)
    const table = 'inventory';
    const url = `${SUPABASE_URL}/rest/v1/${table}`;
    const options = {
      method: 'post',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'resolution=merge-duplicates' // ‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤ ID ‡∏ã‡πâ‡∏≥
      },
      payload: JSON.stringify(records)
    };
    UrlFetchApp.fetch(url, options);
  }
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Logs ‡πÅ‡∏ö‡∏ö Bulk (‡∏ñ‡πâ‡∏≤ Supabase ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á Logs ‡πÅ‡∏ö‡∏ö JSON)
  if (logs && logs.length > 0) {
    const logRecords = logs.map(log => {
      if (!log.date) log.date = new Date().toLocaleString('th-TH');
      const logId = log.date + '_' + Math.floor(Math.random() * 1000);
      return { id: logId, payload: log };
    });
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å fetch ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á logs
  }
  
  return { success: true };
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß (Batch Save) ---
function batchImportInventory(items, logs) {
  // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  if (items && items.length > 0) {
    items.forEach(item => {
      try {
        syncInventory(item); 
      } catch (e) {
        console.error("Error saving item: " + item.id, e);
      }
    });
  }
  
  // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Logs (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°)
  if (logs && logs.length > 0) {
    logs.forEach(log => {
      try {
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
        if (!log.date) log.date = new Date().toLocaleString('th-TH');

        // ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà_‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°
        const logId = log.date + '_' + Math.floor(Math.random() * 1000);

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ ID ‡∏ô‡∏µ‡πâ
        saveDataToSheet('Logs', logId, log); 
      } catch (e) {
         console.error("Error saving log", e);
      }
    });
  }
  
  return { success: true };
}


// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° (Bulk Upsert) ---
function batchImportAssets(assets, logs) {
  // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Assets) ‡πÅ‡∏ö‡∏ö Bulk
  if (assets && assets.length > 0) {
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà Supabase ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ({ id, payload })
    const assetRecords = assets.map(asset => ({
      id: asset.id.toString(),
      payload: asset
    }));

    const url = `${SUPABASE_URL}/rest/v1/assets`;
    const options = {
      method: 'post',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'resolution=merge-duplicates' // ‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤ ID ‡∏ã‡πâ‡∏≥
      },
      payload: JSON.stringify(assetRecords)
    };

    try {
      const response = UrlFetchApp.fetch(url, options);
      if (response.getResponseCode() >= 400) {
        console.error("‚ùå Bulk Asset Error: " + response.getContentText());
        throw new Error("Failed to save assets: " + response.getContentText());
      }
    } catch (e) {
      console.error("‚ùå Bulk Asset Exception: " + e.toString());
      return { success: false, message: e.toString() };
    }
  }

  // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Logs) ‡πÅ‡∏ö‡∏ö Bulk
  if (logs && logs.length > 0) {
    const logRecords = logs.map(log => {
      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
      if (!log.date) log.date = new Date().toLocaleString('th-TH');
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á Log ID
      const logId = log.date + '_' + Math.floor(Math.random() * 10000) + '_' + Math.random().toString(36).substr(2, 5);

      return {
        id: logId,
        payload: log
      };
    });

    const logUrl = `${SUPABASE_URL}/rest/v1/logs`;
    const logOptions = {
      method: 'post',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'resolution=merge-duplicates'
      },
      payload: JSON.stringify(logRecords)
    };

    try {
      UrlFetchApp.fetch(logUrl, logOptions);
    } catch (e) {
      console.error("‚ùå Bulk Log Exception: " + e.toString());
      // Log error ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡πÉ‡∏´‡πâ process ‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏∞‡∏á‡∏±‡∏Å ‡∏à‡∏∂‡∏á‡πÅ‡∏Ñ‡πà console.error ‡πÑ‡∏ß‡πâ
    }
  }
  
  return { success: true };
}



// ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö Cascade (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á)
function updateProjectGlobalData(newProject, oldId, oldName) {
  console.log(`[UpdateProject] Renaming from ${oldName} (${oldId}) to ${newProject.name} (${newProject.id})`);

  // --- Helper: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏¥‡∏à (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error) ---
  const getTableData = (table) => {
    const res = callSupabase(table, 'get', null, '?select=id,payload');
    try {
      const data = JSON.parse(res);
      return Array.isArray(data) ? data : [];
    } catch (e) {
      return [];
    }
  };
  // ----------------------------------------------------

  // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (Upsert)
  saveDataToSheet('Projects', newProject.id, newProject);

  // 2. ‡∏ñ‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (ID) ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô -> ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á
  if (oldId && oldId !== newProject.id) {
    deleteDataFromSheet('Projects', oldId);
  }

  // 3. ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô -> ‡πÑ‡∏•‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ
  if (oldName && oldName !== newProject.name) {
     
     // A. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Requests (‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)
     const requests = getTableData('Requests');
     requests.forEach(row => {
        let req = row.payload;
        if (req.job === oldName) {
           req.job = newProject.name;
           saveDataToSheet('Requests', row.id, req);
        }
     });

     // B. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Inventory (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
     const inventory = getTableData('Inventory');
     inventory.forEach(row => {
        let inv = row.payload;
        if (inv.project === oldName) {
           inv.project = newProject.name;
           saveDataToSheet('Inventory', row.id, inv);
        }
     });

     // C. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Assets (‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô)
     const assets = getTableData('Assets');
     assets.forEach(row => {
        let ast = row.payload;
        if (ast.project === oldName) {
           ast.project = newProject.name;
           saveDataToSheet('Assets', row.id, ast);
        }
     });

     // D. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Users (‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
     const users = getTableData('Users');
     users.forEach(row => {
        let u = row.payload;
        if (u.permissions && u.permissions[oldName]) {
           // ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏õ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
           u.permissions[newProject.name] = u.permissions[oldName];
           // ‡∏•‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤
           delete u.permissions[oldName];
           saveDataToSheet('Users', row.id, u);
        }
     });
  }
  
  return { success: true, message: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡∏°‡∏µ‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö)' };
}


// --- [Code.gs] ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Prevent Duplicate Doc No) ---

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß (Lock)
 * ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ saveRequestToSheet ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
 */
function updateStatusSecurely(id, newStatus, logObj, extraUpdates = {}) {
  // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å (‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏î‡πâ‡∏ô‡∏≤‡∏ô‡∏™‡∏∏‡∏î 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(15000); 
  } catch (e) {
    return { success: false, message: '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (Server Busy)' };
  }

  try {
    // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Database
    var requests = getSheetData('Requests');
    var index = requests.findIndex(function(r) { return r.id === id; });
    
    if (index === -1) return { success: false, message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' };
    
    var req = requests[index];
    
   // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)
    req.status = newStatus;

   // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (Flag) ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    var shouldGenNewDoc = false; 

    if (extraUpdates) {
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á docNumber: null ‡∏°‡∏≤ 
      if (extraUpdates.hasOwnProperty('docNumber') && extraUpdates.docNumber === null) {
          req.docNumber = null; // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏¥‡∏°
          shouldGenNewDoc = true; // ‚úÖ ‡∏à‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ß‡πâ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
          
          delete extraUpdates.docNumber; // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ loop ‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤ null ‡∏°‡∏≤‡∏ó‡∏±‡∏ö
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏ä‡πà‡∏ô type: 'HO')
      Object.keys(extraUpdates).forEach(function(key) {
        req[key] = extraUpdates[key];
      });
    }

    // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (History)
    if (!req.history) req.history = [];
    if (!logObj.date) logObj.date = new Date().toLocaleString('th-TH');
    req.history.push(logObj);

    // 5. Generate Doc ID Logic
    if (!req.docNumber) {
        var isBuyReady = ['Local', 'HO'].includes(req.type) && 
            ['Approved', 'Revise Needed', 'Ordered', 'PR Issued', 'PO Issued', 'Contract Pending', 'Contract Signed', 'Shipping', 'Completed'].includes(newStatus);
        
        var isUseReady = ['Withdraw', 'Borrow'].includes(req.type) && 
            ['Ready to Disburse', 'Completed', 'Returned'].includes(newStatus);

        // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ shouldGenNewDoc ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å extraUpdates ‡∏ã‡πâ‡∏≥
        var isForceGen = shouldGenNewDoc; 

        if (isBuyReady || isUseReady || isForceGen) {
            // ‡∏ô‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            var count = getNextDocIndex(requests, req.type, req.purchaseType);
            var newDocId = generateDocId(req.type, count, req.purchaseType);
            
            req.docNumber = newDocId; 
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Log ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡πâ‡∏ß
            if (req.history.length > 0) {
                req.history[req.history.length - 1].note += ' (New Doc No: ' + newDocId + ')';
            }
        }
    }

    // 6. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Supabase
    saveDataToSheet('Requests', req.id, req);

    // 7. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡πÅ‡∏¢‡∏Å Logic ‡∏°‡∏≤‡∏à‡∏≤‡∏Å syncRequest ‡πÄ‡∏î‡∏¥‡∏°)
    try {
        triggerEmails(req);        // ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        handleStatusNotification(req); // ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    } catch (err) {
        console.error("Email Error: " + err);
    }

    return { success: true, request: req };

  } catch (e) {
    return { success: false, message: 'Error: ' + e.toString() };
  } finally {
    // 8. ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
    lock.releaseLock();
  }
}

// Helper: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å)
function triggerEmails(request) {
  if (request.status === 'Pending Head') {
      if (request.type === 'Withdraw' || request.type === 'Borrow') {
          var headEmails = findApproverEmails(request.job, 8);
          var pmEmails = findApproverEmails(request.job, 9);
          var recipients = [];
          if (headEmails) recipients.push(headEmails);
          if (pmEmails) recipients.push(pmEmails);
          if (recipients.length > 0) {
              sendApprovalEmail(request, recipients.join(','), 'Approver'); 
          }
      } else {
          var headEmails = findApproverEmails(request.job, 8);
          if (headEmails) sendApprovalEmail(request, headEmails, 'Head');
      }
  }
  else if (request.status === 'Pending PM') {
      var pmEmails = findApproverEmails(request.job, 9);
      if (pmEmails) sendApprovalEmail(request, pmEmails, 'PM');
  } 
}


function processStockAudit(adjustments, userBy) {
  // adjustments = Array ‡∏Ç‡∏≠‡∏á { id, name, oldQty, newQty, reason, project }
  
  if (!adjustments || adjustments.length === 0) return { success: true, message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á' };

  // 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Bulk Upsert Inventory
  // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á (Diff)
  const inventoryUpdates = adjustments.map(item => {
    // ‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤ merge ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ field ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡πÅ‡∏ï‡πà Supabase upsert ‡∏õ‡∏Å‡∏ï‡∏¥‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ patch)
    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏ó‡∏±‡∏ö‡πÄ‡∏•‡∏¢ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ ID ‡πÄ‡∏î‡∏¥‡∏°
    return {
      id: item.id,
      // ‡∏£‡∏∞‡∏ß‡∏±‡∏á: ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ item ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏°‡∏µ field ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô
      // ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏î‡∏µ ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á object inventory ‡∏ï‡∏±‡∏ß‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ qty ‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤
      payload: item.fullObject 
    };
  });

  // 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Logs
  const logRecords = adjustments.map(item => {
    const diff = item.newQty - item.oldQty;
    const sign = diff > 0 ? '+' : '';
    
    return {
      id: `LOG-AUDIT-${new Date().getTime()}-${Math.floor(Math.random()*1000)}`,
      payload: {
        date: new Date().toLocaleString('th-TH'),
        action: 'Audit Adjust', // Action ‡∏û‡∏¥‡πÄ‡∏®‡∏©
        item: item.name,
        change: `${sign}${diff}`, // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á ‡πÄ‡∏ä‡πà‡∏ô -5 ‡∏´‡∏£‡∏∑‡∏≠ +2
        note: `‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${item.reason}`,
        by: userBy,
        project: item.project,
        assetId: item.id // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      }
    };
  });

  // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Supabase (‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Batch Import)
  // 3.1 Update Inventory
  const urlInv = `${SUPABASE_URL}/rest/v1/inventory`;
  const optInv = {
    method: 'post',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'resolution=merge-duplicates'
    },
    payload: JSON.stringify(inventoryUpdates)
  };
  
  // 3.2 Insert Logs
  const urlLog = `${SUPABASE_URL}/rest/v1/logs`;
  const optLog = {
    method: 'post',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'resolution=merge-duplicates'
    },
    payload: JSON.stringify(logRecords)
  };

  try {
    UrlFetchApp.fetch(urlInv, optInv);
    UrlFetchApp.fetch(urlLog, optLog);
    return { success: true, count: adjustments.length };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}


// --- [Code.gs] SERVER-SIDE PERMISSION CHECK ---

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö Logic ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)
function validateServerPermission(userId, requiredPermId, targetProject) {
  // A. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Supabase
  const users = getSheetData('Users');
  const user = users.find(u => u.id === userId || u.username === userId);

  if (!user) throw new Error("‚õî Access Denied: User not found.");
  if (user.status !== 'Activated') throw new Error("‚õî Access Denied: Account inactive.");
  
  // B. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Super Admin ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏¢
  if (user.isSuperAdmin) return true;

  // C. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
  // ‡∏ñ‡πâ‡∏≤ targetProject ‡πÄ‡∏õ‡πá‡∏ô null ‡∏´‡∏£‡∏∑‡∏≠ 'All' ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô "‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£" ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô Global Check
  // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ö‡∏∏ Project ‡πÄ‡∏™‡∏°‡∏≠‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡πÑ‡∏î‡πâ
  
  // ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Global Action) -> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Project ‡πÉ‡∏î Project ‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÑ‡∏´‡∏°
  if (!targetProject || targetProject === 'All') {
      const hasPerm = Object.values(user.permissions || {}).some(perms => 
          perms.includes(2) || perms.includes(requiredPermId)
      );
      if (hasPerm) return true;
  } 
  // ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
  else {
      const userPerms = user.permissions?.[targetProject] || [];
      
      // - ‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ô‡∏µ‡πâ (2)
      if (userPerms.includes(2)) return true;

      // - ‡πÄ‡∏õ‡πá‡∏ô Sub-Admin (3) -> ‡πÑ‡∏î‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (4,5,6,7)
      if (userPerms.includes(3) && [4, 5, 6, 7].includes(requiredPermId)) return true;

      // - ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á
      if (userPerms.includes(requiredPermId)) return true;
  }

  // ‡∏ñ‡πâ‡∏≤‡∏´‡∏•‡∏∏‡∏î‡∏ó‡∏∏‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç -> ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
  throw new Error(`‚õî Permission Denied: ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ (${requiredPermId}) ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${targetProject || 'Any'}`);
}

// 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Secure Delete)
// ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô deleteDataFromSheet ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
function deleteItemSecure(userId, tableName, id, project) {
  // ‡πÅ‡∏õ‡∏•‡∏á Table Name ‡πÄ‡∏õ‡πá‡∏ô Permission ID ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ
  let requiredPerm = 0;
  if (tableName === 'Inventory') requiredPerm = 18; // ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  else if (tableName === 'Assets') requiredPerm = 21; // ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô
  else if (tableName === 'Projects') requiredPerm = 26; // ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£

  if (requiredPerm === 0) throw new Error("Unknown table type");

  // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö
  validateServerPermission(userId, requiredPerm, project);

  // ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô -> ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
  deleteDataFromSheet(tableName, id);
  return { success: true };
}
