// --- CONFIGURATION ---
const SPREADSHEET_ID = SpreadsheetApp.getActiveSpreadsheet().getId();

function doGet() {
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('PurchaseHub System')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// --- HELPER FUNCTIONS ---
function getSheetData(sheetName) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(sheetName);
  const data = sheet.getDataRange().getValues();
  if (data.length <= 1) return []; // Empty or header only
  
  // Assumes Column A is ID, Column B is JSON Data
  const result = [];
  // Skip header if exists, reading from row 2
  for (let i = 0; i < data.length; i++) {
    if (data[i][1]) { // Check if JSON column exists
      try {
        result.push(JSON.parse(data[i][1]));
      } catch (e) {
        Logger.log('Error parsing JSON row ' + i);
      }
    }
  }
  return result;
}

function saveDataToSheet(sheetName, id, dataObj) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(sheetName);
  const allData = sheet.getDataRange().getValues();
  
  let rowIndex = -1;
  // Search for existing ID in Column A
  for (let i = 0; i < allData.length; i++) {
    if (allData[i][0] == id) {
      rowIndex = i + 1; // 1-based index
      break;
    }
  }
  
  const jsonString = JSON.stringify(dataObj);
  
  if (rowIndex > 0) {
    // Update existing
    sheet.getRange(rowIndex, 2).setValue(jsonString);
  } else {
    // Insert new
    sheet.appendRow([id, jsonString]);
  }
  return true;
}

function deleteDataFromSheet(sheetName, id) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(sheetName);
  const data = sheet.getDataRange().getValues();
  
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] == id) {
      sheet.deleteRow(i + 1);
      break;
    }
  }
}

// --- API FOR FRONTEND ---

function loadInitialData() {
  return {
    requests: getSheetData('Requests'),
    inventory: getSheetData('Inventory'),
    assets: getSheetData('Assets'),
    logs: getSheetData('Logs')
  };
}

// --- Specific Save Functions ---

function syncRequest(request) {
  return saveDataToSheet('Requests', request.id, request);
}

function syncInventory(item) {
  return saveDataToSheet('Inventory', item.id, item);
}

function syncAsset(asset) {
  return saveDataToSheet('Assets', asset.id, asset);
}

function syncLog(log) {
  // Logs don't usually update, just append. using timestamp as ID
  const id = log.date + '_' + Math.floor(Math.random() * 1000); 
  return saveDataToSheet('Logs', id, log);
}
